标题title
一种检测带宽的方法和装置
摘要abst
本发明公开了一种检测带宽的方法和装置，属于交换芯片技术领域，用户可以自配置所述带宽阈值，根据需求界定是大带宽检测还是小带宽检测，大于所述带宽阈值就将仿真时间作为统计周期进行统计，小于所述带宽阈值就将接收报文的字节数作为统计周期进行统计。本发明一种检测带宽的方法和装置，自动截取流量范围内稳定的带宽进行检测，排除突发和变更带来的影响，精确验证带宽分配功能，减少人工参与，能够自动化进行比对。
权利要求书clms
1.一种检测带宽的方法，其特征在于，包括，步骤S1，配置仿真参数；步骤S2，判断属于大带宽检测还是小带宽检测，若属于小带宽检测，进入步骤S3；若属于大带宽检测，进入步骤S4；步骤S3，将接收报文的字节数作为统计周期，进入步骤S5；步骤S4，将仿真时间作为统计周期，进入步骤S5；步骤S5，根据接收报文的字节数的kn倍数或者仿真时间的kn倍数进行发包，参数k为经验因子，n为目标统计次数，进入步骤S6；步骤S6，将统计次数i清零，统计时间段清零，统计字节数清零，将接收报文的字节数或仿真时间作为统计周期进行统计，计算第1次统计的带宽D，进入步骤S7；步骤S7，判断统计次数i是否小于目标统计次数n，若是，进入步骤S8；否则，进入步骤S9；步骤S8，令统计次数i=i+1，进行下一次统计，计算第i次统计的带宽D，转至步骤S7；步骤S9，检测当前是否发生动态变更配置参数，若有，转到步骤S6，重新进行统计；否则，进入步骤S10；步骤S10，分段统计带宽，统计第1次统计的带宽D至第n次统计的带宽D；步骤S11，将第n次统计的带宽D与带宽预期值进行比对，计算带宽误差，带宽误差=-带宽预期值）/带宽预期值，进入步骤S12；步骤S12，若带宽误差的绝对值在误差阈值m%之内，判断为带宽符合要求；否则，判断为带宽不符合要求，其中，m%为设定的误差阈值。2.如权利要求1所述一种检测带宽的方法，其特征在于，所述步骤S2具体包括，根据带宽预期值和带宽阈值判断属于大带宽检测还是小带宽检测，若带宽预期值小于带宽阈值，属于小带宽检测，进入步骤S3；若带宽预期值大于带宽阈值，属于大带宽检测，进入步骤S4。3.如权利要求2所述一种检测带宽的方法，其特征在于，所述步骤S5具体包括，若为小带宽检测，根据接收报文的字节数的kn倍数进行发包；若为大带宽检测，根据仿真时间的kn倍数进行发包，参数k为经验因子，n为目标统计次数，进入步骤S6。4.如权利要求3所述一种检测带宽的方法，其特征在于，所述步骤S6具体包括，将统计次数i清零，统计时间段清零，统计字节数清零，若为小带宽检测，将接收报文的字节数作为统计周期进行统计，计算第1次统计的带宽D；若为大带宽检测，将仿真时间作为统计周期进行统计，计算第1次统计的带宽D。5.如权利要求4所述一种检测带宽的方法，其特征在于，若为小带宽检测，第1次统计，统计次数i=0，统计累计接收的字节数，并同时计时，直至接收的字节数达到统计字节数byte_period，接收统计字节数byte_period需要的时长为第一时长time_cnt1，第1次统计的带宽D=统计字节数byte_period/第一时长time_cnt1；第2次统计，统计次数i=1，统计累计接收的字节数，并同时计时，直至接收的字节数达到统计字节数byte_period，接收统计字节数byte_period需要的时长为第二时长time_cnt2，第2次统计的带宽D=统计字节数byte_period/第二时长time_cnt2；直至统计n次。6.如权利要求5所述一种检测带宽的方法，其特征在于，对于小带宽检测，若带宽不符合要求，进行如下步骤：将发包量增大为a倍，按所述步骤S6至所述步骤S12进行统计，若带宽符合要求，则结束；若带宽仍不符合要求，继续增大发包量进行统计，如此反复b次。7.如权利要求4所述一种检测带宽的方法，其特征在于，若为大带宽检测，第1次统计，统计次数i=0，统计统计时间段time_period内的总出包字节数为第一总出包字节数bytes_num1，第1次统计的带宽D=第一总出包字节数bytes_num1/统计时间段time_period；第2次统计，统计次数i=1，统计统计时间段time_period内的总出包字节数为第二总出包字节数bytes_num2，第2次统计的带宽D=第二总出包字节数bytes_num2/统计时间段time_period；直至统计n次。8.如权利要求7所述一种检测带宽的方法，其特征在于，对于大带宽检测，若带宽不符合要求，进行如下步骤：将仿真时间增大为c倍，按所述步骤S6至所述步骤S12进行统计，若带宽符合要求，则结束；若带宽仍不符合要求，继续增加仿真时间进行统计，如此反复b次。9.如权利要求1所述一种检测带宽的方法，其特征在于，所述仿真参数包括带宽预期值、带宽阈值、统计时间段、统计字节数、统计次数、参数k、QoS本身的初始化参数、QoS是否进行动态改配、改配的参数。10.一种检测带宽的装置，其特征在于，执行如权利要求1-9任一项所述一种检测带宽的方法，包括配置模块、发激励模块、仿真检测模块、比对模块，所述配置模块连接所述发激励模块和所述仿真检测模块，所述发激励模块连接所述仿真检测模块，所述仿真检测模块连接所述比对模块，所述配置模块配置仿真参数，所述发激励模块发送报文，所述仿真检测模块发送统计方案和统计带宽，所述比对模块将最后一次统计的带宽与带宽预期值进行比对。11.如权利要求10所述一种检测带宽的装置，其特征在于，所述仿真检测模块反馈出包的参数给发激励模块，所述发激励模块根据出包的参数调整发包量。12.如权利要求11所述一种检测带宽的装置，其特征在于，还包括打印模块，所述打印模块连接所述比对模块和所述仿真检测模块，所述打印模块打印仿真参数和统计结果。
说明书desc
技术领域本发明涉及交换芯片技术领域，且特别是有关于一种检测带宽的方法和装置。本发明涉及交换芯片技术领域，且特别是有关于一种检测带宽的方法和装置。背景技术近年来，随着科技水平的飞速发展，网络交换设备的功能越来越多、性能越来越强，人们对于交换通信质量的要求也越来越高。QoS作为网络性能的标志一直是交换芯片的重点测试内容，QoS包括准入控制、准出控制、复制和镜像、调度、限速等模块，其中，对带宽的精确检测是难点。一种常用的带宽测试方法是人工进行测试，根据仿真波形进行卡量计算，然而，这种方法的测试工作量大，并且无法实现标准化测试，主观因素过多，验证回归时也无法进行自动化比对，给QoS的带宽验证带来了很大的不确定性，且代码一旦更改便要重新人工卡波形测量所有的带宽功能。另一种常用的方法是计算整个发包过程中的总发包字节数和总发包时间，根据公式计算整体平均带宽。这种方法会弥补人工卡波形的主观化，然而，实际中流量的波动性很大，有突发、变更等情况，若计算整体平均带宽，则会将突发和变更的波形考虑在内，这使得最后的比对结果会有很大偏差，影响测试的准确性，不能达到功能验证的效果。发明内容本发明旨在提供一种检测带宽的方法和装置，适用于广范围的流量带宽检测。为达到上述目的，本发明技术方案是：一种检测带宽的方法，包括，步骤S1，配置仿真参数；步骤S2，判断属于大带宽检测还是小带宽检测，若属于小带宽检测，进入步骤S3；若属于大带宽检测，进入步骤S4；步骤S3，将接收报文的字节数作为统计周期，进入步骤S5；步骤S4，将仿真时间作为统计周期，进入步骤S5；步骤S5，根据接收报文的字节数的kn倍数或者仿真时间的kn倍数进行发包，参数k为经验因子，n为目标统计次数，进入步骤S6；步骤S6，将统计次数i清零，统计时间段清零，统计字节数清零，将接收报文的字节数或仿真时间作为统计周期进行统计，计算第1次统计的带宽D，进入步骤S7；步骤S7，判断统计次数i是否小于目标统计次数n，若是，进入步骤S8；否则，进入步骤S9；步骤S8，令统计次数i=i+1，进行下一次统计，计算第i次统计的带宽D，转至步骤S7；步骤S9，检测当前是否发生动态变更配置参数，若有，转到步骤S6，重新进行统计；否则，进入步骤S10；步骤S10，分段统计带宽，统计第1次统计的带宽D至第n次统计的带宽D；步骤S11，将第n次统计的带宽D与带宽预期值进行比对，计算带宽误差，带宽误差=-带宽预期值）/带宽预期值，进入步骤S12；步骤S12，若带宽误差的绝对值在误差阈值m%之内，判断为带宽符合要求；否则，判断为带宽不符合要求，其中，m%为设定的误差阈值。上述步骤S2具体包括，根据带宽预期值和带宽阈值判断属于大带宽检测还是小带宽检测，若带宽预期值小于带宽阈值，属于小带宽检测，进入步骤S3；若带宽预期值大于带宽阈值，属于大带宽检测，进入步骤S4。上述步骤S5具体包括，若为小带宽检测，根据接收报文的字节数的kn倍数进行发包；若为大带宽检测，根据仿真时间的kn倍数进行发包，参数k为经验因子，n为目标统计次数，进入步骤S6。上述步骤S6具体包括，将统计次数i清零，统计时间段清零，统计字节数清零，若为小带宽检测，将接收报文的字节数作为统计周期进行统计，计算第1次统计的带宽D；若为大带宽检测，将仿真时间作为统计周期进行统计，计算第1次统计的带宽D。在一具体实施例中，若为小带宽检测，第1次统计，统计次数i=0，统计累计接收的字节数，并同时计时，直至接收的字节数达到统计字节数byte_period，接收统计字节数byte_period需要的时长为第一时长time_cnt1，第1次统计的带宽D=统计字节数byte_period/第一时长time_cnt1；第2次统计，统计次数i=1，统计累计接收的字节数，并同时计时，直至接收的字节数达到统计字节数byte_period，接收统计字节数byte_period需要的时长为第二时长time_cnt2，第2次统计的带宽D=统计字节数byte_period/第二时长time_cnt2；直至统计n次。在一具体实施例中，对于小带宽检测，若带宽不符合要求，进行如下步骤：将发包量增大为a倍，按所述步骤S6至所述步骤S12进行统计，若带宽符合要求，则结束；若带宽仍不符合要求，继续增大发包量进行统计，如此反复b次。在一具体实施例中，若为大带宽检测，第1次统计，统计次数i=0，统计统计时间段time_period内的总出包字节数为第一总出包字节数bytes_num1，第1次统计的带宽D=第一总出包字节数bytes_num1/统计时间段time_period；第2次统计，统计次数i=1，统计统计时间段time_period内的总出包字节数为第二总出包字节数bytes_num2，第2次统计的带宽D=第二总出包字节数bytes_num2/统计时间段time_period；直至统计n次。在一具体实施例中，对于大带宽检测，若带宽不符合要求，进行如下步骤：将仿真时间增大为c倍，按所述步骤S6至所述步骤S12进行统计，若带宽符合要求，则结束；若带宽仍不符合要求，继续增加仿真时间进行统计，如此反复b次。在一具体实施例中，上述仿真参数包括带宽预期值、带宽阈值、统计时间段、统计字节数、统计次数、参数k、QoS本身的初始化参数、QoS是否进行动态改配、改配的参数。本发明还提供一种检测带宽的装置，执行如上述一种检测带宽的方法，包括配置模块、发激励模块、仿真检测模块、比对模块，所述配置模块连接所述发激励模块和所述仿真检测模块，所述发激励模块连接所述仿真检测模块，所述仿真检测模块连接所述比对模块，所述配置模块配置仿真参数，所述发激励模块发送报文，所述仿真检测模块发送统计方案和统计带宽，所述比对模块将最后一次统计的带宽与带宽预期值进行比对。在一具体实施例中，上述仿真检测模块反馈出包的参数给发激励模块，所述发激励模块根据出包的参数调整发包量。在一具体实施例中，上述打印模块连接所述比对模块和所述仿真检测模块，所述打印模块打印仿真参数和统计结果。有益效果，本发明一种检测带宽的方法和装置，自动截取流量范围内稳定的带宽进行检测，排除突发和变更带来的影响，精确验证带宽分配功能，减少人工参与，能够自动化进行比对。为让发明的上述特征和优点能更明显易懂，下文特举实施例，并配合所附图式作详细说明如下。附图说明图1为本发明一种检测带宽的装置的结构示意图。图2为本发明一种检测带宽的方法的流程图。具体实施方式为使本发明实施例的目的和技术方案更加清楚，下面将结合本发明实施例的附图，对本发明实施例的技术方案进行清楚、完整地描述。显然，所描述的实施例是本发明的一部分实施例，而不是全部的实施例。基于所描述的本发明的实施例，本领域普通技术人员在无需创造性劳动的前提下所获得的所有其他实施例，都属于本发明保护的范围。图1为本发明一种检测带宽的装置的结构示意图。如图1所示，本发明一种检测带宽的装置包括配置模块11、发激励模块12、仿真检测模块13、比对模块14与打印模块15，配置模块11连接发激励模块12和仿真检测模块13，发激励模块12连接仿真检测模块13，仿真检测模块13连接比对模块14和打印模块15，比对模块14连接打印模块15。配置模块11用于配置带宽阈值、统计时间段、统计字节数、统计次数、参数k、QoS本身的初始化参数、QoS是否进行动态改配、改配的参数等仿真参数，并传送给仿真检测模块13和发激励模块12。发激励模块12发送仿真和检测带宽所需要的报文，可根据接收报文的字节数和时间进行发送激励，以确保输入值能够满足出口的带宽计算。仿真检测模块13判断进行大带宽检测还是小带宽检测，将统计方案发送给发激励模块12，并对带宽进行精确统计。比对模块14截取最后一次统计的带宽，与带宽预期值进行比对，判断是否在允许的误差阈值之内，若在，则带宽符合要求，打印成功标识；若否，则带宽不符合要求，打印错误标识。打印模块15打印仿真参数、统计结果，以及最后的判定结果为成功还是失败。进一步地，仿真检测模块13反馈出包的参数给发激励模块12，使得发激励模块12的发包量能满足测试的需求，出包能统计到预期的值，达到自动化测试的效果，不需要每次人工调整发包量。图2为本发明一种检测带宽的方法的流程图，具体包括如下步骤。步骤S1，配置仿真参数，传送给仿真检测模块13和发激励模块12。更具体地，仿真参数包括带宽预期值、带宽阈值、统计时间段、统计字节数、统计次数、参数k、QoS本身的初始化参数、QoS是否进行动态改配、改配的参数等。所述带宽阈值用于判断是大带宽还是小带宽。步骤S2，根据带宽预期值和带宽阈值判断属于大带宽检测还是小带宽检测。若带宽预期值小于带宽阈值，属于小带宽检测，进入步骤S3；若带宽预期值大于带宽阈值，属于大带宽检测，进入步骤S4。步骤S3，将接收报文的字节数作为统计周期，进入步骤S5。步骤S4，将仿真时间作为统计周期，进入步骤S5。步骤S5，仿真检测模块13发送统计方案给发激励模块12，发激励模块12根据接收报文的字节数的kn倍数或者仿真时间的kn倍数进行发包，参数k为经验因子，n为目标统计次数，进入步骤S6。更具体地，若为小带宽检测，发激励模块12根据接收报文的字节数的kn倍数进行发包；若为大带宽检测，发激励模块12根据仿真时间的kn倍数进行发包。步骤S6，在出口处监控出包情况，仿真检测模块13将统计次数i清零，统计时间段清零，统计字节数清零，将接收报文的字节数或仿真时间作为统计周期进行统计，计算带宽D，进入步骤S7。更具体地，若为小带宽检测，将接收报文的字节数作为统计周期进行统计，计算带宽D；若为大带宽检测，将仿真时间作为统计周期进行统计，计算带宽D。步骤S7，判断统计次数i是否小于目标统计次数n，若是，进入步骤S8；否则，进入步骤S9。步骤S8，令统计次数i=i+1，进行下一次统计，计算第i次统计的带宽D，转至步骤S7。若为小带宽检测，在将接收报文的字节数作为统计周期的情况下，所述步骤S1中配置的仿真参数包括统计字节数byte_period。第1次统计，统计次数i=0，统计累计接收的字节数，并同时计时，直至接收的字节数达到统计字节数byte_period，接收统计字节数byte_period需要的时长为第一时长time_cnt1，第1次统计的带宽D=统计字节数byte_period/第一时长time_cnt1。第2次统计，统计次数i=1，统计累计接收的字节数，并同时计时，直至接收的字节数达到统计字节数byte_period，接收统计字节数byte_period需要的时长为第二时长time_cnt2，第2次统计的带宽D=统计字节数byte_period/第二时长time_cnt2。直至统计n次。若为大带宽检测，在将仿真时间作为统计周期的情况下，所述步骤S1中配置的仿真参数包括统计时间段time_period。第1次统计，统计次数i=0，统计统计时间段time_period内的总出包字节数为第一总出包字节数bytes_num1，第1次统计的带宽D=第一总出包字节数bytes_num1/统计时间段time_period。第2次统计，统计次数i=1，统计统计时间段time_period内的总出包字节数为第二总出包字节数bytes_num2，第2次统计的带宽D=第二总出包字节数bytes_num2/统计时间段time_period。直至统计n次。步骤S9，检测当前是否发生动态变更配置参数，若有，转到步骤S6，重新进行统计；否则，进入步骤S10。步骤S10，分段统计带宽，打印统计结果。更具体地，统计第1次统计的带宽D至第n次统计的带宽D，打印统计结果。步骤S11，将最后一次统计的带宽D与带宽预期值进行比对，计算带宽误差，带宽误差=-带宽预期值）/带宽预期值，进入步骤S12。步骤S12，打印成功或失败结果，结束。更具体地，若带宽误差的绝对值在误差阈值m%之内，则带宽符合要求，打印成功标识；否则，则带宽不符合要求，打印失败标识。其中，m%为设定的误差阈值。进一步地，对于小带宽检测，若带宽不符合要求，打印失败结果后，可进行如下步骤：传递参数flag1和参数pkt_num给发激励模块12，其中，参数flag1=1，表示需要调整发包量；参数pkt_num=a*pkt_num，表示发包量增大为a倍。发激励模块12接收到参数flag1和参数pkt_num后，会在原来的基础上增大发包量，再按图2中的步骤S6至步骤S12进行统计。若带宽符合要求，则结束；若带宽仍不符合要求，继续将参数flag1和参数pkt_num传递给发激励模块，继续增大发包量进行统计。可以如此反复b次。在一优选实施例中，a的取值为2-5。在一优选实施例中，b的取值为3。进一步地，对于大带宽检测，若带宽不符合要求，打印失败结果后，可进行如下步骤：传递参数flag1和参数time给发激励模块12，其中，参数flag1=1，表示需要调整发包量；参数time=c*time，表示仿真时间增大为c倍。发激励模块12接收到参数flag1和参数time后，会在原来的基础上增加仿真时间，再按图2中的步骤S6至步骤S12进行统计。若带宽符合要求，则结束；若带宽仍不符合要求，继续将参数flag1和参数time传递给发激励模块，继续增加仿真时间进行统计。可以如此反复b次。在一优选实施例中，c的取值为2-5。在一优选实施例中，b的取值为3。综上所述，本发明一种检测带宽的方法和装置，适用于广范围的流量带宽检测，小到1M甚至k级别，大到10G。大带宽在设定的时间内很容易达到稳定带宽，所以在大带宽的情形下，可以将仿真时间作为统计周期进行统计，节约检测时间。小带宽在一定时间内的发包量有限，也许这段时间结束了，发包还没达到稳定状态，这种状况下的统计结果无效，因此，在小带宽的情形下应按照一定的包量进行统计，即将接收报文的字节数作为统计周期，确保检测结果的准确性。由此，本发明设定了一个带宽阈值，用户可以自配置所述带宽阈值，从而根据需求界定是大带宽检测还是小带宽检测，大于所述带宽阈值就将仿真时间作为统计周期进行统计，小于所述带宽阈值就将接收报文的字节数作为统计周期进行统计，从而满足广范围的流量带宽检测的需求，保证检测的高效率与高准确度。此外，之前常用的一种统计方式为从头至尾统计一次计算整体平均带宽，另一种常用的方式是多打印几次，但是统计值还是从头开始的值。这两种方式的干扰因素太多，且流量在代码启动瞬间波动较多，需要仿真一段时间才会达到稳定。若还有动态变更参数，在参数变化的瞬间，流量也是不准确的。因此，本发明采用的统计方式为分段统计，每段都会重新计数和计时；并且会检测动态变更参数，一旦发生变更，也会重新计数和计时；还会统计多段带宽，一般来说，前面几段的带宽相对不稳定，后面几段的带宽相对稳定，可截取最后一段的带宽作为比对的依据，提高判断的准确性。进一步地，本发明一种检测带宽的方法和装置灵活性高，统计次数和统计时间可根据需要配置，可以适用带宽范围广的各种场景。虽然本发明已以实施例揭露如上，然其并非用以限定本发明，任何所属技术领域中具有通常知识者，在不脱离本发明的精神和范围内，当可作些许的更动与润饰，故本发明的保护范围当视后附的申请专利范围所界定者为准。
