标题title
一种冗余现场总线通信控制器及其实现方法
摘要abst
本发明公开了一种冗余现场总线通信控制器及其实现方法，包括两路物理层接口单元，监视状态控制逻辑单元，单通道通信控制器单元。两路物理层接口单元，用于连接现场总线通信控制器与外部两路媒体结合单元构成冗余链路结构，形成双通道总线连接。监视状态控制逻辑单元，包括总线检测单元，总线冗余状态指示单元，总线切换控制单元，有效总线数据选择单元，用于判断信号质量和链路状态，切换有效通路。单通道通信控制器单元用于完成IEC61185‑2现场总线数据通讯、地址表查找匹配、数据链路层定时功能。其优点在于面向现场总线的安全和可靠性需求，增强网络化能力，在单现场总线通信控制器中实现双通道冗余通信，从而提高现场总线的易用性、安全性和可靠性。
权利要求书clms
1.一种冗余现场总线通信控制器，其特征在于，包括：单通道通信控制单元，用于接收监视状态控制逻辑单元输出的接收数据信号、中断指示信号，发送数据信号至监视状态控制逻辑单元，实现接收数据的串变并、解码、帧校验的检查和载波信号生成，发送数据的并变串、曼彻斯特编码，帧校验的生成；监视状态控制逻辑单元，用于根据双通道链路信号信息，判断信号质量和链路状态，实现通路切换与状态指示；物理层接口单元，用于监视状态控制逻辑单元与外部两路媒体结合单元构成冗余链路结构，形成双通道总线连接。2.根据权利要求1所述的一种冗余现场总线通信控制器，其特征在于，所述监视状态控制逻辑单元包括：总线检测单元，用于接收两个物理层接口单元的数据信号RX0、RX1，接收数据经过数据同步和数据比较，输出同步接收数据信号RXS0、RXS1、指示信号CompState至总线冗余状态指示单元，输出有效通路指示信号ValidLine和切换可行标志指示信号SwitchState到总线切换控制单元；所述总线冗余状态指示单元，用于接收两路同步接收数据信号RXS0、RXS1和一致性比较结果指示信号CompState，通过载波检测、曼彻斯特编码解码、CRC校验、有效帧超长检测、前后定界码检测，达到定义错误阈值产生对应的错误指示信号，判断两条链路信号的信号质量和链路状态，输出对应的载波状态指示信号CD0、CD1,曼彻斯特解码错误指示信号MANCH0、MANCH1，CRC校验错误指示信号CRC0、CRC1，接收超长帧错误指示信号LONG0、LONG1，前后定界码丢失指示信号DELIM0、DELIM1至总线切换控制单元，表明当前两条通路的信号质量和链路状态；总线切换控制单元，用于接收有效通路指示信号ValidLine和切换可行标志指示信号SwitchState，载波状态指示信号CD0、CD1,曼彻斯特解码错误指示信号MANCH0、MANCH1，CRC校验错误指示信号CRC0、CRC1，接收超长帧错误指示信号LONG0、LONG1，前后定界码丢失指示信号DELIM0、DELIM1，输出有效链路选择信号TrustLine、冗余线路状态指示信号RedunState至有效总线数据选择单元，输出中断指示信号INT至单通道通信控制器单元；有效总线数据选择单元，用于接收两路物理层接口单元输出的接收数据RX0、RX1，接收单通道通信控制器单元输出的发送数据TX以及受到总线切换控制单元输出的有效链路选择信号TrustLine、冗余线路状态指示信号RedunState控制，选通对应的RX0或RX1输入至RX，传输给单通道通信控制器单元；选通对应的TX0输入至物理层接口单元0、或TX1输入至物理层接口单元1，以形成总线发送数据传输至现场总线。3.根据权利要求1所述的一种冗余现场总线通信控制器，其特征在于，所述总线检测单元，用于分析两路接收数据的正确性，实现RX0和RX1的时序同步：首先进行数据同步操作，再确定两路接收数据是否一致，输出两路同步接收数据信号RXS0、RXS1和一致性比较结果指示信号CompState至总线冗余状态指示单元，输出有效通路指示信号ValidLine和切换可行标志指示信号SwitchState到总线切换控制单元，ValidLine与SwitchState信号组合意义如下：00代表信任线为通道0，不可切换；01代表默认通道0通道为信任通道，冗余现场总线通信控制器运行后，可以根据总线冗余状态指示单元判断结果修改信任通道为0通道还是1通道；10代表信任线为通道1，不可切换；11代表默认通道1通道为信任通道，冗余现场总线通信控制器运行后，可以根据总线冗余状态指示单元判断结果修改信任通道为1通道还是0通道。4.根据权利要求1所述的一种冗余现场总线通信控制器，其特征在于，所述总线切换控制单元，判断链路状态、确定有效链路选择、定义错误类型优先级和切换通路错误阈值，达到阈值则启动切换控制单元，启动内部定时功能，确定切换时间，生成切换中断信号，并根据有效通路指示信号ValidLine和切换可行标志指示信号SwitchState状态，确定当前的有效通路，以及是否可以切换通路，如有效通路和备用通路均有错误，则生成通讯错误中断信号，如可切换有效通路，则生成对应通路的Trustline指示信号以及RedunState冗余线路状态指示信号。5.根据权利要求1所述的一种冗余现场总线通信控制器，其特征在于，所述有效总线数据选择单元，用于接收两路物理层接口单元输出的接收数据RX0、RX1，接收单通道通信控制器单元输出的发送数据TX以及受到总线切换控制单元输出的有效链路选择信号TrustLine、冗余线路状态指示信号RedunState控制，其内部机制为二选一选通单元，通过TrustLine指示信号选择通路0或者通路1为有效通路，选通对应的RX0或RX1输入至RX，传输给单通道通信控制器单元；选通对应的TX0或TX1输入至物理层接口单元0或物理层接口单元1，形成总线发送数据传输至现场总线；同时根据RedunState指示信号状态，自定义是否进行冗余通路的接收发送；监视状态控制逻辑单元判断的链路状态指示信号ValidLine、SwitchState、CompState、CD0、CD1、MANCH0、MANCH1，CRC0、CRC1、LONG0、LONG1、DELIM0、DELIM1、TrustLine和RedunState均可以通过单通道通信控制单元系统总线连接被外设访问、配置。6.一种冗余现场总线通信控制器实现方法，其特征在于，包括以下步骤：单通道通信控制单元接收监视状态控制逻辑单元输出的接收数据信号、中断指示信号，发送数据信号至监视状态控制逻辑单元，实现接收数据的串变并、解码、帧校验的检查和载波信号生成，发送数据的并变串、曼彻斯特编码，帧校验的生成；监视状态控制逻辑单元根据双通道链路信号信息，判断信号质量和链路状态，实现通路切换与状态指示；物理层接口单元监视状态控制逻辑单元与外部两路媒体结合单元构成冗余链路结构，形成双通道总线连接。7.根据权利要求6所述的一种冗余现场总线通信控制器实现方法，其特征在于，所述监视状态控制逻辑单元执行以下步骤：总线检测单元接收两个物理层接口单元的数据信号RX0、RX1，接收数据经过数据同步和数据比较，输出同步接收数据信号RXS0、RXS1、指示信号CompState至总线冗余状态指示单元，输出有效通路指示信号ValidLine和切换可行标志指示信号SwitchState到总线切换控制单元；所述总线冗余状态指示单元接收两路同步接收数据信号RXS0、RXS1和一致性比较结果指示信号CompState，通过载波检测、曼彻斯特编码解码、CRC校验、有效帧超长检测、前后定界码检测，达到定义错误阈值产生对应的错误指示信号，判断两条链路信号的信号质量和链路状态，输出对应的载波状态指示信号CD0、CD1,曼彻斯特解码错误指示信号MANCH0、MANCH1，CRC校验错误指示信号CRC0、CRC1，接收超长帧错误指示信号LONG0、LONG1，前后定界码丢失指示信号DELIM0、DELIM1至总线切换控制单元，表明当前两条通路的信号质量和链路状态；总线切换控制单元接收有效通路指示信号ValidLine和切换可行标志指示信号SwitchState，载波状态指示信号CD0、CD1,曼彻斯特解码错误指示信号MANCH0、MANCH1，CRC校验错误指示信号CRC0、CRC1，接收超长帧错误指示信号LONG0、LONG1，前后定界码丢失指示信号DELIM0、DELIM1，输出有效链路选择信号TrustLine、冗余线路状态指示信号RedunState至有效总线数据选择单元，输出中断指示信号INT至单通道通信控制器单元；有效总线数据选择单元接收两路物理层接口单元输出的接收数据RX0、RX1，接收单通道通信控制器单元输出的发送数据TX以及受到总线切换控制单元输出的有效链路选择信号TrustLine、冗余线路状态指示信号RedunState控制，选通对应的RX0或RX1输入至RX，传输给单通道通信控制器单元；选通对应的TX0输入至物理层接口单元0、或TX1输入至物理层接口单元1，以形成总线发送数据传输至现场总线。8.根据权利要求6所述的一种冗余现场总线通信控制器实现方法，其特征在于，所述总线检测单元分析两路接收数据的正确性，实现RX0和RX1的时序同步：首先进行数据同步操作，再确定两路接收数据是否一致，输出两路同步接收数据信号RXS0、RXS1和一致性比较结果指示信号CompState至总线冗余状态指示单元，输出有效通路指示信号ValidLine和切换可行标志指示信号SwitchState到总线切换控制单元，ValidLine与SwitchState信号组合意义如下：00代表信任线为通道0，不可切换；01代表默认通道0通道为信任通道，冗余现场总线通信控制器运行后，可以根据总线冗余状态指示单元判断结果修改信任通道为0通道还是1通道；10代表信任线为通道1，不可切换；11代表默认通道1通道为信任通道，冗余现场总线通信控制器运行后，可以根据总线冗余状态指示单元判断结果修改信任通道为1通道还是0通道。9.根据权利要求6所述的一种冗余现场总线通信控制器实现方法，其特征在于，所述总线切换控制单元判断链路状态、确定有效链路选择、定义错误类型优先级和切换通路错误阈值，达到阈值则启动切换控制单元，启动内部定时功能，确定切换时间，生成切换中断信号，并根据有效通路指示信号ValidLine和切换可行标志指示信号SwitchState状态，确定当前的有效通路，以及是否可以切换通路，如有效通路和备用通路均有错误，则生成通讯错误中断信号，如可切换有效通路，则生成对应通路的Trustline指示信号以及RedunState冗余线路状态指示信号。10.根据权利要求6所述的一种冗余现场总线通信控制器实现方法，其特征在于，所述有效总线数据选择单元接收两路物理层接口单元输出的接收数据RX0、RX1，接收单通道通信控制器单元输出的发送数据TX以及受到总线切换控制单元输出的有效链路选择信号TrustLine、冗余线路状态指示信号RedunState控制，其内部机制为二选一选通单元，通过TrustLine指示信号选择通路0或者通路1为有效通路，选通对应的RX0或RX1输入至RX，传输给单通道通信控制器单元；选通对应的TX0或TX1输入至物理层接口单元0或物理层接口单元1，形成总线发送数据传输至现场总线；同时根据RedunState指示信号状态，自定义是否进行冗余通路的接收发送；监视状态控制逻辑单元判断的链路状态指示信号ValidLine、SwitchState、CompState、CD0、CD1、MANCH0、MANCH1，CRC0、CRC1、LONG0、LONG1、DELIM0、DELIM1、TrustLine和RedunState均可以通过单通道通信控制单元系统总线连接被外设访问、配置。
说明书desc
技术领域本发明属于现场总线冗余技术领域，涉及一种冗余现场总线通信控制器实现方法，具体来说是一种基于IEC61158标准现场总线通信控制器冗余结构实现方法。背景技术随着现代微电子技术、信息技术和现代通信技术逐步向工业控制系统的渗透，数字化的通信技术逐步取代传统的模拟信号，控制系统由相对独立的模块单元向以网络技术为核心的现场总线控制系统发展，仪器仪表朝着智能化、网络化、小型化发展，现场总线技术就是在这样的背景下推出的，作为工业控制领域中的先进技术，现场总线是用于连接生产现场的智能化测量、控制、显示设备的开放、数字化通信系统。现场总线控制系统具有全数字通信、高可靠性、低成本、高精度、高抗干扰能力、易集成、易维护等特点，其中通信控制器单元是现场总线控制系统的核心单元之一。面向现场总线的安全和可靠性需求，提高网络化能力，通常采用链路冗余技术，通过配置多重备份增加通信的可靠性。对于现有的通信控制器单元，仅有一个通道，用来设计具有链路冗余结构的现场总线系统，需要使用两个通信控制单元，造成软件开发难度和工作量的负担以及制造成本的增加。发明内容针对上述问题，本发明旨在提出一种冗余现场总线通信控制器实现方法，满足在单现场总线通信控制器中实现双通道冗余通信，从而提高现场总线的易用性、安全性和可靠性。本发明为实现上述目的所采用的技术方案是：一种冗余现场总线通信控制器，包括：单通道通信控制单元，用于接收监视状态控制逻辑单元输出的接收数据信号、中断指示信号，发送数据信号至监视状态控制逻辑单元，实现接收数据的串变并、解码、帧校验的检查和载波信号生成，发送数据的并变串、曼彻斯特编码，帧校验的生成；监视状态控制逻辑单元，用于根据双通道链路信号信息，判断信号质量和链路状态，实现通路切换与状态指示；物理层接口单元，用于监视状态控制逻辑单元与外部两路媒体结合单元构成冗余链路结构，形成双通道总线连接。所述监视状态控制逻辑单元包括：总线检测单元，用于接收两个物理层接口单元的数据信号RX0、RX1，接收数据经过数据同步和数据比较，输出同步接收数据信号RXS0、RXS1、指示信号CompState至总线冗余状态指示单元，输出有效通路指示信号ValidLine和切换可行标志指示信号SwitchState到总线切换控制单元；所述总线冗余状态指示单元，用于接收两路同步接收数据信号RXS0、RXS1和一致性比较结果指示信号CompState，通过载波检测、曼彻斯特编码解码、CRC校验、有效帧超长检测、前后定界码检测，达到定义错误阈值产生对应的错误指示信号，判断两条链路信号的信号质量和链路状态，输出对应的载波状态指示信号CD0、CD1,曼彻斯特解码错误指示信号MANCH0、MANCH1，CRC校验错误指示信号CRC0、CRC1，接收超长帧错误指示信号LONG0、LONG1，前后定界码丢失指示信号DELIM0、DELIM1至总线切换控制单元，表明当前两条通路的信号质量和链路状态；总线切换控制单元，用于接收有效通路指示信号ValidLine和切换可行标志指示信号SwitchState，载波状态指示信号CD0、CD1,曼彻斯特解码错误指示信号MANCH0、MANCH1，CRC校验错误指示信号CRC0、CRC1，接收超长帧错误指示信号LONG0、LONG1，前后定界码丢失指示信号DELIM0、DELIM1，输出有效链路选择信号TrustLine、冗余线路状态指示信号RedunState至有效总线数据选择单元，输出中断指示信号INT至单通道通信控制器单元；有效总线数据选择单元，用于接收两路物理层接口单元输出的接收数据RX0、RX1，接收单通道通信控制器单元输出的发送数据TX以及受到总线切换控制单元输出的有效链路选择信号TrustLine、冗余线路状态指示信号RedunState控制，选通对应的RX0或RX1输入至RX，传输给单通道通信控制器单元；选通对应的TX0输入至物理层接口单元0、或TX1输入至物理层接口单元1，以形成总线发送数据传输至现场总线。所述总线检测单元，用于分析两路接收数据的正确性，实现RX0和RX1的时序同步：首先进行数据同步操作，再确定两路接收数据是否一致，输出两路同步接收数据信号RXS0、RXS1和一致性比较结果指示信号CompState至总线冗余状态指示单元，输出有效通路指示信号ValidLine和切换可行标志指示信号SwitchState到总线切换控制单元，ValidLine与SwitchState信号组合意义如下：00代表信任线为通道0，不可切换；01代表默认通道0通道为信任通道，冗余现场总线通信控制器运行后，可以根据总线冗余状态指示单元判断结果修改信任通道为0通道还是1通道；10代表信任线为通道1，不可切换；11代表默认通道1通道为信任通道，冗余现场总线通信控制器运行后，可以根据总线冗余状态指示单元判断结果修改信任通道为1通道还是0通道。所述总线切换控制单元，判断链路状态、确定有效链路选择、定义错误类型优先级和切换通路错误阈值，达到阈值则启动切换控制单元，启动内部定时功能，确定切换时间，生成切换中断信号，并根据有效通路指示信号ValidLine和切换可行标志指示信号SwitchState状态，确定当前的有效通路，以及是否可以切换通路，如有效通路和备用通路均有错误，则生成通讯错误中断信号，如可切换有效通路，则生成对应通路的Trustline指示信号以及RedunState冗余线路状态指示信号。所述有效总线数据选择单元，用于接收两路物理层接口单元输出的接收数据RX0、RX1，接收单通道通信控制器单元输出的发送数据TX以及受到总线切换控制单元输出的有效链路选择信号TrustLine、冗余线路状态指示信号RedunState控制，其内部机制为二选一选通单元，通过TrustLine指示信号选择通路0或者通路1为有效通路，选通对应的RX0或RX1输入至RX，传输给单通道通信控制器单元；选通对应的TX0或TX1输入至物理层接口单元0或物理层接口单元1，形成总线发送数据传输至现场总线；同时根据RedunState指示信号状态，自定义是否进行冗余通路的接收发送；监视状态控制逻辑单元判断的链路状态指示信号ValidLine、SwitchState、CompState、CD0、CD1、MANCH0、MANCH1，CRC0、CRC1、LONG0、LONG1、DELIM0、DELIM1、TrustLine和RedunState均可以通过单通道通信控制单元系统总线连接被外设访问、配置。一种冗余现场总线通信控制器实现方法，包括以下步骤：单通道通信控制单元接收监视状态控制逻辑单元输出的接收数据信号、中断指示信号，发送数据信号至监视状态控制逻辑单元，实现接收数据的串变并、解码、帧校验的检查和载波信号生成，发送数据的并变串、曼彻斯特编码，帧校验的生成；监视状态控制逻辑单元根据双通道链路信号信息，判断信号质量和链路状态，实现通路切换与状态指示；物理层接口单元监视状态控制逻辑单元与外部两路媒体结合单元构成冗余链路结构，形成双通道总线连接。所述监视状态控制逻辑单元执行以下步骤：总线检测单元接收两个物理层接口单元的数据信号RX0、RX1，接收数据经过数据同步和数据比较，输出同步接收数据信号RXS0、RXS1、指示信号CompState至总线冗余状态指示单元，输出有效通路指示信号ValidLine和切换可行标志指示信号SwitchState到总线切换控制单元；所述总线冗余状态指示单元接收两路同步接收数据信号RXS0、RXS1和一致性比较结果指示信号CompState，通过载波检测、曼彻斯特编码解码、CRC校验、有效帧超长检测、前后定界码检测，达到定义错误阈值产生对应的错误指示信号，判断两条链路信号的信号质量和链路状态，输出对应的载波状态指示信号CD0、CD1,曼彻斯特解码错误指示信号MANCH0、MANCH1，CRC校验错误指示信号CRC0、CRC1，接收超长帧错误指示信号LONG0、LONG1，前后定界码丢失指示信号DELIM0、DELIM1至总线切换控制单元，表明当前两条通路的信号质量和链路状态；总线切换控制单元接收有效通路指示信号ValidLine和切换可行标志指示信号SwitchState，载波状态指示信号CD0、CD1,曼彻斯特解码错误指示信号MANCH0、MANCH1，CRC校验错误指示信号CRC0、CRC1，接收超长帧错误指示信号LONG0、LONG1，前后定界码丢失指示信号DELIM0、DELIM1，输出有效链路选择信号TrustLine、冗余线路状态指示信号RedunState至有效总线数据选择单元，输出中断指示信号INT至单通道通信控制器单元；有效总线数据选择单元接收两路物理层接口单元输出的接收数据RX0、RX1，接收单通道通信控制器单元输出的发送数据TX以及受到总线切换控制单元输出的有效链路选择信号TrustLine、冗余线路状态指示信号RedunState控制，选通对应的RX0或RX1输入至RX，传输给单通道通信控制器单元；选通对应的TX0输入至物理层接口单元0、或TX1输入至物理层接口单元1，以形成总线发送数据传输至现场总线。所述总线检测单元分析两路接收数据的正确性，实现RX0和RX1的时序同步：首先进行数据同步操作，再确定两路接收数据是否一致，输出两路同步接收数据信号RXS0、RXS1和一致性比较结果指示信号CompState至总线冗余状态指示单元，输出有效通路指示信号ValidLine和切换可行标志指示信号SwitchState到总线切换控制单元，ValidLine与SwitchState信号组合意义如下：00代表信任线为通道0，不可切换；01代表默认通道0通道为信任通道，冗余现场总线通信控制器运行后，可以根据总线冗余状态指示单元判断结果修改信任通道为0通道还是1通道；10代表信任线为通道1，不可切换；11代表默认通道1通道为信任通道，冗余现场总线通信控制器运行后，可以根据总线冗余状态指示单元判断结果修改信任通道为1通道还是0通道。所述总线切换控制单元判断链路状态、确定有效链路选择、定义错误类型优先级和切换通路错误阈值，达到阈值则启动切换控制单元，启动内部定时功能，确定切换时间，生成切换中断信号，并根据有效通路指示信号ValidLine和切换可行标志指示信号SwitchState状态，确定当前的有效通路，以及是否可以切换通路，如有效通路和备用通路均有错误，则生成通讯错误中断信号，如可切换有效通路，则生成对应通路的Trustline指示信号以及RedunState冗余线路状态指示信号。所述有效总线数据选择单元接收两路物理层接口单元输出的接收数据RX0、RX1，接收单通道通信控制器单元输出的发送数据TX以及受到总线切换控制单元输出的有效链路选择信号TrustLine、冗余线路状态指示信号RedunState控制，其内部机制为二选一选通单元，通过TrustLine指示信号选择通路0或者通路1为有效通路，选通对应的RX0或RX1输入至RX，传输给单通道通信控制器单元；选通对应的TX0或TX1输入至物理层接口单元0或物理层接口单元1，形成总线发送数据传输至现场总线；同时根据RedunState指示信号状态，自定义是否进行冗余通路的接收发送；监视状态控制逻辑单元判断的链路状态指示信号ValidLine、SwitchState、CompState、CD0、CD1、MANCH0、MANCH1，CRC0、CRC1、LONG0、LONG1、DELIM0、DELIM1、TrustLine和RedunState均可以通过单通道通信控制单元系统总线连接被外设访问、配置。本发明具有以下有益效果及优点：本发明用单现场总线通信控制器中可实现双通道总线冗余通信，可以根据链路情况分析链路质量，从而选择最优通道进行数据传输并根据链路质量进行通道切换，实现使用两个相同结构的物理连接通道提高通信控制器的可靠性和安全性，相比双现场总线通信控制器又减少了软件开发的工作量，节约了制造成本和提高了可靠性、安全性。附图说明图1冗余现场总线通信控制器原理图图2监视状态控制逻辑单元框图图3冗余现场总线通信控制器原型系统原理图。具体实施方式为了更清楚地说明本发明实施例或现有技术中的技术方案，下面结合具体的实施例对本发明做进一步的详细说明。显然，所述实施例是本发明一部分实施例，而不是全部实施例。基于本发明中的实施例，本领域普通技术人员在没有做出创造性劳动前提下所获得的所有其他实施例，都属于本发明保护的范围。本发明公开了一种冗余现场总线通信控制器实现方法，具体来说是一种基于IEC61158标准现场总线通信控制器冗余结构实现方法。主要包括两路物理层接口单元，监视状态控制逻辑单元，单通道通信控制器单元。两路物理层接口单元，用于连接现场总线通信控制器与外部两路媒体结合单元构成冗余链路结构，形成双通道总线连接。监视状态控制逻辑单元，包括总线检测单元，总线冗余状态指示单元，总线切换控制单元，有效总线数据选择单元，用于判断信号质量和链路状态，切换有效通路。单通道通信控制器单元用于完成IEC61185-2现场总线数据通讯、地址表查找匹配、数据链路层定时功能。其优点在于面向现场总线的安全和可靠性需求，增强网络化能力，在单现场总线通信控制器中实现双通道冗余通信，从而提高现场总线的易用性、安全性和可靠性。本发明实例提供一种基于IEC61158标准现场总线通信控制器冗余结构实现方法，具体包括：通信控制器冗余结构，包括两路物理层接口单元，监视状态控制逻辑单元，单通道通信控制器单元。所述两路物理层接口单元，用于连接现场总线通信控制器与外部两路媒体结合单元构成冗余链路结构，形成双通道总线连接。所述监视状态控制逻辑单元，包括总线检测单元，总线冗余状态指示单元，总线切换控制单元，有效总线数据选择单元。所述总线检测单元连接两路物理层接口单元的数据输出，用于确定输入的总线数据检测线路处于单线模式或双线模式，并且确定是否可以进行线路切换，并输出判断控制信号至通信控制器微控制器单元。所述总线冗余状态指示单元连接两路接收控制器单元的数据输出，用于对输入数据信号进行同步、数据比较、数据分析，通过判断CRC校验错误，曼彻斯特编码帧错误，信号质量错误，帧长度错误，确定线路状态指示报告，输出状态指示信号至总线切换控制单元。所述总线切换控制单元用于进行线路的选择和替换，并输出线路切换信号、中断信号至有效总线数据选择单元和单通道通信控制器单元。有效总线数据选择单元通过接收总线检测单元和总线切换控制单元信号，决定接收有效总线上的数据并通过微控制器接口传输给单通道通信控制器单元。所述单通道通信控制器单元，包括存储器、DMA控制器、中断控制器、定时器、地址识别与匹配单元、帧类型识别单元、发送控制器、接收控制器、支持单通道的收发控制和编解码单元。下面结合图3描述本发明实施例的冗余现场总线通信控制器原型系统原理。冗余现场总线通信控制器原型系统与现有单通道现场总线通信控制器原型系统最大的区别在于物理层媒体结合单元MAU接口。冗余现场总线通信控制器原型系统具有两路物理层MAU接口连接到两路现场总线上，两路互为主链路和备份链路，每一条通路均与单通道设备一样实现同样的功能。实施例中冗余现场总线通信控制器原型系统需要使用两个媒体结合单元MAU0和MAU1，两个MAU单元是完全相同的，每个MAU单元与冗余现场总线控制器接口都有发送数据TXD，发送使能TXE，接收数据RXD，接收使能RXE。冗余现场总线通信控制器与现场总线微控制器通过系统总线连接，数据存储器和程序存储器也与微控制器通过系统总线连接，构成完整的冗余现场总线通信控制器原型系统。冗余现场总线通信控制器原型系统具有两条物理链路，但与传统的冗余现在总线网络不同的是在现场总线上表现为一个节点，只有一个通信控制器，逻辑节点和物理节点是同一个，并且两条链路是同时在工作的。冗余现场总线通信控制器的实现原理如图1所示，包括两路物理层接口单元，监视状态控制逻辑单元，单通道通信控制器单元。两路物理层接口单元输出接收数据信号RX0、RX1至监视状态控制逻辑单元，监视状态控制逻辑单元输出发送数据信号TX0、TX1分别至两路物理层接口单元。监视状态控制逻辑单元输入的接收数据信号分别接入其内部的总线检测单元和有效总线数据选择单元，接收数据经过总线检测单元中的数据同步，数据比较，输出同步接收数据信号、指示信号至总线冗余状态指示单元和总线切换控制单元。总线冗余状态指示单元负责判断载波检测、曼彻斯特编码解码、CRC校验、有效帧超长检测、前后定界码检测操作，输出两条链路的状态指示信号至总线切换控制单元。总线切换控制单元接收链路状态指示信号，负责判断链路状态、确定有效链路选择、确定切换时间，输出有效链路选择信号至有效总线数据选择单元，输出中断指示信号至单通道通信控制器单元。有效总线数据选择单元接收两路物理层接口单元输出的接收数据RX0、RX1，接收单通道通信控制器单元输出的发送数据TX以及受到总线切换控制单元输出的输出有效链路选择信号控制，输出有效链路数据信号RX至单通道通信控制器单元，输出两路发送数据信号TX0，TX1分别至两路物理层接口单元，此两路发送数据信号只有一路为有效发送数据信号。监视状态控制逻辑单元所用的时钟信号CLK来自单通道通信控制器单元时钟输出。监视状态控制逻辑单元判断的链路状态指示信号均可以通过单通道通信控制单元系统总线连接被微控制器访问、配置。单通道通信控制单元接收监视状态控制逻辑单元输出的有效接收数据信号RX、中断指示信号INT，输出时钟信号CLK和发送数据信号TX至监视状态控制逻辑单元。负责完成接收数据的串变并、曼彻斯特解码、帧校验的检查、错误处理和载波信号生成、发送数据的并变串、曼彻斯特编码，帧校验的生成，内部系统结构符合IEC61185-2物理层和数据链路层规范，通过系统总线与现场总线微控制器相连。监视状态控制逻辑单元的实现原理如图2所示，总线检测单元输入接收数据信号RX0、RX1接收数据经过总线检测单元中的数据同步，数据比较，输出同步接收数据信号、指示信号至总线冗余状态指示单元和总线切换控制单元。分析两路接收数据的正确性，实现时RX0和RX1的时序必须高度同步以便所有的数据比较、状态控制、信号输出才有意义，首先进行数据同步操作，再采用基本原理类似异或门逻辑的比较单元确定两路接收数据的一致性，输出两路同步接收数据信号RXS0、RXS1和一致性比较结果指示信号CompState至总线冗余状态指示单元，输出有效通路指示信号ValidLine和切换可行标志指示信号SwitchState到总线切换控制单元，ValidLine与SwitchState信号组合意义如下：00代表信任线为通道0，不可切换；01代表默认通道0通道为信任通道，系统运行后，可以根据总线冗余状态指示单元判断结果修改信任通道为0通道还是1通道；10代表信任线为通道1，不可切换；11代表默认通道1通道为信任通道，系统运行后，可以根据总线冗余状态指示单元判断结果修改信任通道为1通道还是0通道。总线冗余状态指示单元接收两路同步接收数据信号RXS0、RXS1和一致性比较结果指示信号CompState，通过内部的载波检测、曼彻斯特编码解码、CRC校验、有效帧超长检测、前后定界码检测功能单元，达到定义错误阈值产生对应的错误指示信号，判断两条链路信号的信号质量和链路状态，输出对应的载波状态指示信号CD0、CD1,曼彻斯特解码错误指示信号MANCH0、MANCH1，CRC校验错误指示信号CRC0、CRC1，接收超长帧错误指示信号LONG0、LONG1，前后定界码丢失指示信号DELIM0、DELIM1至总线切换控制单元，表明当前两条通路的信号质量和链路状态。总线切换控制单元接收有效通路指示信号ValidLine和切换可行标志指示信号SwitchState，载波状态指示信号CD0、CD1,曼彻斯特解码错误指示信号MANCH0、MANCH1，CRC校验错误指示信号CRC0、CRC1，接收超长帧错误指示信号LONG0、LONG1，前后定界码丢失指示信号DELIM0、DELIM1，根据内部切换状态机制，判断链路状态、确定有效链路选择、定义错误类型优先级和切换通路错误阈值，达到阈值则启动切换控制单元，启动内部定时功能，确定切换时间，生成切换中断信号，并根据有效通路指示信号ValidLine和切换可行标志指示信号SwitchState状态，确定当前的有效通路，以及是否可以切换通路，如有效通路和备用通路均有错误，则生成通讯错误中断信号，如可切换有效通路，则生成对应通路的Trustline指示信号以及RedunState冗余线路状态指示信号。输出有效链路选择信号TrustLine、冗余线路状态指示信号RedunState至有效总线数据选择单元，输出中断指示信号INT至单通道通信控制器单元的中断控制器单元,以协调控制信号、内部总线信号、处理器接口和发送控制器接口。有效总线数据选择单元接收两路物理层接口单元输出的接收数据RX0、RX1，接收单通道通信控制器单元输出的发送数据TX以及受到总线切换控制单元输出的有效链路选择信号TrustLine、冗余线路状态指示信号RedunState控制，其内部机制为二选一选通单元，通过TrustLine指示信号选择通路0或者通路1为有效通路，选通对应的RX0或RX1输入至RX，传输给单通道通信控制器单元；选通对应的TX0或TX1输入至物理层接口单元0或物理层接口单元1，形成总线发送数据传输至现场总线。同时可以根据RedunState指示信号状态，自定义是否进行冗余通路的接收发送。监视状态控制逻辑单元判断的链路状态指示信号ValidLine、SwitchState、CompState、CD0、CD1、MANCH0、MANCH1，CRC0、CRC1、LONG0、LONG1、DELIM0、DELIM1、TrustLine和RedunState均可以通过单通道通信控制单元系统总线连接被微控制器访问、配置。
