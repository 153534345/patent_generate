标题title
一种基于图匹配的威胁狩猎方法
摘要abst
本发明公开了一种基于图匹配的威胁狩猎方法，包括：构建起源图：收集系统内核审计日志，根据系统内核日志中的因果关系和事件流构建出起源图；构建查询图：从网络威胁情报中提取威胁实体及各个威胁实体之间的关系，以此构建与攻击相关的查询图；图匹配：采用边分割的方法将起源图进行分片，将分片后的起源图分配到各个站点，各个站点分别进行图匹配查找，计算起源图与查询图的相似度，在起源图中找到与查询图最相似子图，即相似度分数最高为止，完成威胁狩猎；威胁预警：若相似度分数大于阈值，则立即进行警报，并将查询图匹配到的节点以及路径输出。本发明方法解决攻击者逃逸的问题，以达到准确高效狩猎的目的。
权利要求书clms
1.一种基于图匹配的威胁狩猎方法，其特征在于，包括如下步骤：1）构建起源图：收集系统内核审计日志，根据系统内核日志中的因果关系和事件流构建出起源图；2）构建查询图：从网络威胁情报中提取威胁实体及各个威胁实体之间的关系，以此构建与攻击相关的查询图；3）图匹配：采用边分割的方法将起源图进行分片，将分片后的起源图分配到各个站点，各个站点分别进行图匹配查找，计算起源图与查询图的相似度，在起源图中找到与查询图最相似子图，即相似度分数最高为止，得到最高相似度分数；4）威胁预警：若最高相似度分数大于阈值，则立即进行警报，并将查询图匹配到的节点以及路径输出。2.根据权利要求1所述的基于图匹配的威胁狩猎方法，其特征在于，步骤1）中，所述的系统为Linux、FreeBSD或/和Windows。3.根据权利要求1所述的基于图匹配的威胁狩猎方法，其特征在于，步骤3）中，采用边分割的方法将起源图进行分片具体包括：根据查询图的各个节点在起源图中候选节点的个数，选择候选个数最少的节点对应的集合作为每个分区的初始节点集，从初始节点集的初始节点开始，每次从已划分数据的邻接点集合中选择一个节点划分到当前分区，直到当前分区达到额定负载，再进行下一个分区的划分，完成主站点分片。4.根据权利要求1所述的基于图匹配的威胁狩猎方法，其特征在于，步骤3）中，将分片后的起源图分配到各个站点，各个站点分别进行图匹配查找，计算起源图与查询图的相似度，具体包括：在主站点进行分片后，将查询图和分片后的起源图分配到各个站点，每个站点分别执行图匹配算法固定查询图的候选节点，通过查询图的候选节点计算起源图与查询图的相似度。5.根据权利要求4所述的基于图匹配的威胁狩猎方法，其特征在于，所述的图匹配算法包括：3.1) 从ATT&amp;CK模型抽取技术模板，根据查询图确定攻击技术，作为攻击元行为，每个站点融合起源图的单节点和攻击元行为进行查找固定查询图攻击元行为的候选节点；3.2)固定与查询图攻击元行为的候选节点的相邻节点，考虑相邻节点的上下文语义和边的语义信息，固定查询图的候选节点。6.根据权利要求5所述的基于图匹配的威胁狩猎方法，其特征在于，步骤3.2)中，考虑相邻节点的上下文语义和边的语义信息，固定查询图的候选节点，具体包括：3.2.1)根据系统实体的类型分为进程、文件、套接字和注册表，其中根据文件的不同类型，又分为敏感文件、库文件、可执行文件；根据相邻节点的可达路径信息以及查询图的相邻节点的类型来确定查询图的最佳候选节点，如果对应则进入步骤3.2.2)考虑边的语义信息；3.2.2) 考虑节点之间的信息流方向同时考虑节点之间的边的语义信息，进行攻击元行为之间的映射或进行节点之间的映射，匹配边的语义信息，如果匹配则完成边的语义信息，固定查询图的候选节点，如果不匹配，使用等价语义传递的规则再次匹配边的语义信息。7.根据权利要求6所述的基于图匹配的威胁狩猎方法，其特征在于，步骤3.2.1)中，根据相邻节点的可达路径信息以及查询图的相邻节点的类型来确定查询图的最佳候选节点，具体包括：根据查询图的节点类型和起源图中的节点类型，如果类型相同，则该起源图中的节点作为查询图的候选节点之一，如果查询图的候选节点匹配到查询图中节点的可达路径信息、可达节点信息和查询图的相邻节点的类型三者中的任意一个，分别赋予不同的权重，权重值依次从低到高，三个权重能累计，最终选择权重值最高的候选节点作为查询图的最佳候选节点。8.根据权利要求6所述的基于图匹配的威胁狩猎方法，其特征在于，步骤3.2.2)中，所述的等价语义传递的规则，具体包括：如果查询图中两个节点之间边的语义信息与对应起源图的候选节点之间边的语义信息不匹配，利用同类型事件的不同关联实体拥有不同的恶意程度，通过判断关联实体的上下文信息，判断边的语义信息是否与攻击关联，与攻击关联则认为路径可达，继续查找下一个节点，直到节点对应的边的语义信息相匹配为止，固定查询图的候选节点。
说明书desc
技术领域本发明涉及威胁狩猎领域，具体涉及一种基于图匹配的威胁狩猎方法。背景技术随着高级持续威胁不断出现，网络安全面临严峻挑战。APT攻击不同于传统的网络攻击，其以渗透到特定公司或组织并获取重要的资产信息、敏感数据等为目的，且攻击者具有组织性、攻击技术具有先进性、攻击过程具有持久性。现有的APT攻击自动化检测方法单一且被动，如通过依赖图、API分析、用户画像、统计特征提取等。对于实时的检测系统来说，报警意味着攻击/危害已经发生；而对于非实时的检测系统，分析人员在离线数据上检测到攻击时，攻击者往往已经对真实环境造成了严重的破坏。因此，如何主动地在组织内部通过持续回扫数据来寻找、识别和理解攻击对手，是学术界和工业界密切关注的热点之一。于是，全自动的攻击检测方法向着半自动的威胁狩猎转变。威胁狩猎是人为驱使的行动，需要主动并反复的在组织环境内进行分析查找被入侵的痕迹，从而缩短攻击者在组织环境内的驻留时间，最大程度的减少攻击者对组织环境造成的危害。网络环境越来越复杂，攻击技术随时可能出现变种，网络威胁情报可以提供融合多源数据的攻击知识，包括攻击场景、攻击战术、攻击技术和攻击过程等。因此，通过网络威胁情报报告企业可以访问庞大的威胁行为数据库，从而尽可能多的得到已知敌对行为，有利于安全人员制定攻防策略，极大提高安全防护效率。在此背景下，以威胁情报驱动的新型网络安全防御机制应运而生。为了进行有效的威胁狩猎，分析人员不仅需要利用情报相关知识增强攻击行为挖掘的能力，还需要结合组织内部长期的系统日志进行持续回扫以发现可能存在的威胁。起源图可以将系统中的因果事件联系起来，通过系统实体对象之间的交互来完全显示系统执行，已被不少研究者用于威胁狩猎。根据调研显示，现有威胁狩猎方法缺乏完整性，无法揭示攻击是如何展开，同时，依赖低级别的签名，若攻击者更新或使用工具更改签名以逃避检测时，则无法检测到攻击行为。发明内容针对现有技术的不足，本发明提供了一种基于图匹配的威胁狩猎方法。一种基于图匹配的威胁狩猎方法，包括如下步骤：1）构建起源图：收集系统内核审计日志，根据系统内核日志中的因果关系和事件流构建出起源图；2）构建查询图：从网络威胁情报中提取威胁实体及各个威胁实体之间的关系，以此构建与攻击相关的查询图；3）图匹配：采用边分割的方法将起源图进行分片，将分片后的起源图分配到各个站点，各个站点分别进行图匹配查找，计算起源图与查询图的相似度，在起源图中找到与查询图最相似子图，即相似度分数最高为止，得到最高相似度分数；4）威胁预警：若最高相似度分数大于阈值，则立即进行警报，并将查询图匹配到的节点以及路径输出，利用ATT&amp;CK框架实现对狩猎结果的可解释性。本发明通过将起源图进行合理分片，分布式查找提高狩猎效率，狩猎融合了实体和元行为匹配的技术，同时结合节点上下文语义和边的信息解决漏报、误报问题，并利用ATT&amp;CK框架对狩猎结果进一步解释，实现高效、精准、可解释的威胁狩猎方法。步骤1）中，所述的系统为Linux、FreeBSD或/和Windows。步骤3）中，采用边分割的方法将起源图进行分片具体包括：根据查询图的各个节点在起源图中候选节点的个数，选择候选个数最少的节点对应的集合作为每个分区的初始节点集，即分区的个数由候选节点个数最少的决定，从初始节点集的初始节点开始，每次从已划分数据的邻接点集合中选择一个节点划分到当前分区，直到当前分区达到额定负载，再进行下一个分区的划分，完成主站点分片。将分片后的起源图分配到各个站点，各个站点分别进行图匹配查找，计算起源图与查询图的相似度，具体包括：在主站点进行分片后，将查询图和分片后的起源图分配到各个站点，每个站点分别执行图匹配算法固定查询图的候选节点，通过查询图的候选节点计算起源图与查询图的相似度。所述的图匹配算法包括：3.1) 从ATT&amp;CK模型抽取技术模板，根据查询图确定攻击技术，作为攻击元行为，每个站点融合起源图的单节点和攻击元行为进行查找固定查询图攻击元行为的候选节点；3.2)固定与查询图攻击元行为的候选节点的相邻节点，考虑相邻节点的上下文语义和边的语义信息，固定查询图的候选节点。步骤3.2)中，考虑相邻节点的上下文语义和边的语义信息，固定查询图的候选节点，具体包括：3.2.1)根据系统实体的类型分为进程、文件、套接字和注册表，其中根据文件的不同类型，又分为敏感文件、库文件、可执行文件；根据相邻节点的可达路径信息以及查询图的相邻节点的类型来确定查询图的最佳候选节点，如果对应则进入步骤3.2.2)考虑边的语义信息；3.2.2) 考虑节点之间的信息流方向同时考虑节点之间的边的语义信息，进行攻击元行为之间的映射或进行节点之间的映射，匹配边的语义信息，如果匹配则完成边的语义信息，固定查询图的候选节点，如果不匹配，使用等价语义传递的规则再次匹配边的语义信息。步骤3.2.1)中，根据相邻节点的可达路径信息以及查询图的相邻节点的类型来确定查询图的最佳候选节点，具体包括：根据查询图的节点类型和起源图中的节点类型，如果类型相同，则该起源图中的节点作为查询图的候选节点之一，如果查询图的候选节点匹配到查询图中节点的可达路径信息、可达节点信息和查询图的相邻节点的类型三者中的任意一个，分别赋予不同的权重，权重值依次从低到高，三个权重能累计，最终选择权重值最高的候选节点作为查询图的最佳候选节点。步骤3.2.2)中，所述的等价语义传递的规则，具体包括：如果查询图中两个节点之间边的语义信息与对应起源图的候选节点之间边的语义信息不匹配，利用同类型事件的不同关联实体拥有不同的恶意程度，通过判断关联实体的上下文信息，判断边的语义信息是否与攻击关联，与攻击关联则认为路径可达，继续查找下一个节点，直到节点对应的边的语义信息相匹配为止，固定查询图的候选节点。所述等价语义传递的规则为根据攻击本质规定的传递规则，如果查询图中两个节点之间边语义信息与对应的候选节点之间边语义信息不匹配，但是满足等价语义传递的规则，那么认为该路径是可达的，继续查找下一个节点，直到到达某个节点时，对应的边信息相匹配为止。与现有技术相比，本发明具有如下优点： 采集内核日志数据，内核数据记录了良好的语义信息，并且较好的展现系统对象间的关系； 使用元行为的匹配模式，避免攻击者故意绕路而错失此信息流； 在查找过程中加入节点之间的语义信息，确保匹配到信息流的准确性；将起源图划份成合理的分片，并行计算每个分片结果，分片间进行通信，实现高效率狩猎；对于图匹配的NPC问题，采用按需搜索，以节点之间的信息流驱动查找。在映射边语义信息时，使用等价语义传递的方法防止攻击者逃逸。附图说明图1为一种基于图匹配的威胁狩猎方法流程图。图2为本发明的图匹配算法流程图。图3为本发明的并行查找流程图。图4为本发明中采用边分割的方法将起源图进行分片的流程图。具体实施方式下面将结合附图对本发明作进一步描述。参照图1，一种基于图匹配的威胁狩猎方法，包括如下步骤：构建起源图：收集Linux、FreeBSD和Windows的内核审计日志，根据日志中的因果关系和事件流构建出起源图G；构建查询图：从网络威胁情报中提取威胁实体及其它们之间的关系，以此构建与攻击相关的查询图Q；图匹配：根据得到的起源图和查询图，将威胁狩猎转化为在起源图中找到与查询图最相似子图的问题，通过攻击元行为检索、考虑节点上下文语义、匹配边语义信息、异步主从式分布式查询等方法，同时，使用等价语义传递的方法解决攻击者逃逸的问题，以达到准确高效狩猎的目的；威胁预警：根据图对齐的分数，若最大对齐分数大于阈值，则立即进行警报，并将匹配到的节点以及路径输出，实现对狩猎结果的可解释性。步骤中，构建起源图的详细步骤如下： 采集日志数据：对于多平台的操作系统，需要选择合适的日志数据采集工具，能够采集内核数据，因为内核数据相对于上层应用程序数据不容易被篡改，在本方法中使用SPADE采集工具收集内核日志，并认为只要系统的内核不被破坏，内核审计日志就不会受到未经授权的篡改，并且认为其包含的系统实体之间关系是可信任的； 建模起源图G：根据收集到的内核审计日志，将其建模为一个带有标记的有向图，能够有效地跟踪因果关系和信息流，其中节点表示内核审计日志中涉及的系统实体。边表示节点之间的信息流和因果关系，如read、fork、receive、write等。步骤中，构建查询图的详细步骤如下： 提取威胁实体以及它们之间的关系：网络威胁情报描述攻击的多个方面，包括攻击顺序、攻击实体以及对被攻击系统的影响等，通常以结构化和非结构化的语言进行描述。本方法中使用自然语言处理技术，从非结构化的CTI报告中提取IOC以及它们之间的关系。 建模查询图Q：将CTI报告中出现的攻击行为建模成一个带有标记的有向图，节点表示报告中出现的实体，边表示节点之间的信息流和因果关系，如read、fork、receive、write等。步骤中，图对齐的算法流程图如图2所示，详细步骤如下： 相关符号定义：本方法中定义三种匹配方式，分别是：单点匹配、元行为匹配和图匹配，相关定义如表1所示。表1符号说明定义攻击成本H：为衡量节点i到节点j产生攻击流的可能性，用来表示攻击的成本，具体计算如下；。表示攻击者从节点i到节点j需要的最少攻击跳数，因此这些攻击步骤相互独立，本发明认为如果某条路径的进程具有同等的语义，则；若节点i到节点j不存在可达路径或语义不匹配，则。根据等价语义传递的规则，即使攻击者故意绕远，本发明中认为语义是等价的，同样能狩猎到，等价语义传递规则表如表2所示。表2等价语义传递规则表元行为匹配分数W：表示攻击元行为的可能性，记为W；。G1与G2分别是Gq、Gp中的子图，W的值越大，表明攻击元行为对齐数量越多，攻击的可能性越高。当W=1时，表明G1与G2中所有节点、所有流以及流上语义信息都匹配成功；W=0时，表明G1与G2中所有节点及结构均匹配失败。对齐分数S：表示起源图G和查询图Q的对齐分数，记为S；。S的值越大，节点对齐数量越多，G与Q的相似度越高，G中的流与Q中的流之间的相似性越大，受到攻击的可能性越大。当S=1时，表明G中的所有节点都与Q中的节点对齐，并且G中存在的所有流也出现在Q中对齐的节点之间。 分片算法：本发明中采用边分割的方法将起源图进行分片，分片后的各个站点根据主从式结构进行分布式查找，如图4所示。找到查询图中节点映射到起源图中的候选节点：网络威胁情报抽取出的实体名称可能与底层内核日志抽取的实体名称不一致，难以匹配到相关实体，影响狩猎的准确性。因此，本发明中提出根据G中节点的类型、节点的出入度、相邻节点类型以及相邻节点到该节点的边语义信息，在G中匹配相应的候选节点，避免直接匹配名称。将起源图进行分片：由主从式结构特点在主站点，根据查询图的各个节点在起源图中候选节点的个数，选择候选个数最少的节点集合作为每个分区的初始节点集，即分区的个数由候选节点个数最少的决定。从初始节点开始，每次从已划分数据的邻接点集合中选择一个节点划分到当前分区，直到当前分区达到额定负载，再进行下一个分区的划分。分布式查找：在主站点进行分片后，将分片的数据和查询图分配到各个站点，每个站点分别执行图匹配算法计算部分答案，即每个分片单独计算H、W，每个站点接收来自其他站点传递的数据以更新本地数据，再向其他站点发送更新后的答案，重复上述过程，直到每个站点的数据都不再更新。之后所有站点的本地计算结果发送到主站点，在主站点中计算形成完整的匹配结果。 图匹配算法：由步骤知，起源图被分片为F=，并分配到站点，计算每个站点的分片Fi与查询图匹配的部分答案，通过攻击元行为检索、节点上下文语义、边语义信息等方法来进行威胁狩猎，如图2所示。攻击元行为检索：ATT&amp;CK框架描述了APT攻击各个阶段使用的不同技术，由此可以提取出元攻击行为，即每个元攻击行为代表一次APT攻击中的一个技术行为。在进行单节点匹配前，首先找到Q中最能代表APT攻击的元攻击行为，进而在G中匹配相应的元行为，如果匹配成功，表明受到攻击的可能性越大，赋予权重值W。例1：提取ATT&amp;CK框架中T1547.001技术模块的元行为如图3所示。匹配节点：通常在Q中可能匹配到多个G对应的候选节点，为提高效率，本发明图匹配算法从匹配到的攻击元行为开始向前/向后遍历图。对于给定Q中的节点n和m，以及G中对应的候选节点集、，若要在G中固定种子节点n的候选节点集，需计算分别到的攻击成本H之和，其中m需满足：从n可达或者可以到达n；在G中与n和m相对应的候选节点，同样有路径可达，并且相连节点之间的边语义信息相同或等价。匹配节点的计算如公式所示：若存在多个候选节点，则选择匹配分数A最大的节点固定。步骤中，威胁预警的详细步骤如下： 计算对齐分数：在主站点中根据公式算对齐分数S，此时对齐分数S是起源图中与查询图最相似子图的相似度得分。 预警：若S大于阈值，则进行威胁预警，并将固定的最佳子图输出，利用确定的攻击元行为对狩猎结果进行解释。
