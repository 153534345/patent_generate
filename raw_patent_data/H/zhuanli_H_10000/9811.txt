标题title
一种应急广播多终端音频的同步方法及应急广播系统
摘要abst
本发明提出一种应急广播多终端音频的同步方法及应急广播系统，涉及应急广播音频同步处理的技术领域，首先将若干个应急广播终端划分至不同的群组，将属于同一群组的应急广播终端接入同一个局域网，然后在属于同一群组的应急广播终端中选举一个主终端与应急广播平台保持连接，相较于传统应急广播平台与每一个应急广播终端均保持连接的方式，占用的网络带宽更低，实现更为简单。此外，考虑由主终端将接收的音频广播数据再在局域网内部转发，转发的数据到达从终端也存在时延的问题，计算并匹配单向传输时延，实现主终端向从终端同步转发音频广播数据，保障应急广播多终端音频的同步效果，保证了应急广播的及时有效传播。
权利要求书clms
1.一种应急广播多终端音频的同步方法，其特征在于，所述方法包括以下步骤：S1.将若干个应急广播终端划分至不同的群组，将属于同一群组的应急广播终端接入同一个局域网；S2.在接入同一个局域网的同一群组的应急广播终端中选举出主终端，将除主终端之外的其它应急广播终端作为从终端；S3.主终端与应急广播平台建立连接通路，接收应急广播平台下发的音频广播数据；S4.主终端确定其与从终端之间的单向传输时延，然后匹配单向传输时延；S5.在匹配单向传输时延的前提下，主终端向从终端同步转发音频广播数据。2.根据权利要求1所述的应急广播多终端音频的同步方法，其特征在于，步骤S1中所述的将若干个应急广播终端划分至不同的群组时，根据应急广播终端的安装地点划分，位于同一安装点的若干个应急广播终端划分至同一个群组。3.根据权利要求2所述的应急广播多终端音频的同步方法，其特征在于，步骤S2中，主终端选举的过程为：S21.将接入同一局域网的同一群组的应急广播终端上电运行，在上电运行开始时，各个应急广播终端均将自身的设备ID置为主终端ID；S22.设置定时器T1及定时器T1的定时时间，在各个应急广播终端上电运行时间到达定时时间时，各个应急广播终端均发送选举协商广播消息，内容包括应急广播终端的设备ID、MAC地址及IP地址；S23.在各个应急广播终端各自发送选举协商广播消息之前，判断各个应急广播终端是否接收到其它应急广播终端发送的选举协商广播消息，且其它应急广播终端发送的选举协商广播消息携带的设备ID大于自身的设备ID，若是，未发送选举协商广播消息的应急广播终端选举失败，进入静默模式；否则，执行步骤S24；S24.在各个应急广播终端各自发送选举协商广播消息之后，设置定时器T2及定时器T2的定时时间，在定时器T2定时时间到达之前，各个应急广播终端持续接收其它应急广播终端发送的选举协商广播消息；S25.判断各个应急广播终端是否接收到其它应急广播终端发送的选举协商广播消息，且其它应急广播终端发送的选举协商广播消息携带的设备ID大于自身的设备ID，若是，将原设置为主终端ID的自身的设备ID更新，并进入静默模式；否则，执行步骤S26；S26.若在定时器T2定时到达后仍未收到其它应急广播终端发送的选举协商广播消息，则表明本应急广播终端为主终端，同时进入主动模式，并重新启动定时器T2，重复监控其它应急广播终端发送的选举协商广播消息；S27.在部分应急广播终端进入静默模式后，设置定时器T3及定时器T3的定时时间，在定时器T3定时到达之前，接收其它应急广播终端发送的选举协商广播消息；S28.判断应急广播终端接收的其它应急广播终端发送的选举协商广播消息携带的设备ID是否大于步骤S25记录的主终端ID，若是，则将步骤S25记录的主终端ID更新为新的设备ID，选举结束；否则，步骤S25记录的主终端ID不变，选举结束。4.根据权利要求3所述的应急广播多终端音频的同步方法，其特征在于，步骤S28之后还包括：若定时器T3定时到达之后，进入静默模式的应急广播终端未接收到步骤S25记录的主终端发送的选举协商广播消息，则步骤S25记录的主终端下线，进入静默模式的应急广播终端结束静默模式，返回S21重新选举主终端。5.根据权利要求3或4所述的应急广播多终端音频的同步方法，其特征在于，定时器T1的定时时间为时间段内任意一个随机值，T表示大于0的时间，定时器T3的定时时间长度大于定时器T2的定时时间长度。6.根据权利要求1所述的应急广播多终端音频的同步方法，其特征在于，步骤S3所述的主终端与应急广播平台建立连接通路的过程为：S31.主终端向应急广播平台发起建立连接请求，应急广播平台收到主终端发送的建立连接请求后响应建立连接请求的应答，通过双方握手建立连接；S32.应急广播平台向主终端下发消息报文，主终端接收消息报文，与应急广播平台建立连接通路；所述消息报文为确认主终端转发音频广播数据组播IP地址或告知主终端主终端自主确定转发音频广播数据组播IP地址的消息报文。7.根据权利要求6所述的应急广播多终端音频的同步方法，其特征在于，步骤S3中主终端接收应急广播平台下发的音频广播数据后，采用RTSP协议，通过应急广播平台下发的URL，调用FFMPEG API接口，将音频广播数据存储在主终端的中转服务站等待转发。8.根据权利要求7所述的应急广播多终端音频的同步方法，其特征在于，步骤S4中主终端确定其与从终端之间的单向传输时延，然后匹配单向传输时延的过程为：S41.主终端向每一个从终端发送时延测量广播请求消息，在消息中同时置入当前时刻时间t1；S42.每一个从终端接收到主终端发送的时延测量广播请求消息后，即刻回送一个时延测量应答消息，应答消息中将接收的时延测量广播请求消息中的t1同时携带返回；S43.主终端接收每一个从终端的时延测量应答消息，记录接收时刻时间t2，并通过t＝/2求得单向传输时延；S44.设主终端的从终端共N个，主终端与每一个从终端的单向传输时延表示为ti，i＝1,2，…,N，以主终端与每一个从终端的单向传输时延的平均值作为主终端与从终端之间的单向传输时延，表达式为：其中，tavg表示主终端与每一个从终端的单向传输时延的平均值；S45.主终端自身准备进行某条音频广播数据播发之前，提前一个单向传输时延tavg将该条音频广播数据从主终端的中转服务站中转发，以匹配单向传输时延。9.根据权利要求7所述的应急广播多终端音频的同步方法，其特征在于，步骤S5中所述在匹配单向传输时延的前提下，主终端向从终端同步转发音频广播数据时，向从终端广播转发组播IP地址。10.一种应急广播系统，其特征在于，所述应急广播系统包括应急广播平台、主终端及若干个从终端，所述应急广播平台与主终端之间存在连接通路，实现互相通信，主终端与若干个从终端均接入同一个局域网，主终端与若干个从终端之间互相通信，主终端确定其与从终端之间的单向传输时延，然后匹配单向传输时延，在匹配单向传输时延的前提下，主终端向从终端同步转发音频广播数据。
说明书desc
技术领域本发明涉及应急广播音频同步处理的技术领域，更具体地，涉及一种应急广 播多终端音频的同步方法及应急广播系统。背景技术目前，应急广播系统遍布全国各个地区，应急广播消息下发过程和消息实际 播放过程中的快速精准性是保障应急广播及时有效传播的关键。在保障应急广播 的及时有效传播方面，各方研究者也做出了较多的努力，如现有技术中公开了一 种应急广播系统，包括应急广播平台以及通过互联网与应急广播平台进行信息沟 通的各种终端设备，更具体地限定了应急广播平台包括PC端控制平台、手机端 控制平台、管理控制服务器和文件服务器，其中，PC端控制平台、手机端控制 平台、文件服务器、管理控制服务器两两之间能够互相通信，PC端控制平台和 手机端控制平台将播放内容以文件的形式传送到文件服务器上存储，并将存储的 相关信息登记到管理控制服务器，PC端控制平台和手机端控制平台能够分别通 过所述管理控制服务器发布广播消息、并接收来自终端设备的消息，还通过管理控制服务器实现消息同步，该方案从细节组成部分上保障应急广播系统能够随时 随地发布紧急消息，随时查询播放状态并快速调整播放内容和状态，使得广播消 息发布快速精准，但在若干个应急广播终端共同接入一个局域网系统时，通常网 络的原因使得应急广播平台到不同终端设备的传输路径时延出现不一致的现象， 在长时间的应急广播播放过程中，相邻的终端设备播放的内容存在时延差，音频 播出常出现不能同步的情况，用户无法听到流畅的音频播出内容，无法保障应急 广播的及时有效传播。发明内容为解决应急广播平台与每一个应急广播终端均保持连接的方式，在因网络存 在广播传输时延差时，导致应急广播终端播放音频不同步的问题，本发明提出一 种应急广播多终端音频的同步方法及应急广播系统，保障应急广播多终端音频的 同步效果，保证了应急广播的及时有效传播。为了达到上述技术效果，本发明的技术方案如下：一种应急广播多终端音频的同步方法，所述方法包括以下步骤:S1.将若干个应急广播终端划分至不同的群组，将属于同一群组的应急广播 终端接入同一个局域网；S2.在接入同一个局域网的同一群组的应急广播终端中选举出主终端，将除 主终端之外的其它应急广播终端作为从终端；S3.主终端与应急广播平台建立连接通路，接收应急广播平台下发的音频广 播数据；S4.主终端确定其与从终端之间的单向传输时延，然后匹配单向传输时延；S5.在匹配单向传输时延的前提下，主终端向从终端同步转发音频广播数据。在本技术方案中，首先将若干个应急广播终端划分至不同的群组，将属于同 一群组的应急广播终端接入同一个局域网，然后在属于同一群组的应急广播终端 中选举一个主终端与应急广播平台保持连接，即仅有一个终端与应急广播平台连 接，相较于应急广播平台与每一个应急广播终端均保持连接的方式，占用的网络 带宽更低，实现更为简单。此外，考虑由主终端将接收的音频广播数据再在局域 网内部转发，转发的数据到达从终端也存在时延的问题，匹配单向传输时延，实 现主终端向从终端同步转发音频广播数据，保障应急广播多终端音频的同步效果， 保证了应急广播的及时有效传播。优选地，步骤S1中所述的将若干个应急广播终端划分至不同的群组时，根 据应急广播终端的安装地点划分，位于同一安装点的若干个应急广播终端划分至 同一个群组。通过以上划分的方式，降低了网络占用带宽。优选地，步骤S2中，主终端选举的过程为：S21.将接入同一局域网的同一群组的应急广播终端上电运行，在上电运行开 始时，各个应急广播终端均将自身的设备ID置为主终端ID；S22.设置定时器T1及定时器T1的定时时间，在各个应急广播终端上电运行 时间到达定时时间时，各个应急广播终端均发送选举协商广播消息，内容包括应 急广播终端的设备ID、MAC地址及IP地址；S23.在各个应急广播终端各自发送选举协商广播消息之前，判断各个应急广 播终端是否接收到其它应急广播终端发送的选举协商广播消息，且其它应急广播 终端发送的选举协商广播消息携带的设备ID大于自身的设备ID，若是，未发送 选举协商广播消息的应急广播终端选举失败，进入静默模式；否则，执行步骤 S24；S24.在各个应急广播终端各自发送选举协商广播消息之后，设置定时器T2 及定时器T2的定时时间，在定时器T2定时时间到达之前，各个应急广播终端 持续接收其它应急广播终端发送的选举协商广播消息；S25.判断各个应急广播终端是否接收到其它应急广播终端发送的选举协商 广播消息，且其它应急广播终端发送的选举协商广播消息携带的设备ID大于自 身的设备ID，若是，将原设置为主终端ID的自身的设备ID更新，并进入静默 模式；否则，执行步骤S26；S26.若在定时器T2定时到达后仍未收到其它应急广播终端发送的选举协商 广播消息，则表明本应急广播终端为主终端，同时进入主动模式，并重新启动定 时器T2，重复监控其它应急广播终端发送的选举协商广播消息；S27.在部分应急广播终端进入静默模式后，设置定时器T3及定时器T3的定 时时间，在定时器T3定时到达之前，接收其它应急广播终端发送的选举协商广 播消息；S28.判断应急广播终端接收的其它应急广播终端发送的选举协商广播消息 携带的设备ID是否大于步骤S25记录的主终端ID，若是，则将步骤S25记录的 主终端ID更新为新的设备ID，选举结束；否则，步骤S25记录的主终端ID不 变，选举结束。在此，步骤S23中若各个应急广播终端接收到其它应急广播终端发送的选举 协商广播消息，且其它应急广播终端发送的选举协商广播消息携带的设备ID大 于自身的设备ID，则代表本应急广播终端必然不是主终端，随机其进行入静默 模式，仅监控并接收其它应急广播终端发送的选举协商广播消息，可以保证只要 确定了在局域网内本终端不是主终端这个信息，即停发送广播消息，避免广播风 暴及占用过多的网络带宽。步骤S26中，应急广播终端进入主动模式时，定期发 送广播消息，是因为主终端可能异常掉线，其周期性的发送广播消息就是让其余 从终端在主终端掉线后能从静默模式中苏醒并重新举行选举。步骤S28中，若应 急广播终端接收的其它应急广播终端发送的选举协商广播消息携带的设备ID是 大于步骤S25记录的主终端ID，则表明局域网内中有一个新终端接入，其与原来的主终端进行了重新选举并选举获胜，所以需要重新记录主终端的信息。优选地，步骤S28之后还包括：若定时器T3定时到达之后，进入静默模式的应急广播终端未接收到步骤S25 记录的主终端发送的选举协商广播消息，则步骤S25记录的主终端下线，进入静 默模式的应急广播终端结束静默模式，返回S21重新选举主终端。优选地，定时器T1的定时时间为时间段内任意一个随机值，T表示大 于0的时间，定时器T3的定时时间长度大于定时器T2的定时时间长度。在此，定时器T1的定时时间为时间段内任意一个随机值，避免所有应 急广播终端上线后同时发送广播消息造成的网络拥堵现象发生，同时从概率学角 度来讲，拥有最大设备ID的终端在所有应急广播终端中有近一半的概率是在顺 序位置居中发送的消息，这样平均有一半左右的终端不需要发送消息就能完成选 举，可以减少发送一半的广播消息。定时器T2是为了保证主终端下线后其它终 端能从静默模式下苏醒并重新选举主终端，保证系统的稳定性，也为了与后续入 网的终端进行选举竞争，保证有后续入网的终端加入时整个选举机制是完备的。 定时器T3是从终端在静默模式下的定时，其目的是保证主终端下线后从终端能 从静默模式下苏醒恢复并重新选举，在实际实现过程中定时器T3的时长应大于 T2的时长，以保证不会误触发。优选地，步骤S3所述的主终端与应急广播平台建立连接通路的过程为：S31.主终端向应急广播平台发起建立连接请求，应急广播平台收到主终端发 送的建立连接请求后响应建立连接请求的应答，通过双方握手建立连接；S32.应急广播平台向主终端下发消息报文，主终端接收消息报文，与应急广 播平台建立连接通路。所述消息报文为确认主终端转发音频广播数据组播IP地 址或告知主终端主终端自主确定转发音频广播数据组播IP地址的消息报文。在此，消息报文的内容表明可以由应急广播平台远程设置主终端转发的组播 IP地址，方便应急广播平台监控管理，也可根据实际场景由主终端灵活配置。优选地，步骤S3中主终端接收应急广播平台下发的音频广播数据后，采用 RTSP协议，通过应急广播平台下发的URL，调用FFMPEG API接口，将音频广 播数据存储在主终端的中转服务站等待转发，防止了上级应急广播数据包的丢失。优选地，步骤S4中主终端确定其与从终端之间的单向传输时延，然后匹配 单向传输时延的过程为：S41.主终端向每一个从终端发送时延测量广播请求消息，在消息中同时置入 当前时刻时间t1；S42.每一个从终端接收到主终端发送的时延测量广播请求消息后，即刻回送 一个时延测量应答消息，应答消息中将接收的时延测量广播请求消息中的t1同 时携带返回；S43.主终端接收每一个从终端的时延测量应答消息，记录接收时刻时间t2， 并通过t＝/2求得单向传输时延；S44.设主终端的从终端共N个，主终端与每一个从终端的单向传输时延表示 为ti，i＝1,2，…,N，以主终端与每一个从终端的单向传输时延的平均值作为主终 端与从终端之间的单向传输时延，表达式为：其中，tavg表示主终端与每一个从终端的单向传输时延的平均值；S45.主终端自身准备进行某条音频广播数据播发之前，提前一个单向传输时 延tavg将该条音频广播数据从主终端的中转服务站中转发，以匹配单向传输时延。在此，主终端本身需要对音频广播数据进行播发，由于主终端到从终端之间 的中转链路可能存在影响听觉的时延，所以主终端需要相应匹配主、从链路的传 输路径时间相应的延时，以实现同步性。优选地，步骤S5中所述在匹配单向传输时延的前提下，主终端向从终端同 步转发音频广播数据时，向从终端广播转发组播IP地址，以保证每个从终端能 按主终端设置的组播IP地址准确接收转发的音频广播数据，主终端在广播转发 的组播IP地址之后，即可以将存储在中转服务站的音频广播数据以组播IP的方 式转发至各个从终端。本发明还提出一种应急广播系统，所述应急广播系统包括应急广播平台、主 终端及若干个从终端，所述应急广播平台与主终端之间存在连接通路，实现互相 通信，主终端与若干个从终端均接入同一个局域网，主终端与若干个从终端之间 互相通信，主终端确定其与从终端之间的单向传输时延，然后匹配单向传输时延， 在匹配单向传输时延的前提下，主终端向从终端同步转发音频广播数据。与现有技术相比，本发明技术方案的有益效果是：本发明提出一种应急广播多终端音频的同步方法及应急广播系统，首先将若 干个应急广播终端划分至不同的群组，将属于同一群组的应急广播终端接入同一 个局域网，然后在属于同一群组的应急广播终端中选举一个主终端与应急广播平 台保持连接，相较于传统应急广播平台与每一个应急广播终端均保持连接的方式， 占用的网络带宽更低，实现更为简单。此外，考虑由主终端将接收的音频广播数 据再在局域网内部转发，转发的数据到达从终端也存在时延的问题，计算并匹配 单向传输时延，实现主终端向从终端同步转发音频广播数据，保障应急广播多终 端音频的同步效果，保证了应急广播的及时有效传播。附图说明图1表示本发明实施例1中提出的应急广播多终端音频的同步方法的流程图；图2表示本发明实施例1中提出的主终端选举的过程流程图；图3表示本发明实施例2中提出的主终端与应急广播平台建立连接通路的流程图；图4表示本发明实施例2中提出的主终端确定其与从终端之间的单向传输时延，然后匹配单向传输时延的流程图；图5表示本发明实施例3中提出的应急广播系统的结构图。具体实施方式附图仅用于示例性说明，不能理解为对本专利的限制；为了更好地说明本实施例，附图某些部位会有省略、放大或缩小，并不代表 实际尺寸；对于本领域技术人员来说，附图中某些公知内容说明可能省略是可以理解的。附图中描述位置关系的用于仅用于示例性说明，不能理解为对本专利的限制；下面结合附图和实施例对本发明的技术方案做进一步的说明。实施例1本发明实施例中针对应急广播中多个需要进行音频同步的终端，提出在一个 局域网内部的多个音频终端中，将一个终端作为主终端，主终端负责与应急广播 平台进行连接，并将应急平台下发的音频广播数据在进行播发的同时进行中继转 发，其余的终端作为从终端，接收主终端转发的音频广播数据并进行播发。具体 的实施过程的流程示意图参见图1，如图1所示的应急广播多终端音频的同步方 法，包括以下步骤:S1.将若干个应急广播终端划分至不同的群组，将属于同一群组的应急广播 终端接入同一个局域网；S2.在接入同一个局域网的同一群组的应急广播终端中选举出主终端，将除 主终端之外的其它应急广播终端作为从终端；S3.主终端与应急广播平台建立连接通路，接收应急广播平台下发的音频广 播数据；S4.主终端确定其与从终端之间的单向传输时延，然后匹配单向传输时延；S5.在匹配单向传输时延的前提下，主终端向从终端同步转发音频广播数据。在本实施例中，考虑应急广播终端的实际使用场景，安装位置相邻或相近的 终端会接入同一个局域网，因此在步骤S1中，将若干个应急广播终端划分至不 同的群组的过程为：将若干个应急广播终端划分至不同的群组时，根据应急广播终端的安装地点 划分，位于同一安装点的若干个应急广播终端划分至同一个群组。一般在实际实 施时，比如一个电线杆上，某个建筑物上，属于同一个安装点，通过以上划分的 方式，降低了网络占用带宽。在本实施例中，步骤S2中，主终端选举的过程遵循终端自主选举机制，是 各终端上电正常工作后，首先根据一种自协商的机制在局域网内部自主协商选举 出主终端，这个过程是终端之间自主进行的，无需用户手动配置，具体过程参见 图2，包括：S21.将接入同一局域网的同一群组的应急广播终端上电运行，在上电运行开 始时，各个应急广播终端均将自身的设备ID置为主终端ID；这里的设备ID是 指每一个终端设备在出厂之前会固化一个设备ID，这个设备ID是唯一的，每个 终端的设备ID均不相同，此ID即作为终端之间判定作为主终端的依据信息。S22.设置定时器T1及定时器T1的定时时间，在各个应急广播终端上电运行 时间到达定时时间时，各个应急广播终端均发送选举协商广播消息，内容包括应 急广播终端的设备ID、MAC地址及IP地址；S23.在各个应急广播终端各自发送选举协商广播消息之前，判断各个应急广 播终端是否接收到其它应急广播终端发送的选举协商广播消息，且其它应急广播 终端发送的选举协商广播消息携带的设备ID大于自身的设备ID，若是，未发送 选举协商广播消息的应急广播终端选举失败，进入静默模式；否则，执行步骤 S24；步骤S23中若各个应急广播终端接收到其它应急广播终端发送的选举协商 广播消息，且其它应急广播终端发送的选举协商广播消息携带的设备ID大于自 身的设备ID，则代表本应急广播终端必然不是主终端，随机其进行入静默模式， 仅监控并接收其它应急广播终端发送的选举协商广播消息，可以保证只要确定了 在局域网内本终端不是主终端这个信息，即停发送广播消息，避免广播风暴及占 用过多的网络带宽。S24.在各个应急广播终端各自发送选举协商广播消息之后，设置定时器T2 及定时器T2的定时时间，在定时器T2定时时间到达之前，各个应急广播终端 持续接收其它应急广播终端发送的选举协商广播消息；S25.判断各个应急广播终端是否接收到其它应急广播终端发送的选举协商 广播消息，且其它应急广播终端发送的选举协商广播消息携带的设备ID大于自 身的设备ID，若是，将原设置为主终端ID的自身的设备ID更新，并进入静默 模式；否则，执行步骤S26；S26.若在定时器T2定时到达后仍未收到其它应急广播终端发送的选举协商 广播消息，则表明本应急广播终端为主终端，同时进入主动模式，并重新启动定 时器T2，重复监控其它应急广播终端发送的选举协商广播消息；应急广播终端 进入主动模式时，定期发送广播消息，是因为主终端可能异常掉线，其周期性的 发送广播消息就是让其余从终端在主终端掉线后能从静默模式中苏醒并重新举 行选举。S27.在部分应急广播终端进入静默模式后，设置定时器T3及定时器T3的定 时时间，在定时器T3定时到达之前，接收其它应急广播终端发送的选举协商广 播消息；S28.判断应急广播终端接收的其它应急广播终端发送的选举协商广播消息 携带的设备ID是否大于步骤S25记录的主终端ID，若是，则将步骤S25记录的 主终端ID更新为新的设备ID，选举结束；否则，步骤S25记录的主终端ID不 变，选举结束。若应急广播终端接收的其它应急广播终端发送的选举协商广播消 息携带的设备ID是大于步骤S25记录的主终端ID，则表明局域网内中有一个新 终端接入，其与原来的主终端进行了重新选举并选举获胜，所以需要重新记录主 终端的信息。步骤S28之后还包括：若定时器T3定时到达之后，进入静默模式的应急广播终端未接收到步骤S25 记录的主终端发送的选举协商广播消息，则步骤S25记录的主终端下线，进入静 默模式的应急广播终端结束静默模式，返回S21重新选举主终端。通过以上过程，将每个应急广播终端均与应急广播平台建立连接的时延难以 控制的难题转换为仅主终端与平台建立单个连接，在主终端与平台时间就不存在 需要两条以上的连接路径延时控制的问题。在本实施例中，定时器T1的定时时间为时间段内任意一个随机值，避 免所有应急广播终端上线后同时发送广播消息造成的网络拥堵现象发生，同时从 概率学角度来讲，拥有最大设备ID的终端在所有应急广播终端中有近一半的概 率是在顺序位置居中发送的消息，这样平均有一半左右的终端不需要发送消息就 能完成选举，可以减少发送一半的广播消息。T表示大于0的时间，定时器T3 的定时时间长度大于定时器T2的定时时间长度。定时器T2是为了保证主终端下 线后其它终端能从静默模式下苏醒并重新选举主终端，保证系统的稳定性，也为 了与后续入网的终端进行选举竞争，保证有后续入网的终端加入时整个选举机制 是完备的。定时器T3是从终端在静默模式下的定时，其目的是保证主终端下线 后从终端能从静默模式下苏醒恢复并重新选举，在实际实现过程中定时器T3的 时长应大于T2的时长，以保证不会误触发。实施例2在本实施例中，基于实施例1已经选举出的主终端，需要将主终端与应急广 播平台建立连接通路，然后接收应急广播平台下发的音频广播数据；参见图3，主终端与应急广播平台建立连接通路的过程为：S31.主终端向应急广播平台发起建立连接请求，应急广播平台收到主终端发 送的建立连接请求后响应建立连接请求的应答，通过双方握手建立连接；S32.应急广播平台向主终端下发消息报文，主终端接收消息报文，与应急广 播平台建立连接通路。其中，消息报文为确认主终端转发音频广播数据组播IP地址或告知主终端 主终端自主确定转发音频广播数据组播IP地址的消息报文，消息报文的内容表 明可以由应急广播平台远程设置主终端转发的组播IP地址，方便应急广播平台 监控管理，也可根据实际场景由主终端灵活配置。在此之后，主终端采用RTSP协议，通过应急广播平台下发的URL，调用 FFMPEG API接口，将音频广播数据存储在主终端的中转服务站等待转发，防止 了上级应急广播数据包的丢失。由主终端组播转发音频数据，主终端到各个从终端的时延由于主、从终端均 在一个局域网内部，时延不会有太大的差别，因此也不需要考虑主终端到不同从 终端时延控制的问题。然而，在实际实施时，主终端本身也需要对音频广播数据 进行播发，由于主终端到从终端之间的中转链路可能存在影响听觉的时延，所以 主终端需要相应匹配主从链路的传输路径时间相应的延时，以广播实现同步性。参见图4，主终端确定其与从终端之间的单向传输时延，然后匹配单向传输 时延的过程为：S41.主终端向每一个从终端发送时延测量广播请求消息，在消息中同时置入 当前时刻时间t1；S42.每一个从终端接收到主终端发送的时延测量广播请求消息后，即刻回送 一个时延测量应答消息，应答消息中将接收的时延测量广播请求消息中的t1同 时携带返回；S43.主终端接收每一个从终端的时延测量应答消息，记录接收时刻时间t2， 并通过t＝/2求得单向传输时延；S44.设主终端的从终端共N个，主终端与每一个从终端的单向传输时延表示 为ti，i＝1,2，…,N，以主终端与每一个从终端的单向传输时延的平均值作为主终 端与从终端之间的单向传输时延，表达式为：其中，tavg表示主终端与每一个从终端的单向传输时延的平均值；S45.主终端自身准备进行某条音频广播数据播发之前，提前一个单向传输时 延tavg将该条音频广播数据从主终端的中转服务站中转发，以匹配单向传输时延。在匹配单向传输时延的前提下，主终端向从终端同步转发音频广播数据时， 向从终端广播转发组播IP地址，以保证每个从终端能按主终端设置的组播IP地 址准确接收转发的音频广播数据，主终端在广播转发的组播IP地址之后，即可 以将存储在中转服务站的音频广播数据以组播IP的方式转发至各个从终端。实施例3在实施例1和实施例2提出的应急广播多终端音频的同步方法下，在本实施 例提出一种应急广播系统，结构图如图5所示，参见图5，应急广播系统包括应 急广播平台、主终端及若干个从终端，设从终端共N个，应急广播平台与主终 端之间存在连接通路，实现互相通信，主终端与N个从终端均接入同一个局域 网，主终端与N个从终端之间互相通信，主终端确定其与从终端之间的单向传 输时延，然后匹配单向传输时延，过程为：主终端向每一个从终端发送时延测量广播请求消息，在消息中同时置入当前 时刻时间t1；每一个从终端接收到主终端发送的时延测量广播请求消息后，即刻回送一个 时延测量应答消息，应答消息中将接收的时延测量广播请求消息中的t1同时携 带返回；主终端接收每一个从终端的时延测量应答消息，记录接收时刻时间t2，并通 过t＝/2求得单向传输时延；设主终端的从终端共N个，主终端与每一个从终端的单向传输时延表示为 ti，i＝1,2，…,N，以主终端与每一个从终端的单向传输时延的平均值作为主终端 与从终端之间的单向传输时延，表达式为：其中，tavg表示主终端与每一个从终端的单向传输时延的平均值；主终端自身准备进行某条音频广播数据播发之前，提前一个单向传输时延 tavg将该条音频广播数据从主终端的中转服务站中转发，以匹配单向传输时延。在匹配单向传输时延的前提下，主终端向从终端同步转发音频广播数据。显然，本发明的上述实施例仅是为清楚地说明本发明所作的举例，而并非是 对本发明的实施方式的限定。对于所属领域的普通技术人员来说，在上述说明的 基础上还可以做出其它不同形式的变化或变动。这里无需也无法对所有的实施方 式予以穷举。凡在本发明的精神和原则之内所作的任何修改、等同替换和改进等， 均应包含在本发明权利要求的保护范围之内。
