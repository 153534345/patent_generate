标题title
一种智能电表基于性能调整TLS协议选择的方法
摘要abst
本发明的目的是提供一种智能电表基于性能调整TLS协议选择的方法，涉及电力设备技术领域。通过本发明的处理，智能电表可以根据自身的运行空间、计量推送要求、运行速度在TLS握手过程中选择合适ECC曲线进行的密钥协商、数字签名、数字验签，同时智能电表应用层可以根据实际使用的TLS安全套件进行数据流调整。智能电表基于性能调整TLS协议选择的方法，主要包括：1.电表根据运行空间、计量推送要求、运行速度，计算不同曲线位数下各类算法的耗时；2.电表根据各曲线下各算法的耗时，及客户端握手响应要求，进行TLS握手；3.电表的应用层根据实际协商出的TLS安全套件，进行数据流调整。
权利要求书clms
1.一种智能电表基于性能调整TLS协议选择的方法，其特征在于该方法包括下列步骤：S1、电表端响应于客户端发送的握手信息，计算握手信息中对应环节所涉及的ECC算法在各ECC曲线类型下的运算时间，并选择适用的ECC曲线；S2、电表端将所选ECC曲线用于本握手环节中的ECC算法，进行TLS握手。2.根据权利要求1所述的智能电表基于性能调整TLS协议选择的方法，其特征在于：握手环节包括密钥协商、数字签名和数字验签；ECC算法包括ECC密钥对生成算法、ECC密钥协商算法、ECC数字签名算法和ECC数字验签算法；ECC曲线包括：secp256r1、secp384r1、secp521r1、BrainpoolP256r1、BrainpoolP384r1和BrainpoolP512r1。3.根据权利要求1所述的智能电表基于性能调整TLS协议选择的方法，其特征在于：任一环节涉及多个ECC算法时，各ECC算法采用同样的ECC曲线。4.根据权利要求1所述的智能电表基于性能调整TLS协议选择的方法，其特征在于：步骤S1中，计算握手信息中对应环节所涉及的ECC算法在各ECC曲线类型下的运算时间具体为：S1-1、根据电表端实际运行空间，计算ECC算法采用各ECC曲线类型的可用滑动窗口尺寸windowsSizei；其中：i表示ECC曲线的编号，i＝1、2、3...n，n表示ECC曲线的总数；memorySpace表示电表端当前的实际剩余运行空间，单位byte；keybitsi为编号为i的ECC曲线的私钥长度比特位数；S1-2、将计量推送时间作为ECC算法的单次运算时间阈值，记为sin g leTime；S1-3、电表端根据可用滑动窗口尺寸、单次运算时间阈值和电表运算速度，采用下述公式计算当前握手环节所采用的各类ECC算法在各曲线类型下单次可运算的位数OneNumji及完成对应ECC算法的耗时Timeji；其中：Frequency表示电表运算速度，InstructionNumj表示编号为j的ECC算法的单次运算的指令数，perwindowsj表示编号为j的ECC算法中滑动窗口相关指令在编号为j的ECC算法所有指令中的占比；S1-4、将握手环节中所需ECC算法在各个曲线下的耗时Timeji与握手响应时间比对，在该环节所有ECC算法采用对应ECC曲线耗时之和小于响应时间要求的曲线中，选择ECC曲线比特位数最长的ECC曲线用于本握手环节中的ECC算法。5.根据权利要求1所述的智能电表基于性能调整TLS协议选择的方法，其特征在于：该方法还包括以下步骤：S3、TLS握手后，电表端的应用层根据实际协商出的TLS安全套件，进行数据流调整。6.根据权利要求5所述的智能电表基于性能调整TLS协议选择的方法，其特征在于：TLS安全套件包括：TLS1.2—0xC023、0xC024、0xC02B、0xC02C，TLS1.3—0x1301、0x1302和0x1304。7.根据权利要求5所述的智能电表基于性能调整TLS协议选择的方法，其特征在于：数据流调整具体为：根据TLS握手协商出的安全套件预留出对应的TLS头尾空间，进行应用层数据加密，头部预留空间为IV len减去fixedIV len字节，尾部预留空间为Pad len加上MAC len或者Padlen加上Tag len字节。8.根据权利要求5所述的智能电表基于性能调整TLS协议选择的方法，其特征在于：智能电表的数据流采用内存复用即应用层、TLS层和物理层三层数据流共用一个空间的形式。9.根据权利要求2所述的智能电表基于性能调整TLS协议选择的方法，其特征在于：握手信息中各环节的ECC算法曲线选择具体为：密钥协商环节，电表端在解析Client Hello和编写Server Hello过程中，需要选择密钥协商用的ECC曲线，用于ECC密钥对生成及ECC密钥协商算法，电表端根据两者相加的时间及客户端响应要求确定使用的曲线；数字签名环节，电表端根据计算出的各曲线进行ECC数字签名需要的运行时间，选择运行时间在客户端响应要求时间内的最优曲线，进行证书验证并发送给客户端；数字验签环节，电表端计算各类ECC曲线验证签名需要的时间，并将客户端响应要求时间内可计算完成的曲线类型写入证书请求内，并在收到客户端证书验证后进行验证。10.根据权利要求1所述的智能电表基于性能调整TLS协议选择的方法，其特征在于：当电表端需要计量推送数据时，退出ECC算法，优先进行计量及其推送，随后再启动ECC算法。
说明书desc
技术领域本发明涉及电力设备技术领域，尤其是一种智能电表基于性能调整TLS协议选择的方法。背景技术智能电表作为智能电网中的数据采集设备，其采集的数据涉及用户隐私、电力公司的盈利等方面，必须对信息进行安全保护，确保信息安全传输，防止数据泄露、恶意篡改。安全传输层协议TLS被认为是现在最好的传输安全协议，最新版本TLS1.3于2018年发布，被广泛地用于各大银行、电子商务、电子邮箱服务中。智能电网也逐步开始使用TLS协议，因此，针对智能电表通信安全需求，在智能电表中建立支持TLS协议的安全层，已经成为共识。但是TLS协议非常庞大，需要各类对称非对称算法的支持，而智能电表作为在智能电网内运行的嵌入式设备，其运行空间是非常有限的，而且通常没有硬件加密芯片的支持，所以想要完全支持TLS协议是非常困难的。发明内容本发明的目的是针对智能电表支持TLS协议时的问题，提出一种智能电表基于性能自动调整TLS协议选择的方法。智能电表根据自身的运行空间、计量推送要求、运行速度在TLS握手过程中选择合适ECC曲线进行密钥协商、数字签名，证书验证，并且根据实际使用的TLS安全套件进行数据流调整。本发明的技术方案是：本发明提供一种智能电表基于性能调整TLS协议选择的方法，该方法包括下列步骤：S1、电表端响应于客户端发送的握手信息，计算握手信息中对应环节所涉及的ECC算法在各ECC曲线类型下的运算时间，并选择适用的ECC曲线；S2、电表端将所选ECC曲线用于本握手环节中的ECC算法，进行TLS握手。进一步地，握手环节包括密钥协商、数字签名和数字验签；ECC算法包括ECC密钥对生成算法、ECC密钥协商算法、ECC数字签名算法和ECC数字验签算法；ECC曲线包括：secp256r1、secp384r1、secp521r1、BrainpoolP256r1、BrainpoolP384r1和BrainpoolP512r1。进一步地，任一环节涉及多个ECC算法时，各ECC算法采用同样的ECC曲线。进一步地，步骤S1中，计算握手信息中对应环节所涉及的ECC算法在各ECC曲线类型下的运算时间具体为：S1-1、根据电表端实际运行空间，计算ECC算法采用各ECC曲线类型的可用滑动窗口尺寸windowsSizei；其中：i表示ECC曲线的编号，i＝1、2、3...n，n表示ECC曲线的总数；memorySpace表示电表端当前的实际剩余运行空间，单位byte；keybitsi为编号为i的ECC曲线的私钥长度比特位数；S1-2、将计量推送时间作为ECC算法的单次运算时间阈值，记为sing leTime；S1-3、电表端根据可用滑动窗口尺寸、单次运算时间阈值和电表运算速度，采用下述公式计算当前握手环节所采用的各类ECC算法在各曲线类型下单次可运算的位数OneNumji及完成对应ECC算法的耗时Timeji；其中：Frequency表示电表运算速度，InstructionNumj表示编号为j的ECC算法的单次运算的指令数，perwindowsj表示编号为j的ECC算法中滑动窗口相关指令在编号为j的ECC算法所有指令中的占比；S1-4、将握手环节中所需ECC算法在各个曲线下的耗时Timeji与握手响应时间比对，在该环节所有ECC算法采用对应ECC曲线耗时之和小于响应时间要求的曲线中，选择ECC曲线比特位数最长的ECC曲线用于本握手环节中的ECC算法。进一步地，该方法还包括以下步骤：S3、TLS握手后，电表端的应用层根据实际协商出的TLS安全套件，进行数据流调整。进一步地，TLS安全套件包括：TLS1.2—0xC023、0xC024、0xC02B、0xC02C，TLS1.3—0x1301、0x1302和0x1304。进一步地，数据流调整具体为：根据TLS握手协商出的安全套件预留出对应的TLS头尾空间，进行应用层数据加密，头部预留空间为IV len减去fixedIV len字节，尾部预留空间为Pad len加上MAC len或者Pad len加上Tag len字节。进一步地，智能电表的数据流采用内存复用即应用层、TLS层和物理层三层数据流共用一个空间的形式。进一步地，握手信息中各环节的ECC算法曲线选择具体为：密钥协商环节，电表端在解析Client Hello和编写Server Hello过程中，需要选择密钥协商用的ECC曲线，用于ECC密钥对生成及ECC密钥协商算法，电表端根据两者相加的时间及客户端响应要求确定使用的曲线；数字签名环节，电表端根据计算出的各曲线进行ECC数字签名需要的运行时间，选择运行时间在客户端响应要求时间内的最优曲线，进行证书验证并发送给客户端；数字验签环节，电表端计算各类ECC曲线验证签名需要的时间，并将客户端响应要求时间内可计算完成的曲线类型写入证书请求内，并在收到客户端证书验证后进行验证。进一步地，当电表端需要计量推送数据时，退出ECC算法，优先进行计量及其推送，随后再启动ECC算法。本发明的有益效果：本发明在智能电表没有硬件加密算法支持的情况下，在有限的运算空间、运算速度下，完成了TLS1.2及TLS1.3协议，并根据握手过程中实际的运行状态进行各类算法运算时间预测，在客户端允许范围内选择安全度最高、最优的TLS协议选项，并通过内存复用使智能电表的应用层、TLS层和物理层三层数据流共用一个空间来减小程序对运行空间的占用。本发明的其它特征和优点将在随后具体实施方式部分予以详细说明。附图说明通过结合附图对本发明示例性实施方式进行更详细的描述，本发明的上述以及其它目的、特征和优势将变得更加明显，其中，在本发明示例性实施方式中，相同的参考标号通常代表相同部件。图1为电表端ECC算法的耗时计算流程图；图2为电表端与客户端的TLS握手过程示意图；图3为电表端内TLS应用层的数据结构图。具体实施方式下面将参照附图更详细地描述本发明的优选实施方式。虽然附图中显示了本发明的优选实施方式，然而应该理解，可以以各种形式实现本发明而不应被这里阐述的实施方式所限制。本实施例的一种智能电表基于性能调整TLS协议选择的方法，使用在支持TLS协议的电表上，本发明中TLS协议安全套件包括TLS1.2—0xC023、0xC024、0xC02B、0xC02C，TLS1.3—0x1301、0x1302、0x1303，使用的非对称算法为ECC，具体算法包括：ECC密钥对生成、ECC密钥协商、ECC数字签名、ECC数字验证，ECC曲线类型包括：secp256r1、secp384r1、secp521r1、BrainpoolP256r1、BrainpoolP384r1、BrainpoolP512r1，该方法的实现通过以下3个方面进行，电表端根据运行空间、计量推送要求、运行速度，计算不同曲线位数下各类算法的耗时：如图1所示，计算不同ECC曲线各类算法的耗时过程如下：S1、电表端根据运行空间，确定ECC算法可以使用的滑动窗口大小；电表端在不同的功能启用状态下，其可用与ECC算法的运行空间是不同的，当需要执行ECC算法时，电表端根据当前的剩余运行空间，开辟不同大小的ECC滑动窗口，剩余的空间越大，可开辟的滑动窗口越大，ECC运算的速度越快。ECC曲线的位数越大，可以开辟的滑动窗口越小，ECC运算的速度越慢。运行空间和窗口大小的关系可表示：其中：i表示ECC曲线的编号，i＝1、2、3...n，n表示ECC曲线的总数；memorySpace表示电表端当前的实际剩余运行空间，单位byte；keybitsi为编号为i的ECC曲线的私钥长度比特位数；S2、电表端根据计量推送要求，确定ECC算法的单次运算时间阈值，记为singleTime；在没有硬件加速的情况下，进行ECC算法，耗时较长，但电表作为计量工具，需要首先保证计量推送功能，在需要进行计量推送的情况下，及时退出ECC算法，优先进行计量及其推送，随后再继续ECC算法。计量推送时间即为此示例中单次可执行ECC时间，记为SingleTime。S3、电表端根据可用滑动窗口尺寸、单次运算时间阈值和电表运算速度，采用下述公式计算当前握手环节所采用的各类ECC算法在各曲线类型下单次可运算的位数OneNumji及完成对应ECC算法的耗时Timeji；其中：Frequency表示电表运算速度，InstructionNumj表示编号为j的ECC算法的单次运算的指令数，perwindowsj表示编号为j的ECC算法中滑动窗口相关指令在编号为j的ECC算法所有指令中的占比；S4、将握手环节中所需ECC算法在各个曲线下的耗时Timeji与握手响应时间比对，在该环节所有ECC算法采用对应ECC曲线耗时之和小于响应时间要求的曲线中，选择ECC曲线的私钥长度比特位数最长的ECC曲线用于本握手环节中的ECC算法。本发明在智能电表没有硬件加密算法支持的情况下，根据握手过程中实际的运行状态，开辟不同大小的滑动窗口进行ECC运算加速，并进行各类ECC算法运算时间的预测，平衡计量推送时间和单次运算ECC的时间、平衡客户端响应时间要求和ECC整体运算时间，在客户端允许范围内选择安全度最高、最优的TLS协议选项，并通过内存复用使智能电表的应用层、TLS层和物理层三层数据流共用一个空间来减小TLS对运行空间的占用，成功的在有限的运算空间、运算速度下，在保证原有计量等功能正常运行的情况下，使智能电表兼容支持TLS1.2及TLS1.3协议，包括TLS1.2安全套件0xC023、0xC024、0xC02B、0xC02C，TLS1.3安全套件0x1301、0x1302、0x1304，包括secp256r1、secp384r1、secp521r1、BrainpoolP256r1、BrainpoolP384r1和BrainpoolP512r1曲线下的ECC算法，实现低端设备的高通讯安全性。具体实施时：如图2所示，在TLS1.2及TLS1.3握手流程中，电表都需要选择合适的ECC曲线进行密钥协商、数字签名、数字验签。电表在各TLS握手环节使用不同的算法，每个环节电表根据各曲线的Timeji来确认可以满足客户响应要求握手方案，具体环节可细分为：密钥协商环节，电表在解析Client Hello和编写Server Hello过程中，需要确认密钥协商用的ECC曲线，该曲线用于ECC密钥对生成及ECC密钥协商算法，电表需要根据两者相加的时间及客户端响应要求确定使用的曲线。数字签名环节，电表需根据所拥有的各项私钥-证书的ECC曲线，计算各曲线进行ECC数字签名的需要的运行时间，选择客户端响应要求时间允许范围内的最优证书，进行证书验证并发送给客户端。数字验签环节，电表计算各类ECC曲线验证签名需要的时间，并将客户端响应要求时间范围内可计算完成的曲线类型写入证书请求内，并在收到客户端证书验证后进行验证。TLS握手后，电表端的应用层根据实际协商出的TLS安全套件，进行数据流调整。本发明中，智能电表的数据流采用内存复用-即应用层、TLS层、物理层三层数据流共用一个空间的形式来减少内存空间的使用。cipher suiteIV lenfixedIV lenPad lenMAC len/Tag len0xC02316016320xC02416016480xC02B12416160xC02C12416160x1301121216160x1302121216160x130412121616TLS对应用层数据加密后数据帧格式如附图3所示，应用层数据进入TLS层后，原明文数据将会被数据填充并加密，不同的TLS安全套件使用的加密方式不同，加密后的数据格式都会有所差别，添加的帧头长度和帧尾长度也会不同。电表应用层将数据放入数据流时，根据TLS握手协商出的安全套件预留出不同的TLS头尾空间，以便TLS层进行应用层数据加密，头部预留空间为IV len-减去fixedIV len字节的，尾部预留空间为Pad len加上MAC len或者Pad len加上Tag len字节。具体各类TLS安全套件需预留的空间入下表：以上已经描述了本发明的各实施例，上述说明是示例性的，并非穷尽性的，并且也不限于所披露的各实施例。在不偏离所说明的各实施例的范围和精神的情况下，对于本技术领域的普通技术人员来说许多修改和变更都是显而易见的。
