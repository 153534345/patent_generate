标题title
一种实现多执行体TCP会话归一化的方法和装置
摘要abst
本发明涉及计算机网络技术领域，尤其涉及一种实现多执行体TCP会话归一化的方法和装置，该方法具体为：首先对进入FPGA的报文进行预处理，输出TCP会话信息和TCP报文；然后通过TCP会话归一化管理状态机建立和保持TCP会话，将TCP会话信息保存到TCP会话缓存队列；再使用写控制器和读控制器，将TCP报文写入内存和从内存中读出TCP报文；最后对读出的TCP报文进行TCP字段归一，再重组报文后发出。本发明相比于软件基于DPDK的实现更加快速且效率高；另外，在TCP会话归一化管理状态机中通过双向链表加双池机制，实现会话缓存的快速分配、快速回收以及随机会话老化后的缓存空间快速拆链、建链。
权利要求书clms
1.一种实现多执行体TCP会话归一化的方法，应用于FPGA，其特征在于，包括以下步骤：步骤一，对输入FPGA的报文进行预处理，输出TCP会话信息和TCP报文；步骤二，通过TCP会话归一化管理状态机建立和保持TCP会话，将TCP会话信息保存到TCP会话缓存队列；步骤三，使用写控制器和读控制器，将TCP报文写入内存DDR和从内存DDR中读出TCP报文；步骤四，对读出的TCP报文进行TCP字段归一，再重组报文后发出。2.根据权利要求1所述的一种实现多执行体TCP会话归一化的方法，其特征在于，所述步骤一具体为：对输入报文进行报文类型解析，提取TCP会话信息，在缓冲器中缓存TCP报文，同时创建TCP消息链路，输出TCP会话信息和TCP报文。3.根据权利要求2所述的一种实现多执行体TCP会话归一化的方法，其特征在于，所述TCP会话归一化管理状态机监控TCP消息链路的输出，根据输出的消息进行会话匹配、判断状态跳转、实时更新会话缓存队列和输出报文，采用双池双向链表，即双向链表加双池机制，来进行TCP会话管理。4.根据权利要求3所述的一种实现多执行体TCP会话归一化的方法，其特征在于，所述双池双向链表，具体包括：a.设置双池链表来管理TCP会话缓存节点，双池分别为已使用列表和空闲列表，其中，已使用列表维护已使用的TCP会话缓存节点，空闲列表维护已预留但未使用的TCP会话缓存节点；初始时刻，已使用列表为空状态，空闲列表为满状态，链表中节点的插入、删除操作则通过TCP会话缓存队列来完成；双池的操作为互补关系，当已使用列表中增加节点时，空闲列表会相应地减少节点；b.双池链表中各条表项的链接关系通过双向链表指针来完成，每个指针包含前节点地址索引和后节点地址索引两部分；在TCP会话归一化过程中，节点的插入、删除会触发链表节点指针和头指针和尾指针的更新。5.根据权利要求3所述的一种实现多执行体TCP会话归一化的方法，其特征在于，所述步骤三，具体为：当TCP会话归一化管理状态机判断TCP报文符合过滤规则时，TCP会话归一化管理状态机发出写指令给写控制器，将TCP报文写入内存DDR；当TCP会话归一化管理状态机判断会话归一后，TCP会话归一化管理状态机发出读指令给读控制器，将TCP报文从内存DDR中读出。6.根据权利要求5所述的一种实现多执行体TCP会话归一化的方法，其特征在于，所述将TCP报文写入内存DDR和将TCP报文从内存DDR中读出，具体包括以下步骤：步骤3.1.系统上电复位或用户复位后，TCP会话归一化管理状态机启动，写控制器和读控制器复位；步骤3.2.TCP会话归一化管理状态机检测到TCP报文输入，根据报文解析结果判断报文是否进入TCP会话缓存队列节点，若否则报文穿通，若是则开启写控制器；步骤3.3.写控制器从双池双向链表中查询DMA逻辑内存地址，并映射为DMA物理内存地址，根据TCP会话归一化管理状态机中记录的DMA长度开启写DMA操作，将TCP报文缓存到内存DDR中；步骤3.4.TCP会话归一化管理状态机中输出中断指示多执行体报文已对齐，读控制器从双池双向链表中查询DMA逻辑内存地址，并映射为DMA物理内存地址，根据TCP会话归一化管理状态机中输出的DMA长度开启读DMA操作，将内存DDR中缓存的报文读出。7.根据权利要求5所述的一种实现多执行体TCP会话归一化的方法，其特征在于，所述步骤四，具体为：读控制器读出的TCP报文进行TCP字段归一，字段归一后，报文重组，然后发送出去，完成归一化的整个流程；其中，发送的报文有两个通道，分别是输出到执行体和输出到网口。8.一种采用权利要求1所述的一种实现多执行体TCP会话归一化的方法的实现多执行体TCP会话归一化的装置，基于FPGA，其特征在于，包括：报文预处理单元，用于对输入报文进行报文类型解析，提取TCP会话信息，在缓冲器中缓存TCP报文，同时创建TCP消息链路，输出TCP会话信息和TCP报文；TCP会话管理及归一单元，包括TCP会话管理体和TCP报文控制器，其中的TCP会话管理体采用TCP会话归一化管理状态机，监控TCP消息链路的输出，根据输出的消息进行会话匹配、判断状态跳转、实时更新TCP会话缓存队列，发送读写指令给TCP报文控制器，输出报文。9.根据权利要求8所述的一种实现多执行体TCP会话归一化的装置，其特征在于，所述TCP报文控制器包括写控制器和读控制器，所述写控制器接收TCP会话归一化管理状态机发出的写指令，将TCP报文写入内存DDR；所述读控制器接收TCP会话归一化管理状态机发出的读指令将TCP报文从内存DDR中读出。
说明书desc
技术领域本发明涉及计算机网络技术领域，尤其涉及一种实现多执行体TCP会话归一化的方法和装置。背景技术基于内生安全的拟态安全防御理论应用于网关、交换机等网络设备能显著提高设备的安全性能，但在实际应用时存在难点，如TCP报文的归一化问题。TCP会话是面向连接的，传统的网络通信中，TCP会话只会存在于点对点之间，不存在多对一或一对多的TCP通信模式。在拟态安全系统中，多个执行体彼此独立地运行相同的功能，这也要求多个执行体上同时建立和保持TCP会话，即实现多对一或一对多的TCP通信。目前已经提出了多执行体TCP归一化的方法，但是通过软件来实现的，归一化过程中的报文解析、TCP会话管理、报文缓存和拷贝操作消耗CPU算力，降低了DPDK的执行效率。发明内容为了解决现有技术中存在的上述技术问题，本发明提出了一种实现多执行体TCP会话归一化的方法和装置，其具体技术方案如下：一种实现多执行体TCP会话归一化的方法，应用于FPGA，包括以下步骤：步骤一，对输入FPGA的报文进行预处理，输出TCP会话信息和TCP报文；步骤二，通过TCP会话归一化管理状态机建立和保持TCP会话，将TCP会话信息保存到TCP会话缓存队列；步骤三，使用写控制器和读控制器，将TCP报文写入内存DDR和从内存DDR中读出TCP报文；步骤四，对读出的TCP报文进行TCP字段归一，再重组报文后发出。进一步的，所述步骤一具体为：对输入报文进行报文类型解析，提取TCP会话信息，在缓冲器中缓存TCP报文，同时创建TCP消息链路，输出TCP会话信息和TCP报文。进一步的，所述TCP会话归一化管理状态机监控TCP消息链路的输出，根据输出的消息进行会话匹配、判断状态跳转、实时更新会话缓存队列和输出报文，采用双池双向链表，即双向链表加双池机制，来进行TCP会话管理。进一步的，所述双池双向链表，具体包括：a.设置双池链表来管理TCP会话缓存节点，双池分别为已使用列表和空闲列表，其中，已使用列表维护已使用的TCP会话缓存节点，空闲列表维护已预留但未使用的TCP会话缓存节点；初始时刻，已使用列表为空状态，空闲列表为满状态，链表中节点的插入、删除操作则通过TCP会话缓存队列来完成；双池的操作为互补关系，当已使用列表中增加节点时，空闲列表会相应地减少节点；b.双池链表中各条表项的链接关系通过双向链表指针来完成，每个指针包含前节点地址索引和后节点地址索引两部分；在TCP会话归一化过程中，节点的插入、删除会触发链表节点指针和头指针和尾指针的更新。进一步的，所述步骤三，具体为：当TCP会话归一化管理状态机判断TCP报文符合过滤规则时，TCP会话归一化管理状态机发出写指令给写控制器，将TCP报文写入内存DDR；当TCP会话归一化管理状态机判断会话归一后，TCP会话归一化管理状态机发出读指令给读控制器，将TCP报文从内存DDR中读出。进一步的，所述将TCP报文写入内存DDR和将TCP报文从内存DDR中读出，具体包括以下步骤：步骤3.1.系统上电复位或用户复位后，TCP会话归一化管理状态机启动，写控制器和读控制器复位；步骤3.2.TCP会话归一化管理状态机检测到TCP报文输入，根据报文解析结果判断报文是否进入TCP会话缓存队列节点，若否则报文穿通，若是则开启写控制器；步骤3.3.写控制器从双池双向链表中查询DMA逻辑内存地址，并映射为DMA物理内存地址，根据TCP会话归一化管理状态机中记录的DMA长度开启写DMA操作，将TCP报文缓存到内存DDR中；步骤3.4.TCP会话归一化管理状态机中输出中断指示多执行体报文已对齐，读控制器从双池双向链表中查询DMA逻辑内存地址，并映射为DMA物理内存地址，根据TCP会话归一化管理状态机中输出的DMA长度开启读DMA操作，将内存DDR中缓存的报文读出。进一步的，所述步骤四，具体为：读控制器读出的TCP报文进行TCP字段归一，字段归一后，报文重组，然后发送出去，完成归一化的整个流程；其中，发送的报文有两个通道，分别是输出到执行体和输出到网口。一种实现多执行体TCP会话归一化的装置，基于FPGA，包括：报文预处理单元，用于对输入报文进行报文类型解析，提取TCP会话信息，在缓冲器中缓存TCP报文，同时创建TCP消息链路，输出TCP会话信息和TCP报文；TCP会话管理及归一单元，包括TCP会话管理体和TCP报文控制器，其中的TCP会话管理体采用TCP会话归一化管理状态机，监控TCP消息链路的输出，根据输出的消息进行会话匹配、判断状态跳转、实时更新TCP会话缓存队列，发送读写指令给TCP报文控制器，输出报文。进一步的，所述TCP报文控制器包括写控制器和读控制器，所述写控制器接收TCP会话归一化管理状态机发出的写指令，将TCP报文写入内存DDR；所述读控制器接收TCP会话归一化管理状态机发出的读指令将TCP报文从内存DDR中读出。与现有技术相比，本发明具有如下有益效果：1、本发明设计了硬件DMA机制，来完成归一化报文的快速存储和读取，完全硬件控制，免驱动，相比于软件基于DPDK的实现更加快速，操作效率和空间利用率高；2、在TCP会话归一化管理状态机中通过双向链表加双池机制，可以实现会话缓存的快速分配、快速回收以及随机会话老化后的缓存空间快速拆链、建链。附图说明图1是本发明的基于FPGA实现多执行体TCP会话归一化的硬件总体框图；图2是本发明的FPGA内部实现多执行体TCP会话归一化的逻辑框图；图3是本发明的FPGA内部双池双向链表的工作示意图；图4是本发明的FPGA中DMA操作时逻辑内存和物理内存的映射关系图；图5是本发明的TCP报文写入内存过程示意图；图6是本发明的从内存读出TCP报文过程示意图；图7是本发明提供的一种实现多执行体TCP会话归一化的装置的结构框图。具体实施方式为了使本发明的目的、技术方案和技术效果更加清楚明白，以下结合说明书附图，对本发明作进一步详细说明。如图1所示，是运用本发明提出的实现多执行体TCP会话归一化的方法的硬件结构，主体包括FPGA和本地CPU，具体的，在硬件结构上，FPGA通过网口和远端用户设备相连，FPGA通过PCIe接口和本地CPU相连，本地CPU上运行多执行体，FPGA将本地CPU多执行体产生的TCP会话做归一化处理后发送给远端设备，FPGA将远端设备发送的TCP会话做归一化判断后再发给本地CPU的多执行体。一种实现多执行体TCP会话归一化的装置，基于FPGA，如图2所示，其中实线箭头表示TCP报文数据连接，虚线箭头表示TCP会话信息链路，该装置包括：报文预处理单元，用于对输入报文进行报文类型解析，提取TCP会话信息，在缓冲器中缓存TCP报文，同时创建TCP消息链路，输出TCP会话信息和TCP报文；TCP会话管理及归一单元，包括TCP会话管理体和TCP报文控制器，其中的TCP会话管理体采用TCP会话归一化管理状态机FSM，监控TCP消息链路的输出，根据输出的消息进行会话匹配、判断状态跳转、实时更新TCP会话缓存队列，发送读写指令给TCP报文控制器，输出报文到执行体和面板网口。其中，所述TCP报文控制器包括写控制器WDMA和读控制器RDMA，所述写控制器WDMA接收TCP会话归一化管理状态机FSM发出的写指令，将TCP报文写入内存DDR；所述读控制器RDMA接收TCP会话归一化管理状态机FSM发出的读指令将TCP报文从内存DDR中读出。本发明设计了硬件DMA机制，完成归一化报文的快速存储和读取，完全硬件控制，免驱动，相比于软件基于DPDK的实现更加快速，操作效率和空间利用率高。所述实现多执行体TCP会话归一化的方法，如图2所示，包括以下步骤：步骤一，对输入FPGA的报文进行预处理，输出TCP会话信息和TCP报文，具体的：首先对进入FPGA的报文进行预处理，对执行体输入报文和面板网口输入报文进行报文类型解析，提取TCP会话信息，在缓冲器buffer中缓存TCP报文，同时创建TCP消息链路，该链路传递报文解析得到的所有信息，包括TCP会话信息和TCP报文。步骤二，通过TCP会话归一化管理状态机FSM建立和保持TCP会话，将TCP会话信息保存到TCP会话缓存队列，具体的：TCP会话归一化管理状态机FSM监控TCP消息链路的输出，根据输出的消息进行会话匹配、判断状态跳转、实时更新会话缓存队列和输出报文，通采用双池双向链表，即双向链表加双池机制，来实现硬件快速化TCP会话管理。其中，所述TCP会话归一化管理状态机FSM负责TCP会话归一化功能的整个生命周期，即从报文输入系统开始到系统输出报文结束，完成会话匹配、规则过滤、新建会话、会话比较、会话选择、会话信息更新、报文DMA访问、会话删除、报文丢弃、报文穿通等所有功能的控制。如图3所示，所述双池双向链表即双向链表加双池机制，具体为：a.设置双池链表来管理TCP会话缓存节点，双池分别为已使用列表和空闲列表，其中，已使用列表维护已使用的TCP会话缓存节点，空闲列表维护已预留但未使用的TCP会话缓存节点；初始时刻，已使用列表为空状态，空闲列表为满状态，链表中节点的插入、删除操作则通过TCP会话缓存队列来完成；双池的操作为互补关系，当已使用列表中增加节点时，空闲列表会相应地减少节点；b.双池链表中各条表项的链接关系通过双向链表指针来完成。每个指针包含前节点地址索引和后节点地址索引两部分；在TCP会话归一化过程中，节点的插入、删除会触发链表节点指针和头指针phead和尾指针pend的更新。步骤三，使用写控制器WDMA和读控制器RDMA，将TCP报文写入内存DDR和从内存DDR中读出TCP报文，具体的：TCP报文通过内存DDR进行缓存，写操作由FPGA中的写控制器WDMA负责，读操作则是FPGA中的读控制器RDMA负责。读写指令仍是由TCP会话归一化管理状态机FSM控制，当TCP会话归一化管理状态机FSM判断进入报文符合过滤规则时，TCP会话归一化管理状态机FSM发出写指令给写控制器WDMA，将TCP报文写入内存DDR；当TCP会话归一化管理状态机FSM判断会话归一后会发出读指令给读控制器RDMA，将TCP报文从内存DDR中读出。更加具体的，如图4、图5、图6所示，所述将TCP报文写入内存DDR和将TCP报文从内存DDR中读出，通过以下子步骤来实现：步骤3.1.系统上电复位或用户复位后，TCP会话归一化管理状态机FSM启动，写控制器WDMA和读控制器RDMA复位。步骤3.2.TCP会话归一化管理状态机FSM检测到TCP报文输入，根据报文解析结果判断报文是否进入TCP会话缓存队列节点，若否则报文穿通，若是则开启写控制器WDMA。步骤3.3.写控制器WDMA从双池双向链表中查询DMA逻辑内存地址，并映射为DMA物理内存地址，根据TCP会话归一化管理状态机FSM中记录的DMA长度开启写DMA操作，将TCP报文缓存到内存DDR中。步骤3.4.TCP会话归一化管理状态机FSM中输出中断指示多执行体报文已对齐，读控制器RDMA从双池双向链表中查询DMA逻辑内存地址，并映射为DMA物理内存地址，根据TCP会话归一化管理状态机FSM中输出的DMA长度开启读DMA操作，将内存DDR中缓存的报文读出。步骤四，对读出的TCP报文进行TCP字段归一，再重组报文后发出，具体的：TCP会话归一化管理状态机FSM判断会话归一后，读控制器RDMA读出的TCP报文会进行TCP字段归一，这里的字段指的是TCP源端口、报文序列号、时间戳、滑窗、MSS等；字段归一后，报文重组，然后发送出去，完成归一化的整个流程。发送的报文有两个通道，分别是输出到执行体和输出到网口，具体需要根据该会话报文携带的随路信息来判断走哪个通道。与前述实现多执行体TCP会话归一化的方法的实施例相对应，本发明还提供了实现多执行体TCP会话归一化的装置的实施例。参见图7，本发明实施例提供的一种实现多执行体TCP会话归一化的装置，包括一个或多个FPGA，用于实现上述实施例中的实现多执行体TCP会话归一化的方法。本发明实现多执行体TCP会话归一化的装置的实施例可以应用在FPGA上，该FPGA可以为诸如计算机等设备或装置。装置实施例可以通过软件实现，也可以通过硬件或者软硬件结合的方式实现。以软件实现为例，作为一个逻辑意义上的装置，是通过其所在FPGA将非易失性存储器中对应的计算机程序指令读取到内存中运行形成的。从硬件层面而言，如图7所示，为本发明实现多执行体TCP会话归一化的装置所在FPGA的一种硬件结构图，除了图7所示的FPGA、内存、网络接口、以及非易失性存储器之外，实施例中装置所在的FPGA通常根据该FPGA的实际功能，还可以包括其他硬件，对此不再赘述。上述装置中各个单元的功能和作用的实现过程具体详见上述方法中对应步骤的实现过程，在此不再赘述。对于装置实施例而言，由于其基本对应于方法实施例，所以相关之处参见方法实施例的部分说明即可。以上所描述的装置实施例仅仅是示意性的，其中所述作为分离部件说明的单元可以是或者也可以不是物理上分开的，作为单元显示的部件可以是或者也可以不是物理单元，即可以位于一个地方，或者也可以分布到多个网络单元上。可以根据实际的需要选择其中的部分或者全部模块来实现本发明方案的目的。本领域普通技术人员在不付出创造性劳动的情况下，即可以理解并实施。本发明实施例还提供一种计算机可读存储介质，其上存储有程序，该程序被FPGA执行时，实现上述实施例中的实现多执行体TCP会话归一化的方法。所述计算机可读存储介质可以是前述任一实施例所述的FPGA的搭载设备的内部存储单元，例如硬盘或内存。所述计算机可读存储介质也可以是FPGA的搭载设备的外部存储设备，例如所述设备上配备的插接式硬盘、智能存储卡、SD卡、闪存卡等。进一步的，所述计算机可读存储介质还可以既包括FPGA的搭载设备的内部存储单元也包括外部存储设备。所述计算机可读存储介质用于存储所述计算机程序以及所述FPGA所需的其他程序和数据，还可以用于暂时地存储已经输出或者将要输出的数据。以上所述，仅为本发明的优选实施案例，并非对本发明做任何形式上的限制。虽然前文对本发明的实施过程进行了详细说明，对于熟悉本领域的人员来说，其依然可以对前述各实例记载的技术方案进行修改，或者对其中部分技术特征进行同等替换。凡在本发明精神和原则之内所做修改、同等替换等，均应包含在本发明的保护范围之内。
