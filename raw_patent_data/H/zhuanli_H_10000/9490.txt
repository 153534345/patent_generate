标题title
微分段策略路由学习方法、报文转发方法及装置
摘要abst
本发明提供了一种微分段策略路由学习方法、报文转发方法及装置，用于解决微分段策略路由场景下路由表项过多的技术问题。本发明在微分段策略路由场景下，在将目的VPN新学习到的路由引入源VPN路由表时，优先引入网段路由，在引入主机路由时，判断主机路由是否和已有的网段路由EPG分组相同，不相同才引入，从而避免不必要的主机路由的引入，降低了源VPN路由表的路由表项的数量。
权利要求书clms
1.一种微分段策略路由学习方法，其特征在于，该方法包括：当目的虚拟私有网络VPN路由表中同时存在网段路由和主机路由且具有不同EPG时，基于端点分组EPG进行分组；对于具有相同EPG的路由表项，优先引入目的地址的掩码较短的网段路由表项到源VPN路由表中；对于目的地址的掩码较长的路由表项，只引入具有不同EPG的路由表项到源VPN路由表中；其中，所述源VPN路由表中的路由表项的下一跳字段为目的VPN，出接口字段为目的VPN对应的还回口子接口，EPG字段值为所引入的路由表项EPG字段值。2.根据权利要求1所述的方法，其特征在于，所述对于具有相同EPG的路由表项，优先引入目的地址的掩码较短的网段路由表项到源VPN路由表中具体为：将目的VPN路由表新学习到的路由表项作为当前路由表项；判断当前路由表项的目的地址的子网掩码是否为相同EPG里子网掩码长度最小的路由表项；当判定为最小时，将所述当前路由表项引入源VPN路由表中，或使用所述当前路由表项替换掉源VPN路由表中目的地址匹配但掩码较长的路由表项；当判定为非最小时，不引入所述当前路由表项。3.根据权利要求1所述的方法，其特征在于，所述对于目的地址的掩码较长的路由表项，只引入具有不同EPG的路由表项到源VPN路由表中具体为；将目的VPN路由表新学习到的路由表项作为当前路由表项；若源VPN路由表中存在与所述当前路由表项的目的地址匹配的路由表项，则只在所述当前路由表项的目的地址掩码较长且EPG不同的情况下引入所述当前路由表项。4.一种报文转发方法，其特征在于，该方法应用于边界网关设备，所述边界网关设备的外网接口配置有微分段策略表项，并拥有根据权利要求1所述的方法学习的源虚拟私有网络VPN路由表，该方法包括：当从所述外网接口接收到发往目的VPN的报文时，使用报文的源地址在源VPN路由表中的目的地址字段进行匹配，匹配到默认路由后，从默认路由的EPG字段获得报文源端点分组EPG；使用报文目的地址在源VPN路由表的目的地址字段进行最长匹配，从匹配的路由表项中获得报文目的EPG；使用得到的报文源EPG和目的EPG，在微分段策略配置表中匹配对应的策略表项，根据匹配的微分段策略配置表项中的动作字段对报文进行相应的处理。5.如权利要求4所述的方法，其特征在于，当所述微分段策略配置表中匹配的表项的动作字段为允许按路由转发时，所述相应处理为：根据报文目的地址在源VPN路由表中匹配的路由表项的下一跳的目的VPN，从该目的VPN对应的环回口子接口转发出去；所述报文经环回口再次进入所述边界网关设备，继续在所述目的VPN的路由表中匹配，根据匹配到的目的VPN路由表项进行转发。6.一种微分段策略路由学习装置，其特征在于，该装置包括：分组模块，用于对目的虚拟私有网络VPN路由表中的网段路由和主机路由基于EPG进行分组；第一引入模块，用于对于具有相同端点分组EPG的路由表项，优先引入目的地址的掩码较短的网段路由表项到源VPN路由表中；第二引入模块，用于对于目的地址的掩码较长的路由表项，只引入具有不同EPG的路由表项到源VPN路由表中；其中，所述源VPN路由表中的路由表项的下一跳字段为目的VPN，出接口字段为目的VPN对应的还回口子接口，EPG字段值为所引入的路由表项EPG字段值。7.根据权利要求6所述的装置，其特征在于，所述第一引入模块包括：第一判断单元，用于将目的VPN路由表新学习到的路由表项作为当前路由表项；判断当前路由表项的目的地址的子网掩码是否为相同EPG里子网掩码长度最小的路由表项；第一处理单元，用于在判定为最小时，将所述当前路由表项引入源VPN路由表中，或使用所述当前路由表项替换掉源VPN路由表中目的地址匹配但掩码较长的路由表项；当判定为非最小时，不引入所述当前路由表项。8.根据权利要求6所述的装置，其特征在于，所述第二引入模块包括：第二判断单元，用于将目的VPN路由表新学习到的路由表项作为当前路由表项；判断源VPN路由表中是否存在与所述当前路由表项的目的地址匹配的路由表项；第三判断单元，用于判断所述当前路由表项的目的地址掩码是否较长；第四判断单元，用于判断所述当前路由表项的EPG是否与源VPN中匹配的路由表项的EPG相同；第二处理单元，用于在判定源VPN路由表中存在与所述当前路由表项的目的地址匹配的路由表项、所述当前路由表项的目的地址掩码较长且EPG不同时，引入所述当前路由表项到所述源VPN路由表中。9.一种报文转发装置，其特征在于，该装置应用于边界网关设备，所述边界网关设备的外网接口配置有微分段策略表项，并拥有根据权利要求1所述的方法学习的源虚拟私有网络VPN路由表，该装置包括：源EPG获取模块，用于在从所述外网接口接收到发往目的VPN的报文时，使用报文的源地址在源VPN路由表中的目的地址字段进行匹配，匹配到默认路由后，从默认路由的EPG字段获得报文源EPG；目的EPG获取模块，用于使用报文目的地址在源VPN路由表的目的地址字段进行最长匹配，从匹配的路由表项中获得报文目的EPG；策略处理模块，用于使用得到的报文源EPG和目的EPG，在微分段策略配置表中匹配对应的策略表项，根据匹配的微分段策略配置表项中的动作字段对报文进行相应的处理。10.如权利要求9所述的装置，其特征在于，当所述微分段策略配置表中匹配的表项的动作字段为允许按路由转发时，所述策略处理模块的相应处理为：根据报文目的地址在源VPN路由表中匹配的路由表项的下一跳的目的VPN，从该目的VPN对应的环回口子接口转发出去；所述报文经环回口再次进入所述边界网关设备，继续在所述目的VPN的路由表中匹配，根据匹配到的目的VPN路由表项进行转发。11.一种电子设备，其特征在于，包括处理器、通信接口、存储介质和通信总线，其中，处理器、通信接口、存储介质通过通信总线完成相互间的通信；存储介质，用于存放计算机程序；处理器，用于执行存储介质上所存放的计算机程序时，实施权利要求1-5任一项所述的方法步骤。12.一种存储介质，其上存储有计算机程序，其特征在于，所述计算机程序当被处理器执行时实施如权利要求1至5中任一项所述的方法步骤。
说明书desc
技术领域本发明涉及通信技术领域，尤其涉及一种微分段策略路由学习方法、报文转发方法及装置。背景技术在以叶脊Leaf-Spine网络架构组网的分布式以太网虚拟私有网络中，每台叶子leaf设备都作为下挂主机的网关，对本地站点的流量进行三层转发，缓解了网关的压力。随着客户精细化访问控制的需求，同一网段的不同主机可能有不同的访问策略。如图1采用微分段策略的组网示例，例如VPN1内的IP地址为1.0.0.1的主机访问外网需要过防火墙FW1和WAF；地址为1.0.0.3的主机访问外网不需要过防火墙，直接放通；网段地址1.0.0.0/24内的其他主机访问外网，只需要过防火墙FW1等。VPN2内地址为2.0.0.1的主机访问外网，需要过防火墙FW2，网段地址2.0.0.0/24内的其他主机访问外网不需要过防火墙。VPN3内的所有主机都不需要过防火墙等。针对这种场景，目前业界可以采用微分段Micro-segment的方式来给主机进行端点分组。例如:VPN1内，网段1.0.0.0/24内的主机默认分组为EPG2，有特殊访问策略的1.0.0.1/32使用EPG1。VPN2内2.0.0.0/24的默认分组是EPG4，有特殊访问策略的2.0.0.1/32使用EPG3。VPN3内所有主机的策略一致，使用EPG5。微分段策略配置表的示例配置如表1所示，其中EPG6为位于外部虚拟私有网络中的EPG。表1微分段策略配置表源EPG目的EPG动作EPG6EPG1走服务链，重定向到FW1和WAFEPG1EPG6走服务链，重定向到FW1和WAFEPG6EPG2走服务链，重定向到FW1EPG2EPG6走服务链，重定向到FW1EPG6EPG3走服务链，重定向到FW2EPG3EPG6走服务链，重定向到FW2EPG4EPG6允许通过，按路由转发EPG6EPG4允许通过，按路由转发EPG5EPG6允许通过，按路由转发EPG6EPG5允许通过，按路由转发EPG7EPG6允许通过，按路由转发EPG6EPG7允许通过，按路由转发目前，业界有使用路由表中增加一个分组标记的方式来标识EPG组标识ID，采用此方案时，在分布式网关场景下，如leaf1，leaf2和leaf3均作为1.0.0.0/24，2.0.0.0/24和3.0.0.0/24网段或主机的分布式网关，外网通过边界网关border1访问内部主机，为了能够准确不绕行到达主机所在的叶子网关leaf，需要border上保存所有leaf下主机的主机路由，这样导致border上的路由表规模较大。如表2-表4的示例。表2初始border1上VPN1的路由表VPN目的地址下一跳出接口EPG IDVPN11.0.0.1/32Leaf1到leaf1的隧道EPG1VPN11.0.0.2/32Leaf2到leaf2的隧道EPG7VPN11.0.0.3/32Leaf3到leaf3的隧道EPG2VPN11.0.0.0/24Leaf1到leaf1的隧道EPG2VPN11.0.0.0/24Leaf2到leaf2的隧道EPG2VPN11.0.0.0/24Leaf3到leaf3的隧道EPG2表3初始border 1上VPN2的路由表表4初始border 1上VPN3的路由表VPN目的地址下一跳出接口EPG IDVPN33.0.0.1/32Leaf1到leaf1的隧道EPG5VPN33.0.0.2/32Leaf2到leaf2的隧道EPG5VPN33.0.0.3/32Leaf3到leaf3的隧道EPG5VPN33.0.0.0/24Leaf1到leaf1的隧道EPG5VPN33.0.0.0/24Leaf2到leaf2的隧道EPG5VPN33.0.0.0/24Leaf3到leaf3的隧道EPG5当外部VPN需要与VPN1，VPN2及VPN3的主机互访时，border1上external VPN的路由表如表5示例。表5更新后border 1上external VPN的路由表这种方式对转发设备的路由表项消耗过大，需要互访的路由需要同时存在于两个VPN里，当互访的VPN比较多时，很容易造成路由表容量不足。发明内容有鉴于此，本发明提供一种微分段策略路由学习方法、报文转发方法及装置，用于解决微分段策略路由场景下路由表项过多的技术问题。基于本发明实施例的一方面，本发明提供了一种微分段策略路由学习方法，该方法包括：当目的VPN路由表中同时存在网段路由和主机路由且具有不同EPG时，基于EPG进行分组；对于具有相同EPG的路由表项，优先引入目的地址的掩码较短的网段路由表项到源VPN路由表中；对于目的地址的掩码较长的路由表项，只引入具有不同EPG的路由表项到源VPN路由表中；其中，所述源VPN路由表中的路由表项的下一跳字段为目的VPN，出接口字段为目的VPN对应的还回口子接口，EPG字段值为所引入的路由表项EPG字段值。进一步地，所述对于具有相同EPG的路由表项，优先引入目的地址的掩码较短的网段路由表项到源VPN路由表中具体为：将目的VPN路由表新学习到的路由表项作为当前路由表项；判断当前路由表项的目的地址的子网掩码是否为相同EPG里子网掩码长度最小的路由表项；当判定为最小时，将所述当前路由表项引入源VPN路由表中，或使用所述当前路由表项替换掉源VPN路由表中目的地址匹配但掩码较长的路由表项；当判定为非最小时，不引入所述当前路由表项。进一步地，所述对于目的地址的掩码较长的路由表项，只引入具有不同EPG的路由表项到源VPN路由表中具体为；将目的VPN路由表新学习到的路由表项作为当前路由表项；若源VPN路由表中存在与所述当前路由表项的目的地址匹配的路由表项，则只在所述当前路由表项的目的地址掩码较长且EPG不同的情况下引入所述当前路由表项。根据本发明实施例的另一方面，本发明还提供了一种报文转发方法，该方法应用于边界网关设备，所述边界网关设备的外网接口配置有微分段策略表项，并拥有根据前述微分段路由学习方法学习的源VPN路由表，该方法包括：当从所述外网接口接收到发往目的VPN的报文时，使用报文的源地址在源VPN路由表中的目的地址字段进行匹配，匹配到默认路由后，从默认路由的EPG字段获得报文源EPG；使用报文目的地址在源VPN路由表的目的地址字段进行最长匹配，从匹配的路由表项中获得报文目的EPG；使用得到的报文源EPG和目的EPG，在微分段策略配置表中匹配对应的策略表项，根据匹配的微分段策略配置表项中的动作字段对报文进行相应的处理。进一步地，当所述微分段策略配置表中匹配的表项的动作字段为允许按路由转发时，所述相应处理为：根据报文目的地址在源VPN路由表中匹配的路由表项的下一跳的目的VPN，从该目的VPN对应的环回口子接口转发出去；所述报文经环回口再次进入所述边界网关设备，继续在所述目的VPN的路由表中匹配，根据匹配到的目的VPN路由表项进行转发。根据本发明实施例的另一方面，本发明还提供一种微分段策略路由学习装置，该装置包括：分组模块，用于对目的VPN路由表中的网段路由和主机路由基于EPG进行分组；第一引入模块，用于对于具有相同EPG的路由表项，优先引入目的地址的掩码较短的网段路由表项到源VPN路由表中；第二引入模块，用于对于目的地址的掩码较长的路由表项，只引入具有不同EPG的路由表项到源VPN路由表中；其中，所述源VPN路由表中的路由表项的下一跳字段为目的VPN，出接口字段为目的VPN对应的还回口子接口，EPG字段值为所引入的路由表项EPG字段值。进一步地，所述第一引入模块包括：第一判断单元，用于将目的VPN路由表新学习到的路由表项作为当前路由表项；判断当前路由表项的目的地址的子网掩码是否为相同EPG里子网掩码长度最小的路由表项；第一处理单元，用于在判定为最小时，将所述当前路由表项引入源VPN路由表中，或使用所述当前路由表项替换掉源VPN路由表中目的地址匹配但掩码较长的路由表项；当判定为非最小时，不引入所述当前路由表项。进一步地，所述第二引入模块包括：第二判断单元，用于将目的VPN路由表新学习到的路由表项作为当前路由表项；判断源VPN路由表中是否存在与所述当前路由表项的目的地址匹配的路由表项；第三判断单元，用于判断所述当前路由表项的目的地址掩码是否较长；第四判断单元，用于判断所述当前路由表项的EPG是否与源VPN中匹配的路由表项的EPG相同；第二处理单元，用于在判定源VPN路由表中存在与所述当前路由表项的目的地址匹配的路由表项、所述当前路由表项的目的地址掩码较长且EPG不同时，引入所述当前路由表项到所述源VPN路由表中。根据本发明实施例的另一方面，本发明还提供一种报文转发装置，该装置应用于边界网关设备，所述边界网关设备的外网接口配置有微分段策略表项，并拥有根据前述微分段策略路由学习方法学习的源VPN路由表，该装置包括：源EPG获取模块，用于在从所述外网接口接收到发往目的VPN的报文时，使用报文的源地址在源VPN路由表中的目的地址字段进行匹配，匹配到默认路由后，从默认路由的EPG字段获得报文源EPG；目的EPG获取模块，用于使用报文目的地址在源VPN路由表的目的地址字段进行最长匹配，从匹配的路由表项中获得报文目的EPG；策略处理模块，用于使用得到的报文源EPG和目的EPG，在微分段策略配置表中匹配对应的策略表项，根据匹配的微分段策略配置表项中的动作字段对报文进行相应的处理。进一步地，当所述微分段策略配置表中匹配的表项的动作字段为允许按路由转发时，所述策略处理模块的相应处理为：根据报文目的地址在源VPN路由表中匹配的路由表项的下一跳的目的VPN，从该目的VPN对应的环回口子接口转发出去；所述报文经环回口再次进入所述边界网关设备，继续在所述目的VPN的路由表中匹配，根据匹配到的目的VPN路由表项进行转发。根据本发明实施例的另一方面，本发明还提供一种电子设备，该电子设备包括处理器、通信接口、存储介质和通信总线，其中，处理器、通信接口、存储介质通过通信总线完成相互间的通信；存储介质，用于存放计算机程序；处理器，用于执行存储介质上所存放的计算机程序时，实施前述微分段策略路由学习方法或报文转发方法的步骤。根据本发明实施例的另一方面，本发明还提供一种存储介质，其上存储有计算机程序，所述计算机程序当被处理器执行时实施如前述微分段策略路由学习方法或报文转发方法的方法步骤。本发明在微分段策略路由场景下，在将目的VPN新学习到的路由引入源VPN路由表时，优先引入网段路由，在引入主机路由时，判断主机路由是否和已有的网段路由EPG分组相同，不相同才引入，从而避免不必要的主机路由的引入，降低了源VPN路由表的路由表项的数量。附图说明为了更加清楚地说明本发明实施例或者现有技术中的技术方案，下面将对本发明实施例或者现有技术描述中所需要使用的附图作简单地介绍，显而易见地，下面描述中的附图仅仅是本发明中记载的一些实施例，对于本领域普通技术人员来讲，还可以根据本发明实施例的这些附图获得其他的附图。图1为本发明一实施例中采用的微分段策略组网示意图；图2为本发明一实施例提供的微分段策略路由学习方法的步骤流程图；图3为本发明一实施例提供的基于源VPN路由表进行微分段策略路由转发的步骤流程示意图；图4为本发明一实施例提供的一种微分段路由学习装置结构示意图；图5为本发明一实施例提供的一种基于微分段路由的报文转发装置的结构示意图；图6为本发明一实施例提供的一种电子设备结构示意图。具体实施方式在本发明实施例使用的术语仅仅是出于描述特定实施例的目的，而非限制本发明实施例。本发明实施例中所使用的单数形式的“一种”、“所述”和“该”也旨在包括多数形式，除非上下文清楚地表示其它含义。本发明中使用的术语“和/或”是指包含一个或多个相关联的列出项目的任何或所有可能组合。应当理解，尽管在本发明实施例可能采用术语第一、第二、第三等来描述各种信息，但这些信息不应限于这些术语。这些术语仅用来将同一类型的信息彼此区分开。例如，在不脱离本发明实施例范围的情况下，第一信息也可以被称为第二信息，类似地，第二信息也可以被称为第一信息。取决于语境，此外，所使用的词语“如果”可以被解释成为“在……时”或“当……时”或“响应于确定”。本发明主要目的是解决主机微分段策略路由场景下，为实现源目的VPN内的主机跨VPN互访，引入过多路由表项导致路由表过于庞大、对计算资源要求高、路由效率低的技术问题。本发明技术方案的基本思想是：在微分段策略路由场景下，在将目的VPN新学习到的路由引入源VPN路由表时，优先引入网段路由，在引入主机路由时，判断主机路由是否和已有的网段路由EPG分组相同，不相同才引入，从而避免不必要的主机路由的引入，降低了源VPN路由表的路由表项的数量。本发明所述的微分段策略路由是指基于微分段策略配置表进行的基于策略的路由方式，例如对于同一目的VPN中不同主机配置不同的路由策略，根据不同的路由策略对同一目的VPN中不同主机的流量进行不同的处理，以实现VPN内流量的更精细化地控制。本发明实施例中，将位于两个网络边缘承担网关和路由功能的设备称为边界网关设备，边界网关设备可通过路由协议从内部网络学习内部网络的主机或网段路由，例如Border1会从脊网关设备Spine和叶网关设备leaf学习内部网络中的VPN内的主机路由和网段路由。Border1设备可通过边界网关协议协议学习到VPN1、VPN2和VPN3的内部主机路由和网段路由，可在BGP路由通告报文的团体属性内携带路由对应的端点分组EPG标识。以下结合图1，以外网VPN内的主机通过边界网关设备上的外网互连接口访问内网目的VPN中的主机为例，详细描述在边界网关设备上如何将目的VPN的路由引入到源VPN的路由表中，以及如何实现基于微分段策略的路由。假设源VPN即external VPN需要跨VPN访问目的VPN即VPN1内的主机，那么Border1设备需要学习目的VPN内的主机路由和网段路由，才能实现源VPN内主机到目的VPN内主机报文的正常转发，路由学习的过程主要分为两个阶段，第一阶段是通过路由协议学习目的VPN中的主机和网段路由到目的VPN路由表中，第二阶段是从目的VPN路由表将路由引入到源VPN路由。图2为本发明一实施例提供的微分段策略路由学习方法的步骤流程图，该流程图示例了路由学习的第二阶段中边界设备border1从目的VPN1的路由表引入路由到源VPN的路由表的过程。步骤201.当目的VPN的路由表学习到一条新的路由表项时，将该新的路由表项作为当前路由表项，并以EPG为关键字对目的VPN的路由表项进行排序；在本发明实施例中，源VPN路由表和目的VPN路由表中都包括EPG字段，用于标识路由表项所属的EPG分组。步骤202.判断当前路由表项的目的地址的子网掩码是否为是相同EPG里子网掩码长度最小的路由表项，如果是则执行步骤203，否则流程结束，不引入当前路由表项；本发明实施例对于目的VPN的路由中具有相同EPG的路由表项，选取掩码长度最小的路由表项即route1_shortest_mask引入到源VPN即external VPN的路由中，这么做的目的是优先引入网段路由，因为网段路由的掩码小于主机路由的掩码。假设，在初始情况下，external_VPN的路由表为空，Border1通过路由学习，学习到如表6中目的VPN1的路由表项，由于只有一条表项，所以按照EPG为关键字key对目的VPN的路由进行排序的话仍如表6所示。表6目的VPN1的路由表EPG IDVPN目的地址下一跳出接口EPG2VPN11.0.0.3/32Leaf3到leaf3的隧道虽然，表6中的路由表项不是网段路由，但针对主机定制的特定微分段策略的主机路由也应当引入，因此根据图2的流程，该表项将会被引入到源VPN的路由表中，如表7所示。表7源VPN的路由表VPN目的地址下一跳出接口EPG IDExteral_VPN1.0.0.3/32VPN1Loopback.vpn1EPG2在表6的基础上，当Border1通过路由学习，学习到EPG相同的同一网段的网段路由表项时，按照EPG为关键字对目的VPN1的路由进行排序后，如表8所示：表8目的VPN1的路由表EPG IDVPN目的地址下一跳出接口EPG2VPN11.0.0.3/32Leaf3到leaf3的隧道EPG2VPN11.0.0.0/24Leaf1到leaf1的隧道学习到1.0.0.0/24的网段路由表项触发图2的路由引入流程，引入流程中的当前路由表项即为表8中目的地址为1.0.0.0/24的路由表项，在步骤202中，由于当前路由表项中目的地址的掩码为24位，小于同一VPN内目的地址为1.0.0.3/32对应的路由表项，因此将会执行步骤203。如果先学到了1.0.0.0/24的路由表项，后学到了1.0.0.3/32的表项，则在步骤202中，由于1.0.0.3/32的掩码长度大于1.0.0.0/24，所以1.0.0.3/32的路由表项将不会被引入到源VPN的路由中。假设，在表8的基础上，Border1通过路由学习，又学习到目的VPN1中相同EPG2，目的地址仍然为1.0.0.0/24但下一跳不同的新的路由表项，按照EPG为关键字对目的VPN1的路由进行排序后，得到如表9所示：表9目的VPN1的路由表EPG IDVPN目的地址下一跳出接口EPG2VPN11.0.0.3/32Leaf3到leaf3的隧道EPG2VPN11.0.0.0/24Leaf1到leaf1的隧道EPG2VPN11.0.0.0/24Leaf2到leaf2的隧道表9中，具有相同EPG，目的VPN为VPN1的路由表项虽然有3个，但3个路由表项中不重复的目的地址只有2个，分别为1.0.0.3/32，1.0.0.0/24，24位的掩码小于32位的掩码长度，因此，针对新学习到的目的地址为1.0.0.0/24、下一跳为leaf2的路由表项，其掩码仍为最小值，仍然会走步骤203的分支进行处理。针对某个EPG仅有一条路由表项的情况，例如表2中，以EPG1为端点分组的路由表项只有1个，即EPG1、目的地址为1.0.0.1/32的路由表项，其掩码虽然是32位的，但由于EPG1分组中只有一条路由，因此默认该路由表项的目的地址的掩码长度为EPG1分组中掩码长度最小的路由表项。步骤203.用当前路由表项的目的地址在源VPN的路由中做最长地址匹配；所述最长地址匹配指按照地址前缀的掩码，在掩码长度范围内做逐位的匹配判断。步骤204.判断是否存在匹配的路由表项，如果判定为是则执行步骤205，否则执行步骤208；该步骤用于判断在源VPN路由表中是否存在与当前路由表项的目的地址匹配的路由表项，如果不存在匹配的路由表项，说明在源VPN的路由表中还不存在同网段或同主机的相关路由表项。以表7和表8为例，在新学到目的VPN1的目的地址为1.0.0.0/24的路由表项时，由于该地址掩码小于32，因此在该步骤中以1.0.0.0/24做最长地址匹配，会匹配到表7源VPN的路由表中的目的地址为1.0.0.3/32的表项。步骤205.判断当前路由表项的目的地址的掩码长度是否小于所匹配的源VPN路由中的路由表项的目的地址的掩码长度，如果判定为是执行步骤206，否则执行步骤207；在源VPN的路由中存在与当前路由表项的目的地址匹配的路由表项的情况下，需要进一步判断是否当前路由表项的目的地址的掩码长度小于源VPN路由中匹配的路由表项的目的地址的掩码长度，如果小于则需要替换源VPN中匹配的路由表项即实现优先引入网段路由的目的，如果不小于则需要根据EPG的异同做进一步地处理，通过替换处理可以保证优先引入短掩码的网段路由。步骤206.使用当前路由表项的目的地址替换源VPN内匹配的路由表项的目的地址，并将匹配的路由表项的下一跳改为当前路由表项的目的VPN，出接口改为与目的VPN对应的环回口的子接口；仍以表7和表8为例，当前路由表项的目的地址1.0.0.0/24匹配到源VPN中的1.0.0.3/32的表项，由于24位掩码小于32位，因此需要使用当前路由表项的目的地址替换源VPN中匹配的表项的目的地址即用1.0.0.0/24替换1.0.0.3/32，并替换下一跳和出接口为当前路由表项所属VPN和所属VPN对应的环回口子接口，如表10所示：表10源VPN路由表VPN目的地址下一跳出接口EPG IDExteral_VPN1.0.0.0/24VPN1Loopback.vpn1EPG2步骤207.判断当前路由表项的EPG与源VPN中所匹配的路由表项的EPG是否相同，若不相同则执行步骤208，若相同则流程结束。在当前路由表项的目的地址的掩码长度不小于所匹配的源VPN路由中的路由表项的目的地址的掩码长度且当前路由表项的EPG与源VPN中所匹配的路由表项的EPG相同的情况下，结束流程，即不将当前路由表项引入到源VPN路由表中。以表9为例，针对新学习到的目的地址为1.0.0.0/24、下一跳为leaf2的路由表项，由于目的地址、目的VPN和EPG都相同，因此在步骤207中不会引入1.0.0.0/24下一跳为leaf2的路由表项到源VPN路由中。步骤208.在源VPN内引入当前路由表项并将该引入的路由表项的下一跳及出接口修改为当前路由表项的目的VPN及目的VPN对应的环回口的子接口；在源VPN的路由中还不存在与当前路由表项目的地址匹配的路由表项的情况下，需要将当前路由表项引入到源VPN的路由中。在源VPN的路由中存在与当前路由表项目的地址匹配的路由表项且当前路由表项的目的地址的掩码长度不小于所匹配的源VPN路由中的路由表项的目的地址的掩码长度且当前路由表项的EPG与源VPN中所匹配的路由表项的EPG不相同的情况下，需要将当前路由表项引入到源VPN的路由中。例如先学习到了EPG2目的地址为1.0.0.0/24的路由，后又学到了EPG8目的地址为1.0.0.5/32的路由，后者为更细分的微分段主机路由，因此需要将后者引入到源VPN的路由表中。上述将当前路由表项引入到源VPN的路由中需要执行步骤包括：在源VPN路由中新增一条源VPN为external VPN、目的地址为当前路由表项的目的地址、下一跳为当前路由表项所属目的VPN、出接口为环回口的子接口、EPG为当前路由表项所属EPG的路由表项。其中，出接口的环回口子接口标识ID可以使用目的VPN的标识ID或其映射值，即出接口为与当前路由表项所属目的VPN对应的环回口子接口。基于图2的路由学习流程，假设得到如表11的源VPN路由表：表11源VPN路由表需要特别说明的是，本发明实施例需要在源VPN路由表中预先配置一条目的地址为0.0.0.0/0的默认路由表项，掩码长度为0，该路由表项用于获取报文入端口所属的EPG。图3为本发明一实施例提供的基于源VPN路由表进行微分段策略路由转发的步骤流程示意图，步骤包括：步骤301.当从border1的外网接口接收到发往目的VPN的报文时，使用报文的源地址在源VPN路由表中的目的地址字段进行匹配，匹配到默认路由后，从默认路由的EPG字段获得报文源EPG；该实施例中，会在border1的接口下发如表1的微分段策略表项，当border1从外网接口如因特网互连接口接收到打上源VPN标记的发往目的VPN1，目的地址为1.0.0.1/32的报文时，首先使用报文的源IP地址到如表11的源VPN路由表中的目的地址字段进行最长地址匹配，由于是外网IP，因此会命中掩码长度为0的目的地址为0.0.0.0/0的默认路由表项，从而获得该端口上默认路由对应的EPG分组即报文源EPG分组为EPG6。步骤302.使用报文目的地址在源VPN路由表的目的地址字段进行最长匹配，从匹配的路由表项中获得报文目的EPG；在命中默认路由，从默认路由表项获得报文源地址所属的EPG分组后，再使用报文目的IP地址在源VPN路由表中进行匹配得到报文目的EPG分组，以表11为例，报文目的IP为1.0.0.1/32，得到目的EPG分组为EPG1，下一跳为VPN1，出接口为本地环回口的子接口Loopback.vpn1。步骤303.使用得到的报文源EPG和目的EPG，在微分段策略配置表中匹配对应的策略表项，根据匹配的微分段策略配置表项中的动作字段对报文进行相应的处理。以表1的微分段策略配置表和表11为例，假设报文源IP地址对应的EPG6，目的IP地址1.0.0.1/32对应的EPG分组为EPG1，对应的处理动作为“走服务链，重定向到FW1和WAF”，此种情况下，报文将不再根据路由表项的下一跳进行转发，而是将报文重定向转发到FW1和WAF。若报文目的地址为1.0.0.3/32，则对应的EPG分组为EPG7，查找表1的微分段策略配置，对应的处理动作为“允许通过，按路由转发”。此时根据报文目的IP地址1.0.0.0.3/32在源VPN路由表中匹配的路由表项的下一跳为VPN1，出接口为Loopback.vpn1，则报文从border1的VPN1对应的环回口子接口转发出去后，再从环回口进入border1，然后会继续在VPN1的路由表中做路由查找，最终找到leaf3下的主机1.0.0.3/32对应的路由表项，根据找到的路由表项转发报文，从连接leaf3的隧道接口将报文转发出去。至此，border1完成了从接收到报文到基于微分段策略路由转发报文的过程。本发明实施所采用的动态路由引入的方式，相比于静态在源VPN路由中配置去往目的VPN的路由的方式来说，减少了网络配置和管理的工作量，提高了网络管理和维护的效率，避免了人为配置出错的情况的发生。图4为本发明一实施例提供的一种微分段路由学习装置结构示意图，该装置400中的各功能模块可以采用软件、硬件或软硬件相结合的方式实现。该装置400应用于边界网关，该装置400包括：分组模块401，用于对目的VPN路由表中的网段路由和主机路由基于EPG进行分组；第一引入模块402，用于对于具有相同EPG的路由表项，优先引入目的地址的掩码较短的网段路由表项到源VPN路由表中；第二引入模块403，用于对于目的地址的掩码较长的路由表项，只引入具有不同EPG的路由表项到源VPN路由表中；其中，所述源VPN路由表中的路由表项的下一跳字段为目的VPN，出接口字段为目的VPN对应的还回口子接口，EPG字段值为所引入的路由表项EPG字段值。其中，第一引入模块402进一步包括：第一判断单元，用于将目的VPN路由表新学习到的路由表项作为当前路由表项；判断当前路由表项的目的地址的子网掩码是否为相同EPG里子网掩码长度最小的路由表项；第一处理单元，用于在判定为最小时，将所述当前路由表项引入源VPN路由表中，或使用所述当前路由表项替换掉源VPN路由表中目的地址匹配但掩码较长的路由表项；当判定为非最小时，不引入所述当前路由表项。其中，第二引入模块进一步包括：第二判断单元，用于将目的VPN路由表新学习到的路由表项作为当前路由表项；判断源VPN路由表中是否存在与所述当前路由表项的目的地址匹配的路由表项；第三判断单元，用于判断所述当前路由表项的目的地址掩码是否较长；第四判断单元，用于判断所述当前路由表项的EPG是否与源VPN中匹配的路由表项的EPG相同；第二处理单元，用于在判定源VPN路由表中存在与所述当前路由表项的目的地址匹配的路由表项、所述当前路由表项的目的地址掩码较长且EPG不同时，引入所述当前路由表项到所述源VPN路由表中。图5为本发明一实施例提供的一种基于微分段路由的报文转发装置的结构示意图，该装置500中的各功能模块可以采用软件、硬件或软硬件相结合的方式实现。该装置500应用于边界网关设备，边界网关设备的外网接口配置有微分段策略表项，并拥有根据前述实施例的路由学习方法学习的源VPN路由表，该装置500包括：源EPG获取模块501，用于在从所述外网接口接收到发往目的VPN的报文时，使用报文的源地址在源VPN路由表中的目的地址字段进行匹配，匹配到默认路由后，从默认路由的EPG字段获得报文源EPG；目的EPG获取模块502，用于使用报文目的地址在源VPN路由表的目的地址字段进行最长匹配，从匹配的路由表项中获得报文目的EPG；策略处理模块503，用于使用得到的报文源EPG和目的EPG，在微分段策略配置表中匹配对应的策略表项，根据匹配的微分段策略配置表项中的动作字段对报文进行相应的处理。进一步地，当微分段策略配置表中匹配的表项的动作字段为允许按路由转发时，策略处理模块503所做的相应处理为：根据报文目的地址在源VPN路由表中匹配的路由表项的下一跳的目的VPN，从该目的VPN对应的环回口子接口转发出去；所述报文经环回口再次进入所述边界网关设备，继续在所述目的VPN的路由表中匹配，根据匹配到的目的VPN路由表项进行转发。图6为本发明一实施例提供的一种电子设备结构示意图，该设备600包括：诸如中央处理单元的处理器610、通信总线620、通信接口640以及存储介质630。其中，处理器610与存储介质630可以通过通信总线620相互通信。存储介质630内存储有计算机程序，当该计算机程序被处理器610执行时即可实现本发明实施例提供的方法的各步骤的功能。其中，存储介质可以包括随机存取存储器，也可以包括非易失性存储器，例如至少一个磁盘存储器。另外，存储介质还可以是至少一个位于远离前述处理器的存储装置。处理器可以是通用处理器，包括中央处理器、网络处理器等；还可以是数字信号处理器、专用集成电路、现场可编程门阵列或其他可编程逻辑器件、分立门或者晶体管逻辑器件、分立硬件组件。应当认识到，本发明的实施例可以由计算机硬件、硬件和软件的组合、或者通过存储在非暂时性存储器中的计算机指令来实现或实施。所述方法可以使用标准编程技术，包括配置有计算机程序的非暂时性存储介质在计算机程序中实现，其中如此配置的存储介质使得计算机以特定和预定义的方式操作。每个程序可以以高级过程或面向对象的编程语言来实现以与计算机系统通信。然而，若需要，该程序可以以汇编或机器语言实现。在任何情况下，该语言可以是编译或解释的语言。此外，为此目的该程序能够在编程的专用集成电路上运行。此外，可按任何合适的顺序来执行本发明描述的过程的操作，除非本发明另外指示或以其他方式明显地与上下文矛盾。本发明描述的过程可在配置有可执行指令的一个或多个计算机系统的控制下执行，并且可作为共同地在一个或多个处理器上执行的代码、由硬件或其组合来实现。所述计算机程序包括可由一个或多个处理器执行的多个指令。进一步，所述方法可以在可操作地连接至合适的任何类型的计算平台中实现，包括但不限于个人电脑、迷你计算机、主框架、工作站、网络或分布式计算环境、单独的或集成的计算机平台、或者与带电粒子工具或其它成像装置通信等等。本发明的各方面可以以存储在非暂时性存储介质或设备上的机器可读代码来实现，无论是可移动的还是集成至计算平台，如硬盘、光学读取和/或写入存储介质、RAM、ROM等，使得其可由可编程计算机读取，当存储介质或设备由计算机读取时可用于配置和操作计算机以执行在此所描述的过程。此外，机器可读代码，或其部分可以通过有线或无线网络传输。当此类媒体包括结合微处理器或其他数据处理器实现上文所述步骤的指令或程序时，本发明所述的发明包括这些和其他不同类型的非暂时性计算机可读存储介质。当根据本发明所述的方法和技术编程时，本发明还包括计算机本身。以上所述仅为本发明的实施例而已，并不用于限制本发明。对于本领域技术人员来说，本发明可以有各种更改和变化。凡在本发明的精神和原理之内所作的任何修改、等同替换、改进等，均应包含在本发明的保护范围之内。
