标题title
一种实现云手机分时共享的方法及系统
摘要abst
本发明公开了一种实现云手机分时共享的方法及系统，该方法包括如下步骤：步骤S1，当判断云手机处于空闲状态，对当前用户的客制化数据进行统计，根据统计结果确定当前用户的类别，根据确定的类别对当前用户的客制化数据进行相应的备份处理，并在数据备份完成后，重启云机，恢复系统初始数据；步骤S2，当接收到用户的申请分配云机请求时，根据用户类型重新分配云机，并根据用户的类别进行云手机再分配处理。
权利要求书clms
1.一种实现云手机分时共享的方法，包括如下步骤：步骤S1，当判断云手机处于空闲状态，对当前用户的客制化数据进行统计，根据统计结果确定当前用户的类别，根据确定的类别对当前用户的客制化数据进行相应的备份处理，并在数据备份完成后，重启云机，恢复系统初始数据；步骤S2，当接收到用户的申请分配云机请求时，根据用户类型重新分配云机，并根据用户的类别进行云手机再分配处理。2.如权利要求1所述的一种实现云手机分时共享的方法，其特征在于，步骤S1进一步包括：步骤S100，判断云手机是否为空闲状态，若为空闲状态，则启动云机释放流程，进入步骤S101；步骤S101，分析云手机当前用户的客制化数据，根据用户客制化数据的类型、数据的大小及恢复速度进行评估，确定云手机当前用户的类别；步骤S102，根据确定的当前用户的类别，采用相应的方法进行数据备份；步骤S103，当数据备份完成后，重启云手机，恢复系统初始数据。3.如权利要求2所述的一种实现云手机分时共享的方法，其特征在于，于步骤S101中，对当前用户的客制化数据进行统计，分析用户客制化数据的类型、数据的大小及恢复速度进行评估，计算出个性化数据的恢复时间，根据个性化数据恢复的时间确定用户类型。4.如权利要求3所述的一种实现云手机分时共享的方法，其特征在于，于步骤S101中，所述个性化数据的恢复时间为：系统预装应用用户数据的网络传输及恢复时间+用户应用安装包的网络下载时间、安装时间及其用户数据网络传输恢复时间。5.如权利要求4所述的一种实现云手机分时共享的方法，其特征在于，所述根据个性化数据恢复的时间确定用户类型的方法包括：当所述个性化数据恢复的时间＜＝设定值，确定为A类用户；当所述个性化数据恢复的时间＞设定值，判断为B类用户或者C类用户，并根据一段时间内应用的I/O并发数据来区分B类用户与C类用户。6.如权利要求5所述的一种实现云手机分时共享的方法，其特征在于，于步骤S102中，若当前用户为A类用户，则采用网络快速备份恢复方法进行数据备份，对用户个性化的数据进行提取，压缩打包上传到外部存储服务器，并将该类用户的云手机加入释放队列；若当前用户为B类用户，则采用网络快速备份恢复与网络磁盘映射备份恢复相结合的方式进行数据备份，并将该类用户的云手机加入释放队列，以便云手机不足时释放重启备用；若当前用户为C类用户，则采用网络快速备份恢复与网络磁盘映射备份恢复相结合的方式进行数据备份，并根据系统的I/O负荷等参数进行配置释放。7.如权利要求2所述的一种实现云手机分时共享的方法，其特征在于，步骤S2进一步包括：步骤S200，接收用户的申请分配云机请求，根据用户的类别进行云机分配；步骤S201，根据用户的分类采用相应的方法进行数据的快速恢复。8.如权利要求7所述的一种实现云手机分时共享的方法，其特征在于：于步骤S201中，若用户为A类用户，采用网络快速备份恢复方法进行数据恢复，直接从外部存储服务器下载用户数据进行恢复；若用户为B类用户或C类用户，采用网络快速备份恢复与网络磁盘映射备份恢复相结合的方式进行数据恢复。9.如权利要求8所述的一种实现云手机分时共享的方法，其特征在于：于步骤201中，对于B类用户或C类用户，当通过网络快速备份恢复方法对数据快速恢复完成后，后台扫描网络挂载目录安装的应用进行安装恢复，不影响用户操作。10.一种实现云手机分时共享的系统，包括：云机释放处理单元，用于当判断云手机处于空闲状态，对当前用户的客制化数据进行统计，根据统计结果确定当前用户的类别，根据确定的类别对当前用户的客制化数据进行相应的备份处理，并在数据备份完成后，重启云机，恢复系统初始数据；云机再分配单元，用于当接收到用户的申请分配云机请求时，根据用户类型重新分配云机，并根据用户的类别进行云手机再分配处理。
说明书desc
技术领域本发明涉及云手机技术领域，特别是涉及一种实现云手机分时共享的方法及系统。背景技术云手机是通过在云服务器端通过虚拟容器的方式，将一台云服务器划分成多个虚拟机来独立运行的android系统，然后提供远程操作让手机等终端设备操作使用，使得各种应用运行在云端，方便管理，可以大大减少真实手机本地资源的消耗。目前，云手机的应用场景也越来越多，包括游戏、办公、教育、视频、娱乐等等。在用户订购云手机的时候，一个云手机分配给某个一个用户使用后，由于用户的数据一直保存在云机上，订购期间就算用户长时间不使用该云机，该云机也无法被再次分配使用，造成云机资源的浪费，云机大都只能采用包天、包月等运营方法，运营方式不灵活，目前云机的运营成本也比较高，不利于云机的推广使用。如果云手机能做到与用户的数据进行分离，根据当前用户的使用情况，空闲的时候对用户数据进行备份，释放云机给其他用户使用；当用户需要再次访问云机的时候重新分配云机并快速恢复用户数据，快速重新进入云机。那么将会大大提高云手机的利用率，从而减低云手机的运营成本。如何让释放云机的用户可以再次快速的使用云机，将影响到用户的体验，成为云手机能否共享的关键。因此需要根据用户使用云机的场景和情况不同，采用相应处理的方法，保证快速恢复使用，实现云机共享。公开号为CN111988409A的中国专利申请公开了一种实现云手机挂载外部存储启动的方法及系统，该方法提供一种实现云手机挂载外部存储启动的方法，将不同用户之间的app和数据备份到配置为关联用户账号的系统集群，用户使用云机的时候，加电启动云机，连接外部存储，根据用户的信息，找到用户对应的rbd，将此rbd加载到云手机中，作为内部存储使用。用户登录后开始使用云手机，如果新安装app或修改了用户数据，都会保存到自己的rbd上；当用户不使用云机的时候，释放云机，重新启动，加载另外一个用户的rbd加载到云手机进行使用，从而实现对于存在固定使用时间段的使用场景，适合云手机的时分复用，可以提高云手机的综合使用效率。该方案将系统和用户数据通过外部存储完全分离，理论上是可以达到云机的释放再分配的，但是实际仍存在如下问题：1、该方案没有考虑系统及预置应用的情况，这类数据分布在系统的各个目录，无法用挂载外部存储的方式实现，该方案并不能完全的将用户数据进行提取备份；2、用户连接云机的时候，需要重新开机，映射用户分区，加载用户的数据到系统，整个系统启动过程会比较长，用户需要连接等待数十秒才能重新进入云机，严重影响用户的体验。3、所有的用户数据和应用都存放到外部存储，应用的访问都会导致I/O的频繁使用，对云机的I/O性能要求比较高，严重的情况可能会导致操作卡顿，应用会出现无响应。发明内容为克服上述现有技术存在的不足，本发明之一目的在于提供一种实现云手机分时共享的方法及系统，充分考虑了云手机的各种使用场景，既考虑了用户自己安装应用的情况，也考虑系统预置应用的情况，对用户数据进行分类备份处理和快速恢复，保证用户数据的完整性。本发明之另一目的在于提供一种实现云手机分时共享的方法及系统，通过快速恢复用户数据，不需要重启云机，用户客户连接一台新分配云机时也感觉不出差异，保证用户体验，达到云机共享的效果。本发明之再一目的在于提供一种实现云手机分时共享的方法及系统，针对存放到外部存储的情况，充分考虑了系统I/O的使用情况，避免系统卡顿，增强用户体验。本发明之又一目的在于提供一种实现云手机分时共享的方法及系统，通过分析用户数据修改的内容，有选择地进行云机的释放和再分配，让不同用户分时使用同一台云手机，大大提高云手机的利用率，减低云手机的运营成本，也灵活了云手机的运营方式。为达上述目的，本发明提出一种实现云手机分时共享的方法，包括如下步骤：步骤S1，当判断云手机处于空闲状态，对当前用户的客制化数据进行统计，根据统计结果确定当前用户的类别，根据确定的类别对当前用户的客制化数据进行相应的备份处理，并在数据备份完成后，重启云机，恢复系统初始数据；步骤S2，当接收到用户的申请分配云机请求时，根据用户类型重新分配云机，并根据用户的类别进行云手机再分配处理。优选地，步骤S1进一步包括：步骤S100，判断云手机是否为空闲状态，若为空闲状态，则启动云机释放流程，进入步骤S101；步骤S101，分析云手机当前用户的客制化数据，根据用户客制化数据的类型、数据的大小及恢复速度进行评估，确定云手机当前用户的类别；步骤S102，根据确定的当前用户的类别，采用相应的方法进行数据备份；步骤S103，当数据备份完成后，重启云手机，恢复系统初始数据。优选地，于步骤S101中，对当前用户的客制化数据进行统计，分析用户客制化数据的类型、数据的大小及恢复速度进行评估，计算出个性化数据的恢复时间，根据个性化数据恢复的时间确定用户类型。优选地，于步骤S101中，所述个性化数据的恢复时间为：系统预装应用用户数据的网络传输及恢复时间+用户应用安装包的网络下载时间、安装时间及其用户数据网络传输恢复时间。优选地，所述根据个性化数据恢复的时间确定用户类型的方法包括：当所述个性化数据恢复的时间＜＝设定值，确定为A类用户；当所述个性化数据恢复的时间＞设定值，判断为B类用户或者C类用户，并根据一段时间内应用的I/O并发数据来区分B类用户与C类用户。优选地，于步骤S102中，若当前用户为A类用户，则采用网络快速备份恢复方法进行数据备份，对用户个性化的数据进行提取，压缩打包上传到外部存储服务器，并将该类用户的云手机加入释放队列；若当前用户为B类用户，则采用网络快速备份恢复与网络磁盘映射备份恢复相结合的方式进行数据备份，并将该类用户的云手机加入释放队列，以便云手机不足时释放重启备用；若当前用户为C类用户，则采用网络快速备份恢复与网络磁盘映射备份恢复相结合的方式进行数据备份，并根据系统的I/O负荷等参数进行配置释放。优选地，步骤S2进一步包括：步骤S200，接收用户的申请分配云机请求，根据用户的类别进行云机分配；步骤S201，根据用户的分类采用相应的方法进行数据的快速恢复。优选地，于步骤S201中，若用户为A类用户，采用网络快速备份恢复方法进行数据恢复，直接从外部存储服务器下载用户数据进行恢复；若用户为B类用户或C类用户，采用网络快速备份恢复与网络磁盘映射备份恢复相结合的方式进行数据恢复。优选地，于步骤201中，对于B类用户或C类用户，当通过网络快速备份恢复方法对数据快速恢复完成后，后台扫描网络挂载目录安装的应用进行安装恢复，不影响用户操作。为达到上述目的，本发明还提供一种实现云手机分时共享的系统，包括：云机释放处理单元，用于当判断云手机处于空闲状态，对当前用户的客制化数据进行统计，根据统计结果确定当前用户的类别，根据确定的类别对当前用户的客制化数据进行相应的备份处理，并在数据备份完成后，重启云机，恢复系统初始数据；云机再分配单元，用于当接收到用户的申请分配云机请求时，根据用户类型重新分配云机分配，并根据用户的类别进行云手机再分配处理。与现有技术相比，本发明具有如下有益效果：1、本发明充分考虑了云手机的各种使用场景，既考虑了用户自己安装应用的情况，也考虑系统预置应用的情况，对用户数据进行分类备份处理和快速恢复，保证用户数据的完整性；2、本发明通过快速恢复用户数据，不需要重启云机，耗时的恢复在后台处理，用户客户可以快速连接一台新分配云机，完全感觉不出差异，保证用户体验，达到云机共享的佳效果。3、本发明针对存放到外部存储的情况，充分考虑系统I/O的使用情况，避免系统卡顿，增强用户体验。4、本发明通过分析用户数据修改的内容，有选择的进行云机的释放和再分配，从而让不同用户分时使用同一台云机，大大提高了云手机的利用率，减低云手机的运营成本，也灵活了云手机的运营方式。附图说明图1为本发明一种实现云手机分时共享的方法的步骤流程图；图2为本发明一种实现云手机分时共享的系统的结构框图；图3为本发明实施例中云机释放流程图；图4为本发明实施例中云机再分配流程图；图5为本发明实施例中网络快速备份恢复流程图。具体实施方式以下通过特定的具体实例并结合附图说明本发明的实施方式，本领域技术人员可由本说明书所揭示的内容轻易地了解本发明的其它优点与功效。本发明亦可通过其它不同的具体实例加以施行或应用，本说明书中的各项细节亦可基于不同观点与应用，在不背离本发明的精神下进行各种修饰与变更。图1为本发明一种实现云手机分时共享的方法的步骤流程图，如图1所示，本发明一种实现云手机分时共享的方法，应用于云机端，包括如下步骤：步骤S1，当判断云手机处于空闲状态，对当前用户的客制化数据进行统计，根据统计结果确定当前用户的类别，根据确定的类别对当前用户的客制化数据进行相应的备份处理，并在数据备份完成后，重启云机，恢复系统初始数据。具体地，步骤S1进一步包括：步骤S100，判断云手机是否为空闲状态，若为空闲状态，则启动云机释放流程，进入步骤S101。在本发明中，当云手机判断用户主动或者无操作超时退出使用云手机，并且在预设时间内没有再次连接云手机时，判断云手机当前为空闲状态，则启动云机释放流程，进入步骤S101。步骤S101，分析云手机当前用户的客制化数据，根据用户客制化数据的类型、数据的大小及恢复速度进行评估，确定云手机当前用户的类别。在本发明中，云手机用户的分类方法主要根据用户客制化的数据分为三类，所述用户客制化的数据主要包括对系统预置应用的修改和用户自己安装的应用两类，云手机通过分析用户客制化数据的类型、数据的大小及恢复速度进行评估，将用户划分成A/B/C三类，采用相应的方法数据备份和恢复，其中：A类用户属于只使用系统预置的应用，极少安装个人应用，个性化数据比较少，因此可以对用户个性化的数据进行提取，压缩打包上传到外部存储服务器；在本发明实施例中，所述个性化数据包括但不限于系统预装应用的用户修改数据、用户安装的应用安装包及用户数据。B类用户不单单使用系统预置的应用，也会安装一部分个人应用使用，个性化数据一般，因此对系统预置的应用的修改部分行提取，压缩打包上传到外部存储服务器，恢复的时候可以快速恢复连上云机；而对个性化安装应用app部分，则采用网络磁盘挂载的方式，系统在后台数据恢复，该类云手机可以放到队列里面作为备用，在云手机不足的时候再进行释放；C类用户安装的个性化app比较丰富，个性化数据很多，并需要根据系统的I/O负荷等参数进行释放。因此在本发明中，在释放云机之前，对当前用户的客制化数据进行统计，分析用户客制化数据的类型、数据的大小及恢复速度进行评估，计算出个性化数据的恢复时间，根据个性化数据恢复的时间确定当前用户为A/B/C三类中的哪一类。具体地，根据个性化数据估算出个性化数据的恢复时间，估算方法如下：系统预装应用用户数据的网络传输及恢复时间+用户应用安装包的网络下载时间、安装时间及其用户数据网络传输恢复时间。A/B/C类用户可以具体地按照如下方法来划分用户类型：1.当个性化数据恢复的时间＜＝5秒，为A类用户；2.当个性化数据恢复的时间＞5秒，为B或者C类，然后根据平时应用的I/O并发数据来区分；.如果记录的磁盘I/O比较高，则确定为C类用户，否则为B类用户。步骤S102，根据确定的当前用户的类别，采用相应的方法进行数据备份。具体地，若当前用户为A类用户，则采用网络快速备份恢复方法进行数据备份，即对用户个性化的数据进行提取，压缩打包上传到外部存储服务器，并将该类用户的云手机加入可以释放的释放队列，以便云手机不足时释放重启备用；若当前用户为B类用户，则采用网络快速备份恢复与网络磁盘映射备份恢复相结合的方式进行数据备份，即对系统预置的应用的修改部分行提取，压缩打包上传到外部存储服务器，对个性化安装应用app部分，则采用网络磁盘映射备份恢复的方式，并将该类用户的云手机加入可以释放队列，以便云手机不足时释放重启备用；若当前用户为C类用户，则采用网络快速备份恢复与网络磁盘映射备份恢复相结合的方式进行数据备份，根据系统的I/O负荷等参数进行配置释放，即根据I/O负荷等参数的配置确定是否加入可释放的释放队列。需说明的是，B类用户与C类用户的区分是平时使用磁盘I/O的高低，B类用户的磁盘I/O比较低，磁盘挂载不影响使用；C类用户占用磁盘I/O比较多，考虑整个云机服务器的网络I/O处理能力，同一台服务器应避免分配过多的C类的用户云手机实例。在本发明具体实施例中，对于采用网络快速备份恢复方法进行数据备份，具体包括如下步骤：提取用户修改数据，包括系统预置应用的修改内容和用户安装的应用，具体包括：通过分析/data/app目录与预置系统应用的数据区别，通过修改时间等信息分析出用户自己安装的应用；或者通过分析分析/data/data目录下系统预置应用的修改数据及用户自己安装的数据，按目录进行提取；针对允许allowbackup应用也可以采用adb backup命令提取。将提取的用户数据压缩打包上传备份到外部存储服务器。具体地，将系统预置应用的修改内容和用户安装的应用分别打包，每个应用对应自己的子目录，压缩成一个文件，带上用户ID和时间戳命名，上传到指定的网络存储服务器。对于网络磁盘映射备份恢复的备份方式，主要针对用户安装app比较多的情况，考虑到提取数据备份的数据内容比较多，影响备份速度，因此采用网络磁盘挂载的方法，以提高恢复时间，将用户安装应用独立的目录进行映射，与系统应用区分开单独存放，方便隔离备份。通过挂载网络磁盘单独安装运行用户应用APK从下面几个方面来实现：1、应用安装目录：可以分别映射成安装到/mnt/NFSInstall目录下面，创建3个目录：/mnt/NFSInstall/app--安装时将apk文件复制到此目录/mnt/NFSInstall/data--存放应用程序数据/mnt/NFSInstall/dalvik-cache--将apk中的dex文件安装到dalvik-cache目录下2、应用安装过程下载APK安装包到/mnt/NFSInstall/app目录下，解压并扫描安装包，把dex文件保存到/mnt/NFSInstall/dalvik-cache目录，并/mnt/NFSInstall/data目录下创建对应的应用数据目录。3、应用卸载过程删除安装过程中在上述三个目录/mnt/NFSInstall/app、/mnt/NFSInstall/data、/mnt/NFSInstall/dalvik-cache下创建的文件及目录。4、用户数据使用备份用户安装的应用数据在独立的/mnt/NFSInstall目录存放，用户安装、卸载应用、更新用户数据都会实时更新到该目录下面。当用户空闲释放云机的时候，只需要将该网络挂载的磁盘进行卸载即可。步骤S103，当数据备份完成后，重启云手机，恢复系统初始数据，即释放云机，等待新用户连接使用。具体地，根据释放队列进行释放云机，优选地，在加入释放队列时，也可考虑A类用户优先释放的情况。步骤S2，当接收到用户的申请分配云机请求时，根据用户类型重新分配云机分配，并根据用户的类别进行云手机再分配处理。具体地，步骤S2进一步包括：步骤S200，接收用户的申请分配云机请求，根据用户的类别进行云机分配。也就是说，当用户之前的云手机被释放后，当该用户再次申请连接云手机，系统需要重新分配云手机，用户申请云机的时候，一般由系统统一分配，从空闲云机中进行分配，先到先得，如果没有空闲云机，只能等系统释放其他云机再分配。当接收到分配云机请求时，若为新用户，则可以直接分配；若不是新用户，则确定用户类型，用户类型的确定可根据前述方法，在此不予赘述，对于A/B类用户可直接分配云机，若为B类用户，则要考虑云机服务器的实例已分配情况，需保证云机服务器所分配的C类云手机用户实例占比不超过设定值，例如10％。步骤S201，根据用户的分类采用相应的方法进行数据的快速恢复。具体地，若用户为A类用户，采用网络快速备份恢复方法进行数据恢复，即A类用户个性化数据比较少，直接从外部存储服务器下载用户数据进行恢复，保证可以快速进入云机并正常使用；若用户为B类用户，采用网络快速备份恢复与网络磁盘映射备份恢复相结合的方式进行数据恢复，即B类用户的系统预置应用数据直接从从外部存储服务器下载用户数据进行恢复，保证可以快速进入云机，而用户安装的个性化app及其数据通过网络磁盘挂载的方式，在后台搜索对应目录将数据导入内存；若用户为C类用户，C类用户的恢复过程跟B类用户相似，即采用网络快速备份恢复与网络磁盘映射备份恢复相结合的方式进行数据恢复，优选地，如果用户app很多及在后台恢复时间相对长些，可以针对常用应用先恢复。在本发明具体实施例中，对于采用网络快速备份恢复方法进行数据恢复，具体包括如下步骤：从网络数据存储服务器下载对应用户的数据到云手机，并对下载的数据进行解压，在本发明具体实施例中，以华为云的对象存储服务为例：./obsutil cp obs://bucket/001/data/将解压后的数据分别恢复到/data/app和/data/data目录，或者用adb restory进行恢复。总之，通过快速恢复的方法处理用户修改数据比较少的情况，可以快速进行恢复，减少等待时间，提高用户体验。对于网络磁盘映射备份恢复方式，即用户数据通过网络磁盘挂载的方式备份，当用户连接云机的时候，将该用户数据网络磁盘进行挂载到/mnt/NFSInstall目录，启动系统后台扫描进行，将安装信息加载到内存。由于网络磁盘挂载后，扫描apk加载到系统内存需要一定的时间，需要在后台执行，避免影响用户使用。另外,针对一些读写磁盘比较频繁的应用，网络的访问延时可能会影响性能,而使用网络挂载的方式对I/O性能有一定要求，因此需要实时检测I/O情况，进行配置使用。本发明考虑了这些情况，充分保证了云手机分时共享实用的体验，避免用户等待，提高用户体验。当通过网络快速备份恢复方法对数据快速恢复完成后，对于B类和C类用户，后台扫描网络挂载目录安装的应用进行安装恢复，不影响用户操作。具体地，快速恢复完成后，用户可以很快到云机进行操作，后台扫描网络挂载目录安装的应用进行安装恢复，不影响用户操作。图2为本发明一种实现云手机分时共享的系统的结构图，如图2所示，本发明一种实现云手机分时共享的系统，应用于云机端，包括：云机释放处理单元20，用于当判断云手机处于空闲状态，对当前用户的客制化数据进行统计，根据统计结果确定当前用户的类别，根据确定的类别对当前用户的客制化数据进行相应的备份处理，并在数据备份完成后，重启云机，恢复系统初始数据。具体地，云机释放处理单元20进一步包括：空闲状态监测模块201，用于判断云手机是否为空闲状态，若为空闲状态，则启动云机释放流程，进入用户类别评估模块202。在本发明中，当云手机判断用户主动或者无操作超时退出使用云手机，并且在预设时间内没有再次连接云手机时，判断云手机当前为空闲状态，则启动云机释放流程，进入用户类别评估模块202。用户类别评估模块202，用于分析云手机当前用户的客制化数据，根据用户客制化数据的类型、数据的大小及恢复速度进行评估，确定云手机当前用户的类别。在本发明中，云手机用户的分类方法主要根据用户客制化的数据分为三类，所述用户客制化的数据主要包括对系统预置应用的修改和用户自己安装的应用两类，云手机通过分析用户客制化数据的类型、数据的大小及恢复速度进行评估，将用户划分成A/B/C三类，采用相应的方法数据备份和恢复，其中：A类用户属于只使用系统预置的应用，极少安装个人应用，个性化数据比较少，因此可以对用户个性化的数据进行提取，压缩打包上传到外部存储服务器，在本发明实施例中，所述个性化数据包括但不限于系统预装应用的用户修改数据、用户安装的应用安装包及用户数据；B类用户不单单使用系统预置的应用，也会安装一部分应用进行，个性化数据一般，因此对系统预置的应用的修改部分行提取，压缩打包上传到外部存储服务器，恢复的时候可以快速恢复连上云机；而对个性化安装应用app部分，则采用网络磁盘挂载的方式，系统在后台数据恢复，该类云手机可以放到队列里面作为备用，在云手机不足的时候再进行释放；C类用户安装的个性化app也比较丰富，个性化数据很多，并需要根据系统的I/O负荷等参数进行释放。因此在本发明中，在释放云机之前，对当前用户的客制化数据进行统计，分析用户客制化数据的类型、数据的大小及恢复速度进行评估，计算出个性化数据的恢复时间，根据个性化数据恢复的时间确定当前用户为A/B/C三类中的哪一类。具体地，根据个性化数据估算出个性化数据的恢复时间，估算方法如下：系统预装应用用户数据的网络传输及恢复时间+用户应用安装包的网络下载时间、安装时间及其用户数据网络传输恢复时间。A/B/C类用户可以具体地按照如下方法来划分用户类型：1.当个性化数据恢复的时间＜＝5秒，为A类用户；2.当个性化数据恢复的时间＞5秒，为B或者C类，然后根据平时应用的I/O并发数据来区分；.如果记录的磁盘I/O比较高，则确定为C类用户，否则为B类用户。数据备份模块203，用于根据确定的当前用户的类别，采用相应的方法进行数据备份。具体地，具体地，若当前用户为A类用户，则采用网络快速备份恢复方法进行数据备份，即对用户个性化的数据进行提取，压缩打包上传到外部存储服务器，并将该类用户的云手机加入可以释放的释放队列，以便云手机不足时释放重启备用；若当前用户为B类用户，则采用网络快速备份恢复与网络磁盘映射备份恢复相结合的方式进行数据备份，即对系统预置的应用的修改部分行提取，压缩打包上传到外部存储服务器，对个性化安装应用app部分，则采用网络磁盘映射备份恢复的方式，并将该类用户的云手机加入可以释放队列，以便云手机不足时释放重启备用；若当前用户为C类用户，则采用网络快速备份恢复与网络磁盘映射备份恢复相结合的方式进行数据备份，根据系统的I/O负荷等参数进行配置释放，即根据I/O负荷等参数的配置确定是否加入可释放的释放队列。需说明的是，B类用户与C类用户的区分是平时使用磁盘I/O的高低，B类用户的磁盘I/O比较低，磁盘挂载不影响使用；C类用户占用磁盘I/O比较多，考虑整个云机服务器的网络I/O处理能力，同一台服务器应避免分配过多的C类的用户云手机实例。在本发明具体实施例中，对于采用网络快速备份恢复方法进行数据备份，具体包括如下步骤：提取用户修改数据，包括系统预置应用的修改内容和用户安装的应用，具体包括：通过分析/data/app目录与预置系统应用的数据区别，通过修改时间等信息分析出用户自己安装的应用；或者通过分析分析/data/data目录下系统预置应用的修改数据及用户自己安装的数据，按目录进行提取；针对允许allowbackup应用也可以采用adb backup命令提取。将提取的用户数据压缩打包上传备份到外部存储服务器。具体地，将系统预置应用的修改内容和用户安装的应用分别打包，每个应用对应自己的子目录，压缩成一个文件，带上用户ID和时间戳命名，上传到指定的网络存储服务器。对于网络磁盘映射备份恢复的备份方式，主要针对用户安装app比较多的情况，考虑到提取数据备份的数据内容比较多，影响备份速度，因此采用网络磁盘挂载的方法，以提高恢复时间，将用户安装应用独立的目录进行映射，与系统应用区分开单独存放，方便隔离备份。通过挂载网络磁盘单独安装运行用户应用APK从下面几个方面来实现：1、应用安装目录：可以分别映射成安装到/mnt/NFSInstall目录下面，创建3个目录：/mnt/NFSInstall/app--安装时将apk文件复制到此目录/mnt/NFSInstall/data--存放应用程序数据/mnt/NFSInstall/dalvik-cache--将apk中的dex文件安装到dalvik-cache目录下2、应用安装过程下载APK安装包到/mnt/NFSInstall/app目录下，解压并扫描安装包，把dex文件保存到/mnt/NFSInstall/dalvik-cache目录，并/mnt/NFSInstall/data目录下创建对应的应用数据目录。3、应用卸载过程删除安装过程中在上述三个目录/mnt/NFSInstall/app、/mnt/NFSInstall/data、/mnt/NFSInstall/dalvik-cache下创建的文件及目录。4、用户数据使用备份用户安装的应用数据在独立的/mnt/NFSInstall目录存放，用户安装、卸载应用、更新用户数据都会实时更新到该目录下面。当用户空闲释放云机的时候，只需要将该网络挂载的磁盘进行卸载即可。云机释放模块204，用于在数据备份完成后，重启云手机，恢复系统初始数据，等待新用户连接使用。具体地，云机释放模块204可根据释放队列进行释放云机，优选地，在加入释放队列时，也可考虑A类用户优先释放的情况。云机再分配单元21，用于在接收到用户的申请分配云机请求时，根据用户类型重新分类云手机，根据用户的类别进行云手机再分配处理。具体地，云机再分配单元21进一步包括：请求接收模块210，用于接收用户的申请分配云机请求，根据用户的类别进行云机分配。也就是说，当用户之前的云手机被释放后，当该用户再次申请连接云手机，系统接收到申请分配云机请求，需要重新分配云手机。用户申请云机的时候，一般由系统统一分配，从空闲云机中进行分配，先到先得，如果没有空闲云机，只能等系统释放其他云机再分配。当接收到分配云机请求时，若为新用户，则可以直接分配；若不是新用户，则确定用户类型，用户类型的确定可根据前述方法，在此不予赘述，对于A/B类用户可直接分配云机，若为B类用户，则要考虑云机服务器的实例已分配情况，需保证云机服务器所分配的C类云手机用户实例占比不超过设定值，例如10％。数据恢复模块211，用于根据用户的分类采用相应的方法进行数据的快速恢复。具体地，若用户为A类用户，采用网络快速备份恢复方法进行数据恢复，即A类用户个性化数据比较少，直接从外部存储服务器下载用户数据进行恢复，保证可以快速进入云机并正常使用；若用户为B类用户，采用网络快速备份恢复与网络磁盘映射备份恢复相结合的方式进行数据恢复，即B类用户的系统预置应用数据直接从从外部存储服务器下载用户数据进行恢复，保证可以快速进入云机，而用户安装的个性化app及其数据通过网络磁盘挂载的方式，在后台搜索对应目录将数据导入内存；若用户为C类用户，C类用户的恢复过程跟B类用户相似，即采用网络快速备份恢复与网络磁盘映射备份恢复相结合的方式进行数据恢复，优选地，如果用户app很多及在后台恢复时间相对长些，可以针对常用应用先恢复。在本发明具体实施例中，对于采用网络快速备份恢复方法进行数据恢复，具体包括如下步骤：从网络数据存储服务器下载对应用户的数据到云手机，并对下载的数据进行解压，在本发明具体实施例中，以华为云的对象存储服务为例：./obsutil cp obs://bucket/001/data/将解压后的数据分别恢复到/data/app和/data/data目录，或者用adb restory进行恢复。总之，通过快速恢复的方法处理用户修改数据比较少的情况，可以快速进行恢复，减少等待时间，提高用户体验。对于网络磁盘映射备份恢复方式，即用户数据通过网络磁盘挂载的方式备份，当用户连接云机的时候，将该用户数据网络磁盘进行挂载到/mnt/NFSInstall目录，启动系统后台扫描进行，将安装信息加载到内存。由于网络磁盘挂载后，扫描apk加载到系统内存需要一定的时间，需要在后台执行，避免影响用户使用。另外,针对一些读写磁盘比较频繁的应用，网络的访问延时可能会影响性能,而使用网络挂载的方式对I/O性能有一定要求，因此需要实时检测I/O情况，进行配置使用。本发明考虑了这些情况，充分保证了云手机分时共享实用的体验，避免用户等待，提高用户体验。当通过网络快速备份恢复方法对数据快速恢复完成后，对于B类和C类用户，后台扫描网络挂载目录安装的应用进行安装恢复，不影响用户操作。当通过网络快速备份恢复方法对数据快速恢复完成后，对于B类和C类用户，后台扫描网络挂载目录安装的应用进行安装恢复，不影响用户操作。具体地，快速恢复完成后，用户可以很快的到云机进行操作，后台扫描网络挂载目录安装的应用进行安装恢复，不影响用户操作。实施例在本实施例中，本发明从流程上分为云机空闲释放流程和云机再分配流程，数据的备份恢复包括用户数据快速恢复和用户应用网络磁盘挂载两种方式。如图3所示，云机释放流程如下：步骤一，当云机判断主动或者无操作超时退出使用云机，并且一定时间没有再次连接云机，云机判断为空闲状态，开始启动云机释放流程。步骤二，释放云机之前对用户修改数据进行统计，根据修改的数据内容，分成A/B/C类，对每类分别进行数据备份和释放云机处理。云手机用户分类方法主要根据用户客制化的数据来进行三类，用户客制化的数据主要包括对系统预置应用的修改和用户自己安装的应用两类。云系统会分析用户客制化数据的类型、数据的大小及恢复速度进性评估，将用户划分成以下A/B/C三类，并采用相应的方法数据备份和恢复：A类用户属于只使用系统预置的应用，极少安装个人应用，个性化数据比较少，可以对用户个性化的数据进行提取，压缩打包上传到外部存储服务器；B类用户不单单使用系统预置的应用，也会安装一部分应用进行，个性化数据一般。对系统预置的应用的修改部分行提取，压缩打包上传到外部存储服务器，恢复的时候可以快速恢复连上云机；对个性化安装应用app部分，可以采用网络磁盘挂载的方式，系统在后台数据恢复。该类云手机可以放到队列里面作为备用，在云机不足的时候进行释放；C类用户的安装的个性化app也比较丰富，个性化数据很多，该类用户备份恢复的数据比较多，需要根据系统的I/O负荷等参数进行释放。步骤三，数据备份完成后，重启云机，恢复系统初始数据，等待新用户连接使用。如图4所示，在本实施例中，云机再分配流程如下：步骤一，当用户之前的云机被释放后，再次申请连接云机，系统需要重新分配云机；步骤二，云机根据用户的分类进行采用相应的方法进行数据恢复：A类用户个性化数据比较少，直接从外部存储服务器下载用户数据进行恢复，保证可以快速进入云机并正常使用；B类用户的系统预置应用数据直接从外部存储服务器下载用户数据进行恢复，保证可以快速进入云机，用户安装的个性化app及其数据通过网络磁盘挂载的方式，在后台搜索对应目录将数据导入内存；C类用户的恢复过程跟B相似，如果用户app很多及在后台恢复时间相对长些，可以针对常用应用先恢复。步骤三，快速恢复完成后，用户可以很快地到云机进行操作，后台扫描网络挂载目录安装的应用进行安装恢复，不影响用户操作。在本实施例中，数据的备份恢复包括用户数据网络快速备份恢复和用户应用网络磁盘挂载两种方式，其中：一、网络快速备份恢复主要包括下面几个步骤，如图5所示：步骤一，提取用户修改数据，包括系统预置应用的修改内容和用安装的应用：1、通过分析/data/app目录与预置系统应用的数据区别，通过修改时间等信息分析出用户自己安装的应用；2、通过分析分析/data/data目录下系统预置应用的修改数据及用户自己安装的数据，按目录进行提取；针对允许allowbackup应用也可以采用adb backup命令提取。步骤二，用户数据压缩打包上传备份将系统预置应用的修改内容和用户安装的应用分别打包，每个应用对应自己的子目录，压缩成一个文件，带上用户ID和时间戳命名，上传到指定的网络存储服务器。以华为云的对象存储服务为例，通过obsutil实现数据上传备份：1、使用obsutil工具前，需要先获取OBS的终端节点信息，指定所在区域的终端节点，减少网络传输时延；2、通过./obsutil mb obs://bucket-test命令创建OBS数据桶；3、将用户数据压缩包上传到OBS桶，./obsutil cp/data/20211208.tar.gzobs://bucket-test/001步骤三，用户数据下载解压从网络数据存储服务器下载对应用户的数据到云机，以华为云的对象存储服务为例：./obsutil cp obs://bucket/001/data/对下载的数据进行解压。步骤四，用户恢复将数据分别恢复到/data/app和/data/data目录，或者用adb restory进行恢复。总之，通过快速恢复的方法处理用修改数据比较少的情况，可以快速进行恢复，减少等待时间，提高用户体验。二、网络磁盘映射备份恢复针对主要将用户安装app比较多的情况，考虑到提取数据备份的数据内容比较多，影响备份速度，可以采用网络磁盘挂载的方法，提高恢复时间。用户安装应用独立的目录进行映射，与系统应用区分开单独存放，方便隔离备份。通过挂载网络磁盘单独安装运行用户应用APK从下面几个方面来实现：1、应用安装目录：可以分别映射成安装到/mnt/NFSInstall目录下面，创建3个目录：/mnt/NFSInstall/app--安装时把apk文件复制到此目录/mnt/NFSInstall/data--存放应用程序数据/mnt/NFSInstall/dalvik-cache--将apk中的dex文件安装到dalvik-cache目录下2、应用安装过程下载APK安装包到/mnt/NFSInstall/app目录下，解压并扫描安装包，把dex文件保存到/mnt/NFSInstall/dalvik-cache目录，并/mnt/NFSInstall/data目录下创建对应的应用数据目录。3、应用卸载过程删除安装过程中在上述三个目录/mnt/NFSInstall/app、/mnt/NFSInstall/data、/mnt/NFSInstall/dalvik-cache下创建的文件及目录。4、用户数据使用备份用户安装的应用数据在独立的/mnt/NFSInstall目录存放，用户安装、卸载应用、更新用户数据都会实时更新到该目录下面。当用户空闲释放云机的时候，只需要将该网络挂载的磁盘进行卸载就可以了。5、用户应用恢复使用过程当用户连接云机的时候，将该用户数据网络磁盘进行挂载到/mnt/NFSInstall目录，启动系统后台扫描进行，将安装信息加载到内存。由于网络磁盘挂载后，扫描apk加载到系统内存需要一定的时间，需要在后台执行，避免影响用户使用。上述实施例仅例示性说明本发明的原理及其功效，而非用于限制本发明。任何本领域技术人员均可在不违背本发明的精神及范畴下，对上述实施例进行修饰与改变。因此，本发明的权利保护范围，应如权利要求书所列。
