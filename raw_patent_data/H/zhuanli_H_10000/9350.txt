标题title
一种报文转发方法及装置
摘要abst
本申请提供了一种报文转发方法及装置。其中，该方法包括：将连接同一个二层环网网络的多个二层接口设置为冗余组；将冗余组的正常工作的二层接口设置为选中状态；通过冗余组的其中一个选中状态的二层接口学习主机地址映射表项时，将主机地址映射表项的出接口设置为冗余组并设置可信端口标识；将学习到主机地址映射表项的选中状态的二层接口更新为冗余组的最高优先级；当收到的下行三层报文的目的IP地址匹配主机地址映射表项，基于主机地址表项将下行三层报文封装为下行二层报文，通过冗余组中最高优先级的二层接口发送。
权利要求书clms
1.一种报文转发方法，其特征在于，所述方法包括：将连接同一个二层环网网络的多个二层接口设置为冗余组；将所述冗余组的正常工作的二层接口设置为选中状态；通过所述冗余组的其中一个选中状态的二层接口学习主机地址映射表项时，将所述主机地址映射表项的出接口设置为所述冗余组并设置可信端口标识；将学习到所述主机地址映射表项的选中状态的二层接口更新为所述冗余组的最高优先级；当收到的下行三层报文的目的IP地址匹配所述主机地址映射表项，基于所述主机地址表项将所述下行三层报文封装为下行二层报文，通过所述冗余组中最高优先级的二层接口发送。2.根据权利要求1所述的方法，其特征在于，所述方法还包括：确定所述冗余组的最高优先级的二层接口为不工作状态；确定所述冗余组还有其他选中状态的二层接口；将所述可信端口标识修改为不可信端口标识；当收到的下行三层报文的目的IP地址匹配带有不可信端口标识的所述主机地址映射表项，基于所述主机地址表项将所述下行三层报文封装为下行二层报文，根据所述冗余组的所述其他二层接口选择一个当前最高优先级的二层接口发送。3.根据权利要求2所述的方法，其特征在于，所述方法还包括：向所述主机地址映射表项的IP地址发送硬件地址请求报文；接收硬件地址响应报文；将收到所述硬件地址响应报文的二层接口设置为所述冗余组的最高优先级的二层接口；将所述不可信端口标识修改为所述可信端口标识。4.根据权利要求2所述的方法，其特征在于，所述方法还包括：接收硬件地址通知报文；将接收所述主机硬件地址通知报文的二层接口修改为所述冗余组的最高优先级的二层接口；将所述硬件地址表项的所述不可信端口标识修改为所述可信端口标识；或者，接收请求网关MAC地址的硬件地址请求报文；将收到所述硬件地址请求报文的二层接口设置为所述冗余组的最高优先级的二层接口；将所述不可信端口标识修改为所述可信端口标识。5.根据权利要求1所述的方法，其特征在于，所述方法还包括：接收上行二层报文；确定所述上行二层报文发生MAC地址迁移；查找到所述上行二层报文的源MAC地址匹配所述主机地址映射表项；将收到所述上行二层报文的二层接口设置为所述冗余组的最高优先级的二层接口；将所述主机地址映射表项的所述不可信端口标识修改为可信端口标识。6.一种报文转发装置，其特征在于，所述装置包括：设置模块，用于将连接同一个二层环网网络的多个二层接口设置为冗余组；将所述冗余组的正常工作的二层接口设置为选中状态；通过所述冗余组的其中一个选中状态的二层接口学习主机地址映射表项时，将所述主机地址映射表项的出接口设置为所述冗余组并设置可信端口标识；地址映射表项模块，用于学习所述主机地址映射表项，将学习到所述主机地址映射表项的选中状态的二层接口更新为所述冗余组的最高优先级；接收模块，用于接收待转发的下行三层报文；三层路由模块，用于基于所述下行三层报文的目的IP地址匹配所述主机地址映射表项，基于所述主机地址表项将所述下行三层报文封装为下行二层报文；选择所述冗余组中最高优先级的二层接口为出端口；发送模块，用于通过所述出端口发送所述下行二层报文。7.根据权利要求6所述的装置，其特征在于，所述设置模块，还用于确定所述冗余组的最高优先级的二层接口为不工作状态；确定所述冗余组还有其他选中状态的二层接口；将所述可信端口标识修改为不可信端口标识；所述三层路由模块，还用于基于收到的下行三层报文的目的IP地址匹配到带有不可信端口标识的所述主机地址映射表项，将所述下行三层报文封装为下行二层报文，选择所述冗余组的另一二层接口为所述出端口。8.根据权利要求7所述的装置，其特征在于，所述三层路由模块，用于生成请求所述主机地址映射表项的IP地址的硬件地址请求报文；所述发送模块，通过所述出端口发送所硬件地址请求报文；所述接收模块，用于接收硬件地址响应报文；所述地址映射表项模块，用于将收到所述硬件地址响应报文的端口设置为所述冗余组的最高优先级的二层接口；所述设置模块，用于将所述不可信端口标识修改为所述可信端口标识。9.根据权利要求7所述的装置，其特征在于，所述接收模块，还用于接收硬件地址通知报文或请求网关MAC地址的硬件地址请求报文；所述地址映射表项模块，还用于将接收所述主机硬件地址通知报文的二层接口修改为所述冗余组的最高优先级的二层接口或将收到所述硬件地址请求报文的二层接口设置为所述冗余组的最高优先级的二层接口；所述设置模块，将所述硬件地址表项的所述不可信端口标识修改为所述可信端口标识。10.根据权利要求6所述的装置，其特征在于，所述接收模块，还用于接收上行二层报文；二层交换模块，确定所述上行二层报文发生MAC地址迁移，通知所述地址映射表项模块；所述地址映射表项，还用于模块查找到所述上行二层报文的源MAC地址匹配所述主机地址映射表项；将收到所述上行二层报文的二层接口设置为所述冗余组的最高优先级的二层接口；所述设置模块，还用于将所述主机地址映射表项的所述不可信端口标识修改为可信端口标识。
说明书desc
技术领域本申请涉及通信技术，特别涉及一种报文转发方法及装置。背景技术网关设备存储了大量主机地址映射表项，例如，IPv4网络的ARP表项，IPv6网络的ND表项。网关连接主机的二层网络拓扑变化或者网关连接主机的二层网络变化时，网关需要删除主机地址映射表项。即使网关在二层网络内还可以通过其他二层接口连接到主机，但是这些主机地址映射表项都会被删除，需要重新在其他二层接口学习这些主机地址映射表项，以使下行三层流量转发到正确的二层接口。但是，一些切换性能要求高的二层环网场景有快速切换的要求，当网关的学习的主机地址映射表项的二层接口故障时，无法将下行三层流量能快速切换到能够到达主机的二层接口。发明内容本申请的目的在于提供一种报文转发方法及装置，将环网中网关设备的正常工作的二层接口构成可以快速切换流量的冗余组。为实现上述目的，本申请提供了一种报文转发方法，该方法包括：将连接同一个二层环网网络的多个二层接口设置为冗余组；将冗余组的正常工作的二层接口设置为选中状态；通过冗余组的其中一个选中状态的二层接口学习主机地址映射表项时，将主机地址映射表项的出接口设置为冗余组并设置可信端口标识；将学习到主机地址映射表项的选中状态的二层接口更新为冗余组的最高优先级；当收到的下行三层报文的目的IP地址匹配主机地址映射表项，基于主机地址表项将下行三层报文封装为下行二层报文，通过冗余组中最高优先级的二层接口发送。为实现上述目的，本申请还提供了一种报文转发装置，该装置包括：设置模块，用于将连接同一个二层环网网络的多个二层接口设置为冗余组；将冗余组的正常工作的二层接口设置为选中状态；通过冗余组的其中一个选中状态的二层接口学习主机地址映射表项时，将主机地址映射表项的出接口设置为冗余组并设置可信端口标识；地址映射表项模块，用于学习主机地址映射表项，将学习到主机地址映射表项的选中状态的二层接口更新为冗余组的最高优先级；接收模块，用于接收待转发的下行三层报文；三层路由模块，用于基于下行三层报文的目的IP地址匹配主机地址映射表项，基于主机地址表项将下行三层报文封装为下行二层报文；选择冗余组中最高优先级的二层接口为出端口；发送模块，用于通过出端口发送下行二层报文。本申请的有益效果在于，将环网中网关设备的正常工作的二层接口构成可以快速切换流量的冗余组，但通过学习到主机地址映射表项的二层接口优先可靠转发下行三层报文。附图说明图1为本申请提供的报文转发方法实施例的流程图；图2A-2B为本申请提供的网关设备通过冗余组快速切换流量的示意图；图3为本申请提供的报文转发装置实施例的示意图。具体实施方式将以多个附图所示的多个例子进行详细说明。在以下详细描述中，多个具体细节用于提供对本申请的全面理解。实例中没有详细地描述已知的方法、步骤、组件以及电路，以免使这些例子的难于理解。使用的术语中，术语“包括”表示包括但不限于；术语“含有”表示包括但不限于；术语“以上”、“以内”以及“以下”包含本数；术语“大于”、“小于”表示不包含本数。术语“基于”表示至少基于其中一部分。图1是本申请提供的报文转发方法实施例的流程图，该方法实施例包括：步骤101，将连接同一个二层环网网络的多个二层接口设置为冗余组；步骤102，将冗余组的正常工作的二层接口设置为选中状态；步骤103，通过冗余组的其中一个选中状态的二层接口学习主机地址映射表项时，将主机地址映射表项的出接口设置为冗余组并设置可信端口标识；步骤104，将学习到主机地址映射表项的选中状态的二层接口更新为冗余组的最高优先级；步骤105，当收到的下行三层报文的目的IP地址匹配主机地址映射表项，基于主机地址表项将下行三层报文封装为下行二层报文，通过冗余组中最高优先级的二层接口发送。本申请的有益效果在于，将环网中网关设备的正常工作的二层接口构成可以快速切换流量的冗余组，但通过学习到主机地址映射表项的二层接口优先可靠转发下行三层报文。图2A-2B为本申请提供的网关设备通过冗余组快速切换流量的示意图。网关设备A与交换设备B-C位于二层环网中。网关设备A将二层环网网络的二层接口a1-a2设置为冗余组。二层接口a1-a2正常工作，网关设备A将二层接口a1-a2设置为选中状态。二层环网里，交换设备B的二层接口b2被阻塞，以免发生广播风暴，交换设备C、D的两个二层接口c1、c2、d1、d2都放开。网关设备A收到需要发往终端的下行三层报文时，譬如来自环网的其他交换设备接入的不同VLAN的终端的需要三层转发的二层报文，或者来自外网的三层报文。网关设备A未查到该三层报文的目的IP地址的对应的MAC地址时，需要先发送ARPRequest报文。在VLAN内，网关设备广播ARP Request报文到交换设备B-C，交换设备B-C根据收到ARP Request报文的二层接口学习网关MAC地址的MAC地址表项，然后在各自同VLAN的二层接口上广播。终端收到交换设备B广播的ARP Request报文，学习ARP表项，然后发送ARPResponse报文。交换设备B通过二层接口b2收到ARP Response报文，学习终端的MAC地址表项，然后基于之前学习的网关MAC地址的MAC地址表项，通过二层接口b1发送ARPResponse报文。网关设备A通过二层接口a2收到ARP Response报文，学习ARP表项，将ARP表项的出接口设置为冗余组并设置可信端口标识；将学习到ARP表项的选中状态的二层接口a2更新为冗余组的最高优先级的二层接口。网关设备A根据学习的ARP表项，将下行三层报文封装为二层报文，通过冗余组中最高优先级的二层接口a2发送。交换设备B通过二层接口b1收到二层报文后，根据已学习的终端的MAC地址表项，通过连接终端的二层接口发送二层报文。如图2B所示，当网关设备A的二层接口a2故障时，二层环网重新计算拓扑，交换设备的二层接口b2放开。网关设备A确定冗余组的最高优先级的二层接口a2为不工作状态；确定冗余组还有其他选中状态的二层接口a1；将ARP表项的可信端口标识修改为不可信端口标识。网关设备A基于缓存下行三层报文的目的IP地址匹配带有不可信端口标识的ARP表项时，基于ARP表项将下行三层报文封装为下行二层报文，选择冗余组的其他二层接口a1作为当前最高优先级的二层接口，发送下行二层报文。交换设备D通过二层接口d1收到下行二层报文，根据源MAC地址进行网关MAC地址表项学习，由于未学习过终端MAC地址的MAC地址表项，将其作为未知单播报文在VLAN内广播，通过二层接口d2发往交换设备C。同样,交换设备通过二层接口c2收到下行二层报文，根据源MAC地址进行网关MAC地址表项学习，由于未学习过终端MAC地址的MAC地址表项，将其作为未知单播报文在VLAN内广播，通过二层接口c1发往交换设备B。交换设备B通过b2收到下行二层报文，刷新已学习网关MAC的MAC地址表项的出端口，根据已学习的终端MAC地址表项，通过连接终端的二层接口发送下行二层报文。由此可见，当网关设备ARP/ND出口存在多个备份时，不需要等待流量或ARP协议报文到达后触发重建，二层出口的切换减少了表项重建的时间。图2A、2B实施例中，网关设备的正常工作的二层接口构成可以快速切换流量的冗余组，但通过学习到主机地址映射表项的二层接口优先可靠转发下行三层报文。网关设备的冗余组的端口故障，将下行三层流量能快速切换到能够到达终端的二层接口。除此之外，网关设备在终端的ARP表项设置了不可信标识时，需要进行ARP表项的有效性检查。譬如，网关设备A可以向ARP表项的IP地址发送ARP请求报文，硬件地址请求报文；网关设备A从二层接口a1收到ARP响应报文时，将二层接口a1设置为冗余组的最高优先级的二层接口；将ARP表项的不可信端口标识修改为可信端口标识。或者，终端设备从接入的交换设备B迁移到交换设备C上，发送免费ARP报文以更新其他设备学习到的终端的ARP表项。网关设备A从二层接口a1收到免费ARP报文时，将二层接口a1设置为冗余组的最高优先级的二层接口；将ARP表项的不可信端口标识修改为可信端口标识。或者终端的ARP表项老化，重新发送请求网关MAC地址的ARP请求报文时，终端发送请求网关MAC地址的ARP请求报文。网关设备A通过二层接口a1收到ARP请求报文，将其设置为冗余组的最高优先级的二层接口；将ARP表项的不可信端口标识修改为可信端口标识。或者，当终端向网关设备A发送承载了需要三层转发的IP报文的上行二层报文时，交换机B、C、D基于重新学习的网关MAC地址表项，将上行二层报文沿交换机B-＞C-＞D的路径到达网关设备A。网关设备A通过二层接口a1收到上行二层报文，根据二层报文的源MAC地址查找到的终端MAC地址表项的出端口为二层接口a2，发生MAC地址迁移。网关设备A基于上行二层报文中作为源MAC地址的MAC地址查找到匹配的ARP表项；将收到上行二层报文的二层接口a1设置为冗余组的最高优先级的二层接口；将主机地址映射表项的不可信端口标识修改为可信端口标识。通过上述几种方式，在快速切换流量的前提下，对设置了不可性端口标识的ARP表项进行探测，确保下行三层的出端口的正确性，另一方面避免大量ARP探测产生过多协议报文，影响网络和设备性能。本申请还可以应用于IPv6网络，通过ND协议，通过冗余组学习到ND表项的二层接口优先可靠转发下行三层报文，并通过ND协议报文和上行二层报文的MAC地址迁移对带有不可信端口标识ND表项进行探测，确保下行三层报文的出端口正确性。本申请不再赘述。图3为本申请提供的报文转发装置的实施例的示意图，该装置40至少包括：网络接口，交换芯片，CPU以及存储器。交换芯片至少包括接收模块、地址映射表项模块、发送模块、设置模块、二层交换模块、三层路由模块。设置模块，用于将连接同一个二层环网网络的多个二层接口设置为冗余组；将冗余组的正常工作的二层接口设置为选中状态；通过冗余组的其中一个选中状态的二层接口学习主机地址映射表项时，将主机地址映射表项的出接口设置为冗余组并设置可信端口标识；地址映射表项模块，用于学习主机地址映射表项，将学习到主机地址映射表项的选中状态的二层接口更新为冗余组的最高优先级；接收模块，用于接收待转发的下行三层报文；三层路由模块，用于基于下行三层报文的目的IP地址匹配主机地址映射表项，基于主机地址表项将下行三层报文封装为下行二层报文；选择冗余组中最高优先级的二层接口为出端口；发送模块，用于通过出端口发送下行二层报文。设置模块，还用于确定冗余组的最高优先级的二层接口为不工作状态；确定冗余组还有其他选中状态的二层接口；将可信端口标识修改为不可信端口标识；三层路由模块，还用于基于收到的下行三层报文的目的IP地址匹配到带有不可信端口标识的主机地址映射表项，将下行三层报文封装为下行二层报文，选择冗余组的另一二层接口为出端口。三层路由模块，用于生成请求主机地址映射表项的IP地址的硬件地址请求报文；发送模块，通过出端口发送所硬件地址请求报文；接收模块，用于接收硬件地址响应报文；地址映射表项模块，用于将收到硬件地址响应报文的端口设置为冗余组的最高优先级的二层接口；设置模块，用于将不可信端口标识修改为可信端口标识。接收模块，还用于接收硬件地址通知报文或请求网关MAC地址的硬件地址请求报文；地址映射表项模块，还用于将接收主机硬件地址通知报文的二层接口修改为冗余组的最高优先级的二层接口或将收到硬件地址请求报文的端口设置为冗余组的最高优先级的二层接口；设置模块，将硬件地址表项的不可信端口标识修改为可信端口标识。接收模块，还用于接收上行二层报文；二层交换模块，确定上行二层报文发生MAC地址迁移，通知地址映射表项模块；地址映射表项，还用于模块查找到上行二层报文的源MAC地址匹配主机地址映射表项；将收到上行二层报文的端口设置为冗余组的最高优先级的二层接口；设置模块，还用于将主机地址映射表项的不可信端口标识修改为可信端口标识。以上所述仅为本申请的较佳实施例而已，并不用以限制本申请，凡在本申请的精神和原则之内，所做的任何修改、等同替换、改进等，均应包含在本申请保护的范围之内。
