标题title
一种触摸按键检测电路及其检测方法
摘要abst
本发明公开了一种触摸按键检测电路及其检测方法，包括电容Cx、ADC单元、逻辑控制单元、至少一个触摸按键及至少第一开关电路、第二开关电路，第一开关电路、第二开关电路分别连接第一IO口和第二IO口，第一开关电路、第二开关电路均包括第一开关、第二开关、第三开关，第一开关的第一端、第二开关的第一端、第三开关的第一端均连接IO口，第一开关的第二端连接电源，第二开关的第二端接地，第三开关的第二端连接ADC单元输入端，逻辑控制单元连接第一开关电路、第二开关电路及ADC单元，ADC单元输出端输出检测值。本发明电路结构简单，成本低，灵敏度高，抗干扰能力强。
权利要求书clms
1.一种触摸按键检测电路，其特征在于，包括电容Cx、ADC单元、逻辑控制单元、至少一个触摸按键及至少第一开关电路、第二开关电路，第一开关电路、第二开关电路分别连接第一IO口和第二IO口，第一开关电路、第二开关电路均包括第一开关、第二开关、第三开关，第一开关的第一端、第二开关的第一端、第三开关的第一端均连接IO口，第一开关的第二端连接电源，第二开关的第二端接地，第三开关的第二端连接ADC单元输入端，第一IO口连接电容Cx一端，电容Cx另一端接地，第二IO口连接触摸按键；逻辑控制单元连接第一开关电路、第二开关电路及ADC单元，ADC单元输出端输出检测值。2.根据权利要求1所述的触摸按键检测电路，其特征在于，设第一IO口处的固有寄生电容为Cp1，所述电容Cx≥2*Cp1。3.根据权利要求1或2所述的触摸按键检测电路，其特征在于，所述触摸按键有N个，N≥2，还包括第三开关电路，……，第N+1开关电路。4.根据权利要求3所述的触摸按键检测电路，其特征在于，还包括运算放大器和开关阵列，所述运算放大器的第一输入端连接第一开关电路、第二开关电路……第N+1开关电路中的第三开关的第二端，运算放大器的第二输入端连接输出端，输出端连接开关阵列中所有开关的第一端，开关阵列中各开关的第二端分别连接第一IO口、第二IO口，……，第N+1 IO口，所述逻辑控制单元连接开关阵列，用于控制开关阵列。5.根据权利要求1或2所述的触摸按键检测电路，其特征在于，第一开关电路和第二开关电路采用MCU自带的通用IO单元。6.根据权利要求1或2所述的触摸按键检测电路，其特征在于，所述ADC单元采用MCU中自带的通用ADC单元。7.根据权利要求4所述的触摸按键检测电路，其特征在于，所述运算放大器采用MCU中自带的通用运算放大器。8.一种使用如权利要求1-7任一所述的触摸按键检测电路的触摸按键检测方法，其特征在于，包括以下步骤：基准值获取步骤：在触摸按键未被按下时，执行充电迁移采样操作，得到的量化输出值作为该触摸按键未被按下时的基准值，用同样的方法获取所有触摸按键未被按下时的基准值；检测步骤：不断执行充电迁移采样操作对各触摸按键进行扫描，若在检测某个待测触摸按键时，量化输出值大于该触摸按键的基准值，说明该触摸按键被按下；所述充电迁移采样操作包括以下步骤：步骤一：闭合所有开关电路中的第二开关，断开所有开关电路中的第一开关、第三开关；步骤二：断开所有开关电路中的第二开关，闭合待测触摸按键所连接的开关电路中的第一开关；步骤三：断开待测触摸按键所连接的开关电路中的第一开关，闭合第一开关电路中的第三开关与待测触摸按键所连接的开关电路中的第三开关；步骤四：循环执行步骤二和步骤三，循环次数为A，A为预设的充电迁移次数；步骤五：待电荷平衡后，断开除第一开关电路外其他开关电路的第三开关，闭合第一开关电路的第三开关，启动ADC单元进行采样，得到量化输出值。9.根据权利要求8所述的触摸按键检测方法，其特征在于，当触摸按键的个数至少为两个时，所述充电迁移采样操作的步骤二还包括：断开开关阵列中连接第一IO口的开关、连接待测触摸按键的开关，闭合开关阵列中其余开关，闭合待测触摸按键所连接的开关电路中的第三开关。
说明书desc
技术领域本发明涉及模拟集成电路设计领域，具体涉及一种触摸按键检测电路及其检测方法。背景技术触摸按键检测通常利用人体手指检测按键产生的额外寄生电容来判断是否按下按键。现有技术常用的触摸按键检测方法有电荷迁移检测或者电荷泵充放电ADC采样方法，他们各有利弊，电荷迁移检测有较高的抗干扰能力，需要复杂的开关阵列以及高性能比较器与高精度定时器模块，这增加了成本费用。电荷泵充放电ADC采样方法虽然硬件只需要电荷泵充电电路与ADC检测电路，但是其抗干扰能力较弱，需要复杂的软件算法进行抗干扰处理，这额外的增加了开发的难度。有的现有技术，虽然不使用高精度定时器模块，采用电容电荷转移的方法进行检测，但是由于其寄生电容较小，不同触摸按键之间的互电容无法忽略，触摸按键是否被按下对于总电容的改变量较小，使得检测灵敏度较差，抗干扰能力差，若想进一步地提升抗干扰能力只能通过复杂的软件算法在数字域进行处理，占用了MCU的资源。发明内容发明目的：为了解决现有技术中提高触摸按键检测电路抗干扰能力需要增加硬件成本或者增加软件开发难度的问题，本发明提供一种触摸按键检测电路及其检测方法。技术方案：一种触摸按键检测电路，包括电容Cx、ADC单元、逻辑控制单元、至少一个触摸按键及至少第一IO单元、第二IO单元，第一IO单元的IO口连接电容Cx一端，电容Cx另一端接地；第二IO单元的IO口连接触摸按键；第一IO单元、第二IO单元均包括第一开关、第二开关、第三开关，第一开关的第一端、第二开关的第一端、第三开关的第一端均连接IO口，第一开关的第二端连接电源，第二开关的第二端接地，第三开关的第二端连接ADC单元输入端，逻辑控制单元连接IO单元及ADC单元，ADC单元输出端输出检测值。进一步地，设触摸按键所连接的IO单元的固有寄生电容为Cp1，所述电容Cx≥2*Cp1。进一步地，所述触摸按键有N个，N≥2，还包括第三IO单元……第N+1 IO单元。进一步地，还包括运算放大器和开关阵列，所述运算放大器的第一输入端连接第一IO单元、第二IO单元……第N+1 IO单元中的第三开关的第二端，运算放大器的第二输入端连接输出端，输出端连接开关阵列中所有开关的第一端，开关阵列中各开关的第二端分别连接第一IO单元、第二IO单元……第N+1 IO单元的IO口，所述逻辑控制单元连接开关阵列，用于控制开关阵列。进一步地，所述ADC单元采用MCU中自带的通用ADC单元，第一IO单元、第二IO单元采用MCU中自带的通用IO单元。进一步地，所述运算放大器采用MCU中自带的通用运算放大器。一种使用上述的触摸按键检测电路的触摸按键检测方法，包括以下步骤：基准值获取步骤：在触摸按键未被按下时，执行充电迁移采样操作，得到的量化输出值作为该触摸按键未被按下时的基准值，用同样的方法获取所有触摸按键未被按下时的基准值；检测步骤：不断执行充电迁移采样操作对各触摸按键进行扫描，若在检测某个待测触摸按键时，量化输出值大于该触摸按键的基准值，说明该触摸按键被按下；所述充电迁移采样操作包括以下步骤：步骤一：闭合所有IO单元中的第二开关，断开所有IO单元中的第一开关、第三开关；步骤二：断开所有IO单元中的第二开关，闭合待测触摸按键所连接的IO单元中的第一开关；步骤三：断开待测触摸按键所连接的IO单元中的第一开关，闭合第一IO单元中的第三开关与待测触摸按键所连接的IO单元中的第三开关；步骤四：循环执行步骤二和步骤三，循环次数为A，A为预设的充电迁移次数；步骤五：待电荷平衡后，断开除第一IO单元外其他IO单元的第三开关，闭合第一IO单元的第三开关，启动ADC单元进行采样，得到量化输出值。进一步地，当触摸按键的个数至少为两个时，所述充电迁移采样操作的步骤二还包括：断开开关阵列中连接第一IO单元的IO口的开关、连接待测触摸按键的开关，闭合开关阵列中其余开关，闭合待测触摸按键所连接的IO单元中的第三开关。相比较现有技术，本发明提供的一种触摸按键检测电路及其检测方法，存在以下有益效果：可以复用通用MCU自带的通用IO功能、通用ADC功能、通用运放OPA功能，这些都是MCU自带的，无需额外增加，用简单的逻辑控制形成低成本高性能的触摸按键检测电路；增加了一个电容Cx，相比较寄生电容，电容Cx选择较大的电容，并采用对触摸按键多次充电及对电容Cx多次电荷迁移的方式，将对触摸按键上电压的检测转化为对较大电容上电压的检测，最终对电容Cx进行ADC采样，以提高检测电路的抗干扰能力；通过固定充电及电荷迁移次数，将检测值与基准值进行比较，判断触摸按键是否被按下，而不是根据充电到固定电压值所需要的时长来判断，省去了高性能比较器与高精度定时器模块，减少这部分硬件成本费用；利用电压跟随器原理减少了多个触摸按键之间互电容对检测结果的影响，不管触摸按键有多少个，均不会受到互电容的影响，进一步提高检测的灵敏度，进一步提升检测电路的抗干扰能力。附图说明图1为单个触摸按键的触摸按键检测电路的结构示意图；图2为多个触摸按键的触摸按键检测电路的结构示意图；图3为增加运放及开关阵列的触摸按键检测电路的结构示意图；图4为触摸按键检测方法中充电迁移采样操作中步骤一的过程示意图；图5为触摸按键检测方法中充电迁移采样操作中步骤二的过程示意图；图6为触摸按键检测方法中充电迁移采样操作中步骤三的过程示意图；图7为触摸按键检测方法中充电迁移采样操作中步骤五的过程示意图；图8为节点V1的电压示意图；图9为节点VT的电压示意图。实施方式下面结合附图和具体实施例对本发明做进一步解释说明。一种触摸按键检测电路，如图1所示，包括电容Cx、ADC单元、逻辑控制单元、至少一个触摸按键及至少第一开关电路、第二开关电路，第一开关电路、第二开关电路分别连接第一IO口、第二IO口，第一开关电路、第二开关电路均包括第一开关SWP、第二开关SWN、第三开关SWQ，第一开关SWP的第一端、第二开关SWN的第一端、第三开关SWQ的第一端均连接IO口，第一开关SWP的第二端连接电源VDD，第二开关SWN的第二端接地GND，第三开关SWQ的第二端连接ADC单元输入端，逻辑控制单元连接第一开关电路、第二开关电路及ADC单元，用于控制开关电路中的各开关及ADC单元。ADC单元输出端输出检测值。其中，电容Cx和各触摸按键的位置不做限制，只要各自连接一个IO口即可，但是在后续控制各开关时需要相对应。设触摸按键所连接的IO单元的固有寄生电容为Cpk，所述电容Cx≥2*Cpk。电容Cx的电容值越大，抗干扰能力越好，最好远大于寄生电容Cpk，一般取Cx=100*Cpk。因电容较大不便于集成在MCU中，所以一般为外接电容，但是理论上也是可以集成在MCU内部的。图1中虚线所述的电容即为寄生电容。所述触摸按键也可以有多个，比如2个、3个等。如图2为n个触摸按键的检测电路的结构示意图，则还应该包括第三开关电路……第n+1 开关电路，即开关电路的个数比触摸按键的个数多一个。IO口处的固有寄生电容为Cpk，各触摸按键、电容Cx之间的互电容Cxy，图中用虚线画出了寄生电容Cpk和互电容Cxy。当触摸按键有N时，为了减少不同触摸按键之间互电容的影响，还可以增加运算放大器OTA和开关阵列SWMx。如图3所示，所述运算放大器的第一输入端连接第一开关电路、第二开关电路……第N+1 开关电路中的第三开关的第二端，运算放大器的第二输入端连接输出端，输出端连接开关阵列中所有开关的第一端，开关阵列中各开关的第二端分别连接第一IO口、第二IO口……第N+1 IO口，所述逻辑控制单元连接开关阵列，用于控制开关阵列。利用运算放大器与开关阵列形成的电压跟随功能，减小按键走线寄生电容，即减小不同按键之间的互电容，可以加大按键未被按下与按下的区别，提高按键的灵敏度。所述ADC单元可以采用MCU中自带的通用ADC单元。第一开关电路、第二IO开关电路……第N+1 开关电路可以采用MCU中自带的通用IO单元，通用IO单元中有开关电路这种电路结构，所以可以直接拿来复用，也可以是单独的开关电路。所述运算放大器采用MCU中自带的通用运算放大器。因此，无需额外增加硬件成本，相比较现有技术需要使用高精度定时器而言，还降低了硬件成本。一种使用上述触摸按键检测电路的触摸按键检测方法，包括以下步骤：基准值获取步骤：在触摸按键未被按下时，执行充电迁移采样操作，得到的量化输出值作为该触摸按键未被按下时的基准值，用同样的方法获取所有触摸按键未被按下时的基准值；检测步骤：不断执行充电迁移采样操作对各触摸按键进行扫描，若在检测某个待测触摸按键时，量化输出值大于该触摸按键的基准值，说明该触摸按键被按下。所述充电迁移采样操作包括以下步骤：步骤一：如图4，闭合所有开关电路中的第二开关SWN，断开所有开关电路中的第一开关SWP、第三开关SWQ。此步骤的目的是充电前对所有电容放电。步骤二：如图5，断开所有开关电路中的第二开关SWN，闭合待测触摸按键所连接的开关电路中的第一开关SWPk，对待测触摸按键的寄生电容进行充电至VDD，例如图5中待测触摸按键为按键1，则闭合的是SWP2；当触摸按键的个数至少为两个时，为了进一步提升检测的灵敏度，检测电路中还可以包含运算放大器和开关阵列，相应的，本步骤还包括对开关阵列的操作：断开开关阵列中连接第一IO口的开关SWM1、连接待测触摸按键的开关SWMk，闭合开关阵列中其余开关，闭合待测触摸按键所连接的开关电路中的第三开关SWQk。此步骤的目的是使其他触摸按键寄生电容上的电压跟随待测触摸按键上的电压，从而起到消除不同触摸按键之间的互电容对检测结果的影响。步骤三：如图6，断开待测触摸按键所连接的开关电路中的第一开关SWM1，闭合第一开关电路中的第三开关SWQ1与待测触摸按键所连接的开关电路中的第三开关SWQk。该步骤将待测触摸按键寄生电容上的电荷迁移到电容Cx上。步骤四：循环执行步骤二和步骤三，循环次数为A次，A为预设的充电迁移次数。若当前是在获取基准值的情况，也可以通过预设一个电压值，使得电容Cx充电达到预设电压停止继续循环，记录下循环次数，作为后续检测过程中充电迁移的次数。步骤五：待电荷平衡后，如图7，断开除第一开关电路外其他开关电路的第三开关SWQ，闭合第一开关电路的第三开关SWQ1，启动ADC单元进行采样，得到量化输出值。本实施例中，因电容Cx的电容值是大于触摸按键上的寄生电容的，通过不断循环执行步骤二和步骤三，将按键寄生电容上的电荷多次搬移到电容Cx上，ADC单元对电容Cx电压进行采样量化处理，相比直接对寄生电容进行采样，获得的电压值更大，抗干扰能力更强。先在没有按下触摸按键的情况下测得ADC量化值作为基准值，此时只有触摸按键寄生电容参与电荷多次搬移到电容Cx。如果触摸按键被按下，触摸按键寄生电容与人体寄生电容将同时参与电荷多次搬移到电容Cx的过程，经过固定次数搬移后，利用通用ADC对电容Cx电压进行采样量化处理，得到按下按键的ADC量化值，与基准值作比较，在经过相同次数的电荷迁移之后，有触摸的电压值会更高，以此来判断触摸按键是否被按下。为了验证本实施例的有益效果，利用如下仿真实验进行说明。以将触摸按键1作为待测触摸按键为例，如图8所示，节点V1经过A次充电与迁移后电压的变化示意图。如图9所示，节点VT经过A次充电与迁移后电压的变化示意图，ADC1表示触摸按键未被按下的ADC量化值，ADC2表示触摸按键被按下的ADC量化值，ADC3表示触摸按键被按下，且使用运算放大器减小焊盘之间互电容的ADC量化值,结果证明使用运算放大器减小焊盘之间互电容的方法可以进一步提升按键的灵敏度，为优选方案。
