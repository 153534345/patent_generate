标题title
一种毫米波雷达数据采集卡及其数据采集控制方法
摘要abst
本发明公开了一种毫米波雷达数据采集卡及其数据采集控制方法。该数据采集卡包括包括网口数据接收模块、网口数据异步缓存FIFO模块、第一协议转换模块、第一MIGip模块、第一DDR缓存模块7、数据控制模块、USB发送fifo模块、USB发送模块、LVDS协议数据接收模块、LVDS协议数据异步缓存FIFO模块、第二协议转换模块、第二MIGip模块和第二DDR缓存模块。本发明灵活运用FPGA内部数据AXI协议、并行数据处理方式、iddr原语模块，实时将LVDS和网口的数据，重组通过usb传输至上位机，极大的降低了数据采集的时延，加之自定义串行状态机设计，使得在资源消耗上，也满足实际需求。
权利要求书clms
1.一种毫米波雷达数据采集卡，其特征在于，包括：网口数据接收模块，用以接收毫米波雷达射频芯片的点迹/航迹数据输出模块输出的网口数据，同时对接收的网口数据进行计数，当计数值达到设定的数据总量A时，代表网口数据已全部接收完成，并触发一个网口数据接收完成信号eth_flag；LVDS协议数据接收模块，用以接收毫米波雷达射频芯片的ADC数据输出模块输出的LVDS协议数据，同时也对采集数据进行计数，当计数值达到设定的数据总量B时，代表LVDS协议数据已全部接收完成，并触发一个LVDS协议数据接收完成信号LVDS_flag；网口数据异步缓存FIFO模块和LVDS协议数据异步缓存FIFO模块，分别与所述网口数据接收模块和LVDS协议数据接收模块连接，分别用以实现不同时域的数据同步处理；第一协议转换模块和第二协议转换模块，分别与所述网口数据异步缓存FIFO模块和LVDS协议数据异步缓存FIFO模块连接，用以将普通fifo协议数据转换子axi协议数据；第一MIGip模块和第二MIGip模块，分别连接在所述第一协议转换模块与第一DDR缓存模块之间和第二协议转换模块与第二DDR缓存模块之间，以分别实现数据的缓存与读取；数据控制模块，与所述网口数据接收模块、LVDS协议数据接收模块、第一协议转换模块和第二协议转换模块分别连接，用以对所述网口数据接收模块、LVDS协议数据接收模块、第一协议转换模块和第二协议转换模块的状态机进行统一初始化，以使所述状态机正式运行时，外部接口都已初始化成功；并通过采集网口数据接收模块和LVDS协议数据接收模块分别输出的数据接收完成信号eth_flag和LVDS_flag，决定何时从第一DDR缓存模块和第二DDR缓存模块读取网口数据和LVDS协议数据，同时对两个数据进行重组；USB发送fifo模块，与所述数据控制模块连接，用以将数据控制模块重组后的数据与USB时钟进行同步；USB发送模块，与所述USB发送fifo模块连接，用以将时钟同步后的数据发送至上位机。2.根据权利要求1所述的一种毫米波雷达数据采集卡，其特征在于，所述LVDS协议数据包括三组LVDS信号，分别为LVDS协议数据信号、LVDS帧同步时钟信号和LVDS时钟信号，在LVDS帧同步时钟信号上升沿到来时，LVDS协议数据接收模块的状态机进入数据采集状态，以进行数据采集并计数。3.根据权利要求1所述的毫米波雷达数据采集卡，其特征在于，所述网口数据接收模块、LVDS协议数据接收模块、网口数据异步缓存FIFO模块、LVDS协议数据异步缓存FIFO模块、第一协议转换模块、第二协议转换模块、第一MIGip模块、第二MIGip模块、数据控制模块、USB发送fifo模块和USB发送模块均集成在一FPGA芯片内。4.根据权利要求1所述的毫米波雷达数据采集卡，其特征在于，所述网口数据接收模块基于RGMII接口接收数据。5.根据权利要求1所述的毫米波雷达数据采集卡，其特征在于，所述USB发送模块通过USB3.0接口将数据发送至上位机。6.根据权利要求1所述的毫米波雷达数据采集卡，其特征在于，还包括GPIO模块，所述GPIO模块包括uart串口、IIC接口、CAN接口和通用GPIO接口。7.一种如权利要求1所述的毫米波雷达数据采集卡的数据采集控制方法，其特征在于，包括以下步骤：步骤1：系统上电后，数据控制模块的状态机、网口数据接收模块的状态机和LVDS协议数据接收模块的状态机均进入复位状态，其中，所述数据控制模块的状态机在复位状态下，启动复位延时计数器，计数满复位计数设定值时，数据控制模块的状态机进入到IDLE状态，将系统准备信号置1后，数据控制模块的状态机进入等待状态，等待网口数据接收完成信号eth_flag和LVDS协议数据接收完成信号LVDS_flag；步骤2：网口数据接收模块的状态机和LVDS协议数据接收模块的状态机进入复位状态后，等待数据控制模块的状态机下发的系统准备信号RDY，并在收到系统准备信号RDY后进入空闲状态，等待外部网口数据和LVDS协议数据进来；步骤3：当外部网口数据进来，网口数据接收模块的状态机开始对网口UDP数据进行解析，当网口数据的帧起始位判断正确后，开始采集网口数据，并对该网口数据进行计数，当计数值达到设定的数据总量A时，触发网口数据接收完成信号eth_flag，并传输至数据控制模块的状态机，网口数据接收模块的状态机进入数据采集完成状态，等待USB发送完成信号，进入下一次采集；步骤4：当LVDS协议数据进来，首先判断LVDS_frame_clk的上升沿到来，当LVDS协议数据接收模块的状态机识别到LVDS_frame_clk的上升沿来临后，进入数据采集状态，并开始对采集的LVDS协议数据进行计数，当计数值达到设定的数据总量B时，触发LVDS_flag标志位，并传输至数据控制模块的状态机，LVDS协议数据接收模块的状态机进入数据采集完成状态，等待usb发送完成信号，进入下一次采集；步骤5：数据控制模块的状态机在等待状态下接收到两个从状态机传输来的网口数据完成信号和LVDS协议数据完成信号后，数据控制模块的状态机进入读取DDR状态，并开始计数，计数满设定值后，数据控制模块的状态机进入usb发送状态，开始读取两片DDR芯片内部数据，同时启动开始读取计数器，并对所述网口数据和LVDS协议数据进行重组，当计数器满读数设定值时，表明第一DDR缓存模块和第二DDR缓存模块的内部数据均已读取完成，在USB发送结束后，数据控制模块的状态机进入到USB数据传输完成状态，并触发USB_tx_done信号给LVDS协议数据接收模块的状态机和网口数据接收模块的状态机，使得LVDS协议数据接收模块的状态机和网口数据接收模块的状态机进行下一次数据采集。
说明书desc
技术领域本发明涉及毫米波雷达数据采集技术领域，具体涉及一种毫米波雷达数据采集卡及其数据采集控制方法。背景技术毫米波雷达是汽车辅助驾驶的重要组成部分，并逐渐向小型化、轻量化的趋势发展，目前各大主机厂对现有的毫米波雷达进行算法设计与验证时，由于毫米波雷达的射频芯片的接口不统一，导致给主机厂只能去购买原雷达芯片厂家的自有的雷达数据采集卡，针对性对雷达芯片进行数据采集；其一是原厂家的数据采集卡的价格较贵，二是原厂家的数据采集卡不会对外开放接口，只能使用固有端口，导致其功能单一，无法进行应用的扩展。但是购买原雷达厂家的数据采集卡，有以下缺点：1、原雷达厂家数据采集卡价格较贵，且采购渠道单一，主机厂容易被雷达厂家卡脖子；2、原雷达厂家数据采集卡不对外开放别的接口，只能使用固有端口，功能单一且无法进行应用扩展。发明内容本发明的目的是针对现有技术存在的不足，提供一种毫米波雷达数据采集卡及其数据采集控制方法。为实现上述目的，在第一方面，本发明提供了一种毫米波雷达数据采集卡，包括：网口数据接收模块，用以接收毫米波雷达射频芯片的点迹/航迹数据输出模块输出的网口数据，同时对接收的网口数据进行计数，当计数值达到设定的数据总量A时，代表网口数据已全部接收完成，并触发一个网口数据接收完成信号eth_flag；LVDS协议数据接收模块，用以接收毫米波雷达射频芯片的ADC数据输出模块输出的LVDS协议数据，同时也对采集数据进行计数，当计数值达到设定的数据总量B时，代表LVDS协议数据已全部接收完成，并触发一个LVDS协议数据接收完成信号LVDS_flag；网口数据异步缓存FIFO模块和LVDS协议数据异步缓存FIFO模块，分别与所述网口数据接收模块和LVDS协议数据接收模块连接，分别用以实现不同时域的数据同步处理；第一协议转换模块和第二协议转换模块，分别与所述网口数据异步缓存FIFO模块和LVDS协议数据异步缓存FIFO模块连接，用以将普通fifo协议数据转换子axi协议数据；第一MIGip模块和第二MIGip模块，分别连接在所述第一协议转换模块与第一DDR缓存模块之间和第二协议转换模块与第二DDR缓存模块之间，以分别实现数据的缓存与读取；数据控制模块，与所述网口数据接收模块、LVDS协议数据接收模块、第一协议转换模块和第二协议转换模块分别连接，用以对所述网口数据接收模块、LVDS协议数据接收模块、第一协议转换模块和第二协议转换模块的状态机进行统一初始化，以使所述状态机正式运行时，外部接口都已初始化成功；并通过采集网口数据接收模块和LVDS协议数据接收模块分别输出的数据接收完成信号eth_flag和LVDS_flag，决定何时从第一DDR缓存模块和第二DDR缓存模块读取网口数据和LVDS协议数据，同时对两个数据进行重组；USB发送fifo模块，与所述数据控制模块连接，用以将数据控制模块重组后的数据与USB时钟进行同步；USB发送模块，与所述USB发送fifo模块连接，用以将时钟同步后的数据发送至上位机。进一步的，所述LVDS协议数据包括三组LVDS信号，分别为LVDS协议数据信号、LVDS帧同步时钟信号和LVDS时钟信号，在LVDS帧同步时钟信号上升沿到来时，LVDS协议数据接收模块的状态机进入数据采集状态，以进行数据采集并计数。进一步的，所述网口数据接收模块、LVDS协议数据接收模块、网口数据异步缓存FIFO模块、LVDS协议数据异步缓存FIFO模块、第一协议转换模块、第二协议转换模块、第一MIGip模块、第二MIGip模块、数据控制模块、USB发送fifo模块和USB发送模块均集成在一FPGA芯片内。进一步的，所述网口数据接收模块基于RGMII接口接收数据。进一步的，所述USB发送模块通过USB3.0接口将数据发送至上位机。进一步的，还包括GPIO模块，所述GPIO模块包括uart串口、IIC接口、CAN接口和通用GPIO接口。在第二方面，本发明提供了一种上述的毫米波雷达数据采集卡的数据采集控制方法，包括以下步骤：步骤1：系统上电后，数据控制模块的状态机、网口数据接收模块的状态机和LVDS协议数据接收模块的状态机均进入复位状态，其中，所述数据控制模块的状态机在复位状态下，启动复位延时计数器，计数满复位计数设定值时，数据控制模块的状态机进入到IDLE状态，将系统准备信号置1后，数据控制模块的状态机进入等待状态，等待网口数据接收完成信号eth_flag和LVDS协议数据接收完成信号LVDS_flag；步骤2：网口数据接收模块的状态机和LVDS协议数据接收模块的状态机进入复位状态后，等待数据控制模块的状态机下发的系统准备信号RDY，并在收到系统准备信号RDY后进入空闲状态，等待外部网口数据和LVDS协议数据进来；步骤3：当外部网口数据进来，网口数据接收模块的状态机开始对网口UDP数据进行解析，当网口数据的帧起始位判断正确后，开始采集网口数据，并对该网口数据进行计数，当计数值达到设定的数据总量A时，触发网口数据接收完成信号eth_flag，并传输至数据控制模块的状态机，网口数据接收模块的状态机进入数据采集完成状态，等待USB发送完成信号，进入下一次采集；步骤4：当LVDS协议数据进来，首先判断LVDS_frame_clk的上升沿到来，当LVDS协议数据接收模块的状态机识别到LVDS_frame_clk的上升沿来临后，进入数据采集状态，并开始对采集的LVDS协议数据进行计数，当计数值达到设定的数据总量B时，触发LVDS_flag标志位，并传输至数据控制模块的状态机，LVDS协议数据接收模块的状态机进入数据采集完成状态，等待usb发送完成信号，进入下一次采集；步骤5：数据控制模块的状态机在等待状态下接收到两个从状态机传输来的网口数据完成信号和LVDS协议数据完成信号后，数据控制模块的状态机进入读取DDR状态，并开始计数，计数满设定值后，数据控制模块的状态机进入usb发送状态，开始读取两片DDR芯片内部数据，同时启动开始读取计数器，并对所述网口数据和LVDS协议数据进行重组，当计数器满读数设定值时，表明第一DDR缓存模块和第二DDR缓存模块的内部数据均已读取完成，在USB发送结束后，数据控制模块的状态机进入到USB数据传输完成状态，并触发USB_tx_done信号给LVDS协议数据接收模块的状态机和网口数据接收模块的状态机，使得LVDS协议数据接收模块的状态机和网口数据接收模块的状态机进行下一次数据采集。有益效果：本发明通过基于FPGA的设计，灵活运用FPGA内部数据AXI协议、并行数据处理方式、iddr原语模块，实时将LVDS和网口的数据，重组通过usb传输至上位机，极大的降低了数据采集的时延，加之自定义串行状态机设计，使得在资源消耗上，也满足实际需求；预留多个GPIO接口，介于FPGA设计方便性，可以将这些预留接口配置成串口、can、iic等，以此满足更多的需求，使得本数据采集系统在未来扩展需求时会更加灵活，这在4D雷达设计验证，故障查找中，更适应未来车载雷达设计的需求。附图说明图1是本发明实施例的一种毫米波雷达数据采集卡的结构示意图；图2是LVDS协议数据的示意图；图3是一种毫米波雷达数据采集卡的数据采集控制方法的流程图。具体实施方式下面结合附图和具体实施例，进一步阐明本发明，本实施例在以本发明技术方案为前提下进行实施，应理解这些实施例仅用于说明本发明而不用于限制本发明的范围。如图1所示，本发明实施例提供了一种毫米波雷达数据采集卡，包括网口数据接收模块3、网口数据异步缓存FIFO模块4、第一协议转换模块5、第一MIGip模块6、第一DDR缓存模块7、数据控制模块8、USB发送fifo模块9、USB发送模块10、LVDS协议数据接收模块11、LVDS协议数据异步缓存FIFO模块12、第二协议转换模块13、第二MIGip模块14和第二DDR缓存模块15。其中，网口数据接收模块3、LVDS协议数据接收模块11、网口数据异步缓存FIFO模块4、LVDS协议数据异步缓存FIFO模块12、第一协议转换模块5、第二协议转换模块13、第一MIGip模块6、第二MIGip模块14、数据控制模块8、USB发送fifo模块9和USB发送模块10均优选集成在一FPGA芯片内。其中，网口数据接收模块3用以接收点迹/航迹数据输出模块1输出的网口数据，同时对接收的网口数据进行计数，当计数值达到设定的数据总量AA时，代表网口数据已全部接收完成，并触发一个网口数据接收完成信号eth_flag。上述点迹/航迹数据输出模块1是雷达射频芯片内部模块，可以通过软件配置进行数据格式的配置，作为数据采集卡的网口数据输入源，网口数据采用UDP协议。网口数据接收模块优选基于RGMII接口接收数据，该接口兼容MII接口，即千兆速率数据和百兆速率数据都可接接收。LVDS协议数据接收模块11用以接收ADC数据输出模块2输出的LVDS协议数据，同时也对采集数据进行计数，当计数值达到设定的数据总量B时，代表LVDS协议数据已全部接收完成，并触发一个LVDS协议数据接收完成信号LVDS_flag。上述ADC数据输出模块2同样是雷达射频芯片内部模块，可以通过软件配置进行数据格式的配置，作为数据采集卡系统的LVDS协议数据输入源。LVDS协议数据接收模块11基于TI AWR2944芯片设计，LVDS协议信号参阅图2所示，有三组LVDS信号，分别是LVDS_TXP/M、LVDS_FRCLKP/M、LVDS_CLKP/M。标准LVDS协议是两组信号线，分别是时钟和数据线，而在AWR2944中有三组信号线，多了一组LVDS_FRCLKP/M信号线，所以LVDS协议数据接收模块11通过参数进行选择，0代表标准的LVDS协议，1代表基于AWR2944的LVDS协议，在未来还可根据不同雷达芯片型号进行更多设计选择，使得本发明可以做到仅仅修改某一个参数就可以适配各种不同的雷达芯片。另外，只有在LVDS_FRCLKP/M有效的前提下数据才是有效的。具体的，本发明采用iddr方式对进来的LVDS协议数据信号先进行不间断解析。同时采用状态机的设计方式对解析后的数据进行采集，状态机在系统上电后，进入空闲状态，在LVDS_FRCLKP/M上升沿到来时，状态机进入数据采集状态进行采集数据，简而言之LVDS协议数据从系统上电后一直在解析，但只有在状态机进入数据采集状态下，才开始采集解析后的数据，并传输至LVDS协议数据异步缓存FIFO模块12，同时也对采集数据进行计数。无论网口数据接收模块3，还是LVDS协议数据接收模块11，其驱动时钟均来自外部接口，与FPGA时钟不同频。所以为了兼容各类接口数据，将网口数据异步缓存FIFO模块4和LVDS协议数据异步缓存FIFO模块12分别与网口数据接收模块3和LVDS协议数据接收模块11连接，以实现不同时域的数据在FPGA内部进行一个同步处理，方便后续模块处理。第一协议转换模块5和第二协议转换模块13分别与网口数据异步缓存FIFO模块4和LVDS协议数据异步缓存FIFO模块12连接，用以将普通fifo协议数据转换子axi协议数据。实现第一协议转换模块5与第一MIGip模块6以及第二协议转换模块13与第二MIGip模块14的通信功能。第一MIGip模块6连接在第一协议转换模块5与第一DDR缓存模块7之间，第二MIGip模块14连接在第二协议转换模块13与第二DDR缓存模块15之间，以分别实现数据的缓存与读取。第一DDR缓存模块7和第二DDR缓存模块15主要实现高速数据缓存功能。数据控制模块8与网口数据接收模块3、LVDS协议数据接收模块11、第一协议转换模块5和第二协议转换模块13分别连接，用以对网口数据接收模块3、LVDS协议数据接收模块11、第一协议转换模块5和第二协议转换模块13的状态机进行统一初始化，以使状态机正式运行时，外部接口都已初始化成功。并通过采集网口数据接收模块3和LVDS协议数据接收模块11分别输出的数据接收完成信号eth_flag和LVDS_flag，决定何时从第一DDR缓存模块7和第二DDR缓存模块15读取网口数据和LVDS协议数据，同时对两个数据进行重组。USB发送fifo模块9与数据控制模块8连接，用以将数据控制模块8重组后的数据与USB时钟进行同步。由于在网口数据异步缓存FIFO模块4和LVDS协议数据异步缓存FIFO模块12处理后，网口数据和LVDS协议数据均与FPGA内部时钟进行了同步，但是USB接口时钟与FPGA本身时钟并不一致，因而需要USB发送fifo模块9将重组后的FPGA内部数据与USB时钟进行同步。USB发送模块10与USB发送fifo模块9连接，用以将时钟同步后的数据发送至上位机，实现与上位机通信功能。USB发送模块10优选通过USB3.0接口将数据发送至上位机。本发明实施例还包括GPIO模块16，GPIO模块16包括uart串口、IIC接口、CAN接口和通用GPIO接口。从而满足未来可能出现的需求，便于产品的迭代。结合图1和图3，基于以上实施例，本领域技术人员可以轻易理解，本发明还提供了一种上述毫米波雷达数据采集卡的数据采集控制方法，其中，A设定为1000个，B设定为10000个，该方法包括以下步骤：步骤1：系统上电后，数据控制模块8的状态机、网口数据接收模块3的状态机和LVDS协议数据接收模块11的状态机均进入复位状态，其中，数据控制模块8的状态机在复位状态下，启动复位延时计数器，计数满1000时，数据控制模块8的状态机进入到IDLE状态，将系统准备信号置1后，数据控制模块8的状态机进入等待状态，等待网口数据接收完成信号eth_flag和LVDS协议数据接收完成信号LVDS_flag。步骤2：网口数据接收模块3的状态机和LVDS协议数据接收模块11的状态机进入复位状态后，等待数据控制模块8的状态机下发的系统准备信号RDY，并在收到系统准备信号RDY后进入空闲状态，等待外部网口数据和LVDS协议数据进来。步骤3：当外部网口数据进来，网口数据接收模块3的状态机开始对网口UDP数据进行解析，当网口数据的帧起始位判断正确后，开始采集网口数据，并对该网口数据进行计数，当计数值达到1000时，触发网口数据接收完成信号eth_flag，并传输至数据控制模块8的状态机，网口数据接收模块3的状态机进入数据采集完成状态，等待USB发送完成信号，进入下一次采集。步骤4：当LVDS协议数据进来，首先判断LVDS_frame_clk的上升沿到来，当LVDS协议数据接收模块11的状态机识别到LVDS_frame_clk的上升沿来临后，进入数据采集状态，并开始对采集的LVDS协议数据进行计数，当计数值达到10000时，触发LVDS_flag标志位，并传输至数据控制模块8的状态机，LVDS协议数据接收模块11的状态机进入数据采集完成状态，等待usb发送完成信号，进入下一次采集。步骤5：数据控制模块8的状态机在等待状态下接收到两个从状态机传输来的网口数据完成信号eth_flag和LVDS协议数据完成信号LVDS_flag后，数据控制模块8的状态机进入读取DDR状态，并开始计数，计数满10后，数据控制模块8的状态机进入usb发送状态，开始读取两片DDR芯片内部数据，同时启动开始读取计数器，并对网口数据和LVDS协议数据进行重组，当计数器满10000时，表明第一DDR缓存模块和第二DDR缓存模块的内部数据均已读取完成，在USB发送结束后，数据控制模块8的状态机进入到USB数据传输完成状态，并触发USB_tx_done信号给LVDS协议数据接收模块11的状态机和网口数据接收模块3的状态机，使得LVDS协议数据接收模块11的状态机和网口数据接收模块3的状态机进行下一次数据采集。在数据重组时，比如网口数据是16位，LVDS协议数据16位，两者重组成32位数据，其中，高16位为网口数据，低16位为LVDS数据，需要主要的是网口数据是小于LVDS协议数据，重组后，前1000个数据是网口数据+LVDS协议数据，1000以后是16个0+LVDS协议数据。综上所述，本发明基于并行处理器对雷达采集系统进行了集成优化设计，采用主从状态机协调控制，实现各模块之间通过标准握手协议完成数据链路的构建和传递。以外部LVDS接口作为ADC外部数据输入接口，千兆以太网作为点迹和航迹输入接口，USB3.0作为数据输出接口，再通过AXI协议配合MIG IP将ADC数据和点迹航迹数据分别缓存至DDR0和DDR1中，最后将其同步通过USB3.0输出至上位机中做算法的处理和验证。本发明采用成本较低的硬件架构、主从逻辑的软件架构，同时预留多接口，具有集成度高，精度高，采集方便以及快速适配等诸多优点。以上所述仅是本发明的优选实施方式，应当指出，对于本技术领域的普通技术人员来说，其它未具体描述的部分，属于现有技术或公知常识。在不脱离本发明原理的前提下，还可以做出若干改进和润饰，这些改进和润饰也应视为本发明的保护范围。
