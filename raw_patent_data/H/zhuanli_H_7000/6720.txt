标题title
一种TSN实时以太网网关数据传输方法
摘要abst
本发明提供了一种TSN实时以太网网关数据传输方法，应用于TSN网关装置，TSN网关装置包括有FPGA芯片、总线收发器、以太网收发器以及电源模块；所述FPGA芯片通过总线收发器与总线终端设备通信连接，以及通过以太网收发器与以太网设备通信连接；所述FPGA芯片内部设置有网口通信模块、数据接收组包模块、数据解析模块、收发模块、数据存储模块、时间同步模块、数据发送组包模块、数据发送模块；数据传输方法包括总线终端设备至以太网终端设备的传输方法以及以太网终端设备至总线终端设备的传输方法。本发明解决了现有一对一专用网关存在的通信冲突问题以及现有网关存在的较长时间工作下时间不同步问题。
权利要求书clms
1.一种TSN实时以太网网关数据传输方法，应用于TSN网关装置，其特征在于，所述TSN网关装置包括有FPGA芯片、与FPGA芯片通信连接的总线收发器、以太网收发器以及电源模块；所述FPGA芯片通过总线收发器与总线终端设备通信连接，以及通过以太网收发器与以太网设备通信连接；所述FPGA芯片内部设置有与以太网收发器通信连接的网口通信模块、与网口通信模块通信连接的数据接收组包模块、与数据接收组包模块通信连接的数据解析模块、与总线收发器通信连接的收发模块、与数据解析模块及收发模块通信连接的数据存储模块、分别与数据解析模块和数据接收组包模块通信连接的时间同步模块、分别与时间同步模块、数据存储模块通信连接的数据发送组包模块、分别与数据发送组包模块以及网口通信模块通信连接的数据发送模块；所述数据传输方法包括总线终端设备至以太网终端设备的传输方法以及以太网终端设备至总线终端设备的传输方法，其中总线终端设备至以太网终端设备的传输方法包括以下步骤：所述总线收发器接收总线数据，并将其发送至数据存储模块，所述总线数据包括RS422总线数据及LVDS总线数据；数据存储模块接收总线数据，判断总线数据的数据帧头、数据长度是否符合预设标准，在总线数据的数据帧头、数据长度符合预设标准的情况下，判断数据存储模块中的FIFO缓存器是否为未写满状态，在数据存储模块中的FIFO缓存器为未写满状态情况下，则将总线数据进行存储，在数据存储模块中的FIFO缓存器为已写满状态情况下，数据存储模块则将总线数据丢弃；数据组包发送模块获取总线数据，然后在每帧总线数据中增加以太网格式数据后组成以太网帧后发送给数据发送模块，数据发送模块通过网口通信模块以及以太网收发器发送至以太网终端设备；所述以太网格式数据包括源MAC地址、目的MAC地址、帧表示信息、VLAN标志、时间戳以及数据和校验信息；以太网终端设备至总线设备的传输方法，包括以下步骤：以太网收发器接收来自于以太网终端设备的TSN以太网数据，并将其发送给数据接收组包模块；数据接收组包模块在以太网协议每帧数据中增加目标端口信息以及时间戳信息后发送给数据解析模块；数据解析模块获取TSN以太网数据的数据类型，在数据类型是时间同步帧的情况下，则获取时间同步帧内的时间戳以及帧类型信息并将其发送给时间同步模块，时间同步模块根据时间信息，并以此修复本地时间；在数据类型是数据配置帧的情况下，则获取配置信息；在数据类型为其他数据帧的情况下，则将其他数据发送至存储模块所述其他数据帧包括有RS422总线数据或LVDS总线数据；数据存储模块接收TSN以太网数据，判断数据存储模块中的FIFO缓存器是否为未写满状态，在数据存储模块中的FIFO缓存器为未写满状态情况下，则将TSN以太网数据进行存储；在数据存储模块中的FIFO缓存器为已写满状态情况下，数据存储模块则将总线数据丢弃；根据数据帧头信息，数据存储模块将TSN以太网数据通过收发模块、总线收发器发送至总线终端设备。2.如权利要求1所述的一种TSN实时以太网网关数据传输方法，其特征在于：所述总线收发器包括有RS422总线收发器以及LVDS总线收发器，其中，RS422总线收发器包括与RS422收发模块通信连接的RS422芯片、与RS422芯片通信连接的隔离电路以及RS422接口，LVDS总线收发器包括与LVDS收发模块通信连接的LVDS芯片、与LVDS芯片通信连接的隔离电路以及LVDS接口；以太网收发器包括有与网口通信模块通信连接的以太网物理芯片、与以太网物理芯片通信连接的变压器以及与变压器通信连接的千兆网口。3.如权利要求2所述的一种TSN实时以太网网关数据传输方法，其特征在于：时间同步模块根据时间信息，并以此修复本地时间，包括：时间同步模块进入集成状态并等待接收来自于其内集成单元的集成帧，若在预设时间内未接收到集成帧或以太网终端设备数目少于预设个数，则进入冷启动过程；冷启动过程结束后，时间同步模块进入假定的时间同步状态，并再次等待接收集成单元的集成帧，在预设时间内接收到集成帧且以太网终端设备数目大于或等于预设个数的情况下，跳转到同步状态；在预设时间内未接收到集成帧或同步设备数目少于预设个数的情况下，由假定的时间同步状态跳转至非同步状态，并开启同步重启动和超时计时；若时间同步模块在超时计时过程中，接收到集成单元的集成帧且同步设备数目大于或等于预设个数，则确认网络中存在全局同步时钟，将跳转到同步状态，否则进入冷启动过程；时间同步模块进入同步状态后，根据接收到的集成帧计算时钟修正值，并以此修复本地时间。4.如权利要求3所述的一种TSN实时以太网网关数据传输方法，其特征在于：所述的冷启动过程，包括以下步骤：时间同步模块向以太网终端设备发送冷启动帧，以太网终端设备接收冷启动帧并对其进行固化和压缩处理后，响应并将冷启动帧发送给时间同步模块，时间同步模块对接收的冷启动帧进行固化和压缩处理；时间同步模块等待接收集成单元的集成帧，在预设时间内未接收到集成帧或同步设备数目少于预设个数的情况下，发送冷启动确认帧至所有的以太网终端设备；以太网终端设备接收冷启动确认帧并对其进行固化和压缩处理后，响应并将冷启动确认帧发送给时间同步模块，时间同步模块对接收的冷启动确认帧进行固化和压缩处理，冷启动过程结束。5.如权利要求1或4所述的一种TSN实时以太网网关数据传输方法，其特征在于，判断数据存储模块中的FIFO缓存器是否为未写满状态，具体包括：数据存储模块计算FIFO缓存器的缓存深度与已写入FIFO缓存器内数据个数的差值；计算待存储数据的数据长度与FIFO缓存器的写入速度的商值再与FIFO缓存器内发送数据的速度之间的乘积；将所述差值与乘积相加，得到FIFO缓存动态值；所述待存储数据为TSN以太网数据、RS422总线数据或LVDS总线数据；数据存储模块判断接收到的每一帧待存储数据的数据长度是否小于FIFO缓存动态值，在待存储数据的数据长度小于FIFO缓存动态值的情况下，将该帧待存储数据进行存储，在待存储数据的数据长度大于FIFO缓存动态值的情况下，则对待存储数据进行丢弃。
说明书desc
技术领域本发明涉及以太网网络技术领域，具体涉及一种TSN实时以太网网关数据传输方法。背景技术随着现场总线在工业网络通信中应用越来越广，多个总线与以太网之间具有异构性，互操作难度较大。为了实现异构总线和以太网之间的信息交换，一般采用专用网关进行一对一的协议转换，采用这种方式，由于任意两种协议转换之间均需要通过专用网关来连接完成，因此这种使用方式灵活性很低，而且当多个总线设备同时访问现场总线或以太网时，容易出现通信冲突问题；因此，如何对多个异构总线设备与以太网设备实现互联，是需要解决的技术问题。同时，现有技术中的实时以太网网关，当多个以太网数据端口的数据发送至总线端口或多个总线数据端口的数据发送至以太网数据端口时，且端口传输速率较大，例如端口传输速率大于1000Mbps时，会出现帧头或者帧尾数据丢失、超长帧以及多帧合并等大量数据误码的情况，因此，在高速率传输过程中，多端口高速流量汇聚造成的数据大量误码，是需要解决的技术问题。公开号为CN109510747A的专利公开了一种基于SRIO的一对多总线网关转换方法，该装置采用VPX架构，将SRIO分别与CAN、以太网、ARINC、USB总线设备数据协议的转换，用户可以选择某一种总线格式数据转换成其它某几种总线格式数据，通过采用一对多的转换策略，降低了采用多个一对一网关设备带来的额外时间成本和价格成本，同时集成存储记录功能提高了系统的故障排查能力；但是，该方案为时间确定性较低的通信链路，不能维持较长时间同步以及在网络拓扑改变和通信过程存在不确定因素的情况下，不能长时间维持时间同步并正常工作。发明内容针对现有技术的不足，本发明提供了一种基于TSN的网关数据传送方法，能够对多种总线数据与TSN以太网数据之间进行数据交换，实现了多个异构总线设备与以太网设备互联，解决了现有一对一专用网关存在的通信冲突问题以及现有一对多异构网关存在的较长时间工作下时间不同步以及在网络拓扑改变和通信过程存在不确定因素的情况下不能正常工作的问题。本发明的技术方案如下：一种TSN网关数据传输方法，应用于TSN网关装置，所述TSN网关装置包括有FPGA芯片、与FPGA芯片通信连接的总线收发器、以太网收发器以及电源模块；所述FPGA芯片通过总线收发器与总线终端设备通信连接，以及通过以太网收发器与以太网设备通信连接；所述FPGA芯片内部设置有与以太网收发器通信连接的网口通信模块、与网口通信模块通信连接的数据接收组包模块、与数据接收组包模块通信连接的数据解析模块、与总线收发器通信连接的收发模块、与数据解析模块及收发模块通信连接的数据存储模块、分别与数据解析模块和数据接收组包模块通信连接的时间同步模块、分别与时间同步模块、数据存储模块通信连接的数据发送组包模块、分别与数据发送组包模块以及网口通信模块通信连接的数据发送模块；所述数据传输方法包括总线终端设备至以太网设备的传输方法以及以太网设备至总线终端设备的传输方法，其中总线终端设备至以太网设备的传输方法包括以下步骤：所述总线收发器接收总线数据，并将其发送至数据存储模块，所述总线数据包括RS422总线数据及LVDS总线数据；数据存储模块接收总线数据，判断总线数据的数据帧头、数据长度是否符合预设标准，在总线数据的数据帧头、数据长度符合预设标准的情况下，判断数据存储模块中的FIFO缓存器是否为未写满状态，在数据存储模块中的FIFO缓存器为未写满状态情况下，则将总线数据进行存储，在数据存储模块中的FIFO缓存器为已写满状态情况下，数据存储模块则将总线数据丢弃；数据组包发送模块获取总线数据，然后在每帧总线数据中增加以太网格式数据后组成以太网帧后发送给数据发送模块，数据发送模块通过网口通信模块以及以太网收发器发送至以太网终端设备；所述以太网格式数据包括源MAC地址、目的MAC地址、帧表示信息、VLAN标志、时间戳以及数据和校验信息；以太网设备至总线设备的传输方法，包括以下步骤：以太网收发器接收来自于以太网终端设备的TSN以太网数据，并将其发送给数据接收组包模块；数据接收组包模块在以太网协议每帧数据中增加目标端口信息以及时间戳信息后发送给数据解析模块；数据解析模块获取TSN以太网数据的数据类型，在数据类型是时间同步帧的情况下，则获取时间同步帧内的时间戳以及帧类型信息并将其发送给时间同步模块，时间同步模块根据时间信息，并以此修复本地时间；在数据类型是数据配置帧的情况下，则获取配置信息；在数据类型为其他数据帧的情况下，则将其他数据发送至存储模块所述其他数据帧包括有RS422总线数据或LVDS总线数据；数据存储模块接收TSN以太网数据，判断数据存储模块中的FIFO缓存器是否为未写满状态，在数据存储模块中的FIFO缓存器为未写满状态情况下，则将总线数据进行存储；在数据存储模块中的FIFO缓存器为已写满状态情况下，数据存储模块则将总线数据丢弃；根据数据帧头信息，将TSN以太网数据通过总线收发器发送至总线终端设备。进一步地，所述总线收发器包括有RS422总线收发器以及LVDS总线收发器，其中，RS422总线收发器包括与RS422收发模块通信连接的RS422芯片、与RS422芯片通信连接的隔离电路以及RS422接口，LVDS总线收发器包括与LVDS收发模块通信连接的LVDS芯片、与LVDS芯片通信连接的隔离电路以及LVDS接口；以太网收发器包括有与网口通信模块通信连接的以太网物理芯片、与以太网物理芯片通信连接的变压器以及与变压器通信连接的千兆网口。进一步地，时间同步模块根据时间信息，并以此修复本地时间，包括：时间同步模块进入集成状态并等待接收来自于其内集成单元的集成帧，若在预设时间内未接收到集成帧或以太网终端设备数目少于预设个数，则进入冷启动过程；冷启动过程结束后，时间同步模块进入假定的时间同步状态，并再次等待接收集成单元的集成帧，在预设时间内接收到集成帧且以太网终端设备数目大于或等于预设个数的情况下，跳转到同步状态；在预设时间内未接收到集成帧或同步设备数目少于预设个数的情况下，由假定的时间同步状态跳转至非同步状态，并开启同步重启动和超时计时；若时间同步模块在超时计时过程中，接收到集成单元的集成帧且同步设备数目大于或等于预设个数，则确认网络中存在全局同步时钟，将跳转到同步状态，否则进入冷启动过程；时间同步模块进入同步状态后，根据接收到的集成帧计算时钟修正值，并以此修复本地时间。进一步地，所述的冷启动过程，包括以下步骤：时间同步模块向以太网终端设备发送冷启动帧以太网终端设备接收冷启动帧并对其进行固化和压缩处理后，响应并将冷启动帧发送给时间同步模块，时间同步模块对接收的冷启动帧进行固化和压缩处理；时间同步模块等待接收集成单元的集成帧，在预设时间内未接收到集成帧或同步设备数目少于预设个数的情况下，发送冷启动确认帧至所有的以太网终端设备；以太网终端设备接收冷启动确认帧并对其进行固化和压缩处理后，响应并将冷启动确认帧发送给时间同步模块，时间同步模块对接收的冷启动确认帧进行固化和压缩处理，冷启动过程结束。进一步地，判断数据存储模块中的FIFO缓存器是否为未写满状态，具体包括：数据存储模块计算FIFO缓存器的缓存深度与已写入FIFO缓存器内数据个数的差值；计算待存储数据的数据长度与FIFO缓存器的写入速度的商值再与FIFO缓存器内发送数据的速度之间的乘积；将所述差值与乘积相加，得到FIFO缓存动态值；所述待存储数据为TSN以太网数据、RS422总线数据或LVDS总线数据；数据存储模块判断接收到的每一帧待存储数据的数据长度是否小于FIFO缓存动态值，在待存储数据的数据长度小于FIFO缓存动态值的情况下，将该帧待存储数据进行存储，在待存储数据的数据长度大于FIFO缓存动态值的情况下，则对待存储数据进行丢弃。本发明通过总线收发器以及收发模块接收总线数据，并将其发送至数据存储模块，在总线数据的数据帧头、数据长度符合预设标准以及数据存储模块中的FIFO缓存器为未写满状态下，数据存储模块将总线数据转发至数据组包发送模块，然后数据组包发送模块将总线数据组成以太网帧后通过数据发送模块发送至以太网终端设备，从而实现总线设备至以太网设备的数据传输；同时，本发明还通过以太网收发器、网口通信模块接收以太网终端设备的以太网数据，数据接收组包模块对以太网数据的数据帧中增加时间戳及目标端口信息后发送至数据解析模块，数据解析模块针对以太网数据进行解析，并将数据类型为其他数据帧的以太网数据发送至数据存储模块，在FIFO缓存器为未写满状态下，数据存储模块将总线数据根据以太网数据中携带的目标端口，转发至收发模块，最后通过总线收发器传输至总线终端设备，从而实现了以太网数据从以太网终端设备向总线终端设备的数据传输。本发明的技术效果：1.通过本发明所述的总线终端设备至以太网终端设备的传输方法以及以太网终端设备至总线终端设备的传输方法，能够实现以太网终端设备发出的以太网数据向总线终端设备的传输以及总线终端设备发出的总线数据向以太网终端设备的传输，解决了传统网关进行一对一的协议转换而导致灵活性低的问题，以及多个总线设备同时访问现场总线或以太网时，容易出现通信冲突问题；2.通过本发明所述的本地时间修复方法，能够实现以太网网关与以太网终端设备之间的时间同步，解决了现有技术存在的不能维持较长时间同步以及在网络拓扑改变和通信过程存在不确定因素的情况下，不能长时间维持时间同步并正常工作的问题；3.本发明通过在总线终端设备至以太网设备或以太网设备至总线终端设备的传输过程中，对数据存储模块中的FIFO缓存器的存储状态进行判断，在FIFO缓存器为已写满状态情况下，则将总线数据丢弃，从而解决在高速率传输过程中，多端口高速流量汇聚造成的数据大量误码的问题，误码率低。附图说明图1是本发明实施例所述的TSN网关装置的结构示意图；图2是本发明实施例所述的FPGA芯片的内部结构示意图；图3是本发明实施例一所述的一种总线终端设备至以太网设备的传输方法的流程图；图4是本发明实施例二所述的一种总线终端设备至以太网设备的传输方法的流程图；图5是本发明实施例三所述的一种以太网设备至总线终端设备的传输方法的流程图。具体实施方式本发明实施例提供了一种TSN网关数据传输方法，应用于TSN网关装置，如附图1所示，TSN网关装置包括有FPGA芯片、与FPGA芯片通信连接的总线收发器、以太网收发器以及电源模块；FPGA芯片通过总线收发器与总线终端设备通信连接，以及通过以太网收发器与以太网设备通信连接。总线收发器包括有RS422总线收发器以及LVDS总线收发器，其中，RS422总线收发器是其包括与RS422收发模块通信连接的RS422芯片、与RS422芯片通信连接的隔离电路以及RS422接口，RS422芯片是一款非隔离全双工收发器芯片，数据速率为100Mbps；LVDS总线收发器包括与LVDS收发模块通信连接的LVDS芯片、与LVDS芯片通信连接的隔离电路以及LVDS接口；以太网收发器包括有与网口通信模块通信连接的以太网物理芯片、与以太网物理芯片通信连接的变压器以及与变压器通信连接的千兆网口，其中，以太网物理芯片适配10/100/1000Mbps速率；电源模块为POE方式供电，预留普通12V供电接口，为总线收发器、FPGA芯片以及以太网收发器供电。如附图2所示，FPGA芯片内部设置有与以太网收发器通信连接的网口通信模块、与网口通信模块通信连接的数据接收组包模块、与数据接收组包模块通信连接的数据解析模块、与数据解析模块通信连接的以太网数据存储模块、分别与数据解析模块和数据接收组包模块通信连接的时间同步模块、与以太网数据存储模块通信连接的RS422收发模块及LVDS收发模块、与RS422收发模块通信连接的RS422数据存储模块、与LVDS收发模块通信连接的LVDS数据存储模块、分别与时间同步模块、RS422数据存储模块及LVDS数据存储模块通信连接的数据发送组包模块、分别与数据发送组包模块以及网口通信模块通信连接的数据发送模块；所述以太网数据存储模块、RS422数据存储模块以及LVDS数据存储模块三者构成数据存储模块。本发明实施例中，多总线网关内部各个模块并行运行，数据传输分为两个方向，一为数据从以太网设备到终端设备，二为终端设备到以太网设备；数据传输方法包括总线终端设备至以太网设备的传输方法以及以太网设备至总线终端设备的传输方法，具体地，通过以下三种实施例实施：实施例一如附图3所示，本发明实施例1提供了一种总线终端设备至以太网设备的传输方法，具体包括以下步骤：S101. RS422总线收发器接收来自于RS422总线数据，并通过FPGA芯片中的RS422收发模块传输至RS422数据存储模块；S102. RS422数据存储模块接收RS422总线数据，判断RS422总线数据的数据帧头、数据长度是否符合预设标准，在RS422总线数据的数据帧头、数据长度是否符合预设标准的情况下，然后判断RS422数据存储模块中的FIFO缓存器是否为未写满状态，在判断RS422数据存储模块中的FIFO缓存器为未写满状态情况下，则将RS422总线数据进行存储；RS422数据存储模块判断其内FIFO缓存器为已被写满的情况下，数据存储模块则将RS422总线数据数据丢弃。S103.数据组包发送模块获取RS422总线数据，然后在RS422总线数据中增加源MAC地址、目的MAC地址、帧表示信息、VLAN标志、时间戳以及数据和校验信息等以太网格式数据后组成以太网帧，并通过数据发送模块、网口通信模块发送至以太网终端设备。步骤S102中，RS422数据存储模块判断其内FIFO缓存器是否为未写满状态，具体包括：S10201. RS422数据存储模块计算FIFO缓存器的缓存深度与已写入FIFO缓存器内数据个数的差值；计算待存储的RS422总线数据的数据长度与FIFO缓存器的写入速度的商值再与FIFO缓存器内发送数据的速度之间的乘积；将所述差值与乘积相加，得到FIFO缓存动态值；S10202. RS422数据存储模块判断接收到的每一帧RS422总线数据的数据长度是否小于FIFO缓存动态值，在RS422总线数据的数据长度小于FIFO缓存动态值的情况下，将该帧RS422总线数据进行存储，在RS422总线数据的数据长度大于FIFO缓存动态值的情况下，则对RS422总线数据进行丢弃。实施例二如附图4所示，本发明实施例2提供了一种总线终端设备至以太网设备的传输方法，具体包括以下步骤：S201. LVDS总线收发器接收来自于LVDS总线数据，并通过FPGA芯片中的LVDS收发模块传输至LVDS数据存储模块；S202. LVDS数据存储模块接收LVDS总线数据，判断LVDS总线数据的数据帧头、数据长度是否符合预设标准，在LVDS总线数据的数据帧头、数据长度是否符合预设标准的情况下，然后判断LVDS数据存储模块中的FIFO缓存器是否为未写满状态，在判断LVDS数据存储模块中的FIFO缓存器为未写满状态情况下，则将LVDS总线数据进行存储；LVDS数据存储模块判断其内FIFO缓存器为已被写满的状态，则将LVDS总线数据丢弃。S203.数据组包发送模块获取LVDS总线数据，然后在LVDS总线数据中增加源MAC地址、目的MAC地址、帧表示信息、VLAN标志、时间戳以及数据和校验信息等以太网格式数据后组成以太网帧，并通过数据发送模块、网口通信模块发送至以太网终端设备。上述步骤S202中，LVDS数据存储模块判断其内FIFO缓存器是否为未写满状态，具体包括：S20201. LVDS数据存储模块计算FIFO缓存器的缓存深度与已写入FIFO缓存器内数据个数的差值；计算待存储的LVDS总线数据的数据长度与FIFO缓存器的写入速度的商值再与FIFO缓存器内发送数据的速度之间的乘积；将所述差值与乘积相加，得到FIFO缓存动态值；S20202. LVDS数据存储模块判断接收到的每一帧LVDS总线数据的数据长度是否小于FIFO缓存动态值，在LVDS总线数据的数据长度小于FIFO缓存动态值的情况下，将该帧LVDS总线数据进行存储，在LVDS总线数据的数据长度大于FIFO缓存动态值的情况下，则对LVDS总线数据进行丢弃。通过上述实施例1所述的以太网终端设备至总线终端设备的传输方法以及实施例2所述的总线终端设备至以太网终端设备的传输方法以及，能够实现以太网终端设备发出的以太网数据向总线终端设备的传输以及总线终端设备发出的总线数据向以太网终端设备的传输，解决了传统网关进行一对一的协议转换而导致灵活性低的问题，以及多个总线设备同时访问现场总线或以太网时，容易出现通信冲突问题。实施例三如附图5所示，本发明实施例3提供了一种以太网设备至总线终端设备的传输方法，具体包括以下步骤：S301. 以太网收发器接收TSN以太网数据并通过网口通信模块发送给数据接收组包模块；数据接收组包模块在每帧TSN以太网数据中增加目标端口信息以及时间戳信息后发送给数据解析模块；S302. 数据解析模块获取TSN以太网数据的数据类型，在数据类型是时间同步帧的情况下，则获取时间同步帧内的时间戳以及帧类型信息后将其发送给时间同步模块，时间同步模块根据时间信息，并以此修复本地时间；在数据类型是数据配置帧的情况下，则获取配置信息；在数据类型为其他数据帧的情况下，则将其他数据存储至以太网存储模块中，其他数据帧包括有RS422总线数据或LVDS总线数据；上述步骤中，从以太网设备发送过来的数据分为三种类型，一为时间同步数据，时间同步数据用来完成系统间的时间同步，二为网关配置数据，实现对网关的配置，配置信息包括RS422和LVDS的数据长度，数据帧头，数据传输的优先级，链路号，发送目的MAC地址，以及发送的端口号等信息，三为和终端设备的交互数据，亦即本发明实施例中的“其他数据帧”。S303. 以太网数据存储模块根据交互数据帧的帧头信息，若帧头信息为RS422总线交互数据，则将TSN以太网数据通过RS422总线收发器发送至RS422总线设备；若帧头信息为RS422总线交互数据，则将TSN以太网数据通过LVDS总线收发器发送至LVDS总线设备。上述步骤S302中，时间同步模块根据时间信息，并以此修复本地时间，具体地，本地时间修复的方法包括以下步骤：S30201. 时间同步模块进入集成状态并等待接收来自于集成单元的集成帧，若在预设时间内未接收到集成帧或同步设备数目少于预设个数，则进入冷启动过程；S30202.冷启动过程结束后，时间同步模块进入假定的时间同步状态，并等待接收集成单元的集成帧，在预设时间内接收到集成帧且同步设备数目大于或等于预设个数的情况下，跳转到同步状态；S30203.在预设时间内未接收到集成帧或同步设备数目少于预设个数的情况下，由假定的时间同步状态跳转至非同步状态，并开启同步重启动和超时计时；若时间同步模块在超时计时过程中，接收到集成单元的集成帧且同步设备数目大于或等于预设个数，则确认网络中存在全局同步时钟，将跳转到同步状态，否则进入冷启动过程；S30204. 时间同步模块进入同步状态后，根据接收到的集成帧计算时钟修正值，并以此修复本地时间。上述步骤S30201至S30203中，冷启动过程包括以下步骤：S30205.时间同步模块向外部设备发送冷启动帧，外部设备接收冷启动帧并对其进行固化和压缩处理后，响应并将冷启动帧发送给时间同步模块，时间同步模块对接收的冷启动帧进行固化和压缩处理；S30206.时间同步模块等待接收集成单元的集成帧，在预设时间内未接收到集成帧或同步设备数目少于预设个数的情况下，发送冷启动确认帧至所有的外部设备；外部设备接收冷启动确认帧并对其进行固化和压缩处理后，响应并将冷启动确认帧发送给时间同步模块，时间同步模块对接收的冷启动确认帧进行固化和压缩处理，冷启动过程结束。通过本发明实施例所述的本地时间修复方法，能够实现以太网网关与以太网终端设备之间的时间同步，解决了现有技术存在的不能维持较长时间同步以及在网络拓扑改变和通信过程存在不确定因素的情况下，不能长时间维持时间同步并正常工作的问题。
