标题title
一种HDR视频优化编码方法
摘要abst
本发明公开了一种HDR视频优化编码方法，涉及视频编码技术领域，该方法包括以下步骤：获取编码单元的红、绿、蓝颜色数值，并计算出当前编码单元的灰度差GRE；获取编码单元x方向的梯度值Sx、y方向的梯度值Sy，并计算出当前编码单元的纹理值WL；综合灰度差GRE和纹理值WL，获得编码单元的图像表征系数δ，标记编码单元；对未标记的编码单元进行常规视频编码，获取量化参数QP、源数据量MB、编码后数据量DB；对编码后的视频进行分析，使用灰度转换获取视频像素点的灰度值f，计算出所有像素拉普拉斯梯度值之和D；将量化参数QP、数据量压缩率γ和清晰度D建立关联模型，调整量化参数，平衡视频清晰度和数据量压缩率。
权利要求书clms
1.一种HDR视频优化编码方法，其特征在于，包括以下步骤：获取编码单元的红、绿、蓝三个通道的最大颜色数值和最小颜色数值，并计算出当前编码单元的灰度差GRE，通过比对预先设置的灰度阈值，当灰度差大于灰度阈值时，标记当前编码单元；获取编码单元在x方向的梯度值Sx、y方向的梯度值Sy，并计算出当前编码单元的纹理值WL，通过比对预先设置的纹理阈值，当纹理值WL大于纹理阈值时，标记当前编码单元；综合灰度差GRE和纹理值WL进行分析，获得编码单元的图像表征系数δ，通过比对预先设置的第一阈值，进一步筛选出需要标记的编码单元；对未标记的编码单元进行常规视频编码，获取量化参数QP、源数据量MB、编码后数据量DB；对编码后的视频进行分析，使用灰度转换获取视频像素点的灰度值f，并使用拉普拉斯模板拉普拉斯梯度值，进而计算出所有像素拉普拉斯梯度值之和D，即作为视频的清晰度D；根据源数据量MB、编码后数据量DB计算数据量压缩率γ，将量化参数QP、数据量压缩率γ和清晰度D进行关联分析，建立关联模型，并根据关联模型调整量化参数，对标记的编码单元进行视频编码，平衡视频清晰度和数据量压缩率。2.根据权利要求1所述的一种HDR视频优化编码方法，其特征在于，所述灰度差的具体分析步骤包括：获取当前编码单元的红、绿、蓝三个通道的最大颜色数值Rmax、Gmax、Bmax以及最小颜色数值Rmin、Gmin、Bmin；计算当前编码单元的灰度差GRE，计算公式如下：；其中a1、a2、a3为权重系数，且，/＞，/＞，/＞；预先设置灰度阈值，当灰度差GRE大于灰度阈值时，标记当前编码单元。3.根据权利要求1所述的一种HDR视频优化编码方法，其特征在于，所述纹理值的具体分析步骤如下：获取当前编码单元在x方向的梯度值Sx、y方向的梯度值Sy；通过x方向的梯度值Sx和y方向的梯度值Sy计算当前编码单元的纹理值WL，纹理值WL的计算公式如下：；预先设置纹理阈值，当纹理值大于纹理阈值时，标记当前编码单元。4.根据权利要求3所述的一种HDR视频优化编码方法，其特征在于，所述图像表征系数的具体分析步骤如下：获取当前编码单元的灰度差GRE和纹理值WL，进行无量纲化处理，并计算出编码单元的图像表征系数δ，图像表征系数δ的计算公式如下：；其中α、β为修正系数，且，/＞；预先设置第一阈值，当时，取消当前编码单元的标记；当/＞时，保持当前编码单元的标记。5.根据权利要求3所述的一种HDR视频优化编码方法，其特征在于，所述视频的清晰度D的具体分析过程如下：使用灰度转换算法获取视频图像像素点的灰度值f，其中x为像素点横轴坐标，y为像素点纵轴坐标；使用拉普拉斯模板算子；得到拉普拉斯梯度值，计算公式如下：；计算所有像素拉普拉斯梯度值之和D，计算公式如下：；其中Nx为横轴像素点总数，Ny为纵轴像素点总数。6.根据权利要求5所述的一种HDR视频优化编码方法，其特征在于，量化参数QP、数据量压缩率γ和清晰度D进行关联分析的过程如下：根据源数据量MB和编码后数据量DB，计算分析后获得数据量压缩率γ，计算公式如下：；将数据量压缩率γ和量化参数QP以及D进行关联分析，建立数据量压缩率γ和量化参数QP以及D之间的关联模型，计算公式如下：；根据已建立的关联模型，通过调整量化参数，对标记的编码单元进行视频编码，平衡视频清晰度和数据量压缩率。
说明书desc
技术领域本发明涉及视频编码技术领域，具体为一种HDR视频优化编码方法。背景技术HDR视频是一种具有更高亮度、更宽色域和更高对比度的视频格式，为了使HDR视频在编码和传输过程中保持其质量和特性，需要采用一些编码方法。在申请公布号为CN107197266B的中国发明申请中，公开了一种HDR视频编码方法。它具体包括如下步骤：视频源数据通过常规的码率控制获得量化参数；视频源数据通过电光转换获得当前编码单元在HDR显示设备上的对比敏感度；通过步骤中的量化参数以及步骤中的对比敏感度获得当前编码单元的量化参数，并对视频源数据进行量化。从而可以较准确地反映出人眼在HDR显示设备上观看视频时由亮度对比产生的不同敏感程度；使HDR视频中人眼比较敏感的对比敏感度较大的区域的细节保留地更加完整，提高了细节保留的完整度。在以上发明申请中，通过编码单元的最大亮度和最小亮度，来获得编码单元的对比敏感度，根据对比敏感度来调节各个编码单元的量化参数，使HDR视频中人眼比较敏感的对比敏感度较大的区域的细节保留地更加完整，提高了细节保留的完整度。但是光通过亮度显然不能完全保留视频细节的完成性，还有其他的因素影响着视频的细节以及质量。因此，本发明提供了一种HDR视频优化编码方法。发明内容解决的技术问题针对背景技术提到的不足，本发明提供了一种HDR视频优化编码方法，旨在解决背景技术中记载的技术问题。技术方案为实现以上目的，本发明通过以下技术方案予以实现：一种HDR视频优化编码方法，包括以下步骤：获取编码单元的红、绿、蓝三个通道的最大颜色数值和最小颜色数值，并计算出当前编码单元的灰度差GRE，通过比对预先设置的灰度阈值，当灰度差大于灰度阈值时，标记当前编码单元；获取编码单元在x方向的梯度值Sx、y方向的梯度值Sy，并计算出当前编码单元的纹理值WL，通过比对预先设置的纹理阈值，当纹理值WL大于纹理阈值时，标记当前编码单元；综合灰度差GRE和纹理值WL进行分析，获得编码单元的图像表征系数δ，通过比对预先设置的第一阈值，进一步筛选出需要标记的编码单元；对未标记的编码单元进行常规视频编码，获取量化参数QP、源数据量MB、编码后数据量DB；常规视频编码包括：预处理阶段：图像对齐，对于多帧HDR视频，将它们对齐以减少运动估计误差，对齐通过运动矢量估计和全局运动补偿来实现；色彩空间转换，将原始HDR视频的色彩空间转换为编码器所支持的标准色彩空间，如Rec.709；色域映射，将宽广的HDR色域映射为编码器所支持的色域，以保留尽可能多的颜色信息；帧间编码阶段：运动估计和补偿，利用帧间预测技术根据前一帧或后一帧的信息来预测当前帧的内容，并计算运动矢量和残差；帧间压缩，将预测的运动矢量和残差进行编码和压缩，以减少数据量，并提高编码效率；帧内编码阶段：帧内预测，通过对当前帧的像素值进行分析，预测并编码帧内的像素值，以减少冗余信息；变换编码，对帧内预测的残差进行频域变换，例如离散余弦变换，以更好地表示和压缩视频中的频域信息；量化和熵编码，对变换系数进行量化，并利用熵编码技术对量化后的系数进行编码，以进一步减少数据量；附加数据编码阶段：HDR元数据，对HDR视频的附加数据，如色彩空间信息、亮度范围和色彩深度等元数据进行编码，以确保在解码时能正确解释这些信息；音频编码，对HDR视频的音频进行编码，常用的编码格式包括AAC等。对编码后的视频进行分析，使用灰度转换获取视频像素点的灰度值f，并使用拉普拉斯模板拉普拉斯梯度值，进而计算出所有像素拉普拉斯梯度值之和D，即作为视频的清晰度D；根据源数据量MB、编码后数据量DB计算数据量压缩率γ，将量化参数QP、数据量压缩率γ和清晰度D进行关联分析，建立关联模型，并根据关联模型，调整量化参数，对标记的编码单元进行视频编码，平衡视频清晰度和数据量压缩率。进一步的，所述灰度差的具体分析步骤包括：获取当前编码单元的红、绿、蓝三个通道的最大颜色数值Rmax、Gmax、Bmax以及最小颜色数值Rmin、Gmin、Bmin；计算当前编码单元的灰度差GRE，计算公式如下：；其中a1、a2、a3为权重系数，且，，，；预先设置灰度阈值，当灰度差GRE大于灰度阈值时，标记当前编码单元。进一步的，所述纹理值的具体分析步骤如下：获取当前编码单元在x方向的梯度值Sx、y方向的梯度值Sy；通过x方向的梯度值Sx和y方向的梯度值Sy计算当前编码单元的纹理值WL，纹理值WL的计算公式如下：；预先设置纹理阈值，当纹理值大于纹理阈值时，标记当前编码单元。进一步的，所述图像表征系数的具体分析步骤如下：获取当前编码单元的灰度差GRE和纹理值WL，进行无量纲化处理，并计算出编码单元的图像表征系数δ，图像表征系数δ的计算公式如下：；其中α、β为修正系数，且，；预先设置第一阈值，当时，取消当前编码单元的标记；当时，保持当前编码单元的标记。进一步的，所述视频的清晰度D的具体分析过程如下：使用灰度转换算法获取视频图像像素点的灰度值f，其中x为像素点横轴坐标，y为像素点纵轴坐标；使用拉普拉斯模板算子；得到拉普拉斯梯度值，计算公式如下：；计算所有像素拉普拉斯梯度值之和D，计算公式如下：；其中Nx为横轴像素点总数，Ny为纵轴像素点总数。进一步的，量化参数QP、数据量压缩率γ和清晰度D进行关联分析的过程如下：根据源数据量MB和编码后数据量DB，计算分析后获得数据量压缩率γ，计算公式如下：；将数据量压缩率γ和量化参数QP以及D进行关联分析，建立数据量压缩率γ和量化参数QP以及D之间的关联模型，计算公式如下：；根据已建立的关联模型，通过调整量化参数，对标记的编码单元进行视频编码，平衡视频清晰度和数据量压缩率。有益效果本发明提供了一种HDR视频优化编码方法，具备以下有益效果：1、通过根据源数据量MB和编码后数据量DB，计算分析后获得数据量压缩率γ，将数据量压缩率γ和量化参数QP以及D进行关联分析，建立三者之间的关联模型，通过调整量化参数对已标记的编码单元进行编码，从而有效地提升了视频编码的效率和视频的质量。2、通过对视频进行灰度转换，使用拉普拉斯模板计算每个像素的拉普拉斯梯度值，再计算所有像素拉普拉斯梯度值之和，用来当作视频清晰度的评价标准，更加直观、有效地体现了编码后的视频质量。附图说明图1为本发明HDR视频优化编码方法流程示意图。具体实施方式下面将结合本发明实施例中的附图，对本发明实施例中的技术方案进行清楚、完整地描述，显然，所描述的实施例仅仅是本发明一部分实施例，而不是全部的实施例。基于本发明中的实施例，本领域普通技术人员在没有做出创造性劳动前提下所获得的所有其他实施例，都属于本发明保护的范围。请参阅图1，本发明提供一种HDR视频优化编码方法，包括以下步骤：步骤一：获取编码单元的红、绿、蓝三个通道的最大颜色数值和最小颜色数值，并计算出当前编码单元的灰度差，通过比对预先设置的灰度阈值，当灰度差大于灰度阈值时，标记当前编码单元；步骤101：获取当前编码单元的红、绿、蓝三个通道的最大颜色数值Rmax、Gmax、Bmax以及最小颜色数值Rmin、Gmin、Bmin；步骤102：计算当前编码单元的灰度差GRE，计算公式如下：；其中a1、a2、a3为权重系数，且，，，；步骤103：预先设置灰度阈值，当灰度差GRE大于灰度阈值时，标记当前编码单元。需要说明的是，当红、绿、蓝三个通道的最大颜色值和最小颜色值差值越大，灰度差越大，反之则越小，式中权重因子系数用于均衡各项数据在公式中的比重，从而促进计算结果的准确性。使用时，结合步骤101至步骤103中的内容：通过计算红、绿、蓝三个通道的最大颜色值和最小颜色值之间的差值，来获得当前编码单元的灰度差，根据预先设置的灰度阈值来标记出需要筛选出的编码单元，以便用于后续的分析和处理。步骤二：获取编码单元在x方向的梯度值Sx、y方向的梯度值Sy，并计算出当前编码单元的纹理值，通过比对预先设置的纹理阈值，当纹理值WL大于纹理阈值时，标记当前编码单元；步骤201：获取当前编码单元在x方向的梯度值Sx、y方向的梯度值Sy；步骤202：通过x方向的梯度值Sx和y方向的梯度值Sy计算当前编码单元的纹理值WL，纹理值WL的计算公式如下：；步骤203：预先设置纹理阈值，当纹理值大于纹理阈值时，标记当前编码单元。需要说明的是，当前编码单元在x方向的梯度值Sx和y方向的梯度值Sy的值越大，当前编码单元的纹理值越高，反之则越低，纹理值越高表示当前编码单元图像中的细节越多，而越低则表示当前编码单元图像中的细节越少。结合步骤201至步骤203中的内容：通过计算当前编码单元在x方向的梯度值Sx和y方向的梯度值Sy，获得当前编码单元的纹理值，通过比对预先设置的纹理阈值，标记出需要筛选出来的编码单元，纹理值的高低决定了图像的细节多少，因此需要对细节较多的编码单元进行标记，用于后续的分析和处理。步骤三：综合灰度差GRE和纹理值WL进行分析，获得编码单元的图像表征系数δ，通过比对预先设置的第一阈值，进一步筛选出需要标记的编码单元；包括：步骤301：获取当前编码单元的灰度差GRE和纹理值WL，进行无量纲化处理，并计算出编码单元的图像表征系数δ，图像表征系数δ的计算公式如下：；其中α、β为修正系数，且，；步骤302：预先设置第一阈值，当时，取消当前编码单元的标记；当时，保持当前编码单元的标记。需要说明的是，当灰度差和纹理值越大，图像表征系数越大，图像内容就越丰富，反之当灰度差和纹理值越小，图像表征系数越小，图像内容就越简单。结合步骤201至步骤203中的内容：通过综合编码单元的灰度差和纹理值，进行进一步分析，获得图像的表征系数，通过预先设置第一阈值，来筛选出图像内容丰富的编码单元，通过对不同编码单元的不同处理，提升视频编码的效率，提高视频质量。步骤四：对未标记的编码单元进行常规视频编码，获取量化参数QP、源数据量MB、编码后数据量DB；步骤401：HDR视频预处理，对HDR视频进行预处理操作，包括图像对齐、颜色转换和色域映射等。图像对齐操作针对不同帧之间的运动进行处理，以减少帧间的运动估计误差；颜色转换操作将HDR视频的颜色空间转换成编码器所支持的标准颜色空间；色域映射将HDR视频的宽广色域调整为标准色域，以适应编码器的要求；步骤402：帧内预测编码，采用帧内预测技术对每一帧进行编码。帧内预测通过空间相关性来减少编码视频中的冗余信息，通过像素值之间的差异性来表示视频帧内容，减少传输数据量，并提高编码效率；步骤403：帧间预测编码，利用帧间预测技术对连续帧之间的关联性进行编码。帧间预测根据前一帧或后一帧的信息来预测当前帧的内容，进一步减少冗余信息的传输，有效地提高编码效率，适用于动态变化较小的场景；步骤404：变换编码：对编码后的视频进行变换和压缩。变换编码利用变换算法对视频进行频域处理，如离散余弦变换，以减小视频文件的大小，提高存储和传输效率，变换编码进一步压缩视频数据，并保持良好的视觉质量。需要说明的是，以上是HDR视频编码的基本步骤，还需要进行进一步处理，以提高编码效率和视频质量，编码后的数据可以以各种格式存储或传输，如MP4、HEVC等，解码器将对编码后的数据进行解码和重建，以恢复原始的HDR视频。结合步骤401至步骤404中的内容：通过对视频源数据进行预处理、帧内预测编码、帧间预测编码以及变换编码，获得常规视频编码后的量化参数QP、源数据量MB、编码后数据量DB，用于对标记出的编码单元进行后续的分析和处理。步骤五：对编码后的视频进行分析，使用灰度转换获取视频像素点的灰度值f，并使用拉普拉斯模板拉普拉斯梯度值，进而计算出所有像素拉普拉斯梯度值之和D，即作为视频的清晰度D；步骤501：使用灰度转换算法获取视频图像像素点的灰度值f，其中x为像素点横轴坐标，y为像素点纵轴坐标；步骤502：使用拉普拉斯模板算子；得到拉普拉斯梯度值，计算公式如下：；步骤503：计算所有像素拉普拉斯梯度值之和D，计算公式如下：；其中Nx为横轴像素点总数，Ny为纵轴像素点总数。需要说明的是，所有像素拉普拉斯梯度值之和D即可作为视频清晰度，当拉普拉斯梯度值之和越高，视频清晰度越高，则视频越清晰，反之则越模糊。结合步骤501至步骤503中的内容：通过对视频进行灰度转换，使用拉普拉斯模板计算每个像素的拉普拉斯梯度值，再计算所有像素拉普拉斯梯度值之和，用来当作视频清晰度的评价标准，更加直观、有效地体现了编码后的视频质量。步骤六：根据源数据量MB、编码后数据量DB计算数据量压缩率γ，将量化参数QP、数据量压缩率γ和清晰度D进行关联分析，建立关联模型，并根据关联模型，调整量化参数，对标记的编码单元进行视频编码，平衡视频清晰度和数据量压缩率。步骤601：根据源数据量MB和编码后数据量DB，计算分析后获得数据量压缩率γ，计算公式如下：；步骤602：将数据量压缩率γ和量化参数QP以及D进行关联分析，建立数据量压缩率γ和量化参数QP以及D之间的关联模型，计算公式如下：；步骤603：根据已建立的关联模型，通过调整量化参数，对标记的编码单元进行视频编码，平衡视频清晰度和数据量压缩率。需要说明的是，编码后数据量越高，数据量压缩率就越低，视频质量就越高，则视频越清晰，编码后数据量越低，数据量压缩率就越高，视频质量就越低，则视频越模糊。结合步骤601至步骤603的内容：通过根据源数据量MB和编码后数据量DB，计算分析后获得数据量压缩率γ，进一步将数据量压缩率γ和量化参数QP以及D进行关联分析，建立三者之间的关联模型，通过调整量化参数对已标记的编码单元进行编码，有效地提升了视频编码的效率和视频的质量。上述公式均是去量纲取其数值计算，公式是由采集大量数据进行软件模拟得到最近真实情况的一个公式，公式中的预设参数由本领域的技术人员根据实际情况进行设置。上述实施例，可以全部或部分地通过软件、硬件、固件或其他任意组合来实现。当使用软件实现时，上述实施例可以全部或部分地以计算机程序产品的形式实现。本领域普通技术人员可以意识到，结合本文中所公开的实施例描述的各示例的单元及算法步骤，能够以电子硬件、或者计算机软件和电子硬件的结合来实现。这些功能究竟以硬件还是软件方式来执行，取决于技术方案的特定应用和设计约束条件。所述作为分离部件说明的单元可以是或者也可以不是物理上分开的，作为单元显示的部件可以是或者也可以不是物理单元，即可以位于一个地方，或者也可以分布到多个网络单元上。可以根据实际的需要选择其中的部分或者全部单元来实现本实施例方案的目的。以上所述，仅为本申请的具体实施方式，但本申请的保护范围并不局限于此，任何熟悉本技术领域的技术人员在本申请揭露的技术范围内，可轻易想到变化或替换，都应涵盖在本申请的保护范围之内。
