标题title
一种车载双目相机视差校正方法
摘要abst
本申请公开了一种车载双目相机视差校正方法，包括以下步骤：步骤1、根据预设采样周期，获取双目相机当前采样时刻的采样图像；步骤2、判断当前采样时刻的采样图像中的当前目标距离与初始采样时刻的采样图像中的初始目标距离的相对差值是否大于或等于校正阈值P1；若是，根据当前目标距离、初始目标距离以及对应的视差值，计算双目相机的视差补偿值；若否，重新执行步骤1，获取双目相机的采样图像。本申请能够利用车辆本身的固有结构特征作为视差校正的媒介，在无需返厂或拆卸车载双目相机的情况下，对车载双目相机进行实时视差校正，以保障车辆行驶安全。
权利要求书clms
1.一种车载双目相机视差校正方法，其特征在于，包括以下步骤：步骤1、根据预设采样周期，获取双目相机当前采样时刻的采样图像；步骤2、判断所述当前采样时刻的采样图像中的当前目标距离与初始采样时刻的采样图像中的初始目标距离的相对差值是否大于或等于校正阈值P1；若是，根据所述当前目标距离、所述初始目标距离以及对应的视差值，计算所述双目相机的视差补偿值；若否，重新执行步骤1，获取所述双目相机的采样图像；其中，所述当前目标距离以及所述初始目标距离为所述采样图像中预设目标与所述双目相机之间的距离或者所述采样图像中任两个预设目标之间的距离。2.根据权利要求1所述的车载双目相机视差校正方法，其特征在于，所述步骤1之后，还包括：步骤1.1、对所述采样图像进行目标检测，确定各个预设目标的最小外接矩形框的位置坐标；步骤1.2、连续确定N3帧采样图像中各个预设目标的最小外接矩形框的位置坐标，并计算各个最小外接矩形的位置坐标的均值坐标；步骤1.3、对下一帧采样图像进行目标检测，确定各个预设目标的最小外接矩形框的位置坐标，记作待定位置坐标；步骤1.4、判断所述待定位置坐标与对应的所述均值坐标之间的坐标偏移是否小于或等于偏移阈值N4；若是，执行所述步骤2；若否，重新执行步骤1.3，直至到达下一个预设采样周期。3.根据权利要求2所述的车载双目相机视差校正方法，其特征在于，所述步骤1.2之前，还包括：步骤1.2.1、确定当前帧采样图像中各个预设目标的最小外接矩形框的位置坐标，并与所述初始采样时刻的采样图像中各个预设目标相应的最小外接矩形框的初始位置坐标进行比较，计算位置偏移；步骤1.2.2、当判定所述位置偏移小于位置偏移阈值N1时，将最小外接矩形框的计数加1；步骤1.2.3、连续统计N3帧采样图像中最小外接矩形框的计数值，当所述计数值大于或等于数量阈值N2时，执行上述步骤1.2。4.根据权利要求1或2所述的车载双目相机视差校正方法，其特征在于，所述步骤2中，所述当前目标距离以及所述初始目标距离的计算步骤，包括：步骤2.1.1、对所述采样图像进行目标检测，确定各个预设目标的最小外接矩形框的位置坐标和各个预设目标中心位置图像的像素坐标；步骤2.1.2、将所述各个预设目标的最小外接矩形框的位置坐标映射到对应的视差图像中，得到对应的视差数据并进行滤波处理，对处理后的视差数据进行均值计算，将均值计算结果记作视差值disp；步骤2.1.3、根据所述视差值disp以及坐标变换公式，将所述各个预设目标中心位置图像的像素坐标转换为世界坐标系下的空间坐标；步骤2.1.4、基于所述各个预设目标中心位置图像在世界坐标系下的空间坐标，计算所述当前目标距离以及所述初始目标距离。5.根据权利要求4所述的车载双目相机视差校正方法，其特征在于，所述步骤2.1.2中，对所述视差数据进行滤波处理的过程，包括：步骤2.1.2.1、对映射到所述视差图像中的所述各个预设目标的最小外接矩形框内的视差数据进行排序；步骤2.1.2.2、分别剔除掉排序后的视差数据中占比P0的大端值视差数据和小端值视差数据。6.根据权利要求4所述的车载双目相机视差校正方法，其特征在于，所述步骤2.1.4中，当所述当前目标距离为所述采样图像中预设目标与所述双目相机之间的距离时，所述当前目标距离的计算方法为：将所述双目相机在世界坐标系中的位置记作原点；根据所述各个预设目标中心位置图像在世界坐标系下的空间坐标，计算所述各个预设目标与所述双目相机之间的当前目标距离，对应的计算公式为：式中，Li为第i个预设目标对应的当前目标距离，为第i个预设目标中心位置图像在世界坐标系下的空间坐标，i＝1,2,…,n，n为设定的所述预设目标的数量。7.根据权利要求4所述的车载双目相机视差校正方法，其特征在于，所述步骤2.1.4中，当所述当前目标距离为所述采样图像中任两个预设目标之间的距离时，所述当前目标距离的计算方法为：根据第i个预设目标与第i+1个预设目标中心位置图像在世界坐标系下的空间坐标，计算相邻两个预设目标之间的当前目标距离，对应的计算公式为：式中，为第i个预设目标中心位置图像在世界坐标系下的空间坐标，为第i+1个预设目标中心位置图像在世界坐标系下的空间坐标，ΔLi+1,i为第i个预设目标与第i+1个预设目标之间的当前目标距离，i＝1,2,…,n，n为设定的所述预设目标的数量。8.根据权利要求6所述的车载双目相机视差校正方法，其特征在于，所述步骤2中，所述双目相机的所述视差补偿值为所述相对差值平方的累加和值取值最小情况下的视差补偿值，对应的计算公式为：式中，Li为视差补偿后第i个预设目标与所述双目相机之间的当前目标距离，为第i个预设目标与所述双目相机之间的初始目标距离，i＝1,2,…,n，n为设定的所述预设目标的数量，Δdj为第j个预设视差取值范围中第j个视差补偿值，为第i个预设目标中心位置图像在世界坐标系下的空间坐标，为第i个预设目标中心位置图像的像素坐标，B为所述双目相机的基线距离，f为所述双目相机的焦距，为所述双目相机的光心坐标，dispi为第i个预设目标对应的视差值。9.根据权利要求7所述的车载双目相机视差校正方法，其特征在于，所述步骤2中，所述双目相机的所述视差补偿值为所述相对差值平方的累加和值取值最小情况下的视差补偿值，对应的计算公式为：式中，ΔLi+1,i为视差补偿后第i个预设目标与第i+1个预设目标之间的当前目标距离，为第i个预设目标与第i+1个预设目标之间的初始目标距离，i＝1,2,…,n，n为设定的所述预设目标的数量，Δdj为第j个预设视差取值范围中第j个视差补偿值，为第i个预设目标中心位置图像在世界坐标系下的的空间坐标，为第i个预设目标中心位置图像的像素坐标，B为所述双目相机的基线距离，f为所述双目相机的焦距，为所述双目相机的光心坐标，dispi为第i个预设目标对应的视差值。10.根据权利要求1或2所述的车载双目相机视差校正方法，其特征在于，所述步骤2中，当判定所述相对差值大于或等于所述校正阈值P1时，还包括：步骤2.2.1、统计当前帧采样图像中所述相对差值大于或等于所述校正阈值P1对应的预设目标个数，当统计出的预设目标个数的占比大于或等于预设占比P2时，不达标图像帧数的计数加1；步骤2.2.2、连续统计N3帧采样图像中所述不达标图像帧数的计数值，判断所述计数值在所述N3帧采样图像中的占比是否大于或等于预设占比P3，若是，根据所述当前目标距离以及所述初始目标距离，计算所述双目相机的视差补偿值；若否，重新执行所述步骤1。
说明书desc
技术领域本申请涉及图像处理技术领域，更具体地说，尤其涉及一种车载双目相机视差校正方法。背景技术随着自动驾驶技术的不断发展与成熟，车载视觉感知的重要性日益凸显。将标定好的双目相机安装在车辆上后，能够输出高精度深度图像用于感知车辆周围目标信息，因此，基于双目相机的车载视觉感知技术越来越被车厂所青睐。在车载行驶环境比较恶劣，尤其是当车辆在各种颠簸路面上行驶时，会对车载双目相机造成振动、冲击，长期以往可能会导致车载双目相机视差精度产生退化。除此之外，温度变化等因素影响也会导致车载双目相机视差精度的退化。因此，为了满足图像采集精度和准确性，当车载双目相机视差精度产生退化时，需要及时对其进行视差校正，以保障车辆行驶安全。现有的双目相机视差校正方法通常仅是针对封装后但未安装到车辆上的双目相机，且在校正过程中需要精密的标靶和相应的环境、设备，标定过程比较复杂，通常仅有专业的车载双目相机厂商才具备这些设备、环境和标定能力。而且，车辆出厂后如果车载双目相机的视差发生退化，通常情况下需将车载双目相机拆卸后返厂进行视差校正，这种方式不仅增加售后成本，更重要的是大大影响了客户体验。因此，现有的双目相机视差校正方法无法满足车辆出厂后车载双目相机的视差实时校正。现有技术中也有不少专利提出了双目相机的自校正或自标定方法，如专利CN111862235A就提供了一种双目相机自标定方法及系统，包括：1)获取左右原始图像；2)校正左右原始图像；3)从左右校正图像中提取特征点并匹配；4)统计左右图像纵坐标偏差的平均值，若大于对应阈值则修正估计第一参数组，反复迭代修正，直至小于对应阈值；5)找到静态物体及车道线；6)处于移动状态时，追踪静态物体的视差及车轮运动信息；7)得到车轮运动距离与静态物体的三维距离变化值的距离偏差及车道线的宽度偏差，若大于对应阈值则修正估计第二参数组，反复迭代校正，直至小于对应阈值，完成自标定。该专利能够利用实时图像追踪、车体运动信息及车道宽度信息，对内外参进行优化标定，完成图像校正工作，为车体提供准确的三维识别数据。但该专利所提出的双目相机自标定方法及系统适用于镜头焦距未知的定焦双目相机及变焦双目相机，具有一定的局限性，且其自标定方法也是较为复杂的。因此，有必要对车载双目相机视差校正方法进行进一步深入的研究，如何提出一种无需返厂即可实现车载双目相机定周期的在线自动视差校正方法是具有重要意义的。发明内容本申请所要解决的技术问题是：在无需返厂或拆卸车载双目相机的情况下，如何对车载双目相机进行实时视差校正。为了解决上述技术问题，本申请提供如下技术方案：一种车载双目相机视差校正方法，包括以下步骤：步骤1、根据预设采样周期，获取双目相机当前采样时刻的采样图像；步骤2、判断当前采样时刻的采样图像中的当前目标距离与初始采样时刻的采样图像中的初始目标距离的相对差值是否大于或等于校正阈值P1；若是，根据当前目标距离、初始目标距离以及对应的视差值，计算双目相机的视差补偿值；若否，重新执行步骤1，获取双目相机的采样图像；其中，当前目标距离以及初始目标距离为采样图像中预设目标与双目相机之间的距离或者采样图像中任两个预设目标之间的距离。在一些实施例中，步骤1之后，还包括：步骤1.1、对采样图像进行目标检测，确定各个预设目标的最小外接矩形框的位置坐标；步骤1.2、连续确定N3帧采样图像中各个预设目标的最小外接矩形框的位置坐标，并计算各个最小外接矩形的位置坐标的均值坐标；步骤1.3、对下一帧采样图像进行目标检测，确定各个预设目标的最小外接矩形框的位置坐标，记作待定位置坐标；步骤1.4、判断待定位置坐标与对应的均值坐标之间的坐标偏移是否小于或等于偏移阈值N4；若是，执行步骤2；若否，重新执行步骤1.3，直至到达下一个预设采样周期。在一些实施例中，步骤1.2之前，还包括：步骤1.2.1、确定当前帧采样图像中各个预设目标的最小外接矩形框的位置坐标，并与初始采样时刻的采样图像中各个预设目标相应的最小外接矩形框的初始位置坐标进行比较，计算位置偏移；步骤1.2.2、当判定位置偏移小于位置偏移阈值N1时，将最小外接矩形框的计数加1；步骤1.2.3、连续统计N3帧采样图像中最小外接矩形框的计数值，当计数值大于或等于数量阈值N2时，执行上述步骤1.2。在一些实施例中，步骤2中，当前目标距离以及初始目标距离的计算步骤，包括：步骤2.1.1、对采样图像进行目标检测，确定各个预设目标的最小外接矩形框的位置坐标和各个预设目标中心位置图像的像素坐标；步骤2.1.2、将各个预设目标的最小外接矩形框的位置坐标映射到对应的视差图像中，得到对应的视差数据并进行滤波处理，对处理后的视差数据进行均值计算，将均值计算结果记作视差值disp；步骤2.1.3、根据视差值disp以及坐标变换公式，将各个预设目标中心位置图像的像素坐标转换为世界坐标系下的空间坐标；步骤2.1.4、基于各个预设目标中心位置图像在世界坐标系下的空间坐标，计算当前目标距离以及初始目标距离。在一些实施例中，步骤2.1.2中，对视差数据进行滤波处理的过程，包括：步骤2.1.2.1、对映射到视差图像中的各个预设目标的最小外接矩形框内的视差数据进行排序；步骤2.1.2.2、分别剔除掉排序后的视差数据中占比P0的大端值视差数据和小端值视差数据。在一些实施例中，步骤2.1.4中，当当前目标距离为采样图像中预设目标与双目相机之间的距离时，当前目标距离的计算方法为：将双目相机在世界坐标系中的位置记作原点；根据各个预设目标中心位置图像在世界坐标系下的空间坐标，计算各个预设目标与双目相机之间的当前目标距离，对应的计算公式为：式中，Li为第i个预设目标对应的当前目标距离，为第i个预设目标中心位置图像在世界坐标系下的空间坐标，i＝1,2,…,n，n为设定的预设目标的数量。在一些实施例中，步骤2.1.4中，当当前目标距离为采样图像中任两个预设目标之间的距离时，当前目标距离的计算方法为：根据第i个预设目标与第i+1个预设目标中心位置图像在世界坐标系下的空间坐标，计算相邻两个预设目标之间的当前目标距离，对应的计算公式为：式中，为第i个预设目标中心位置图像在世界坐标系下的空间坐标，为第i+1个预设目标中心位置图像在世界坐标系下的空间坐标，ΔLi+1,i为第i个预设目标与第i+1个预设目标之间的当前目标距离，i＝1,2,…,n，n为设定的预设目标的数量。在一些实施例中，步骤2中，双目相机的视差补偿值为相对差值平方的累加和值取值最小情况下的视差补偿值，对应的计算公式为：式中，Li为视差补偿后第i个预设目标与双目相机之间的当前目标距离，为第i个预设目标与双目相机之间的初始目标距离，i＝1,2,…,n，n为设定的预设目标的数量，Δdj为第j个预设视差取值范围中第j个视差补偿值，为第i个预设目标中心位置图像在世界坐标系下的空间坐标，为第i个预设目标中心位置图像的像素坐标，B为双目相机的基线距离，f为双目相机的焦距，为双目相机的光心坐标，dispi为第i个预设目标对应的视差值。在一些实施例中，步骤2中，双目相机的视差补偿值为相对差值平方的累加和值取值最小情况下的视差补偿值，对应的计算公式为：式中，ΔLi+1,i为视差补偿后第i个预设目标与第i+1个预设目标之间的当前目标距离，为第i个预设目标与第i+1个预设目标之间的初始目标距离，i＝1,2,…,n，n为设定的预设目标的数量，Δdj为第j个预设视差取值范围中第j个视差补偿值，为第i个预设目标中心位置图像在世界坐标系下的的空间坐标，为第i个预设目标中心位置图像的像素坐标，B为双目相机的基线距离，f为双目相机的焦距，为双目相机的光心坐标，dispi为第i个预设目标对应的视差值。在一些实施例中，步骤2中，当判定相对差值大于或等于校正阈值P1时，还包括：步骤2.2.1、统计当前帧采样图像中相对差值大于或等于校正阈值P1对应的预设目标个数，当统计出的预设目标个数的占比大于或等于预设占比P2时，不达标图像帧数的计数加1；步骤2.2.2、连续统计N3帧采样图像中不达标图像帧数的计数值，判断计数值在N3帧采样图像中的占比是否大于或等于预设占比P3，若是，根据当前目标距离以及初始目标距离，计算双目相机的视差补偿值；若否，重新执行步骤1。与现有技术相比，本申请具有以下有益效果：本申请所提供的一种车载双目相机视差校正方法，能有效利用车辆本身的结构特征作为视差校正的媒介，通过将双目相机安装到车辆预设位置且标定好的状态作为初始状态，进行初始采样，以获得初始目标距离作为车载双目相机视差校正的基准值，然后人为设定采样周期，利用当前采样时刻车载双目相机所获取的采样图像中的当前目标距离与初始目标距离进行视差校正判定，当车载双目相机发生退化时，则通过视差补偿的方式，将当前目标距离校正至基准值或者基准值的某一设定范围内，进而实现车载双目相机的视差实时校正，无需拆卸车载双目相机，进一步保障了驾驶安全。本申请所设计的一种车载双目相机视差校正方法，无需将退化的车载双目相机返厂即可实现其定周期的、在线高精度的自动化校正，从而有效地减少了售后成本，大大提升了客户体验。上述说明仅是本申请技术方案的概述，为了能够更清楚了解本申请的技术手段，从而可依照说明书的内容予以实施，并且为了让本申请的上述和其他目的、特征和优点能够更明显易懂，以下以本申请的较佳实施例并配合附图详细说明如后。根据下文结合附图对本申请具体实施例的详细描述，本领域技术人员将会更加明了本申请的上述及其他目的、优点和特征。附图说明为了更清楚地说明本申请实施例或现有技术中的技术方案，下面将对实施例或现有技术描述中所需要使用的附图作简单地介绍，显而易见地，下面描述中的附图是本申请的一些实施例，对于本领域普通技术人员来讲，在不付出创造性劳动的前提下，还可以根据这些附图获得其他的附图。在所有附图中，类似的元件或部分一般由类似的附图标记标识。附图中，各元件或部分并不一定按照实际的比例绘制。图1是本申请实施例中一种车载双目相机视差校正方法的流程示意图；图2是本申请实施例中双目相机获取图像的示意图；图3是本申请实施例中另一种车载双目相机视差校正方法的流程示意图；图4是本申请实施例中预设目标与双目相机之间的距离及任两个预设目标之间的距离示意图；图中：1、双目相机；2、视野范围；3、预设目标；301、网格状凸起；302、驾驶室窗户；303、后视镜；31、第一预设目标；32、第二预设目标。具体实施方式为使本申请实施例的目的、技术方案和优点更加清楚，下面将结合本申请实施例中的附图，对本申请实施例中的技术方案进行清楚、完整地描述，显然，所描述的实施例是本申请一部分实施例，而不是全部的实施例。在下面的描述中，提供诸如具体的配置和组件的特定细节仅仅是为了帮助全面理解本申请的实施例。因此，本领域技术人员应该清楚，可以对这里描述的实施例进行各种改变和修改而不脱离本申请的范围和精神。另外，为了清楚和简洁，实施例中省略了对已知功能和构造的描述。本申请中术语“和/或”，仅仅是一种描述关联对象的关联关系，表示可以存在三种关系，例如，A和/或B，可以表示：单独存在A，单独存在B，同时存在A和B三种情况，本申请中术语“/和”是描述另一种关联对象关系，表示可以存在两种关系，例如，A/和B，可以表示：单独存在A，单独存在A和B两种情况，另外，本申请中字符“/”，一般表示前后关联对象是一种“或”关系。还需要说明的是，在本申请中，诸如第一和第二等之类的关系术语仅仅用来将一个实体或者操作与另一个实体或操作区分开来，而不一定要求或者暗示这些实体或操作之间存在任何这种实际的关系或者顺序。而且，术语“包括”、“包含”或者其任何其他变体意在涵盖非排他性的包含。实施例1如图1所示，本实施例提供了一种车载双目相机视差校正方法，该方法包括以下步骤：步骤1、根据预设采样周期，获取双目相机当前采样时刻的采样图像；步骤2、判断当前采样时刻的采样图像中的当前目标距离与初始采样时刻的采样图像中的初始目标距离的相对差值是否大于或等于校正阈值P1；若是，根据当前目标距离以及初始目标距离，计算双目相机的视差补偿值，其中，视差补偿值用于补偿双目相机的视差，以使通过补偿后的视差计算出的当前采样时刻的采样图像中的当前目标距离趋近于初始采样时刻的采样图像中的初始目标距离，即，使两者的相对差值等于或趋近于0；若否，重新执行步骤1，获取双目相机的采样图像；其中，当前目标距离以及初始目标距离为采样图像中预设目标与双目相机之间的距离或者采样图像中任两个预设目标之间的距离。具体的，本实施例中将双目相机安装在车辆上之后，对该双目相机进行车载标定，标定后的车载双目相机即可实时输出车辆前方和/或周围的图像信息、距离信息，以便作为测距、盲区检测、碰撞预警等自动驾驶功能的数据。因此，本实施例中利用标定后的车载双目相机进行初始采样，确定相应的初始目标距离并进行保存，以便作为车载双目相机视差校正的基准值。本实施例中，双目相机在被安装到车辆的预设位置处时，其视野范围需朝向车辆的前方；其中，预设位置可以为车辆的前方、上方或者后侧方中的任一位置。当预设位置为车辆的前方或者上方时，预设目标可以为车辆引擎盖左右边缘的中部、车辆引擎盖前方边缘的中部、前方车辆车牌的左右边缘等车辆固有结构特征。其中，当预设目标为前方车辆车牌的左右边缘时，当前目标距离为前方车辆车牌左右边缘的间距。如图2所示，当预设位置为车辆的后侧方时，预设目标可以为驾驶室窗户302、后视镜303、车门边缘等车辆固有结构特征。其中，当车辆为卡车、货车或其他大型车辆时，预设目标还可以为车辆车厢侧壁，如卡车车厢上的网格状凸起301。本实施例中，步骤1中的采样周期是可以根据实际情况结合客户需求进行人为设定的。车辆出厂交付用户使用后，即可根据采样周期实时进行车载双目相机视差校正，以保证车载双目相机视差精度。在校正过程中，当到达第一个预设采样周期时，双目相机获取当前采样时刻的采样图像，进行目标检测，识别出采样图像中预设目标，并确定该预设目标在图像中像素坐标信息。需要说明的是，本实施例对目标检测的实现方式并不限定。之后，再根据预设目标在图像中像素坐标信息、双目相机的相关参数，基于坐标变换的方式确定当前采样时刻的当前目标距离，将该当前目标距离与初始目标距离进行比较，判断两者的相对差值是否大于或等于校正阈值P1。需要说明的是，本实施例中当前目标距离与初始目标距离的计算方式相同。如果当前目标距离与初始目标距离之间的差值较大，即大于或等于校正阈值P1，则表明基于初始状态下车载双目相机相关参数计算出的距离信息存在偏差，此时车载双目相机发生的退化，影响图像采集精度和准确性，导致车载双目相机测距的不准确。而由于本实施例中所选定的预设目标为车辆固有结构特征，这些特征并不会随着车辆的使用而发生结构性的变化，因此，可以通过视差补偿的方式，将当前目标距离修正至初始目标距离，实现对车载双目相机的视差校正，减小车载双目相机退化对图像采集精度和准确性的影响。如果当前目标距离与初始目标距离之间的差值较小，即小于校正阈值P1，则表明车载双目相机未发生退化或发生的退化并不影响图像采集精度和准确性，此时无需进行视差校正，等待第二个预设采样周期到达，重新执行上述步骤即可。因此，通过本实施例中的上述技术方案，无需拆卸车载双目相机，即可实现对车载双目相机视差的实时校正。为了进一步保证视差精度检测校正的鲁棒性、准确性，预设目标至少选取3个。可以看出，本实施例可以针对不同的车型、不同的预设位置，对应地选择合适的预设目标；而且，针对不同的预设目标，还能对应地选择合适的目标距离。即本实施例能够结合实际应用中车载双目相机不同的使用情况来做出对应的选择判断，考虑得十分全面周到，能够便于后续视差校正工作的进行。在一些实施例中，考虑到车载双目相机在图像采集过程中不可避免的会受到一些噪声干扰，影响预设目标识别以及预设目标在图像中像素坐标信息的确定，因此，为了保证车载双目相机视差校正的准确性，如图3所示，步骤1之后，还包括：步骤1.1、对采样图像进行目标检测，确定各个预设目标的最小外接矩形框的位置坐标；步骤1.2、连续确定N3帧采样图像中各个预设目标的最小外接矩形框的位置坐标，并计算各个最小外接矩形的位置坐标的均值坐标；步骤1.3、对下一帧采样图像进行目标检测，确定各个预设目标的最小外接矩形框的位置坐标，记作待定位置坐标；步骤1.4、判断待定位置坐标与对应的均值坐标之间的坐标偏移是否小于或等于偏移阈值N4；若是，执行步骤2；若否，重新执行步骤1.3，直至到达下一个预设采样周期。本实施例中，步骤1.1至步骤1.4能够有效保证在车载双目相机视差出现偏差后，仍能获取到与初始状态相比较为准确的、鲁棒的最小外接矩形框，进而保证视差校正的准确性和可靠性。在一些实施例中，为了保证车载双目相机采集图像中包含一定数量的、有效的最小外接矩形框，为车载双目相机视差校正提供可靠的、准确的依据，步骤1.2之前，还包括：步骤1.2.1、确定当前帧采样图像中各个预设目标的最小外接矩形框的位置坐标，并与初始采样时刻的采样图像中各个预设目标相应的最小外接矩形框的初始位置坐标进行比较，计算位置偏移；步骤1.2.2、当判定位置偏移小于位置偏移阈值N1时，将最小外接矩形框的计数加1；步骤1.2.3、连续统计N3帧采样图像中最小外接矩形框的计数值，当计数值大于或等于数量阈值N2时，执行上述步骤1.2。在本实施例中，考虑到车辆在行驶过程中可能会发生碰撞，特别是安装双目相机的位置发生碰撞时，会对双目相机产生较大的影响。因此，在上述过程中，如果连续检测的图像帧数达到或超过设定阈值N3，但最小外接矩形框的位置坐标信息数量依旧无法满足设定数量阈值N2时，即位置偏移小于位置偏移阈值N1的最小外接矩形框的计数小于N2，说明车载双目相机的姿态发生了大幅度的变化，已经无法通过视差校正的方式对双目相机进行校正，此时应发出告警信息，提示用户需要返厂维修，调整双目相机安装姿态，并停止视差检测。在一些实施例中，步骤2中，当前目标距离以及初始目标距离的计算步骤，包括：步骤2.1.1、对采样图像进行目标检测，确定各个预设目标的最小外接矩形框的位置坐标和各个预设目标中心位置图像的像素坐标；步骤2.1.2、将各个预设目标的最小外接矩形框的位置坐标映射到对应的视差图像中，得到对应的视差数据并进行滤波处理，对处理后的视差数据进行均值计算，将均值计算结果记作视差值disp；步骤2.1.3、根据视差值disp以及坐标变换公式，将各个预设目标中心位置图像的像素坐标转换为世界坐标系下的空间坐标；步骤2.1.4、基于各个预设目标中心位置图像在世界坐标系下的空间坐标，计算当前目标距离以及初始目标距离。具体的，先对采样图像进行目标检测，确定各个预设目标的最小外接矩形框的位置坐标和各个预设目标中心位置图像的像素坐标；再将各个预设目标的最小外接矩形框的位置坐标映射到对应的视差图像中，得到对应的视差数据并进行滤波处理，将处理后的视差数据进行均值计算，计算结果即为视差值disp；之后，基于公式完成各个预设目标中心位置图像的像素坐标到世界坐标的变换；式中，B为双目相机的基线距离，f为双目相机的焦距，disp为视差值，为双目相机的光心坐标；最后，基于各个预设目标中心位置图像在世界坐标系下的空间坐标，进行当前目标距离以及初始目标距离的计算。需要说明的是，本实施例中当前目标距离与初始目标距离的计算方式相同。以当前目标距离为例，当前目标距离的计算方式如下：①当前目标距离为采样图像中预设目标与双目相机之间的距离时，当前目标距离的计算方法为：将双目相机在世界坐标系中的位置记作原点；根据各个预设目标中心位置图像在世界坐标系下的空间坐标，计算各个预设目标与双目相机之间的当前目标距离，对应的计算公式为：式中，Li为第i个预设目标对应的当前目标距离，为第i个预设目标中心位置图像在世界坐标系下的空间坐标，i为预设目标的标号，i＝1,2,…,n，n为设定的预设目标的数量。②当前目标距离为采样图像中任两个预设目标之间的距离时，当前目标距离的计算方法为：根据第i个预设目标与第i+1个预设目标中心位置图像在世界坐标系下的空间坐标，计算相邻两个预设目标之间的当前目标距离，对应的计算公式为：式中，为第i个预设目标中心位置图像在世界坐标系下的空间坐标，为第i+1个预设目标中心位置图像在世界坐标系下的空间坐标，ΔLi+1,i为第i个预设目标与第i+1个预设目标之间的当前目标距离，i为预设目标的标号，i＝1,2,…,n，n为设定的预设目标的数量。因此，若当前目标距离与初始目标距离的相对差值小于校正阈值P1，无需对车载双目相机的视差进行校正，可实时采集车辆前方和/或周围的图像信息、距离信息，且该距离信息与相应的真实距离的差值被认为处于合理的误差范围之内。若当前目标距离与初始目标距离的相对差值大于或等于校正阈值P1，则认为当前状态下的距离信息与相应的真实距离的差值超出了合理的误差范围，因此，车载双目相机需要视差校正，以便根据校正后的视差值，获得准确的距离信息。在基于上述多个当前目标距离进行视差校正时，每一个预设目标均可对应于一个视差补偿值，以使每一个当前目标距离与初始目标距离之间的相对差值等于或趋近于0。因此，可以选择上述计算出的多个视差补偿值中的最大值、最小值、中间值或者平均值中的任一个，作为视差补偿值输出，也可以选择其他运算方式计算出的视差补偿值，对车载双目相机的视差值进行补偿，以保证车载双目相机的测距精度。在一些实施例中，为了保证视差校正的可靠性，选择采用求取距离差和值最小的方式，计算距离差平方的累加和值取值最小情况下的视差补偿值Δd，该距离差为当前目标距离与初始目标距离之间的相对差值，与上述过程相应的，步骤2中，双目相机的视差补偿值为相对差值平方的累加和值取值最小情况下的视差补偿值，对应的计算公式为：①当前目标距离为采样图像中预设目标与双目相机之间的距离时，视差补偿值的计算公式为：式中，Li为视差补偿后第i个预设目标与双目相机之间的当前目标距离，为第i个预设目标与双目相机之间的初始目标距离，i为预设目标的标号，i＝1,2,…,n，n为设定的预设目标的数量，Δdj为第j个预设视差取值范围中第j个视差补偿值，为第i个预设目标中心位置图像在世界坐标系下的空间坐标，为第i个预设目标中心位置图像的像素坐标，B为双目相机的基线距离，f为双目相机的焦距，为双目相机的光心坐标，dispi为第i个预设目标对应的视差值。本实施例中，预设视差取值范围的取值可以人为设定。采用遍历的方式，每一个选取出视差补偿值Δdj均对应于一个距离差平方的累加和值，选取该累加和值取值最小时对应的视差补偿值，作为最终输出的车载双目相机的视差补偿值，对视差进行补偿。②当前目标距离为采样图像中任两个预设目标之间的距离时，视差补偿值的计算公式为：/＞式中，ΔLi+1,i为视差补偿后第i个预设目标与第i+1个预设目标之间的当前目标距离，为第i个预设目标与第i+1个预设目标之间的初始目标距离，i为预设目标的标号，i＝1,2,…,n，n为设定的预设目标的数量，Δdj为第j个预设视差取值范围中第j个视差补偿值，为第i个预设目标中心位置图像在世界坐标系下的空间坐标，为第i个预设目标中心位置图像的像素坐标，B为双目相机的基线距离，f为双目相机的焦距，为双目相机的光心坐标，dispi为第i个预设目标对应的视差值。在一些实施例中，为了保证数据的有效性，减小无效或小量数据对算力的影响，步骤2.1.2中，对视差数据进行滤波处理的过程，包括：步骤2.1.2.1、对映射到视差图像中的各个预设目标的最小外接矩形框内的视差数据进行排序；步骤2.1.2.2、分别剔除掉排序后的视差数据中占比P0的大端值视差数据和小端值视差数据。在一些实施例中，考虑到车载双目相机在图像采集过程中不可避免的会受到一些噪声干扰，因此，为了避免频繁的进行车载双目视差校正，减少对车载数据处理设备算力的占用，步骤2中，当判定相对误差大于或等于校正阈值P1时，还包括：步骤2.2.1、统计当前帧采样图像中大于或等于校正阈值P1的预设目标个数，当统计出的预设目标个数的占比大于或等于预设占比P2时，不达标图像帧数的计数加1；步骤2.2.2、连续统计N3帧采样图像的不达标图像帧数的计数值，当计数值在N3帧采样图像的占比大于或等于预设占比P3时，根据当前目标距离以及初始目标距离，计算双目相机的视差补偿值；否则，重新执行步骤1。本实施例所提供的一种车载双目相机视差校正方法，能够利用车辆本身的结构特征作为视差校正的媒介，无需将退化的车载双目相机返厂即可实现其定周期的、高精度的自动化校正。这有效减少了售后成本，进一步保障了驾驶安全，大大提升了客户体验。实施例2基于实施例1，本实施例提供了一种基于采样图像中预设目标到双目相机之间的距离计算来进行的一种车载双目相机视差校正方法，并以卡车为例来进行说明。该方法具体包括以下步骤：S1、将双目相机安装在卡车车厢后端，获取双目相机初始采样时刻的采样图像，记作初始采样图像；并对初始采样图像进行目标检测，获取初始采样时刻各个预设目标到双目相机的距离，记作初始目标距离并保存，以便后期视差校正时使用。在一些实施例中，双目相机安装在卡车车厢后端能够有助于获得卡车转弯过程中内轮差区域、A柱盲区范围等区域的图像。在一些实施例中，安装在卡车车厢后端的双目相机视野范围内所获取的采样图像中包含多个如卡车车厢上的网格状凸起301、驾驶室窗户302、后视镜303等预设目标。具体结合附图2所示，图2是本实施例中双目相机获取采样图像的示意图。在一些实施例中，S1中，对初始采样图像进行目标检测，包括以下步骤：S101、获取定位框信息：基于Blob分析、模板匹配、深度学习等方法对初始采样图像进行目标检测，确定各个预设目标的最小外接矩形框的位置坐标并对其进行滤波处理，获取各个预设目标所在初始采样图像中的最小外接矩形框的位置坐标信息Rect和各个预设目标中心位置图像的像素坐标；S102、获取视差值：将各个预设目标所在初始采样图像中的最小外接矩形框的位置坐标信息映射到对应的视差图像中，得到对应的视差数据；对映射到视差图像中各个预设目标的最小外接矩形框内的视差数据进行排序，分别剔除掉排序后的视差数据中占比P0的大端值视差数据和小端值视差数据；对剩余视差数据进行均值计算，计算结果即为各个预设目标所在区域对应的视差值disp；S103、坐标系变换：基于公式完成各个预设目标中心位置图像的像素坐标到世界坐标的变换；式中，B为双目相机的基线距离，f为双目相机的焦距，disp为视差值，为双目相机的光心坐标。在一些实施例中，S1中，获取初始采样时刻各个预设目标到双目相机的距离，即初始目标距离的计算方法为：将双目相机在世界坐标系中的位置记作原点；根据各个预设目标中心位置图像在世界坐标系下的空间坐标，计算各个预设目标对应的初始目标距离，计算公式为：式中，Li为第i个预设目标对应的初始目标距离，为第i个预设目标中心位置图像在世界坐标系下的空间坐标，i为预设目标的标号，i＝1,2,…,n，n为设定的预设目标的数量。S2、到达第一个预设采样周期，获取双目相机当前采样时刻的采样图像，记作第一采样图像；并对第一采样图像进行目标检测，获取当前采样时刻各个预设目标到双目相机的当前目标距离，记作第一目标距离。在一些实施例中，S2中，对第一采样图像进行目标检测，包括以下步骤：S201、基于Blob分析、模板匹配、深度学习等方法对当前帧第一采样图像进行目标检测，确定各个预设目标的最小外接矩形框的位置坐标并对其进行滤波处理；S202、将当前帧第一采样图像中各个预设目标的最小外接矩形框的位置坐标与初始采样图像中各个预设目标相应的最小外接矩形框的初始位置坐标进行比较，计算位置偏移；当判定位置偏移大于或等于位置偏移阈值N1时，剔除该最小外接矩形框；当判定位置偏移小于位置偏移阈值N1时，保留该最小外接矩形框并将最小外接矩形框的计数加1；S203、连续统计N3帧第一采样图像中最小外接矩形框的计数值，当计数值大于或等于数量阈值N2时，计算N3帧第一采样图像中各个最小外接矩形的位置坐标的均值坐标并保存；当计数值小于数量阈值N2时，说明双目相机姿态发生了大幅度的变化，则提示用户需要重新调整双目相机安装姿态，视差检测停止。S204、对下一帧第一采样图像进行目标检测，确定各个预设目标的最小外接矩形框的位置坐标，记作待定位置坐标；S205、判断S204中待定位置坐标与S203中对应的均值坐标之间的坐标偏移是否小于或等于偏移阈值N4；若是，计算并输出第一目标距离；若否，重新执行S204，直至到达下一个预设采样周期。需要说明的是，S2中第一目标距离与S1中初始目标距离所采用的计算步骤和计算方法相同，在此不作赘述。S3：判断第一目标距离与初始目标距离的相对差值是否大于或等于校正阈值P1；若是：统计当前帧采样图像中大于或等于校正阈值P1的预设目标个数，当统计出的预设目标个数的占比大于或等于预设占比P2时，不达标图像帧数的计数加1；连续统计N3帧采样图像的不达标图像帧数的计数值，当计数值在N3帧采样图像的占比大于或等于预设占比P3时，根据当前目标距离以及初始目标距离，计算双目相机的视差补偿值；当计数值在N3帧采样图像的占比小于预设占比P3时，重新执行S1；若否：重新执行S1，获取双目相机的采样图像。在一些实施例中，初始目标距离、双目相机的基线距离B、双目相机的焦距f均已知，仅需对视差值disp进行补偿校正，使得第一目标距离等于或近似等于初始目标距离。由于预设目标设置有多个，因此，S3中“计算双目相机的视差补偿值”采用求取距离差和值最小的方式，计算距离差平方的累加和值取值最小情况下的视差补偿值Δd。在一些实施例中，S3中“计算双目相机的视差补偿值”需连续计算N5帧第一采样图像，获取N6个Δd，然后进行数据滤波处理，即对视差补偿值Δd进行排序处理，分别删除占比P4的大端值和小端值，然后对剩余数据做均值计算，计算结果即为最终的视差校正值，并将该值写入双目相机，完成视差精度校正工作，等待下一个精度检测预设采样周期开启。在一些实施例中，S3中“计算双目相机的视差补偿值”所采用的计算公式为：式中，Li为视差补偿后第i个预设目标与双目相机之间的当前目标距离，为第i个预设目标与双目相机之间的初始目标距离，i＝1,2,…,n，n为设定的预设目标的数量，Δdj为第j个预设视差取值范围中第j个视差补偿值，为第i个预设目标中心位置图像在世界坐标系下的空间坐标，为第i个预设目标中心位置图像的像素坐标，B为双目相机的基线距离，f为双目相机的焦距，为双目相机的光心坐标，dispi为第i个预设目标对应的视差值。实施例3基于实施例1和2，本实施例提供了一种基于采样图像中任两个预设目标之间的距离计算来进行的一种车载双目相机视差校正方法，同样以卡车为例来进行说明。该方法具体包括以下步骤：S1、将双目相机安装在卡车车厢后端，获取双目相机初始采样时刻的采样图像，记作初始采样图像；并对初始采样图像进行目标检测，获取初始采样图像中任两个预设目标之间的距离，记作初始目标距离并保存，以便后期视差校正时使用。需要说明的是，本实施例S1中“对初始采样图像进行目标检测”包括的步骤S101-S103与实施例2相同，在此不作赘述。在一些实施例中，S1中，获取初始采样图像中任两个预设目标之间的距离，即初始目标距离的计算方法为：根据第i个预设目标与第i+1个预设目标中心位置图像在世界坐标系下的空间坐标，计算相邻两个预设目标之间的初始目标距离，对应的计算公式为：式中，为第i个预设目标中心位置图像在世界坐标系下的空间坐标，为第i+1个预设目标中心位置图像在世界坐标系下的空间坐标，ΔLi+1,i为第i个预设目标与第i+1个预设目标之间的初始目标距离，i为预设目标的标号，i＝1,2,…,n，n为设定的预设目标的数量。在一些实施例中，以选取2个预设目标为例，具体结合附图4所示，图4是预设目标与双目相机之间的距离及任两个预设目标之间的距离示意图。根据S101-S103可以分别得到第一预设目标31和第二预设目标32中心位置图像在世界坐标系下的空间坐标和，进而可以计算出第一预设目标31和第二预设目标32之间的初始目标距离并以此作为视差校正的依据。在一些实施例中，还可以采用遍历的方式，计算任两个预设目标之间的距离，以保证视差校正的准确性。S2、到达第一个预设采样周期，获取双目相机当前采样时刻的采样图像，记作第一采样图像；并对第一采样图像进行目标检测，获取第一采样图像中任两个预设目标之间的当前目标距离，记作第二目标距离。需要说明的是，本实施例S2中“对第一采样图像进行目标检测”包括的步骤S201-S205与实施例2相同，在此不作赘述。同样需要说明的是，S2中第二目标距离与S1中初始目标距离所采用的计算步骤和计算方法相同，在此不作赘述。S3：判断第二目标距离与初始目标距离的相对差值是否大于或等于校正阈值P1；若是：统计当前帧采样图像中大于或等于校正阈值P1的预设目标个数，当统计出的预设目标个数的占比大于或等于预设占比P2时，不达标图像帧数的计数加1；连续统计N3帧采样图像的不达标图像帧数的计数值，当计数值在N3帧采样图像的占比大于或等于预设占比P3时，根据当前目标距离以及初始目标距离，计算双目相机的视差补偿值；当计数值在N3帧采样图像的占比小于预设占比P3时，重新执行S1；若否：重新执行S1，获取双目相机的采样图像。需要说明的是，本实施例利用任两个预设目标之间的距离进行车载双目相机的视差校正与实施例2利用各个预设目标与双目相机之间的距离进行车载双目相机的视差校正的原理基本相同，只是把预设目标与双目相机之间的距离变换成任两个预设目标之间的距离。故本实施例S3中“计算双目相机的视差补偿值”同样采用求取距离差和值最小的方式，计算距离差平方的累加和值取值最小情况下的视差补偿值Δd。在一些实施例中，S3中“计算双目相机的视差补偿值”所采用的计算公式为：式中，ΔLi+1,i为视差补偿后第i个预设目标与第i+1个预设目标之间的当前目标距离，为第i个预设目标与第i+1个预设目标之间的初始目标距离，i＝1,2,…,n，n为设定的预设目标的数量，Δdj为第j个预设视差取值范围中第j个视差补偿值，为第i个预设目标中心位置图像在世界坐标系下的的空间坐标，为第i个预设目标中心位置图像的像素坐标，B为双目相机的基线距离，f为双目相机的焦距，为双目相机的光心坐标，dispi为第i个预设目标对应的视差值。实施例4基于实施例1和2，本实施例还可以选取世界坐标系中同一个轴向方向的预设目标与双目相机之间的距离变化作为校正视差的依据。本实施例以“选取卡车车体Z轴方向上前后分布的多个网格状凸起作为预设目标”为例进行车载双目相机的视差校正，具体包括以下步骤：S1、将双目相机安装在卡车车厢后端，获取双目相机初始采样时刻的采样图像，记作初始采样图像；并对初始采样图像进行卡车车体Z轴方向上前后分布的多个网格状凸起的检测，获取初始采样时刻卡车车体Z轴方向上前后分布的多个网格状凸起到双目相机的距离，记作初始目标距离并保存，以便后期视差校正时使用。需要说明的是，本实施例S1中“对初始采样图像进行卡车车体Z轴方向上前后分布的多个网格状凸起的检测”包括的步骤S101-S103与实施例2相同，在此不作赘述。在一些实施例中，本实施例S1中，获取初始采样时刻卡车车体Z轴方向上前后分布的多个网格状凸起到双目相机的距离，即初始目标距离的计算方法为：式中，Li为第i个凸起对应的初始目标距离，dispi为第i个凸起对应的视差值，B为双目相机的基线距离，f为双目相机的焦距。S2、到达第一个预设采样周期，获取双目相机当前采样时刻的采样图像，记作第一采样图像；并对第一采样图像进行卡车车体Z轴方向上前后分布的多个网格状凸起的检测，获取当前采样时刻卡车车体Z轴方向上前后分布的多个网格状凸起到双目相机的当前目标距离，记作第三目标距离。S3：判断第三目标距离与初始目标距离的相对差值是否大于或等于校正阈值P1；若是：统计当前帧采样图像中大于或等于校正阈值P1的凸起个数，当统计出的凸起个数的占比大于或等于预设占比P2时，不达标图像帧数的计数加1；连续统计N3帧采样图像的不达标图像帧数的计数值，当计数值在N3帧采样图像的占比大于或等于预设占比P3时，根据当前目标距离以及初始目标距离，计算双目相机的视差补偿值；当计数值在N3帧采样图像的占比小于预设占比P3时，重新执行S1；若否：重新执行S1，获取双目相机的采样图像。需要说明的是，本实施例与实施例2的原理基本相同，只是两者的距离计算和校正公式有所不同。故本实施例S2、S3仅需在进行距离计算和校正时选择对应的公式，其余内容均与实施例2相同，相同内容在此不作赘述。在一些实施例中，本实施例还可以选取Y轴方向上下设置的卡车自身的固有结构特征作为预设目标，如驾驶室窗户的上沿、下沿；也可以选取X轴方向左右设置的固有结构特征作为预设目标，如后视镜的左边沿、右边沿。以上仅为本申请的优选实施例而已，其并非因此限制本申请的保护范围，对于本领域的技术人员来说，本申请可以有各种更改和变化。凡在本申请的精神和原则之内，通过常规的替代或者能够实现相同的功能在不脱离本申请的原理和精神的情况下对这些实施例进行变化、修改、替换、整合和参数变更均落入本申请的保护范围内。
