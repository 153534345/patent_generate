标题title
一种提高7816通讯效率的方法及装置
摘要abst
本申请涉及通讯技术领域，公开了一种提高7816通讯效率的方法及装置，所述方法应用于从设备，所述从设备与主设备通过7816通讯协议连接，所述方法包括：接收所述主设备发出的指令信号；对所述指令信号进行处理，获得应答信号；检测到所述主设备准备好接收所述应答信号时，发送所述应答信号，在发送所述应答信号的过程中，同时为接收下一个指令信号配置准备寄存器。配置准备寄存器与发送应答信号同时进行，能够节省额外配置准备寄存器的时间，提高7816协议的通讯速率。
权利要求书clms
1.一种提高7816通讯效率的方法，其特征在于，应用于从设备，所述从设备与主设备通过7816通讯协议连接，所述方法包括：接收所述主设备发出的指令信号；对所述指令信号进行处理，获得应答信号；检测到所述主设备准备好接收所述应答信号时，发送所述应答信号，在发送所述应答信号的过程中，同时为接收下一个指令信号配置准备寄存器。2.根据权利要求1所述的方法，其特征在于，所述准备寄存器包括：接收中断寄存器；所述在发送所述应答信号的过程中，同时为接收下一个指令信号配置准备寄存器，具体包括：在发送所述应答信号的过程中的第一时刻，重新配置所述接收中断寄存器；其中，所述第一时刻通过总应答时钟数减去配置所述接收中断寄存器需要的时钟数获得。3.根据权利要求2所述的方法，其特征在于，所述准备寄存器还包括：接收格式寄存器；在所述重新配置所述接收中断寄存器之前，还包括：在发送所述应答信号的过程中，配置所述接收格式寄存器。4.根据权利要求3所述的方法，其特征在于，所述准备寄存器还包括：接收缓冲寄存器；在所述重新配置所述接收中断寄存器之前，还包括：在发送所述应答信号的过程中，配置所述接收缓冲寄存器。5.根据权利要求2-4任一项所述的方法，其特征在于，还包括：当所述应答信号发送完毕时，开启所述接收中断寄存器，并控制所述从设备进入省电模式。6.根据权利要求1-4任一项所述的方法，其特征在于，所述主设备准备好接收所述应答信号包括：所述主设备发出指令信号后超过预设时间再接收所述应答信号；该方法还包括：对所述指令信号进行处理的同时，设置计时器；所述计时器的时间为所述预设时间；所述检测到所述主设备准备好接收所述应答信号时，发送所述应答信号，具体包括：查询所述计时器的状态，如果为溢出，发送所述应答信号；否则重新查询所述计时器的状态。7.一种提高7816通讯效率的装置，其特征在于，包括：接收模块、处理模块、发送模块和配置模块；所述接收模块，用于接收主设备发出的指令信号；所述处理模块，用于对所述接收模块的所述指令信号进行处理，获得应答信号；所述发送模块，用于在检测到所述主设备准备好接收所述应答信号时，发送所述应答信号；所述配置模块，用于在所述发送模块发送所述应答信号的过程中，同时为接收下一个指令信号配置准备寄存器。8.根据权利要求7所述的装置，其特征在于，所述准备寄存器包括：接收中断寄存器；所述配置模块，具体用于在发送所述应答信号过程中的第一时刻，重新配置所述接收中断寄存器；其中，所述第一时刻通过总应答时钟数减去配置所述接收中断寄存器需要的时钟数获得。9.根据权利要求8所述的装置，其特征在于，所述准备寄存器还包括：接收格式寄存器；所述配置模块，还用于在重新配置所述接收中断寄存器之前，在发送所述应答信号的过程中，配置所述接收格式寄存器。10.根据权利要求9所述的装置，其特征在于，所述准备寄存器还包括：接收缓冲寄存器；所述配置模块，还用于在重新配置所述接收中断寄存器之前，在发送所述应答信号的过程中，配置所述接收缓冲寄存器。11.根据权利要求7-10任一项所述的装置，其特征在于，所述主设备准备好接收所述应答信号包括：所述主设备发出指令信号后超过预设时间再接收所述应答信号；所述处理模块还用于对所述指令信号进行处理的同时，设置计时器；所述计时器的时间为所述预设时间；所述发送模块具体用于：查询所述计时器的状态，如果为溢出，发送所述应答信号；否则重新查询所述计时器的状态。
说明书desc
技术领域本申请涉及通讯技术领域，具体涉及一种提高7816通讯效率的方法及装置。背景技术7816是一种通讯协议，被广泛应用于智能卡等设备中。7816通讯协议，包含时钟端口、串行输入/输出端口等多种端口。传统的7816通讯过程中，主设备和从设备通过7816协议通信；从设备为了在下一指令周期更加方便、准确地接收主设备发来的新的指令，常常在当前指令的应答信号发送完毕之后，在接收新的指令之前，预先配置好接收新的指令所需要的准备寄存器。但由于各个步骤均是按预设顺序依次执行，通讯效率较低。发明内容有鉴于此，本申请提供一种提高7816通讯效率的方法及装置，能够有效提高通讯效率。为解决上述问题，本申请提供的技术方案如下：在本申请第一方面提供一种提高7816通讯效率的方法，应用于从设备，从设备与主设备通过7816通讯协议连接，方法包括：接收主设备发出的指令信号；对指令信号进行处理，获得应答信号；检测到主设备准备好接收应答信号时，发送应答信号，在发送应答信号的过程中，同时为接收下一个指令信号配置准备寄存器。优选地，准备寄存器包括：接收中断寄存器；在发送应答信号的过程中，同时为接收下一个指令信号配置准备寄存器，具体包括：在发送应答信号的过程中的第一时刻，重新配置接收中断寄存器；其中，第一时刻通过总应答时钟数减去配置接收中断寄存器需要的时钟数获得。优选地，准备寄存器还包括：接收格式寄存器；在重新配置接收中断寄存器之前，还包括：在发送应答信号的过程中，配置接收格式寄存器。优选地，准备寄存器还包括：接收缓冲寄存器；在重新配置接收中断寄存器之前，还包括：在发送应答信号的过程中，配置接收缓冲寄存器。优选地，该方法还包括：当应答信号发送完毕时，开启接收中断寄存器，并控制从设备进入省电模式。优选地，主设备准备好接收应答信号包括：主设备发出指令信号后超过预设时间再接收应答信号；该方法还包括：对指令信号进行处理的同时，设置计时器；计时器的时间为预设时间；检测到主设备准备好接收应答信号时，发送应答信号，具体包括：查询计时器的状态，如果为溢出，发送应答信号；否则重新查询计时器的状态。本申请第二方面提供一种提高7816通讯效率的装置，包括：接收模块、处理模块、发送模块和配置模块；接收模块，用于接收主设备发出的指令信号；处理模块，用于对接收模块的指令信号进行处理，获得应答信号；发送模块，用于在检测到主设备准备好接收应答信号时，发送应答信号；配置模块，用于在发送模块发送应答信号的过程中，同时为接收下一个指令信号配置准备寄存器。优选地，准备寄存器包括：接收中断寄存器；配置模块，具体用于在发送应答信号过程中的第一时刻，重新配置接收中断寄存器；其中，第一时刻通过总应答时钟数减去配置接收中断寄存器需要的时钟数获得。优选地，准备寄存器还包括：接收格式寄存器；配置模块，还用于在重新配置接收中断寄存器之前，在发送应答信号的过程中，配置接收格式寄存器。优选地，准备寄存器还包括：接收缓冲寄存器；配置模块，还用于在重新配置接收中断寄存器之前，在发送应答信号的过程中，配置接收缓冲寄存器。优选地，主设备准备好接收应答信号包括：主设备发出指令信号后超过预设时间再接收应答信号；处理模块还用于对指令信号进行处理的同时，设置计时器；计时器的时间为预设时间；发送模块具体用于：查询计时器的状态，如果为溢出，发送应答信号；否则重新查询计时器的状态。由此可见，本申请具有如下有益效果：本申请提供的提高7816通讯速率的方法，应用于从设备，从设备与主设备通过7816通讯协议连接，该方法包括：接收主设备发出的指令信号；对指令信号进行处理，获得应答信号；检测到主设备准备好接收应答信号时，发送应答信号，在发送应答信号的过程中，同时为接收下一个指令信号配置准备寄存器。由于配置准备寄存器所需要的时间低于发送应答信号所需要的时间，并且发送应答信号与接收下一个指令信号之间无时序要求；因此本申请提供的提高7816通讯速率的方法，配置准备寄存器可以与发送应答信号同时进行，能够节省额外配置准备寄存器的时间，提高7816协议的通讯速率。附图说明图1为一种采用7816协议的通信系统的示意图；图2为本申请实施例提供的一种提高7816通讯速率的方法的流程图；图3为本申请实施例提供的另一种提高7816通讯速率的方法的流程图；图4为本申请实施例提供的一种7816接收指令信号和处理指令信号的时序图；图5为本申请实施例提供的一种7816发送应答信号的时序图；图6为本申请实施例提供的一种提高7816通讯效率的装置的示意图；图7为本申请实施例提供的另一种提高7816通讯效率的装置的示意图。具体实施方式为了使本领域技术人员更好地理解和实施本申请的技术方案，下面介绍本申请的具体应用场景。参见图1，该图为一种采用7816协议的通信系统的示意图。采用7816协议的通信系统包括主设备A和从设备B。主设备A和从设备B之间通过7816协议进行通信连接。这种通信系统的工作方式为：主设备A向从设备B发送指令信号，从设备B进行处理并返回应答信号给主设备A。在7816通讯协议下，每个基本时间单元传输1bit数据。初始通讯速率为1/)，即1ETU=372CLK。发明人发现，7816通讯协议下，数据传输是以ETU为时间单位；而数据处理则是以CLK为时间单位；也就是说，数据处理速度明显比数据传输速度更快。若是数据处理能够在数据传输时并行处理，则可以提高通讯效率。为了使本领域技术人员更好地理解本申请提供的技术方案，下面先对本申请涉及的7816协议的通讯时序要求进行简单介绍。主设备发给从设备的最后一字节起始位下降沿与由从设备发出的第一字符起始位下降沿之间最大时间间隔不应该超过；其中，BWI的值在0-4之间，所以BWT将在971-15371ETU之间。反向传送的两相邻字符的起始位下降沿之间的最小时间间隔为22ETU。下面结合附图和具体实施方式对本申请实施例作详细的说明。参见图2，该图为本申请实施例提供的一种提高7816通讯速率的方法的流程图。本申请实施例提供的提高7816通讯速率的方法，应用于从设备，从设备与主设备通过7816通讯协议连接。本申请不具体限定从设备的类型，例如从设备可以是集成电路卡。该方法包括：S201：接收主设备发出的指令信号。S202：对指令信号进行处理，获得应答信号。S203：检测到主设备准备好接收应答信号时，发送应答信号，在发送应答信号的过程中，同时为接收下一个指令信号配置准备寄存器。由于7816的相关时序要求中，对于从设备给终端应答后，到下一条主设备给从设备的指令的起始位之间的时序均没有约定；因此，从设备应答和准备接收下一个指令信号之间的动作并行执行，可以有效提升7816通讯效率。应该理解，发送应答信号属于数据传输，以ETU为时间单位进行；而配置准备寄存器属于数据处理，以CLK为时间单位。因此，发送应答信号所需的时间更长，能够在发送应答信号的过程中同时配置准备寄存器。其中，准备寄存器是指接收下一个指令信号时所要用到的寄存器，具体可以为各种各样的类型，本申请对此不做具体限定。例如：准备寄存器具体可以是接收中断寄存器，还可以是接收格式寄存器，也可以是接收缓冲寄存器等等。当然，具体可以是一种准备寄存器的配置与发送应答信号同时执行；也可以是多种准备寄存器的配置均与发送应答信号的过同时执行。本申请不具体限定主设备准备好接收应答信号的具体实现方式，例如：从设备可以在接收到指令信号后进行计时，当计时时间达到7816协议的通讯时序要求的最小时间间隔，且未超过通讯时序要求的最大时间间隔时，表示主设备准备好接收应答信号。本申请实施例提供的提高7816通讯速率的方法，应用于从设备，从设备与主设备通过7816通讯协议连接，该方法包括：接收主设备发出的指令信号；对指令信号进行处理，获得应答信号；检测到主设备准备好接收应答信号时，发送应答信号，在发送应答信号的过程中，同时为接收下一个指令信号配置准备寄存器。由于配置准备寄存器所需要的时间低于发送应答信号所需要的时间，并且发送应答信号与接收下一个指令信号之间无时序要求；因此本申请实施例提供的提高7816通讯速率的方法，配置准备寄存器可以与发送应答信号同时进行，能够节省额外配置准备寄存器的时间，提高7816协议的通讯速率。为了使本领域技术人员更清楚地理解本申请提供的技术方案，下面以准备寄存器具体包括接收格式寄存器、接收缓冲寄存器和接收中断寄存器为例，介绍一种可能的具体实现方式。参见图3，该图为本申请实施例提供的另一种提高7816通讯速率的方法的流程图。S301：接收主设备发出的指令信号。S302：处理指令信号，获得应答信号。S303：对指令信号进行处理的同时，设置计时器。计时器的时间为预设时间。本申请不具体限定预设时间的取值，只要满足通讯时序要求即可。S304：查询计时器是否溢出，如果是，执行步骤S305。由于上述介绍的通讯时序中，要求从设备需要在特定时间以后再给出应答信号，否则主设备未准备好不能接收应答信号；因此，计时器溢出，表示主设备准备好接收应答信号，此时再执行步骤S305；否则重新查询计时器状态，等待计时器溢出。S305：发送应答信号。S306：在发送应答信号的过程中，配置接收缓冲寄存器。接收缓冲寄存器，用来存放接收到的指令。接收缓冲寄存器的长度具体可以依据上一条指令信号设置，也可以设为默认值。S307：配置接收格式寄存器。接收格式寄存器，用来解析接收到的指令，例如依据预期接收指令格式，能够得知下一指令周期中将启动的模块，则可以令这些模块提前做准备，更快更有效地解析并执行指令。同样地，接收指令格式具体可以依据上一条指令信号设置，也可以设为默认值。S308：在第一时刻，重新配置接收中断寄存器。重新配置接收中断寄存器，是因为在指令接收过程、指令处理过程以及返回应答信号过程中时，不应启动接收中断寄存器，防止发生冲突。因此优选地，接收中断寄存器排在最后一个进行配置，即发送应答信号即将完成时的第一时刻。第一时刻通过总应答时钟数减去配置接收中断寄存器需要的时钟数获得。S309：判断应答信号是否发送完毕，如果是，执行步骤S310。S310：开启接收中断寄存器。发送应答信号过程结束，则启动接收中断寄存器，不影响通讯过程的同时，表示该轮指令周期完成，以便与下一指令进行区分。S311：控制从设备进入省电模式。顾名思义，控制从设备进入省电模式，能够节省电能消耗。由于接收寄存器已经配置完毕，等待接收主设备发送下一个指令信号的过程中，从设备无其他动作，因此可以进入省电模式。为了更加直观地体现上述7816通讯过程，下面提供两部分的时序图。参见图4，该图为本申请实施例提供的一种7816接收指令信号和处理指令信号的时序图。图4中，CLK表示时钟信号；SIO表示7816通讯协议的SIO端口，SIO下降沿直至下一上升沿期间，表示SIO端口正在进行指令接收。exec表示处理指令信号的开始；exec_bus表示处理指令的过程。tcon表示计时器开始计数，可以看出，计时器与处理指令信号是同步开始的；tcnt表示计时器的计数过程；tcts表示计时器溢出。计时器溢出后，若指令信号处理完毕，则进行后续的发送应答信号。参见图5，该图为本申请实施例提供的一种7816发送应答信号的时序图。图5中，CLK表示时钟信号；SIO表示7816通讯协议的SIO端口，SIO下降沿直至下一上升沿期间，表示SIO端口正在进行应答信号的发送。具体地，send表示应答信号发送的开始；send_data表示应答信号的发送过程；send_over表示应答信号发送的结束。可以看出，这三个send相关的时序与SIO发送应答信号的时序相对应。evet1表示配置接收缓冲寄存器；evet2表示配置接收格式寄存器；evet3表示配置接收中断寄存器；mcu_idle表示从设备进入省电模式。图中竖着的双波浪线表示省略，即中间可能存在较长的发送过程，但为了体现开始与结束，对中间部分进行了省略。下面以一种可能的具体实现方式为例，说明本申请实施例提供的提高7816通讯速率的方法的效果。当7816通讯时设置1ETU=16CLK时，从设备返回的应答信号为1byte数据时，即8ETU，则发送应答信号用时16×8=128CLK。在发送应答信号过程中，同步配置的准备寄存器有接收格式寄存器、接收缓冲寄存器和接收中断寄存器；其中，配置接收缓冲寄存器的过程中，写地址用时4CLK，写长度用时4CLK；配置接收格式寄存器用时4CLK；配置接收中断寄存器的过程中，配置终端类型用时4CLK，配置中断优先级用时4CLK，配置中断引起的事件用时4CLK。综上，配置准备寄存器共需用时24CLK。若发送应答信号与配置准备寄存器串行处理，则需要用时152CLK；但并行处理，能够节省24CLK，提升了大约16%的通讯效率。为了使本申请提供的方案提高通讯速率效果更加明显，在一些实施例中，可以通过PPS协商，提高7816原有的通讯速率，即降低ETU与CLK的比值。ETU与CLK的比值降低后，配置准备寄存器的时间与发送应答信号的时间在一个数量级，并行处理提高的通讯效率更加明显。下面以一种可能的具体指令为例，介绍本申请实施例提供的提高7816通讯速率的方法的具体应用。主设备发送的指令信号为：00 58 00 02 08；从设备发送的应答信号为：58。主设备的指令信号中：“58”表示写指令，“02”表示按word写，“08”表示下一条指令长度为08byte。从设备的应答信号中：“58”表示准备好了。应该理解，从设备应答的“58”，是对于写指令动作准备好了，仅是一种应答信号，与上述实施例提及的准备接收下一指令或主设备准备好接收应答信号等提及的准备有所不同。对应于图3中的步骤S306-S308，在从设备发送“58”的同时，还需执行以下配置：配置下一条指令接收缓冲寄存器的长度为08；配置下一条指令格式为“58”写操作：准备写操作将启动的被写存储的时钟；准备配置接收地址的寄存器；准备配置接收数据的寄存器；根据写操作的模式，准备写时序。当下一条指令到来时，启动上述至的配置操作。配置接收中断寄存器。以上实施例仅是一种指令信号具体是写指令的实现方式，当指令为其他操作时，对应地，需要配置相应指令会启动的模块做好准备。应该理解，在其他可能的实现方式中，准备寄存器可能仅包括上述实施例提到的接收格式寄存器、缓冲寄存器和接收中断寄存器其中的一种；或者是未提及种类的准备寄存器；但其实施方式可以参照以上实施例。基于以上实施例提供的提高7816通讯速率方法，本申请实施例还提供一种提高7816通讯速率装置，下面结合附图进行详细介绍。参见图6，该图为本申请实施例提供的一种提高7816通讯效率的装置的示意图。本申请实施例提供的提高7816通讯效率的装置，包括：接收模块100、处理模块200、发送模块300和配置模块400。接收模块100，用于接收主设备发出的指令信号。处理模块200，用于对接收模块的指令信号进行处理，获得应答信号。发送模块300，用于在检测到主设备准备好接收应答信号时，发送应答信号。具体地，当主设备准备好接收应答信号表现为主设备发出指令信号后超过预设时间再接收应答信号时，处理模块200还用于对指令信号进行处理的同时，设置计时器；计时器的时间为预设时间。对应地，发送模块300具体用于：查询计时器的状态，如果为溢出，发送应答信号；否则重新查询计时器的状态。配置模块400，用于在发送模块发送应答信号的过程中，同时为接收下一个指令信号配置准备寄存器。由于7816的相关时序要求中，对于从设备给终端应答后，到下一条主设备给从设备的指令的起始位之间的时序均没有约定；因此，从设备应答和准备接收下一个指令信号之间的动作并行执行，可以有效提升7816通讯效率；避免这两个动作依次执行，存在时间浪费。其中，准备寄存器是指接收下一个指令信号时所要用到的寄存器，具体可以为各种各样的类型，本申请对此不做具体限定。例如：准备寄存器具体可以是接收中断寄存器，还可以是接收格式寄存器，也可以是接收缓冲寄存器等等。当然，具体可以是一种准备寄存器的配置与发送应答信号同时执行；也可以是多种准备寄存器的配置均与发送应答信号的过同时执行。本申请实施例提供的提高7816通讯速率的装置，包括：接收模块、处理模块、发送模块和配置模块。接收模块接收主设备发出的指令信号；处理模块对指令信号进行处理，获得应答信号；发送模块在检测到主设备准备好接收应答信号时，发送应答信号，配置模块在发送应答信号的过程中，同时为接收下一个指令信号配置准备寄存器。由于配置准备寄存器所需要的时间低于发送应答信号所需要的时间，并且发送应答信号与接收下一个指令信号之间无时序要求；因此本申请实施例提供的提高7816通讯速率的装置，配置模块与发送模块将配置准备寄存器与发送应答信号同时进行，能够节省单独配置准备寄存器的时间，提高7816协议的通讯速率。参见图7，该图为本申请实施例提供的另一种提高7816通讯效率的装置的示意图。与以上实施例相同地，本实施例提供的提高7816通讯效率的装置也包括：接收模块100、处理模块200、发送模块300和配置模块400。在本实施例中，准备寄存器具体包括：接收中断寄存器、接收格式寄存器和接收缓冲寄存器。对应地，配置模块400，具体用于在发送应答信号的过程中，配置接收格式寄存器；配置接收缓冲寄存器；在发送应答信号过程中的第一时刻，重新配置接收中断寄存器。其中，第一时刻通过总应答时钟数减去配置接收中断寄存器需要的时钟数获得。由于重新配置接收中断寄存器，是为了在指令接收过程、指令处理过程以及返回应答信号过程中时，不应启动接收中断寄存器，防止发生冲突；因此接收中断寄存器优选地应该放到最后进行配置。以上所描述的装置实施例仅仅是示意性的，例如，所述模块的划分，仅仅为一种逻辑功能划分，实际实现时可以有另外的划分方式，例如多个模块可以结合或者某个模块可以进一步划分出多个模块等等。需要说明的是，本说明书中各个实施例采用递进的方式描述，每个实施例重点说明的都是与其他实施例的不同之处，各个实施例之间相同相似部分互相参见即可。对于实施例公开的系统或装置而言，由于其与实施例公开的方法相对应，所以描述的比较简单，相关之处参见方法部分说明即可。对所公开的实施例的上述说明，使本领域专业技术人员能够实现或使用本申请。对这些实施例的多种修改对本领域的专业技术人员来说将是显而易见的，本文中所定义的一般原理可以在不脱离本申请的精神或范围的情况下，在其它实施例中实现。因此，本申请将不会被限制于本文所示的这些实施例，而是要符合与本文所公开的原理和新颖特点相一致的最宽的范围。
