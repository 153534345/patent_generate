标题title
基于新型PoM共识算法的分布式账本系统及方法
摘要abst
本发明提供了一种基于新型PoM共识算法的分布式账本方法及系统，包括：步骤S1：从所有候选节点中随机选择预设个热候选节点；步骤S2：在leader选举中，消费节点通过向若干个热候选节点提交合法交易数据从而支持相应的热候选节点，当热候选节点收集到的合法交易数据满足预设要求时，则当前热候选节点为leader节点；步骤S3：将消费节点通过向热候选节点提交合法交易数据从而支持热候选节点的信息整合为合法的Avalon区块数据，并保存在新的合法区块中，在P2P网络中通过调用gossip传输协议广播当前区块，从而实现一个新的合法区块被各节点达成共识。
权利要求书clms
1.一种基于新型PoM共识算法的分布式账本方法，其特征在于，包括：步骤S1：从所有候选节点中随机选择预设个热候选节点；步骤S2：在leader选举中，消费节点通过向若干个热候选节点提交合法交易数据从而支持相应的热候选节点，当热候选节点收集到的合法交易数据满足预设要求时，则当前热候选节点为leader节点；步骤S3：将消费节点通过向热候选节点提交合法交易数据从而支持热候选节点的信息整合为合法的Avalon区块数据，并保存在新的合法区块中，在P2P网络中通过调用gossip传输协议广播当前区块，从而实现一个新的合法区块被各节点达成共识。2.根据权利要求1所述的基于新型PoM共识算法的分布式账本方法，其特征在于，所述合法交易数据采用：只有当消费节点完成预设消费节点PoW共识时，交易才被视为符合预设要求，属于合法交易数据；所述消费节点PoW共识是当候选节点执行leader选举时，消费节点则需要通过消费节点PoW输出相应的提交合法交易数据，并在leader选举过程中提交给相应的候选节点。3.根据权利要求2所述的基于新型PoM共识算法的分布式账本方法，其特征在于，将leader选举和消费节点PoW共识解耦，从而削弱了安全性和出块间隔的相关性，提高吞吐量，降低交易的延迟。4.根据权利要求1所述的基于新型PoM共识算法的分布式账本方法，其特征在于，所述步骤S1采用：步骤S1.1：在每个周期T内从所有候选节点中通过VRF的leader选举方案随机选择预设个热候选节点，并将其他的候选节点设为冷候选节点；步骤S1.2：消费节点向热候选节点提交合法交易数据从而支持当前的热候选节点，当消费节点判断当前热候选节点是恶意的或离线时，则消费节点向随机选择的冷候选节点提交合法交易数据。5.根据权利要求4所述的基于新型PoM共识算法的分布式账本方法，其特征在于，所述消费节点判断当前热候选节点是恶意的或离线采用：当预设时间后热候选节点均未发布新区块，则消费节点确定热候选节点均已离线。6.一种基于新型PoM共识算法的分布式账本系统，其特征在于，包括：模块M1：从所有候选节点中随机选择预设个热候选节点；模块M2：在leader选举中，消费节点通过向若干个热候选节点提交合法交易数据从而支持相应的热候选节点，当热候选节点收集到的合法交易数据满足预设要求时，则当前热候选节点为leader节点；模块M3：将消费节点通过向热候选节点提交合法交易数据从而支持热候选节点的信息整合为合法的Avalon区块数据，并保存在新的合法区块中，在P2P网络中通过调用gossip传输协议广播当前区块，从而实现一个新的合法区块被各节点达成共识。7.根据权利要求6所述的基于新型PoM共识算法的分布式账本系统，其特征在于，所述合法交易数据采用：只有当消费节点完成预设消费节点PoW共识时，交易才被视为符合预设要求，属于合法交易数据；所述消费节点PoW共识是当候选节点执行leader选举时，消费节点则需要通过消费节点PoW输出相应的提交合法交易数据，并在leader选举过程中提交给相应的候选节点。8.根据权利要求7所述的基于新型PoM共识算法的分布式账本系统，其特征在于，将leader选举和消费节点PoW共识解耦，从而削弱了安全性和出块间隔的相关性，提高吞吐量，降低交易的延迟。9.根据权利要求6所述的基于新型PoM共识算法的分布式账本系统，其特征在于，所述模块M1采用：模块M1.1：在每个周期T内从所有候选节点中通过VRF的leader选举方案随机选择预设个热候选节点，并将其他的候选节点设为冷候选节点；模块M1.2：消费节点向热候选节点提交合法交易数据从而支持当前的热候选节点，当消费节点判断当前热候选节点是恶意的或离线时，则消费节点向随机选择的冷候选节点提交合法交易数据。10.根据权利要求9所述的基于新型PoM共识算法的分布式账本系统，其特征在于，所述消费节点判断当前热候选节点是恶意的或离线采用：当预设时间后热候选节点均未发布新区块，则消费节点确定热候选节点均已离线。
说明书desc
技术领域本发明涉及区块链技术领域，具体地，涉及基于新型PoM共识算法的分布式账本系统及方法。背景技术中本区块链是许多现有分布式账本系统中最典型的例子，但其背后的区块链技术是必不可少的。其核心目标是让用户在没有可信第三方的情况下，就公共账本达成共识。Nakamoto共识，中本区块链的核心共识算法，使用工作量证明使计算节点的成本非常高，从而确保整个系统共识的安全性。Nakamoto共识认为只要系统中恶意计算节点的算力不超过全网总算力的50％，那么该系统就是有效安全的，不过后来的工作揭示了Nakamoto共识的一些缺点和潜在攻击。除了这些攻击和漏洞之外，Nakamoto共识的可用性相较于当前的线上交易需求来说也很差——平均每秒钟只能处理7笔交易，并且平均交易确认延迟高达一小时。另外，PoW型区块链还面临去中心化的挑战。Proof-of-Stake和PoW的leader选举已经显现出明显的“中心化倾向”与“不公平”，过度的中心化也非常容易导致一些安全性问题。虽然传统的BFT类协议是完全去中心化的，但它们限制节点自由加入或退出系统，并且很容易被DDoS攻击破坏。目前，许多高性能的共识算法协议都是基于以上两大类共识方案，然而它们都或多或者存在一些缺陷和不足，PoW类方案则是把系统效率和安全性过度耦合造成性能瓶颈；而BFT则无法适用于大网络多节点共识环境，且需要额外的节点验证机制才能防止例如DDoS、Sybil类型的恶意攻击。经典区块链存在诸多不足，讨论最多的应该是可扩展性问题。为此，学界和工业界还提出了许多解决方案，例如中本区块链-NG；中本区块链-NG引入了“key block”和“microblock”的概念，key block使用经典的PoW进行leader选举，microblock用于存储交易。并且为了防止双花攻击，中本区块链-NG引入了“毒药交易”机制。然而，它仍然将PoW与leader节点选举联系起来，并且引入了额外的复杂共识机制，这将在极端情况下大大降低其效率。此外，对PoW的一些修改并没有改变PoW的本质。专利文献CN110300969A公开了一种技术，包括：在用于根据基于投票的共识算法操作的分布式账本网络的已有节点处，识别分布式账本网络的新候选节点，其中，所述识别是基于与分布式账本网络无关的已有的唯一标识符而进行的。发明内容针对现有技术中的缺陷，本发明的目的是提供一种基于新型PoM共识算法的分布式账本系统及方法。根据本发明提供的一种基于新型PoM共识算法的分布式账本方法，包括：步骤S1：从所有候选节点中随机选择预设个热候选节点；步骤S2：在leader选举中，消费节点通过向若干个热候选节点提交合法交易数据从而支持相应的热候选节点，当热候选节点收集到的合法交易数据满足预设要求时，则当前热候选节点为leader节点；步骤S3：将消费节点通过向热候选节点提交合法交易数据从而支持热候选节点的信息整合为合法的Avalon区块数据，并保存在新的合法区块中，在P2P网络中通过调用gossip传输协议广播当前区块，从而实现一个新的合法区块被各节点达成共识。优选地，所述合法交易数据采用：只有当消费节点完成预设消费节点PoW共识时，交易才被视为符合预设要求，属于合法交易数据；所述消费节点PoW共识是当候选节点执行leader选举时，消费节点则需要通过消费节点PoW输出相应的提交合法交易数据，并在leader选举过程中提交给相应的候选节点。优选地，将leader选举和消费节点PoW共识解耦，从而削弱了安全性和出块间隔的相关性，提高吞吐量，降低交易的延迟。优选地，所述步骤S1采用：步骤S1.1：在每个周期T内从所有候选节点中通过VRF的leader选举方案随机选择预设个热候选节点，并将其他的候选节点设为冷候选节点；步骤S1.2：消费节点向热候选节点提交合法交易数据从而支持当前的热候选节点，当消费节点判断当前热候选节点是恶意的或离线时，则消费节点向随机选择的冷候选节点提交合法交易数据。优选地，所述消费节点判断当前热候选节点是恶意的或离线采用：当预设时间后热候选节点均未发布新区块，则消费节点确定热候选节点均已离线。根据本发明提供的一种基于新型PoM共识算法的分布式账本系统，包括：模块M1：从所有候选节点中随机选择预设个热候选节点；模块M2：在leader选举中，消费节点通过向若干个热候选节点提交合法交易数据从而支持相应的热候选节点，当热候选节点收集到的合法交易数据满足预设要求时，则当前热候选节点为leader节点；模块M3：将消费节点通过向热候选节点提交合法交易数据从而支持热候选节点的信息整合为合法的Avalon区块数据，并保存在新的合法区块中，在P2P网络中通过调用gossip传输协议广播当前区块，从而实现一个新的合法区块被各节点达成共识。优选地，所述合法交易数据采用：只有当消费节点完成预设消费节点PoW共识时，交易才被视为符合预设要求，属于合法交易数据；所述消费节点PoW共识是当候选节点执行leader选举时，消费节点则需要通过消费节点PoW输出相应的提交合法交易数据，并在leader选举过程中提交给相应的候选节点。优选地，将leader选举和消费节点PoW共识解耦，从而削弱了安全性和出块间隔的相关性，提高吞吐量，降低交易的延迟。优选地，所述模块M1采用：模块M1.1：在每个周期T内从所有候选节点中通过VRF的leader选举方案随机选择预设个热候选节点，并将其他的候选节点设为冷候选节点；模块M1.2：消费节点向热候选节点提交合法交易数据从而支持当前的热候选节点，当消费节点判断当前热候选节点是恶意的或离线时，则消费节点向随机选择的冷候选节点提交合法交易数据。优选地，所述消费节点判断当前热候选节点是恶意的或离线采用：当预设时间后热候选节点均未发布新区块，则消费节点确定热候选节点均已离线。与现有技术相比，本发明具有如下的有益效果：1、本发明虽然仍然需要执行PoW操作，但PoM将其离散化到消费节点节点级别，解耦了系统的安全性和效率，使两者均得到了提升，并且合理地利用了PoW为攻击者增加了成本。2、本发明首次采用了VRF&amp;BFT机制，它使用可验证的随机数来确保leader节点选举的数学公平性。3、本发明可以作为底层共识机制服务于分片和侧链，以得到更大的提升。4、本发明综合考虑了效率、公平性、去中心化和节能，并试图打破经典区块链面临的诸多限制。PoM本质上是一种新型的PoW共识，但它将“hash运算”的工作从区块生产者转移到消费节点。再加上合理的激励机制，使得恶意节点的攻击无利可图。在理性攻击者的假设下，具有更好的性能和去中心化性，并充分考虑了消费节点的意愿。面对非理性的攻击者，安全性不亚于相同配置的PoW型区块链。附图说明通过阅读参照以下附图对非限制性实施例所作的详细描述，本发明的其它特征、目的和优点将会变得更明显：图1为Avalon系统架构图。图2为Avalon的leader选举过程示意图。图3为消费节点的合法vote结构图。图4为Avalon的激励机制示意图。图5为参数TAT与Avalon系统的吞吐量之间的关系实验图。图6为参数dc与Avalon系统的吞吐量之间的关系实验图。图7为TAT与交易确认延迟的关系实验图。图8为dc与交易确认延迟的关系实验图。图9为TAT与交易回滚率的关系实验图。图10为dc与交易回滚率的关系实验图。图11为TAT与分叉数量和高度的关系实验图。图12为dc与分叉数量和高度的关系实验图。具体实施方式下面结合具体实施例对本发明进行详细说明。以下实施例将有助于本领域的技术人员进一步理解本发明，但不以任何形式限制本发明。应当指出的是，对本领域的普通技术人员来说，在不脱离本发明构思的前提下，还可以做出若干变化和改进。这些都属于本发明的保护范围。实施例1根据本发明提供的一种基于新型PoM共识算法的分布式账本方法，包括：步骤S1：从所有候选节点中随机选择预设个热候选节点；所述步骤S1具体采用：步骤S1.1：在每个周期T内从所有候选节点中通过VRF的leader选举方案随机选择预设个热候选节点，并将其他的候选节点设为冷候选节点；步骤S1.2：消费节点向热候选节点提交合法交易数据从而支持当前的热候选节点，当消费节点判断当前热候选节点是恶意的或离线时，则消费节点向随机选择的冷候选节点提交合法交易数据。其中，所述消费节点判断当前热候选节点是恶意的或离线具体采用：当预设时间后热候选节点均未发布新区块，则消费节点确定热候选节点均已离线。步骤S2：在leader选举中，消费节点通过向若干个热候选节点提交合法交易数据从而支持相应的热候选节点，当热候选节点收集到的合法交易数据满足预设要求时，则当前热候选节点为leader节点；步骤S3：将消费节点通过向热候选节点提交合法交易数据从而支持热候选节点的信息整合为合法的Avalon区块数据，并保存在新的合法区块中，在P2P网络中通过调用gossip传输协议广播当前区块，从而实现一个新的合法区块被各节点达成共识。具体地，所述合法交易数据采用：只有当消费节点完成预设消费节点PoW共识时，交易才被视为符合预设要求，属于合法交易数据；所述消费节点PoW共识是当候选节点执行leader选举时，消费节点则需要通过消费节点PoW输出相应的提交合法交易数据，并在leader选举过程中提交给相应的候选节点。具体地，将leader选举和消费节点PoW共识解耦，从而削弱了安全性和出块间隔的相关性，提高吞吐量，降低交易的延迟。根据本发明提供的一种基于新型PoM共识算法的分布式账本系统，包括：模块M1：从所有候选节点中随机选择预设个热候选节点；所述模块M1具体采用：模块M1.1：在每个周期T内从所有候选节点中通过VRF的leader选举方案随机选择预设个热候选节点，并将其他的候选节点设为冷候选节点；模块M1.2：消费节点向热候选节点提交合法交易数据从而支持当前的热候选节点，当消费节点判断当前热候选节点是恶意的或离线时，则消费节点向随机选择的冷候选节点提交合法交易数据。其中，所述消费节点判断当前热候选节点是恶意的或离线具体采用：当预设时间后热候选节点均未发布新区块，则消费节点确定热候选节点均已离线。模块M2：在leader选举中，消费节点通过向若干个热候选节点提交合法交易数据从而支持相应的热候选节点，当热候选节点收集到的合法交易数据满足预设要求时，则当前热候选节点为leader节点；模块M3：将消费节点通过向热候选节点提交合法交易数据从而支持热候选节点的信息整合为合法的Avalon区块数据，并保存在新的合法区块中，在P2P网络中通过调用gossip传输协议广播当前区块，从而实现一个新的合法区块被各节点达成共识。具体地，所述合法交易数据采用：只有当消费节点完成预设消费节点PoW共识时，交易才被视为符合预设要求，属于合法交易数据；所述消费节点PoW共识是当候选节点执行leader选举时，消费节点则需要通过消费节点PoW输出相应的提交合法交易数据，并在leader选举过程中提交给相应的候选节点。具体地，将leader选举和消费节点PoW共识解耦，从而削弱了安全性和出块间隔的相关性，提高吞吐量，降低交易的延迟。实施例2本发明提供的基于新型PoM共识算法的分布式账本系统，包括：假设hash函数作为随机预言机，任何节点都可以进行PoW操作，并且这个过程在单位时间内的所有消耗对于任何节点都是均等的，即任何节点都可以用同样的钱购买获得同等质量的“PoW计算服务”。本发明具有标准密码学假设。任何节点都可以获得正确且合法的创世区块。任何节点都有一个固定的身份：消费者或候选者。消费节点产生交易并提交给候选节点，leader选举将在候选节点中选出一个当前轮的leader。然后leader节点打包并广播合法区块。此外，所有节点也根据属性分为诚实节点和恶意节点。网络模型网络中有N个节点，并且认为诚实节点形成了一个连接良好的同步点对点覆盖网络，并且系统中需要传输的任何消息的大小是固定的。因此，当一个诚实节点广播或传输消息时，任何其他诚实节点的接收延迟的上限也是固定的，并记为Δ。且所有消息都通过gossip协议在诚实节点之间传输。威胁模型本发明容忍所有恶意节点的计算能力不到总网的1/3。恶意节点的行为可以任意地偏离我们的协议。此外，恶意节点可以破坏任意的诚实候选节点，但它们不能破坏诚实消费节点节点。然而，恶意节点可以创建任意数量的恶意消费节点。此外，他们不能在多项式时间内破解我们的标准密码学假设。消费节点偏好消费节点对于候选节点的选择都有一定的偏好，并且这是其他区块链协议没有考虑的。假设代表消费节点节点i∈对候选节点j∈的偏好程度，则表示i偏好j多于k。并且我们定义LCPi为i根据他的偏好对所有候选节点进行排序的列表。本发明需要实现高吞吐量、低交易延迟、一定的可扩展性、低候选阈值、简单性、有效性和安全性，具体说明如下：有效性和安全性：诚实消费节点的交易最终会得到本发明中区块链的确认；本发明可以抵御双花攻击、Sybil攻击以及SPOF类攻击。吞吐量：当网络的规模、带宽等系统参数确定后，将单位时间内系统确认的平均交易数定义为系统的吞吐量。本发明则需要最大限度地提高系统吞吐量。交易延迟：当网络的规模、带宽等系统参数确定后，交易延迟定义为从交易产生起直到交易最终在区块链上被确认所经过的时间。本发明则需要尽可能地减少交易延迟。可扩展性：本发明需要解决PoW型共识中安全性和可扩展性之间的冲突和耦合，并保证在不牺牲安全性的情况下尽可能提高可扩展性。此外，本发明应该能够嵌入其他分片协议和第2层协议以实现“scale-out”。候选节点门槛和去中心化：在本发明中，候选节点承担验证者的义务，即，候选节点的门槛意味着加入共识机制的条件。本发明需要尽可能降低此门槛以实现更高度的去中心化，同时确保不牺牲安全性。消费节点偏好：令为候选j的受欢迎程度，那么Avalon系统需要满足：“j节点成为leader节点”的概率与j的受欢迎程度呈现正相关关系。为了解决上述问题，本发明介绍Avalon方案，一种新颖的分布式共识协议。Avalon将PoW共识和leader选举解耦，大大削弱了安全性和出块间隔的相关性，提高了系统吞吐量，降低了交易延迟。Avalon的共识机制——Proof-of-Market，允许市场和消费节点决定leader选举的结果，PoM不需要任何其他共识的协助，这使得它的代码实现非常简单。并且在相同的环境条件下，Avalon与中本区块链一样安全。Avalon的核心内容—PoM分为leader选举和消费节点PoW。在leader选举中，消费节点通过向他支持的候选节点提交合法交易数据来表示他在leader选举中支持此候选节点，即，合法交易数据被视为“选票”。只有收集了预定数量的vote的候选节点才能成为leader节点。消费节点PoW是为了防止恶意行为，它要求只有当消费节点完成指定消费节点PoW时，交易才被视为合法vote。本发明提供了一组激励来匹配PoM，并证明了恶意的攻击在统计学意义上是无利可图的。值得注意的是，即使有不理智的攻击者坚持攻击，他的攻击也不会比攻击相同设置下的PoW类区块链的难度要小，因为PoW和PoM具有相同的防御机制和防御特性。非理性攻击只会影响公平和去中心化。而且Avalon协议拥有比PoW类区块链更大的可控空间，比如通过调整PoM的一些参数来抑制自然分叉率。总之，PoM实现了PoW类区块链的安全性，同时体现了消费节点和市场在leader选举方面的意愿，分析表明，PoM机制可以有效抑制区块传输延迟对区块间隔和安全性的约束。因此，PoM优化了Avalon系统的吞吐量、交易延迟、去中心化、公平性以及能耗。此外，通过omnetpp模拟了一个p2p网络，它具有30Mbps的带宽和100毫秒的延迟，其中包含超过1,000个分布式对等节点。实验检测了方案的各个参数对Avalon性能的影响。结果表明，在大多数参数设置下，Avalon可以实现出色的吞吐量和交易延迟。因此，在相似的网络环境下，Avalon的吞吐量达到了10×中本区块链-NG、5×ByzCoin和4×Algorand的水平，其交易延迟也达到了与Algorand相同的水平，并是中本区块链-NG和ByzCoin的一半。Avalon系统中上链的交易在等待3个区块后的回滚率为0％，在Avalon区块链中，几乎没有高度超过1的分叉，说明该方案具有较高的安全性。并且Avalon在所有参数设置下都保持了出色的去中心化。Avalon系统设计方案图1展示了Avalon的分层系统架构。在数据层，Avalon的区块链的数据结构和传统的中本区块链类似，但原本的交易信息被vote信息替代。Avalon区块链由一个个Avalon区块构成，Avalon区块则包括vote信息、候选节点deposit信息、leader数字签名等，其中vote信息还包括：UTXO交易信息、消费节点PoW证明、消费节点数字签名、前块哈希指针等。在网络层，Avalon采用了gossip传输协议，保证消息在分布式网络中的可靠广播。在共识和激励层，提出了Avalon的核心共识算法——PoM机制，并辅以基于博弈论的激励策略以及冷热候选节点机制完成了共识激励的任务。各层级模块之间的关系如下，系统中的所有候选节点运行Avalon的leader选举模块；同时消费节点执行消费节点PoW模块，消费节点PoW需要输入UTXO交易信息，其可输出合法的vote信息，消费节点将合法的vote信息提交给相应的候选节点；leader选举的输出，即，成为leader的节点，将收集到的vote信息整合为合法的Avalon区块数据，并调用gossip传输协议广播此区块。至此，一个新的合法Avalon区块在系统中被各节点达成共识。市场证明机制PoM共识机制包括vote、选举和区块广播。消费节点的PoW构成了vote机制。与经典的leader选举不同，提出了“一票多投”机制，其消除了PoW机制对于系统吞吐量的限制并简化了我们的协议。消费节点使用他们提交的交易数据作为vote来选择他们最喜欢的候选节点作为leader节点，而消费节点PoW产生的成本可以过滤掉恶意节点。候选节点的leader选举下一任leader节点的选举将在前任leader节点上任后立即进行。这是一个不间断的过程。图2展示了Avalon系统中的选举过程，具体内容如下：首先，在一轮选举中，所有参加选举的候选节点“冻结”其本地账本中的一定数量的数字资产$d作为“押金”，然后将此信息进行数字签名并广播。收到此消息的消费节点可以根据$d的数值及其他因素选择他们支持的候选节点并将本地的交易数据提交给他。注意，$d是暂时从候选节点的账本中冻结的，除非leader竞选失败，否则候选节点不能使用、转移此deposit。如果候选节点成为leader，那么$d将被分发给此前提交过交易信息给他的消费节点，具体的分发金额数目则是与消费节点提交的交易的金额成正比。候选节点可以在前一轮leader节点广播区块后立即进行下一轮leader选举，并将其deposit$d值广播到网络中。当候选节点i本轮收集的总交易额tai达到某个阈值后，他将立即验证所有收集到的交易。如果没有其他候选节点早于i达到阈值，那么他将立即打包并广播所有合法交易。收到区块的候选节点知道自己在本轮选举中失败，便可立即加入下一轮选举。在leader选举中隐藏了很多细节，这里我们首先描述候选节点需要收集的交易金额阈值TAT。如果前一个leader节点l收集的交易金额为tal，则下一位leader的交易金额至少为λtal。系数λ在某种程度上相当于中本区块链系统中的hash运算难度，λ受此期间市场的交易量和趋势控制，例如,前任领先者的交易额为tal＝100，当前市场的需求在上升阶段，λ＝1.07，那么下一个leader收集的交易额一定大于107。λ的主要作用是控制区块的间隙。消费节点PoW方案当候选节点在执行leader选举时，消费节点则需要通过消费节点PoW输出相应的vote数据以在leader选举中提交给特定的候选节点，以此保证Avalon系统中leader选举过程的正常执行。具体方案如下：消费节点提交给候选节点的消息结构为：消费节点的数字签名、交易信息、最新区块的哈希信息、支持的候选数量和随机数x。这种类型的消息称为消费节点的vote，如图3所示。消费节点必须对其vote进行PoW操作，即，调整随机数x，使整个消费节点vote的哈希值、交易金额等数据满足当前的消费节点难度条件。只有在规定的消费节点难度下完成PoW的vote才是合法的。一票多投：Avalon系统不会阻止消费节点在一轮选举中将不同的vote提交给多位候选节点，只要他们提交的vote是合法的。消费节点PoW难度。类似于PoW型区块链的hash运算难度，dc就是消费节点进行PoW操作的难度。dc是与当前所有消费节点的总哈希能力相关的变量，且dc与消费节点提交的交易金额上界相关。但是，不同于PoW的hash运算难度的定义，这里我们从一个新的角度在定义1中对消费节点难度dc和消费节点PoW、交易金额等的关系进行定义，具体如下。定义1：基于前文的假设，如果节点投资了$PoW额度的资金用于消费节点PoW，且当前消费节点难度为dc，那么他可以合法化的预期交易金额的上限为dc$PoW。例如，如果一笔交易的金额是10单位货币，并且dc＝100，那么消费节点需要花费0.1单位货币来完成消费节点PoW所产生的成本才能使该交易合法。结合定义1，我们可以得出dc的一些特性：对于两笔不同的交易tx1和tx2，其金额分别为和那么对其合法化的消费节点PoW的成本也不同。若这些成本被量化为货币值，即和那么我们有和与PoW型区块链一样，Avalon中消费节点的算力也会不断变化，因此dc需要根据网络的总算力做出相应的变化，以保持计算时间的稳定。此外，消费节点PoW还需要保证消费节点PoW的成本线性，即当一笔交易tx被拆分为两部分tx1和tx2时，tx的消费节点PoW成本的期望值应该等于完成tx1和tx2的PoW的期望成本。而且这很容易实现：假设在一次哈希函数调用中，完成一单位货币交易的消费节点PoW的概率为p，那么在一次哈希函数调用中，完成s单位货币交易的消费节点PoW的概率应为实际上，PoM机制将hash运算与leader节点选举脱钩，避免了中心化和恶性的hash运算竞争。而消费节点PoW则使PoW具有“惩罚”攻击者的功能。激励机制消费节点PoM不足以使Avalon系统是激励相容的，因此我们需要引入配套的激励机制。运用博弈论是设置合理的激励机制的关键，下面我们介绍一下协议的整体激励机制。除了前面提到的交易金额的阈值TAT和消费节点PoW难度dc，如图4所示，Avalon还有以下两个参数：计算激励kt：当leader成功上链金额为$的交易时，消费节点应该给leader一定比例的交易金额作为“计算激励”，即kt$。这在中本区块链中也有类似的机制。延误惩罚kd：如果候选节点在选举中失败，他应该向在本轮选举中支持他的消费节点支付kd$作为交易的延误惩罚。延误费是对选举失败造成的交易延迟的一种“安慰”，可以防止一些恶意攻击，这在后面会进行详细分析。这kt和kd应满足以下关系：以及其中n表示系统内节点数；$0表示deposit数额；f表示当一个候选者广播$0数额的deposit时，可以获得的消费节点提交的vote数额的数学期望；dc表示消费节点PoW难度。计算激励和延误惩罚按照以下规则支付：我们要求候选节点在决定参加选举时向全网广播带有签名的deposit信息。如果候选节点获胜，则立即将收集到的交易打包并按比例向每个消费节点支付deposit，否则此交易集被视为非法的。由于全网对失败候选节点收集的交易没有达成共识，我们采用“索赔”机制来分配延误费。合法vote本身可以被视为一种“支票”，当此“支票”在未来被用于支付时，相应的金额将从失败的候选帐户中自动扣除。为防止候选节点资金短缺而无法支付延误费，我们可以规定候选节点在每次选举中必须冻结一定数额的“预付延误费”。如果候选节点获胜，则解冻，否则等待几轮后自动解冻。但只要候选节点处于选举状态，那么就必须保持一定数额的“预付延误费”。为了让延误费对Avalon有正向的激励作用，这就要求节点在消费节点PoW上的成本的数学期望大于他可以获得的延误费，即，冷热候选节点机制在前面对Avalon的描述中，所有候选节点都可以同时参与leader选举。但是，这种方法分散了消费节点的计算能力，并可能削弱Avalon的安全性。因此，我们引入热冷候选节点机制：Avalon系统的运行过程按照时间T进行分割，并分为若干个长度相等的周期。在每个周期T内，Avalon系统从所有候选节点中随机选择3个特殊候选节点，被称为热候选节点，其他候选节点则被称为冷候选节点。消费节点只能向热候选节点提交合法交易，除非消费节点判断热候选节点是恶意的或离线的。当消费节点判断热门候选节点是恶意的或离线时，消费节点可以提交合法vote给冷候选节点。这里我们解释一下冷热候选方案的一些细节。首先，每轮只选出3个热门候选，以确保所有消费节点的计算能力都集中在这三个候选上。因此，只要恶意节点的算力不超过全网算力的1/3，他就无法进行双花攻击。随机选择热门候选节点的过程在Algorand的委员会选举方案中有详细说明，该方案使用全局不可伪造且可验证的随机数来防止作弊。关于消费节点发现候选离线的方法：由于消费节点PoW的完成时间满足指数分布，随着时间的增加，热候选节点出块的概率会不断接近1。如果等待足够长的时间还没有热候选节点发布新块，则消费节点可以确定热候选节点均已离线。Gossip传输协议Gossip协议是一种典型的分布式消息传输协议，其底层一般采用UDP协议，其可以同时实现低负载，高可靠和可扩展性等性能，且简单而易于实现。Gossip协议内容大致如下，首先消息传输由一个种子节点发起，此种子节点先随机挑选出若干个邻居几点，并将需要同步的消息发送给它们。收到消息的节点则成为新的种子节点并重复上述过程，直到网络中的所有节点均接收到此消息。Gossip协议具有最终一致性，即，在理论上，总会存在一个时间节点，系统内所有节点在此节点之后均收到了需要同步的消息。分叉我们首先介绍Avalon区块链的链接规则：一个区块内的所有交易必须指向同一个前一个区块，该区块也是这个区块的父区块。因此，当分叉发生时，所有消费节点都需要选择合适的父区块，而候选节点也必须选择合适的消费节点。当分叉产生并且不同的网络分区产生不同的共识时，我们使用与PoW型区块链相同的解决方案：选择最长的链。区块间隔的缩短可能会导致分叉的增加。并且由于PoM的机制，分叉的概率在更大程度上取决于市场情况。例如，如果有一个“超级候选节点”，具有很强的吸引交易能力，那么分叉的概率非常低，因为其他候选节点很难与他几乎同时发布合法块。如果有多个相同受欢迎的候选节点，那么分叉的概率会增加。尽管如此，与区块链不同的是，在这种情况下，我们的协议仍然可以通过调整参数来影响分叉率。例如，我们可以调整dc、TAT或限制OVMI。Avalon伪代码本节我们用算法1中的伪代码来阐明Avalon的运行过程。算法1：Avalon主算法输入：交易金额阈值TAT、消费节点PoW难度dc、计算激励kt、计算激励kd。对于任意一个候选人j：步骤一：开始新一轮的leader选举，j广播自己的deposit信息$d；j收集消费节点的交易并验证其合法性；将所有合法交易添加到本轮j收集的交易集TX中。执行步骤二。步骤二：若∑tx∈TX$tx＞TAT且没有任何候选节点广播一个新的合法区块，其中$tx代表tx的金额，则执行步骤三，反之执行步骤四。步骤三：j立即签署、打包和广播所有交易；j向消费节点支付相应deposit，这些交易包含在TX中，并向消费节点收取交易税。执行步骤五。步骤四：若已有其他候选节点广播新的合法块，则j向本轮中所有提交vote给他的消费节点支付延误费。执行步骤五。步骤五：若j继续参加leader节点选举，则进入下一轮选举并执行步骤一，反之退出。对于任意的候选节点i：步骤一：若接收到新的合法区块b，i停止正在进行的操作并执行以下操作：i根据最新的区块链更新自己的未提交信息列表UTXi；i收集候选节点的deposit信息并调整LCPi。进入步骤二。步骤二：若从高到低遍历所有的候选节点j∈LCPi且j是热候选节点，则i从UTXi中选择最早的交易tx；i执行CPoW函数得到合法交易ltx＝CPoW。i将ltx提交给j。同时，i监听网络，是否收到新的合法区块，若收到则进入步骤一，反之继续执行步骤二。算法2：函数CPoW输入：消费节点i，候选节点j，前一个区块b，交易内容tx，消费节点PoW难度dc。输出：合法交易ltx。步骤一：产生随机数x；计算H＝HASH,tx,x)，其中HASH表示散列函数；如果H满足金额为$tx的交易对应的消费节点PoW难度dc，则执行步骤二，反之执行步骤一。步骤二：函数返回ltx＝sigi,tx,x＞)，其中sigi表示i的数字签名。Avalon的原型试验在本节中，我们评估Avalon的性能。我们特别关注交易的吞吐量、交易的确认延迟、交易的回滚率、链的收敛性和去中心化。此外，两个重要的变量是领导人选举的阈值TAT和消费节点PoWhash运算难度dc。注意，为了便于理解，我们这里重新定义了dc，即消费节点在单位时间内可以通过消费节点PoW合法化的一单位金额的交易次数，即,dc越大，节点的hash运算效率越高。我们指定TAT和dc的默认值是80,000和6。表1.Avalon实验参数及其说明表。参数解释说明交易吞吐量Avalon系统每秒确认的平均交易数。交易确认延迟交易自出现到被Avalon上链确认所经历的平均时长。交易的回滚率在若干区块后，交易因发送分叉而被回滚的概率。区块链的收敛性发生分叉时Avalon区块链需要等待收敛的块数。去中心化每个候选节点成功生产一个区块的概率。2.1原型实施我们通过omnetpp在模拟的p2p网络中实现了Avalon的原型。为了模拟真实的全局分布式网络，我们将节点之间所有连接的带宽限制为30Mbps，并在所有通信链路上施加100毫秒的延迟。并且为了模拟消费节点的交易，我们收集了中本区块链区块链中所有真实交易的集合，其来自高度从500,000到505,000的区块。我们的原型总共模拟了1,003个节点，包括1,000个消费节点节点和3个热点候选节点，每个消费节点每秒产生5个原始交易。交易吞吐量在这里，我们研究了TAT和dc在我们的实验设置下对Avalon吞吐量的影响。具体实验结果如图5和6所示，其中dc采用图5中的默认值，TAT采用图6中的默认值。TAT和dc的增加都对Avalon的吞吐量有积极的调节作用，但并不是很明显。Avalon在大多数参数设置下可以达到4,000TPS以上。这与Visa的平均吞吐量相当，在相同条件下远高于ByzCoin。交易确认延迟Avalon的平均TCD实验结果如图7、8所示。注意这里的TCD计算是基于等待6个区块才确认交易，即，我们使用中本区块链的标准确认模型。TAT与TCD呈明显正相关性，而dc对TCD几乎没有影响。其潜在的原因是阈值需要更多的交易，然而消费节点产生的交易频率是固定的，因此需要等待更长的时间。当dc≥3时，消费节点基本可以向所有三个热门候选提交信息，所以继续增加dc只能带来TCD的小幅提升。在大多数情况下，Avalon的TCD不会超过40s，在最好的情况下，交易可以在10s内得到确认。总的来说，Avalon的TCD远远超过了PoW型区块链的水平，与目前主流的区块链协议相当，这说明Avalon在达到了高实用性的同时，其延迟也是完全可以接受的。交易回滚率回滚率是衡量区块链协议的重要指标，直接关系到系统的安全性。PoM本质上是一种PoW类型的共识，因此Avalon还具有PoW型区块链的收敛性，这使得提交的交易在被确认后是不可变的。图9和10为相关实验结果，其中数据均取自高度超100的区块链。TAT和dc的增加可以有效抑制TRR。而仅仅当等待超过3个区块后再确认交易，则Avalon系统中不存在回滚现象。Avalon和中本区块链一样等待6个区块来确认交易，因此它的安全性非常高。区块链的收敛性链的收敛实验通过记录分叉的数量和高度来判断区块链的安全性。实验结果如图11、12所示。一般情况下，大多数分叉的高度为1，只有少数分叉达到高度2。增加TAT可以有效抑制分叉。比较图10和12可以发现，dc的增加可以抑制TRR但不影响分叉率。这是因为dc的增加允许消费节点将相同的交易提交给更多的候选节点，即使有回滚，交易也可以被其他候选节点的区块确认。去中心化去中心化实验检验了Avalon的公平性和安全性。如果区块间隔的缩小使得节点具有“抢跑”优势，那么系统的安全性将受到极大威胁。我们的实验结果如表2和3所示，其中所有实验数据均至少稳定运行3次获得，结果表明Avalon在不同的TAT和dc设置下保持良好的去中心化。热门候选人的胜率基本维持在25％～40％的区间内，TAT和dc的变化并没有带来明显的胜率波动。考虑到Avalon的TCD和带宽设置，同等条件下的PoW型区块链会有严重的拥塞和“抢跑”优势，但是Avalon却可以保证系统的正常运行。表2.热候选节点的胜率与阈值TAT的关系表。TAT20000400006000080000热候选节点130.20％28.60％29.50％25.60％热候选节点234.00％30.70％31.10％43.30％热候选节点335.80％40.70％39.40％31.10％表3.热候选节点的胜率与消费节点PoW难度dc的关系。dc46810热候选节点123.90％25.60％26.40％26.70％热候选节点237.50％43.30％34.10％33.30％热候选节点338.60％31.10％39.50％40.00％本领域技术人员知道，除了以纯计算机可读程序代码方式实现本发明提供的系统、装置及其各个模块以外，完全可以通过将方法步骤进行逻辑编程来使得本发明提供的系统、装置及其各个模块以逻辑门、开关、专用集成电路、可编程逻辑控制器以及嵌入式微控制器等的形式来实现相同程序。所以，本发明提供的系统、装置及其各个模块可以被认为是一种硬件部件，而对其内包括的用于实现各种程序的模块也可以视为硬件部件内的结构；也可以将用于实现各种功能的模块视为既可以是实现方法的软件程序又可以是硬件部件内的结构。以上对本发明的具体实施例进行了描述。需要理解的是，本发明并不局限于上述特定实施方式，本领域技术人员可以在权利要求的范围内做出各种变化或修改，这并不影响本发明的实质内容。在不冲突的情况下，本申请的实施例和实施例中的特征可以任意相互组合。
