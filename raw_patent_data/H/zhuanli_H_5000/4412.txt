标题title
一种非协作条件下的网络拓扑探测方法
摘要abst
本发明属于网络拓扑探测技术领域，具体涉及一种非协作条件下的网络拓扑探测方法。该方法有效补充了对不支持SNMP协议设备的探测。并针对特殊非协作不可探测节点，采用Traceroute绕过法，有效突破了非协作节点对网络拓扑发现的阻碍，同时也避免了大量采用Traceroute主动探测给网络带来较大负担以及探测效率低下的问题。
权利要求书clms
1.一种非合作条件下的网络拓扑探测方法，其特征在于：包括以下步骤：步骤一、预设需要探测的最大层数n，选择起始路由器并将其添加到探测队列，所述起始路由器拓扑层数为0，且起始路由器开启SNMP、OSPF、RIP中的一个；步骤二、采用广度优先搜索从探测队列头部取出路由器，若当前路由器层数大于预设层数n，则跳过当前路由器，取下一个路由器；反之，对其进行探测；步骤三、对当前路由器发送SNMP请求，判断是否支持SNMP探测；Ⅰ、若支持SNMP探测，则遍历路由表信息，对每一条记录中的ip Route Type值进行判断，以确定所连接的是子网还是路由；Ⅱ、若不支持SNMP探测，则对其发送OSPF的LSR报文，判断是否支持OSPF协议；1、若支持OSPF协议，获取Router LSA报文，遍历LSA报文中的信息，根据Type值进行判断；2、若不支持OSPF协议，则对其发送RIP协议请求报文，判断是否支持RIP协议；a、若支持RIP协议，对其发送RIP协议请求报文，获得该路由器的路由条目，遍历路由条目并判断metric的值；b、若不支持RIP协议，则将该路由器设备作为不可探测路由器，使用Traceroute突破法进行绕过，对探测得到拓扑路径进行整合，将可知路由器按照顺序添加到探测队列中；步骤四、重复步骤二至三，直到当前探测队列为空。2.根据权利要求1所述的非合作条件下的网络拓扑探测方法，其特征在于：步骤三中若支持SNMP，对每一条记录中的ip Route Type值进行判断所连接的是子网还是路由的规则为：若ip Route Type值为3，说明是路由器和子网的连接关系，将子网信息添加到网络拓扑记录中；若ip Route Type值为4，说明连接的下一跳是路由器设备，将对应的连接信息添加到网络拓扑记录中，然后将下一跳路由器IP添加到探测队列中，对其层数设置为当前路由器层数加1。3.根据权利要求1所述的非合作条件下的网络拓扑探测方法，其特征在于：步骤三中若支持OSPF协议，获取Router LSA报文，遍历LSA报文中的信息，根据Type值进行判断，具体的：若Type值为1或4，则表示下一跳与路由器连接，将对应的连接信息添加到网络拓扑记录中，然后将下一跳无重复路由器IP添加到探测队列中，对其层数设置为当前路由器层数加1；若Type值为3，说明是路由器和子网的连接关系，将子网信息添加到网络拓扑记录中；若Type值为2，则代表下一跳连接的是DR端口，对DR端口继续请求Network LSA，获得传输网的地址，添加到拓扑网络记录中，并根据传输网包含的路由器列表，将无重复路由器IP全都添加到探测队列中。4.根据权利要求1所述的非合作条件下的网络拓扑探测方法，其特征在于：步骤三中若支持RIP协议，对其发送RIP协议请求报文，获得该路由器的路由条目，遍历路由条目并判断metric的值，若metric为1，则目的地址表示与路由器直连的子网网段，将对应的连接信息添加到网络拓扑记录中；若metric大于1，则Nexthop表示与该路由器直接连接的路由器地址，将下一跳无重复路由器IP添加到探测队列中。
说明书desc
技术领域本发明属于网络拓扑探测技术领域，具体涉及一种非协作条件下的网络拓扑探测方法。背景技术随着互联网的快速发展，网络规模迅速扩大，网络结构愈加复杂，网络拓扑探测技术的应用愈加广泛，快速准确获取目标网络的拓扑环境，对于优化网络管理、定位网络资源和保障网络安全都具有重大意义。网络拓扑不仅能使使用者了解整个网络结构，对网络中的重要节点、数据流向等信息进行分析，而且可以对网络空间进行高效管理、合理分配资源以及有效的安全监测和防护。一般来说，网络拓扑探测分为逻辑拓扑发现和物理拓扑发现，分别对应于 OSI 参考模型中的网络层和链路层。其中，逻辑拓扑发现主要根据网络层 IP 地址来发现路由器与路由器之间的连接，路由器与子网之间的连接，使用 IP 地址建立网络实体的连接。物理拓扑发 现主要根据链路层的信息发现物理网络实体之间的连接，使用 Mac 地址建立网络实体的连接。现有的网络拓扑探测方法，大多是基于SNMP协议实现的，或是使用类Traceroute方法进行主动探测。其中SNMP是一种用来实现网络拓扑发现的互联网管理协议。SNMP协议是通过管理/代理的机制来实现对网络的拓扑发现，其思想是在网络节点中设置一个网络管理信息数据库，由节点的代理对它进行管理。管理者通过管理进程来使用 SNMP协议对代理的管理数据库进行访问，从而得到网络拓扑。它的特点是算法简单、网络开销小和得到的网络拓扑比较准确。Traceroute程序则是根据TTL来对目标节点进行拓扑路径探测。当且仅当TTL 字段大于1时，路由器将会继续转发收到的报文，否则将舍掉该报文，并向源节点发送一份包含路由器的IP地址的ICMP超时报文。源节点根据返回的信息将TTL加1，并继续给目标节点发送该探测报文，它能够准确地探测出源节点和目的节点之间完整的IP路径。然而面对非协作环境，即路由器关闭SNMP权限或禁止响应探测报文屏蔽Traceroute探测，网络探测就会面临信息缺失、探测受阻等问题。发明内容针对现有网络拓扑探测方法面对非协作环境时网络探测面临信息缺失、探测受阻的缺陷和问题，本发明提供一种非协作条件下的网络拓扑探测方法。本发明解决其技术问题所采用的方案是：一种非合作条件下的网络拓扑探测方法，包括以下步骤：步骤一、预设需要探测的最大层数n，选择起始路由器并将其添加到探测队列，所述起始路由器拓扑层数为0，且起始路由器开启SNMP、OSPF、RIP中的一个；步骤二、采用广度优先搜索从探测队列头部取出路由器，若当前路由器层数大于预设层数n，则跳过当前路由器，取下一个路由器；反之，对其进行探测；步骤三、对当前路由器发送SNMP请求，判断是否支持SNMP探测；Ⅰ、若支持SNMP探测，则遍历路由表信息，对每一条记录中的ip Route Type值进行判断，以确定所连接的是子网还是路由；Ⅱ、若不支持SNMP探测，则对其发送OSPF的LSR报文，判断是否支持OSPF协议；1、若支持OSPF协议，获取Router LSA报文，遍历LSA报文中的信息，根据Type值进行判断；2、若不支持OSPF协议，则对其发送RIP协议请求报文，判断是否支持RIP协议；a、若支持RIP协议，对其发送RIP协议请求报文，获得该路由器的路由条目，遍历路由条目并判断metric的值；b、若不支持RIP协议，则将该路由器设备作为不可探测路由器，使用Traceroute突破法进行绕过，对探测得到拓扑路径进行整合，将可知路由器按照顺序添加到探测队列中；步骤四、重复步骤二至三，直到当前探测队列为空。上述的非合作条件下的网络拓扑探测方法，步骤三中若支持SNMP，对每一条记录中的ip Route Type值进行判断所连接的是子网还是路由的规则为：若ip Route Type值为3，说明是路由器和子网的连接关系，将子网信息添加到网络拓扑记录中；若ip Route Type值为4，说明连接的下一跳是路由器设备，将对应的连接信息添加到网络拓扑记录中，然后将下一跳路由器IP添加到探测队列中，对其层数设置为当前路由器层数加1。上述的非合作条件下的网络拓扑探测方法，步骤三中若支持OSPF协议，获取Router LSA报文，遍历LSA报文中的信息，根据Type值进行判断，具体的：若Type值为1或4，则表示下一跳与路由器连接，将对应的连接信息添加到网络拓扑记录中，然后将下一跳无重复路由器IP添加到探测队列中，对其层数设置为当前路由器层数加1；若Type值为3，说明是路由器和子网的连接关系，将子网信息添加到网络拓扑记录中；若Type值为2，则代表下一跳连接的是DR端口，对DR端口继续请求NetworkLSA，获得传输网的地址，添加到拓扑网络记录中，并根据传输网包含的路由器列表，将无重复路由器IP全都添加到探测队列中。上述的非合作条件下的网络拓扑探测方法，步骤三中若支持RIP协议，对其发送RIP协议请求报文，获得该路由器的路由条目，遍历路由条目并判断metric的值，若metric为1，则目的地址表示与路由器直连的子网网段，将对应的连接信息添加到网络拓扑记录中；若metric大于1，则Nexthop表示与该路由器直接连接的路由器地址，将下一跳无重复路由器IP添加到探测队列中。本发明的有益效果：本发明在原有SNMP协议探测的基础上，采用RIP、OSPF协议等路由协议补充探测的方式，大幅度减少了不可探测节点数量。本发明针对少部分仍然无法探测的路由器设备，采用以路由表为线索的Traceroute定向突破法，绕过少量不可探测节点，补全网络拓扑中的缺失信息，进一步优化完善探测结果，有效突破了非协作节点对网络拓扑发现的阻碍，同时也避免了大量采用Traceroute主动探测给网络带来较大负担以及探测效率低下的问题。附图说明图1为本发明探测方法流程图。图2为Router LSA 报文格式。图3为RIP报文格式。图4为X不支持任何协议探测示意图。图5为Traceroute主动探测法探测示意图。图6为实验拓扑环境示意图。具体实施方式本发明通过分析研究当前主流网络拓扑探测方法，基于SNMP协议分析探测法和基于Traceroute的主动探测法，SNMP协议探测法虽然简单高效，但并非所有设备都具备或开启SNMP协议，面对这种情况，仅仅使用SNMP协议探测就会失效。而路由协议作为网络中的基础，必然存在于路由器之间。针对这两种方法对于非协作设备时存在的探测能力不足，拓扑信息缺失的问题，提出了通过多种路由协议补充探测方法，以有效提高原本SNMP协议探测法的适用范围，并针对极少数节点实在无法探测的情况，采用路由表加Traceroute定向突破的方式，绕过该节点，继续进行探测，最大程度完善拓扑信息收集和整合。下面结合附图和实施例对本发明进一步说明。实施例1：本实施例提供一种非协作条件下的网络拓扑探测方法，如图1所示，该方法包括以下内容。步骤一、预设需要探测的最大层数n，选择起始路由器并将其添加到探测队列，所述起始路由器拓扑层数为0，且起始路由器开启SNMP、OSPF、RIP中的一个；步骤二、采用广度优先搜索从探测队列头部取出路由器，若当前路由器层数大于预设层数n，则跳过当前路由器，取下一个路由器；反之，对其进行探测；步骤三、对当前路由器发送SNMP请求，判断是否支持SNMP探测；SNMP 管理站用Get-Request消息从拥有SNMP代理的网络设备中检索信息，而SNMP代理则用Get-Response消息响应。Get-Next- Request用于和Get-Request组合起来查询特定的表对象中的列元素。表1 和表2 分别表示通过 OID 标识符号访问 ip Route Table和 ip Addr Table 的主要信息。在有了这些OID 之后，可以通过创建 PDU报文来获取相应信息。。Ⅰ、若支持SNMP探测，则遍历路由表信息，对每一条记录中的ip Route Type值进行判断，以确定所连接的是子网还是路由；若ip Route Type值为3，说明是路由器和子网的连接关系，将子网信息添加到网络拓扑记录中；若ip Route Type值为4，说明连接的下一跳是路由器设备，将对应的连接信息添加到网络拓扑记录中，然后将下一跳路由器IP添加到探测队列中，对其层数设置为当前路由器层数加1；Ⅱ、若不支持SNMP探测，则对其发送OSPF的LSR报文，判断是否支持OSPF协议。OSPF协议是一种链路状态协议。每个路由器负责发现、维护与邻居的关系，并将已知的邻居列表和链路费用LSU报文描述，通过可靠的泛洪与自治系统AS内的其他路由器周期性交互，学习到整个自治系统的网络拓扑结构。正常流程中，OSPF协议只有每隔一个特定时间或当链路状态发生变化时，才会重新生成LSA，路由器通过泛洪机制将新LSA通告出去。但是，OSPF中也可以通过主动请求的方式，获取链路状态数据库中信息。通过主动发送LSR，获取需要的LSA具体信息。目前 OSPF 协议已经定义了 11 种 LSA，本文通过获取 LSU 报文中的 Router LSA和Network LSA对网络进行拓扑发现。Router LSA 格式见图2。通过读取Router LSA，可以获得用于拓扑发现的信息包括：一个路由器结点，该路由器结点的链路类型 ，以及与该路由器结点直接相连的邻居结点。Type 的值分别代表路由器的 4 种不同链路类型。具体链路信息见表 3。其中，point-to-point、stub和virtual link 这三种类型，可以直接获得包括路由器 ID，Link ID 和 Link Data 的完整网络连接关系信息。而对于transit 类型，只能得知路由器通过传输网与 DR 相连接，但无法获取具体的传输网地址。因此需要继续请求Network LSA，从Network LSA 获知的信息中寻找与 Router LSA 中的路由器 ID匹配的传输网地址，并获得该传输网包含的路由器列表，构成 transit 类型的完整连接关系信息。1、若支持OSPF协议，获取Router LSA报文，遍历LSA报文中的信息，根据Type值进行判断；若Type值为1或4，则表示下一跳与路由器连接，将对应的连接信息添加到网络拓扑记录中，然后将下一跳无重复路由器IP添加到探测队列中，对其层数设置为当前路由器层数加1；若Type值为3，说明是路由器和子网的连接关系，将子网信息添加到网络拓扑记录中；若Type值为2，则代表下一跳连接的是DR端口，对DR端口继续请求NetworkLSA，获得传输网的地址，添加到拓扑网络记录中，并根据传输网包含的路由器列表，将无重复路由器IP全都添加到探测队列中；2、若不支持OSPF协议，则对其发送RIP协议请求报文，判断是否支持RIP协议。RIP是Routing Information Protocol的简称，它是一种较为简单的内部网关协议。RIP是一种基于距离矢量算法的协议，它使用跳数作为度量来衡量到达目的网络的距离。RIP报文格式如图3所示。图中：command：该报文是请求报文或响应报文，1表示请求报文，2表示响应报文；ip address：该路由条目的目标网络地址；Subnet Mask：目的地址的掩码；NextHop：下一跳地址；Metric：到达该网络的开销。a、若支持RIP协议，对其发送RIP协议请求报文，获得该路由器的路由条目，遍历路由条目并判断metric的值；若metric为1，则目的地址表示与路由器直连的子网网段，将对应的连接信息添加到网络拓扑记录中；若metric大于1，则Nexthop表示与该路由器直接连接的路由器地址，将下一跳无重复路由器IP添加到探测队列中.b、若不支持RIP协议，则将该路由器设备作为不可探测路由器，使用Traceroute突破法进行绕过，对探测得到拓扑路径进行整合，将可知路由器按照顺序添加到探测队列中；对于极少部分既不支持SNMP，也不支持OSPF和RIP路由协议的路由器X。当探测步骤执行到该设备时，无法获得该路由器与其他路由器或网络的连接情况，探测到此终止。如图4所示，X不支持任何协议探测，因此无法确定X连接的路由器和子网情况。针对这类特殊情况，本实施例以路由表为线索，Traceroute定向突破不可测路由器绕过法。根据现有拓扑结构，通过获取与这些设备相连的路由器路由表信息，列出所有下一跳地址为该非协作路由器的路由条目，遍历目标网络地址，通过Traceroute主动探测这些路由地址，得到多条拓扑路径，合并路径信息，将探测到的所有可知IP的路由设备按照与X距离由小到大的顺序，通过X的层数加上X与该设备距离得出路由器的层数，并将路由器拓扑层数小于最大探测层数n的设备，按照从小到大的顺序添加到探测队列中。实现原理如图5所示。不可探测路由器X阻断探测进程后，获取R1和R2的路由表信息，并筛选出下一跳地址为X的所有路由条目。对目的网络地址采用Traceroute主动探测法，获取到探测路径存在的路由器T1和T2的IP地址，将T1和T2添加到探测队列中，继续探测进程。步骤四、重复步骤二至三，直到当前探测队列为空。试验例：本试验例为了验证各种协议探测法的差异性，通过EVE-NG虚拟环境，搭建了一个包含多路由器和子网的实验环境，如图6所示：R1-R3、T1-T3采用RIP协议，R4-R7使用OSPF协议，R4同时配置了RIP协议用于连接RIP和OSPF，X为静态路由。R2-R5开启了SNMP协议，其他均关闭。首先仅使用SNMP服务探测，选择R3为起始点，结果仅发现R1-R6、X和N1。添加RIP协议和OSPF协议作为补充后，R7和N4被发现。最后加入Traceroute突破法，成功绕过不可探测路由器X，进而发现T1-T3设备及对应子网N2、N3。通过对比看出，本发明方法由于添加了对不同协议的对应策略，对比单纯使用SNMP探测，适用性更加广泛，且仅对不支持SNMP协议的设备采用OSPF和RIP探测，探测效率基本一致。使用Traceroute对个别关键目标进行突破绕过，大大扩展了探测范围，克服了非协作节点对整体网络拓扑探测的桎梏，具有较强的鲁棒性。
