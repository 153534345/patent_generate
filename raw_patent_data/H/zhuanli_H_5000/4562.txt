标题title
一种基于事件驱动的高效数据加密转发方法及装置
摘要abst
本发明公开了一种基于事件驱动的高效数据加密转发方法及装置，所述方法包括建立本端与客户端、服务端之间的网络连接，通过异步方式调用加密卡，以初始状态监听每个连接和加密卡的读事件；当客户端连接可读时，从客户端读取数据并尝试写入数据到加密卡输入队列；当加密卡可写时，将未成功写入的客户端数据写入到加密卡输入队列；当加密卡可读时，从加密卡输出队列读取数据并尝试发送给服务端；当服务端连接可写时，将未成功发送的数据发送到服务端，完成整个客户端数据到服务端的转发过程，本发明确保程序运行不阻塞不空转，高效完成数据加解密和数据转发过程。
权利要求书clms
1.一种基于事件驱动的高效数据加密转发方法，其特征在于，包括：建立本端与客户端、服务端之间的网络连接，通过异步方式调用加密卡，以初始状态监听每个连接和加密卡的读事件；当客户端连接可读时，从客户端读取数据并尝试写入数据到加密卡输入队列；当加密卡可写时，将未成功写入的客户端数据写入到加密卡输入队列；当加密卡可读时，从加密卡输出队列读取数据并尝试发送给服务端；当服务端连接可写时，将未成功发送的数据发送到服务端，完成整个客户端数据到服务端的转发过程。2.根据权利要求1所述的基于事件驱动的高效数据加密转发方法，其特征在于，所述当客户端连接可读时，从客户端读取数据并尝试写入数据到加密卡输入队列，包括：如果写入失败，开始监听加密卡读写，等待下次写入加密卡；判断客户端连接是否存在未发送数据，如果存在，监听客户端连接写，否则不监听客户端连接写。3.根据权利要求2所述的基于事件驱动的高效数据加密转发方法，其特征在于，还包括：在客户端数据成功发送到服务端前，不监听客户端连接读。4.根据权利要求1所述的基于事件驱动的高效数据加密转发方法，其特征在于，所述当加密卡可写时，将未成功写入的客户端数据写入到加密卡输入队列，包括：如果写入失败，则继续监听加密卡读写，如果写入成功，仅监听加密卡读。5.根据权利要求1所述的基于事件驱动的高效数据加密转发方法，其特征在于，所述当加密卡可读时，从加密卡输出队列读取数据并尝试发送给服务端，包括：如果发送成功，则开始监听客户端连接读，否则等待服务端可写时再次发送。6.根据权利要求5所述的基于事件驱动的高效数据加密转发方法，其特征在于，还包括：当客户端连接存在未发送数据时，服务端不监听读，如果服务端数据全部发送至客户端，则开始监听服务端读。7.根据权利要求1所述的基于事件驱动的高效数据加密转发方法，其特征在于，所述当服务端连接可写时，将未成功发送的数据发送到服务端，包括：如果发送失败，继续等待服务端可写；如果发送成功，则开始监听客户端连接读，并停止服务端连接写监听。8.根据权利要求7所述的基于事件驱动的高效数据加密转发方法，其特征在于，还包括：如果客户端连接有未发送的数据，客户端连接继续监听写，服务端连接不监听读；如果客户端连接数据全部发送，服务端连接开始监听读，客户端不监听写。9.根据权利要求8所述的基于事件驱动的高效数据加密转发方法，其特征在于，还包括：当数据全部发送到服务器后，完成整个客户端数据到服务端的转发过程，此时客户端、服务端、加密卡恢复到初始监听读状态。10.一种基于事件驱动的高效数据加密转发装置，其特征在于，包括：网络连接建立单元，用于建立本端与客户端、服务端之间的网络连接，通过异步方式调用加密卡，以初始状态监听每个连接和加密卡的读事件；客户端可读单元，用于当客户端连接可读时，从客户端读取数据并尝试写入数据到加密卡输入队列；加密卡可写单元，用于当加密卡可写时，将未成功写入的客户端数据写入到加密卡输入队列；加密卡可读单元，用于当加密卡可读时，从加密卡输出队列读取数据并尝试发送给服务端；服务端可写单元，用于当服务端连接可写时，将未成功发送的数据发送到服务端，完成整个客户端数据到服务端的转发过程。
说明书desc
技术领域本发明涉及一种基于事件驱动的高效数据加密转发方法及装置，属于数据传输技术领域。背景技术在物联网环境中，海量物联终端需要与后端服务器进行通信，为验证物联终端身份，并保证传输数据的安全性，一般通过加密网关等装置进行终端身份验证和数据加密传输，这要求加密网关具有高并发、高吞吐的特性。在处理网络请求时，一般有如下几种模型：1)多线程模型，该模型对于每一个连接创建一个线程处理。在海量物联终端的背景下，该模型需要创建大量的线程，线程切换将是一笔很大的开销。2)线程池模型，该模型一般创建一个线程接收任务，并将任务加入队列，若干个工作线程从队列中取任务执行。该模型存取任务都需要加锁，且接收任务的线程可能会成为整个系统的瓶颈。3)多进/线程独立监听模型，该模型使用Linux内核提供的REUSEPORT特性，多进/线程同时监听同一个端口，且每个进/线程的监听独立。该模型避免了“惊群”现象的发生，可以最大限度的利用多核处理器的优势，现代网络程序一般采用该模型进行网络连接的处理。但该模型存在进/线程数量变化时数据包会按新的进/线程数重新分配的问题。加密网关需要进行大量的数据加解密运算，在同步加密卡调用模式下，会造成程序等待加解密运算结果的情形，不利于处理器的利用。物联终端一般通过无线网络进行通信，且终端性能一般不高，势必会导致加密网关两侧网络收发速度不匹配问题。对于此问题，一般可以采用如下方法处理。方法一，循环等待数据发送结束，但该方式会阻塞线程，不能及时处理其他已经就绪的连接；方法二，缓存数据，等待下次发送，该方法在存在大量慢连接时，会消耗大量内存。发明内容本发明的目的在于克服现有技术中的不足，提供一种基于事件驱动的高效数据加密转发方法及装置，确保程序运行不阻塞不空转，高效完成数据加解密和数据转发过程。为达到上述目的，本发明是采用下述技术方案实现的：第一方面，本发明提供了一种基于事件驱动的高效数据加密转发方法及装置，包括：建立本端与客户端、服务端之间的网络连接，通过异步方式调用加密卡，以初始状态监听每个连接和加密卡的读事件；当客户端连接可读时，从客户端读取数据并尝试写入数据到加密卡输入队列；当加密卡可写时，将未成功写入的客户端数据写入到加密卡输入队列；当加密卡可读时，从加密卡输出队列读取数据并尝试发送给服务端；当服务端连接可写时，将未成功发送的数据发送到服务端，完成整个客户端数据到服务端的转发过程。进一步的，所述当客户端连接可读时，从客户端读取数据并尝试写入数据到加密卡输入队列，包括：如果写入失败，开始监听加密卡读写，等待下次写入加密卡；判断客户端连接是否存在未发送数据，如果存在，监听客户端连接写，否则不监听客户端连接写。进一步的，还包括：在客户端数据成功发送到服务端前，不监听客户端连接读。进一步的，所述当加密卡可写时，将未成功写入的客户端数据写入到加密卡输入队列，包括：如果写入失败，则继续监听加密卡读写，如果写入成功，仅监听加密卡读。进一步的，所述当加密卡可读时，从加密卡输出队列读取数据并尝试发送给服务端，包括：如果发送成功，则开始监听客户端连接读，否则等待服务端可写时再次发送。进一步的，还包括：当客户端连接存在未发送数据时，服务端不监听读，如果服务端数据全部发送至客户端，则开始监听服务端读。进一步的，所述当服务端连接可写时，将未成功发送的数据发送到服务端，包括：如果发送失败，继续等待服务端可写；如果发送成功，则开始监听客户端连接读，并停止服务端连接写监听。进一步的，还包括：如果客户端连接有未发送的数据，客户端连接继续监听写，服务端连接不监听读；如果客户端连接数据全部发送，服务端连接开始监听读，客户端不监听写。进一步的，还包括：当数据全部发送到服务器后，完成整个客户端数据到服务端的转发过程，此时客户端、服务端、加密卡恢复到初始监听读状态。第二方面，本发明提供一种基于事件驱动的高效数据加密转发装置，包括：网络连接建立单元，用于建立本端与客户端、服务端之间的网络连接，通过异步方式调用加密卡，以初始状态监听每个连接和加密卡的读事件；客户端可读单元，用于当客户端连接可读时，从客户端读取数据并尝试写入数据到加密卡输入队列；加密卡可写单元，用于当加密卡可写时，将未成功写入的客户端数据写入到加密卡输入队列；加密卡可读单元，用于当加密卡可读时，从加密卡输出队列读取数据并尝试发送给服务端；服务端可写单元，用于当服务端连接可写时，将未成功发送的数据发送到服务端，完成整个客户端数据到服务端的转发过程。与现有技术相比，本发明所达到的有益效果：本发明提供一种基于事件驱动的高效数据加密转发方法及装置，在调用加密卡进行数据加解密时，通过进程与加密卡通道一对一的绑定实现了进程对加密卡的无锁调用，减少了性能损失。在数据加解密转发阶段，设计了一套根据加密卡状态和网络收发状态控制加密卡和两端连接读写监听的机制，有效解决了当两端传输速率不一致时数据转发难题和同步调用加密卡时处理器等待的问题，实现了即不用阻塞进程，也不需要占用大量内存缓存数据的效果，最终实现加密数据的高效转发。附图说明图1是本发明实施例提供的一种基于事件驱动的高效数据加密转发方法的流程图；图2是本发明实施例提供的客户端连接可读事件处理流程图；图3是本发明实施例提供的加密卡可写事件处理流程图；图4是本发明实施例提供的加密卡可读事件处理流程图；图5是本发明实施例提供的服务端连接可写事件处理流程图。具体实施方式下面结合附图对本发明作进一步描述。以下实施例仅用于更加清楚地说明本发明的技术方案，而不能以此来限制本发明的保护范围。实施例1本实施例介绍一种基于事件驱动的高效数据加密转发方法及装置，包括：建立本端与客户端、服务端之间的网络连接，通过异步方式调用加密卡，以初始状态监听每个连接和加密卡的读事件；当客户端连接可读时，从客户端读取数据并尝试写入数据到加密卡输入队列；当加密卡可写时，将未成功写入的客户端数据写入到加密卡输入队列；当加密卡可读时，从加密卡输出队列读取数据并尝试发送给服务端；当服务端连接可写时，将未成功发送的数据发送到服务端，完成整个客户端数据到服务端的转发过程。本实施例提供的基于事件驱动的高效数据加密转发方法及装置，其应用过程具体涉及如下步骤：连接准备建立本端与客户端、服务端之间的网络连接，通过异步方式调用加密卡，初始状态监听每个连接和加密卡的读事件。以下以客户端连接可读开始描述整个流程。客户端连接可读当客户端连接可读时，从客户端读取数据并尝试写入数据到加密卡输入队列。如果写入失败，开始监听加密卡读写，等待下次写入加密卡。然后判断客户端连接是否存在未发送数据，如果存在，监听客户端连接写，否则不监听客户端连接写。在客户端数据成功发送到服务端前，不监听客户端连接读。加密卡可写当加密卡可写时，将未成功写入的客户端数据写入到加密卡输入队列，如果写入失败，则继续监听加密卡读写，如果写入成功，仅监听加密卡读。加密卡可读当加密卡可读时，从加密卡输出队列读取数据并尝试发送给服务端，如果发送成功，则可以开始监听客户端连接读了，否则需要等待服务端可写时再次发送。当客户端连接存在未发送数据时，服务端不监听读，如果服务端数据全部发送至客户端，则可以开始监听服务端读。服务端连接可写当服务端连接可写时，将未成功发送的数据发送到服务端，如果仍然发送失败，继续等待服务端可写；如果发送成功，则可以开始监听客户端连接读，并停止服务端连接写监听。如果客户端连接有未发送的数据，客户端连接继续监听写，服务端连接不监听读；如果客户端连接数据全部发送，服务端连接开始监听读，客户端不监听写。当数据全部发送到服务器后，就完成了整个客户端数据到服务端的转发过程，此时客户端、服务端、加密卡恢复到初始监听读状态。当服务端连接可读时，整体流程与上述流程基本一致，只需将加密卡从解密运算设置成加密运算即可。实施例2本实施例提供一种基于事件驱动的高效数据加密转发装置，包括：网络连接建立单元，用于建立本端与客户端、服务端之间的网络连接，通过异步方式调用加密卡，以初始状态监听每个连接和加密卡的读事件；客户端可读单元，用于当客户端连接可读时，从客户端读取数据并尝试写入数据到加密卡输入队列；加密卡可写单元，用于当加密卡可写时，将未成功写入的客户端数据写入到加密卡输入队列；加密卡可读单元，用于当加密卡可读时，从加密卡输出队列读取数据并尝试发送给服务端；服务端可写单元，用于当服务端连接可写时，将未成功发送的数据发送到服务端，完成整个客户端数据到服务端的转发过程。以上所述仅是本发明的优选实施方式，应当指出，对于本技术领域的普通技术人员来说，在不脱离本发明技术原理的前提下，还可以做出若干改进和变形，这些改进和变形也应视为本发明的保护范围。
