标题title
一种NAT探测的方法、客户端及系统
摘要abst
本发明公开了一种NAT探测的方法、客户端及系统，方法包括：客户端向STUN服务器发起映射行为探测，并基于映射行为探测识别NAT的映射类型；当基于映射行为探测识别出NAT的映射类型为端点无关映射的NAT类型时，向STUN服务器发起过滤行为探测，并基于过滤行为探测识别NAT的过滤类型；当基于过滤行为探测识别出NAT的过滤类型为地址和端口相关过滤的NAT类型时，向STUN服务器发起顺序行为探测，并基于顺序行为探测识别NAT的顺序类型。本发明通过顺序行为探测，使得其可以通过识别出NAT映射端口上的数据收发顺序类型从而得出映射端口是否有效的判定，以使得客户端能够预测出不同局域网内两个主机之间在特定条件下是否能够建立P2P数据传输。
权利要求书clms
1.一种NAT探测的方法，其特征在于，所述方法包括以下步骤：客户端向STUN服务器发起映射行为探测，并基于映射行为探测识别NAT的映射类型；当基于映射行为探测识别出NAT的映射类型为端点无关映射的NAT类型时，向STUN服务器发起过滤行为探测，并基于过滤行为探测识别NAT的过滤类型；当基于过滤行为探测识别出NAT的过滤类型为地址和端口相关过滤的NAT类型时，向STUN服务器发起顺序行为探测，并基于顺序行为探测识别NAT的顺序类型。2.如权利要求1所述的NAT探测的方法，其特征在于，所述客户端向STUN服务器发起映射行为探测，并基于映射行为探测识别NAT的映射类型包括：以客户端的固定IP地址和第一客户端口向STUN服务器的第一服务IP地址和第一服务端口发送第一STUN绑定请求，并从STUN服务器返回的第一STUN绑定请求的响应中得到NAT映射后的掩蔽IP地址和第一掩蔽端口；以客户端的固定IP地址和第一客户端口向STUN服务器的第二服务IP地址和第一服务端口发送第二STUN绑定请求，并从STUN服务器返回的第二STUN绑定请求的响应中得到NAT映射后的掩蔽IP地址和第二掩蔽端口；在判断所述第一掩蔽端口和所述第二掩蔽端口相同时，则识别出NAT的映射类型为端点无关映射的NAT类型。3.如权利要求2所述的NAT探测的方法，其特征在于，所述向STUN服务器发起过滤行为探测，并基于过滤行为探测识别NAT的过滤类型，包括：以客户端的固定IP地址和第二客户端口向STUN服务器的第一服务IP地址和第一服务端口发送第三STUN绑定请求，并收到第三STUN绑定请求的响应，并从第三STUN绑定请求的响应中得到NAT映射后的掩蔽IP地址和第三掩蔽端口；以客户端的固定IP地址和第二客户端口向STUN服务器的第一服务IP地址和第一服务端口发送第四STUN绑定请求，所述第四STUN绑定请求中设置了STUN请求报文的Change IP和Change PORT属性为1，所述第四STUN绑定请求用于请求STUN服务器以STUN服务器的第二服务IP地址和第二服务端口来回复第四STUN绑定请求；接收STUN服务器所返回的第四STUN绑定请求的响应，根据第四STUN绑定请求的响应判断NAT的过滤类型，在客户端没有收到第四STUN绑定请求的响应而引发接收超时，则识别出NAT的过滤类型为地址和端口相关过滤的NAT类型。4.如权利要求3所述的NAT探测的方法，其特征在于，所述向STUN服务器发起顺序行为探测，并基于顺序行为探测识别NAT的顺序类型，包括：以客户端的固定IP地址和第二客户端口向STUN服务器的第一服务IP地址和第二服务端口发送第五STUN绑定请求，并从STUN服务器返回的第五STUN绑定请求的响应中得到NAT映射后的掩蔽IP地址和第五掩蔽端口；解析第五掩蔽端口是否与第三掩蔽端口相同，若第五掩蔽端口与第三掩蔽端口相同，则NAT的顺序类型为收发顺序无关的NAT类型，若第五掩蔽端口与第三掩蔽端口不同则NAT的顺序类型为收发顺序相关的NAT类型。5.一种客户端，其特征在于，所述客户端包括：映射探测模块，用于向STUN服务器发起映射行为探测，并基于映射行为探测识别NAT的映射类型；过滤探测模块，用于当基于映射行为探测识别出NAT的映射类型为端点无关映射的NAT类型时，向STUN服务器发起过滤行为探测，并基于过滤行为探测识别NAT的过滤类型；顺序探测模块，用于当基于过滤行为探测识别出NAT的过滤类型为地址和端口相关过滤的NAT类型时，向STUN服务器发起顺序行为探测，并基于顺序行为探测识别NAT的顺序类型。6.如权利要求5所述的客户端，其特征在于，所述映射探测模块包括：第一请求单元，用于以客户端的固定IP地址和第一客户端口向STUN服务器的第一服务IP地址和第一服务端口发送第一STUN绑定请求；第一响应单元，用于从STUN服务器返回的第一STUN绑定请求的响应中得到NAT映射后的掩蔽IP地址和第一掩蔽端口；第二请求单元，用于以客户端的固定IP地址和第一客户端口向STUN服务器的第二服务IP地址和第一服务端口发送第二STUN绑定请求；第二响应单元，用于从STUN服务器返回的第二STUN绑定请求的响应中得到NAT映射后的掩蔽IP地址和第二掩蔽端口；第一识别单元，用于在判断所述第一掩蔽端口和所述第二掩蔽端口相同时，则识别出NAT的映射类型为端点无关映射的NAT类型。7.如权利要6所述的客户端，其特征在于，所述过滤探测模块包括：第三请求单元，用于以客户端的固定IP地址和第二客户端口向STUN服务器的第一服务IP地址和第一服务端口发送第三STUN绑定请求；第三响应单元，用于接收第三STUN绑定请求的响应，并从第三STUN绑定请求的响应中得到NAT映射后的掩蔽IP地址和第三掩蔽端口；第四请求单元，用于以客户端的固定IP地址和第二客户端口向STUN服务器的第一服务IP地址和第一服务端口发送第四STUN绑定请求，所述第四STUN绑定请求中设置了STUN请求报文的Change IP和Change PORT属性为1，所述第四STUN绑定请求用于请求STUN服务器以STUN服务器的第二服务IP地址和第二服务端口来回复第四STUN绑定请求；第四响应单元，用于接收STUN服务器所返回的第四STUN绑定请求的响应；第二识别单元，用于根据第四STUN绑定请求的响应判断NAT的过滤类型，在客户端没有收到第四STUN绑定请求的响应而引发接收超时，则识别出NAT的过滤类型为地址和端口相关过滤的NAT类型。8.如权利要求7所述的客户端，其特征在于，所述顺序探测模块包括：第五请求单元，用于以客户端的固定IP地址和第二客户端口向STUN服务器的第一服务IP地址和第二服务端口发送第五STUN绑定请求；第五响应单元，用于接收STUN服务器所返回的第五STUN绑定请求的响应，并从第五STUN绑定请求的响应中得到NAT映射后的掩蔽IP地址和第五掩蔽端口；第三识别单元，用于解析第五掩蔽端口是否与第三掩蔽端口相同，若第五掩蔽端口与第三掩蔽端口相同则NAT的顺序类型为收发顺序无关的NAT类型，若第五掩蔽端口与第三掩蔽端口不同则NAT的顺序类型为收发顺序相关的NAT类型。9.一种NAT探测的系统，其特征在于，所述系统包括：客户端，用于向STUN服务器发起映射行为探测，并基于映射行为探测识别NAT的映射类型；当基于映射行为探测识别出NAT的映射类型为端点无关映射的NAT类型时，向STUN服务器发起过滤行为探测，并基于过滤行为探测识别NAT的过滤类型；当基于过滤行为探测识别出NAT的过滤类型为地址和端口相关过滤的NAT类型时，向STUN服务器发起顺序行为探测，并基于顺序行为探测识别NAT的顺序类型；NAT设备，用于在客户端和STUN服务器之间通信时，提供网络地址转换；STUN服务器，提供STUN协议的服务器端支持，用于通过UDP协议协助客户端进行不同路由器之间的穿越，STUN服务器通过NAT设备与客户端进行数据通信。10.如权利要求9所述的NAT探测的系统，其特征在于，所述客户端用于以客户端的固定IP地址和第二客户端口向STUN服务器的第一服务IP地址和第二服务端口发送第五STUN绑定请求，并从STUN服务器返回的第五STUN绑定请求的响应中得到NAT映射后的掩蔽IP地址和第五掩蔽端口；解析第五掩蔽端口是否与第三掩蔽端口相同，若第五掩蔽端口与第三掩蔽端口相同则NAT的顺序类型为收发顺序无关的NAT类型，若第五掩蔽端口与第三掩蔽端口不同则NAT的顺序类型为收发顺序相关的NAT类型。
说明书desc
技术领域本发明涉及通信技术领域，尤其涉及一种NAT探测的方法、客户端及系统。背景技术网络地址转换也叫做网络掩蔽或者IP掩蔽，它是IETF制订的标准，NAT是一种网络地址翻译技术，主要作用是在内网数据包离开NAT时修改IP协议和TCP/UDP协议报文，将IP层的内部私有IP地址和路由器所在域的公网IP，并根据一些规则将TCP/UDP协议层的端口映射到NAT的某个端口上。NAT的功能通常被集成到路由器、防火墙、ISDN路由器或者单独的NAT设备中。NAT可以同时让多个计算机同时联网，并隐藏其内网IP，因此也增加了内网的网络安全性；NAT对来自外部的数据查看其NAT映射记录，对没有相应记录的数据包进行拒绝，提高了网络安全性；NAT不仅能解决IP地址不足的问题，而且还能够有效地避免来自网络外部的攻击，隐藏并保护网络内部的计算机。通过RFC5780提出的探测方式可以探测到NAT的映射行为和过滤行为，这样在位于不同NAT之后的两个客户端在进行P2P数据传输通道建立前，可以先对自身的NAT行为进行探测，进而得到自己所对应的NAT类型后，通过一些消息转发服务器把自己的NAT类型互相通知对方，双方即可通过自己的NAT类型和对方的NAT类型进行组合判断，得出是否能够在这两个客户端之间建立起P2P通道。但NAT环境中测试时，目前存在一种特殊的NAT行为，NAT会屏蔽未发先收的映射端口，导致两个客户端之间无法建立P2P通道，使得两个客户端之间无法直接通信。位于不同NAT后面的两个客户端之间要能够建立P2P数据传输，除了与RFC4787中定义的NAT映射行为和过滤行为相关外，还与已经在NAT上建立起映射端口的数据收发顺序相关，当客户端以某个地址和端口IP-A：PORT-A通过STUN协议从向STUN服务器的某个地址和端口IP-S：PORT-S发送STUN绑定请求，而获得客户端IP地址和端口IP-A：PORT-A在NAT上的地址与端口映射IP-O：PORT-O之后，若此客户端未用IP-A：PORT-A发送数据，且有任何外部主机的任意IP地址和端口向该NAT映射的端口IP-O：PORT-O发送数据时，则NAT会屏蔽此映射端口PORT-O，即此端口不能再作为先前对内网主机地址和端口IP-A：PORT-A的映射，也就是说内网主机不能再通过NAT的这个端口向外发送数据，屏蔽的时间长度因不同厂商的NAT而异，若此后内网客户端主机再用上述的地址和端口IP-A：PORT-A向外发送数据时，NAT会映射到不同的另一个端口，因此如何通过基于客户端建立NAT探测来完成P2P的预测就变得尤为重要。发明内容本发明的目的在于克服现有技术的不足，本发明提供了一种NAT探测的方法、客户端及系统，客户端通过在NAT的映射行为和过滤行为的基础上，增加一种顺序行为探测，使得其可以识别出映射端口的有效性与在端口上数据收发顺序的相关性，以使得客户端能够预测出不同局域网内两个主机之间是否能够建立P2P数据传输。为了解决上述问题，本发明提出了一种NAT探测的方法，所述方法包括以下步骤：客户端向STUN服务器发起映射行为探测，并基于映射行为探测识别NAT的映射类型；当基于映射行为探测识别出NAT的映射类型为端点无关映射的NAT类型时，向STUN服务器发起过滤行为探测，并基于过滤行为探测识别NAT的过滤类型；当基于过滤行为探测识别出NAT的过滤类型为地址和端口相关过滤的NAT类型时，向STUN服务器发起顺序行为探测，并基于顺序行为探测识别NAT的顺序类型。所述客户端向STUN服务器发起映射行为探测，并基于映射行为探测识别NAT的映射类型，包括：以客户端的固定IP地址和第一客户端口向STUN服务器的第一服务IP地址和第一服务端口发送第一STUN绑定请求，并从STUN服务器返回的第一STUN绑定请求的响应中得到NAT映射后的掩蔽IP地址和第一掩蔽端口；以客户端的固定IP地址和第一客户端口向STUN服务器的第二服务IP地址和第一服务端口发送第二STUN绑定请求，并从STUN服务器返回的第二STUN绑定请求的响应中得到NAT映射后的掩蔽IP地址和第二掩蔽端口；在判断所述第一掩蔽端口和所述第二掩蔽端口相同时，则识别出NAT的映射类型为端点无关映射的NAT类型。所述向STUN服务器发起过滤行为探测，并基于过滤行为探测识别NAT的过滤类型，包括：以客户端的固定IP地址和第二客户端口向STUN服务器的第一服务IP地址和第一服务端口发送第三STUN绑定请求，并收到第三STUN绑定请求的响应，并从第三STUN绑定请求的响应中得到NAT映射后的掩蔽IP地址和第三掩蔽端口；以客户端的固定IP地址和第二客户端口向STUN服务器的第一服务IP地址和第一服务端口发送第四STUN绑定请求，所述第四STUN绑定请求中设置了STUN请求报文的ChangeIP和Change PORT属性为1，所述第四STUN绑定请求用于请求STUN服务器以STUN服务器的第二服务IP地址和第二服务端口来回复第四STUN绑定请求；接收STUN服务器所返回的第四STUN绑定请求的响应，根据第四STUN绑定请求的响应判断NAT的过滤类型，在客户端没有收到第四STUN绑定请求的响应而引发接收超时，则识别出NAT的过滤类型为地址和端口相关过滤的NAT类型。所述向STUN服务器发起顺序行为探测，并基于顺序行为探测识别NAT的顺序类型，包括：以客户端的固定IP地址和第二客户端口向STUN服务器的第一服务IP地址和第二服务端口发送第五STUN绑定请求，并从STUN服务器返回的第五STUN绑定请求的响应中得到NAT映射后的掩蔽IP地址和第五掩蔽端口；解析第五掩蔽端口是否与第三掩蔽端口相同，若第五掩蔽端口与第三掩蔽端口相同则NAT的顺序类型为收发顺序无关的NAT类型，若第五掩蔽端口与第三掩蔽端口不同则NAT的顺序类型为收发顺序相关的NAT类型。相应的，本发明还提出了一种客户端，所述客户端包括：映射探测模块，用于向STUN服务器发起映射行为探测，并基于映射行为探测识别NAT的映射类型；过滤探测模块，用于当基于映射行为探测识别出NAT的映射类型为端点无关映射的NAT类型时，向STUN服务器发起过滤行为探测，并基于过滤行为探测识别NAT的过滤类型；顺序探测模块，用于当基于过滤行为探测识别出NAT的过滤类型为地址和端口相关过滤的NAT类型时，向STUN服务器发起顺序行为探测，并基于顺序行为探测识别NAT的顺序类型。所述映射探测模块包括：第一请求单元，用于以客户端的固定IP地址和第一客户端口向STUN服务器的第一服务IP地址和第一服务端口发送第一STUN绑定请求；第一响应单元，用于从STUN服务器返回的第一STUN绑定请求的响应中得到NAT映射后的掩蔽IP地址和第一掩蔽端口；第二请求单元，用于以客户端的固定IP地址和第一客户端口向STUN服务器的第二服务IP地址和第一服务端口发送第二STUN绑定请求；第二响应单元，用于从STUN服务器返回的第二STUN绑定请求的响应中得到NAT映射后的掩蔽IP地址和第二掩蔽端口；第一识别单元，用于在判断所述第一掩蔽端口和所述第二掩蔽端口相同时，则识别出NAT的映射类型为端点无关映射的NAT类型。所述过滤探测模块包括：第三请求单元，用于以客户端的固定IP地址和第二客户端口向STUN服务器的第一服务IP地址和第一服务端口发送第三STUN绑定请求；第三响应单元，用于接收第三STUN绑定请求的响应，并从第三STUN绑定请求的响应中得到NAT映射后的掩蔽IP地址和第三掩蔽端口；第四请求单元，用于以客户端的固定IP地址和第二客户端口向STUN服务器的第一服务IP地址和第一服务端口发送第四STUN绑定请求，所述第四STUN绑定请求中设置了STUN请求报文的Change IP和Change PORT属性为1，所述第四STUN绑定请求用于请求STUN服务器以STUN服务器的第二服务IP地址和第二服务端口来回复第四STUN绑定请求；第四响应单元，用于接收STUN服务器所返回的第四STUN绑定请求的响应；第二识别单元，用于根据第四STUN绑定请求的响应判断NAT的过滤类型，在客户端没有收到第四STUN绑定请求的响应而引发接收超时，则识别出NAT的过滤类型为地址和端口相关过滤的NAT类型。所述顺序探测模块包括：第五请求单元，用于以客户端的固定IP地址和第二客户端口向STUN服务器的第一服务IP地址和第二服务端口发送第五STUN绑定请求；第五响应单元，用于接收STUN服务器所返回的第五STUN绑定请求的响应，并从第五STUN绑定请求的响应中得到NAT映射后的掩蔽IP地址和第五掩蔽端口；第三识别单元，用于解析第五掩蔽端口是否与第三掩蔽端口相同，若第五掩蔽端口与第三掩蔽端口相同则NAT的顺序类型为收发顺序无关的NAT类型，若第五掩蔽端口为与第三掩蔽端口不同则NAT的顺序类型为收发顺序相关的NAT类型。相应的，本发明还提出了一种NAT探测的系统，所述系统包括：客户端，用于向STUN服务器发起映射行为探测，并基于映射行为探测识别NAT的映射类型；当基于映射行为探测识别出NAT的映射类型为端点无关映射的NAT类型时，向STUN服务器发起过滤行为探测，并基于过滤行为探测识别NAT的过滤类型；当基于过滤行为探测识别出NAT的过滤类型为地址和端口相关过滤的NAT类型时，向STUN服务器发起顺序行为探测，并基于顺序行为探测识别NAT的顺序类型；NAT设备，用于在客户端和STUN服务器之间通信时，提供网络地址转换；STUN服务器，提供STUN协议的服务器端支持，用于通过UDP协议协助客户端进行不同路由器之间的穿越，STUN服务器通过NAT设备与客户端进行数据通信。所述客户端用于以客户端的固定IP地址和第二客户端口向STUN服务器的第一服务IP地址和第二服务端口发送第五STUN绑定请求，并从STUN服务器返回的第五STUN绑定请求的响应中得到NAT映射后的掩蔽IP地址和第五掩蔽端口；解析第五掩蔽端口是否与第三掩蔽端口相同，若第五掩蔽端口与第三掩蔽端口相同则NAT的顺序类型为收发顺序无关的NAT类型，若第五掩蔽端口与第三掩蔽端口不同则NAT的顺序类型为收发顺序相关的NAT类型。本发明实施例中的客户端通过在映射行为和过滤行为的基础上，增加一种顺序探测行为，使得其可以识别出映射端口的有效性与该端口上的数据收发顺序的关系，以使得客户端能够预测出不同局域网内两个主机之间是否能够建立P2P数据传输。通过这种方法其可以作为RFC4787中对NAT行为划分的补充，通过这种NAT的探测方式，使得位于不同NAT之后的两个客户端在进行P2P数据传输通道建立前，可以先对自身的NAT行为进行探测，进而了解相互所对应的NAT类型，从而实现客户端彼此的预测得出是否能够在这两个客户端之间建立起P2P通道。附图说明为了更清楚地说明本发明实施例或现有技术中的技术方案，下面将对实施例或现有技术描述中所需要使用的附图作简单地介绍，显而易见的，下面描述中的附图仅仅是本发明的一些实施例，对于本领域普通技术人员来讲，在不付出创造性劳动的前提下，还可以根据这些附图获得其它的附图。图1是本发明实施例中的NAT探测的系统结构示意图；图2是本发明实施例中的客户端结构示意图；图3是本发明实施例中的映射探测模块结构示意图；图4是本发明实施例中的过滤探测模块结构示意图；图5是本发明实施例中的顺序探测模块结构示意图；图6是本发明实施例中的NAT探测的方法流程图；图7是本发明实施例中的NAT探测的具体方法流程图。具体实施方式下面将结合本发明实施例中的附图，对本发明实施例中的技术方案进行清楚、完整地描述，显然，所描述的实施例仅仅是本发明一部分实施例，而不是全部的实施例。基于本发明中的实施例，本领域普通技术人员在没有作出创造性劳动前提下所获得的所有其它实施例，都属于本发明保护的范围。需要说明的是，P2P是指不经过服务器，两个客户端之间直接通信，或者在服务器的协助下，两个终端可以直接建立通信链路。不是所有的两个对等体间都能够建立P2P通道，比如位于不同地域的两台主机电脑、手机等等终端，由于所在的路由器的NAT类型差异，有的终端体之间无法建立P2P。通过RFC5780提出的探测方式可以探测到NAT的映射行为和过滤行为，这样在位于不同NAT之后的两个客户端在进行P2P数据传输通道建立前，可以先对自身的NAT行为进行探测，进而得到自己所对应的NAT类型后，通过一些消息转发服务器把自己的NAT类型互相通知对方，双方即可通过自己的NAT类型和对方的NAT类型进行组合判断，得出是否能够在这两个客户端之间建立起P2P通道。目前存在一种特殊的NAT行为，即NAT设备会屏蔽未发先收的映射端口。因此本发明实施例中提出了NAT的端口映射行为与收发顺序相关，对该NAT类型定义为“收发顺序相关映射的NAT”和“收发顺序无关映射的NAT，并给出了该类型NAT的探测方式。本发明实施例中的掩蔽即映射，这里的掩蔽端口即映射端口，这里的掩蔽IP地址即映射IP地址。具体的，图1示出了本发明实施例中的NAT探测的系统结构示意图，该系统包括：客户端，用于向STUN服务器发起映射行为探测，并基于映射行为探测识别NAT的映射类型；当基于映射行为探测识别出NAT的映射类型为端点无关映射的NAT类型时，向STUN服务器发起过滤行为探测，并基于过滤行为探测识别NAT的过滤类型；当基于过滤行为探测识别出NAT的过滤类型为地址和端口相关过滤的NAT类型时，向STUN服务器发起顺序行为探测，并基于顺序行为探测识别NAT的顺序类型；NAT设备，用于在客户端和STUN服务器之间通信时，提供网络地址转换；STUN服务器，提供STUN协议的服务器端支持，用于通过UDP协议协助客户端进行不同路由器之间的穿越，STUN服务器通过NAT设备与客户端进行数据通信。客户端通过图1所示的网络拓扑结构来获取其在NAT上的映射地址和端口，STUN服务器有两个IP地址和两个端口，这里设定IP地址分别为s.s.s.s和t.t.t.t，端口分别为3478和3479；客户端有一个IP地址为a.a.a.a，两个端口分别为10000和20000。这里的客户端用于以客户端的固定IP地址和第二客户端口向STUN服务器的第一服务IP地址和第二服务端口发送第五STUN绑定请求，并从STUN服务器返回的第五STUN绑定请求的响应中得到NAT映射后的掩蔽IP地址和第五掩蔽端口；解析第五掩蔽端口是否与第三掩蔽端口相同，若第五掩蔽端口与第三掩蔽端口相同则NAT的顺序类型为收发顺序无关的NAT类型，若第五掩蔽端口与第三掩蔽端口不同则NAT的顺序类型为收发顺序相关的NAT类型。具体的，图2示出了本发明实施例中的客户端结构示意图，该客户端包括：映射探测模块，用于向STUN服务器发起映射行为探测，并基于映射行为探测识别NAT的映射类型；过滤探测模块，用于当基于映射行为探测识别出NAT的映射类型为端点无关映射的NAT类型时，向STUN服务器发起过滤行为探测，并基于过滤行为探测识别NAT的过滤类型；顺序探测模块，用于当基于过滤行为探测识别出NAT的过滤类型为地址和端口相关过滤的NAT类型时，向STUN服务器发起顺序行为探测，并基于顺序行为探测识别NAT的顺序类型。具体的，图3示出了本发明实施例中的映射探测模块结构示意图，该映射探测模块包括：第一请求单元，用于以客户端的固定IP地址和第一客户端口向STUN服务器的第一服务IP地址和第一服务端口发送第一STUN绑定请求；第一响应单元，用于从STUN服务器返回的第一STUN绑定请求的响应中得到NAT映射后的掩蔽IP地址和第一掩蔽端口；第二请求单元，用于以客户端的固定IP地址和第一客户端口向STUN服务器的第二服务IP地址和第一服务端口发送第二STUN绑定请求；第二响应单元，用于从STUN服务器返回的第二STUN绑定请求的响应中得到NAT映射后的掩蔽IP地址和第二掩蔽端口；第一识别单元，用于在判断所述第一掩蔽端口和所述第二掩蔽端口相同时，则识别出NAT的映射类型为端点无关映射的NAT类型。具体的，图4示出了本发明实施例中的过滤探测模块结构示意图，该过滤探测模块包括：第三请求单元，用于以客户端的固定IP地址和第二客户端口向STUN服务器的第一服务IP地址和第一服务端口发送第三STUN绑定请求；第三响应单元，用于接收第三STUN绑定请求的响应，并从第三STUN绑定请求的响应中得到NAT映射后的掩蔽IP地址和第三掩蔽端口；第四请求单元，用于以客户端的固定IP地址和第二客户端口向STUN服务器的第一服务IP地址和第一服务端口发送第四STUN绑定请求，所述第四STUN绑定请求中设置了STUN请求报文的Change IP和Change PORT属性为1，所述第四STUN绑定请求用于请求STUN服务器以STUN服务器的第二服务IP地址和第二服务端口来回复第四STUN绑定请求；第四响应单元，用于接收STUN服务器所返回的第四STUN绑定请求的响应；第二识别单元，用于根据第四STUN绑定请求的响应判断NAT的过滤类型，在客户端没有收到第四STUN绑定请求的响应而引发接收超时，则识别出NAT的过滤类型为地址和端口相关过滤的NAT类型。具体的，图5示出了本发明实施例中的顺序探测模块结构示意图，该顺序探测模块包括：第五请求单元，用于以客户端的固定IP地址和第二客户端口向STUN服务器的第一服务IP地址和第二服务端口发送第五STUN绑定请求；第五响应单元，用于接收STUN服务器所返回的第五STUN绑定请求的响应，并从第五STUN绑定请求的响应中得到NAT映射后的掩蔽IP地址和第五掩蔽端口；第三识别单元，用于解析第五掩蔽端口是否与第三掩蔽端口相同，若第五掩蔽端口与第三掩蔽端口相同则NAT的顺序类型为收发顺序无关的NAT类型，若第五掩蔽端口与第三掩蔽端口不同则NAT的顺序类型为收发顺序相关的NAT类型。具体的，图6示出了本发明实施例中的NAT探测的方法流程图，该方法包括以下步骤：S601、客户端向STUN服务器发起映射行为探测，并基于映射行为探测识别NAT的映射类型；具体的，所述客户端向STUN服务器发起映射行为探测，并基于映射行为探测识别NAT的映射类型，包括：以客户端的固定IP地址和第一客户端口向STUN服务器的第一服务IP地址和第一服务端口发送第一STUN绑定请求，并从STUN服务器返回的第一STUN绑定请求的响应中得到NAT映射后的掩蔽IP地址和第一掩蔽端口；以客户端的固定IP地址和第一客户端口向STUN服务器的第二服务IP地址和第一服务端口发送第二STUN绑定请求，并从STUN服务器返回的第二STUN绑定请求的响应中得到NAT映射后的掩蔽IP地址和第二掩蔽端口；在判断所述掩蔽IP地址和第一掩蔽端口与所述掩蔽IP地址和第二掩蔽端口相同时，即所述第一掩蔽端口和所述第二掩蔽端口在数值上相等时，则识别出NAT的映射类型为端点无关映射的NAT类型。需要说明的是，NAT的映射类型为端点无关映射的NAT类型时，掩蔽IP地址即为NAT设备上的外网IP地址，第一掩蔽端口和第二掩蔽端口为同一掩蔽端口。S602、当基于映射行为探测识别出NAT的映射类型为端点无关映射的NAT类型时，向STUN服务器发起过滤行为探测，并基于过滤行为探测识别NAT的过滤类型；所述向STUN服务器发起过滤行为探测，并基于过滤行为探测识别NAT的过滤类型包括：以客户端的固定IP地址和第二客户端口向STUN服务器的第一服务IP地址和第一服务端口发送第三STUN绑定请求，并收到第三STUN绑定请求的响应，并从第三STUN绑定请求的响应中得到NAT映射后的掩蔽IP地址和第三掩蔽端口；以客户端的固定IP地址和第二客户端口向STUN服务器的第一服务IP地址和第一服务端口发送第四STUN绑定请求，所述第四STUN绑定请求中设置了STUN请求报文的Change IP和Change PORT属性为1，所述第四STUN绑定请求用于请求STUN服务器以STUN服务器的第二服务IP地址和第二服务端口来回复第四STUN绑定请求；接收STUN服务器所返回的第四STUN绑定请求的响应，根据第四STUN绑定请求的响应判断NAT的过滤类型，在客户端没有收到第四STUN绑定请求的响应而引发接收超时，则识别出NAT的过滤类型为地址和端口相关过滤的NAT类型。需要说明的是，在识别出NAT的过滤类型为地址和端口相关过滤的NAT类型时，这里的掩蔽IP地址即为NAT设备上的外网IP地址，该第三掩蔽端口的值由NAT的分配策略而定，没有特殊意义。S603、当基于过滤行为探测识别出NAT的过滤类型为地址和端口相关过滤的NAT类型时，向STUN服务器发起顺序行为探测，并基于顺序行为探测识别NAT的顺序类型。所述向STUN服务器发起顺序行为探测，并基于顺序行为探测识别NAT的顺序类型，包括：以客户端的固定IP地址和第二客户端口向STUN服务器的第一服务IP地址和第二服务端口发送第五STUN绑定请求，并从STUN服务器返回的第五STUN绑定请求的响应中得到NAT映射后的掩蔽IP地址和第五掩蔽端口；解析第五掩蔽端口是否与第三掩蔽端口相同，若第五掩蔽端口与第三掩蔽端口相同则NAT的顺序类型为收发顺序无关的NAT类型，若第五掩蔽端口与第三掩蔽端口不同则NAT的顺序类型为收发顺序相关的NAT类型。需要说明的是，在识别NAT的顺序类型时，这里的掩蔽IP地址即为NAT设备上的外网IP地址，该第五掩蔽端口的值由NAT的分配策略而定，没有特殊意义。这里通过顺序行为探测，使得其可以通过识别出NAT映射端口上的数据收发顺序类型从而得出映射端口是否有效的判定，以使得客户端能够预测出不同局域网内两个主机之间在特定条件下是否能够建立P2P数据传输。这里以图1所示的NAT探测的系统架构结合图1至图6的技术原理为例进行说明如下：如图7所示的NAT探测的方法流程图，其可以先依照RFC5780的探测流程进行映射探测和过滤探测，再进行顺序行为探测即705，这里的IP地址和端口号数字不是强制性，仅为说明原理而随意指定，若涉及到具体的STUN协议可以参考RFC4787和RFC5780中的规范要求，这里不再详细描述。1、映射行为探测如下：701、客户端A以地址和端口a.a.a.a:10000向STUN服务器的地址和端口s.s.s.s:3478发送STUN绑定请求；从STUN服务器返回的响应中得到NAT映射后的地址和端口为：m.m.m.m:10000；702、客户端A以地址和端口a.a.a.a:10000向STUN服务器的地址和端口t.t.t.t:3478发送STUN绑定请求；通过NAT映射的地址和端口仍然为：m.m.m.m:10000。依据RFC4787和RFC5780所述，该NAT类型为端点无关映射的NAT，如果NAT类型为不是“端点无关映射的NAT”，则不满足本发明所设定的条件，不必进行下面的过滤行为探测步骤。需要说明的是，映射和过滤是NAT的两种行为，映射指的是局域网内的IP地址和端口号怎样与NAT上的端口对应，一个从局域网发往外网的数据包在经过NAT时，NAT会把该数据包中的源IP地址替换为NAT的外网IP地址，并且会把数据包中的源端口号替换为经NAT映射后的端口号，映射的规则由不同的NAT端口分配策略来定，来自外网的数据到达NAT后，NAT会检索该数据包中的目的端口，若目的端口为NAT先前映射的端口，NAT会把把该数据包中的目的IP地址和目的端口进行替换，并转发给内网主机。过滤指的是NAT是否允许来自外部的数据通过NAT并转发至某个内网主机。2、过滤行为探测如下：703、客户端A以地址和端口a.a.a.a:20000向STUN服务器的地址和端口s.s.s.s:3478发送绑定请求，且客户端收到了STUN服务器的响应，并从STUN服务器返回的响应中得到此次通过地址和端口a.a.a.a：20000向STUN服务器的地址和端口s.s.s.s：3478发送数据时NAT映射的地址和端口为：m.m.m.m:20000；704、客户端A以地址和端口a.a.a.a:20000向STUN服务器的地址和端口s.s.s.s:3478发送绑定请求，并设置STUN请求报文的Change IP和Change PORT属性为1，设置请求报文中Change IP和Change PORT属性值为1的目的是请求服务器以另外一个地址和端口来回复此请求，客户端基于此请求的回复进行以下两种判断：、若客户端A没有收到此请求的响应而引发接收超时，则此NAT类型属于“地址和端口相关过滤的NAT”，原因是当STUN服务器用t.t.t.t：3479向NAT的映射地址和端口发送数据时，NAT会丢弃此数据；、若客户端收到了此请求的响应，则该NAT属于“端点无关过滤的NAT”，NAT会转发该数据到对应的内网主机。若NAT的过滤行为是所述，即NAT的过滤行为是“地址和端口相关过滤的NAT”时，可继续下面的“顺序行为探测”步骤，否则若过滤行为是所述时不符合本文所设定的条件，不必继续下面的“顺序行为探测”探测步骤。3、顺序行为探测如下：705、客户端A以地址和端口a.a.a.a：20000，向STUN服务器s.s.s.s：3479地址和端口发送绑定请求，则：若NAT属于“收发顺序相关映射的NAT”时，NAT会屏蔽20000这个映射端口，NAT会用另外一个端口重新作为对该收发两端四元组的映射，如图7中用1111端口作为新的映射，从STUN服务器返回的STUN响应报文可以看到NAT使用了新的1111端口作为映射，而20000端口被NAT暂时屏蔽，该1111端口在数值上由NAT的分配策略而定。若NAT属于“收发顺序无关映射的NAT”时，NAT仍然会用先前的20000作为该收发两端四元组的映射，从STUN服务器返回的STUN响应报文中可以看到对此次STUN绑定请求，NAT仍然用先前的20000端口作为映射。到此，可以用上面的“顺序行为探测”中的第705步的结果来判断该NAT的行为属于下面哪一种，即：收发顺序相关映射的NAT；收发顺序无关映射的NAT。这两种NAT行为，可以作为对RFC4787规范的补充，上面的“顺序行为探测“也可以作为对RFC5780探测NAT行为的补充。在不同局域网内的设备之间实现P2P穿透后，可以使两个位于不同局域网的设备直接传输基于UDP协议的数据，避免了使用服务器转发数据而带来的流量成本和运营成本，基于NAT的顺序行为探测可以预测NAT之间是否能够建立P2P以及建立P2P的方法，由于现有的RFC的相关文件中并没有“顺序行为探测”，只有“映射探测”和“过滤探测”，而RFC中的方法不能够对有“顺序相关映射的NAT”的NAT之间是否能够成功建立P2P而准确预测。基于本发明实施例中的NAT的探测方式，使得位于不同NAT之后的两个客户端在进行P2P数据传输通道建立前，可以先对自身的NAT行为进行探测，进而了解相互所对应的NAT类型，从而实现客户端彼此的预测得出是否能够在这两个客户端之间建立起P2P通道。本申请实施例还提供了一种计算机存储介质，该计算机可读存储介质中存储有指令，当其在计算机或处理器上运行时，使得计算机或处理器执行上述任一个实施例所述方法中的一个或多个步骤。上述装置的各组成模块如果以软件功能单元的形式实现并作为独立的产品销售或使用时，可以存储在所述计算机可读取存储介质中，基于这样的理解，本申请的技术方案本质上或者说对现有技术做出贡献的部分或者该技术方案的全部或部分可以以软件产品的形式体现出来，该计算机产品存储在计算机可读存储介质中。上述计算机可读存储介质可以是前述实施例所述的设备的内部存储单元，例如硬盘或内存。上述计算机可读存储介质也可以是上述设备的外部存储设备，例如配备的插接式硬盘，智能存储卡，安全数字卡，闪存卡等。进一步地，上述计算机可读存储介质还可以既包括上述设备的内部存储单元也包括外部存储设备。上述计算机可读存储介质用于存储上述计算机程序以及上述设备所需的其他程序和数据。上述计算机可读存储介质还可以用于暂时地存储已经输出或者将要输出的数据。本领域普通技术人员可以理解实现上述实施例方法中的全部或部分流程，可通过计算机程序来指令相关的硬件来完成，该计算机的程序可存储于计算机可读取存储介质中，该程序在执行时，可包括如上述各方法的实施例的流程。而前述的存储介质包括：ROM、RAM、磁碟或者光盘等各种可存储程序代码的介质。以上对本发明实施例进行了详细介绍，本文中采用了具体个例对本发明的原理及实施方式进行了阐述，以上实施例的说明只是用于帮助理解本发明的方法及其核心思想；同时，对于本领域的一般技术人员，依据本发明的思想，在具体实施方式及应用范围上均会有改变之处，综上所述，本说明书内容不应理解为对本发明的限制。
