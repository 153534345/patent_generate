标题title
机器视觉测量系统与传感器芯片模拟参数调整方法
摘要abst
本发明揭示一种机器视觉测量系统，包括图像传感器芯片及控制处理器配合使用，所述控制处理器还包括一高动态范围成像系统模块，所述高动态范围成像系统模块包括：数据接收模块，用以根据行数据的个数同步行起点与终点；数据特征值分析模块，用以对串行数据进行特征值提取；参数裁决反馈模块，判断所提取的上述特征值是否位于预先设置的最优工作区域，如是则保持图像传感器芯片的模拟参数不变；如否则调整图像传感器芯片的模拟参数；同步系统控制生成器模块，用以跟踪图像传感器芯片的控制工作时序并启动数据输入检测窗口；同步模拟参数输出模块，根据同步系统控制生成器模块的信号，更新图像传感器芯片的模拟参数。
权利要求书clms
1.一种机器视觉测量系统，包括图像传感器芯片及控制处理器配合使用，所述图像传感器芯片包括光电传感器阵列、采样读出电路、运算放大器、模数转换器、阵列曝光控制器、系统控制生成器及通信接口配置模块，所述控制处理器包括通信接口配置模块、主控制系统、数据输出系统及数据处理系统，其特征在于所述控制处理器还包括一高动态范围成像系统模块，所述高动态范围成像系统模块包括：数据接收模块，用以根据行数据的个数同步行起点与终点；数据特征值分析模块，用以对串行数据进行特征值提取；参数裁决反馈模块，判断所提取的上述特征值是否位于预先设置的最优工作区域，如是则保持图像传感器芯片的模拟参数不变；如位于最优区域上方，则将特征值沿下降趋势调节图像传感器芯片的模拟参数，反之则将特征值沿上升趋势调节图像传感器芯片的模拟参数；同步系统控制生成器模块，用以跟踪图像传感器芯片的控制工作时序并启动数据输入检测窗口；同步模拟参数输出模块，根据同步系统控制生成器模块的信号，更新图像传感器芯片的模拟参数。2.如权利要求1所述的机器视觉测量系统，其特征在于：所述特征值为像素最大值、均值或对比度之一。3.如权利要求2所述的机器视觉测量系统，其特征在于：所述模拟参数包括增益参数与量化参数。4.一种利用权利要求1所述的机器视觉测量系统调整图像传感器芯片的模拟参数的方法，包括如下步骤：获取裁决区间参数，设定像素特征的最优工作区间；系统工作启动后，同步系统控制生成器模块跟踪图像传感器芯片的控制工作时序并启动数据输入检测窗口；数据接收模块根据行数据的个数同步行起点和终点；数据特征值分析模块对串行数据进行特征值提取；参数裁决反馈模块判断所提取的上述特征值是否位于设置好的最优工作区间，如是则保持模拟参数不变；如位于最优区域上方，则将特征值沿下降趋势调节图像传感器芯片的模拟参数，反之则将特征值沿上升趋势调节图像传感器芯片的模拟参数；同步模拟参数输出模块根据同步系统控制信号，更新图像传感器芯片的模拟参数。5.如权利要求4所述的方法，其特征在于：所述特征值为像素最大值、均值或对比度之一。6.如权利要求4所述的方法，其特征在于：所述模拟参数为增益参数和量化参数。7.如权利要求4所述的方法，其特征在于：所述将特征值沿上升趋势调节图像传感器芯片的模拟参数为调大增益参数和调小量化参数，而将特征值沿下降趋势调节图像传感器芯片的模拟参数为调小增益参数和调大量化参数。8.如权利要求4所述的方法，其特征在于：所述模拟参数为增益参数和量化参数，调节图像传感器芯片的模拟参数的方法包括如下步骤：根据增益参数与量化电压可能的取值建立等效增益取值表，其中等效增益为增益参数与量化电压的比值；取得当前行的特征值V0及等效增益K0；确定放大倍数K’，其中放大倍数K’=预期等效增益K1/等效增益K0；枚举所有放大倍数的新预期目标值，其中新预期目标值为当前行的特征值V0*放大倍数K’；依据落入最优工作区间的新预期目标值确定放大倍数K’，之后再确定预期等效增益K1，之后再根据上述等效增益取值表确定预期等效增益K1对应的增益参数与量化参数。9.如权利要求8所述的方法，其特征在于：如果存在多个落入最优工作区间的新预期目标值，则可选择与最优工作区间的中间值最接近的新预期目标值确定放大倍数K’。
说明书desc
技术领域本发明属于测量领域，特别涉及一种通过动态反馈实现帧内高动态范围成像的机器视觉测量系统与传感器芯片模拟参数调整方法。背景技术高动态范围成像是指在计算机图形学与电影摄影术中用来实现比普通数字图像技术更大曝光动态范围的一组技术。在工业机器视觉领域方面，HDR多用于解决明暗差异较大或者存在多重反射带来的成像干扰等场景中。目前已知的方法有帧间对比方法和单帧高动态范围成像方法。其中帧间对比方法指采集两帧或多帧不同的图像进行对比，再结合算法设计进行判定选择。该方法包含不同的曝光时间与不同的增益配置两种形式，该方法需要多帧的运行时间，且由于被测物在运行过程中，帧与帧之间采样的图像已经可能不是针对被测物体的同一个位置，如此会引入帧间干扰。而单帧高动态范围成像方法通过单帧即可实现，主要通过曝光时长的不同，产生非线性的量化方法。该方法通过曝光时长而非实际光学响应的方式，对于应当进行差异化数据处理的地方在实际运行中因为非线性转换节点而没有实施，其实际效果受限，对于被测物不同感光强度的区别无法做出反应，虽然实现了单帧高动态范围成像，但其真实帧率也仅为非高动态范围成像工作模式的一半左右，对帧率的影响与帧间对比方法相当。以上方法均对于机器视觉领域应用的高帧率采样需求有显著影响，其会导致帧率接近减半，因此无法适用于机器视觉领域。发明内容本发明的目的在于提供一种机器视觉测量系统与传感器芯片模拟参数调整方法，用以解决现有技术对帧率产生较大影响的问题。为实现上述目的，实施本发明的一种机器视觉测量系统，包括图像传感器芯片及控制处理器配合使用，所述图像传感器芯片包括光电传感器阵列、采样读出电路、运算放大器、模数转换器、阵列曝光控制器、系统控制生成器及通信接口配置模块，所述控制处理器包括通信接口配置模块、主控制系统、数据输出系统及数据处理系统，其特征在于所述控制处理器还包括一高动态范围成像系统模块，所述高动态范围成像系统模块包括：数据接收模块，用以根据行数据的个数同步行起点与终点；数据特征值分析模块，用以对串行数据进行特征值提取；参数裁决反馈模块，判断所提取的上述特征值是否位于预先设置的最优工作区域，如是则保持图像传感器芯片的模拟参数不变；如位于最优区域上方，则将特征值沿下降趋势调节图像传感器芯片的模拟参数，反之则将特征值沿上升趋势调节图像传感器芯片的模拟参数；同步系统控制生成器模块，用以跟踪图像传感器芯片的控制工作时序并启动数据输入检测窗口；同步模拟参数输出模块，根据同步系统控制生成器模块的信号，更新图像传感器芯片的模拟参数。依据上述主要特征，所述特征值为像素最大值、均值或对比度之一。依据上述主要特征，所述模拟参数包括增益参数与量化参数。为实现上述目的，本发明提供一种利用上述的机器视觉测量系统调整图像传感器芯片的模拟参数的方法，所述方法包括如下步骤：获取裁决区间参数，设定像素特征的最优工作区间；系统工作启动后，同步系统控制生成器模块跟踪图像传感器芯片的控制工作时序并启动数据输入检测窗口；数据接收模块根据行数据的个数同步行起点和终点；数据特征值分析模块对串行数据进行特征值提取；参数裁决反馈模块判断所提取的上述特征值是否位于设置好的最优工作区间，如是则保持模拟参数不变；如位于最优区域上方，则将特征值沿下降趋势调节图像传感器芯片的模拟参数，反之则将特征值沿上升趋势调节图像传感器芯片的模拟参数；同步模拟参数输出模块根据同步系统控制信号，更新图像传感器芯片的模拟参数。依据上述主要特征，所述特征值为像素最大值、均值或对比度之一。依据上述主要特征，所述模拟参数为增益参数和量化参数。依据上述主要特征，所述将特征值沿上升趋势调节图像传感器芯片的模拟参数为调大增益参数和调小量化参数，而将特征值沿下降趋势调节图像传感器芯片的模拟参数为调小增益参数和调大量化参数。依据上述主要特征，所述模拟参数为增益参数和量化参数，调节图像传感器芯片的模拟参数的方法包括如下步骤：根据增益参数与量化电压可能的取值建立等效增益取值表，其中等效增益为增益参数与量化电压的比值；取得当前行的特征值V0及等效增益K0；确定放大倍数K’，其中放大倍数K’=预期等效增益K1/等效增益K0；枚举所有放大倍数的新预期目标值，其中新预期目标值为当前行的特征值V0*放大倍数K’；依据落入最优工作区间的新预期目标值确定放大倍数K’，之后再确定预期等效增益K1，之后再根据上述等效增益取值表确定预期等效增益K1对应的增益参数与量化参数。依据上述主要特征，如果存在多个落入最优工作区间的新预期目标值，则可选择与最优工作区间的中间值最接近的新预期目标值确定放大倍数K’。与现有技术相比较，本发明利用行与行之间的转换时间，完成计算反馈与特征配置的变更，从而完成单帧图像内连续调节，达到对图像持续变化的跟踪，具有如下技术效果：第一，通过单帧高动态范围成像模式，不用降低帧率，不会出现不同帧间的信息差干扰；第二，帧内不同位置与场景实时跟踪采用不同的增益配置和动态量化范围，防止出现信息过弱或者过曝的问题。附图说明图1为实施本发明的机器视觉测量系统的功能模块组成示意图。图2为实施本发明的机器视觉测量系统的工作流程示意图。图3为高动态范围成像系统模块的工作流程示意图。具体实施方式请参阅图1所示，实施本发明的机器视觉测量系统的功能模块组成示意图，实施本发明的机器视觉测量系统包括：上位机系统，用以接受使用者的输入指令并发送至控制处理器，并且接受控制处理器输出的数据并呈现给使用者；控制处理器，包括通信接口配置模块、主控制系统、数据输出系统及数据处理系统，其中上述的通信接口配置模块、主控制系统、数据输出系统及数据处理系统的工作原理现有技术中均有描述，此处不再详细说明。另外，所述控制处理器还包括一高动态范围成像系统模块；图像传感器芯片，包括光电传感器阵列、采样读出电路、运算放大器、模数转换器、阵列曝光控制器、系统控制生成器及通信接口配置模块，其中上述的光电传感器阵列、采样读出电路、运算放大器、模数转换器、阵列曝光控制器、系统控制生成器及通信接口配置模块的工作原理和方式在现有技术中多有揭示，此处不再详细说明。本发明的改进之处在于在控制处理器中增加设置一高动态范围成像系统模块，所述高动态范围成像系统模块包括：数据接收模块，用以根据行数据的个数同步行起点与终点，并标识相应的数据有效/无效标志；数据特征值分析模块，用以对串行数据进行特征值提取，所述特征值可为像素最大值、最小值、均值、对比度、灰度光斑大小等一个或多个的组合；参数裁决反馈模块，判断所提取的上述特征值是否位于预先设置的最优工作区域，如是则保持图像传感器芯片的模拟参数不变；如位于最优区域上方，则将特征值沿下降趋势调节图像传感器芯片的模拟参数，反之则将特征值沿上升趋势调节图像传感器芯片的模拟参数；同步系统控制生成器模块，用以跟踪图像传感器芯片的控制工作时序并启动数据输入检测窗口；同步模拟参数输出模块，根据同步系统控制生成器模块的信号，更新图像传感器芯片的模拟参数，在具体实施时，所述模拟参数包括增益参数与量化参数。请参阅图2所示，为实施本发明的机器视觉测量系统的工作流程示意图，实施本发明的机器视觉测量系统的工作流程包括如下步骤：系统上电，图像传感器芯片和控制处理器完成上电过程；控制处理器完成过对图像传感器芯片的识别，上位机完成对控制处理器与图像传感器芯片的功能及参数的配置；控制处理器与图像传感器芯片进入待机状态，等待启动指令；上位机对控制处理器发出启动指令，控制处理器响应启动指令并对图像传感器芯片发出事件触发信号，每一个信号触发传感器完成一次曝光和数据传输的完整流程；图像传感器芯片根据事件触发信号，生成控制信号，包括曝光控制信号、采样控制信号及数据输出控制信号等，控制处理器同步生成以上信号；逐行曝光控制，其中曝光时序实现CDS，行间操作的时间间隙用于HDR处理流程的时间损耗，使转化数据与模拟参数匹配一致；像素电压采样，其中采样读出电路支持CDS需求，完成复位电压与曝光电压的采样，其中每一个行周期将一行像素全部使用采样读出电路待输出至包括运算放大器和模数转换器组成的转换电路；将一行数据按序串行控制输出，之后运算放大器采样，模数转换器转换输出至高动态范围成像系统模块进行处理，更新模拟参数。请参阅图3所示，为高动态范围成像系统模块的工作流程示意图。高动态范围成像系统模块的工作流程具体包括如下步骤：控制处理器系统上电后进行初始化配置，其中高动态范围成像系统模块获取裁决区间参数，设定像素特征的最优工作区间；并配置图像传感器芯片阵列的规格信息，以用于同步图像传感器芯片与控制处理器的控制/数据传输等过程，以用于控制处理器对图像传感器芯片进行时序操作的同步跟踪，以准确预知图像传感器芯片所处的工作节点。其中所述的裁决区间参数具体可以通过上位机进行配置及更新。由于光电传感器受光照后形成光电流，光强越强，光电流越大，放电时间越长，形成的响应电压越大，最终会根据器件参数等经历电压线性增加-饱和区间-过曝的过程，饱和区间和过曝区间表征随着时间增加，其电压变化和光强度是非线性的关系，该区间无法反映真实的强度对比，裁决参数的区间，其根据器件的工作原理和数据处理对于数据特征区间的要求，一般是指特征值位于非饱和区和临近线性区的数据区间，以灰度位深8Bit为例，该区间大致位于。进入待机状态；上位机启动系统工作后，同步系统控制生成器模块跟踪图像传感器芯片的控制工作时序并启动数据输入检测窗口；数据接收模块根据行数据的个数同步行起点和终点，并标识相应的数据有效标志/无效标志；数据特征值分析模块对串行数据进行特征值提取，即前述将每行的起点与终点标定后，接收完每行的数据就便进行特征值提取，所述特征值可为像素最大值、均值或对比度之一，较佳地以像素最大值为特征值；参数裁决反馈模块判断所提取的上述特征值是否位于设置好的最优工作区间，如是则保持模拟参数不变；如位于最优区域上方，则将特征值沿下降趋势调节，反之则将特征值沿上升趋势调节；同步模拟参数输出模块根据同步系统控制信号，在适当的时序位置更新图像传感器芯片的模拟参数，在具体实施时，所述模拟参数为增益参数和量化参数。以下以一具体的实施例说明上述的实施过程，其中模拟参数1为增益参数Gain，模拟参数2为量化参数adc_ref，对应量化电压Vref，曝光电压为Ve，模数转换器的转换公式为特征值ADC_DATA= 曝光电压Ve * 增益参数Gain /  = 曝光电压Ve* 增益参数Gain * 1024 / 量化电压Vref，首先设定初始工作条件，设增益参数Gain为1，量化电压1V，模数转换器为10Bit，则特征值ADC_DATA = 1024 * 曝光电压Ve / 量化电压Vref；裁决判定过程以单个数值为例，假设最优工作区域为一个区间，当特征值ADC_DATA介于Dmin与Dmax之间，则保持两个模拟参数不变；当特征值ADC_DATA ＜Dmin，可以通过调大增益参数Gain和调小量化电压Vref的方式增大特征值ADC_DATA；当特征值ADC_DATA ＞ Dmin，可以通过调小增益参数Gain和调大量化电压Vref的方式减小特征值ADC_DATA。受设计条件的限制，增益参数Gain与量化电压Vref不可能实现完全连续，可以表征为任意值。为简化，也可采用查表的方式确定，如上述的公式：特征值ADC_DATA=曝光电压Ve * 增益参数Gain /  = 曝光电压Ve * 增益参数Gain * 1024 /量化电压Vref =曝光电压Ve * 1024*增益参数Gain / 量化电压Vref，增益参数Gain /量化电压Vref=等效增益K，如此特征值ADC_DATA=曝光电压Ve * 1024*等效增益K，在实际的运用中，增益参数Gain对特征值ADC_DATA的影响倍率更大，具体设计时增益参数Gain可设为1、2、4倍，量化电压Vref具体设计时可设为0.8、1、1.2、1.4。如此可利用公式等效增益K=增益参数Gain/量化电压Vref建立如表1所示的等效增益K的取值表。诚然，表中增益参数Gain 与量化电压Vref的取值仅是示例，增益参数Gain 与量化电压Vref的取值可以更精细，如此等效增益K有更多的取值，从而令调节过程更加精确。在建立上述等效增益K的取值表后，采用以下步骤更新模拟参数：数据特征值分析模块对串行数据进行特征值提取，即接收完每行的数据就便提取当前行的特征值V0；如当前行的特征值位于设置好的最优工作区间，如是则保持模拟参数不变，否则取得当前的等效增益K0，其中等效增益K0=增益参数Gain/量化电压Vref；之后利用表2枚举所有放大倍数的新预期目标值，在等效增益K0确定后，预期等效增益K1可根据表2确定，如表1所知，等效增益K0与等效增益K1的取值范围是相同的，如此等效增益K0确定后，便可以通过表2得到预期等效增益K1的12个可能的取值，假如如等效增益K0=1.25，则预期等效增益K1可取为：1.25、1、0.833、0.714、2.5、2、1.66667、1.4286、5、4、3.33、2.857，即共12个取值；之后计算放大倍数K’=预期等效增益K1/等效增益K0;之后取得新预期目标值=当前行的特征值V0*放大倍数K’；依据落入最优工作区间的新预期目标值确定放大倍数K’，之后再确定预期等效增益K1，之后再根据表1确定预期等效增益K1对应的增益参数Gain与量化参数adc_ref，从而更新图像传感器芯片的上述两个模拟参数。在上一步骤中，如果存在多个落入最优工作区间的新预期目标值，则可选择与最优工作区间的中间值最接近的新预期目标值。与现有技术相比较，本发明利用行与行之间的转换时间，完成计算反馈与特征配置的变更，从而完成单帧图像内连续调节，达到对图像持续变化的跟踪，具有如下技术效果：第一，通过单帧HDR模式，不用降低帧率，不会出现不同帧间的信息差干扰；第二，帧内不同位置与场景实时跟踪采用不同的增益配置和动态量化范围，防止出现信息过弱或者过曝的问题。可以理解的是，对本领域普通技术人员来说，可以根据本发明的技术方案及其发明构思加以等同替换或改变，而所有这些改变或替换都应属于本发明所附的权利要求的保护范围。
