标题title
一种O-RAN系统时序同步互备份方法
摘要abst
本发明公开了一种O‑RAN系统时序同步互备份方法，涉及移动通信技术领域，在O‑RU侧设置有1588主时序维护模块、O‑RAN时间节拍辅时序维护模块以及时序切换控制模块；时序切换控制模块能检测所述1588主时序维护模块是否异常，若异常，则切换为使用所述O‑RAN时间节拍辅时序维护模块，若正常，则切换为使用所述1588主时序维护模块。本发明相当于O‑RU中维护了两个时序：主时序—基于1588和syncE得到的时序；辅时序—O‑DU节拍时序。这两个时序互备份，一旦在主时序中出现异常可以根据辅时序来平滑整个系统，1558主时序和O‑RAN时序的辅时序互备份系统不会涉及到消息结构改进，保证了接口不变，具有极好的兼容性。
权利要求书clms
1.一种O-RAN系统时序同步互备份方法，其特征在于，在O-RU侧设置有1588主时序维护模块、O-RAN时间节拍辅时序维护模块以及时序切换控制模块，且在同一时刻，仅有所述1588主时序维护模块和O-RAN时间节拍辅时序维护模块中的一个处于工作状态；所述时序切换控制模块能检测所述1588主时序维护模块是否异常，若异常，则切换为使用所述O-RAN时间节拍辅时序维护模块，若正常，则切换为使用所述1588主时序维护模块；所述1588主时序维护模块在工作时，基于1588协议和syncE维护O-DU和O-RU的O-RAN时序主同步，在该状态下，O-RU内部跟踪O-DU下发的O-RAN数据面消息或者O-RAN控制面消息里面的时序信息；所述O-RAN时间节拍辅时序维护模块在工作时，采用用户自定义的缓存区存储一个数据结构信息，记为map，其中key是接收到当前O-RAN数据面消息的时间t,value是四元组信息，每次更新完四元组信息时，将时间t更新到O-RU的时间计数器。2.根据权利要求1所述的O-RAN系统时序同步互备份方法，其特征在于，所述时序切换控制模块能记录了当前使用的是所述1588主时序维护模块，或者所述O-RAN时间节拍辅时序维护模块。3.根据权利要求2所述的O-RAN系统时序同步互备份方法，其特征在于，所述时序切换控制模块具有一个时序运行模式变量，该时序运行模式变量具有两种赋值状态，分别对应所述1588主时序维护模块和O-RAN时间节拍辅时序维护模块。4.根据权利要求3所述的O-RAN系统时序同步互备份方法，其特征在于，当存在以下四种判定条件中的至少一种时，则认为所述1588主时序维护模块异常；所述1588主时序维护模块计算出的时序误差超过误差阈值，并持续时长T1；延迟请求接收时间t4比同步报文发送时间t1早，并持续时长T2；收不到1588同步报文或者跟进报文，并持续时长T3；1588延迟请求报文发送失败，并持续时长T4。5.根据权利要求4所述的O-RAN系统时序同步互备份方法，其特征在于，所述误差阈值为10us。6.根据权利要求4所述的O-RAN系统时序同步互备份方法，其特征在于，用户能自定义所述误差阈值。7.根据权利要求4所述的O-RAN系统时序同步互备份方法，其特征在于，用户能自定义T1、T2、T3和T4，T1=T2=T3=T4。8.根据权利要求4所述的O-RAN系统时序同步互备份方法，其特征在于，在O-DU和O-RU的时序同步后，O-DU的下行流程包括以下步骤：S1、O-DU中的业务模块将业务数据发送到基带模块；S2、基带模块对业务数据进行处理；S3、基带模块通过O-DU中的O-RAN模块，根据当前时序向O-RU中的O-RAN模块下发O-RAN控制面消息，在O-RAN控制面消息中带有当前基带时序信息；S4、O-DU中的O-RAN模块向O-RU中的O-RAN模块下发O-RAN数据面消息，所述O-RAN数据面消息的数目与一个时序中包含的symbol时序数目相同，每接收到一个symbol的O-RAN数据面消息，均会触发运行O-RAN时间节拍辅时序维护模块；S5、O-RU中的O-RAN模块对O-RAN控制面消息和O-RAN数据面消息进行处理，并将得到的IQ频域数据发送至O-RU中的射频模块处理后发射出去。9.根据权利要求8所述的O-RAN系统时序同步互备份方法，其特征在于，在步骤S4中，O-RAN时间节拍辅时序维护模块根据每个symbol的O-RAN数据面消息更新时间计数器，以及用户自定义的缓存区存储的数据结构信息map。
说明书desc
技术领域本发明涉及一种O-RAN系统时序同步互备份方法，应用于移动通信，特别在5G NRO-RAN系统上基带处理单元和远程拉远射频单元之间时序同步。背景技术O-RAN，即Open RAN，这个标准联盟是为了适应迅猛增长的移动业务，移动网络及相关网络设备必须更加绿色、灵活及智能，实现方式应该更加软件化和虚拟化。O-RAN主要通过定义开放标准接口实现设备的解耦和软件化，目前O-RAN定义了很多标准接口，如前传标准接口O-RAN-WG4.CUS-V03.00等，在这个前传协议接口里面，O-DU负责信号的频域处理，O-RU负责下行频域转时域和上行的时域转频域的处理；O-DU和O-RU之间的时序同步是整个O-RAN系统的关键技术难点，常用的技术就是通过1588协议和syncE来实现O-DU和O-RU之间时序同步。在实际情况可能由于以下异常造成整个O-RAN系统时序紊乱：O-DU主时钟的异常，不管是从GPS或者其他服务器来的时间，可能引起O-DU和O-RU之间1588同步的异常，如O-RU发现1588时间戳异常，O-RU计算出来sync offset异常等；O-DU和O-RU网络间特殊报文冲击，造成1588协议报文不能正常通信从而影响时序同步更新。在这些异常情况下，如何平滑的让整个O-RAN系统正常使用也是O-RAN系统一个难点所在。发明内容本发明在于提供一种O-RAN系统时序同步互备份方法，其能够缓解上述问题。为了缓解上述的问题，本发明采取的技术方案如下：本发明提供了一种O-RAN系统时序同步互备份方法，在O-RU侧设置有1588主时序维护模块、O-RAN时间节拍辅时序维护模块以及时序切换控制模块，且在同一时刻，仅有所述1588主时序维护模块和O-RAN时间节拍辅时序维护模块中的一个处于工作状态；所述时序切换控制模块能检测所述1588主时序维护模块是否异常，若异常，则切换为使用所述O-RAN时间节拍辅时序维护模块，若正常，则切换为使用所述1588主时序维护模块；所述1588主时序维护模块在工作时，基于1588协议和syncE维护O-DU和O-RU的O-RAN时序主同步，在该状态下，O-RU内部跟踪O-DU下发的O-RAN数据面消息或者O-RAN控制面消息里面的时序信息；所述O-RAN时间节拍辅时序维护模块在工作时，采用用户自定义的缓存区存储一个数据结构信息，记为map，其中key是接收到当前O-RAN数据面消息的时间t,value是四元组信息，每次更新完四元组信息时，将时间t更新到O-RU的时间计数器。本技术方案的技术效果是：本技术方案相当于O-RU中维护了两个时序：主时序—基于1588和syncE得到的时序；辅时序—O-DU节拍时序。这两个时序互备份，一旦在主时序中出现异常可以根据辅时序来平滑整个系统。1558主时序和O-RAN时序的辅时序互备份系统不会涉及到消息结构改进，保证了接口不变，具有极好的兼容性。在本发明的一较佳实施方式中，所述时序切换控制模块能记录了当前使用的是所述1588主时序维护模块，或者所述O-RAN时间节拍辅时序维护模块。本技术方案的技术效果是：可以达到35us时钟滴答精度，精度高，不需要额外通过其他新的消息方式，直接是基于存在的O-RAN协议消息来维护，这样引入的模块不会破坏原有协议；最后一个优势是引入的模块记录的map也有映射关系，每35us时钟滴答都对应O-DU的一个时序,这样O-RU维护的时间计数器，每一个计数器都可以反映实际O-DU的时序。在本发明的一较佳实施方式中，所述时序切换控制模块具有一个时序运行模式变量，该时序运行模式变量具有两种赋值状态，分别对应所述1588主时序维护模块和O-RAN时间节拍辅时序维护模块。本技术方案的技术效果是：时序运行模式变量的二义性可以精确指明模式，对变量的读写互斥操作容易操作，需要的资源也少，另外对变量更新能及时反映新的模式状态，切换实时效果很高，其他方式如模块间的消息交互需要新定义消息，发送和接收消息也需要资源，另外切换也有延迟性。在本发明的一较佳实施方式中，当存在以下四种判定条件中的至少一种时，则认为所述1588主时序维护模块异常；所述1588主时序维护模块计算出的时序误差超过误差阈值，并持续时长T1；延迟请求接收时间t4比同步报文发送时间t1早，并持续时长T2；收不到1588同步报文或者跟进报文，并持续时长T3；1588延迟请求报文发送失败，并持续时长T4。本技术方案的技术效果是：上述四种异常是直接根据1588协议特征能明确反映时序同步异常，不会引入误判，是一种直接而且效率高的异常检测方式。在本发明的一较佳实施方式中，所述误差阈值是可配的，默认为10us。本技术方案的技术效果是：引入一个可配阈值可以更好匹配实际系统特性，在实际部署中可根据系统里面1588时间戳硬件特性指标根据默认值微调，可以适配实际系统子载波配置，误差阈值可以严格限制为子载波配置对应时间保护带，例如30khz的子载波配置下保护带为2.86us，如果时序误差超过这个阈值，O-RU和O-DU之间同步会造成空口符号解析出错造成整个系统失效。在本发明的一较佳实施方式中，用户能自定义T1、T2、T3和T4，T1=T2=T3=T4。本技术方案的技术效果是：能在一定程度上增加可应用场景。在本发明的一较佳实施方式中，在O-DU和O-RU的时序同步后，O-DU的下行流程包括以下步骤：S1、O-DU中的业务模块将业务数据发送到基带模块；S2、基带模块对业务数据进行处理；S3、基带模块通过O-DU中的O-RAN模块，根据当前时序向O-RU中的O-RAN模块下发O-RAN控制面消息，在O-RAN控制面消息中带有当前基带时序信息；S4、O-DU中的O-RAN模块向O-RU中的O-RAN模块下发O-RAN数据面消息，所述O-RAN数据面消息的数目与一个时序中包含的symbol时序数目相同，每接收到一个symbol的O-RAN数据面消息，均会触发运行O-RAN时间节拍辅时序维护模块；S5、O-RU中的O-RAN模块对O-RAN控制面消息和O-RAN数据面消息进行处理，并将得到的IQ频域数据发送至O-RU中的射频模块处理后发射出去。本技术方案的技术效果是：在S4步骤，直接根据已存在的协议消息通过引入O-RAN时间节拍辅时序模块，这种方案没有增加新的消息流程，没有破坏O-RAN协议交互，该方案最大优点是借用S4已有每35us一个symbol数据面消息来作为触发源，可以提供高精度的时钟源，另外也提供每次触发源对应的O-DU时序信息，O-RU直接可以通过时间计数器找到匹配的O-DU时序。为使本发明的上述目的、特征和优点能更明显易懂，下文特举本发明实施例，并配合所附附图，作详细说明如下。附图说明为了更清楚地说明本发明实施例的技术方案，下面将对实施例中所需要使用的附图作简单地介绍，应当理解，以下附图仅示出了本发明的某些实施例，因此不应被看作是对范围的限定，对于本领域普通技术人员来讲，在不付出创造性劳动的前提下，还可以根据这些附图获得其他相关的附图。图1是5G基站系统拓扑；图2是O-DU和O-RU时序同步和下行流程；图3是O-RAN数据面宏观结构；图4是O-RAN数据面详细消息；图5是实施例中的时序收敛误差异常日志；具体实施方式为使本发明实施例的目的、技术方案和优点更加清楚，下面将结合本发明实施例中的附图，对本发明实施例中的技术方案进行清楚、完整地描述，显然，所描述的实施例是本发明一部分实施例，而不是全部的实施例。通常在此处附图中描述和示出的本发明实施例的组件可以以各种不同的配置来布置和设计。因此，以下对在附图中提供的本发明的实施例的详细描述并非旨在限制要求保护的本发明的范围，而是仅仅表示本发明的选定实施例。基于本发明中的实施例，本领域普通技术人员在没有作出创造性劳动前提下所获得的所有其他实施例，都属于本发明保护的范围。为了更好理解本文领域的相关术语，下面对本文使用的英文术语解释如下：BBU：基带处理单元；RRU/RU：远程拉远射频单元/射频单元；eCPRI：扩展的公共无线接入接口协议；O-RAN/O-RAN：Open RAN ，用于精确硬件时间戳记录；网卡驱动的发送完成回调里面把硬件的发送时间如t3封装在skb送给上层协议栈，硬件的发送时间可以通过DMA描述符状态获取减少抖动；在DMA接收完成状态的回调里面读取硬件的PHC时间来获取接收时间如t2；在RU的PS侧通过启动标准linux ptp4l服务来实现，ptp4l服务绑定上面网卡PHC clock来获取和设置精确的硬件时间。在本发明中，O-RAN时间节拍辅时序维护模块可采用下面的方式实现：RU侧维护四个模块PHY/MAC模块，报文分类模块，O-RAN模块，lowPhy模块；数据报文通过了PHY/MAC模块做一些CRC校验，MAC地址过滤校验，送到报文分类模块对以太类报文进行分类处理，如果是eCPRI报文，送给O-RAN模块；如果是其他管理面报文，或者1588报文，送给RU PS处理；针对eCRPI报文，进过O-RAN模块解析协议，提取出IQ数据送给lowPhy模块进行频域转时域处理；O-RAN模块里面引入一个子模块O-RAN时间节拍辅时序维护模块,O-RAN模块负责解析O-RAN协议，子模块O-RAN时间节拍辅时序维护模块通过O-RAN模块提供的API注册数据面回调函数，一旦有效的数据面通过了O-RAN模块解析，上面注册的数据面回调函数就会被调用来通过map数据结构来存到用户自定义的缓存，k就是一个symbol数据面达到时间，value就是四元组信息。在本发明中，时序切换控制模块中1588异常检测可采用下面的方式实现：检查RU侧ptp4l服务日志状态如时序收敛误差异常，1588协议里面t1、t2、t3、t4时间异常。时序收敛误差异常日志一个示例如图5所示，其中maser offset偏差为-1048574，属于异常情况。1588协议里面t1、t2、t3、t4时间异常一个示例中：t1,t2,t3,t4的信息中，t4 反而比t1小，这个是1588的时间戳异常。通过RU侧PS和PL总线接口如AXI-LITE读取以太网发送状态寄存器来确认发送失败情况。由于O-RU的时序同步都是以O-DU的下行方向为参考，因此下面以下行方向为例介绍本发明。在下行流程的最开始部分是通过1588协议实现O-DU和O-RU时序同步。因为1588是标准协议，里面关于同步报文，跟进报文，时序延迟请求报文，时序延迟响应报文这里就不详细介绍。1588核心思想就是通过携带在上面报文里面的时间戳计算两个节点的时间差后再进行同步。在整个5G系统，为了更好达到同步效果在微秒或者纳秒级别同步，同步报文发送时间t1、延迟请求接收时间t4是由O-DU的前传卡硬件控制，同步报文接收时间t2、延迟请求发送时间t3是由O-RU的硬件控制。根据1588协议，O-RU的1588主时序维护模块根据上面报文里面t1,t2,t3,t4计算出O-DU和O-RU的时序差，然后修正O-RU上的时序以同步到O-DU。请参照图2，在O-DU和O-RU的时序同步后，整个下行流程如下：S1、O-DU中的业务模块将业务数据发送到基带模块；S2、基带模块对业务数据进行处理，包括信道编码、调制等处理过程；S3、基带模块通过O-DU中的O-RAN模块，根据当前时序向O-RU中的O-RAN模块下发O-RAN控制面消息，在O-RAN控制面消息中带有当前基带时序信息，如本时序数据有几个symbol，占多少RB等；S4、O-DU中的O-RAN模块向O-RU中的O-RAN模块下发O-RAN数据面消息，O-RAN数据面消息的数目与一个时序中包含的symbol时序数目相同，如在5G NR sub6 TDD系统里面，如果子载波间隔是30khz，一个subframe有两个slot，每个slot 是0.5ms时隙长度，每个slot有14个symbol，基带会下发14个O-RAN数据面消息，每个O-RAN数据面消息中包括本symbol所在的slot时序，对应symbol的IQ频域数据等；S5、O-RU中的O-RAN模块对O-RAN控制面消息和O-RAN数据面消息进行处理，并将得到的IQ频域数据发送至O-RU中的射频模块处理后发射出去。在下行流程中，O-RAN控制面消息和O-RAN数据面消息都包括时序信息，如frameId,subframeId,slotId, symbolId等信息，O-RAN控制面消息是以每个slot间隔来发送，O-RAN数据面消息是按照每个symbol间隔发送。O-RU通过接收O-RAN数据面消息，可以获取以symbol为单位的时序节拍信息，如果以30khz子载波考虑，相当一个35us时钟滴答的到来。请参照图3，下面以一个O-RAN数据面消息为例：在图3中O-RAN数据面宏观结构，前面8个字节是eCPRI头部信息，后面就是业务信息，下面对一些重要信息介绍如下：ecpriMessage：指定是O-RAN控制面消息或者O-RAN数据面消息；ecpriPcid：数据流标识符信息，由基带处理单元标识符，小区标识符，载波标识符，天线标识符等聚合体现；dir：业务的上下行方向；filterindex：O-RU滤波频率索引的控制；frameId：5G系统帧号，取值范围0到255；subframeId：5G系统在一个系统帧里面的子帧号，取值范围0到9；slotId：5G系统子帧号里面时隙号，取值范围0到1；symbolId：5G系统时隙里面符号，取值范围0到13。详细业务数据面信息如图4所示。在所示的消息结构里面包括frameId,subframeId, slotId, starSymbolId等时序信息。此外，还有RB，IQ压缩信息，以及实际的IQ数据等。根据时序节拍信息，整个O-DU时序节拍可以达到symbol级别，如果在5G NR sub6 TDD的30khz子载波下，一个symbol间隔大约是35us，O-RU可以根据这个时序节拍信息建立时序，相当每过35us有一个时钟节拍滴答在O-RU上。以上所述仅为本发明的优选实施例而已，并不用于限制本发明，对于本领域的技术人员来说，本发明可以有各种更改和变化。凡在本发明的精神和原则之内，所作的任何修改、等同替换、改进等，均应包含在本发明的保护范围之内。
