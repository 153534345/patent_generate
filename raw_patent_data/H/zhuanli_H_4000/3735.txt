标题title
一种基于FPGA的网口状态扫描系统和方法
摘要abst
本发明涉及一种基于FPGA的网口状态扫描系统和方法，属于通信网络领域。本发明当Link状态有变化时，FPGA立即上报给CPU，CPU解析到是Link状态报文后，立即响应并把解析出的速率封装成和FPGA协商的报文格式通过网口下发给FPGA，FPGA解析到是更新Link状态报文立即更新Link状态，使FPGA能快速切换到新的速率模式。本发明是基于FPGA的网口状态扫描系统和方法，可以实时监测网口状态的变化，并及时上报给CPU，扫描也更精准，更灵敏。当两侧的网口速率不一致时，能够及时上报给CPU，避免了长时间两侧网口速率不一致，可以使两侧网口速率快速达到一致，快速恢复到稳定的状态，避免长时间处于异常情况。
权利要求书clms
1.一种基于FPGA的网口状态扫描系统，其特征在于，FPGA包括：计数器、监测Link状态模块、封装报文模块、FPGA 内部总线模块、网口、报文解析模块和更新Link状态模块；外部设备把Link状态传递到FPGA的监测Link状态模块，监测Link状态模块用于监测Link状态的变化，并将Link状态信息发送到封装报文模块；计数器连接监测Link状态模块，用于决定上送CPU的时间间隔；封装报文模块用于将Link状态信息封装成CPU可以解析的Link状态报文，发送到FPGA 内部总线模块；FPGA 内部总线模块用于汇聚FPGA内部的Link状态报文，发送到网口；网口用于将Link状态报文上送到CPU；CPU接收报文并解析到是更新Link状态的Link状态报文后，将Link状态封装成和FPGA协商的Link状态更新报文通过网口下发给FPGA，网口用于接收CPU发送的报文并发送给FPGA内部总线模块，FPGA内部总线模块用于将网口的报文分发到报文解析模块；报文解析模块用于解析接收的报文，并判断是标准网络报文或Link状态更新报文，如果是Link状态更新报文，将新的Link状态发送至更新Link状态模块；更新Link状态模块用于用新的Link状态替换掉原来的Link状态。2.如权利要求1所述的基于FPGA的网口状态扫描系统，其特征在于，外部设备为CPLD。3.如权利要求1或2所述的基于FPGA的网口状态扫描系统，其特征在于，外部设备监测Link状态，Link状态包括速率10M、速率100M、速率1000M和phy的连接状态。4.如权利要求2所述的基于FPGA的网口状态扫描系统，其特征在于，所述封装报文模块封装的Link状态报文包括标准网络二层头、Link状态标志和Link状态，Link状态为0代表无连接，1代表10M，2代表100M，3代表1000M。5.如权利要求1所述的基于FPGA的网口状态扫描系统，其特征在于，所述更新Link状态模块还复位FPGA内部逻辑，使逻辑进入到新的Link状态。6.如权利要求1所述的基于FPGA的网口状态扫描系统，其特征在于，FPGA的网口包括网口1和网口2，FPGA通过网口2与CPU连接，通过网口1与外部网络连接。7.如权利要求6所述的基于FPGA的网口状态扫描系统，其特征在于，外部设备监测的Link状态为网口1的Link状态或网口2的Link状态。8.如权利要求7所述的基于FPGA的网口状态扫描系统，其特征在于，FPGA 内部总线模块用于汇聚FPGA内部的Link状态报文，发送到网口2；网口2用于将Link状态报文上送到CPU；CPU接收报文并解析到是更新Link状态的Link状态报文后，将Link状态封装成和FPGA协商的Link状态更新报文通过网口2下发给FPGA，网口2用于接收CPU发送的报文并发送给FPGA内部总线模块，FPGA内部总线模块用于将网口2的报文分发到报文解析模块。9.一种基于权利要求1-8任一项所述的扫描系统的基于FPGA的网口状态扫描方法，其特征在于，该方法包括如下步骤：步骤一：FPGA监测外部设备输入的标志Link状态的信号，当没有变化跳转到步骤二；当有变化则跳转到步骤三；步骤二：由CPU决定FPGA是否将此时的状态上送到CPU，如果无需上送到CPU则跳转到步骤一；如果需要上送到CPU，则等待一个计数器时间后跳转到步骤七；步骤三：等待一个计数器的时间，跳转到步骤四；步骤四：再次判断Link状态是否有变化；如果没有变化则跳转到步骤五；如果有变化则跳转到步骤一；步骤五：等待一个计数器的时间，跳转到步骤六；步骤六：再次判断Link状态，如果有变化则跳转到步骤一；如果没有变化则跳转到步骤七；步骤七：FPGA将Link状态信息封装为Link状态报文通过网口上送给CPU；跳转到步骤八；步骤八：CPU接收到Link状态报文并解析后，如果是更新Link状态的Link状态报文，CPU立即响应，封装Link状态更新报文通过网口下发给FPGA；跳转到步骤九；步骤九：FPGA通过网口接收到报文，然后通过报文解析模块解析到是Link状态更新报文后，立即响应更新Link状态。10.如权利要求9所述的基于FPGA的网口状态扫描方法，其特征在于，所述步骤二中，CPU通过配置寄存器配置是否需要上送到CPU，如果CPU通过配置寄存器配置的是无需上送到CPU则跳转到步骤一；如果CPU通过配置寄存器配置的是上送到CPU，则等待一个计数器时间后跳转到步骤七。
说明书desc
技术领域本发明属于通信网络领域，具体涉及一种基于FPGA的网口状态扫描系统和方法。背景技术传统的网口状态扫描是CPU通过mdio接口轮询读取phy的连接状态和速率。传统的方法由于主要依赖上层CPU，由CPU发起动作，CPU操作有时延，达不到实时监测，准确度也不高。通过mdio的操作方式速率低。发明内容要解决的技术问题本发明要解决的技术问题是如何提供一种基于FPGA的网口状态扫描系统和方法，以解决传统的网口状态扫描达不到实时监测、准确度也不高、速率低等方面的问题。技术方案为了解决上述技术问题，本发明提出一种基于FPGA的网口状态扫描系统，FPGA包括：计数器、监测Link状态模块、封装报文模块、FPGA 内部总线模块、网口、报文解析模块和更新Link状态模块；外部设备把Link状态传递到FPGA的监测Link状态模块，监测Link状态模块用于监测Link状态的变化，并将Link状态信息发送到封装报文模块；计数器连接监测Link状态模块，用于决定上送CPU的时间间隔；封装报文模块用于将Link状态信息封装成CPU可以解析的Link状态报文，发送到FPGA 内部总线模块；FPGA 内部总线模块用于汇聚FPGA内部的Link状态报文，发送到网口；网口用于将Link状态报文上送到CPU；CPU接收报文并解析到是更新Link状态的Link状态报文后，将Link状态封装成和FPGA协商的Link状态更新报文通过网口下发给FPGA，网口用于接收CPU发送的报文并发送给FPGA内部总线模块，FPGA内部总线模块用于将网口的报文分发到报文解析模块；报文解析模块用于解析接收的报文，并判断是标准网络报文或Link状态更新报文，如果是Link状态更新报文，将新的Link状态发送至更新Link状态模块；更新Link状态模块用于用新的Link状态替换掉原来的Link状态。进一步地，外部设备为CPLD。进一步地，外部设备监测Link状态，Link状态包括速率10M、速率100M、速率1000M和phy的连接状态。进一步地，所述封装报文模块封装的Link状态报文包括标准网络二层头、Link状态标志和Link状态，Link状态为0代表无连接，1代表10M，2代表100M，3代表1000M。进一步地，所述更新Link状态模块还复位FPGA内部逻辑，使逻辑进入到新的Link状态。进一步地，FPGA的网口包括网口1和网口2，FPGA通过网口2与CPU连接，通过网口1与外部网络连接。进一步地，外部设备监测的Link状态为网口1的Link状态或网口2的Link状态。进一步地，FPGA 内部总线模块用于汇聚FPGA内部的Link状态报文，发送到网口2；网口2用于将Link状态报文上送到CPU；CPU接收报文并解析到是更新Link状态的Link状态报文后，将Link状态封装成和FPGA协商的Link状态更新报文通过网口2下发给FPGA，网口2用于接收CPU发送的报文并发送给FPGA内部总线模块，FPGA内部总线模块用于将网口2的报文分发到报文解析模块。本发明还提供一种基于FPGA的网口状态扫描方法，该方法包括如下步骤：步骤一：FPGA监测外部设备输入的标志Link状态的信号，当没有变化跳转到步骤二；当有变化则跳转到步骤三；步骤二：由CPU决定FPGA是否将此时的状态上送到CPU，如果无需上送到CPU则跳转到步骤一；如果需要上送到CPU，则等待一个计数器时间后跳转到步骤七；步骤三：等待一个计数器的时间，跳转到步骤四；步骤四：再次判断Link状态是否有变化；如果没有变化则跳转到步骤五；如果有变化则跳转到步骤一；步骤五：等待一个计数器的时间，跳转到步骤六；步骤六：再次判断Link状态，如果有变化则跳转到步骤一；如果没有变化则跳转到步骤七；步骤七：FPGA将Link状态信息封装为Link状态报文通过网口上送给CPU；跳转到步骤八；步骤八：CPU接收到Link状态报文并解析后，如果是更新Link状态的Link状态报文，CPU立即响应，封装Link状态更新报文通过网口下发给FPGA；跳转到步骤九；步骤九：FPGA通过网口接收到报文，然后通过报文解析模块解析到是Link状态更新报文后，立即响应更新Link状态。进一步地，所述步骤二中，CPU通过配置寄存器配置是否需要上送到CPU，如果CPU通过配置寄存器配置的是无需上送到CPU则跳转到步骤一；如果CPU通过配置寄存器配置的是上送到CPU，则等待一个计数器时间后跳转到步骤七。有益效果本发明提出一种基于FPGA的网口状态扫描系统和方法，本发明是基于FPGA的网口状态扫描系统和方法，能够实时监测，扫描更精准。本发明通过网口上报网口的状态变化提高了网口扫描状态的速度。本发明可快速使FPGA切换速率模式，使CPU侧和FPGA侧网口能更快地处于稳定工作状态。本发明是基于FPGA的网口状态扫描系统和方法，可以实时监测网口状态的变化，并及时上报给CPU，扫描也更精准，更灵敏。当CPU侧和FPGA侧网口速率不一致时，能够及时上报给CPU，避免了长时间两侧网口速率不一致，可以使两侧网口速率快速达到一致，快速恢复到稳定的状态，避免长时间处于异常情况。附图说明图1为本发明基于FPGA的网口状态扫描系统示意图；图2为本发明基于FPGA的网口状态扫描方法流程图；图3为封装报文模块封装的带有Link状态报文格式；图4为本发明监测Link状态实现流程图。具体实施方式为使本发明的目的、内容和优点更加清楚，下面结合附图和实施例，对本发明的具体实施方式作进一步详细描述。基于FPGA的网口状态扫描系统和方法可以提高扫描的准确度，并可以实时监测网口的状态，提高网口状态扫描的速度，可以快速切换FPGA的工作模式。本发明基于FPGA的网口状态扫描系统的整体结构框图见图1。FPGA包括：计数器、监测Link状态模块、封装报文模块、FPGA 内部总线模块、网口、报文解析模块和更新Link状态模块，网口包括网口1和网口2，FPGA通过网口2与CPU连接，通过网口1与外部网络连接，CPLD监测FPGA侧的网口对应的phy层Link状态，可以监测网口1的Link状态，也可以监测网口2的Link状态。虚线方向是FPGA将Link状态上送给CPU的过程。首先外部设备如CPLD把Link状态传递到FPGA的监测Link状态模块，监测Link状态模块用于监测Link状态的变化，并将Link状态信息发送到封装报文模块，速率具体变成为多少兆；计数器连接监测Link状态模块，用于决定上送CPU的时间间隔；封装报文模块用于将Link状态信息封装成CPU可以解析的Link状态报文，发送到FPGA 内部总线模块；FPGA 内部总线模块用于汇聚FPGA内部的Link状态报文，发送到网口；网口用于将Link状态报文上送到CPU。实线方向是CPU将Link状态更新给FPGA的过程。CPU接收报文并解析到是更新Link状态的Link状态报文后，将Link状态封装成和FPGA协商的Link状态更新报文通过网口下发给FPGA，网口用于接收CPU发送的报文并发送给FPGA内部总线模块，FPGA内部总线模块用于将网口的报文分发到报文解析模块；报文解析模块用于解析接收的报文，并判断是标准网络报文或Link状态更新报文，如果是Link状态更新报文，将新的Link状态发送至更新Link状态模块；更新Link状态模块用于用新的Link状态替换掉原来的Link状态，此外，更新Link状态模块还复位FPGA内部逻辑，使逻辑进入到新的Link状态。进一步地，FPGA的网口包括网口1和网口2，FPGA通过网口2与CPU连接，通过网口1与外部网络连接。进一步地，外部设备如CPLD监测的Link状态为网口1的Link状态或网口2的Link状态。进一步地，FPGA 内部总线模块用于汇聚FPGA内部的Link状态报文，发送到网口2；网口2用于将Link状态报文上送到CPU；CPU接收报文并解析到是更新Link状态的Link状态报文后，将Link状态封装成和FPGA协商的Link状态更新报文通过网口2下发给FPGA，网口2用于接收CPU发送的报文并发送给FPGA内部总线模块，FPGA内部总线模块用于将网口2的报文分发到报文解析模块。本发明当通过CPLD监测到FPGA侧的网口的phy层的状态发生变化时，通过本发明的方法可以使FPGA内部的逻辑使用新的时钟，切换到新的速率模式，避免了长时间网口速率和FPG内部处理速率不一致。本发明的流程包括FPGA将Link状态上送给CPU的过程和CPU将Link状态更新给FPGA的过程，具体本发明的流程见图2。首先CPLD监测Link状态；Link状态主要包括速率10M、速率100M、速率1000M和phy的连接状态，该Link状态为FPGA侧的网口对应的phy层Link状态。如图3所示为本发明的带有Link状态报文格式，包括标准网络二层头、Link状态标志和Link状态，图3报文格式中的Link状态为0代表无连接，1代表10M，2代表100M,3代表1000M。具体的监测Link状态过程如图4所示。当Link状态有变化时，FPGA立即上报给CPU，CPU解析到是Link状态报文后，立即响应并把解析出的速率封装成和FPGA协商的Link状态更新报文通过网口下发给FPGA，FPGA解析到是Link状态更新报文立即更新Link状态，使FPGA能快速切换到新的速率模式。如图4所示，本发明基于FPGA的网口状态扫描方法包括如下步骤：步骤一：FPGA监测外部设备输入的标志Link状态的信号，当没有变化跳转到步骤二。当有变化则跳转到步骤三。步骤二：由CPU通过配置寄存器决定FPGA是否将此时的状态上送到CPU，如果CPU通过配置寄存器配置的是无需上送到CPU则跳转到步骤一；如果CPU通过配置寄存器配置的是上送到CPU，则等待一个计数器时间后跳转到步骤七。步骤三：等待一个计数器的时间，跳转到步骤四。步骤四：再次判断Link状态是否有变化。如果没有变化则跳转到步骤五。如果有变化则跳转到步骤一。步骤五：等待一个计数器的时间，跳转到步骤六。。步骤六：再次判断Link状态，如果有变化则跳转到步骤一。如果没有变化则跳转到步骤七。步骤七：FPGA按照图3的封装格式将Link状态信息封装为Link状态报文通过网口上送给CPU。跳转到步骤八。步骤八：CPU接收到Link状态报文并解析后，如果是更新Link状态的Link状态报文，CPU立即响应，封装Link状态更新报文通过网口下发给FPGA。跳转到步骤九。步骤九：FPGA通过网口接收到报文，然后通过报文解析模块解析到是Link状态更新报文后，立即响应更新Link状态，并复位FPGA内部逻辑，使逻辑进入到新的Link状态。本发明是基于FPGA的网口状态扫描系统和方法，能够实时监测，扫描更精准。本发明通过网口上报网口的状态变化提高了网口扫描状态的速度。本发明可快速使FPGA切换速率模式，使PGA侧网口能更快地处于稳定工作状态。本发明是基于FPGA的网口状态扫描系统和方法，可以实时监测网口状态的变化，并及时上报给CPU，扫描也更精准，更灵敏。当CPU侧和FPGA侧网口速率不一致或者外部网络与FPGA侧网口速率不一致时，能够及时上报给CPU，由CPU下达指令切换内部逻辑，避免了长时间两侧网口速率不一致，可以使两侧网口速率快速达到一致，快速恢复到稳定的状态，避免长时间处于异常情况。以上所述仅是本发明的优选实施方式，应当指出，对于本技术领域的普通技术人员来说，在不脱离本发明技术原理的前提下，还可以做出若干改进和变形，这些改进和变形也应视为本发明的保护范围。
