标题title
基于车载以太网传输音视频同步传输方法
摘要abst
本发明提供一种基于车载以太网传输音视频同步传输方法，至少包括：对车载网络节点的时间进行同步校正；分别采集视频数据和对应的音频数据；计算音频帧，根据帧率与本帧的时间戳计算出下一帧之间的音频时间戳，根据音频时间戳，获取对应的多帧音频数据和视频数据进行合成，形成音视频同步数据包；将音视频同步数据包经过IEEE1722AVTP协议进行封装后，经过车载以太网PHY发送接口发送至目标网络。本发明将将音视频同步这一复杂的过程在发送端实现，接收端只需从音视频同步数据中分理处音频数据和对应的视频数据后直接播放，降低接收端的音视频播放一致性的开发难度。
权利要求书clms
1.一种基于车载以太网传输音视频同步传输方法，其特征在于，至少包括：对车载网络节点的时间进行同步校正；分别采集视频数据和对应的音频数据；计算音频帧，根据帧率与本帧的时间戳计算出下一帧之间的音频时间戳，根据音频时间戳，获取对应的多帧音频数据和视频数据进行合成，形成音视频同步数据包；将音视频同步数据包经过IEEE1722 AVTP协议进行封装后，经过车载以太网PHY发送接口发送至目标网络。2.如权利要求1所述一种基于车载以太网传输音视频同步传输方法，其特征在于，音频数据和视频数据进行合成时，按音频播放基准进行组包，音视频同步数据包对应N分之一的音频PCM数据和K分之一的图像RGB数据。3.如权利要求1所述一种基于车载以太网传输音视频同步传输方法，其特征在于，获取音频帧和视频帧，比较当前的音频帧时间戳和视频帧时间戳之间的差值判断是否切换下一帧视频，以实现音频帧与视频帧同步。4.如权利要求1所述一种基于车载以太网传输音视频同步传输方法，其特征在于，若音频帧时间戳差值小于预先设定的固定差值且视频帧时间戳小于音频帧时间戳，则获取下一帧视频，采用下一帧视频与当前音频帧进行音视频同步；若视频帧时间戳大于音频帧时间戳，则表明视频帧已超前，获取上一帧视频，将上一帧视频与当前帧进行音视频同步。5.如权利要求1所述一种基于车载以太网传输音视频同步传输方法，其特征在于，音视频同步数据包至少包括：数据包的报头信息、音频数据、视频数据、同步时间戳信息中的一种或多种。6.如权利要求1所述一种基于车载以太网传输音视频同步传输方法，其特征在于，对采集的音频数据进行标定，形成标定后的基准音频信息，标定后的基准音频信息至少包括：本地采集数据的自然时间、时间基、音频采样率、位深、通道数和音频数据序列号中的一种或多种；对标定后的基准音频数据进行组装处理，形成用于传输的音频数据，至少包括：类型、采样率、位深、通道数、同步时间戳、序列号中的一种或多种。7.如权利要求1所述一种基于车载以太网传输音视频同步传输方法，其特征在于，对采集的视频数据进行处理，获取图像属性信息，图像属性信息至少包括：图像类型、分辨率、时间戳、系列号、数据长度中的一种或多种。8.如权利要求1所述一种基于车载以太网传输音视频同步传输方法，其特征在于，对音视频同步数据包进行加密后，将音视频同步数据包放入循环缓冲队列；根据IEEE1722 AVTP协议的传输要求，将放入缓冲队列的数据包拆分成固定大小的数据包再进行封装。9.如权利要求1所述一种基于车载以太网传输音视频同步传输方法，其特征在于，目标网络获取到音视频同步数据包后对音视频同步数据包进行分离，获取音频数据和对应的视频数据；判断音频数据是否需要重采样，如果需要重采样，则对声音数据进行冲采样；对音频数据进行处理形成PCM数据传输至音频播放回调接口；将视频数据进行处理获取RGB数据传输至视频播放回调接口。10.如权利要求9所述一种基于车载以太网传输音视频同步传输方法，其特征在于，目标网络将接收到的数据包放入循环队列缓冲区，对循环缓冲区的数据包进行解析合并处理后获得完整的数据包，对数据包进行解密和数据校验，获得音视频同步数据包。11.如权利要求9所述一种基于车载以太网传输音视频同步传输方法，其特征在于，音频播放线程与视频播放线程相互独立，音频播放线程用于处理音频数据，视频播放线程用于处理视频数据，通过音频播放线程和视频播放线程实现声音与视频的同步播放；存取共享音频时需要采用互斥量对共享缓冲区的音频数据进行保护。12.如权利要求9所述一种基于车载以太网传输音视频同步传输方法，其特征在于，音频播放线程直接从音频帧缓冲区中读取音频帧进行播放并且利用音频时间戳查找对应的视频时间戳并进行播放；音频帧和视频帧数据采用分段缓冲式的音频数据，待分段播放完成后再进行释放。
说明书desc
技术领域本发明涉及车载以太网音视频同步领域，特别是涉及车载以太网传输音视频同步传输方法。背景技术随着智能网联汽车不断向前发展，人们对汽车内部座舱提出的更高的要求，在座舱内部，同时常用车身控制、影音播放外，有些用户需要车内进行在线会议和进行直播，而车内直播或在线会议，与传统的PC通信方式并不相同，传统PC直播或手机直播，由于都是单一通信，在直播时对视频和音频的采集的同步性要求并不高，但是在车载网络中，由于涉及到多种不同的总线，如车载以太网总线、CAN总线、LIN总线以及多种域控制下对应的较多ECU的传输，如何兼顾音频和视频采集的信号同步，降低卡顿和延迟，提升车内直播的用户体验。另外，一方面现有的视频播放都是客户端接收到音视频流需要按照各自的时间基进行转换然后再同步到统一的时间下进行播放，播放过程中的音视频的同步是目前存在的较大问题，特别是在直播的时候，由于画面和音频是实时传输，当出现不一致时，会导致严重的抖动发生，造成声音与画面的不匹配。发明内容基于现有技术中存在的缺陷，一种基于车载以太网传输音视频同步传输方法，至少包括：对车载网络节点的时间进行同步校正；分别采集视频数据和对应的音频数据；计算音频帧，根据帧率与本帧的时间戳计算出下一帧之间的音频时间戳，根据音频时间戳，获取对应的多帧音频数据和视频数据进行合成，形成音视频同步数据包；将音视频同步数据包经过IEEE1722 AVTP协议进行封装后，经过车载以太网PHY发送接口发送至目标网络。一种基于车载以太网传输音视频同步传输方法，进一步可选地，音频数据和视频数据进行合成时，按音频播放基准进行组包，音视频同步数据包对应N分之一的音频PCM数据和K分之一的图像RGB数据。一种基于车载以太网传输音视频同步传输方法，进一步可选地，获取音频帧和视频帧，比较当前的音频帧时间戳和视频帧时间戳之间的差值判断是否切换下一帧视频，以实现音频帧与视频帧同步。一种基于车载以太网传输音视频同步传输方法，进一步可选地，若音频帧时间戳差值小于预先设定的固定差值且视频帧时间戳小于音频帧时间戳，则获取下一帧视频，采用下一帧视频与当前音频帧进行音视频同步；若视频帧时间戳大于音频帧时间戳，则表明视频帧已超前，获取上一帧视频，将上一帧视频与当前帧进行音视频同步。一种基于车载以太网传输音视频同步传输方法，进一步可选地，音视频同步数据包至少包括：数据包的报头信息、音频数据、视频数据、同步时间戳信息中的一种或多种。一种基于车载以太网传输音视频同步传输方法，进一步可选地，对采集的音频数据进行标定，形成标定后的基准音频信息，标定后的基准音频信息至少包括：本地采集数据的自然时间，时间基、音频采样率、位深、通道数和音频数据序列号中的一种或多种；对标定后的基准音频数据进行组装处理，形成用于传输的音频数据，至少包括：类型、采样率、位深、通道数、同步时间戳、序列号中的一种或多种。一种基于车载以太网传输音视频同步传输方法，进一步可选地，对采集的视频数据进行处理，获取图像属性信息，图像属性信息至少包括：图像类型、分辨率、时间戳、系列号、数据长度中的一种或多种。一种基于车载以太网传输音视频同步传输方法，进一步可选地，对音视频同步数据包进行加密后，将音视频同步数据包放入循环缓冲队列；根据IEEE1722 AVTP协议的传输要求，将放入缓冲队列的数据包进行拆分成固定大小的数据包在进行封装。一种基于车载以太网传输音视频同步传输方法，进一步可选地，目标网络获取到音视频同步数据包后对音视频同步数据包进行分离，获取音频数据和对应的视频数据；判断音频数据是否需要重采样，如果需要重采样，则对声音数据进行冲采样；对音频数据进行处理形成PCM数据传输至音频播放回调接口；将视频数据进行处理获取RGB数据传输至视频播放回调接口；一种基于车载以太网传输音视频同步传输方法，进一步可选地，目标网络将接收到的数据包放入循环队列缓冲区，对循环缓冲区的数据包进行解析合并处理后获得完整的数据包，对数据包进行解密和数据校验，获得音视频同步数据包。一种基于车载以太网传输音视频同步传输方法，进一步可选地，音频播放线程与视频播放线程相互独立，音频播放线程用于处理音频数据，视频播放线程用于处理视频数据，通过音频播放线程和视频播放线程实现声音与视频的同步播放；存取共享音频时需要采用互斥量对共享缓冲区的音频数据进行保护。一种基于车载以太网传输音视频同步传输方法，进一步可选地，音频播放线程直接从音频帧缓冲区中读取音频帧进行播放并且利用音频时间戳查找对应的视频时间戳并进行播放；音频帧和视频帧数据采用分段缓冲式的音频数据，待分段播放完成后在进行释放。有益效果：本发明的技术方案中，通过在服务端采集音频数据和视频数据，在服务端对音频数据和视频数据进行处理后，设计存储缓冲区，按音频播放基准进行获取对应的视频帧，然后将音频帧和同步的视频帧进行同步合成封装成音视频同步数据包后发送至目标网络，目标网络接收到音视频同步数据包，分离出音频和视频直接播放。将音视频同步这一复杂的过程在发端实现，减少收端开发工作量降低了开发难度和需要的知识储备。全系统实现了发端收端以及对应的网络传输控制技术，开发使用者只需要简单注册几个回调事件函数即可完成；附图说明以下附图仅对本发明做示意性说明和解释，并不限定本发明的范围。图1为本发明一实施例车载以太网传输音视频同步传输示意图。图2为本发明一实施例音频信号采集处理方法示意图。图3为本发明一实施例视频信号采集处理方法示意图。图4为本发明一实施例音频信号和视频信号同步合成音视频数据包的方法示意图。图5为本发明一实施例音视频数据包的解析方法示意图。图6为本发明一实施例音视频数据包的分离方法示意图。图7为本发明一实施例音频数据与视频数据播放过程示意图。具体实施方式为了对本文的技术特征、目的和效果有更加清楚的理解，现对照附图说明本发明的具体实施方式，在各图中相同的标号表示相同的部分。为使图面简洁，各图中的示意性地表示出了与本发明相关部分，而并不代表其作为产品的实际结构。另外，为使图面简洁便于理解，在有些图中具有相同结构或功能的部件，仅示意性地绘示了其中的一个，或仅标出了其中的一个。关于控制系统，功能模块、应用程序本领域技术人员熟知的是，其可以采用任何适当的形式，既可以是硬件也可以是软件，既可以是离散设置的多个功能模块，也可以是集成到一个硬件上的多个功能单元。作为最简单的形式，所述控制系统可以是控制器，例如组合逻辑控制器、微程序控制器等，只要能够实现本申请描述的操作即可。当然，控制系统也可以作为不同的模块集成到一个物理设备上，这些都不偏离本发明的基本原理和保护范围。本发明中“连接”，即可包括直接连接、也可以包括间接连接、通信连接、电连接，特别说明除外。本文中所使用的术语仅为了描述特定实施方案的目的并且不旨在限制本公开。如本文中所使用地，单数形式“一个”、“一种”、以及“该”旨在也包括复数形式，除非上下文明确地另作规定。还将理解的是，当在说明书中使用时，术语“包括”和/或“包含”是指存在有所陈述的特征、数值、步骤、操作、元件和/或组分，但是并不排除存在有或额外增加一个或多个其它的特征、数值、步骤、操作、元件、组分和/或其组成的群组。作为在本文中所使用的，术语“和/或”包括列举的相关项的一个或多个的任何和全部的组合应当理解，此处所使用的术语“车辆”或“车辆的”或其它类似术语一般包括机动车辆，例如包括运动型多用途车辆、公共汽车、卡车、各种商用车辆的乘用汽车，包括各种舟艇、船舶的船只，航空器等等，并且包括混合动力车辆、电动车辆、可插式混合动力电动车辆、氢动力车辆以及其它替代性燃料车辆。正如此处所提到的，混合动力车辆是具有两种或更多动力源的车辆，例如汽油动力和电力动力两者的车辆。此外，本公开的控制器可被具体化为计算机可读介质上的非瞬态计算机可读介质，该计算机可读介质包含由处理器、控制器或类似物执行的可执行程序指令。计算机可读介质的示例包括，但不限于，ROM、RAM、光盘-ROM、磁带、软盘、闪存驱动器、智能卡和光学数据存储设备。计算机可读记录介质也可分布在通过网络耦合的计算机系统中，使得计算机可读介质例如通过远程信息处理服务器或控制器区域网络以分布式方式存储和执行。本发明提供一种基于车载以太网传输音视频同步传输方法，具体参见图1至图7，至少包括：对车载网络节点的时间进行同步校正；分别采集视频数据和对应的音频数据；计算音频帧，根据帧率与本帧的时间戳计算出下一帧之间的音频时间戳，根据音频时间戳，获取对应的多帧音频数据和视频数据进行合成，形成音视频同步数据包；将音视频同步数据包经过IEEE1722 AVTP协议进行封装后，经过车载以太网PHY发送接口发送至目标网络。具体地，本实施例中，通过在服务端将视频和音频的数据进行同步后合成相应的音视频同步数据包，在客户端，通过直接将音视频同步数据包进行进行并分离，然后以音频数据为基准，根据同步的时间戳查找对应的视频帧进行播放。如图1所示，在视频直播时，通过底层接口分别采集音频信号和视频信号，然后在音视频同步器进行处理，将音视频进行同步后在传输至客户端进行解析播放。具体地，音视频数据同步的采集方式之一可以为：音频数据和视频数据进行合成时，按音频播放基准进行组包，音视频同步数据包对应N分之一的音频PCM数据和K分之一的图像RGB数据。具体地，由于音频数据和视频数据在采集是分离的，音频数据采用声卡采集，而视频数据采用摄像头进行采集，当用户在进行直播时，对系统时间进行同步后，开始采集用户的视频和音频，并且每帧视频和音频数据都配置对应的时间戳，根据格式或编码的不同，存在一帧音频数据对应多帧视频数据，即在同步时，将一帧音频数据与多帧视频数据进行音视频同步，视频帧之间可以用时间戳与序列号进行标识。参见图2，显示了音频信号的采集处理方法。对采集的音频数据进行标定，形成标定后的基准音频信息，标定后的基准音频信息至少包括：本地采集数据的自然时间，时间基、音频采样率、位深、通道数和音频数据序列号中的一种或多种；对标定后的基准音频数据进行组装处理，形成用于传输的音频数据，至少包括：类型、采样率、位深、通道数、同步时间戳、序列号中的一种或多种。参见图3，显示了视频信号的采集处理方法。对采集的视频数据进行处理，获取图像属性信息，图像属性信息至少包括：图像类型、分辨率、时间戳、系列号、数据长度中的一种或多种。参见图4，具体地，获取音频帧和视频帧，比较当前的音频帧时间戳和视频帧时间戳之间的差值判断是否切换下一帧视频，以实现音频帧与视频帧同步。若音频帧时间戳差值小于预先设定的固定差值且视频帧时间戳小于音频帧时间戳，则获取下一帧视频，采用下一帧视频与当前音频帧进行音视频同步；若视频帧时间戳大于音频帧时间戳，则表明视频帧已超前，获取上一帧视频，将上一帧视频与当前帧进行音视频同步。由于在同步过程中，可能存在音频和视频同步出现差异较大情况，为了在视频缓冲队列和音频缓冲队列中，采用分段缓存和分段释放对音频数据和视频数据进行管理；在预设的分段长度，以音频帧为基准，待音频帧数据查找对应的视频帧进行同步后在进行释放。具体地，音视频同步数据包至少包括：数据包的报头信息、音频数据、视频数据、同步时间戳信息中的一种或多种。具体地，在车内直播进行视频直播获得数据在基于车载以太网传输至TSN网关，TSN网关对数据进行转化，如果需要传输给远程的用户观看，通过TSN网关传输至T-box，经过T-box通过无线通信的方式传输至云服务器；或者传输至车载网络的另一车载以太网显示屏中进行播放，如乘客坐在后排时，在副驾上进行直播的用户，需要同步直播内容之以供后排乘客观看。在车内网络，具体地，当音视频数据进行同步后，获取同步的音视频同步数据，由于数据视频数据过大，需要对音视频同步数据进行压缩处理；为了防止数据传输过程中被窃取，在进行压缩后进行加密；加密完成后，将音视频同步数据包放入循环缓冲队列；根据IEEE1722 AVTP协议的传输要求，将放入缓冲队列的数据包进行拆分成固定大小的数据包在进行封装。具体地，上述在本地的服务端完成后音视频数据的同步，当音视频数据同步后，需要传输至远程进行播放。参见图6，具体地，目标网络获取到音视频同步数据包后对音视频同步数据包进行分离，获取音频数据和对应的视频数据；判断音频数据是否需要重采样，如果需要重采样，则对声音数据进行冲采样；对音频数据进行处理形成PCM数据传输至音频播放回调接口；将视频数据进行处理获取RGB数据传输至视频播放回调接口；目标网络将接收到的数据包放入循环队列缓冲区，对循环缓冲区的数据包进行解析合并处理后获得完整的数据包，对数据包进行解压、解密和数据校验，获得音视频同步数据包，如图5所示。音频播放线程与视频播放线程相互独立，音频播放线程用于处理音频数据，视频播放线程用于处理视频数据，通过音频播放线程和视频播放线程实现声音与视频的同步播放，参见图7。存取共享音频时需要采用互斥量对共享缓冲区的音频数据进行保护。音频播放线程直接从音频帧缓冲区中读取音频帧进行播放并且利用音频时间戳查找对应的视频时间戳并进行播放；音频帧和视频帧数据采用分段缓冲式的音频数据，待分段播放完成后在进行释放。由于人的感官受声音影响反应比较快，所以播放时以声音为基准，播放完对应的声音后发送信号触发下一视频显示。上所述的仅是本发明的优选实施方式，本发明不限于以上实施例。本领域的技术人员可以清楚，该实施例中的形式不局限于此，同时可调整方式也不局限于此。可以理解，本领域技术人员在不脱离本发明的基本构思的前提下直接导出或联想到的其他改进和变化，均应认为包含在本发明的保护范围之内。
