标题title
VF配置方法及装置
摘要abst
本发明提供一种VF配置方法及装置，涉及网络虚拟化技术领域，所述方法包括：对一个虚拟端口配置N个VF，并将所述N个VF同时挂载到虚拟机；所述N个VF的MAC地址和VLAN均相同，所述N为大于1的正整数。本发明通过对一个虚拟端口配置多个VF，提高了SR‑IOV的L2冗余，解决虚拟机单点故障，提高虚拟机的可靠性，多个VF的MAC地址和VLAN均相同，无需开启安全信任开关，提高了安全性。
权利要求书clms
1.一种VF配置方法，其特征在于，包括：对一个虚拟端口配置N个VF，并将所述N个VF同时挂载到虚拟机；所述N个VF的MAC地址和VLAN均相同，所述N为大于1的正整数。2.根据权利要求1所述的VF配置方法，其特征在于，所述对一个虚拟端口配置N个VF之前，还包括：设置VF白名单；利用所述VF白名单对VF进行筛选，获取VF池。3.根据权利要求2所述的VF配置方法，其特征在于，所述获取VF池之后，还包括：确定每一个VF池中VF处于空闲态的数量；若每一个VF池中VF处于空闲态的数量均大于等于M个，则从每一个VF池中选择M个处于空闲态的VF；所述M个为预设请求的VF个数。4.根据权利要求3所述的VF配置方法，其特征在于，所述从每一个VF池中选择M个处于空闲态的VF之后，还包括：将选择的N个VF对应的PCI地址以列表类型的方式更新到所述虚拟端口的信息中；所述N个VF为从所有VF池中选取出的处于空闲态的VF。5.根据权利要求1所述的VF配置方法，其特征在于，对一个虚拟端口配置N个VF之后，还包括：检测VF是否变化；对变化的VF进行配置调整，并更新所述虚拟端口的状态。6.根据权利要求1所述的VF配置方法，其特征在于，所述N个VF的MAC地址和VLAN均采用所述虚拟端口的MAC地址和VLAN。7.一种VF配置装置，其特征在于，包括：配置模块，用于对一个虚拟端口配置N个VF，并将所述N个VF同时挂载到虚拟机；所述N个VF的MAC地址和VLAN均相同，所述N为大于1的正整数。8.一种电子设备，包括存储器、处理器及存储在所述存储器上并可在所述处理器上运行的计算机程序，其特征在于，所述处理器执行所述计算机程序时实现如权利要求1至6中的任一项所述VF配置方法。9.一种非暂态计算机可读存储介质，其上存储有计算机程序，其特征在于，所述计算机程序被处理器执行时实现如权利要求1至6中的任一项所述VF配置方法。10.一种计算机程序产品，包括计算机程序，其特征在于，所述计算机程序被处理器执行时实现如权利要求1至6中的任一项所述VF配置方法。
说明书desc
技术领域本发明涉及网络虚拟化技术领域，尤其涉及一种VF配置方法及装置。背景技术在网络功能虚拟化领域，许多场景需要单根I/O虚拟化的L2冗余。目前的nova和neutron L2绑定的解决方案通常是通过配置多个neutron端口并分配不同的虚拟功能在不同的物理网卡来实现。虚拟机挂载的VF之间的物理地址和虚拟局域网不相同，在进行聚合时必须关闭安全检测，带来了安全性问题。发明内容针对现有技术中存在的问题，本发明提供一种VF配置方法及装置。本发明提供一种VF配置方法，包括：对一个虚拟端口配置N个VF，并将所述N个VF同时挂载到虚拟机；所述N个VF的MAC地址和VLAN均相同，所述N为大于1的正整数。可选地，所述对一个虚拟端口配置N个VF之前，还包括：设置VF白名单；利用所述VF白名单对VF进行筛选，获取VF池。可选地，所述获取VF池之后，还包括：确定每一个VF池中VF处于空闲态的数量；若每一个VF池中VF处于空闲态的数量均大于等于M个，则从每一个VF池中选择M个处于空闲态的VF；所述M个为预设请求的VF个数。可选地，所述从每一个VF池中选择M个处于空闲态的VF之后，还包括：将选择的N个VF对应的PCI地址以列表类型的方式更新到所述虚拟端口的信息中；所述N个VF为从所有VF池中选取出的处于空闲态的VF。可选地，对一个虚拟端口配置N个VF之后，还包括：检测VF是否变化；对变化的VF进行配置调整，并更新所述虚拟端口的状态。可选地，所述N个VF的MAC地址和VLAN均采用所述虚拟端口的MAC地址和VLAN。本发明还提供一种VF配置装置，包括：配置模块，用于对一个虚拟端口配置N个VF，并将所述N个VF同时挂载到虚拟机；所述N个VF的MAC地址和VLAN均相同，所述N为大于1的正整数。本发明还提供一种电子设备，包括存储器、处理器及存储在存储器上并可在处理器上运行的计算机程序，所述处理器执行所述程序时实现如上述中的任一项所述VF配置方法。本发明还提供一种非暂态计算机可读存储介质，其上存储有计算机程序，该计算机程序被处理器执行时实现如上述中的任一项所述VF配置方法。本发明还提供一种计算机程序产品，包括计算机程序，所述计算机程序被处理器执行时实现如上述中的任一项所述VF配置方法。本发明提供的VF配置方法及装置，通过对一个虚拟端口配置多个VF，提高了SR-IOV的L2冗余，解决虚拟机单点故障，提高虚拟机的可靠性，多个VF的MAC地址和VLAN均相同，无需开启安全信任开关，提高了安全性。附图说明为了更清楚地说明本发明或现有技术中的技术方案，下面将对实施例或现有技术描述中所需要使用的附图作以简单地介绍，显而易见地，下面描述中的附图是本发明的一些实施例，对于本领域普通技术人员来讲，在不付出创造性劳动的前提下，还可以根据这些附图获得其他的附图。图1是本发明提供的VF配置方法的流程示意图之一；图2是本发明提供的VF配置方法的原理示意图；图3是本发明提供的VF配置方法的流程示意图之二；图4是本发明提供的VF配置装置的结构示意图；图5是本发明提供的电子设备的结构示意图。具体实施方式为使本发明的目的、技术方案和优点更加清楚，下面将结合本发明中的附图，对本发明中的技术方案进行清楚、完整地描述，显然，所描述的实施例是本发明一部分实施例，而不是全部的实施例。基于本发明中的实施例，本领域普通技术人员在没有付出创造性劳动前提下所获得的所有其他实施例，都属于本发明保护的范围。图1是本发明提供的VF配置方法的流程示意图之一，如图1所示，本发明提供一种VF配置方法，该方法包括：步骤101，对一个虚拟端口配置N个VF，并将所述N个VF同时挂载到虚拟机；所述N个VF的MAC地址和VLAN均相同，所述N为大于1的正整数。具体地，一个虚拟端口可以灵活挂载多个VF到虚拟机，一个虚拟端口对应多个VF，提高VF冗余，当其中一个VF存在故障时，可以利用其他的VF进行替代，提高虚拟机的可靠性，还可以兼容现有技术中一个虚拟端口对应一个VF的方案。多个VF之间的MAC地址和VLAN均相同，这样可以避免在进行聚合时需要关闭安全检测的问题，提高安全性。例如，有2个VF，VF1的MAC地址和VF2的MAC地址相同，VF1的VLAN和VF2的VLAN相同。图2是本发明提供的VF配置方法的原理示意图，如图2所示，Host bond中有网络接口控制器1和NIC2，开启链路聚合控制协议LACP，NIC1通过VF1连接到NIC3上，NIC2通过VF2连接到NIC4上。在虚拟机内部，Guest bond将一个逻辑neutron端口的NIC3和NIC4聚合，关闭LACP，从而实现一个虚拟端口挂载两个VF。本发明实施例提供的VF配置方法，通过对一个虚拟端口配置多个VF，提高了SR-IOV的L2冗余，解决虚拟机单点故障，提高虚拟机的可靠性，多个VF的MAC地址和VLAN均相同，无需开启安全信任开关，提高了安全性。可选地，所述N个VF的MAC地址和VLAN均采用所述虚拟端口的MAC地址和VLAN。具体地，多个VF的MAC地址和VLAN均采用挂载的虚拟端口的MAC地址和VLAN。例如，VF1和VF2均挂载到虚拟端口1，VF1的MAC地址和VF2的MAC地址均为虚拟端口1的MAC地址，VF1的VLAN和VF2的VLAN均为虚拟端口1的VLAN。本发明实施例提供的VF配置方法，通过将多个VF的MAC地址和VLAN均采用挂载的虚拟端口的MAC地址和VLAN，进一步有利于提高安全性。可选地，所述对一个虚拟端口配置N个VF之前，还包括：设置VF白名单；利用所述VF白名单对VF进行筛选，获取VF池。具体地，图3是本发明提供的VF配置方法的流程示意图之二，如图3所示，Nova配置VF白名单，VF白名单包括两个配置信息，已开启SR-IOV的网卡设备名称列表，需要绑定的网卡设备名称列表。一个网卡设备名称对应一个VF池，一个VF池包含一个或多个VF。用户通过Neutron创建一个direct类型的port，利用创建的direct类型port创建虚拟机，此虚拟机的状态处于building状态。Nova中应用程序编程接口接收请求，生成VF请求信息以及请求的VF个数信息。VF请求信息同时也包括网络信息和最大传输单元信息等。请求的VF个数信息是可以设置的，在未进行设置即默认情况下，请求的VF个数信息为1。Nova scheduler对计算节点进行筛选，筛选出开启SR-IOV的计算节点，即创建SR-IOV虚拟机的所在节点。Nova compute根据VF白名单筛选出的一个或多个VF池。具体过程是：根据已开启SR-IOV的网卡设备名称列表和需要绑定的网卡设备名称列表，获取两个列表中交集的网卡设备名称，交集的网卡设备名称至少为2个，再根据交集的网卡设备名称，获取多个VF池。例如，已开启SR-IOV的网卡设备名称列表中有3个网卡设备名称，分别是eth0、eth1、eth2，需要绑定的网卡设备名称列表中有2个网卡设备名称，分别是eth0、eth1，获取两个列表中交集的网卡设备名称为eth0、eth1。根据eth0获取一个VF池，根据eth1获取一个VF池。本发明实施例提供的VF配置方法，通过Nova设置VF白名单，根据VF白名单对VF进行筛选，有利于选定挂载在虚拟端口的VF。可选地，所述获取VF池之后，还包括：确定每一个VF池中VF处于空闲态的数量；若每一个VF池中VF处于空闲态的数量均大于等于M个，则从每一个VF池中选择M个处于空闲态的VF；所述M个为预设请求的VF个数。具体地，Nova compute判断每一个VF池中处于空闲态的VF是否够用，即判断每一个VF池中空闲态的VF数量是否大于等于预设请求的VF个数，预设请求的VF个数是请求的VF个数信息中设置的个数。若每一个VF池中处于空闲态的VF数量大于等于预设请求的VF个数，则说明处于空闲态的VF够用。在VF够用的情况下，从每一个VF池中选择M个处于空闲态的VF，M个即为预设请求的VF个数。本发明实施例提供的VF配置方法，通过从空闲态的VF中选定VF，有利于实现将VF挂载到虚拟机。可选地，所述从每一个VF池中选择M个处于空闲态的VF之后，还包括：将选择的N个VF对应的PCI地址以列表类型的方式更新到所述虚拟端口的信息中；所述N个VF为从所有VF池中选取出的处于空闲态的VF。具体地，若VF池一共有W个，从每一个VF池中选择M个处于空闲态的VF，则N个VF的数量为W与M的乘积。Nova compute更新虚拟端口的binding_profile信息，其中pci_slot信息为选定的N个VF的PCI地址组成的列表。Neutron-server更新虚拟端口的binding_profile，其中pci_slot信息为选定的N个VF的PCI地址组成的列表。将binding_profile信息中pci_slot信息由字符串类型优化成列表类型。Nova compute调用libvirt挂载选定的N个VF到虚拟机，并等待Neutron端口处理。本发明实施例提供的VF配置方法，通过将pci_slot信息由字符串类型优化成列表类型，有利于一个虚拟端口挂载多个VF。可选地，对一个虚拟端口配置N个VF之后，还包括：检测VF是否变化；对变化的VF进行配置调整，并更新所述虚拟端口的状态。具体地，Neutron-sriov-agent检测VF是否变化，VF的变化包括VF的MAC地址的变化。针对变化的VF进行配置调整，配置调整包括服务质量和trunk处理等。例如，虚拟机内部对VF配置负载均衡Bonding，正常状态下最大带宽限制的QoS策略在2个VF上各配置一半，当其中一个SR-IOV网口故障时，动态调整正常VF为最大带宽限制QoS策略的实际值，并当故障恢复时，动态调整2个VF为正常状态。在全部变化的VF处理完成之后，更新虚拟端口状态为active。Neutron-server通知nova虚拟端口处理完成，Nova-compute等待Neutron处理完成消息后，更新虚拟机的状态为active，从而完成虚机创建。本发明实施例提供的VF配置方法，通过对VF进行检测，实现灵活调整VF的配置，进一步灵活调整虚拟端口的状态。下面对本发明提供的VF配置装置进行描述，下文描述的VF配置装置与上文描述的VF配置方法可相互对应参照。图4是本发明提供的VF配置装置的结构示意图，如图4所示，本发明还提供一种VF配置装置，包括：配置模块401；配置模块401，用于对一个虚拟端口配置N个VF，并将所述N个VF同时挂载到虚拟机；所述N个VF的MAC地址和VLAN均相同，所述N为大于1的正整数。可选地，所述装置还包括：设置模块和获取模块，其中：所述设置模块，用于设置VF白名单；所述获取模块，用于根据所述VF白名单对VF进行筛选，获取VF池。可选地，所述装置还包括：确定模块和选择模块，其中：所述确定模块，用于确定每一个VF池中VF处于空闲态的数量；所述选择模块，用于若每一个VF池中VF处于空闲态的数量均大于等于M个，则从每一个VF池中选择M个处于空闲态的VF；所述M个为预设请求的VF个数。可选地，所述装置还包括：更新模块；所述更新模块，用于将选择的N个VF对应的PCI地址以列表类型的方式更新到所述虚拟端口的信息中；所述N个VF为从所有VF池中选取出的处于空闲态的VF。可选地，所述装置还包括：检测模块和调整模块；其中：所述检测模块，用于检测检测VF是否变化；所述调整模块，用于对变化的VF进行配置调整，并更新所述虚拟端口的状态。可选地，所述N个VF的MAC地址和VLAN均采用所述虚拟端口的MAC地址和VLAN。具体来说，本申请实施例提供的VF配置装置，能够实现上述方法实施例所实现的所有方法步骤，且能够达到相同的技术效果，在此不再对本实施例中与方法实施例相同的部分及有益效果进行具体赘述。图5是本发明提供的电子设备的结构示意图，如图5所示，该电子设备可以包括：处理器510、通信接口520、存储器530和通信总线540，其中，处理器510，通信接口520，存储器530通过通信总线540完成相互间的通信。处理器510可以调用存储器530中的逻辑指令，以执行VF配置方法，该方法包括：对一个虚拟端口配置N个VF，并将所述N个VF同时挂载到虚拟机；所述N个VF的MAC地址和VLAN均相同，所述N为大于1的正整数。此外，上述的存储器530中的逻辑指令可以通过软件功能单元的形式实现并作为独立的产品销售或使用时，可以存储在一个计算机可读取存储介质中。基于这样的理解，本发明的技术方案本质上或者说对现有技术做出贡献的部分或者该技术方案的部分可以以软件产品的形式体现出来，该计算机软件产品存储在一个存储介质中，包括若干指令用以使得一台计算机设备执行本发明各个实施例所述方法的全部或部分步骤。而前述的存储介质包括：U盘、移动硬盘、只读存储器、随机存取存储器、磁碟或者光盘等各种可以存储程序代码的介质。另一方面，本发明还提供一种计算机程序产品，所述计算机程序产品包括计算机程序，计算机程序可存储在非暂态计算机可读存储介质上，所述计算机程序被处理器执行时，计算机能够执行上述各方法所提供的VF配置方法，该方法包括：对一个虚拟端口配置N个VF，并将所述N个VF同时挂载到虚拟机；所述N个VF的MAC地址和VLAN均相同，所述N为大于1的正整数。又一方面，本发明还提供一种非暂态计算机可读存储介质，其上存储有计算机程序，该计算机程序被处理器执行时实现以执行上述各方法提供的VF配置方法，该方法包括：对一个虚拟端口配置N个VF，并将所述N个VF同时挂载到虚拟机；所述N个VF的MAC地址和VLAN均相同，所述N为大于1的正整数。以上所描述的装置实施例仅仅是示意性的，其中所述作为分离部件说明的单元可以是或者也可以不是物理上分开的，作为单元显示的部件可以是或者也可以不是物理单元，即可以位于一个地方，或者也可以分布到多个网络单元上。可以根据实际的需要选择其中的部分或者全部模块来实现本实施例方案的目的。本领域普通技术人员在不付出创造性的劳动的情况下，即可以理解并实施。通过以上的实施方式的描述，本领域的技术人员可以清楚地了解到各实施方式可借助软件加必需的通用硬件平台的方式来实现，当然也可以通过硬件。基于这样的理解，上述技术方案本质上或者说对现有技术做出贡献的部分可以以软件产品的形式体现出来，该计算机软件产品可以存储在计算机可读存储介质中，如ROM/RAM、磁碟、光盘等，包括若干指令用以使得一台计算机设备执行各个实施例或者实施例的某些部分所述的方法。本申请实施例中术语“第一”、“第二”等是用于区别类似的对象，而不用于描述特定的顺序或先后次序。应该理解这样使用的术语在适当情况下可以互换，以便本申请的实施例能够以除了在这里图示或描述的那些以外的顺序实施，且“第一”、“第二”所区别的对象通常为一类，并不限定对象的个数，例如第一对象可以是一个，也可以是多个。最后应说明的是：以上实施例仅用以说明本发明的技术方案，而非对其限制；尽管参照前述实施例对本发明进行了详细的说明，本领域的普通技术人员应当理解：其依然可以对前述各实施例所记载的技术方案进行修改，或者对其中部分技术特征进行等同替换；而这些修改或者替换，并不使相应技术方案的本质脱离本发明各实施例技术方案的精神和范围。
