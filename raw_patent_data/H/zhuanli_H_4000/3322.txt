标题title
一种弹性带宽调控方法、存储介质及终端
摘要abst
本发明公开了一种弹性带宽调控方法、存储介质及终端，属于带宽控制技术领域，包括空闲带宽利用步骤：当前网段的令牌数大于零、当前网段下各IP地址的令牌数小于零、IP地址的令牌数使IP地址下终端设备的使用带宽达到可抢占带宽上限同时成立时，增加IP地址的令牌数。还包括空闲带宽利用步骤：当前网段的令牌数小于零、当前网段下存在IP地址下终端设备在保障带宽内丢弃数据包、IP地址的令牌数使IP地址下终端设备的使用带宽超过保障带宽同时成立时，减小IP地址的令牌数。本发明数据传输的依据为是否有令牌可用，整个数据传输过程中没有队列调度开销，对系统的处理能力消耗小，能够在不增加系统处理开销的基础上实现有效的弹性带宽调控。
权利要求书clms
1.一种弹性带宽调控方法，其特征在于：所述方法包括空闲带宽利用步骤：当前网段的令牌数大于零、当前网段下各IP地址的令牌数小于零、IP地址的令牌数使IP地址下终端设备的使用带宽达到可抢占带宽上限同时成立时，增加IP地址的令牌数；所述方法还包括带宽抢占超上限IP地址的带宽控制步骤：当前网段的令牌数小于零、当前网段下存在IP地址下终端设备在保障带宽内丢弃数据包、IP地址的令牌数使IP地址下终端设备的使用带宽超过保障带宽同时成立时，减小IP地址的令牌数。2.根据权利要求1所述的一种弹性带宽调控方法，其特征在于：进行带宽利用步骤时：确定IP地址的令牌数使IP地址下终端设备的使用带宽达到可抢占带宽上限具体包括：获取基于当前IP地址的令牌数下的上下行流量进而获取IP地址的使用带宽，进而判断IP地址下终端设备的使用带宽是否达到可抢占带宽上限；进行宽带控制步骤时：确定IP地址的令牌数使IP地址下终端设备的使用带宽超过保障带宽具体包括：获取基于当前IP地址的令牌数下的上下行流量进而获取IP地址的使用带宽，进而判断IP地址下终端设备的使用带宽是否超过保障带宽。3.根据权利要求1所述的一种弹性带宽调控方法，其特征在于：进行带宽利用步骤或宽带控制步骤时，均以定时器周期为间隔触发和/或通过外部请求触发，进而实时调整各IP地址的令牌数。4.根据权利要求3所述的一种弹性带宽调控方法，其特征在于：所述方法还包括数据缓冲处理步骤：将上一周期未发送的数据包重新入队内核队列队首以缓冲。5.根据权利要求1所述的一种弹性带宽调控方法，其特征在于：所述方法还包括数据传输监控告警步骤：判断当前网段总令牌数是否小于零，若小于，执行第一告警动作；反之，判断当前网段下IP地址的令牌数是否小于零，若小于，执行第二告警动作；反之，继续统计当前周期内已发送的数据包字节数。6.根据权利要求1所述的一种弹性带宽调控方法，其特征在于：所述方法还包括内核组件建立步骤，包括：建立用于统计IP地址已发数据包字节数的IP地址发送计数器，以确定IP地址的令牌数是否使IP地址下终端设备的使用带宽达到可抢占带宽上限；建立令牌池，用于生成各网段、各IP地址的令牌；建立用于存储带宽配置信息的带宽配置表，进而获取可抢占带宽上限信息。7.根据权利要求3所述的一种弹性带宽调控方法，其特征在于：内核组件建立步骤还包括：建立令牌更新用内核定时器，用于生成定时器周期。8.一种存储介质，其上存储有计算机指令，其特征在于：所述计算机指令运行时执行权利要求1-7任意一项所述的一种弹性带宽调控方法的步骤。9.一种终端，包括存储器和处理器，所述存储器上存储有可在所述处理器上运行的计算机指令，其特征在于：所述处理器运行所述计算机指令时执行权利要求1-7任意一项所述的一种弹性带宽调控方法的步骤。
说明书desc
技术领域本发明涉及带宽控制技术领域，尤其涉及一种弹性带宽调控方法、存储介质及终端。背景技术通信网络应用至实际使用场景中时，由于网络带宽的限制，以及某些应用对带宽的抢占，易使终端用户之间带宽占用不合理。有的终端对带宽占用并不大，有的终端对带宽占用很大，由此终端之间带宽占用不均衡，影响客户体验。尤其目前WIF6进入大规模部署，AC+瘦AP，无线终端以更高的速率连接到AP上，以更高的上行和下行速率进行数据发送，会在AC的互联网出口形成更大的上下行数据量。因此，在AC+AP的网络模型中，提供对终端的上下行带宽占用的控制就显得很必要了。对接入网络的终端上下行带宽进行控制，即为每个接入网络的终端设定一个保障带宽，确保终端在任何时候都能获得保障带宽，同时任何终端在没有数据流量的时候，不能占用带宽不释放，每个终端之间都是平等的。每个终端得到的带宽是弹性的，既有底线保障，也能参与更多带宽的抢占，同时无数据时不预留带宽。当前家用和小微企业使用的路由器多采用linux系统作为操作系统，linux系统本身提供了TC机制，用于对网络中的终端和业务进行带宽限制。使用linux系统开发的路由器，使用linux提供的TC机制来实现对终端的带宽限制，如能够限制单个IP地址的带宽，更为具体地限制 192.168.1.2的下载速度为 30Mbit最高可以60Mbit。Linux系统提供的TC机制也可实现对网段的限速，实现网段内部的IP地址共享带宽。然而TC机制复杂对系统处理能力消耗大。如基于MTK7621主板，限制192.168.8.0网段300Mbit的带宽，此时从WAN口输入500M下行流量，根据带宽限制配置，设备要丢弃200M下行流量，进而限制192.168.8.0 网段的带宽为300Mbit，整个测试过程中，MTK7621的CPU占用率达到了90%。出现这种情况是因为，TC机制是为了满足多种QOS服务需求设计的一个普适机制，基本的构成块有三部分：队列规定qdisc 、类 和分类器。其中，队列用于实现控制网络的收发速度。通过队列，linux可以将网络数据包缓存起来，然后根据用户的设置，在尽量不中断连接 的前提下来平滑网络流量。需要注意的是，linux对接收队列的控制不够好，所以我们一般只用发送队列，即“控发不控收”。它封装了其他两个主要 TC组件 。内核如果需要通过某个网络接口发送数据包，它都需要按照为这个接口配置的qdisc把数据包加入队列。然后，内核会尽可能多地从qdisc里面取出数据包，把它们交给网络适配器驱动模块。队列规则包括： FIFO， RED，SFQ和令牌桶 ，类基队列 。CBQ 是一种超级队列，其能够包含其它队列；便于理解，以一棵树做类比，CBQ是树干，而且可以嫁接其他新的树枝或树干，当然也可以直接生长出树叶来，而 FIFO只能充当树叶的角色，在它下面不能再添加分类了。Class用于表示控制策略。实际应用过程中，需要对不同的 IP地址实行不同的流量控制策略，此时需要用不同的 class表示不同的控制策略了。Filter用于将用户划入到具体的控制策略中  。比如，现需对192.168.1.33，192.168.1.34 两个 IP地址实行不同的控制策略 ，此时采用 filter将192.168.1.33划入到控制策略 A，将 192.168.1.34划入到控制策略 B，filter划分的标志位可用u32打标功能或IP地址tables 的 set-mark 功能来实现。综上，基于TC机制实现如前所述的家装和小微企业需要的弹性带宽调控模型，每个IP地址包进来之后，除了正常的NAT处理和路由处理之外，还要用filter将IP地址包纳入不同的class中，再入队到对应的队列里，由内核调度各个队列，进行发送，可以看出TC机制是建立在复杂的队列管理与调度、分类策略上的，因此对系统的处理能力消耗大，在此基础上，如何在不增加系统处理开销的基础上实现弹性带宽调控是目前亟需解决的技术问题。发明内容本发明的目的在于克服现有技术中无法在不增加系统处理开销的基础上实现弹性带宽调控的问题，提供了一种弹性带宽调控方法、存储介质及终端。本发明的目的是通过以下技术方案来实现的：一种弹性带宽调控方法，所述方法包括空闲带宽利用的控制策略：当前网段的令牌数大于零、当前网段下各IP地址的令牌数小于零、IP地址的令牌数使IP地址下终端设备的使用带宽达到可抢占带宽上限同时成立时，增加IP地址的令牌数；所述方法还包括带宽抢占超上限IP地址的带宽控制步骤：当前网段的令牌数小于零、当前网段下存在IP地址下终端设备在保障带宽内丢弃数据包、IP地址的令牌数使IP地址下终端设备的使用带宽超过保障带宽同时成立时，减小IP地址的令牌数。其中，令牌对应着字节数，IP地址对应着网络终端，每个IP的令牌数就对应着当前周期内，IP地址可以发送的包的字节数，网段的令牌数就对应着本周期内位于网段内所有IP能够发送的包的字节总数。带宽以bit为单位，相应的，令牌在与带宽做比较的时候，也要从字节单位转换为bit单位。作为一种可选的技术方案，进行带宽利用步骤时：确定IP地址的令牌数使IP地址下终端设备的使用带宽达到可抢占带宽上限具体包括：获取基于当前IP地址的令牌数下的上下行流量进而获取IP地址的使用带宽，进而判断IP地址下终端设备的使用带宽是否达到可抢占带宽上限；进行宽带控制步骤时：确定IP地址的令牌数使IP地址下终端设备的使用带宽超过保障带宽具体包括：获取基于当前IP地址的令牌数下的上下行流量进而获取IP地址的使用带宽，进而判断IP地址下终端设备的使用带宽是否超过保障带宽作为一种可选的技术方案，进行带宽利用步骤或宽带控制步骤时，均以定时器周期为间隔触发和/或通过外部请求触发，进而实时调整各IP地址的令牌数。作为一种可选的技术方案，所述方法还包括数据缓冲处理步骤：将上一周期未发送的数据包重新入队内核队列队首以缓冲。作为一种可选的技术方案，所述方法还包括数据传输监控告警步骤：判断当前网段总令牌数是否小于零，若小于，执行第一告警动作；反之，判断当前网段下IP地址的令牌数是否小于零，若小于，执行第二告警动作；反之，继续统计当前周期内已发送的数据包字节数。作为一种可选的技术方案，所述方法还包括内核组件建立步骤，包括：建立用于统计IP地址已发数据包字节数的IP地址发送计数器，以确定IP地址的令牌数是否使IP地址下终端设备的使用带宽达到可抢占带宽上限；建立令牌池，用于生成各网段、各IP地址的令牌；建立用于存储带宽配置信息的带宽配置表，进而获取可抢占带宽上限信息。作为一种可选的技术方案，内核组件建立步骤还包括：建立令牌更新用内核定时器，用于生成定时器周期。需要进一步说明的是，上述各示例对应的技术特征可以相互组合或替换构成新的技术方案。本发明还包括一种存储介质，其上存储有计算机指令，所述计算机指令运行时执行上述任一示例或者多个示例组合形成的所述的一种弹性带宽调控方法的步骤。本发明还包括一种终端，包括存储器和处理器，所述存储器上存储有可在所述处理器上运行的计算机指令，所述处理器运行所述计算机指令时执行上述任一示例或者多个示例组合形成的所述的一种弹性带宽调控方法的步骤。与现有技术相比，本发明有益效果是：在一示例中，本发明基于网段、IP地址的令牌数量确定当前网络带宽的使用情况，在网段的带宽未完全占用的情况下，进一步增大丢包的IP地址终端的网络带宽，以实现有效的数据传输，且数据传输的依据为是否有令牌可用，整个数据传输过程中没有队列调度开销，对系统的处理能力消耗小，即本发明能够在不增加系统处理开销的基础上实现有效的弹性带宽调控。在一示例中，本发明基于网段、IP地址的令牌数量确定当前网络带宽的使用情况，在网段带宽完全被使用的基础上，进一步限制抢占过多带宽的IP地址终端，以此保证有效的数据传输，且数据传输的依据为是否有令牌可用，整个数据传输过程中没有队列调度开销，对系统的处理能力消耗小，即本发明能够在不增加系统处理开销的基础上实现有效的弹性带宽调控。在一示例中，本发明通过引入定时器周期对令牌数量进行更新调整，以适应不断变化的数据传输场景。在一示例中，本发明通过队首入队的方式能够保证缓冲的数据包顺序不被打乱，降低数据传输出错几率。在一示例中，本发明通过网段、IP地址的令牌数对当前带宽的使用情况进行报警提示，能够更加直观获取当前网络的带宽使用情况。在一示例中，本发明通过建立IP地址发送计数器、网段发送计数器能够统计各网段、各IP地址的实时流量使用情况，进而确定网络带宽占用情况。附图说明下面结合附图对本发明的具体实施方式作进一步详细的说明，此处所说明的附图用来提供对本发明的进一步理解，构成本发明的一部分，在这些附图中使用相同的参考标号来表示相同或相似的部分，本发明的示意性实施例及其说明用于解释本发明，并不构成对本发明的不当限定。图1为本发明一示例中空闲带宽利用的方法流程图；图2为本发明一示例中带宽抢占超上限IP地址的带宽控制的方法流程图；图3为本发明一示例中弹性带宽优选控制方法流程图；图4为本发明一示例中的上行数据调控方法流程图；图5为本发明一示例中的下行数据调控方法流程图。具体实施方式下面结合附图对本发明的技术方案进行清楚、完整地描述，显然，所描述的实施例是本发明一部分实施例，而不是全部的实施例。基于本发明中的实施例，本领域普通技术人员在没有做出创造性劳动前提下所获得的所有其他实施例，都属于本发明保护的范围。在本发明的描述中，需要说明的是，属于“中心”、“上”、“下”、“左”、“右”、“竖直”、“水平”、“内”、“外”等指示的方向或位置关系为基于附图所述的方向或位置关系，仅是为了便于描述本发明和简化描述，而不是指示或暗示所指的装置或元件必须具有特定的方位、以特定的方位构造和操作，因此不能理解为对本发明的限制。此外，属于“第一”、“第二”仅用于描述目的，而不能理解为指示或暗示相对重要性。在本发明的描述中，需要说明的是，除非另有明确的规定和限定，属于“安装”、“相连”、“连接”应做广义理解，例如，可以是固定连接，也可以是可拆卸连接，或一体地连接；可以是机械连接，也可以是电连接；可以是直接相连，也可以通过中间媒介间接相连，可以是两个元件内部的连通。对于本领域的普通技术人员而言，可以具体情况理解上述术语在本发明中的具体含义。此外，下面所描述的本发明不同实施方式中所涉及的技术特征只要彼此之间未构成冲突就可以相互结合。本发明旨在解决现有带宽控制技术即TC机制队列管理与调度、分类策略复杂导致对系统处理性能占用率大的问题，提供出了一种带宽控制方法，以应用于家装和小微企业的网络场景为例说明本发明方法，该示例使用场景并不对本发明方法使用场景进行限制。在一示例中，一种弹性带宽调控方法，具体包括空闲带宽利用的控制策略，当前网段的令牌数大于零、当前网段下各IP地址的令牌数小于零、IP地址的令牌数使IP地址下终端设备的使用带宽达到可抢占带宽上限同时成立时，增加IP地址的令牌数。如图1所示，作为一优选实施方式，上述控制策略的实施步骤具体包括：判断当前网段的令牌数是否耗尽，若未耗尽，判断当前网段下各IP地址的令牌数是否耗尽，若耗尽，判断第一IP地址的令牌数是否使第一IP地址下终端设备在数据传输时的实用带宽达到可抢占带宽上限，若未达到可抢占带宽上限，增加第一IP地址的令牌数。其中，第一IP地址表示令牌数耗尽的IP地址；IP地址的令牌数即该IP地址被分配的令牌数量，一IP地址对应多个终端设备，如接入同一WIFI的手机、平板、电脑以及智能电视等；同一IP地址下的终端设备是否能够收发数据取决于其是否用可以使用的令牌数，即IP地址的令牌数与数据包数量对应，数据包能够发送必须有对应的令牌进行授权；数据包字节数越大、数量越大，对应地需要更大的带宽进行数据收发。具体地，可抢占带宽上限表示该IP地址下的终端设备可使用的最大带宽，默认为保障带宽的32倍。其中，保障带宽表示可满足该IP地址下的终端设备正常通信的最小带宽，终端设备的保障带宽可以使用默认设置，默认设置会根据网段在线的终端数量来计算保障带宽。更为具体地，当前网段的令牌数未耗尽时，说明当前网段的带宽未被完全使用，仍有冗余，此时通过判断该网段下IP地址的令牌数数量进一步判断是否有IP地址对应的终端设备出现丢包的情况，如果在网段令牌没有耗尽，IP地址对应的终端设备的令牌耗尽，只要此时IP地址的令牌数没有超过可抢占带宽上限，那么就增加该终端设备对应的IP地址的令牌数，以拓展该IP地址的带宽，在不影响其他IP地址数据传输的情况下，保证了整个网段下各IP地址对应的终端设备能够实现正常的数据传输，防止数据传输卡顿、丢包的情况。进一步地，本发明整个数据传输过程中，数据包发送的依据为是否有令牌可用，整个数据传输过程中没有队列调度开销，对系统的处理能力消耗小，即本发明能够在不增加系统处理开销的基础上实现有效的弹性带宽调控。更为具体地，上述空闲带宽利用示例还具体包括：若当前网段下各IP地址的令牌数若未耗尽，则维持现有令牌数，不做调整；同时，若第一IP地址的令牌数使第一IP地址下终端设备在数据传输时的使用带宽达到可抢占带宽上限，则维持现有令牌数，不做调整。在一示例中，判断第一IP地址的令牌数是否使第一IP地址下终端设备在数据传输时的实用带宽达到可抢占带宽上限具体包括：获取基于当前第一IP地址的令牌数下的上下行流量进而获取第一IP地址的使用带宽，进而判断第一IP地址下终端设备的使用带宽是否达到可抢占带宽上限。具体地，获取基于当前第一IP地址的令牌数下的上下行流量表示，在第一IP地址保持当前令牌数的情况下，统计基于该令牌数已经发出的数据包字节大小，进而获取第一IP地址的上下行流量即实际的使用带宽。其中，第一IP地址在数据传输时达到可抢占带宽上限表示第一IP地址下所有终端设备的带宽总和是否能达到可抢占带宽上限。作为一选项，IP地址的令牌数的增加与减小通过实际使用场景进行预设定，在家用和小微企业场景下，每次IP地址的令牌数增加与减小均变化一倍保障带宽。在一示例中，判断对应第二IP地址的令牌数是否会使第二IP地址在数据传输时超过保障带宽具体包括：基于IP地址的令牌数计算待发送数据包字节大小以获取IP地址的上下行流量，基于IP地址的上下行流量进而获取IP地址的理论带宽，比较理论带宽与保障带宽大小即可判断IP地址是否超过保障带宽。其中，第二IP地址在数据传输时超过保障带宽表示第二IP地址下任一终端设备带宽超过保障带宽。在一示例中，所述空闲带宽利用步骤以定时器周期为间隔触发和/或通过外部请求触发，进而实时调整各IP地址的令牌数。其中，外部请求触发即用户终端与本发明调控方法执行主体进行通信连接建立连接后，发送对应的带宽调整请求信息，内核重新执行对应的空闲带宽利用步骤。优选地，空闲带宽利用步骤根据上一周期内的实际带宽使用情况对各网段、各IP地址的令牌数进行调整更新，即重新计算下一个周期内各个IP地址的令牌大小，以适应不断变化的数据传输场景。定时器周期为固定周期，作为一优选项，定时器周期的周期可调，即可以设置为1s，100ms，10ms等，以此提升终端设备的令牌调整灵敏度。本示例中，定时器周期为50ms，即1秒内更新20次IP地址的令牌数。在一示例中，所述方法还包括数据缓存步骤：将上一周期未发送的数据包重新入队内核队列队首以缓冲。Linux系统内，原本有一个队列，用于缓冲从接口接收的数据包，这个队列原本的工作方式是后继的包进入队尾，只提供了从队尾入队的方式，本发明增加了队首入队的方式，用于将超出了带宽的数据包重新入队到缓冲队列里。为保证下一次发送队列里缓冲包的顺序不乱，因此无法发送的包需要重新入队到队首去，以此降低数据传输出错几率。在一示例中，所述方法还包括数据传输监控告警步骤：判断当前网段总令牌数是否小于零，若小于，执行第一告警动作；反之，判断当前网段下IP地址的令牌数是否小于零，若小于，执行第二告警动作；反之，继续统计当前周期内已发送的数据包字节数，包括网段已发送字节数、及IP地址已发送的字节数；通过网段、IP地址的令牌数对当前带宽的使用情况进行报警提示，能够更加直观获取当前网络的带宽使用情况。具体地，执行第一告警动作具体为显示“FAIL”标志，并显示对应的网段名称，同时本周期内未发送的数据包插入临时队列队尾；执行第二告警动作具体为显示“FAIL”标志，并显示对应的IP地址，同时本周期内未发送的数据包插入临时队列队尾。当然作为一优选项，执行第一告警动作、第二告警动作的同时可以额外增加新的报警动作，如不同语音提示或者灯光提示等。在一示例中，所述方法还包括内核组件建立步骤，包括：建立用于统计IP地址已发数据包字节数的IP地址发送计数器，以获取当前IP令牌数下各IP地址的实时上行流量、下行流量，以确定IP地址的使用带宽，进而判断IP地址的令牌数是否使IP地址在数据传输时的使用带宽达到可抢占带宽上限；建立令牌池，用于生成各网段、各IP地址的令牌，以使各网段、IP地址分配得到对应的令牌数进而发送对应的数据包；建立用于存储带宽配置信息的带宽配置表，进而获取IP地址的网段的总带宽、可抢占带宽上限信息、各IP地址与网段的映射关系，基于带宽配置表的参数计算下一个定时器周期内每个IP地址的令牌数量。其中，网段总带宽表示网段最大能获取到的物理带宽。带宽配置表包括1024个表项，每个表项对应一个IP地址的配置，我们称为“IP地址配置项”。带宽配置表还包括8个“网段配置项”，将“IP地址配置项”与“网段配置项”关联起来，即实现各IP地址与网段的映射。在一示例中，所述内核组件建立步骤还包括：建立用于统计网段已发数据包字节数的网段地址发送计数器。具体地，家用和小微企业场景下，接入网络的终端数量有限，设置1024个IP地址发送计数器，用于统计一个时间周期内已经发送的字节数，该IP地址发送计数器与接入网络的终端的IP地址一一对应。同时设置8个网段发送计数器，每个网段发送计数器与各网段一一对应。更为具体地，1024个“IP地址发送计数器”和8个“网段发送计数器”构成一个发送统计表，用于在一个定时器周期内，通过递减计数的方式限制单个IP地址的下行或者上行流量以及一个网段的上下行流量；当递减计数小于零时，后继待发送的包，或者丢弃，或者缓存起来。在一示例中，所述内核组件建立步骤还包括：建立令牌更新用内核定时器，用于生成定时器周期，基于上一周期的数据发送情况即带宽使用情况计算下一定时器周期内各个IP地址的令牌数量。本实施例提供了一种存储介质，与上述任一示例或多个示例组合形成的一种弹性带宽调控方法具有相同的发明构思，其上存储有计算机指令，所述计算机指令运行时执行上述任一示例或多个示例组合形成的所述一种弹性带宽调控方法的步骤。基于这样的理解，本实施例的技术方案本质上或者说对现有技术做出贡献的部分或者该技术方案的部分可以以软件产品的形式体现出来，该计算机软件产品存储在一个存储介质中，包括若干指令用以使得一台计算机设备执行本发明各个实施例所述方法的全部或部分步骤。而前述的存储介质包括：U盘、移动硬盘、只读存储器、随机存取存储器、磁碟或者光盘等各种可以存储程序代码的介质。本实施例还提供一种终端，与上述任一示例或多个示例组合形成的一种弹性带宽调控方法具有相同的发明构思，包括存储器和处理器，所述存储器上存储有可在所述处理器上运行的计算机指令，所述处理器运行所述计算机指令时执行上述任一示例或多个示例组合形成的所述一种弹性带宽调控方法的步骤。处理器可以是单核或者多核中央处理单元或者特定的集成电路，或者配置成实施本发明的一个或者多个集成电路。在本发明提供的实施例中的各功能单元可以集成在一个处理单元中，也可以是各个单元单独物理存在，也可以两个或两个以上单元集成在一个单元中。基于上述带宽调控方法任一示例或者多个示例组合的发明构思，本发明还提供一种弹性带宽调控系统，所述系统具体包括：IP地址发送计数器，用于统计地址已发数据包字节数，以此获取各IP地址的实时上行流量，进而判断IP地址的令牌数是否使IP地址下终端设备在数据传输时的使用带宽达到可抢占带宽上限；具体地，基于所述IP地址发送计数器能够统计基于当前IP地址的令牌数已发送数据包字节数，进而将IP地址的令牌数与其使用带宽进行关联。令牌池，用于生成各网段、各IP地址的令牌，以使各网段、IP地址分配得到对应的令牌数进而发送对应的数据包；带宽配置表，用于存储带宽配置信息，进而获取IP地址的网段的总带宽、IP地址的保障带宽、可抢占带宽上限信息、各IP地址与网段的映射关系；在一示例中，所述弹性带宽调控系统还包括网段发送计数器，用于基于IP地址的令牌数统计的网段已发数据包字节数，以此获取各网段的实时上行流量；在一示例中，所述弹性带宽调控系统还包括内核定时器，用于生成定时器周期，基于上一周期的数据发送情况即带宽使用情况计算下一定时器周期内各个IP地址的令牌数量。定时器周期为固定周期，作为一优选项，定时器周期的周期可调，即可以设置为1s，100ms，10ms等，以此提升终端设备的令牌调整灵敏度。本示例中，定时器周期为50ms，即1秒内更新20次IP地址的令牌数。在一示例中，本发明一种带宽调控方法还包括：带宽抢占超上限IP地址的带宽控制步骤，包括当前网段的令牌数小于零、当前网段下存在IP地址下终端设备在保障带宽内丢弃数据包、IP地址的令牌数使IP地址下终端设备的使用带宽超过保障带宽同时成立时，减小IP地址的令牌数。如图2所示，作为一优选实施方式，带宽抢占超上限IP地址的带宽控制步骤具体包括：判断当前网段的令牌数是否耗尽，若耗尽，判断当前网段下各IP地址下终端设备是否在保障带宽内丢弃数据包，若丢弃了数据包，判断对应第二IP地址的令牌数是否使第二IP地址下终端设备在数据传输时的使用带宽超过保障带宽，若超过保障带宽，减小第二IP地址的令牌数。其中，第二IP地址表示在保障带宽内丢弃数据包的IP地址，即保障带宽内丢弃数据包的IP地址下的终端设备。具体地，当前网段的令牌数耗尽时，说明当前网段的带宽被完全使用，无冗余带宽可传输数据包，此时进一步判断该网段下的终端设备是否在保障带宽内丢弃数据包，若有终端设备保障带宽内的数据丢弃，则表示当前IP地址的其他终端设备抢占了过多的带宽，此时超过保障带宽的终端设备的令牌数都需进一步减少。更为具体地，上述带宽抢占超上限IP地址的带宽控制示例还具体包括：若当前网段下各IP地址对应的终端未在保障带宽内丢弃数据包，则维持现有令牌数，不做调整；同时，若第二IP地址的令牌数不会使第二IP地址下终端设备在数据传输时的使用带宽超过保障带宽，则维持现有令牌数，不做调整。作为一选项，IP地址的令牌数的增加与减小通过实际使用场景进行预设定，在家用和小微企业场景下，每次IP地址的令牌数增加与减小均变化一倍保障带宽。在一示例中，判断对应第二IP地址的令牌数是否使第二IP地址下终端设备在数据传输时的使用带宽超过保障带宽具体包括：获取基于当前第二IP地址的令牌数下的上下行流量进而获取第二IP地址的使用带宽，进而判断第二IP地址下终端设备的使用带宽是否达到可抢占带宽上限。具体地，获取基于当前第二IP地址的令牌数下的上下行流量表示，在第二IP地址保持当前令牌数的情况下，统计基于该令牌数已经发出的数据包字节大小，进而获取IP地址的上下行流量即实际的使用带宽。其中，第二IP地址在数据传输时超过保障带宽表示第二IP地址下任一终端设备带宽超过保障带宽。在一示例中，所述带宽抢占超上限IP地址的带宽控制步骤以定时器周期为间隔触发和/或通过外部请求触发，进而实时调整各IP地址的令牌数。其中，外部请求触发即用户终端与本发明调控方法执行主体进行通信连接建立连接后，发送对应的带宽调整请求信息，内核重新执行对应的带宽抢占超上限IP地址的带宽控制步骤。优选地，带宽抢占超上限IP地址的带宽控制步骤根据上一周期内的实际带宽使用情况对各网段、各IP地址的令牌数进行调整更新，即重新计算下一个周期内各个IP地址的令牌大小，以适应不断变化的数据传输场景。定时器周期为固定周期，作为一优选项，定时器周期的周期可调，即可以设置为1s，100ms，10ms等，以此提升终端设备的令牌调整灵敏度。本示例中，定时器周期为50ms，即1秒内更新20次IP地址的令牌数。在一示例中，所述方法还包括数据缓存步骤：将上一周期未发送的数据包重新入队内核队列队首以缓冲。Linux系统内，原本有一个队列，用于缓冲从接口接收的数据包，这个队列原本的工作方式是后继的包进入队尾，只提供了从队尾入队的方式，本发明增加了队首入队的方式，用于将超出了带宽的数据包重新入队到缓冲队列里。为保证下一次发送队列里缓冲包的顺序不乱，因此无法发送的包需要重新入队到队首去，以此降低数据传输出错几率。在一示例中，所述方法还包括数据传输监控告警步骤：判断当前网段总令牌数是否小于零，若小于，执行第一告警动作；反之，判断当前网段下IP地址的令牌数是否小于零，若小于，执行第二告警动作；反之，继续统计当前周期内已发送的数据包字节数，包括网段已发送字节数、及IP地址已发送的字节数；通过网段、IP地址的令牌数对当前带宽的使用情况进行报警提示，能够更加直观获取当前网络的带宽使用情况。具体地，执行第一告警动作具体为显示“FAIL”标志，并显示对应的网段名称，同时本周期内未发送的数据包插入临时队列队尾；执行第二告警动作具体为显示“FAIL”标志，并显示对应的IP地址，同时本周期内未发送的数据包插入临时队列队尾。当然作为一优选项，执行第一告警动作、第二告警动作的同时可以额外增加新的报警动作，如不同语音提示或者灯光提示等。在一示例中，所述方法还包括内核组件建立步骤，包括：建立用于统计IP地址已发数据包字节数的IP地址发送计数器，以获取当前IP令牌数下各IP地址的实时上行流量、下行流量，以确定IP地址的使用带宽，进而判断IP地址的令牌数是否使IP地址在数据传输时的使用带宽达到保障带宽；建立令牌池，用于生成各网段、各IP地址的令牌，以使各网段、IP地址分配得到对应的令牌数进而发送对应的数据包；建立用于存储带宽配置信息的带宽配置表，进而获取IP地址的网段的总带宽、IP地址的保障带宽、各IP地址与网段的映射关系，基于带宽配置表的参数计算下一个定时器周期内每个IP地址的令牌数量。其中，网段总带宽表示网段最大能获取到的物理带宽。带宽配置表包括1024个表项，每个表项对应一个IP地址的配置，我们称为“IP地址配置项”。带宽配置表还包括8个“网段配置项”，将“IP地址配置项”与“网段配置项”关联起来，即实现各IP地址与网段的映射。在一示例中，所述内核组件建立步骤还包括：建立用于统计网段已发数据包字节数的网段地址发送计数器。具体地，家用和小微企业场景下，接入网络的终端数量有限，设置1024个IP地址发送计数器，用于统计一个时间周期内已经发送的字节数，该IP地址发送计数器与接入网络的终端的IP地址一一对应。同时设置8个网段发送计数器，每个网段发送计数器与各网段一一对应。更为具体地，1024个“IP地址发送计数器”和8个“网段发送计数器”构成一个发送统计表，用于在一个定时器周期内，通过递减计数的方式限制单个IP地址的下行或者上行流量以及一个网段的上下行流量；当递减计数小于零时，后继待发送的包，或者丢弃，或者缓存起来。在一示例中，所述内核组件建立步骤还包括：建立令牌更新用内核定时器，用于生成定时器周期，基于上一周期的数据发送情况即带宽使用情况计算下一定时器周期内各个IP地址的令牌数量。本实施例提供了一种存储介质，与上述任一示例或多个示例组合形成的一种弹性带宽调控方法具有相同的发明构思，其上存储有计算机指令，所述计算机指令运行时执行上述任一示例或多个示例组合形成的所述一种弹性带宽调控方法的步骤。基于这样的理解，本实施例的技术方案本质上或者说对现有技术做出贡献的部分或者该技术方案的部分可以以软件产品的形式体现出来，该计算机软件产品存储在一个存储介质中，包括若干指令用以使得一台计算机设备执行本发明各个实施例所述方法的全部或部分步骤。而前述的存储介质包括：U盘、移动硬盘、只读存储器、随机存取存储器、磁碟或者光盘等各种可以存储程序代码的介质。本实施例还提供一种终端，与上述任一示例或多个示例组合形成的一种弹性带宽调控方法具有相同的发明构思，包括存储器和处理器，所述存储器上存储有可在所述处理器上运行的计算机指令，所述处理器运行所述计算机指令时执行上述任一示例或多个示例组合形成的所述一种弹性带宽调控方法的步骤。处理器可以是单核或者多核中央处理单元或者特定的集成电路，或者配置成实施本发明的一个或者多个集成电路。在本发明提供的实施例中的各功能单元可以集成在一个处理单元中，也可以是各个单元单独物理存在，也可以两个或两个以上单元集成在一个单元中。基于上述带宽调控方法任一示例或者多个示例组合的发明构思，本发明还提供一种弹性带宽调控系统，所述系统具体包括：IP地址发送计数器，用于统计IP地址已发数据包字节数，以此获取各IP地址的实时上行流量，进而判断IP地址的令牌数是否使IP地址下终端设备在数据传输时的使用带宽超过保障带宽；具体地，基于所述IP地址发送计数器能够统计基于当前IP地址的令牌数已发送数据包字节数，进而将IP地址的令牌数与其使用带宽进行关联。令牌池，用于生成各网段、各IP地址的令牌，以使各网段、IP地址分配得到对应的令牌数进而发送对应的数据包；带宽配置表，用于存储带宽配置信息，进而获取IP地址的网段的总带宽、IP地址的保障带宽、可抢占带宽上限信息、各IP地址与网段的映射关系；在一示例中，所述弹性带宽调控系统还包括网段发送计数器，用于基于IP地址的令牌数统计的网段已发数据包字节数，以此获取各网段的实时上行流量；在一示例中，所述弹性带宽调控系统还包括内核定时器，用于生成定时器周期，基于上一周期的数据发送情况即带宽使用情况计算下一定时器周期内各个IP地址的令牌数量。定时器周期为固定周期，作为一优选项，定时器周期的周期可调，即可以设置为1s，100ms，10ms等，以此提升终端设备的令牌调整灵敏度。本示例中，定时器周期为50ms，即1秒内更新20次IP地址的令牌数。将上述空闲带宽利用步骤的控制策略与带宽抢占超上限IP地址的带宽控制策略进行组合得到一优选带宽调控方法，如图3所示，具体包括：S1：判断当前网段的令牌数是否耗尽，若否，进入步骤S2，反之进入步骤S3；S2：判断当前网段下各IP地址的令牌数是否耗尽，若否，维持现有令牌；若是，判断第一IP地址的令牌数是否使第一IP地址在数据传输时达到可抢占带宽上限，若达到可抢占带宽上限，维持现有令牌，若未达到可抢占带宽上限，增加第一IP地址的令牌数，本次IP地址令牌调整结束；S3：判断当前网段下各IP地址下终端设备是否在保障带宽内丢弃数据包，若否，维持现有令牌；反之，判断对应第二IP地址的令牌数是否会使第二IP地址在数据传输时超过保障带宽，若未超过保障带宽，维持现有令牌；反之，减小第二IP地址的令牌数，本次IP地址令牌调整结束。通过上述优选示例，在每个定时器周期内，抢占过多带宽的终端被识别出，进而减少其令牌数，进一步限制其带宽；在网段带宽未被完全占用的情况下，任何终端只要出现了丢包，都可以上调令牌，直到达到可抢占带宽的上限，进而将空闲的带宽都利用起来，释放给需要的终端设备，保证了数据的有效传输，以此根据不同时间段的用户数据传输需求实现灵活的带宽控制，且由于不涉及队列调度开销，只增加了判断IP地址所拥有的令牌是否耗尽的开销，在数据包不发生丢弃的情况下，系统开销的增加可以忽略不计。基于上述空闲带宽利用步骤的控制策略与带宽抢占超上限IP地址的带宽控制策略的组合的发明构思，本发明还提供一种弹性带宽调控系统，所述系统具体包括：IP地址发送计数器，用于统计IP地址已发数据包字节数，以此获取各IP地址的实时上行流量，进而判断IP地址的令牌数是否使IP地址下终端设备在数据传输时的使用带宽达到可抢占带宽上限、并判断IP地址的令牌数是否会使IP地址下终端设备在数据传输时的使用带宽超过保障带宽；具体地，基于所述IP地址发送计数器能够统计基于当前IP地址的令牌数已发送数据包字节数，进而将IP地址的令牌数与其使用带宽进行关联。令牌池，用于生成各网段、各IP地址的令牌，以使各网段、IP地址分配得到对应的令牌数进而发送对应的数据包；带宽配置表，用于存储带宽配置信息，进而获取IP地址的网段的总带宽、IP地址的保障带宽、可抢占带宽上限信息、各IP地址与网段的映射关系；在一示例中，所述弹性带宽调控系统还包括网段发送计数器，用于基于IP地址的令牌数统计的网段已发数据包字节数，以此获取各网段的实时上行流量；在一示例中，所述弹性带宽调控系统还包括内核定时器，用于生成定时器周期，基于上一周期的数据发送情况即带宽使用情况计算下一定时器周期内各个IP地址的令牌数量。定时器周期为固定周期，作为一优选项，定时器周期的周期可调，即可以设置为1s，100ms，10ms等，以此提升终端设备的令牌调整灵敏度。本示例中，定时器周期为50ms，即1秒内更新20次IP地址的令牌数。作为一选项，带宽配置表中网段总带宽表示网段最大能获取到的物理带宽，如当前互联网出口下行带宽是500M，如果当前有两个LAN网段，两个网段能获取的总带宽理论计算值相加等于500M，其中LAN1网段192.168.10.0/24，带宽200Mbit；LAN2网段192.168.11.0/24，带宽300Mbit。可抢占带宽上限表示该IP地址下的终端设备可使用的最大带宽，默认为保障带宽的32倍。其中，保障带宽表示可满足该IP地址下的终端设备正常通信的最小带宽，终端设备的保障带宽可以使用默认设置，默认设置会根据网段在线的终端数量来计算保障带宽。以LAN1网段为例，假如当前在线终端设备数量是80，那么保障带宽200/80/4=0.6M，也就是每个在线终端可以得到0.6Mbit的保障带宽。如果运行过程中，在线终端数量下降到50，则每个在线终端的保障带宽变为200/50/4=1M。更为具体地，带宽配置表包括1024个表项，每个表项对应一个IP地址的配置，我们称为“IP地址配置项”。带宽配置表还包括8个“网段配置项”，将“IP地址配置项”与“网段配置项”关联起来，即实现各IP地址与网段的映射。上述带宽配置表的带宽配置参数为优选默认配置模式，该模式下屏蔽了参数细节和参数之间的关联性，用户只需要配置WAN口总带宽，各个LAN网段的占用带宽即可，IP地址的保障带宽、可抢占带宽上限信息等参数可自动计算，进而实现带宽控制。基于上述优选弹性带宽调控系统的基础上，结合上述弹性带宽调控方法的示例的组合得到本发明最优示例，为进一步说明本发明发明构思，现以该最优示例的数据发送流程进行具体说明：首先，以linux系统上行数据调控方法为例进行说明，如图4所示，具体包括：S21：从LAN口接收的IP地址包并查询路由表，进而得知具体IP地址包具体经某一WAN口进行发送；S22：判断网段总令牌数是否小于零，若是，IP地址包插入临时队列队尾，同时对应的IP地址发送计数器设置“FAIL”标志；反之，进入步骤S23；S23：判断IP地址的令牌数是否小于零，若小于，IP地址包插入临时队列队尾，同时对应的IP地址发送计数器设置“FAIL”标志；反之，IP地址发送计数器递减，网段发送计算器递减；S24：进行SNAT处理，将源IP地址替换成WAN的 IP地址，以此将IP地址包发送出去。更进一步地，作为一优选项，步骤S22中，若网段总令牌数小于零，还包括对IP地址令牌进行调整，具体包括：判断当前网段下各IP地址下终端设备是否在保障带宽内丢弃数据包，若未丢弃数据包，维持现有令牌；若丢弃了数据包，判断对应IP地址的令牌数是否会使IP地址在数据传输时超过保障带宽，若未超过保障带宽，维持现有令牌；若超过保障带宽，减IP地址的令牌数，本次IP地址令牌调整结束。再者，以linux系统下行数据调控方法为例进行说明，如图5所示，具体包括：S31：从WAN口接收的IP地址包并进行DNAT处理，还原出指向LAN网段终端的目的IP地址；S32：判断网段总令牌数是否小于零，若是，IP地址包插入临时队列队尾，同时对应的IP地址发送计数器设置“FAIL”标志；反之，进入步骤S33；S33：判断IP地址的令牌数是否小于零，若小于，IP地址包插入临时队列队尾，同时对应的IP地址发送计数器设置“FAIL”标志；反之，IP地址发送计数器递减，网段发送计算器递减；S34：查询路由表，进而得知具体IP地址包具体经某一LAN口进行发送，以此将IP地址包发送至对应终端设备。更进一步地，作为一优选项，步骤S33中，若IP地址的令牌数小于零，还包括对IP地址令牌进行调整，具体包括：判断第一IP地址的令牌数是否使第一IP地址下终端设备在数据传输时的使用带宽达到可抢占带宽上限，若达到可抢占带宽上限，维持现有令牌，若未达到可抢占带宽上限，增加第一IP地址的令牌数，本次IP地址令牌调整结束。本发明在队列管理方面，从数据进入内核缓冲开始，仅使用linux内核提供的唯一队列“sd-＞process_queue”，出队数据如果因为没有令牌无法发出，则按出队先后顺序，组成链表，在退出内核“process_backlog”函数之前，回插到队列里去，整个流程简单可控。在数据分类识别层面，因各终端设备之间并无优先级区分，因此从WAN-＞LAN的下行数据或者从LAN-＞WAN的上行数据，只需要用终端的IP地址索引到“IP地址发送计数器”和“网段发送计数器”即可，无需用filter将IP地址包纳入不同的class，带宽控制策略流程简单；在队列调度层面，本发明只有一个缓冲数据的队列，数据能否发送只根据当前是否有令牌可用，在linux原有的路由+NAT处理流程基础上，没有队列调度环节的开销，系统处理开销小。综上所述，本发明在Linux原有下行数据DNAT+路由，上行数据路由+SNAT的基础上，只增加了判断IP地址所拥有的令牌是否耗尽，以及在耗尽的情况下重新入队保存的开销，所需系统处理能力消耗小，即能够在不增加系统处理开销的基础上实现有效的弹性带宽调控。以上具体实施方式是对本发明的详细说明，不能认定本发明的具体实施方式只局限于这些说明，对于本发明所属技术领域的普通技术人员来说，在不脱离本发明构思的前提下，还可以做出若干简单推演和替代，都应当视为属于本发明的保护范围。
