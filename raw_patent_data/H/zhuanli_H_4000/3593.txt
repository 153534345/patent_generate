标题title
智能终端设备信息采集时间校正系统及方法
摘要abst
本发明涉及智能终端设备信息采集技术，其公开了一种智能终端设备信息采集时间校正系统及方法，解决现有技术中智能终端设备采集信息时，系统时钟未同步导致的上报信息中包含的时间信息无效的问题。本发明通过在信息采集报文中附加采集时刻、上报时刻之间的系统节拍时间差信息，以及预设上报与接收之间的延迟时间，为上报时刻与接收时刻校验提供时钟信息倒推依据；利用上报时刻时钟信息对采集时刻的时钟信息进行第一次校验；利用接收时刻时钟信息对报文中的时钟信息进行第二次校验，通过双重校验可以做到信息采集时即使系统时钟未获得网络同步，服务器端也可以准确还原出正确的信息采集时间信息。
权利要求书clms
1.智能终端设备信息采集时间校正系统，包括设置于智能终端设备中的信息采集模块和信息上报模块，以及设置于服务器中的信息接收模块和信息处理模块；其特征在于，所述信息采集模块，用于在智能终端设备进行信息采集时，同时获取采集时刻的智能终端设备系统时钟信息和系统节拍信息，并添加至待上报的报文信息中；所述信息上报模块，用于在智能终端设备进行信息上报时，同时获取上报时刻的智能终端设备系统时钟信息与系统节拍信息；利用上报时刻的系统节拍信息与采集时刻的系统节拍信息之差替换报文信息中的采集时刻系统节拍信息；以及，用上报时刻的系统时钟信息校验采集时刻的系统时钟信息，若发现采集时刻的系统时钟信息未同步，则用上报时刻的系统时钟信息替换报文信息中的采集时刻的系统时钟信息；然后将报文信息打包上报到服务器；所述信息接收模块，用于在服务器接收到报文信息时，获取服务器接收时刻的系统时钟信息；用服务器接收时刻的系统时钟信息校验报文信息中的系统时钟信息，若发现报文信息中的系统时钟信息未同步，则用服务器接收时刻的系统时钟信息减去网络传输延迟时间替换报文信息中的时钟信息；所述信息处理模块，用于在对报文信息中的设备状态信息进行分析处理前，使用报文信息中的时钟信息与系统节拍信息计算报文时间戳信息。2.如权利要求1所述的智能终端设备信息采集时间校正系统，其特征在于，所述信息上报模块用上报时刻的系统时钟信息校验采集时刻的系统时钟信息，具体包括：预先设置一个时间阈值Tt；若上报时刻的系统时钟信息与采集时刻的系统时钟信息差值大于时间阈值Tt，则判定采集时刻的系统时钟未同步，否则，判定采集时刻的系统时钟同步。3.如权利要求2所述的智能终端设备信息采集时间校正系统，其特征在于，所述信息接收模块用服务器接收时刻的系统时钟信息校验报文信息中的系统时钟信息，具体包括：若服务器接收时刻的系统时钟信息与报文信息中的系统时钟信息差值大于时间阈值Tt，则判定报文信息中的系统时钟未同步，否则，判定报文信息中的系统时钟同步。4.如权利要求1所述的智能终端设备信息采集时间校正系统，其特征在于，所述网络传输延迟时间依据智能终端设备在系统时钟同步后进行的信息采集、上报所携带的系统时钟信息与服务器接收到此报文信息时的系统时钟信息进行单次计算或多次计算取平均值得到。5.如权利要求1-4任意一项所述的智能终端设备信息采集时间校正系统，其特征在于，所述信息处理模块使用报文信息中的时钟信息与系统节拍信息计算报文时间戳信息，具体包括：若信息采集时刻的系统时钟同步，则报文信息中的时钟信息即为报文时间戳信息；若信息采集时刻的系统时钟未同步，则报文时间戳信息＝报文信息中的时钟信息-报文信息中的系统节拍信息。6.智能终端设备信息采集时间校正方法，其特征在于，包括以下步骤：S1、在智能终端设备进行信息采集时，同时获取采集时刻的智能终端设备系统时钟信息和系统节拍信息，并添加至待上报的报文信息中；S2、在智能终端设备进行信息上报时，同时获取上报时刻的智能终端设备系统时钟信息与系统节拍信息；利用上报时刻的系统节拍信息与采集时刻的系统节拍信息之差替换报文信息中的采集时刻系统节拍信息；以及，用上报时刻的系统时钟信息校验采集时刻的系统时钟信息，若发现采集时刻的系统时钟信息未同步，则用上报时刻的系统时钟信息替换报文信息中的采集时刻的系统时钟信息；然后将报文信息打包上报到服务器；S3、在服务器接收到报文信息时，获取服务器接收时刻的系统时钟信息；用服务器接收时刻的系统时钟信息校验报文信息中的系统时钟信息，若发现报文信息中的系统时钟信息未同步，则采用服务器接收时刻的系统时钟信息减去网络传输延迟时间替换报文信息中的时钟信息；S4、服务器在对报文信息中的设备状态信息进行分析处理前，使用报文信息中的时钟信息与系统节拍信息计算报文时间戳信息。7.如权利要求6所述的智能终端设备信息采集时间校正方法，其特征在于，步骤S2中，所述利用上报时刻的系统时钟信息校验采集时刻的系统时钟信息，具体包括：预先设置一个时间阈值Tt；若上报时刻的系统时钟信息与采集时刻的系统时钟信息差值大于时间阈值Tt，则判定采集时刻的系统时钟未同步，否则，判定采集时刻的系统时钟同步。8.如权利要求7所述的智能终端设备信息采集时间校正方法，其特征在于，步骤S3中，所述信息接收模块用服务器接收时刻的系统时钟信息校验报文信息中的系统时钟信息，具体包括：若服务器接收时刻的系统时钟信息与报文信息中的系统时钟信息差值大于时间阈值Tt，则判定报文信息中的系统时钟未同步，否则，判定报文信息中的系统时钟同步。9.如权利要求6所述的智能终端设备信息采集时间校正方法，其特征在于，步骤S3中，所述网络传输延迟时间依据智能终端设备在系统时钟同步后进行的信息采集、上报所携带的系统时钟信息与服务器接收到此报文信息时的系统时钟信息进行单次计算或多次计算取平均值得到。10.如权利要求6-9任意一项所述的智能终端设备信息采集时间校正方法，其特征在于，步骤S4中，所述使用报文信息中的时钟信息与系统节拍信息计算报文时间戳信息，具体包括：若信息采集时刻的系统时钟同步，则报文信息中的时钟信息即为报文时间戳信息；若信息采集时刻的系统时钟未同步，则报文时间戳信息＝报文信息中的时钟信息-报文信息中的系统节拍信息。
说明书desc
技术领域本发明涉及智能终端设备信息采集技术，具体涉及一种智能终端设备信息采集时间校正系统及方法。背景技术智能终端设备，是指具备操作系统及网络连接功能的电子设备，比如智能电视、智能音箱等，具有进行信息处理、交互响应、软件状态更新等能力。智能终端设备厂商通常通过设备信息采集了解设备使用状态，进而为用户提供差异化、精准化的售后服务。信息采集技术是在智能终端设备中预置信息采集点，在智能终端设备建立网络连接后，将设备信息上报到指定服务器进行分析处理。信息上报动作由事件触发，上报信息中通常包含事件发生时的时间信息及此时的设备状态信息。上报信息中的时间信息通常取自于智能终端设备操作系统的时钟信息。然而，现有技术中，有些智能终端设备关机后系统时钟信息丢失，需要在开机联网后通过网络授时服务同步设备系统时钟。在此类智能终端设备的信息采集过程中，若信息采集时刻发生于设备系统时钟尚未同步时，则对应的上报信息中所包含的时间信息是无效信息。服务器端收到包含了无效时间信息的上报信息，要么丢弃不处理，这样会导致浪费了有效的设备信息；要么用服务器系统时钟替换上报信息中的无效时间信息，这样会导致时间信息不准确，对分析处理结果有不良影响。发明内容本发明所要解决的技术问题是：提出一种智能终端设备信息采集时间校正系统及方法，解决现有技术中智能终端设备采集信息时，系统时钟未同步导致的上报信息中包含的时间信息无效的问题。本发明解决上述技术问题采用的技术方案是：一方面，本发明提供的智能终端设备信息采集时间校正系统，包括设置于智能终端设备中的信息采集模块和信息上报模块，以及设置于服务器中的信息接收模块和信息处理模块；所述信息采集模块，用于在智能终端设备进行信息采集时，同时获取采集时刻的智能终端设备系统时钟信息和系统节拍信息，并添加至待上报的报文信息中；所述信息上报模块，用于在智能终端设备进行信息上报时，同时获取上报时刻的智能终端设备系统时钟信息与系统节拍信息；利用上报时刻的系统节拍信息与采集时刻的系统节拍信息之差替换报文信息中的采集时刻系统节拍信息；以及，用上报时刻的系统时钟信息校验采集时刻的系统时钟信息，若发现采集时刻的系统时钟信息未同步，则用上报时刻的系统时钟信息替换报文信息中的采集时刻的系统时钟信息；然后将报文信息打包上报到服务器；所述信息接收模块，用于在服务器接收到报文信息时，获取服务器接收时刻的系统时钟信息；用服务器接收时刻的系统时钟信息校验报文信息中的系统时钟信息，若发现报文信息中的系统时钟信息未同步，则用服务器接收时刻的系统时钟信息减去网络传输延迟时间替换报文信息中的时钟信息；所述信息处理模块，用于在对报文信息中的设备状态信息进行分析处理前，使用报文信息中的时钟信息与系统节拍信息计算报文时间戳信息。进一步的，所述信息上报模块用上报时刻的系统时钟信息校验采集时刻的系统时钟信息，具体包括：预先设置一个时间阈值Tt；若上报时刻的系统时钟信息与采集时刻的系统时钟信息差值大于时间阈值Tt，则判定采集时刻的系统时钟未同步，否则，判定采集时刻的系统时钟同步。进一步的，所述信息接收模块用服务器接收时刻的系统时钟信息校验报文信息中的系统时钟信息，具体包括：若服务器接收时刻的系统时钟信息与报文信息中的系统时钟信息差值大于时间阈值Tt，则判定报文信息中的系统时钟未同步，否则，判定报文信息中的系统时钟同步。进一步的，所述网络传输延迟时间依据智能终端设备在系统时钟同步后进行的信息采集、上报所携带的系统时钟信息与服务器接收到此报文信息时的系统时钟信息进行单次计算或多次计算取平均值得到。进一步的，所述信息处理模块使用报文信息中的时钟信息与系统节拍信息计算报文时间戳信息，具体包括：若信息采集时刻的系统时钟同步，则报文信息中的时钟信息即为报文时间戳信息；若信息采集时刻的系统时钟未同步，则报文时间戳信息＝报文信息中的时钟信息-报文信息中的系统节拍信息。另一方面，基于上述系统，本发明还提供了一种智能终端设备信息采集时间校正方法，包括以下步骤：S1、在智能终端设备进行信息采集时，同时获取采集时刻的智能终端设备系统时钟信息和系统节拍信息，并添加至待上报的报文信息中；S2、在智能终端设备进行信息上报时，同时获取上报时刻的智能终端设备系统时钟信息与系统节拍信息；利用上报时刻的系统节拍信息与采集时刻的系统节拍信息之差替换报文信息中的采集时刻系统节拍信息；以及，用上报时刻的系统时钟信息校验采集时刻的系统时钟信息，若发现采集时刻的系统时钟信息未同步，则用上报时刻的系统时钟信息替换报文信息中的采集时刻的系统时钟信息；然后将报文信息打包上报到服务器；S3、在服务器接收到报文信息时，获取服务器接收时刻的系统时钟信息；用服务器接收时刻的系统时钟信息校验报文信息中的系统时钟信息，若发现报文信息中的系统时钟信息未同步，则采用服务器接收时刻的系统时钟信息减去网络传输延迟时间替换报文信息中的时钟信息；S4、服务器在对报文信息中的设备状态信息进行分析处理前，使用报文信息中的时钟信息与系统节拍信息计算报文时间戳信息。进一步的，步骤S2中，所述利用上报时刻的系统时钟信息校验采集时刻的系统时钟信息，具体包括：预先设置一个时间阈值Tt；若上报时刻的系统时钟信息与采集时刻的系统时钟信息差值大于时间阈值Tt，则判定采集时刻的系统时钟未同步，否则，判定采集时刻的系统时钟同步。进一步的，步骤S3中，所述信息接收模块用服务器接收时刻的系统时钟信息校验报文信息中的系统时钟信息，具体包括：若服务器接收时刻的系统时钟信息与报文信息中的系统时钟信息差值大于时间阈值Tt，则判定报文信息中的系统时钟未同步，否则，判定报文信息中的系统时钟同步。进一步的，步骤S3中，所述网络传输延迟时间依据智能终端设备在系统时钟同步后进行的信息采集、上报所携带的系统时钟信息与服务器接收到此报文信息时的系统时钟信息进行单次计算或多次计算取平均值得到。进一步的，步骤S4中，所述使用报文信息中的时钟信息与系统节拍信息计算报文时间戳信息，具体包括：若信息采集时刻的系统时钟同步，则报文信息中的时钟信息即为报文时间戳信息；若信息采集时刻的系统时钟未同步，则报文时间戳信息＝报文信息中的时钟信息-报文信息中的系统节拍信息。本发明的有益效果是：本发明综合信息采集、上报时的系统时钟信息及系统节拍信息，通过上报与接收时的双重校验方法，可以做到信息采集时即使系统时钟未获得网络同步，服务器端也可以准确还原出正确的信息采集时间信息。基于上述方案，在服务器端分析采集信息时，可以增加有效样本数量，防止因采集信息时间戳不准确导致的数据污染，本发明对通过信息采集分析智能终端设备系统启动过程中的设备状态尤其有效，比如智能电视开机广告运营情况、开机方式等。附图说明图1为本发明实施例中的智能终端设备信息采集时间校正系统结构框图；图2为本发明实施例中的信息采集报文数据结构示意图；图3为本发明实施例中的智能终端设备信息采集时间校正方法流程图。具体实施方式本发明旨在提出一种智能终端设备信息采集时间校正系统及方法，解决现有技术中智能终端设备采集信息时，系统时钟未同步导致的上报信息中包含的时间信息无效的问题。本发明通过在信息采集报文中附加采集时刻、上报时刻之间的系统节拍时间差信息，以及预设上报与接收之间的延迟时间，为上报时刻与接收时刻校验提供时钟信息倒推依据；利用上报时刻时钟信息对采集时刻的时钟信息进行第一次校验；利用接收时刻时钟信息对报文中的时钟信息进行第二次校验，通过双重校验可以做到信息采集时即使系统时钟未获得网络同步，服务器端也可以准确还原出正确的信息采集时间信息。实施例：本实施例中的智能终端设备信息采集时间校正系统结构如图1所示，包括设置于智能终端设备中的信息采集模块101、信息上报模块102；设置于信息采集服务器中的信息接收模块103和信息处理模块104；信息采集模块101：当预设事件发生时，被触发进行相关信息采集动作并将信息组织成约定格式的报文发送给信息上报模块；在本实施例中，在智能终端设备进行信息采集时，同时获取采集时刻的智能终端设备系统时钟信息和系统节拍信息，并添加至待上报的报文信息中；作为一种具体示例，智能终端设备信息采集报文格式如图2所示。其中，Time信息201指的是基于系统时钟的时间信息；Tick信息202指的是基于系统节拍的时间信息；设备信息203指的是需要采集的设备相关信息。终端信息上报模块102：负责将信息采集模块发送过来的报文打包处理后发送到指定的服务器；本实施例中，在智能终端设备进行信息上报时，同时获取上报时刻的智能终端设备系统时钟信息与系统节拍信息；利用上报时刻的系统节拍信息与采集时刻的系统节拍信息之差替换报文信息中的采集时刻系统节拍信息；以及，用上报时刻的系统时钟信息校验采集时刻的系统时钟信息，若发现采集时刻的系统时钟信息未同步，则用上报时刻的系统时钟信息替换报文信息中的采集时刻的系统时钟信息；然后将报文信息打包上报到服务器；其中，用上报时刻的系统时钟信息校验采集时刻的系统时钟信息可以通过与预设时间阈值的比较来实现，时间阈值为代表某一时间长度的数值信息，通过上报时刻的系统时钟与采集时刻的系统时钟之差与时间阈值的比较久可以判断上报时刻系统时钟与采集时刻系统时钟是否处于同一时间域。若二者之差小于时间阈值，则判定处于同一时间域，则表明采集时刻的系统时钟信息同步，否则，表明采集时刻的系统时钟未同步。服务器信息接收模块103：负责接收终端上报的报文信息进行拆包、预处理后发送给服务器信息处理模块；在本实施例中，当服务器信息接收模块103接收到报文信息时，获取服务器接收时刻的系统时钟信息；用服务器接收时刻的系统时钟信息校验报文信息中的系统时钟信息，若发现报文信息中的系统时钟信息未同步，则采用服务器接收时刻的系统时钟信息减去网络传输延迟时间替换报文信息中的时钟信息；其中，用服务器接收时刻的系统时钟信息校验报文信息中的系统时钟信息同样采用与预设时间阈值的比较来实现。若二者之差小于时间阈值，则判定处于同一时间域，则表明报文中的系统时钟信息同步，否则，表明报文中的系统时钟未同步。另外，这里的网络传输延迟时间指的是智能终端设备上报时刻到服务器接收到报文时刻之间相对于同一基准时钟所经过的时间长度。可以通过在系统时钟同步后进行的信息采集、上报所携带的系统时钟信息与服务器接收到此报文信息时的系统时钟信息进行单次计算或多次计算取平均值得到。服务器信息处理模块104：负责处理报文信息。本实施例中，服务器信息处理模块104在对报文信息中的设备状态信息进行分析处理前，使用报文信息中的时钟信息与系统节拍信息计算报文时间戳信息。具体而言，若信息采集时刻的系统时钟同步，则报文信息中的时钟信息即为报文时间戳信息；若信息采集时刻的系统时钟未同步，则报文时间戳信息＝报文信息中的时钟信息-报文信息中的系统节拍信息。基于上述系统，本实施例在实现信息采集时间校正时，首先预先设置一个时间阈值Tt，用于判断两个系统时钟是否处于同一时间域。并预先设置一个网络传输延迟时间Td，用于从服务器接收时刻系统时钟信息推算智能终端设备上报时刻系统时钟信息。Td可以依据智能终端设备在系统时钟同步后进行的信息采集、上报所携带的系统时钟信息与服务器接收到此报文信息时的系统时钟信息进行单次计算或多次计算取平均值得到。信息采集时间校正流程如图3所示：在终端信息采集模块101进行信息采集时，由终端信息采集模块101获取当前设备系统时钟信息Time1及当前设备主CPU节拍数所对应的时长信息Tick1，并将Time1添加到Time信息201中，Tick1添加到Tick信息202中，形成报文信息301；则报文信息301就包含了设备信息、Time1信息和Tick1信息。在终端信息上报模块102进行信息上报时，由终端信息上报模块102获取当前设备系统时钟信息Time2及当前设备主CPU节拍数所对应的时长信息Tick2；若Time2-Time1＞Tt，则将报文中的Time信息201替换成Time2；再将报文中的Tick信息202替换成Tick2-Tick1；形成报文信息302；若Time2-Time1≤Tt，则保持报文中的Time信息201不变，仅将报文中的Tick信息202替换成Tick2-Tick1，形成报文303；最后对报文进行打包处理后发送到指定的服务器。在服务器信息接收模块103进行信息接收时，由服务器信息接收模块103获取当前服务器系统时钟信息Time3；若Time3与报文中的Time信息之差大于Tt，则用Time3-Td替换报文信息中的Time信息；形成报文信息305；若Time3与报文中的Time信息之差小于等于Tt，则保持报文中的信息不变，从而形成报文304或报文306。最后，服务器信息处理模块104计算报文时间戳信息：若Time1为同步时钟信息，则报文时间戳为Time1，如图3中的309；若Time1未同步，Time2为同步信息，则报文时间戳为Time2-，如图3中的307；若Time1未同步，Time2未同步，则报文时间戳为Time3-Td-，如图3中的308。最后应当说明的是，上述实施例仅是优选实施方式，并不用以限制本发明。应当指出，对于本技术领域的普通技术人员来说，在不脱离本发明宗旨和权利要求所保护的范围情况下，还可以做出若干修改，等同替换、改进等，均应包含在本发明的保护范围之内。
