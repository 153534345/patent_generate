标题title
一种LIN总线系统及其从机自动寻址的方法
摘要abst
本发明公开了一种LIN总线系统及其从机自动寻址的方法，其中总线系统，包括：控制主机、BUS总线和从机；所述BUS总线一端连接到该控制主机，且另一端分别连接多个可寻址的从机；所述主机设有串联连接的电阻RM、二极管VD1、二极管VD2和控制开关SD；所述从机中包括多个可寻址的从机，且每个从机均设有：控制开关S1、控制开关S2、上拉电阻RS、电流源IS、二极管VD3、二极管VD4、二极管VD5、下拉开关St、检测电阻Rshunt、差分放大器AMP和ADC；本发明采用阶梯增加从机上拉电流源的方式，在检测电阻Rshunt小于0.2Ω时仍能稳定寻址。
权利要求书clms
1.一种LIN总线系统，包括：主机、BUS总线和从机；所述BUS总线一端连接到所述主机，且另一端分别连接多个可寻址的从机；其特征在于：采用阶梯增加从机上拉电流源的方式，在检测电阻Rshunt小于0.2Ω时仍能稳定寻址；且，所述主机设有串联连接的电阻RM、二极管VD1、二极管VD2和控制开关SD；所述从机中包括多个可寻址的从机，且每个从机均设有：控制开关S1、控制开关S2、上拉电阻RS、电流源IS、二极管VD3、二极管VD4、二极管VD5、下拉开关St、检测电阻Rshunt、差分放大器AMP和ADC；所述控制开关S1、上拉电阻RS、二极管VD3、二极管VD5、下拉开关串联连接形成第一条支路，所述控制开关S2、电流源IS、二极管VD4串联连接形成第二条支路,且所述第一条支路与第二条支路并联连接；所述主机中的二极管VD1与二极管VD2之间具有一耦接点A，所述BUS总线耦接主机中的耦接点A，所述从机中的二极管VD3与二极管VD4之间具有一耦接点B，所述BUS总线耦接从机中的耦接点B，且所述从机中的二极管VD4耦接到BUS总线上，且将耦接处作为耦接点C；所述BUS总线还串联连接检测电阻Rshunt，且所述检测电阻Rshunt的两端分别具有耦接点D、E，所述耦接点D和耦接点E分别作为负向输入端和正向输入端耦接差分放大器AMP。2.根据权利要求1所述的LIN总线系统，其特征在于：所述控制开关S1为默认闭合状态，上拉电阻RS通过BUS总线被上拉，在自动寻址时断开控制开关S1。3.根据权利要求1所述的LIN总线系统，其特征在于：所述检测电阻Rshunt阻值小于等于0.2Ω。4.根据权利要求1所述的LIN总线系统，其特征在于：所述差分放大器AMP的输出端耦接ADC，所述差分放大器AMP对Rshunt上流过电流产生的压降放大后送到ADC读取Rshunt上的电流。5.根据权利要求1所述的LIN总线系统，其特征在于：所述LIN总线系统采用菊花链连接方式，且使用总线分流的总线体系结构。6.根据权利要求1所述的LIN总线系统，其特征在于：每个从机中所述检测电阻Rshunt上的电流取决于在总线上的位置。7.根据权利要求1所述的LIN总线系统，其特征在于：所述LIN总线系统在流入主机电流不超过20mA时，通过阶梯方式增加从机上拉电流源的方式，增加菊花链上从机的数量。8.一种LIN总线系统的从机自动寻址的方法，其特征在于，具体步骤包括：步骤1：主机发送自动寻址命令，从机接收到自动寻址中断字节，开始寻址，对没有自动寻址功能的从机，保持状态不变；步骤2：已经分配地址的从机等待寻址命令，结束恢复默认状态；没有分配地址的从机通过差分放大器AMP放大Rshunt上的电压，送到ADC，换算出Rshunt的偏移电流，标记为I0；步骤3；通过阶梯增加从机上拉电流源方式进行配置，所有从机额外配置电流源I1,测量Rshunt上的实测电流记为I1，计算差值IDIFF1=I1-I0；如果差值IDIFF1大于设定的阈值，关闭电流源IS，等待寻址命令结束再恢复默认状态；如果差值IDIFF1小于等于设定的阈值，增加电流源IS值到I2，测量Rshunt上的实测电流记为I2，计算差值IDIFF2=I2-I0；如果差值IDIFF2大于设定的阈值，关闭电流源IS，等待寻址命令结束再恢复默认状态；如果差值IDIFF2小于等于设定的阈值，继续阶梯增加电流源IS值到I3，如此循环，直到最大电流In，计算差值IDIFFn=In-I0；步骤4：电流源IS增大到最大电流后，若差值IDIFFn大于设定的阈值，关闭电流源IS，等待寻址命令结束恢复默认状态；若差值IDIFFn小于等于设定的阈值，则认定为所有没有分配地址的从机中距离主机最远的从机，判断结果存储其RAM中，主机对其分配地址；步骤5：检测是否所有从机已经分配地址。9.根据权利要求8所述的一种LIN总线系统的从机自动寻址的方法，其特征在于：步骤1开始自动寻址后，所有从机关闭上拉电阻和电流源，从机判断是否已经分配地址。10.根据权利要求8所述的一种LIN总线系统的从机自动寻址的方法，其特征在于：步骤4之后先关闭所有电流源，打开从机上拉电阻RS，再进行步骤5。
说明书desc
技术领域本发明涉及一种LIN总线技术领域，具体为一种LIN总线系统及其从机自动寻址的方法。背景技术在汽车电子设备中为了最小化线路的复杂性，通常通过总线传输驱动电子设置的控制信号，除了控制主机外，每个从机的驱动器单元是相互连接的，组成总线的控制系统，例如车输空调的制动装置、车窗升降装置、车辆氛围灯等。LIN是一种低成本的串行通迅网络，用于实现汽车中的分布式电子系统控制。LIN的目标是为现有的汽车网络提供辅助功能，所以LIN总线是一种辅助的总线网络，在不需要CAN总线的宽带和多功能的场合，如汽车氛围灯之间的通迅使用LIN总线可大大节省成本。LIN总线系统的连接如图1所示，采用菊花链的连接方法，n最大为15。为了让控制主机有选择性的驱动一个或多个从机，首先需要对从机进行地址分配，现有技术已有各种不同的用于LIN总线系统中的自动寻址方法：参考图2，在专利EP2717547B1中所述，从机使用两个不同电流源对在不同时间点灌电流，测量流过内部电阻的电流，与一固定的阈值电流比较，当电流值小于设定阈值时，确定为离主机最远的节点，然后分配地址；专利US7091876B2还描述了总线系统的第二实施例，与图2中所示的总线系统设置相同，其中寻址过程比较在总线上流动的电流不超过预定的最大值。关于LIN总线的现有技术都是基于Rshunt电阻1Ω时提出的，由于主机下拉开关闭合时，对外面最大驱动电流为20mA，所以限制了通过Rshunt电阻的电流。现有技术的从机分配地址方法，首先将全部从机上拉1mA电流，通过与阈值电流2mA比较，预选出1~3个从机，然后在预选出的从机上拉3.5mA电流，再次通过与阈值电流比较，最后判断离主机最远端的从机分配地址，但是每个从机上1Ω的Rshunt电阻给最远端的从机带来巨大延时，比如有15个从机，就带来了15Ω电阻，波形失真严重，甚至使通迅错误；如果想解决上述问题，就必然要降低菊花链上的电阻，比如Rshunt降到0.2Ω，如果仍采用已有LIN总线的现有技术判断阈值为2mA时，电阻上的差分电压只有0.4mV,如此小的差分电压就会被运放的噪声淹没，使自动寻址状态不稳定，甚至出错。现有技术已经不能满足现阶段人们的需求，基于现状，急需对现有技术进行改革。发明内容本发明的目的在于提供一种LIN总线系统及其从机自动寻址的方法，以解决上述背景技术中提出的问题。一方面，本发明提供如下技术方案一种LIN总线系统，包括：控制主机、BUS总线和从机；所述BUS总线一端连接到该控制主机，且另一端分别连接多个可寻址的从机；所述主机设有串联连接的电阻RM、二极管VD1、二极管VD2和控制开关SD；所述从机中包括多个可寻址的从机，且每个从机均设有：控制开关S1、控制开关S2、上拉电阻RS、电流源IS、二极管VD3、二极管VD4、二极管VD5、下拉开关St、检测电阻Rshunt、差分放大器AMP和ADC；作为优选项，所述控制开关S1、上拉电阻RS、二极管VD3、二极管VD5、下拉开关串联连接形成第一条支路，所述控制开关S2、电流源IS、二极管VD4串联连接形成第二条支路,且所述第一条支路与第二条支路并联连接；作为优选项，所述主机中的二极管VD1与二极管VD2之间具有一耦接点A，所述BUS总线耦接主机中的耦接点A，所述从机中的二极管VD3与二极管VD4之间具有一耦接点B，所述BUS总线耦接从机中的耦接点B，且所述从机中的二极管VD4耦接到BUS总线上，且将耦接处作为耦接点C；作为优选项，所述BUS总线还串联连接检测电阻Rshunt，且所述检测电阻Rshunt的两端分别具有耦接点D、E，所述耦接点D和耦接点E分别作为负向输入端和正向输入端耦接差分放大器AMP，且所述差分放大器AMP的输出端耦接ADC。另一方面，本发明还提供如下技术方案一种LIN总线系统的从机自动寻址的方法，具体步骤包括：步骤1：主机发送自动寻址命令，从机接收到自动寻址中断字节，开始寻址，对没有自动寻址功能的从机，保持状态不变；步骤2：如果已经分配地址等待寻址命令结束恢复默认状态。否则通过差分放大器AMP放大Rshunt上的电压，送到ADC，换算出Rshunt的偏移电流，标记为I0；步骤3：阶梯增加从机上拉电流源方式开始配置；步骤4：电流源IS增大到最大电流后，差值IDIFFn大于设定的阈值，关闭电流源IS，等待寻址命令结束恢复默认状态；步骤5：检测是否所有从机已经分配地址。本发明具有如下有益效果：本发明提出了一种采用阶梯增加从机上拉电流源的方式，解决Rshunt阻值较小时自动寻址不稳定的问题；从机上拉电流源分时开启，每步自动判断，每次判断后未被选中的芯片关闭上拉电流，避免超过主机驱动能力电流；Rshunt电阻较小时，待分配地址的从机的电流源采用阶梯变化的方式，最大可增大到主机驱动的最大电流，使Rshunt压差足够大，通过差分放大器后送到ADC读取电流，自动寻址更加稳定可靠。附图说明图1为 LIN总线系统典型架构示意图；图2为LIN总线从机自动寻址电路的现有技术的电路结构示意图；图3为本发明LIN总线系统电路结构示意图；图4为本发明自动寻址时的时序图；图5为本发明自动寻址时的状态图；图6为本发明自动寻址时电流源变化示意图。具体实施方式下面将结合本发明实施例中的附图，对本发明实施例中的技术方案进行清楚、完整地描述，显然，所描述的实施例仅仅是本发明一部分实施例，而不是全部的实施例。基于本发明中的领域普通技术人员在没有做出创造性劳动前提下所获得的所有其他实施例，都属于本发明保护的范围。参考图3，一方面，在较佳的实施例中，本发明提供如下LIN总线系统的实施例，LIN总线系统包括：控制主机、BUS总线和从机。所述BUS总线一端连接到该控制主机，且另一端分别连接多个可寻址的从机。主机中用于自动寻址的电路设有串联连接的电阻RM、二极管VD1、二极管VD2和控制开关SD。从机中用于自动寻址的电路包括多个可寻址的从机，且每个从机均设有：控制开关S1、控制开关S2、上拉电阻RS、电流源IS、二极管VD3、二极管VD4、二极管VD5、下拉开关St、检测电阻Rshunt、差分放大器AMP和ADC；在实施例中，所述控制开关S1、上拉电阻RS、二极管VD3、二极管VD5、下拉开关串联连接形成第一条支路，所述控制开关S2、电流源IS、二极管VD4串联连接形成第二条支路,且所述第一条支路与第二条支路并联连接，其中，控制开关S1为默认闭合状态，BUS总线通过电阻RS被上拉，在自动寻址时断开控制开关S1。在实施例中，所述主机中的二极管VD1与二极管VD2之间具有一耦接点A，所述BUS总线耦接主机中的耦接点A，所述从机中的二极管VD3与二极管VD4之间具有一耦接点B，所述BUS总线耦接从机中的耦接点B，且所述从机中的二极管VD4耦接到BUS总线上，且将耦接处作为耦接点C，所述BUS总线还串联连接检测电阻Rshunt，且Rshunt阻值小于等于0.2Ω，且所述检测电阻Rshunt的两端分别具有耦接点D、E，所述耦接点D和耦接点E分别作为负向输入端和正向输入端耦接差分放大器AMP，且所述差分放大器AMP的输出端耦接ADC，差分放大器AMP对Rshunt上流过电流产生的压降放大后送到ADC读取Rshunt上的电流。在实施例中，LIN总线系统采用菊花链连接、使用总线分流方法的总线体系结构，在寻址过程中，从机打开电流源，电流会都流向主机，所以每个从机检测电阻Rshunt上的电流取决于在总线上的位置。另外，LIN总线自动寻址的技术都是基于Rshunt电阻1Ω时提出的，由于主机下拉开关闭合时，对外面最大驱动电流为20mA，所以限制了通过Rshunt电阻的电流。在实施例中，本发明的LIN总线系统采用阶梯增加从机上拉电流源的方式，可以在Rshunt电阻小于0.2Ω时仍能稳定寻址，为了降低成本，增加菊花链上从机的数量，在保证对主机电流不超过20mA的前提下，通过阶梯方式增加从机上拉电流源，在选址中最后稳定选出菊花链最远端的从机，其中判断的阈值电流可以为比较大的电流，比如判断阈值为10mA,Rshunt电阻为0.2Ω时，电阻上的差分电压为2mV，对差分运放的设计无需提高要求，就能得到稳定的判断结果，提高寻址的稳定性。另一方面，在较佳的实施例中，本发明提供如下LIN总线系统的从机自动寻址的方法的实施例。参考图4和图5，自动寻址的方法的具体步骤包括：步骤1：主机发送自动寻址命令，从机接收到自动寻址中断字节，开始寻址，对没有自动寻址功能的从机，保持状态不变；开始自动寻址后，所有从机关闭上拉电阻和电流源，从机判断是否已经分配地址。步骤2：如果已经分配地址等待寻址命令结束恢复默认状态；否则通过差分放大器AMP放大Rshunt上的电压，送到ADC，换算出Rshunt的偏移电流，标记为I0。步骤3：通过阶梯增加从机上拉电流源方式进行配置；首先所有从机配置电流源I1,测量Rshunt上的实测电流记为I1，计算差值IDIFF1=I1-I0，如果差值IDIFF1大于设定的阈值，关闭电流源IS，等待寻址命令结束再恢复默认状态；如果差值IDIFF1小于等于设定的阈值，增加电流源IS到I2，测量Rshunt上的实测电流记为I2，计算差值IDIFF2=I2-I0；如果差值IDIFF2大于设定的阈值，关闭电流源IS，等待寻址命令结束再恢复默认状态；如果差值IDIFF2小于等于设定的阈值，继续阶梯增加电流源IS到I3，如此循环，直到最大电流In，计算差值IDIFFn=In-I0。步骤4：电流源IS增大到最大电流后，若差值IDIFFn大于设定的阈值，关闭电流源IS，等待寻址命令结束恢复默认状态；若差值IDIFFn小于等于设定的阈值，则认定为所有没有分配地址的从机中距离主机最远的从机，判断结果存储其RAM中，主机对其分配地址；最后恢复默认状态，关闭所有电流源，打开从机上拉电阻RS。步骤5：检测是否所有从机已经分配地址。在实施例中，LIN联盟发布的LIN Bus Shunt Slave Node Position DetectionRevision 1.0规定主机驱动从机灌入的最大电流为20mA，根据上述自动寻址的方法的具体步骤，本发明提供如下一可选实施例，举例说明上述自动寻址的方法。作为本发明的可选实施例，以上拉电流源IS每步变化0.5mA，最大电流16mA，设定的比较阈值电流10mA，待分配地址的从机数量n为15个为例，各从机在不同时间点时Rshunt上的电流可由下表给出：在可选实施例中，在时间t0时测量偏移电流I0，在时间t1时所有从机的电流源加0.5mA，所有从机上电流都不超过10mA，所以在时间t2时所有从机电流源仍开启，在时间t2时刻从机电流源变为1mA，且从机4~从机1电流超过10mA，在时间t3时从机4~从机1电流源关闭，在时间t3时刻电流源变为1.5mA，从机8~从机1电流超过10mA，在下一时刻关闭电流源，在时间t4时刻电流源变为2mA, 从机9~从机1电流超过10mA，在下一时刻关闭电流源，如此继续增大未选中从机的电流源，在时间tn时刻电流源变为16mA，从机14~从机1电流超过10mA，最后仅剩从机15没有被选中，认定为没有分配地址的从机中离主机最远的从机，然后对从机15分配地址;如此反复，直到所有从机都分配地址，自动寻址结束。参考图6，在可选实施例中，在实际应用时需要考虑不同芯片间的时钟误差，图6说明不同芯片间调整电流源变化的时间误差，在计算不同步骤的时间时，必须考虑一定的时钟余量，图中电流源的变化是未被选中的从机电流的变化波形，在时间tn时间后从机供电到最大电流In，没有分配地址的从机中距离主机最远的从机电流一直保持为0。尽管参照前述实施例对本发明进行了详细的说明，对于本领域的技术人员来说，其依然可以对前述各实施例所记载的技术方案进行修改，或者对其中部分技术特征进行等同替换,凡在本发明的精神和原则之内，所作的任何修改、等同替换、改进等，均应包含在本发明的保护范围之内。
