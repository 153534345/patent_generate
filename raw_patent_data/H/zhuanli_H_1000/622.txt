标题title
一种定日镜控制器基于Autbus通讯方式的控制方法
摘要abst
本发明提出了一种定日镜控制器基于Autbus通讯方式的控制方法，涉及定日镜通讯控制技术领域，启动定日镜控制器的控制系统，由群控制器实时处理定日镜控制器发送的数据,群控制器将所有数据发送至中央通讯处理器；中央通讯处理器获取数据到达群控制器和主定日镜控制器的时钟节点，为每项时钟节点标记时间标记，计算时钟漂移，并发送至群控制器；群控制器根据时钟漂移对主定日镜控制器进行时间校正，将时间校正后的主定日镜控制器控制的定日镜调整至稳态位置；经过一轮校正周期后，重新选定主定日镜控制器并进行状态切换。
权利要求书clms
1.一种定日镜控制器基于Autbus通讯方式的控制方法，其特征在于，包括如下步骤：S1：启动定日镜控制器的控制系统，由群控制器实时处理定日镜控制器发送的数据,群控制器将所有数据发送至中央通讯处理器；S2：中央通讯处理器获取数据到达群控制器和主定日镜控制器的时钟节点，为每项时钟节点标记时间标记，计算时钟漂移，并发送至群控制器；S3：群控制器根据时钟漂移对主定日镜控制器进行时间校正，将时间校正后的主定日镜控制器控制的定日镜调整至稳态位置；S4：经过一轮校正周期后，重新选定主定日镜控制器并进行状态切换。2.根据权利要求1中所述的控制方法，其特征在于，步骤S2中，设数据到达群控制器时钟节点的时间标记为T1,到达主定日镜控制器时钟节点的时间标记为T2,数据回环时再次经过群控制器和主定日镜控制器的时间标记分别为T3和T4，数据由群控制器发送至主定日镜控制器时钟之间的平均传播延时Tmd1为：Tmd1=1/2)。3.根据权利要求2中所述的控制方法，其特征在于，时钟漂移的计算公式为：；式中，Tml为群控制器的本地时间，tref为系统参考时间，Tmo为群控制器的本地时间与系统参考时间的初始偏差，Tmd为数据再次返回群控制器的时间延时。4.根据权利要求1中所述的控制方法，其特征在于，步骤S3中，获取时间校正后的主定日镜控制器控制的定日镜的初始角度，正向转动t1后，记录第一脉冲数N1、第一角度/＞，再反向转动t2时间后，记录第二脉冲数N2、第二角度/＞，计算出转动系数P1和P2；；。5.根据权利要求4中所述的控制方法，其特征在于，对定日镜在k时刻的实际位置H的时变轨迹进行非线性处理，如下式：HS＝Hexp+H)；其中，HS为定日镜的稳态位置，H为定日镜在k时刻的实际位置，H为定日镜在k-1时刻的实际位置，TS为采样时间，T为时间常数。6.根据权利要求1中所述的控制方法，其特征在于，步骤S4中，群控制器通过Autbus总线向多个定日镜控制器发送主状态选定及切换命令,各个定日镜控制器首先检查自身状态是否满足要求,若满足,则进行主状态切换并将新的状态写入状态寄存器，若不满足,则将设置不满足指示。7.根据权利要求6中所述的控制方法，其特征在于，主状态选定及切换过程中，状态转换函数首先定义状态请求代码和当前状态代码，当前状态代码的值不为零时,将状态请求代码的值赋给不满足指示；当前状态代码的值为零时,读取状态命令进行主状态转换。8.根据权利要求1中所述的控制方法，其特征在于，步骤S2中，当通讯发生暂停时，控制系统检测暂停信号，当Autbus暂停信号暂停到来后，控制系统获取Autbus信号暂停的时刻Tt；而后等待定日镜控制器执行暂停，在定日镜控制器执行暂停时，控制系统获取定日镜控制器执行暂停的时刻Tp；获取到两个时刻Tt和Tp后，计算Autbus信号暂停与定日镜控制器执行暂停的时间间隔Tot为：Tot=Tp-Tt；将Tot与偏置阈值Tct比较，若始终保持下述判断关系式，则控制系统不停止通讯过程，定日镜控制器以暂停信号作为同步事件来更新数据，反之控制系统停止通讯过程；判断关系式为：Tct-d＜Tot＜Tct+d，其中，偏置阈值Tct代表期望设置的Autbus信号暂停与定日镜控制器执行暂停之间的间隔时间；d为暂停容差。
说明书desc
技术领域本发明涉及定日镜通讯控制技术领域，具体涉及一种定日镜控制器基于Autbus通讯方式的控制方法。背景技术定日镜控制器是一种应用在光热发电领域的双轴运动控制器。可以控制镜场的定日镜将太阳光线反射至吸热器。控制器内部集成时间模块和运算模块，可以根据当前的时间与当地的地理坐标计算出太阳的位置，并根据太阳位置、镜场中定日镜与吸热器的相对坐标计算出定日镜的理论旋转目标角，使定日镜能将太阳光反射至吸热吸热器。一个光热发电镜场有上千面定日镜，控制策略由上位机来控制若干台控制定日镜。定日镜控制器需要与镜场的上位机建立通讯链接，响应上位机的控制指令，根据上位机下发的指令来控制定日镜运动，并且将当前定日镜的状态信息上传至上位机。传统的定日镜控制器与上位机的通讯是基于RS485总线连接或者基于以太网接口连接。但以上连接方式都有一定的弊端。RS485总线连接受限于通讯速度与通讯距离，不能应用在中型、大型镜场。以太网接口连接方式速度可以满足要求，但是需要额外增加网络交换机成本。Autbus总线是是一种采用两线非桥接媒介，具有多节点、高带宽、高实时，可远距离传输的工业现场总线。总线数据带宽可达到100Mbps。一个Autbus总线系统可支持254个有效节点。AUTBUS 协议栈架构包括物理层、数据链路层和应用层三部分。物理层向数据链路层提供了时钟管理服务、数据传输服务和物理层管理服务三大类接口。应用层可提供数据传输服务，并且其中的时间服务模块可以同时钟同步、时钟查询功能。一个Autbus网络由1个CN和若干个TN组成。由CN节点控制整个网络的通讯。每个TN在网络中有唯一识别号，CN通过唯一识别号与TN进行通讯。发明内容为了解决上述技术问题，本发明提出了一种定日镜控制器基于Autbus通讯方式的控制方法，包括如下步骤：S1：启动定日镜控制器的控制系统，由群控制器实时处理定日镜控制器发送的数据,群控制器将所有数据发送至中央通讯处理器；S2：中央通讯处理器获取数据到达群控制器和主定日镜控制器的时钟节点，为每项时钟节点标记时间标记，计算时钟漂移，并发送至群控制器；S3：群控制器根据时钟漂移对主定日镜控制器进行时间校正，将时间校正后的主定日镜控制器控制的定日镜调整至稳态位置；S4：经过一轮校正周期后，重新选定主定日镜控制器并进行状态切换。进一步地，步骤S2中，设数据到达群控制器时钟节点的时间标记为T1,到达主定日镜控制器时钟节点的时间标记为T2,数据回环时再次经过群控制器和主定日镜控制器的时间标记分别为T3和T4，数据由群控制器发送至主定日镜控制器时钟之间的平均传播延时Tmd1为：Tmd1=1/2)。进一步地，时钟漂移的计算公式为：；式中，Tml为群控制器的本地时间，tref为系统参考时间，Tmo为群控制器的本地时间与系统参考时间的初始偏差，Tmd为数据再次返回群控制器的时间延时。进一步地，步骤S3中，获取时间校正后的主定日镜控制器控制的定日镜的初始角度，正向转动t1后，记录第一脉冲数N1、第一角度/＞，再反向转动t2时间后，记录第二脉冲数N2、第二角度/＞，计算出转动系数P1和P2；；。进一步地，对定日镜在k时刻的实际位置H的时变轨迹进行非线性处理，如下式：HS＝Hexp+H)；其中，HS为定日镜的稳态位置，H为定日镜在k时刻的实际位置，H为定日镜在k-1时刻的实际位置，TS为采样时间，T为时间常数。进一步地，步骤S4中，群控制器通过Autbus总线向多个定日镜控制器发送主状态选定及切换命令,各个定日镜控制器首先检查自身状态是否满足要求,若满足,则进行主状态切换并将新的状态写入状态寄存器，若不满足,则将设置不满足指示。进一步地，主状态选定及切换过程中，状态转换函数首先定义状态请求代码和当前状态代码，当前状态代码的值不为零时,将状态请求代码的值赋给不满足指示；当前状态代码的值为零时,读取状态命令进行主状态转换。进一步地，步骤S2中，当通讯发生暂停时，控制系统检测暂停信号，当Autbus暂停信号暂停到来后，控制系统获取Autbus信号暂停的时刻Tt；而后等待定日镜控制器执行暂停，在定日镜控制器执行暂停时，控制系统获取定日镜控制器执行暂停的时刻Tp；获取到两个时刻Tt和Tp后，计算Autbus信号暂停与定日镜控制器执行暂停的时间间隔Tot为：Tot=Tp-Tt；将Tot与偏置阈值Tct比较，若始终保持下述判断关系式，则控制系统不停止通讯过程，定日镜控制器以暂停信号作为同步事件来更新数据，反之控制系统停止通讯过程；判断关系式为：Tct-d＜Tot＜Tct+d，其中，偏置阈值Tct代表期望设置的Autbus信号暂停与定日镜控制器执行暂停之间的间隔时间；d为暂停容差。相比于现有技术，本发明具有如下有益技术效果：启动定日镜控制器的控制系统，由群控制器实时处理定日镜控制器发送的数据,群控制器将所有数据发送至中央通讯处理器；中央通讯处理器获取数据到达群控制器和主定日镜控制器的时钟节点，为每项时钟节点标记时间标记，计算时钟漂移，并发送至群控制器；群控制器根据时钟漂移对主定日镜控制器进行时间校正，将时间校正后的主定日镜控制器控制的定日镜调整至稳态位置；经过一轮校正周期后，重新选定主定日镜控制器并进行状态切换。本发明结合Autbus总线的特点，控制器与上位机的通讯采用Autbus总线进行通讯，有很高的通讯速度、能应用在大规模的光热发电镜场、能有效降低组网成本。在实现定日镜控制器功能的同时，利用Autbus总线在高速工业总线通讯方面的优势，提高了控制系统的可靠性，提高了上位机与控制器之间的数据交互效率，降低了运营成本。附图说明为了更清楚地说明本发明实施例中的技术方案，下面将对实施例描述中所需要使用的附图作简单地介绍，显而易见地，下面描述中的附图仅仅是本发明的一些实施例，对于本领域普通技术人员来讲，在不付出创造性劳动性的前提下，还可以根据这些附图获得其他的附图。图1为本发明的定日镜控制系统的结构示意图；图2为本发明的Autbus总通讯协议的层级示意图；图3为本发明的定日镜控制器基于Autbus通讯方式的控制方法的流程示意图；图4为本发明的一个校正周期示意图；图5为本发明的定日镜控制器端口结构示意图。具体实施方式为使本申请实施例的目的、技术方案和优点更加清楚，下面将结合本申请实施例中的附图，对本申请实施例中的技术方案进行清楚、完整地描述，显然，所描述的实施例是本申请一部分实施例，而不是全部的实施例。基于本申请中的实施例，本领域普通技术人员在没有做出创造性劳动前提下所获得的所有其他实施例，都属于本申请保护的范围。在本发明的具体实施例附图中，为了更好、更清楚的描述系统中的各元件的工作原理，表现所述装置中各部分的连接关系，只是明显区分了各元件之间的相对位置关系，并不能构成对元件或结构内的信号传输方向、连接顺序及各部分结构大小、尺寸、形状的限定。如图1所示，为定日镜控制系统的结构示意图，定日镜控制系统具有三层结构，最上层为中央通讯处理器，中层为群控制器，下层为定日镜控制器。中央通讯处理器和群控制器之间采用以太网环网方式通讯；群控制器到定日镜控制器之间使用Autbus总线通信。Autbus总通讯协议的层级如图2所示，由三层组成。物理层为Autbus物理层构成。数据链路层包括Autbus LLC子层与 Autbus Mac子层构成。应用层可采用Autbus-PA协议，也可采用TCP/IP协议。通过Autbus LLC子层的的时间服务模块可以同时钟同步、时钟查询功能。该时钟信息可提供给中央通讯处理器，用于计算太阳位置。每个定日镜控制器在出厂前可设置唯一识别标识，控制节点通过Autbus总线可读取该唯一识别标识，并且根据该唯一识别标识与定日镜坐标的关联表格，设置定日镜的初始化参数，便于镜场管理。Autbus总线有在线升级的软件接口，可实现上位机对定日镜控制器进行批量的软件在线升级。定日镜控制器包括：电源模块、电源监测模块、运算与控制模块、驱动模块、传感器接收模块、数据保护模块和Autbus总线通讯模块。电源模块：包括电压调节电路、电源稳压电路、电能存储器件。电压调节电路可将输入电压调整为不同电压等级的若干输出分支，以提供给不同电压需求的功能模块。电源稳压电路有电源滤波的功能，保证各个模块的电源质量。电能存储器件可在总电源停止供电时短时间维持供电，为数据保护模块提供电源。电源监测模块：包括电压采样电路与电压比较电路。其中电压采样电路采集电源电压。电压比较电路将电源电压与参考电压作比较，低于参考阈值时发出报警信号。运算与控制模块：该模块在电路的处理器软件中实现。驱动模块：包括两路电机驱动电路，分别驱动方位轴电机与俯仰轴电机运动。传感器接收模块：包括两路传感器接收电路，分别接受方位轴与俯仰轴的角度信号与位置信号。数据保护模块：该模块在电路的处理器软件中实现。当该模块接收到电源监测模块的报警信号后，及时将状态数据存储至控制器的ROM中。并在电源上电后，从ROM中读取存储的状态数据，并检测数据的有效性。Autbus总线通讯模块：控制器使用东土公司Autbus总线功能的专用Soc,型号为KY3001，通讯功能由该Soc实现。如图3所示，为本发明的定日镜控制器基于Autbus通讯方式的控制方法的流程示意图，该控制方法包括如下步骤：S1：启动定日镜控制器的控制系统，由群控制器实时处理定日镜控制器发送的数据,群控制器将所有数据发送至中央通讯处理器。群控制器和定日镜控制器之间使用Autbus总线连接，群控制器作为控制节点，定日镜控制器作为网络终端。控制节点与各网络终端之间建立起Autbus通信连接。中心基站需要装有带有RJ45接口的网卡，并安装相关驱动；分布站点需要使用专用数据链路层芯片及微处理芯片，实现信息的接收、发送及状态检测等工作。网络终端的物理层与链路层使用专用的两线制通讯控制芯片，两线制通讯控制芯片主要完成Autbus网络数据的收发。应用层采用Modbus-tcp基本通信协议，在Keil上使用C编写，在KY3001通讯处理芯片上运行。系统运行时， KY3001通讯处理芯片通过Autbus总线读取全局时间，根据该时间与当地地理位置信息，带入太阳角度计算算法，计算出太阳位置角度，进而计算出使定日镜能够将太阳光反射至目标点的理论法线角度。同时，KY3001通过计时器捕捉接口接受来自定日镜位置传感器信号并解析为角度数据，然后将该角度数据与理论角度对比，控制电机运动到理论角度。并将当前的跟踪状态，通过Autbus总线反馈至群控制器。携带过程数据的Autbus通讯报文遍历完所有定日镜控制器后返回群控制器，群控制器将所有报文转换成以太网通讯报文，上传给中央通讯处理器，由中央通讯处理器处理。中央通讯处理器将对通信部分进行处理。同时，中央通讯处理器将会根据控制策略实现对跟踪定日镜的控制。S2：中央通讯处理器获取数据到达群控制器和主定日镜控制器的时钟节点，为每项时钟节点标记时间标记，计算时钟漂移，并发送至群控制器。设群控制器的本地时间为Tml，控制系统发出数据的参考时间为tref，两者之间存在的初始偏差为Tmo，规定数据从控制系统到达群控制器时钟节点的时间标记为T1,到达主定日镜控制器时钟节点的时间标记为T2，数据回环时再次经过群控制器和主定日镜控制器的时间标记分别为T3和T4。上述时间标记点是由群控制器发送的数据进行捕获记录的。本地时间和系统参考时钟有以下关系：Tml=tref-Tmo；数据由群控制器发送至主定日镜控制器，然后数据再次返回群控制器的时间延时为Tmd，计算数据由群控制器发送至主定日镜控制器时钟之间的平均传播延时Tmd1：Tmd1=1/2)；Tmo=-Tmd1；Tmd=+Tmd1=1/2)；基于计算得到了关键时间数据Tmd和Tmo，然后利用发送广播帧的报文,将系统参考时钟嵌入群控制器的时间节点,计算岀时钟漂移,时钟漂移/＞的计算公式为：。如图4所示为一个校正周期示意图，一个校正周期即控制系统发出数据再次回到主定日镜控制器的时间。时钟漂移每个定日镜控制器实时监视从群控制器收到的同步信号，假如检测到同步错误,定日镜控制器会进入暂停状态并产生对应的状态码,群控制器可以通过非周期命令读取这一状态码。在优选实施例中，定日镜控制器以暂停信号作为同步事件来更新数据, Autbus支持数据同步模式。当通讯发生暂停时，控制系统检测暂停信号，当Autbus信号暂停到来后，控制系统获取Autbus信号暂停时刻Tt；而后等待定日镜控制器执行暂停，在定日镜控制器执行暂停时，控制系统获取定日镜控制器执行信号暂停时刻Tp；获取到两个时刻后，可得Autbus信号暂停与定日镜控制器暂停的时间间隔Tot为：Tot=Tp-Tt；将Tot与偏置阈值Tct比较，若始终保持下述判断关系式，则控制系统不停止通讯过程，定日镜控制器以暂停信号作为同步事件来更新数据，反之控制系统停止通讯过程。判断关系式为：Tct-d＜Tot＜Tct+d，其中，偏置阈值Tct代表期望设置的Autbus信号暂停与定日镜控制器执行暂停之间的间隔时间；d为暂停容差。S3：群控制器根据时钟漂移对主定日镜控制器进行时间校正，将时间校正后的主定日镜控制器控制的定日镜调整至稳态位置。当封装后的帧数据上传到中央通讯处理器后，基于中央通讯处理器内设置的处理程序，将基时间加上各自的时钟漂移，即得到各个定日镜控制器本身时间标记的绝对值；当前，即可通过中央通讯处理器有效的对各个定日镜控制器的上传数据进行实时控制。获取时钟漂移校正后的定日镜控制器控制的定日镜的初始角度，驱动电机正向转动t1时间后，记录第一脉冲数N1、第一角度/＞，再驱动电机反向转动t2时间后，记录第二脉冲数N2、第二角度/＞。基于初始角度、第一脉冲数N1、第一角度/＞、第二脉冲数N2、第二角度/＞计算出转动系数P1和P2；将上述转动系数P1和P2作为校验系数进行存储，并标记当前日期内已完成数据校验操作，将当前周期内校验标志位置设置为1。转动系数P1和P2可以表示电机正反转时的不同性能，了解电机在正反转时的性能差异，从而进行必要的调整或优化。从调整优化后的定日镜测得的定日镜位置为h，对定日镜行程进行校正。设h0为定日镜的起始位置，hp为定日镜的角度系数，hg为定日镜的齿隙,定日镜压力为p。定日镜的位置H如以下公式所示：H=h0+hpp-hp。对定日镜在的时变轨迹进行非线性处理，非线性处理为对定日镜在k时刻的实际位置H和k-1时刻的实际位置H的时变轨迹进行计算，得到定日镜的稳态位置HS。非线性处理由指数函数或者第一阶或第二阶滤波器执行，非线性处理可以执行下式：HS＝Hexp+H)；TS为采样时间，T为时间常数。非线性处理采用指数衰减和线性滤波器的组合方式，考虑了非线性因素的影响，使得对实际位置的描述更加准确。这种非线性处理方式能够更好地处理和模拟现实世界中的复杂系统和非线性现象。S4：经过一轮校正周期后，重新选定主定日镜控制器并进行状态切换。群控制器通过Autbus总线向多个定日镜控制器发送主状态切换命令,多个定日镜控制器在成功接收到命令后,进行状态切换任务。各个定日镜控制器首先检查自身状态是否满足要求,若满足,则切换状态并将新的状态写入状态寄存器;若不满足,将设置不满足指示。在Autbus协议栈中,通过调用函数来实现状态切换,该函数有控制码和状态码两个参数,其中控制码存放群控制器的命令控制代码, 状态码存放着各个定日镜控制器的即时状态。主状态选定及切换过程包括：信道参数检查步骤和主状态转换步骤。信道参数检查步骤，在初始化转态时,首先需要对信道的配置进行检査,比如信道空间使用量,存在重叠的问题等。协议栈中内置的check函数用来检査信道配置。此函数需要在定日镜控制器状态切换前被调用,在确保信道配置没有错误的情况下才可以切换到群控制器请求的状态。主状态转换步骤，主状态选定及切换过程中，状态转换函数首先定义状态请求代码和当前状态代码，当前状态代码的值不为零时,将状态请求代码的值赋给不满足指示；当前状态代码的值为零时，说明该定日镜控制器做好了状态转换的准备,开始读取状态命令进行主状态转换。在优选实施例中，定日镜控制器有两种运行模式,在程序中通过修改全局变量来实现定日镜控制器运行模式的切换：当全局变量被赋0值时,定日镜控制器将运行在自由运行模式，当全局变量被赋1值时,定日镜控制器将运行在时间同步模式。该全局变量由群控制器通过Autbus总线进行赋值,群控制器首先将定日镜控制器需要使用的运行模式参数传递给信道,在初始化阶段对全局变量进行初始化,使定日镜控制器模式可知可控。在实际硬件设计的实施例中，如图5所示，定日镜控制器有如下端口：CN1：Autbus总线接口，连接Autbus收发电路，为定日镜控制器与上位机的通讯接口。CN2：手操器接口，连接RS485收发芯片，用于连接手操器，现场维护人员可使用手操器对控制器进行校准、控制与初始化操作。CN3：扩展RS485接口，连接RS485收发芯片，用于与现场智能清洗设备连接，与智能设备交互。CN4：方位轴接近开关接口，连接接近开关信号接收电路。方位轴接近开关在定日镜控制器执行归零指令时，为方位轴零位开关的功能。在执行其它指令时，为方位轴限位开关的作用。CN5：俯仰轴接近开关接口，连接接近开关信号接收电路。俯仰轴接近开关在定日镜控制器执行归零指令时，为俯仰轴零位开关的功能。在执行其它指令时，为俯仰轴限位开关的作用。CN6：方位轴编码器接口，连接编码器信号接收电路，用于反馈方位轴的运动位置信息。CN7：俯仰轴编码器接口，连接编码器信号接收电路，用于反馈俯仰轴的运动位置信息。CN8：220VAC监测接口，连接A/D转换电路，监测220VAC电源供电，当电源停止供电时，及时监测到并通知主控芯片，使主控芯片及时保存定日镜控制器状态数据。CN9：24V电源接口，用于连接电源转换与稳压电路及A/D转换电路。CN10：方位轴电机接口，连接N通道MOS-FETs及电机驱动芯片。CN11：俯仰轴电机接口，连接N通道MOS-FETs及电机驱动芯片。CN12：制动电阻接口，连接N通道MOS-FETs。当定日镜控制器母线电压高于阈值时，制动电阻启动，将母线电压拉低，保护控制器内部各个功能电路。上述各个接口最终受KY3001芯片控制。在上述实施例中，可以全部或部分地通过软件、硬件、固件或者其任意组合来实现。当使用软件实现时，可以全部或部分地以计算机程序产品的形式实现。所述计算机程序产品包括一个或多个计算机指令。在计算机上加载和执行所述计算机程序指令时，全部或部分地产生按照本申请实施例所述的流程或功能。所述计算机可以是通用计算机、专用计算机、计算机网络、或者其他可编程装置。所述计算机指令可以存储在计算机可读存储介质中，或者通过所述计算机可读存储介质进行传输。所述计算机可读存储介质可以是计算机能够存取的任何可用介质或者是包含一个或多个可用介质集成的服务器、数据中心等数据存储设备。所述可用介质可以是磁性介质，、光介质、或者半导体介质)等。以上所述，仅为本申请的具体实施方式，但本申请的保护范围并不局限于此，任何熟悉本技术领域的技术人员在本申请揭露的技术范围内，可轻易想到各种等效的修改或替换，这些修改或替换都应涵盖在本申请的保护范围之内。因此，本申请的保护范围应以权利要求的保护范围为准。
