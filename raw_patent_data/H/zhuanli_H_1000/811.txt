标题title
一种自动识别设备通讯协议的方法及信息采集系统
摘要abst
本发明涉及暖通空调领域，特别提供一种自动识别设备通讯协议的方法及信息采集系统，所述方法包括如下步骤S1：信息采集终端进入协议类型识别流程并确认所挂载设备的协议类型；S2：信息采集终端进入设备特征值的获取流程并获取所挂载设备的设备特征值；S3：信息采集终端在数据库中的协议库中查询并获取该设备特征值对应的协议，根据该协议对设备数据进行解析；其中步骤S1和S2分别具有其实现的子步骤。本方法和系统通过一个标准化的控制识别流程识别出设备的协议，然后进行数据解析并上传平台。打破了传统的需要去现场确定仪表或者阀门型号，进行定制开发的非标模式，大大提高接入效率，降低接入成本，为工业信息化改造提供支撑。
权利要求书clms
1.一种自动识别设备通讯协议的方法，其特征在于，包括如下步骤：S1：信息采集终端进入协议类型识别流程并确认所挂载设备的协议类型；S2：信息采集终端进入设备特征值的获取流程并获取所挂载设备的设备特征值；S3：信息采集终端在数据库中的协议库中查询并获取该设备特征值对应的协议，根据该协议对设备数据进行解析；所述步骤S1中的协议类型识别流程包括如下子步骤：S11：选择数据库中的协议类型库中的第一种协议；S12：波特率设定为起始值；S13：在不同奇偶校验位下向挂载设备发送当前协议的广播码；S14：判断该设备是否回复:如果回复，则进行CRC校验，判定设备数据是否正确，如果正确则识别为该协议类型；结束步骤S1；如果不正确则进入下一种协议的判断流程并进入步骤S12；如果没有回复，则波特率增加预设间隔值后，进入步骤S13；若波特率已经达到终止波特率，则进入下一种协议的判断流程并进入步骤S12；S15：如果协议类型库中的最后一种协议没有被识别，则结束步骤S1，并返回结果：无法识别协议类型；所述步骤S2中的设备特征值的获取流程包括如下子步骤：S21：若识别的协议类型为标准协议，则按照该标准协议的规则解析该挂载设备传来的数据并获取该挂载设备的设备特征值；S22：若识别的协议类型为非标准协议，则读取人工设定的设备特征值，若无人工设定的设备特征值，则进入设备特征值遍历试探流程；所述步骤S22中的设备特征值遍历试探流程的具体步骤为：Step1：选取数据库中的设备特征值库中的第一个设备特征值；Step2：获取当前设备特征值对应的协议；Step3：选取该协议中的特征信息，并获取所述特征信息在挂载设备向外传送的数据包中的位置和长度信息；Step4：获取挂载设备的数据包，并检验所述数据包中与Step3获取到的相应位置和相应长度的信息是否满足该特征信息的特征：如果满足则确认该设备特征值，并结束设备特征值遍历试探流程；如果不满足则进入下一个设备特征值并重复上述Step2至Step4的过程；Step5：如果所有的设备特征值遍历完之后没有确认设备特征值，则返回结果：无法确认设备特征值。2.根据权利要求1所述的方法，其特征在于：所述方法还包括如下步骤：S4：若所挂载设备的协议不在协议库中，则人工获取该协议后，由系统自动生成该协议的设备特征值，并将该协议及其设备特征值添加至所述数据库。3.根据权利要求1所述的方法，其特征在于：所述设备为传感器或执行器。4.根据权利要求1所述的方法，其特征在于：所述特征信息为能够识别协议内容的标识性信息。5.根据权利要求4所述的方法，其特征在于：所述标识性信息为时钟信息。6.一种信息采集系统，所述系统包括平台端和数据采集终端，所述数据采集终端上挂载设备，其特征在于：所述数据采集终端通过权利要求1至5任一项所述的方法采集所挂载设备的信息，并发送给平台端。7.根据权利要求6所述的系统，其特征在于：所述平台端向数据采集终端发送升级后的数据库。
说明书desc
技术领域本发明涉及暖通空调领域，特别是一种自动识别设备通讯协议的方法及信息采集系统。背景技术在供热，供水，化工，热电等领域经常会使用各种的仪表或者阀门。随着工业物联网的不断发展，迫切需要将这些仪表、阀门等设备的数据采集回来，以实现信息化、智能化。将原有工业现场的仪表或者阀门更换为智能设备的成本高且影响业务的开展，因此比较实际的做法是在原有系统的基础上进行物联网化改造。传统的改造的方法是根据现场安装的设备，查找其型号，获取其通讯协议，再根据其通讯参数配置信息进行定制化开发，然后进行现场调试。这种方式主要存在效率低下、需要重复劳动、维护性差、实施难度大等问题。发明内容针对现有技术存在的不足和缺陷，本发明提供一种自动识别设备通讯协议的方法，包括如下步骤：S1：信息采集终端进入协议类型识别流程并确认所挂载设备的协议类型；S2：信息采集终端进入设备特征值的获取流程并获取所挂载设备的设备特征值；S3：信息采集终端在数据库中的协议库中查询并获取该设备特征值对应的协议，根据该协议对设备数据进行解析；所述步骤S1中的协议类型识别流程包括如下子步骤：S11：选择数据库中的协议类型库中的第一种协议；S12：波特率设定为起始值；S13：在不同奇偶校验位下向挂载设备发送当前协议的广播码；S14：判断该设备是否回复:如果回复，则进行CRC校验，判定设备数据是否正确，如果正确则识别为该协议类型；结束步骤S1；如果不正确则进入下一种协议的判断流程并进入步骤S12；如果没有回复，则波特率增加预设间隔值后，进入步骤S13；若波特率已经达到终止波特率，则进入下一种协议的判断流程并进入步骤S12；S15：如果协议类型库中的最后一种协议没有被识别，则结束步骤S1，并返回结果：无法识别协议类型；所述步骤S2中的设备特征值的获取流程包括如下子步骤：S21：若识别的协议类型为标准协议，则按照该标准协议的规则解析该挂载设备传来的数据并获取该挂载设备的设备特征值；S22：若识别的协议类型为非标准协议，则读取人工设定的设备特征值，若无人工设定的设备特征值，则进入设备特征值遍历试探流程；所述步骤S22中的设备特征值遍历试探流程的具体步骤为：Step1：选取数据库中的设备特征值库中的第一个设备特征值；Step2：获取当前设备特征值对应的协议；Step3：选取该协议中的特征信息，并获取所述特征信息在挂载设备向外传送的数据包中的位置和长度信息；Step4：获取挂载设备的数据包，并检验所述数据包中与Step3获取到的相应位置和相应长度的信息是否满足该特征信息的特征：如果满足则确认该设备特征值，并结束设备特征值遍历试探流程；如果不满足则进入下一个设备特征值并重复上述Step2至Step4的过程；Step5：如果所有的设备特征值遍历完之后没有确认设备特征值，则返回结果：无法确认设备特征值。进一步的，所述方法还包括如下步骤：S4：若所挂载设备的协议不在协议库中，则人工获取该协议后，由系统自动生成该协议的设备特征值，并将该协议及其设备特征值添加至所述数据库。进一步的，所述设备为传感器或执行器。进一步的，所述特征信息为能够识别协议内容的标识性信息。进一步的，所述标识性信息为时钟信息。本发明还保护一种信息采集系统，所述系统包括平台端和数据采集终端，所述数据采集终端上挂载设备，所述数据采集终端通过上述方法采集所挂载设备的信息，并发送给平台端。进一步的，所述平台端向数据采集终端发送升级后的数据库。本发明能够实现如下技术效果：本发明提供的方法或系统，通过将各种设备的设备特征值、协议内容、协议类型等信息整合到数据库中，然后通过一个标准化的控制识别流程识别出设备的协议，然后进行数据解析并上传平台。打破了传统的需要去现场确定仪表或者阀门型号，通讯协议及通讯参数，进行定制开发的非标模式，大大提高接入效率，降低接入成本，为工业信息化改造提供支撑。附图说明为了更清楚地说明本发明具体实施方式中的技术方案，下面将对具体实施方式或现有技术描述中所需要使用的附图作简单地介绍。图1为本发明第一方面实施例的信息采集系统的结构示意图。图2为本发明第一方面实施例的方法的主要步骤S1-S3的流程图。图3为本发明第一方面实施例的数据库的数据结构示意图。图4为本发明第一方面实施例的方法中的步骤S1的子步骤的流程图。图5为本发明第一方面实施例的步骤S1的子步骤的具体实施流程图。图6为本发明第一方面实施例的步骤S2中的设备特征值的获取流程。图7为本发明第一方面实施例的设备特征值遍历试探流程的具体流程示意图。具体实施方式下面将结合附图对本发明专利的结构和运行方式做进一步详细说明，显然，附图的提供仅为了更好地理解本发明专利，它们不应该理解为对本发明专利的限制。基于本发明专利的实施例，本领域普通技术人员在没有做出创造性劳动前提下所获得的所有其他实施例，都属于本发明保护的范围。在本发明的描述中，需要说明的是，如出现术语“中心”、“上”、“下”、“左”、“右”、“竖直”、“水平”、“内”、“外”等，其所指示的方位或位置关系为基于附图所示的方位或位置关系，仅是为了便于描述本发明和简化描述，而不是指示或暗示所指的装置或元件必须具有特定的方位、以特定的方位构造和操作，因此不能理解为对本发明的限制。此外，如出现术语“第一”、“第二”仅用于描述目的，而不能理解为指示或暗示相对重要性。在本发明的描述中，需要说明的是，除非另有明确的规定和限定，如出现术语“安装”、“相连”、“连接”应做广义理解，例如，可以是固定连接，也可以是可拆卸连接，或一体地连接；可以是直接相连，也可以通过中间媒介间接相连，可以是两个元件内部的连通。对于本领域的普通技术人员而言，可以具体情况理解上述术语在本发明中的具体含义。实施例1下面对本发明的一种自动识别设备通讯协议的方法的具体实施例进行说明。该方法的实施主体可以是一种信息采集系统，如图1所示，该信息采集系统具有平台端和若干个信息采集终端。平台端可以是云端数据库或集中处理的管理平台，信息采集终端可以是位于市政采暖系统或其他系统中的地下管井中的信息采集设备。信息采集终端上挂载设备，例如各种仪表、阀门、传感器、执行器等设施。信息采集终端与挂载的设备通讯，从中获取数据，并进行识别和解析，然后再上传给平台端。平台端主要提供如下功能：1、对设备进行管理，主要包括设备掉线、在线状态管理，采集上周周期设定，设备采集上传周期展示，采集参数的校准下发，设备OTA升级，设备版本维护，协议特征值下发，采集协议表下发。2、数据管理，主要包括实时数据采集，异常数据去除，历史数据的存储调用，采集参数动态变化计算，变化率计算及突发异常情况的预判及告警状态产生。3、数据转发功能，根据需要，对采集对接设备的数据转发到第三方平台或者本公司业务平台。终端采集装置主要由MCU，NB-IoT通讯模块/4G通讯模块，按键、指示灯及电源系统组成，主要提供如下技术方案：1、对挂载在其下面的仪表或者阀门进行通讯参数的自动识别，通讯协议的自动识别，协议的自动解析；2、具备平台端的通讯功能，具备数据上传，接收平台下发指令如OTA升级，接收远程下发协议并根据协议采集数据，远程控制重新识别协议等功能3、具备本地化识别状态指示，按键触发重新识别等功能。由于这种信息采集系统是在原有系统的基础上进行物联化改造而成，所以每一种设备所采用的通讯协议均可能不相同。为了避免对现场的设备进行定制化开发、现场调试等低效的工作模式，本发明采用的方法能够对设备所采用的通讯协议进行自动识别，在识别到通讯协议后就可以根据该协议对设备传来的数据进行解析，从而获取设备信息或对设备进行控制。具体来说，该方法包括如图2所示的下述步骤：S1：所述信息采集终端进入协议类型识别流程并确认所挂载设备的协议类型；S2：所述信息采集终端进入设备特征值的获取流程并获取所挂载设备的设备特征值；S3：所述信息采集终端在数据库中的协议库查询并获取该设备特征值对应的协议，根据该协议对设备数据进行解析。所述数据库是如图3所示的数据结构。具体来说，每一种设备都有具体的基本信息，例如是某个厂家的某种设备，该设备所采用的协议类型可能是CJ188协议，或MBUS协议或其他协议类型，每个设备都对应一个设备特征值，该特征值是一个唯一的识别编码，该设备的协议的具体内容也存放在该数据库中。所述数据库包含若干子数据库，图3中的每个列分别形成一个子数据库，例如第一列形成设备库，第二列形成协议类型库，第三列形成设备特征值库，第四列形成协议库。所述步骤S1中的协议类型识别流程包括如图4所示的下述子步骤：S11：选择协议类型库中的第一种协议；S12：波特率设定为起始值；S13：在不同奇偶校验位下向挂载设备发送当前协议的广播码；S14：判断该设备是否回复:如果回复则进行CRC校验，判定设备数据是否正确，如果正确则识别为该协议类型；结束步骤S1；如果不正确则进入下一种协议的判断流程并进入步骤S12；如果没有回复，则波特率增加预设间隔值后，进入步骤S13；若波特率已经达到终止波特率，则进入下一种协议的判断流程并进入步骤S12；S15：如果协议类型库中的最后一种协议没有被识别，则结束步骤S1，并返回结果：无法识别协议类型。图5示出了一个具体的实施例中的协议类型识别流程的具体实现过程的流程图。首先信息采集终端会选择协议类型库中的第一种类型，例如CJ188协议类型，然后从起始波特率开始，在不同的奇偶校验位之下向设备发送该通讯类型的广播码，判断设备是否有回复，如果没有回复则波特率增加一个步进值，在下一个波特率下继续这个判断流程，如果有回复则判断CRC校验返回是否正确，如果不正确则波特率在增加步进值后进入下一个波特率的判断流程，如果正确了则确定协议类型为当前的协议类型，如果波特率已达最大值则表示该协议类型不正确，则进入下一个协议类型的判断流程，直到找到正确的协议类型，或者在数据库中所有的协议类型都已经试过一遍以后依然没有找到正确的协议类型则返回无法识别协议类型的结果。初始波特率、步进值及终止波特率都可以进行设定。所述步骤S2中的设备特征值的获取流程包括如下子步骤：S21：若识别的协议类型为标准协议，则按照该标准协议的规则解析该挂载设备传来的数据并获取其设备特征值；S22：若识别的协议类型为非标准协议，则读取人工设定的设备特征值，若无人工设定的设备特征值，或者进入设备特征值遍历试探流程。标准协议指的是国际标准协议，或者协议的内容能够通过公开的标准查询出来并获取其协议内容的协议。一般来讲，标准协议会披露在该设备的设备特征值位于什么位置以及数据长度是多少，所以按照该标准协议的内容的指引到设备发来的数据中的相应位置并读取相应长度的信息后即可以获得该设备特征值，在数据库中查询其对应的协议内容即可以获得通讯参数并对数据进行解析。而非标准协议指的是协议的内容不具有通用性，各个厂家可以自行定义的协议。遇到非标准协议，如果不能查询到设备安装时人工设定的设备特征值就只能通过设备特征值遍历试探流程来进行破解。图6示出了步骤S2的子步骤的一个具体的实现过程。图7示出了所述步骤S22中的设备特征值遍历试探流程的具体步骤为：Step1：选取设备特征值数据库中的第一个设备特征值；Step2：获取该设备特征值对应的协议；Step3：选取该协议中的特征信息，并获取所述特征信息在挂载设备向外传送的数据包中的位置和长度信息；Step4：获取挂载设备的数据包，并检验所述数据包中与Step3获取到的相应位置和相应长度的信息是否满足该特征信息的特征：如果满足则确认该设备特征值，并结束设备特征值遍历试探流程；如果不满足则进入下一个设备特征值的判断流程；Step5：如果所有的设备特征值遍历完之后没有确认设备特征值，则返回结果：无法确认设备特征值。所述特征信息指的是能够识别该协议的标记性信息。例如，时钟信息。设备所发送的信息中都带有时钟信息，其每隔一秒钟跳动一次，该种规律使其具有可识别性。在不同的协议中，时钟信息在数据中的位置和长度不同。因此在假定为某种协议时，去相应位置处读取相应长度的信息后判断其是否符合时钟信息的规则就能够判断该协议的假设是否成立，如果成立则判断为该设备特征值对应的协议内容，如果不成立，则换下一个设备特征值进行判断，直到确认为某个协议，或者在所有的设备特征值均遍历完之后返回无法确认的结果。在具体的实施例中，所述方法还包括如下步骤：S4：若所挂载设备的协议不在协议库中，则人工获取该协议后，由系统自动生成该协议的设备特征值，并将该协议及其设备特征值添加至所述数据库。上述步骤一般是在线下完成，然后再增添数据至数据库，然后平台端可以将更新后的数据库下发给数据采集终端，这样数据采集终端就可以识别这些设备并与其通讯、解析数据。系统具有设备特征值自动计算和添加的算法，能够将某种协议自动计算生成对应的设备特征值，并保证与已经存在的设备特征值不相冲突。实施例2一种信息采集系统，所述系统包括平台端和数据采集终端，所述数据采集终端上挂载设备，所述数据采集终端通过前述方法采集所挂载设备的信息，并发送给平台端。所述平台端向数据采集终端发送升级后的数据库。所述设备为传感器或执行器。与现有技术相比具有的有益效果是：1、实施安装过程标准化，无需人员参与即可自动识别对接设备的协议类型、设备特征值及协议内容，并进行数据解析；2、设备标准化，无需根据现场的仪表或者阀门进行非标的开发，标准化设备进行现场数据采集；3、新设备特征值再计算功能，根据输入的协议进行设备特征值计算判定，判断是否同之前的设备特征值冲突，形成新的设备特征值编码；4、具备OTA升级及解析协议下发功能，能够根据平台下发协议表进行识别协议变更，无需现场处理即可实现新增自动识别导入。上述各实施例仅用于说明本发明专利，其中各部件的结构、连接方式和制作工艺等都是可以有所变化的，凡是在本技术方案的基础上进行的等同变换和改进，均不应排除在本发明专利的保护范围之外。
