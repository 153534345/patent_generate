标题title
兼容BR与BLE5.2多模蓝牙协议的基带数据收发处理方法及系统
摘要abst
本发明公开了一种兼容BR与BLE5.2多模蓝牙协议的基带数据收发处理方法及系统，包括：通过收发状态机在对与蓝牙基本速率模式、支持BLE5.2协议的非编码物理层模式或支持BLE5.2协议的编码物理层模式相对应的帧结构进行发送和接收时，进行帧结构的跳转，并通过收发状态机产生用于表征帧结构状态的逻辑信号。根据本发明实施例的兼容BR与BLE5.2多模蓝牙协议的基带数据收发处理方法及系统，可作为需要兼容双模/多模蓝牙、兼容多种无线RF传输、多种无线协议兼容传输的基带协议特性。
权利要求书clms
1.一种兼容BR与BLE5.2多模蓝牙协议的基带数据收发处理方法，其特征在于，包括：通过收发状态机在对与蓝牙基本速率模式、支持BLE5.2协议的非编码物理层模式或支持BLE5.2协议的编码物理层模式相对应的帧结构进行发送和接收时，进行帧结构的跳转，并通过收发状态机产生用于表征帧结构状态的逻辑信号；通过crc/hec模块、白化模块、fec模块、defec模块、解白化模块和crc/hec校验模块对与蓝牙基本速率模式对应的第一帧结构的分组头进行对应的hec算法、白化、fec的发送处理以及defec、解白化和hec算法校验的接收处理；通过白化模块、解白化模块对与蓝牙基本速率模式对应的第一帧结构的有效载荷进行对应的白化的发送处理以及解白化的接收处理；通过crc/hec模块、白化模块、解白化模块和crc/hec校验模块对与支持BLE5.2协议的非编码物理层模式对应的第二帧结构的有效载荷进行对应的crc算法和白化的发送处理以及解白化和crc算法校验的接收处理；通过crc/hec模块、白化模块、fec模块、映射模块、解映射模块、defec模块、解白化模块和crc校验模块对与支持BLE5.2协议的编码物理层模式对应的第三帧结构的有效载荷进行相应的crc算法、白化、fec和映射的发送处理以及解映射、defec、解白化和crc算法校验的接收处理。2.如权利要求1所述的兼容BR与BLE5.2多模蓝牙协议的基带数据收发处理方法，其特征在于，在对与蓝牙基本速率模式对应的第一帧结构的有效载荷进行白化处理之前还通过crc/hec模块、加密模块对第一帧结构的有效载荷进行crc算法和加密的发送处理，以及在对与蓝牙基本速率模式对应的第一帧结构的有效载荷进行白化处理之后还通过编码模块对第一帧结构的有效载荷进行编码的发送处理；在对与蓝牙基本速率模式对应的第一帧结构的有效载荷进行解白化处理之前还通过解码模块对第一帧结构的有效载荷进行解码的接收处理，以及在对与蓝牙基本速率模式对应的第一帧结构的有效载荷进行解白化处理之后还通过解密模块、crc/hec校验模块对第一帧结构的有效载荷进行解密和crc检验算法的发送处理。3.如权利要求1所述的兼容BR与BLE5.2多模蓝牙协议的基带数据收发处理方法，其特征在于，在对与支持BLE5.2协议的非编码物理层模式对应的第二帧结构的有效载荷进行crc算法之前还通过加密模块对第二帧结构的有效载荷进行加密的发送处理，以及在对与支持BLE5.2协议的非编码物理层模式对应的第二帧结构的有效载荷进行crc检验算法之后还通过解密模块对第二帧结构的有效载荷进行解密的接收处理。4.如权利要求1所述的兼容BR与BLE5.2多模蓝牙协议的基带数据收发处理方法，其特征在于，在对与支持BLE5.2协议的编码物理层模式对应的第三帧结构的有效载荷进行crc算法之前还通过加密模块对第三帧结构的有效载荷进行加密的发送处理，以及在对与支持BLE5.2协议的编码物理层模式对应的第三帧结构的有效载荷进行crc检验算法之后还通过解密模块对第三帧结构的有效载荷进行解密的接收处理。5.如权利要求1所述的兼容BR与BLE5.2多模蓝牙协议的基带数据收发处理方法，其特征在于，通过计数寄存器基于当前的蓝牙协议以及当前的帧结构状态产生计数值，通过收发状态机基于计数值进行帧结构的跳转。6.如权利要求5所述的兼容BR与BLE5.2多模蓝牙协议的基带数据收发处理方法，其特征在于，通过发送数据控制模块基于当前的蓝牙协议、表征帧结构状态的逻辑信号以及计数寄存器的计数值产生与当前帧结构状态对应的码流。7.如权利要求1所述的兼容BR与BLE5.2多模蓝牙协议的基带数据收发处理方法，其特征在于，通过比特流控制模块控制各模块输出数据流的有效性。8.一种兼容BR与BLE5.2多模蓝牙协议的基带数据收发处理系统，其特征在于，包括：收发状态机，用于对与蓝牙基本速率模式、支持BLE5.2协议的非编码物理层模式或支持BLE5.2协议的编码物理层模式相对应的帧结构进行发送和接收时，进行帧结构的跳转，并通过收发状态机产生用于表征帧结构状态的逻辑信号；加密模块，用于帧结构的加密处理；crc/hec模块，用于帧结构的crc算法和/或hec算法处理；白化模块，用于帧结构的白化处理；编码模块，用于帧结构的编码处理；fec模块，用于帧结构的前向纠错处理；映射模块，用于帧结构的映射处理；解密模块，用于帧结构的解密处理；crc/hec校验模块，用于帧结构的crc算法和/或hec算法后的校验处理；解白化模块，用于帧结构的解白化处理；解码模块，用于帧结构的解码处理；defec模块，用于帧结构前向纠错后的解码处理；解映射模块，用于帧结构的解映射处理；存储单元，用于存储数据；数据写入模块，用于将数据写入存储单元；数据读取模块，用于读取存储单元内的数据；寄存器，用于配置蓝牙模式以及帧结构的处理模式；连接配对单元，用于数据的连接匹配。9.如权利要求8所述的兼容BR与BLE5.2多模蓝牙协议的基带数据收发处理系统，其特征在于，所述基带数据收发处理系统还包括比特流控制模块，用于控制一个或多个模块输出数据流的有效性。10.如权利要求8所述的兼容BR与BLE5.2多模蓝牙协议的基带数据收发处理系统，其特征在于，所述连接配对单元包括：数据采样模块，用于进行数据采样；识别码模块，用于对数据的识别码进行识别而关联；符号恢复模块，用于进行数据恢复；同步缓存模块，用于进行数据缓存。
说明书desc
技术领域本发明是关于兼容双模以及多模蓝牙协议的技术领域，特别是关于一种兼容BR与BLE5.2多模蓝牙协议的基带数据收发处理方法及系统。背景技术随着AIOT无线智能传感集成技术的发展，以及随着无线通信技术、无线MCUSoC产品应用以及无线传输控制家居、智能家电以及智能健康监测、智能物联等技术的发展，蓝牙作为一种近距离无线通信解决方案，越来越受到市场的重视。市场上具有蓝牙功能的设备也越来越多，但现有的每台设备仅单一的支持一种蓝牙协议，无法实现多种蓝牙协议的兼容，从而带来使用场景的受限，通用性低。公开于该背景技术部分的信息仅仅旨在增加对本发明的总体背景的理解，而不应当被视为承认或以任何形式暗示该信息构成已为本领域一般技术人员所公知的现有技术。发明内容本发明的目的在于提供一种兼容BR与BLE5.2多模蓝牙协议的基带数据收发处理方法及系统，其能够基于发送和接收的数据比特流根据配置的通信协议模式进行发送数据的组帧、产生CRC码、白化、编码等，并根据配置的通信协议模式寄存器进行接收数据的译码、解白化、帧解析、CRC校验等的比特流处理，实现多种蓝牙协议的兼容，功耗低、通用性强、占用面积小、节约成本。为实现上述目的，本发明的实施例提供了一种兼容BR与BLE5.2多模蓝牙协议的基带数据收发处理方法，包括：通过收发状态机在对与蓝牙基本速率模式、支持BLE5.2协议的非编码物理层模式或支持BLE5.2协议的编码物理层模式相对应的帧结构进行发送和接收时，进行帧结构的跳转，并通过收发状态机产生用于表征帧结构状态的逻辑信号；通过crc/hec模块、白化模块、fec模块、defec模块、解白化模块和crc/hec校验模块对与蓝牙基本速率模式对应的第一帧结构的分组头进行对应的hec算法、白化、fec的发送处理以及defec、解白化和hec算法校验的接收处理；通过白化模块、解白化模块对与蓝牙基本速率模式对应的第一帧结构的有效载荷进行对应的白化的发送处理以及解白化的接收处理；通过crc/hec模块、白化模块、解白化模块和crc/hec校验模块对与支持BLE5.2协议的非编码物理层模式对应的第二帧结构的有效载荷进行对应的crc算法和白化的发送处理以及解白化和crc算法校验的接收处理；通过crc/hec模块、白化模块、fec模块、映射模块、解映射模块、defec模块、解白化模块和crc校验模块对与支持BLE5.2协议的编码物理层模式对应的第三帧结构的有效载荷进行相应的crc算法、白化、fec和映射的发送处理以及解映射、defec、解白化和crc算法校验的接收处理。在本发明的一个或多个实施例中，在对与蓝牙基本速率模式对应的第一帧结构的有效载荷进行白化处理之前还通过crc/hec模块、加密模块对第一帧结构的有效载荷进行crc算法和加密的发送处理，以及在对与蓝牙基本速率模式对应的第一帧结构的有效载荷进行白化处理之后还通过编码模块对第一帧结构的有效载荷进行编码的发送处理；在对与蓝牙基本速率模式对应的第一帧结构的有效载荷进行解白化处理之前还通过解码模块对第一帧结构的有效载荷进行解码的接收处理，以及在对与蓝牙基本速率模式对应的第一帧结构的有效载荷进行解白化处理之后还通过解密模块、crc/hec校验模块对第一帧结构的有效载荷进行解密和crc检验算法的发送处理。在本发明的一个或多个实施例中，在对与支持BLE5.2协议的非编码物理层模式对应的第二帧结构的有效载荷进行crc算法之前还通过加密模块对第二帧结构的有效载荷进行加密的发送处理，以及在对与支持BLE5.2协议的非编码物理层模式对应的第二帧结构的有效载荷进行crc检验算法之后还通过解密模块对第二帧结构的有效载荷进行解密的接收处理。在本发明的一个或多个实施例中，在对与支持BLE5.2协议的编码物理层模式对应的第三帧结构的有效载荷进行crc算法之前还通过加密模块对第三帧结构的有效载荷进行加密的发送处理，以及在对与支持BLE5.2协议的编码物理层模式对应的第三帧结构的有效载荷进行crc检验算法之后还通过解密模块对第三帧结构的有效载荷进行解密的接收处理。在本发明的一个或多个实施例中，通过计数寄存器基于当前的蓝牙协议以及当前的帧结构状态产生计数值，通过收发状态机基于计数值进行帧结构的跳转。在本发明的一个或多个实施例中，通过发送数据控制模块基于当前的蓝牙协议、表征帧结构状态的逻辑信号以及计数寄存器的计数值产生与当前帧结构状态对应的码流。在本发明的一个或多个实施例中，通过比特流控制模块控制各模块输出数据流的有效性。本发明还公开了一种兼容BR与BLE5.2多模蓝牙协议的基带数据收发处理系统，包括：收发状态机，用于对与蓝牙基本速率模式、支持BLE5.2协议的非编码物理层模式或支持BLE5.2协议的编码物理层模式相对应的帧结构进行发送和接收时，进行帧结构的跳转，并通过收发状态机产生用于表征帧结构状态的逻辑信号；加密模块，用于帧结构的加密处理；crc/hec模块，用于帧结构的crc算法和/或hec算法处理；白化模块，用于帧结构的白化处理；编码模块，用于帧结构的编码处理；fec模块，用于帧结构的前向纠错处理；映射模块，用于帧结构的映射处理；解密模块，用于帧结构的解密处理；crc/hec校验模块，用于帧结构的crc算法和/或hec算法后的校验处理；解白化模块，用于帧结构的解白化处理；解码模块，用于帧结构的解码处理；defec模块，用于帧结构前向纠错后的解码处理；解映射模块，用于帧结构的解映射处理；存储单元，用于存储数据；数据写入模块，用于将数据写入存储单元；数据读取模块，用于读取存储单元内的数据；寄存器，用于配置蓝牙模式以及帧结构的处理模式；连接配对单元，用于数据的连接匹配。在本发明的一个或多个实施例中，所述基带数据收发处理系统还包括比特流控制模块，用于控制一个或多个模块输出数据流的有效性。在本发明的一个或多个实施例中，所述连接配对单元包括：数据采样模块，用于进行数据采样；识别码模块，用于对数据的识别码进行识别而关联；符号恢复模块，用于进行数据恢复；同步缓存模块，用于进行数据缓存。与现有技术相比，根据本发明实施例的兼容BR与BLE5.2多模蓝牙协议的基带数据收发处理方法及系统，可作为需要兼容双模/多模蓝牙、兼容多种无线RF传输、多种无线协议兼容传输的基带协议特性。根据寄存器配置传输模式实现内部设计比特流控制数据传输，发送比特流数据部分进行串行数据比特流进行组帧、加密、crc算法、fec、白化、编码、映射等控制，接受比特流数据部分完成对接收的串行数据比特流进行帧解析、解密、译码、纠错等控制；可作为兼容双模/多模蓝牙基带处理硬件装置电路，可作为一个通用的具有可以配置兼容双模/多模蓝牙数据的组帧、编码、CRC算法的发送以及接收数据的比特流的解码、解白化、帧解析、CRC校验等数据处理的IP模块；可集成于SoC或MCU电路中，具有功耗低、通用性强、占用面积小、节约成本。附图说明图1是根据本发明的兼容BR与BLE5.2多模蓝牙协议的基带数据收发处理方法的结构示意图。图2是根据本发明的在发送数据时的收发状态机进行数据帧结构跳转的跳转示意图。图3是根据本发明的在接收数据时的收发状态机进行数据帧结构跳转的跳转示意图。图4是根据本发明的计数寄存器的结构示意图。图5是根据本发明的发送数据控制模块的结构示意图。图6a是根据本发明的蓝牙基本速率模式下的分组头的收发处理流程图。图6b是根据本发明的蓝牙基本速率模式下的有效载荷的第一收发处理流程图。图6c是根据本发明的蓝牙基本速率模式下的有效载荷的第二收发处理流程图。图7是根据本发明的支持BLE5.2协议的非编码物理层模式下的有效载荷的收发处理流程图。图8是根据本发明的支持BLE5.2协议的编码物理层模式下的有效载荷的收发处理流程图。图9是根据本发明的在发送数据下的数据处理示意图。图10是根据本发明的在接收数据下的数据处理示意图。图11是根据本发明的比特流控制模块的示意图。图12是根据本发明的比特流控制模块内部的两个计数器的示意图。图13是根据本发明的比特流控制模块内部的两个计数器的控制信号逻辑电路图。图14是根据本发明的蓝牙基本速率模式的数据帧结构的示意图。图15是根据本发明的蓝牙基本速率模式的数据帧结构的识别码结构的示意图。图16是根据本发明的蓝牙基本速率模式的数据帧结构的分组头结构的示意图。图17是根据本发明的支持BLE5.2协议的非编码物理层数据包格式的示意图。图18是根据本发明的支持BLE5.2协议的编码物理层的数据包格式的示意图。具体实施方式下面结合附图，对本发明的具体实施例进行详细描述，但应当理解本发明的保护范围并不受具体实施例的限制。除非另有其它明确表示，否则在整个说明书和权利要求书中，术语“包括”或其变换如“包含”或“包括有”等等将被理解为包括所陈述的元件或组成部分，而并未排除其它元件或其它组成部分。说明书中的“耦接”或“连接”或“相连”既包含直接连接，也包含间接连接。间接连接为通过中间媒介进行的连接，如通过电传导媒介进行的连接，其可具有寄生电感或寄生电容；间接连接还可包括在实现相同或相似功能目的的基础上通过其他有源器件或无源器件的连接，如通过开关、跟随电路等电路或部件的连接。另外，在本发明中，例如“第一”、“第二”之类的词语主要用于区分一个技术特征与另一个技术特征，而并不一定要求或暗示这些技术特征之间存在某种实际的关系、数量或者顺序。如图1所示，一种兼容BR与BLE5.2多模蓝牙协议的基带数据收发处理系统，包括：收发状态机、加密模块、crc/hec模块、白化模块、编码模块、fec模块、映射模块、解密模块、crc/hec校验模块、解白化模块、解码模块、defec模块、解映射模块、存储单元、数据写入模块、数据读取模块、比特流控制模块、连接配对单元；存储单元包括双端口RAM、内存控制器、时钟建立模块、GIO模块、接口状态机和RF前端模块。在本实施例中，基带数据收发处理系统设计作为一个特定的IP模块时，总线接口为AMBA总线；当设计接口为SPI或I2C总线时，可以作为一个特定的芯片电路。内部或外部处理器通过总线接口可以配置系统的工作模式，并且通过总线接口，处理器可以配置双端口RAM的收发数据值。对于需发送的数据，处理器写入双端口RAM中，对于接收的数据，处理器读取双端口RAM的数据。RF前端模块接收空中数据，连接配对单元对能够握手的空中数据进行识别而连接匹配，根据蓝牙协议以及数据帧结构选择一种或多种模块对握手成功的数据进行相应的解映射、defec、解码、解白化、crc校验、hec校验、解密的帧结构处理并结合收发状态机的帧结构状态跳转而输出比特流数据，并将帧结构处理后的比特流数据通过数据写入模块写入双端口RAM内；通过数据读取模块将双端口RAM内的数据进行读取，根据蓝牙协议以及数据帧结构选择一种或多种模块对读取的数据进行相应的加密、hec、crc、白化、编码、fec、映射的帧结构处理并结合收发状态机的帧结构状态跳转而输出比特流数据，输出的比特流数据经RF前端模块向外发送。进一步的，收发状态机用于对与蓝牙基本速率模式、支持BLE5.2协议的非编码物理层模式或支持BLE5.2协议的编码物理层模式相对应的帧结构进行发送和接收时，进行帧结构的跳转，并通过收发状态机产生用于表征帧结构状态的逻辑信号。加密模块用于帧结构的加密处理；crc/hec模块用于帧结构的crc算法和/或hec算法处理；白化模块用于帧结构的白化处理；编码模块用于帧结构的编码处理；fec模块用于帧结构的前向纠错处理；映射模块用于帧结构的映射处理；解密模块用于帧结构的解密处理；crc/hec校验模块用于帧结构的crc算法和/或hec算法后的校验处理；解白化模块用于帧结构的解白化处理；解码模块用于帧结构的解码处理；defec模块用于帧结构前向纠错后的解码处理；解映射模块用于帧结构的解映射处理；存储单元用于存储数据；数据写入模块用于将数据写入存储单元；数据读取模块用于读取存储单元内的数据；寄存器用于配置蓝牙模式以及帧结构的处理模式；比特流控制模块用于控制各模块输出数据流的有效性，连接配对单元用于数据的连接匹配，本实施例中，通过比特流控制模块基于从双端口RAM内读取的数据流与fec处理后输出的数据流的关系来控制fec处理后输出的数据流的有效性，在其他实施例中，也可以控制crc或者其他处理后产生的数据流的有效性。连接配对单元包括数据采样模块、识别码模块、符号恢复模块、同步缓存模块。其中，数据采样模块用于进行数据采样；识别码模块用于对数据的识别码进行识别而关联；符号恢复模块用于进行数据恢复；同步缓存模块用于进行数据缓存。在本实施例中，蓝牙基本速率模式的数据帧结构如图14所示。蓝牙基本速率模式的数据帧结构的识别码ACCESS CODE结构如图15所示。蓝牙基本速率模式的数据帧结构的分组头HEADER结构如图16所示。在基带定义的数据包和消息时，编码序列遵循LSB各数据段在基带内部生成，如分组头HEADER和有效载荷PAYLOAD等。分组头HEADER包含HEC结构的整个分组头信息由18位组成，该分组头信息以1/3比例前向纠错码编码，因此，分组头信息最后成为54位编码格式，LT_ADDR和TYPE对应的信息段的LSB首先发送。如图6a所示，对于分组头发送时，依次通过crc/hec模块进行hec算法处理、使用白化模块进行whitening处理、采用fec模块进行fec前向纠错处理；在接收端执行相反过程，即先采用defec模块进行defec解码处理、使用解白化模块进行dewhitening处理、通过crc/hec校验模块进行hec算法校验处理。图6a示出的收发两端的分组头处理的执行过程，在处理过程中两端的所有头位处理过程是强制性的。如图6b所示，对有效载荷来讲，将执行类似的处理过程。但执行过程还要取决于分组类别。其执行过程如图6b所示，在发送端时，依次包括通过crc/hec模块进行crc算法处理、通过加密模块进行encryption处理、通过白化模块进行whitening处理和通过编码模块进行encoding处理；在接收端时，进行相反操作，依次包括通过解码模块进行decoding处理、通过解白化模块进行dewhitening处理、通过解密模块进行decryption处理和通过crc/hec校验模块进行crc算法校验处理，其中只有whitening和dewhitening为每个有效载荷必须强制执行，其他所有处理都是可选的，这取决于分组类型和可用模式，如图6b中凡属可选处理皆用虚线框标出。如图6c所示，在其他实施例中，对有效载荷来讲，通过crc/hec模块进行crc算法处理和通过加密模块进行encryption处理的顺序可以调换，通过解密模块进行decryption处理和通过crc/hec校验模块进行crc算法校验处理的顺序也可以调换，从而在白化处理前以及解白化处理均形成如图6c所示的两条路径，即在发送端时，可选择通过crc/hec模块进行crc算法处理、通过加密模块进行encryption处理这一条路径，或者选择通过加密模块进行encryption处理、通过crc/hec模块进行crc算法处理这另一条路径，再接着通过白化模块进行whitening处理和通过编码模块进行encoding处理；在接收端时，进行相反操作，依次包括通过解码模块进行decoding处理、通过解白化模块进行dewhitening处理，接着可选择通过解密模块进行decryption处理、通过crc/hec校验模块进行crc算法校验处理这一条路径，或者选择通过crc/hec校验模块进行crc算法校验、通过解密模块进行decryption处理这另一条路径，其中只有whitening和dewhitening为每个有效载荷必须强制执行，其他所有处理都是可选的，这取决于分组类型和可用模式，如图6c中凡属可选处理皆用虚线框标出。在本实施例中，支持BLE5.2协议的非编码物理层 数据包格式如图17所示。如图7所示，对有效载荷来讲，将执行类似的处理过程。但执行过程还要取决于分组类别。其执行过程如图7所示，在发送端时，依次包括通过加密模块进行encryption处理、通过crc/hec模块进行crc算法处理和通过白化模块进行whitening处理；在接收端时，进行相反操作，依次包括通过解白化模块进行dewhitening处理、通过crc/hec校验模块进行crc算法校验处理和通过解密模块进行decryption处理，其中只有crc算法和crc算法校验为每个有效载荷必须强制执行，其他所有处理都是可选的，这取决于分组类型和可用模式，如图7中凡属可选处理皆用虚线框标出。在本实施例中，支持BLE5.2协议的编码物理层的数据包格式如图18所示。其中，每个数据包包括Preamble、FEC block 1和FEC block 2，而Preamble属于不编码的部分，FEC block 1包括3个部分：Access Address，CI和TERM1；FEC block 1用S=8编码结构。而CI设定FECblock 2的编码结构，FEC block 2包括3部分: PDU，CRC和TERM2，FEC block 2由CI的值决定S=2orS=8编码结构。整个包结构按1M速率传输，支持BLE5.2协议的编码物理层没有Constant Tone Extension部分，其前导由10个重复的标识符'00111100'构成。数据包结构长度包括462μs至17040μs传输。其整个组帧结构如下表一：如图8所示，对有效载荷来讲，将执行类似的处理过程。但执行过程还要取决于分组类别。其执行过程如图8所示，在发送端时，依次包括通过加密模块进行encryption处理、通过crc/hec模块进行crc算法处理、通过白化模块进行whitening处理、通过fec模块进行fec前向纠错处理和通过映射模块进行mapper处理；在接收端时，进行相反操作，依次包括通过解映射模块进行demapper处理、通过defec模块进行defec解码处理、通过解白化模块进行dewhitening处理、通过crc/hec算法校验模块进行crc算法校验处理和通过解密模块进行decryption处理，其中只有encryption和decryption为每个有效载荷可选执行，其他所有处理都是强制执行，这取决于分组类型和可用模式，如图8中凡属可选处理用虚线框标出。结合图6a、图6b、图6c、图7、图8可以看出不同的蓝牙协议模式需要跳转的状态是不同的，而且需要经过不同的算法以及算法错误校验，算法错误校验分别hec算法校验和crc算法校验，而且根据蓝牙协议不同的蓝牙协议模式需要进行的crc校验算法也是不同；另外不同的蓝牙协议模式需要进行不同的fec算法错误校验，以及是否需要whitening等。fec模块内部兼容多种可选fec算法，并可以通过寄存器来配置不同的fec算法以及配置fec使能信号和fec初始化信号等，可以根据不同的帧结构状态和蓝牙协议工作模式需要进行不同的数据码段的fec算法等，hec/crc算法以及whiten原理也相同。图2示出的是发送数据时的收发状态机进行数据帧结构跳转的跳转示意图，主要示意在非睡眠模式下的收发状态机的跳转。当上电复位后，且处于非睡眠模式下，发送状态跳转到ST_IDLE状态，后续主要是等待VCO和PA稳定后开始状态跳转，其跳转时间是通过寄存器配置，具体由收发状态机内部设计的控制帧状态的计数寄存器framer的计数值计数到某值决定；当满足计数到某值时，收发状态机跳转到发送的ST_TX_SYN/ADDRESS时，根据不同的蓝牙协议跳转到不同的其他状态，当寄存器配置工作为蓝牙蓝牙基本速率模式时，发送状态跳转到ST_TX_TRAILER，配置为BLE5.2编码物理层模式时跳转到ST_TX_CI，配置为BLE5.2 非编码物理层模式时跳转到ST_TX_PDU_HEADER。收发状态机的其他情况条件下的跳转如图2所示。计数寄存器framer的计数值由数据帧结构需要计数的数据比特流数据的个数控制，收发状态机跳转到ST_TX_PREAMBLE状态时，根据寄存器配置不同的蓝牙模式。图3示出的是接收数据时的收发状态机进行数据帧结构跳转的跳转示意图，主要示意在非睡眠模式下的收发状态机跳转；当处于非睡眠模式下时，接收状态跳转到ST_IDLE状态，然后跳转到ST_SYN_VCO_ON，然后跳转到等待状态，根据寄存器配置不同的蓝牙模式，当工作在支持BLE5.2协议的编码物理层模式时，收发状态机跳转到ST_RX_WAIT_PREAMBLE状态；当工作在蓝牙基本速率模式或支持BLE5.2协议的非编码物理层模式。满足计数到某值时，收发状态机跳转到ST_RX_WAIT_SYNWORD/ADDRESS状态，然后再根据不同的蓝牙模式跳转到不同的其他状态。当寄存器配置工作为蓝牙蓝牙基本速率模式时，发送状态跳转到ST_RX_TRAILER，配置为支持BLE5.2协议的编码物理层模式时，发送状态跳转到ST_RX_CI，配置为支持BLE5.2协议的非编码物理层模式时，发送状态跳转到ST_RX_PDU_HEADER。收发状态机的其他情况条件下的跳转如图3所示。如图4所示，根据计数寄存器配置需要工作数据传输的蓝牙模式，进行framer帧结构跳转的控制和需要在某个帧结构状态下的计数值配置；如支持BLE5.2协议的编码物理层模式是发送80 比特的串行码流，其framer_cnt从帧结构处于PREAMBLE时，开启计数，总共80个clk，对于收发状态机和各算法模块、计数寄存器都是以1M时钟频率计数，即表征帧结构状态的逻辑信号以及寄存器配置的蓝牙协议模式等共同控制着收发状态机的跳转。图5是发送数据控制模块的结构示意图，主要由蓝牙协议模式及表征帧结构状态的逻辑信号以及计数寄存器的计数值共同控制着发送数据控制模块的输出。以发送跳转的收发状态机的工作模式为例进行说明，当收发状态机跳转到ST_TX_PREAMBLE时，根据不同的蓝牙模式，发送不同的preamble码流，工作在蓝牙基本速率模式时，发送的tx_data在preamble帧状态下的码流为4比特的1010或0101，由sync word的第一个比特确定；而配置为支持BLE5.2协议的非编码物理层模式，发送的tx_data在preamble帧状态下根据Access-address配置的第一个比特位发送；配置为支持BLE5.2协议的编码物理层模式, 发送的tx_data在preamble帧状态下为10个重复的8比特流“00111100”。图9示出的是在发送数据下的数据处理示意图，通过内部设计的比特流控制模块，Transmit/Receive framer state，计数寄存器，发送数据控制模块等共同产生的控制逻辑使发送的数据进行不同比特流控制，数据读取模块控制着从双端口RAM内读取的数据和数据长度等，对于不同的蓝牙协议模式和配置的寄存器控制的算法需求等可选择控制是否进行比特流序列以及控制某一中间算法的是否进行和相应的数据处理等。图10示出的是在接收数据下的数据处理示意图，通过内部设计的比特流控制模块，Transmit/Receive framer state，计数寄存器，接收数据控制模块等共同产生的控制逻辑使接收的数据进行不同比特流控制，数据写入模块控制着存入到双端口RAM内的数据和数据长度等，对于不同的蓝牙协议和配置的寄存器模块控制进行的算法需求等可选择控制是否进行比特流序列以及控制某一中间算法是否进行和相应的数据处理等。图11示出的是串行数据输出的比特流控制模块示意图，比特流控制模块用于控制从先进先出的数据缓存器/或RAM中读取的数据进行发送数据的串行输出比特流数据的控制和进行通信编码控制处理。如图11所示，比特流控制模块输入信号分别有init_cnt，fec_ready，data_type，reset，clk；模块输出信号分别为bit_cnt，data_bit_cnt，data_bit_cnt_en；其中data_type为数据的通信编码模式寄存器配置信号，其意义如下表二所示，init_cnt为数据传输控制的比特流控制模块内部自加计数器的初始化信号，fec_ready是fec模块产生的fec算法计算有效控制信号，即每一个fec_ready有效时，进行内部比特流的有效计数。reset为控制比特流控制模块内部计数器的复位信号，clk进行比特流控制模块内部比特流的有效计数的时钟信号。图12示出的是串行数据输出的比特流控制模块内部的两个计数器，分别为自减计数器和自加计数器，自减计数器主要根据通信编码模式的不同，根据不同初始值以开启自减计数，load_bit_cnt有效时，自减计数器进行load初始值，对于不同输入的data_type，自减计数器进行load不同的初始值。另外串行数据输出的比特流控制模块内部还含有一个自加计数器，输入信号有init_cnt，data_bit_cnt_en，reset，clk；当输入信号init_cnt为1时，自加计数器的初始化值为0，当data_bit_cnt_en有效时，自加计数器进行自加计数，clk为计数器的时钟信号，reset为计数器的复位信号。图13示出的是串行数据输出的比特流控制模块内部的两个计数器的控制信号逻辑电路图。自减计数器输出的计数值bit_cnt和data_type配置不同的值产生data_bit_cnt_en。data_type配置为00:NRZ law data，图13中的data_nrz为1，data_type配置为01: Manchester data type，图13中的data_man为1，data_type配置为10: 8/10 bits line code，图13中的data8b/10b为1，data_type配置为11:Interleave data type，图13中的data_interleave为1。当输入信号init_cnt为1，或自减计数器的计数值为零时且fec_ready为1时，以上两种情况，都会使load_bit_cnt为1。基于上述的兼容BR与BLE5.2多模蓝牙协议的基带数据收发处理系统，本发明还公开了一种基带数据收发处理方法，包括：通过收发状态机在对与蓝牙基本速率模式、支持BLE5.2协议的非编码物理层模式或支持BLE5.2协议的编码物理层模式相对应的帧结构进行发送和接收时，进行帧结构的跳转，并通过收发状态机产生用于表征帧结构状态的逻辑信号。如图6a所示，通过crc/hec模块、白化模块、fec模块、defec模块、解白化模块和crc/hec校验模块对与蓝牙基本速率模式对应的第一帧结构的分组头header进行对应的hec算法、白化、fec前向纠错的发送处理以及defec解码、解白化和hec算法校验的接收处理。如图6b所示，通过白化模块、解白化模块对与蓝牙基本速率模式对应的第一帧结构的有效载荷payload进行对应的白化的发送处理以及解白化的接收处理。在本实施例中，在对与蓝牙基本速率模式对应的第一帧结构的有效载荷payload进行白化处理之前还通过crc/hec模块、加密模块对第一帧结构的有效载荷进行crc算法和加密的发送处理，以及在对与蓝牙基本速率模式对应的第一帧结构的有效载荷进行白化处理之后还通过编码模块对第一帧结构的有效载荷进行编码的发送处理。在其他实施例中，可以不设置crc算法和加密的发送处理以及编码。在本实施例中，在对与蓝牙基本速率模式对应的第一帧结构的有效载荷进行解白化处理之前还通过解码模块对第一帧结构的有效载荷进行解码的接收处理，以及在对与蓝牙基本速率模式对应的第一帧结构的有效载荷进行解白化处理之后还通过解密模块、crc/hec校验模块对第一帧结构的有效载荷进行解密和crc检验算法的发送处理。在其他实施例中，可以不设置解码、解密和crc检验算法处理。如图6c所示，在其他实施例中，通过crc/hec模块进行crc算法处理和通过加密模块进行加密处理的顺序可以调换，通过解密模块进行解密处理和通过crc/hec校验模块进行crc算法校验处理的顺序也可以调换，从而在白化处理前以及解白化处理前均形成如图6c所示的两条可选路径。如图7所示，通过crc/hec模块、白化模块、解白化模块和crc/hec校验模块对与支持BLE5.2协议的非编码物理层模式对应的第二帧结构的有效载荷进行对应的crc算法和白化的发送处理以及解白化和crc算法校验的接收处理。同时，在对与支持BLE5.2协议的非编码物理层模式对应的第二帧结构的有效载荷进行crc算法之前还通过加密模块对第二帧结构的有效载荷进行加密的发送处理，以及在对与支持BLE5.2协议的非编码物理层模式对应的第二帧结构的有效载荷进行crc检验算法之后还通过解密模块对第二帧结构的有效载荷进行解密的接收处理。在其他实施例中，可以不设置加密和解密的处理。通过crc/hec模块、白化模块、fec模块、映射模块、解映射模块、defec模块、解白化模块和crc校验模块对与支持BLE5.2协议的编码物理层模式对应的第三帧结构的有效载荷进行相应的crc算法、白化、fec和映射的发送处理以及解映射、defec、解白化和crc算法校验的接收处理。同时，在对与支持BLE5.2协议的编码物理层模式对应的第三帧结构的有效载荷进行crc算法之前还通过加密模块对第三帧结构的有效载荷进行加密的发送处理，以及在对与支持BLE5.2协议的编码物理层模式对应的第三帧结构的有效载荷进行crc检验算法之后还通过解密模块对第三帧结构的有效载荷进行解密的接收处理。在其他实施例中，可以不设置加密和解密的处理。在本实施例中，通过计数寄存器基于当前的蓝牙协议以及表征当前的帧结构状态的逻辑信号产生计数值，通过收发状态机基于计数值进行帧结构的跳转。在本实施例中，通过发送数据控制模块基于当前的蓝牙协议、表征帧结构状态的逻辑信号以及计数寄存器的计数值产生与当前帧结构状态对应的码流。在本实施例中，通过比特流控制模块控制各模块输出数据流的有效性。前述对本发明的具体示例性实施方案的描述是为了说明和例证的目的。这些描述并非想将本发明限定为所公开的精确形式，并且很显然，根据上述教导，可以进行很多改变和变化。对示例性实施例进行选择和描述的目的在于解释本发明的特定原理及其实际应用，从而使得本领域的技术人员能够实现并利用本发明的各种不同的示例性实施方案以及各种不同的选择和改变。本发明的范围意在由权利要求书及其等同形式所限定。
