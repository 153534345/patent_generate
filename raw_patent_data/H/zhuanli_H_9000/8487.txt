标题title
一种整车FOTA升级系统及方法
摘要abst
本发明公开了一种整车FOTA升级系统及方法，系统包括：FOTA升级云端和搭载有Autosar AP平台的FOTA升级车载终端；FOTA升级云端响应升级命令，创建升级任务，对升级包进行加密和管理，并下发含有升级包的升级任务给车载终端及对FOTA升级进度和结果的状态维护；车载终端利用Autosar AP平台的FOTA Services组件，接收FOTA升级云端的升级任务并下载升级包，生成配置文件用于判断车载终端能否进行升级，当能够升级时解密和验签升级包以及控制升级包的传输和刷写方式对DOIP ECU或CAN ECU进行升级，校验升级结果及上报FOTA升级进度和结果给FOTA升级云端。本发明能够升级DOIP和CAN的ECU；实现多节点及单节点的串行和并行刷写，减少升级时间；回滚合理；基于配置文件获取升级包，提高升级效率。
权利要求书clms
1.一种整车FOTA升级系统，其特征在于，包括：FOTA升级云端和搭载有Autosar AP平台的FOTA升级车载终端，两者通过无线网络通信；所述FOTA升级云端，用于响应升级命令，创建升级任务，对升级包进行加密和管理，并下发含有升级包的升级任务给所述车载终端，以及对FOTA升级进度和结果的状态维护；所述车载终端利用Autosar AP平台的FOTA Services组件，接收所述FOTA升级云端的升级任务并下载升级包，生成配置文件用于判断车载终端能否进行升级，当能够升级时解密和验签升级包以及控制升级包的传输和刷写方式对DOIP ECU或CAN ECU进行升级，校验升级结果以及上报FOTA升级进度和结果给所述FOTA升级云端。2.根据权利要求1所述的整车FOTA升级系统，其特征在于，所述FOTA Services组件，包括：FOTA Master、UCM Master和UCM DOIP；所述FOTA Master，负责与FOTA升级云端通信，用于接收所述FOTA升级云端的升级任务并下载升级包，生成配置文件并传输给UCM Master用以通知UCM Master进行升级，以及上报FOTA升级进度和结果给所述FOTA升级云端；所述UCM Master，根据FOTA Master传输的配置文件，进行解析后传给对应UCM DOIP，控制UCM DOIP的升级，以及上报升级进度和结果给FOTA Master；所述UCM DOIP，基于UCM Master传输的文件，解析出升级包的本地存储路径及解密信息，对升级包进行解密和验签，并在UCM Master的控制下对DOIP ECU或CAN ECU进行FOTA升级。3.根据权利要求2所述的整车FOTA升级系统，其特征在于，所述配置文件，包括：升级前置条件、UCM DOIP名称、ECU升级配置文件、以及ECU传输及刷写顺序配置文件；所述升级前置条件，用于判断车载终端能否进行升级，其包括：车载终端电量、车载终端是否充电以及车载终端工作状态；所述UCM DOIP名称，用于配置及存储需控制升级的UCM DOIP名称；所述ECU升级配置文件，用于配置及存储升级包的本地存储路径以及各ECU所属功能组；所述ECU传输及刷写顺序配置文件，用于配置及存储所述ECU升级配置文件中升级包的传输方式以及ECU的刷写方式。4.根据权利要求3所述的整车FOTA升级系统，其特征在于，所述升级包的传输方式，包括：串行传输方式和并行传输方式。5.根据权利要求3所述的整车FOTA升级系统，其特征在于，所述ECU的刷写方式，包括：单ECU串行刷写、单ECU并行刷写、多ECU串行刷写以及多ECU并行刷写。6.根据权利要求4或5所述的整车FOTA升级系统，其特征在于，所述升级的过程，包括：升级包的传输、ECU刷写、激活、校验及回滚。7.根据权利要求6所述的整车FOTA升级系统，其特征在于，所述回滚的过程，包括：基于所述ECU升级配置文件中各ECU所属功能组，由UCM Master统一控制，遍历所有ECU刷写结果，当ECU刷写失败时，对其所属功能组相同的所有ECU进行回滚。8.根据权利要求2所述的整车FOTA升级系统，其特征在于，所述升级进度和结果，包括：刷写中、刷写成功、刷写失败、回滚中、回滚成功和回滚失败。9.根据权利要求2所述的整车FOTA升级系统，其特征在于，所述UCM Master与FOTAMaster和所述UCM DOIP均通过Autosar Ap平台中的预设组件进行通信。10.一种整车FOTA升级方法，其特征在于，包括：FOTA升级云端响应升级命令，创建升级任务，对升级包进行加密和管理，并下发含有升级包的升级任务给车载终端，以及对FOTA升级进度和结果的状态维护；所述车载终端利用Autosar AP平台的FOTAServices组件，接收所述FOTA升级云端的升级任务并下载升级包，生成配置文件用于判断车载终端能否进行升级，当能够升级时解密和验签升级包以及控制升级包的传输和刷写方式对DOIP ECU或CAN ECU进行升级，校验升级结果以及上报FOTA升级进度和结果给所述FOTA升级云端。
说明书desc
技术领域本发明涉及FOTA升级技术领域，涉及一种整车FOTA升级系统及方法。背景技术随着汽车智能化程度越来越高以及人们对车辆舒适性和安全性要求的提高，车辆FOTA移动终端的空中下载软件升级功能成为了车辆的标配，方便车辆出厂后进行功能升级和问题修复，FOTA升级是通过远程方式对整车的ECU电子控制单元进行刷写。然而，现有车辆ECU数量从几十到上百个，对整车ECU升级需要消耗大量时间；并且各个ECU之间可能有依赖关系，必须同时升级成功才能正常工作。因此，对车端应用的更新需要一套合理流程才能保证车辆ECU顺利升级。当前，Autosar AP平台的UCM组件提供了车端应用更新方法。UCM组件负责在Adaptive平台上更新，安装，删除和保留软件记录。它的作用类似于Linux中的dpkg软件包管理系统，其功能可确保以安全可靠的方式更新或修改Adaptive平台上的软件。然而，目前UCM组件在实际使用的过程中有一些局限性：1、只能安装、更新、删除Adaptive平台上的应用软件，对于车辆中的ECU，大多数ECU是基于CAN控制器域网的ECU，Adaptive平台缺乏完整、成熟的解决方案。2、一个UCM节点只能刷写一个ECU，并且刷写时，只能串行处理多个软件包。3、回滚设置简单，当一个ECU刷写失败，整车ECU都进入回滚，严重影响了整车升级进度。4、UCM Master需要将软件包传输给各个UCM，当软件包较大且较多时，传输升级包会消耗大量时间，影响升级效率。如何解决目前Autosar AP中UCM存在的问题，提高整车的升级进度和效率是目前亟待解决的问题。发明内容因此，本发明提供了一种整车FOTA升级系统及方法，能够升级车端任意支持DOIP和CAN的ECU；能够实现多节点串、并行刷写及单节点串、并行刷写，减少升级时间；回滚设置合理，只回滚功能组相同ECU，提高升级效率；对配置文件解析后获取升级包本地存储路径，节约升级时间，提高升级效率，以解决上述背景技术中提出的问题。为达到上述目的，本发明提供如下技术方案：第一方面，本发明实施例提供一种整车FOTA升级系统，包括：FOTA升级云端和搭载有Autosar AP平台的FOTA升级车载终端，两者通过无线网络通信；FOTA升级云端，用于响应升级命令，创建升级任务，对升级包进行加密和管理，并下发含有升级包的升级任务给车载终端，以及对FOTA升级进度和结果的状态维护；车载终端利用Autosar AP平台的FOTA Services组件，接收FOTA升级云端的升级任务并下载升级包，生成配置文件用于判断车载终端能否进行升级，当能够升级时解密和验签升级包以及控制升级包的传输和刷写方式对DOIP ECU或CAN ECU进行升级，校验升级结果以及上报FOTA升级进度和结果给FOTA升级云端。可选地，FOTA Services组件，包括：FOTA Master、UCM Master和UCM DOIP；FOTAMaster，负责与FOTA升级云端通信，用于接收FOTA升级云端的升级任务并下载升级包，生成配置文件并传输给UCM Master用以通知UCM Master进行升级，以及上报FOTA升级进度和结果给FOTA升级云端；UCM Master，根据FOTAMaster传输的配置文件，进行解析后传给对应UCM DOIP，控制UCM DOIP的升级，以及上报升级进度和结果给FOTA Master；UCM DOIP，基于UCM Master传输的文件，解析出升级包的本地存储路径及解密信息，对升级包进行解密和验签，并在UCM Master的控制下对DOIP ECU或CAN ECU进行FOTA升级。可选地，配置文件，包括：升级前置条件、UCM DOIP名称、ECU升级配置文件、以及ECU传输及刷写顺序配置文件；升级前置条件，用于判断车载终端能否进行升级，其包括：车载终端电量、车载终端是否充电以及车载终端工作状态；UCM DOIP名称，用于配置及存储需控制升级的UCM DOIP名称；ECU升级配置文件，用于配置及存储升级包的本地存储路径以及各ECU所属功能组；ECU传输及刷写顺序配置文件，用于配置及存储ECU升级配置文件中升级包的传输方式以及ECU的刷写方式。可选地，升级包的传输方式，包括：串行传输方式和并行传输方式。可选地，ECU的刷写方式，包括：单ECU串行刷写、单ECU并行刷写、多ECU串行刷写以及多ECU并行刷写。可选地，升级的过程，包括：升级包的传输、ECU刷写、激活、校验及回滚。可选地，回滚的过程，包括：基于ECU升级配置文件中各ECU所属功能组，由UCMMaster统一控制，遍历所有ECU刷写结果，当ECU刷写失败时，对其所属功能组相同的所有ECU进行回滚。可选地，升级进度和结果，包括：刷写中、刷写成功、刷写失败、回滚中、回滚成功和回滚失败。可选地，UCM Master与FOTAMaster和UCM DOIP均通过Autosar Ap平台中的预设组件进行通信。第二方面，本发明实施例提供一种整车FOTA升级方法，包括：FOTA升级云端响应升级命令，创建升级任务，对升级包进行加密和管理，并下发含有升级包的升级任务给车载终端，以及对FOTA升级进度和结果的状态维护；车载终端利用Autosar AP平台的FOTAServices组件，接收FOTA升级云端的升级任务并下载升级包，生成配置文件用于判断车载终端能否进行升级，当能够升级时解密和验签升级包以及控制升级包的传输和刷写方式对DOIP ECU或CAN ECU进行升级，校验升级结果以及上报FOTA升级进度和结果给FOTA升级云端。本发明技术方案，具有如下优点：本发明提供的整车FOTA升级系统及方法，系统包括：FOTA升级云端和搭载有Autosar AP平台的FOTA升级车载终端，两者通过无线网络通信；FOTA升级云端，用于响应升级命令，创建升级任务，对升级包进行加密和管理，并下发含有升级包的升级任务给车载终端，以及对FOTA升级进度和结果的状态维护；车载终端利用Autosar AP平台的FOTAServices组件，接收FOTA升级云端的升级任务并下载升级包，生成配置文件用于判断车载终端能否进行升级，当能够升级时解密和验签升级包以及控制升级包的传输和刷写方式对DOIP ECU或CAN ECU进行升级，校验升级结果以及上报FOTA升级进度和结果给FOTA升级云端。通过本发明能够升级车端任意支持DOIP和CAN的ECU；能够实现多节点串、并行刷写及单节点串、并行刷写，减少升级时间；回滚设置合理，只回滚功能组相同ECU，提高升级效率；对配置文件解析后获取升级包本地存储路径，节约升级时间，提高升级效率。附图说明为了更清楚地说明本发明具体实施方式或现有技术中的技术方案，下面将对具体实施方式或现有技术描述中所需要使用的附图作简单地介绍，显而易见地，下面描述中的附图是本发明的一些实施方式，对于本领域普通技术人员来讲，在不付出创造性劳动的前提下，还可以根据这些附图获得其他的附图。图1本发明实施例中提供的整车FOTA升级系统的结构示意图；图2本发明实施例中提供的FOTAServices组件的架构图；图3本发明实施例中提供的UCM DOIP升级过程的状态转换图；图4本发明实施例中提供的ECU刷写过程的示意图；图5本发明实施例中提供的回滚状态的流程图；图6本发明实施例中提供的回滚过程的流程图；图7本发明实施例中提供的整车FOTA升级方法的流程图。具体实施方式为了使本技术领域的人员更好地理解本发明方案，下面将结合本发明实施例中的附图，对本发明实施例中的技术方案进行清楚、完整地描述，显然，所描述的实施例仅是本发明一部分的实施例，不是全部的实施例，而并非要限制本发明公开的范围。此外，在以下说明中，省略了对公知结构和技术的描述，以避免不必要的混淆本发明公开的概念。基于本发明中的实施例，本领域普通技术人员在没有做出创造性劳动前提下所获得的所有其他实施例，都应当属于本发明保护的范围。此外，下面所描述的本发明不同实施方式中所涉及的技术特征只要彼此之间未构成冲突就可以相互结合。实施例1本发明实施例提供一种整车FOTA升级系统，如图1所示，包括：FOTA升级云端和搭载有Autosar AP平台的FOTA升级车载终端，两者通过无线网络通信；FOTA升级云端，用于响应升级命令，创建升级任务，对升级包进行加密和管理，并下发含有升级包的升级任务给车载终端，以及对FOTA升级进度和结果的状态维护；车载终端利用Autosar AP平台的FOTAServices组件，接收FOTA升级云端的升级任务并下载升级包，生成配置文件用于判断车载终端能否进行升级，当能够升级时解密和验签升级包以及控制升级包的传输和刷写方式对DOIP ECU或CAN ECU进行升级，校验升级结果以及上报FOTA升级进度和结果给FOTA升级云端。需要说明的是，目前车辆大多数ECU是CAN ECU，AutosarAP平台没有完整、成熟的升级方案，本发明将AutosarAP与DOIP结合，可以刷写车载终端中任意支持DOIP和CAN的ECU。对于CAN ECU，其通过DOIP ECU作为信息中转，实现CAN ECU与FOTAServices组件的通信。本发明提供的FOTA Services组件的架构图，如图2所示，包括：FOTA Master、UCMMaster和UCM DOIP。其中，FOTA Master，负责与FOTA升级云端通信，用于接收FOTA升级云端的升级任务并下载升级包，生成配置文件并传输给UCM Master用以通知UCM Master进行升级，以及上报FOTA升级进度和结果给FOTA升级云端。本实施例FOTA Master与UCM Master通过Autosar Ap平台中的预设组件进行通信。具体地，预设组件为Autosar Ap平台中的ara::com组件，仅作为举例说明，依据不同场景做适应性修改。本实施例中，配置文件，包括：升级前置条件、UCM DOIP名称、ECU升级配置文件、以及ECU传输及刷写顺序配置文件。其中，升级前置条件，用于判断车载终端能否进行升级，其包括：车载终端电量、车载终端是否充电以及车载终端工作状态。具体地，当车载终端电量大于85％，车载终端未进行充电以及车载终端停止工作时，即满足升级前置条件时，此时的车载终端能够进行升级；UCM DOIP名称，用于配置及存储需控制升级的UCM DOIP名称；ECU升级配置文件，用于配置及存储升级包的本地存储路径以及各ECU所属功能组；ECU传输及刷写顺序配置文件，用于配置及存储ECU升级配置文件中升级包的传输方式以及ECU的刷写方式。如图2所示，UCM Master根据FOTA Master传输的配置文件，进行解析后传给对应UCM DOIP，控制UCM DOIP的升级，以及上报升级进度和结果给FOTA Master。具体地，UCMMaster根据FOTAMaster传输过来的配置文件，解析出需要升级的ECU升级配置文件，并根据配置文件中的UCM DOIP名称将ECU升级配置文件传输给对应的UCM DOIP，控制UCM DOIP对DOIP ECU或CAN ECU的升级，以及上报各ECU的升级进度和结果给FOTA Master。本实施例中，升级进度和结果，包括：刷写中、刷写成功、刷写失败、回滚中、回滚成功和回滚失败。本实施例中，UCM Master与UCM DOIP通过Autosar Ap平台中的预设组件进行通信。具体地，预设组件为Autosar Ap平台中的ara::com组件，仅作为举例说明，依据不同场景做适应性修改。如图2所示，UCM DOIP基于UCM Master传输的文件，解析出升级包的本地存储路径及解密信息，对升级包进行解密和验签，并在UCM Master的控制下对DOIP ECU或CAN ECU进行FOTA升级。本实施例中，UCM DOIP可以同时部署在多个ECU节点上，统一由UCM Master协调控制，多UCM DOIP同时工作，提高升级效率。具体地，UCM DOIP与ECU之间通过DOIP协议通信，DOIP是基于车载以太网的诊断协议，其带宽高，非常适合FOTA传输大量数据的场景。此外，对于不支持DOIP的ECU，其可以通过CAN总线与支持DOIP的ECU通信，即DOIP ECU作为信息中转，实现CAN ECU与FOTA Services组件的通信，通过CAN总线将升级包传输给对应ECU，从而完成ECU的FOTA升级。本发明提供的UCM DOIP升级过程的状态转换，如图3所示，UCM DOIP的升级过程包括：升级包的传输、ECU刷写、激活、校验及回滚。其中，升级包的传输方式，包括：串行传输方式和并行传输方式。具体地，正常情况下，UCM DOIP处于空闲状态，基于UCM Master的控制，进行相应升级状态转换。一具体实施例中，UCM DOIP在空闲状态由UCM Master发送transfer指令进入安装包传输状态，并解析传输过来的配置文件，对升级包进行解密和验签。具体地，一次传输过程可以传输单个ECU的升级包或多个ECU的升级包，当一次传输过程传输为单个升级包时，对应升级包的串行传输；当一次传输过程传输为多个升级包时，对应升级包的并行传输，后续多个升级包将会进行串行或并行刷写。传输状态可以多次传输配置文件并解析，传输的配置文件按顺序标记序号t_index。在传输状态时，若UCMMaster发送cancel指令，UCM DOIP进入空闲状态，此次升级取消。当传输状态完成时，进入ECU刷写状态，由UCM Master发送process指令进入刷写状态。本实施例中，ECU的刷写方式，包括：单ECU串行刷写、单ECU并行刷写、多ECU串行刷写以及多ECU并行刷写。具体地，在刷写状态UCM DOIP根据传输过来的t_idnex序号开始刷写ECU，如果传输t_index时有多个ECU，则多个ECU并行刷写。在一次刷写完成后，可以多次发送process指令刷写后续ECU，实现串行刷写。一具体实施例中，为提高FOTA升级效率，本发明提供的ECU刷写过程，如图4所示，其中，UCM Master和名称为DP1的UCM DOIP部署在车载终端控制器VCU1上，同理车载终端控制器VCU2和VCU3分别部署UCM DOIP的DP2和DP3，UCM Master通过ara::com组件与DP1、DP2、DP3通信。配置文件相关设置下表所示：其中，设置了UCM DOIP DP1、DP2和DP1，以及其对应刷写顺序和包含ECU的刷写方式，具体包含以下刷写方式：a.单节点串行、并行刷写例如，如图4所示，在VCU1中，UCM DOIP DP1根据表1配置文件中的相关设置，同时刷写ECU1和ECU2，实现UCM DOIP DP1单节点的ECU1和ECU2的并行刷写。在VCU2中，根据表1配置文件中的相关设置，UCM DOIP DP2可以串行刷写ECU3和ECU4，实现UCM DOIP DP2单节点的ECU3和ECU4的串行刷写。b.多节点串行、并行刷写例如，根据表1配置文件中的相关设置，UCM Master在刷写的顺序序号1中，UCMMaster同时控制DP1和DP2进行刷写操作，此时，DP1和DP2实现了多节点并行刷写；在它们完成刷写后，UCM Master控制DP3开始刷写，实现单节点串行刷写。本实例中，在刷写状态完成后，由UCM Master发送activate指令进入激活状态。具体地，在激活状态，UCM DOIP会等待ECU刷写完成，并读取刷写ECU的升级后的版本号。直到ECU全部刷写并读取完所有刷写ECU的升级后的版本号时，进入校验状态，由UCM Master发送verify指令进入校验状态。本实例中，在校验状态时，UCM DOIP将ECU的期望版本号与激活状态获取到ECU版本号作对比，如果ECU对比结果一致，即校验成功，则此ECU刷写成功，进入空闲状态，刷写完成。如果ECU对比结果不一致，即校验失败，则此ECU进入回滚状态，开始回滚过程。本实施例中，回滚的过程包括：基于ECU升级配置文件中各ECU所属功能组，由UCMMaster统一控制，遍历所有ECU刷写结果，当ECU刷写失败时，对其所属功能组相同的所有ECU进行回滚。具体地，回滚状态的流程示意图，如图5所示，当处于回滚状态时，首先会遍历所有ECU的刷写结果，并校验ECU的刷写结果，如果有ECU刷写失败，则会将与此ECU相同功能组的所有ECU保存下来，后续对这些ECU进行回滚。本发明ECU按功能分组，回滚时，只回滚相同功能组的ECU，其他ECU不受影响，提高了升级效率。具体地，回滚过程的流程示意图，如图6所示，回滚时，根据回滚的ECU查询本地保存的上次刷写的ECU版本，如果版本不存在，则认为回滚失败，并上报无可回滚版本；如果版本存在，则开始刷写此版本固件到ECU，当所有待回滚的ECU刷写完成时，上报回滚结果，回滚过程结束。回滚完成后，进入空闲状态，升级完成。本发明提供的整车FOTA升级系统，将AutosarAP与DOIP结合，能够升级车端任意支持DOIP和CAN的ECU；能够多节点部署UCM DOIP，实现多节点串、并行刷写及单节点串、并行刷写，减少升级时间；回滚设置合理，只回滚功能组相同ECU，提高升级效率；UCM Master通过传输配置文件而不是升级包给UCM DOIP，UCM DOIP通过解析配置文件，获取到升级的本地路径来处理升级包，节约了升级时间，提高了升级效率。实施例2本发明实施例提供一种整车FOTA升级方法，基于实施例1中的整车FOTA升级系统，如图7所示，该方法包括以下步骤：步骤S1：FOTA升级云端响应升级命令，创建升级任务，对升级包进行加密和管理，并下发含有升级包的升级任务给车载终端，以及对FOTA升级进度和结果的状态维护。一具体实施例中，车厂下发车载终端升级的命令，FOTA升级云端响应升级命令，并进行后续升级相关操作，仅作为举例说明，依据实际应用场景做适应性修改。步骤S2：车载终端利用Autosar AP平台的FOTA Services组件，接收FOTA升级云端的升级任务并下载升级包，生成配置文件用于判断车载终端能否进行升级，当能够升级时解密和验签升级包以及控制升级包的传输和刷写方式对DOIP ECU或CAN ECU进行升级，校验升级结果以及上报FOTA升级进度和结果给FOTA升级云端。本发明提供的整车FOTA升级方法，能够在多操作系统进行部署，包括：QNX、Linux和Android操作系统，该升级方法兼容性和适配性强，能够有效节约升级时间，提高升级效率。显然，上述实施例仅是为清楚地说明所作的举例，而并非对实施方式的限定。对于所属领域的普通技术人员来说，在上述说明的基础上还可以做出其它不同形式的变化或变动。这里无需也无法对所有的实施方式予以穷举。而由此所引申出的显而易见的变化或变动仍处于本发明创造的保护范围之中。
