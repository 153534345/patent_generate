标题title
一种基于哈希表的报文协议超时重发管理方法
摘要abst
本发明属于计算机控制技术领域，公开了一种基于哈希表的报文协议超时重发管理方法，基于哈希表数据结构，通过一种新型管理结构，将报文重发的过程信息全部记录到哈希表中，对于超时重发的管理仅需在定时器中不断查询关联容器中的报文应答状态，即可高效地完成超时应答管理。
权利要求书clms
1.一种基于哈希表的报文协议超时重发管理方法，其特征在于，包括以下步骤：S1：报文需要进行超时重发时，设计系统间报文协议以及在报文发送出去后目的节点接收到报文后需要回复的接收确认帧，即应答帧；S2：定义总线载体BusInfo，S3：定义重发管理结构体MainReSend，S4：定义一个哈希表类Hash型变量gSndQ，此哈希表用来存储帧发送出去的信息，S5：在发送报文端，报文内容填充完成并发送；S6：报文接收线程中，接收应答帧，并在哈希表中标记处理；S7：设置重发处理定时器，启动定时器，遍历重发管理结构体，判断是否重发，重发则转S8；S8：重发管理结构体变量中计数器进行加一操作，对报文进行重发。2.如权利要求1所述的基于哈希表的报文协议超时重发管理方法，其特征在于，步骤S1中，系统间报文协议定为变长协议，包括：两个字节的协议帧头FrmHead，四个字节的帧序号FrmNum，使用帧序号进行ID标记，帧序号是对应应答帧的唯一标识ID，一个字节的此标识ID重发次数ReCnt，两个字节的帧长度FrmLen，两个字节的帧类型FrmType，四个字节的目的地址FrmDst、四个字节的源地址FrmSrc，两个字节的应答标识FrmACKFlag，此标识用来表示该帧是否需要应答，两个字节的功能码FrmCode，字节数不定的负载内容FrmContent，两个字节的校验FrmChk，以及两个字节的帧结尾FrmTail。3.如权利要求2所述的基于哈希表的报文协议超时重发管理方法，其特征在于，步骤S1中，应答帧ACK的帧头部分和帧尾部分与上述报文一致，内容为四个字节的帧序号的帧序号，两个字节的功能码；发送帧与应答帧帧协议相互关联时以帧序号进行关联。4.如权利要求3所述的基于哈希表的报文协议超时重发管理方法，其特征在于，步骤S2中，总线载体BusInfo包含两个元素，分别为：①总线类型，此类型为枚举型，0表示以太网发送，1表示串口发送，2表示CAN总线发送；②需要发送数据的目的地址，类型为整型，根据总线类型确定为目的IP地址，串口端口号，以及CAN总线端口号。5.如权利要求4所述的基于哈希表的报文协议超时重发管理方法，其特征在于，步骤S3中，重发管理结构体MainReSend内容：①S2中定义的总线载体BusInfo，②要发送数据的内存地址Addr，类型为无符号指针型，③是否重发标志IsReSnd，设置为无符号字符型，值为1时表示需要重发，为0时表示不需要重发，④已发送次数计数HaSnCnt，设置为无符号整型，表示此数据已经发送的次数，⑤需要重发的次数NeSnCnt，此变量设置为无符号短整型。6.如权利要求5所述的基于哈希表的报文协议超时重发管理方法，其特征在于，步骤S4中，哈希表类Hash型变量gSndQ中，键key的类型设置为整型int型，这个值为发送帧的帧序号；值value设置为结构体类型，此结构体为S3中定义的重发管理结构体MainReSend。7.如权利要求6所述的基于哈希表的报文协议超时重发管理方法，其特征在于，步骤S5中，报文内容填充完成并发送时，判断应答标识FrmACKFlag是否为0xFF00，如果判断失败，表示此报文不需要根据应答重发；如果判断成功，则定义一个重发管理结构体变量gMReSend，以及SeqNum变量记录报文序号；根据选择的物理端口类型以及端口地址信息填充变量gMReSend中总线载体内容，将要发送的数据的首地址gDataAddr赋值给结构体中Addr内容，将结构体变量中的是否重发标志设置为TURE，结构体中已重发的次数HaSnCnt设置为0，将结构体变量中的需要重发的次数NeSnCnt设置为TIMES_SET，使用中哈希表Hsh中插入方法insert将报文序号SeqNum以及重发管理结构体变量gMReSend，等待后面遍历查询，此时报文已经发送出去。8.如权利要求7所述的基于哈希表的报文协议超时重发管理方法，其特征在于，步骤S6中，当接收到应答报文的时候，将协议中的帧序号提取出来，使用哈希表Hash中的遍历查询方法查询该帧序号键值，是否在哈希表存储空间中，如果查找成功，则将结构体变量中的是否重发标志设置为FALSE，等待遍历过程中该键值对从哈希表中移除。9.如权利要求8所述的基于哈希表的报文协议超时重发管理方法，其特征在于，步骤S7中，定时器设置周期时间为RATES，在定时器回调函数中，通过匹配帧序号遍历重发管理结构体变量的键，对于遍历到的每一个帧序号，通过gSndQ下标索引方式判断其中gMReSend中是否重发标志是否为FALSE，若为FALSE则使用哈希表Hash中的移除remove方法，将该序号对应内容全部从队列中移除；如果为TRUE，则转到S8。10.如权利要求9所述的基于哈希表的报文协议超时重发管理方法，其特征在于，步骤S8中，重发管理结构体变量中gMReSend计数器进行加一操作，重发管理结构体变量中的计数器对TIMES_SET进行取余操作，当这个值为TIMES_SET-1的时候，对报文进行重发，将要发送的数据以及发送的总线信息，传入到系统底层的发送函数中进行发送，同时将重发结构体变量中的发送次数进行加一操作；在定时器触发的过程中，周期性进行S8的操作，每次重发结构体发送次数进行加一操作，如果重发过程中查询到帧序号匹配，则重发结束，将该键值对从gSndQ中移除；否则移植进行重发操作，当重发次数达到预设次数TIMES_SEND时，将该键值对从gSndQ中移除，表示重发已经达到最大次数，对超时未应答进行提示。
说明书desc
技术领域本发明属于计算机控制技术领域，涉及一种基于哈希表的报文协议超时重发管理方法。背景技术哈希表是根据关键码值而直接进行访问的数据结构。把关键码值映射到表中的一个位置进行记录，增加查找的速度。哈希表通过关键值计算直接获取目标位置，对于海量数据的精确查找有着明显的数据提升，随着数据量增大，哈希表可以保持O的查找速度，而普通列表只能保持O的查找速度。消息重发机制是保证总线数据交互中出现数据错帧、乱帧、丢帧后数据可达的机制。传统的系统间报文超时重发管理通常采用数组标记的方式进行管理，对于不同的报文类型，报文发送后在数组中标记是否需要应答，对于不断增加需要应答的报文数量，数组的长度需要不断增加，造成了系统运行负载的增大，计算机控制系统中需要打开定时器进行计数，此定时器用来判断不同定时报文的超时应答。当报文重发的时候，需要找到发送的总线信息，内容，长度等信息，一般为全局共有变量，从第一次发送到超时未应答后发送中间变量以及数据的值都可能被程序的其其它部分篡改，导致两次发送数据内容并非完全一致。发明内容发明目的本发明的目的是：提供一种基于哈希表的报文协议超时重发管理方法，解决现有技术中超时应答数据不一致的问题。技术方案为了解决上述技术问题，本发明提供一种基于哈希表的报文协议超时重发管理方法，其包括以下步骤：S1：报文需要进行超时重发时，设计系统间报文协议以及在报文发送出去后目的节点接收到报文后需要回复的接收确认帧，即应答帧；S2：定义总线载体BusInfo，S3：定义重发管理结构体MainReSend，S4：定义一个哈希表类Hash型变量gSndQ，此哈希表用来存储帧发送出去的信息，S5：在发送报文端，报文内容填充完成并发送；S6：报文接收线程中，接收应答帧，并在哈希表中标记处理；S7：设置重发处理定时器，启动定时器，遍历重发管理结构体，判断是否重发，重发则转S8；S8：重发管理结构体变量中计数器进行加一操作，对报文进行重发。有益效果上述技术方案所提供的基于哈希表的报文协议超时重发管理方法，基于哈希表数据结构，通过一种新型管理结构，将报文重发的过程信息全部记录到哈希表中，对于超时重发的管理仅需在定时器中不断查询关联容器中的报文应答状态，即可高效地完成超时应答管理。附图说明图1为本发明实施例基于哈希表的报文协议超时重发管理方法的流程图。具体实施方式为使本发明的目的、内容和优点更加清楚，下面结合附图和实施例，对本发明的具体实施方式作进一步详细描述。如图1所示，本实施例基于哈希表的报文协议超时重发管理方法包括以下步骤：S1：在报文需要进行超时重发时，所设计的协议中需要带有应答特性，在报文发送出去后目的节点接收到报文后需要回复接收确认帧。S1_1设计系统间报文协议，协议定为变长协议，包括两个字节的协议帧头FrmHead，包括四个字节的帧序号FrmNum，使用帧序号进行ID标记，帧序号是对应应答帧的唯一标识ID，一个字节的此标识ID重发次数ReCnt，两个字节的帧长度FrmLen，两个字节的帧类型FrmType，四个字节的目的地址FrmDst、四个字节的源地址FrmSrc，两个字节的应答标识FrmACKFlag，此标识用来表示该帧是否需要应答，两个字节的功能码FrmCode，字节数不定的负载内容FrmContent，两个字节的校验FrmChk，两个字节的帧结尾FrmTail。S1_2设置应答帧ACK的帧头部分和帧尾部分与上述报文一致，内容为四个字节的帧序号的帧序号，两个字节的功能码。发送帧与应答帧帧协议相互关联时以帧序号进行关联的，这样设计能清晰追溯帧地应答状态。S2：定义总线载体BusInfo，共包含两个元素，分别为①总线类型，此类型为枚举型，0表示以太网发送，1表示串口发送，2表示CAN总线发送②需要发送数据的目的地址，类型为整型，根据总线类型确定为目的IP地址，串口端口号，以及CAN总线端口号。S3：定义重发管理结构体MainReSend，结构体内容为，①S2中定义的总线载体BusInfo②要发送数据的内存地址Addr，类型为无符号指针型。③是否重发标志IsReSnd，设置为无符号字符型，值为1时表示需要重发，为0时表示不需要重发④已发送次数计数HaSnCnt，设置为无符号整型，表示此数据已经发送的次数⑤需要重发的次数NeSnCnt，此变量设置为无符号短整型。S4：定义一个哈希表类Hash型变量gSndQ，此哈希表用来存储帧发送出去的信息，其中键的类型设置为整型，这个值为发送帧的帧序号，值设置为结构体类型，此结构体为S3中定义的重发管理结构体MainReSend。S5：在发送报文端，报文内容填充完成并发送时，判断应答标识FrmACKFlag是否为0xFF00，如果判断失败，表示此报文不需要根据应答重发。如果判断成功，则定义一个重发管理结构体变量gMReSend，以及SeqNum变量记录报文序号。根据选择的物理端口类型以及端口地址信息填充变量gMReSend中总线载体内容，将要发送的数据的首地址gDataAddr赋值给结构体中Addr内容，将结构体变量中的是否重发标志设置为TURE，结构体中已重发的次数HaSnCnt设置为0，将结构体变量中的需要重发的次数NeSnCnt设置为TIMES_SET，使用中哈希表Hsh中插入方法insert将报文序号SeqNum以及重发管理结构体变量gMReSend，等待后面遍历查询，此时报文已经发送出去。S6：在报文接收线程中，接收应答帧，当接收到应答报文的时候，将协议中的帧序号提取出来，使用哈希表Hash中的遍历查询方法查询该帧序号键值，是否在哈希表存储空间中，如果查找成功，则将将结构体变量中的是否重发标志设置为FALSE，等待遍历过程中该键值对从哈希表中移除。S7：设置重发处理定时器，启动定时器，定时器设置周期时间为RATES,在定时器回调函数中，通过匹配帧序号遍历重发管理结构体变量的键，对于遍历到的每一个帧序号，通过gSndQ下标索引方式判断其中gMReSend中是否重发标志是否FALSE，若为FALSE则使用哈希表Hash中的移除remove方法，将该序号对应内容全部从队列中移除。如果为TRUE，则转到S8。S8：重发管理结构体变量中gMReSend计数器进行加一操作，重发管理结构体变量中的计数器对TIMES_SET进行取余操作，当这个值为TIMES_SET-1的时候，需要对报文进行重发，将要发送的数据以及发送的总线信息，传入到系统底层的发送函数中进行发送。同时将重发结构体变量中的发送次数进行加一操作。在定时器触发的过程中，周期性进行S8的操作，每次重发结构体发送次数进行加一操作，如果重发过程中查询到帧序号匹配，则重发结束，将该键值对从gSndQ中移除。否则移植进行重发操作，当重发次数达到预设次数TIMES_SEND时，将该键值对从gSndQ中移除，表示重发已经达到最大次数，对超时未应答进行提示。以上所述仅是本发明的优选实施方式，应当指出，对于本技术领域的普通技术人员来说，在不脱离本发明技术原理的前提下，还可以做出若干改进和变形，这些改进和变形也应视为本发明的保护范围。
