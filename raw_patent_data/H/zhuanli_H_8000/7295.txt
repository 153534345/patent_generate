标题title
一种车载设备的校时方法及存储介质
摘要abst
一种车载设备的校时方法及存储介质，涉及一种车载设备的校时方法及存储介质。本发明为解决机车车载设备无法满足以最高优先级响应校时器的校时命令导致校时时间存在不够准确的问题。本发明首先，根据校时器获取的车载设备的时间T0，计算车载设备时间与校时器时间T1的差值ΔT＝T1–，其中Ttrans为传输延迟；然后，校时器发送校时命令，将差值ΔT发给车载设备，车载设备根据时间差值ΔT调整时间。本发明用于车载设备的校时。
权利要求书clms
1.一种车载设备的校时方法，其特征在于，包括以下步骤：首先，根据校时器获取的车载设备的时间T0，计算车载设备时间与校时器时间T1的差值ΔT＝T1–，其中Ttrans为传输延迟；然后，校时器发送校时命令，将差值ΔT发给车载设备，车载设备根据时间差值ΔT调整时间。2.根据权利要求1所述的一种车载设备的校时方法，其特征在于，根据校时器获取的车载设备的时间T0之前，校时器获取基准时间并维持自身时间运行。3.根据权利要求2所述的一种车载设备的校时方法，其特征在于，所述校时器获取基准时间的基准时间为GPS基准时间。4.根据权利要求1、2或3所述的一种车载设备的校时方法，其特征在于，校时器获取车载设备的时间T0的过程包括以下步骤：在校时开始时，校时器发送“获取时间”命令，车载设备接收命令后，车载设备获取自身时间并将自身时间填充到固定长度的回复报文里；校时器以最高优先级接收响应回复报文，实现获取车载设备的时间T0。5.根据权利要求4所述的一种车载设备的校时方法，其特征在于，车载设备在获取自身时间及填充发送报文过程中，不能被打断，确保填充时间即为当前时间。6.根据权利要求5所述的一种车载设备的校时方法，其特征在于，所述校时器时间T1为校时器以最高优先级接收响应回复报文时对应的接收时间。7.根据权利要求6所述的一种车载设备的校时方法，其特征在于，车载设备根据时间差值ΔT调整时间的过程如下：车载设备响应校时命令，将自身时间按ΔT正负值前后调整。8.根据权利要求7所述的一种车载设备的校时方法，其特征在于，车载设备根据时间差值ΔT调整时间的过程中需要关闭系统中断功能。9.根据权利要求8所述的一种车载设备的校时方法，其特征在于，所述传输延迟Ttrans＝协议长度/通讯速率。10.一种计算机存储介质，其特征在于，所述存储介质中存储有至少一条指令，所述至少一条指令由处理器加载并执行以实现如权利要求1至9之一所述的一种车载设备的校时方法。
说明书desc
技术领域本发明涉及一种车载设备的校时方法及存储介质。背景技术针对于机车车载设备的校时而言，目前的校时方法是校时系统将本身时间发给被校时设备，同时要求被校设备必须以最高优先级响应校时命令，并及时将新时间写入时钟系统，保证双方时间统一。如果被校设备延迟响应校时命令，则会导致时间偏差。但实际在机车车载设备中，无法满足以最高优先级响应校时器的校时命令，其他如双核通讯、AD采样、关键计算、告警等功能优先级可能会更高。这样就会导致即使校时了，时间也不够准确。发明内容本发明为解决机车车载设备无法满足以最高优先级响应校时器的校时命令导致校时时间存在不够准确的问题。一种车载设备的校时方法，包括以下步骤：首先，根据校时器获取的车载设备的时间T0，计算车载设备时间与校时器时间T1的差值ΔT＝T1–，其中Ttrans为传输延迟；然后，校时器发送校时命令，将差值ΔT发给车载设备，车载设备根据时间差值ΔT调整时间。进一步地，根据校时器获取的车载设备的时间T0之前，校时器获取基准时间并维持自身时间运行。进一步地，校时器获取基准时间的基准时间为GPS基准时间。进一步地，校时器获取车载设备的时间T0的过程包括以下步骤：在校时开始时，校时器发送“获取时间”命令，车载设备接收命令后，车载设备获取自身时间并将自身时间填充到固定长度的回复报文里；校时器以最高优先级接收响应回复报文，实现获取车载设备的时间T0。进一步地，车载设备在获取自身时间及填充发送报文过程中，不能被打断，确保填充时间即为当前时间。进一步地，校时器时间T1为校时器以最高优先级接收响应回复报文时对应的接收时间。进一步地，车载设备根据时间差值ΔT调整时间的过程如下：车载设备响应校时命令，将自身时间按ΔT正负值前后调整。进一步地，车载设备根据时间差值ΔT调整时间的过程中需要关闭系统中断功能。进一步地，传输延迟Ttrans＝协议长度/通讯速率。一种计算机存储介质，存储介质中存储有至少一条指令，至少一条指令由处理器加载并执行以实现一种车载设备的校时方法。有益效果：1.本发明在不要求车载设备最高优先级响应校时命令的情况下，即可实现精准校时。2.本发明可在现有设备上只通过修改软件及通讯协议即可实现，不仅可以避免额外的开销，而且实现起来非常方便，实现成本较低。3.本发明具有良好的移植性和可扩展性，可以扩展到其他行业嵌入式设备使用校时功能场景中，具有较为广阔的适用场景和应用前景。附图说明图1为车载设备的校时的流程示意图。图2为校时器结构图示意图。具体实施方式需要特别说明的是，在不冲突的情况下，本申请公开的各个实施方式之间可以相互组合。本发明通过校时器获取车载设备的时间，并计算车载设备时间与校时器时间的差值ΔT。将差值发给车载设备，车载设备根据时间差值调整时间，不必立刻响应。根据校时器与车载设备的通讯接口配置及数据长度，计算传输时间，补偿传输延迟。下面结合具体实施方式对本发明做出进一步说明。具体实施方式一：结合图1说明本实施方式，本实施方式为一种车载设备的校时方法，包括以下步骤：1、校时器拥有GPS芯片或BD芯片，校时器获取GPS或BD基准时间，并维持自身时间运行。2、校时开始时，校时器发送“获取时间”命令，车载设备接收命令后，将自身即刻时间T0填充到固定长度的回复报文里。车载设备在获取自身时间及填充发送报文过程中，需要关闭系统中断功能，不能被打断，确保填充时间即为当前时间。关闭系统中断功能，是为了让当前的操作连续执行，不被其他事情打断，直到开中断为止。开中断就是打开了中断功能，当前操作可以被打断。3、校时器以最高优先级接收响应回复报文，并记录接收时间T1。4、校时器支持UART、CAN、USB通讯，这些通讯方式具有传输固定长度数据时传输时间固定的特点，可根据通讯口配置，计算出传输延迟Ttrans。5、校时器在T1时刻获取车载设备的实际时间信息为T0+Ttrans，计算车载设备时间与校时器时间的差值ΔT＝T1–。6、校时器发送校时命令，将ΔT传输给车载设备。7、车载设备响应校时命令，将自身时间按ΔT正负值前后调整。调整时间的操作过程需要关闭系统中断功能。8、车载设备操作完成后，回复校时命令。实施例校时器是专用校时设备，基于STM32F4XX开发，芯片内有毫秒级精度的RTC。校时器结构图如图2所示，包含供电单元、GPS单元、时钟单元、通信单元、显示控制单元。供电单元负责给所有模块供电。GPS单元负责获取GPS标准时间。时钟单元负责维持本地时间。通信单元为串口负责与车载设备通信校时。显示控制单元用于显示当前时间及GPS状态，并控制校时功能开始。校时器在有GPS信号时获取GPS基准时间，并写入时钟单元。设计图1中回复时间、校时命令协议格式相同，只有命令字不同。具体格式为：协议头+命令字+协议长度+秒时间+毫秒时间+CRC校验+协议尾，共12个字节。串口默认配置波特率115200bps、8数据位、无校验、1停止位。校时器在获取GPS时间后，用串口连接车载设备。开始校时功能，发送获取时间命令至车载设备。车载设备有毫秒级的时钟系统，在收到送获取时间命令后，读取本地的时间T0，换算成秒时间及毫秒时间，填充到协议中发送出去，此过程不能被打断。校时器在串口中断中直接响应接收回复数据，并记录校时器本地时间T1.计算传输延迟Ttrans＝协议字节数12*/波特率115200bps。其他器件响应时间、代码运行时间极小忽略不计。将T1时间换算成秒时间及毫秒时间，计算ΔT＝T1–。之后将ΔT按校时命令格式发送给车载设备。车载设备在任意时刻收到校时命令后，按ΔT的正负值调整本地时间。调整时间过程中，不能被打断。经过上诉过程，在不修改车载设备硬件、不修改车载设备事件响应优先级的前提下，实现校时器与车载设备时间的精确同步，精度可达毫秒级。具体实施方式二：本实施方式为一种计算机存储介质，存储介质中存储有至少一条指令，至少一条指令由处理器加载并执行以实现一种车载设备的校时方法。应当理解，包括本发明描述的任何方法对应的可以被提供为计算机程序产品、软件或计算机化方法，其可以包括其上存储有指令的非暂时性机器可读介质，指令可以用于编程计算机系统，或其他电子装置。存储介质可以包括但不限于磁存储介质，光存储介质；磁光存储介质包括：只读存储器ROM、随机存取存储器RAM、可擦除可编程存储器以及闪存层；或者适合于存储电子指令的其他类型的介质。本发明的上述算例仅为详细地说明本发明的计算模型和计算流程，而并非是对本发明的实施方式的限定。对于所属领域的普通技术人员来说，在上述说明的基础上还可以做出其它不同形式的变化或变动，这里无法对所有的实施方式予以穷举，凡是属于本发明的技术方案所引伸出的显而易见的变化或变动仍处于本发明的保护范围之列。
