标题title
一种基于UFS的自检测与自复位方法及系统
摘要abst
本发明公开一种基于UFS的自检测与自复位方法及系统，包括：UFSdevi ce控制器检测到UFSdevice处于空闲的状态后，控制UIC层中的发起模块发出一自检pattern至互连层；互连层接收到自检pattern后，loopback回UIC层中的校验模块进行校验，并得到一校验结果；若校验结果为失败，则UFSdevice控制器对互连层的配置信息进行保存，并对链路进行复位；UFSdevice控制器根据配置信息对互连层的配置进行恢复，从而完成device端的自复位；若校验结果为成功，则结束自检测过程。本发明实现不需要UFShost的参与，即可完成UIC层到M‑PHY层的链路自检测和自恢复。
权利要求书clms
1.一种基于UFS的自检测与自复位方法，其特征在于，包括以下步骤：UFSdevice控制器检测到UFSdevice处于空闲的状态后，控制UIC层中的pattern发起模块发出一自检pattern至互连层；所述互连层接收到所述自检pattern后，将所述自检patternloopback回所述UIC层中的pattern校验模块；所述pattern校验模块对loopback的自检pattern进行校验，并得到一校验结果；若所述校验结果为失败，则所述UFSdevice控制器对所述互连层的配置信息进行保存，并对链路进行复位；复位完成后，所述UFSdevice控制器根据所述配置信息对所述互连层的配置进行恢复，从而完成device端的自复位；若所述校验结果为成功，则所述UFSdevice控制器结束自检测过程。2.根据权利要求1所述的基于UFS的自检测与自复位方法，其特征在于，还包括：UIC层中的pattern发起模块发出一自检pattern至MIPIUnipro层的Cport接口；第一loopback模块接收到所述自检pattern后，将所述自检patternloopback回所述UIC层中的pattern校验模块；所述pattern校验模块对所述第一loopback模块loopback的自检pattern进行校验；若校验成功，所述UFSdevice控制器继续自检测过程；若校验失败，所述UFSdevice控制器对所述UIC层进行复位，若复位成功，则继续自检测过程；其中，所述互连层包括所述MIPIUnipro层，所述Cport接口包括所述第一loopback模块。3.根据权利要求2所述的基于UFS的自检测与自复位方法，其特征在于，在对所述UIC层进行复位时，还包括：若复位失败，则所述UFSdevice控制器对所述互连层的配置信息进行保存，并对链路进行复位。4.根据权利要求3所述的基于UFS的自检测与自复位方法，其特征在于，在对所述UIC层进行复位以及对配置信息进行保存时，还包括：所述UFSdevice控制器利用所述UIC层中的单独复位源对所述UIC层进行单独复位；所述UFSdevice控制器利用RTL硬件电路将所述互连层的配置信息进行保存，所述RTL硬件电路不受复位操作的影响，并在不掉电的情况下可以一直保持。5.根据权利要求2所述的基于UFS的自检测与自复位方法，其特征在于，在所述第一loopback模块对所述自检pattern进行loopback时，包括：所述第一loopback模块将所述Cport接口上的接收端信号按照正常通信的协议loopback到发送端。6.根据权利要求2所述的基于UFS的自检测与自复位方法，其特征在于，所述继续自检测过程，包括：所述Cport接口将所述自检pattern发送至PA层的RMMI接口；第二loopback模块接收到所述自检pattern后，将所述自检patternloopback回所述UIC层中的pattern校验模块；若校验成功，所述UFSdevice控制器继续自检测过程；若校验失败，所述UFSdevice控制器对所述互连层的配置信息进行保存，并对链路进行复位；其中，所述MIPIUnipro层包括所述PA层，所述RMMI接口包括所述第二loopback模块。7.根据权利要求6所述的基于UFS的自检测与自复位方法，其特征在于，所述继续自检测过程时，包括：所述RMMI接口将所述自检pattern发送至MIPIM-PHY层；第三loopback模块接收到所述自检pattern后，将所述自检patternloopback回所述UIC层中的pattern校验模块；若校验成功，所述UFSdevice控制器结束自检测过程；若校验失败，所述UFSdevice控制器对所述互连层的配置信息进行保存，并对链路进行复位；其中，所述互连层包括所述MIPIM-PHY层，所述MIPIM-PHY层包括所述第三loopback模块。8.根据权利要求1所述的基于UFS的自检测与自复位方法，其特征在于，在所述pattern校验模块对loopback的自检pattern进行校验时，包括：所述pattern校验模块对所述自检pattern所携带的CRC校验码进行CRC校验，若校验失败，则在状态寄存器中标志位上进行标志，并且进入CPU中断。9.一种基于UFS的自检测与自复位系统，其特征在于，包括：UFSdevice控制器，用于发出自检测指令，以及在校验失败时对互连层的配置信息进行保存和对链路进行复位，并在所述链路复位后，根据所述配置信息对所述互连层的配置进行恢复；UIC层，包括pattern发起模块和pattern校验模块，所述pattern发起模块用于接收到所述自检测指令后，发出一自检pattern，所述pattern校验模块用于对loopback的自检pattern进行校验；互连层，用于接收到所述自检pattern后，将所述自检patternloopback回所述pattern校验模块。10.根据权利要求9所述的基于UFS的自检测与自复位系统，其特征在于，所述互连层包括：MIPIUnipro层，包括Cport接口和RMMI接口，所述Cport接口包括第一loopback模块，所述RMMI接口包括第二loopback模块，所述第一loopback模块和所述第二loopback模块均用于接收到所述自检pattern后，将所述自检patt ernloopback回所述UIC层中的pattern校验模块；MIPIM-PHY层，包括第三loopback模块，用于接收到所述自检pattern后，将所述自检patternloopback回所述UIC层中的pattern校验模块。
说明书desc
技术领域本发明涉及数据传输技术领域，具体涉及一种基于UFS的自检测与自复位方法及系统。背景技术UFS协议包括：UCS基于SBC和SPC的SCSI命令、UTPJEDEC定义的协议、UIC数据链路层的MIPI协议和物理层的MIPI-M-PHY协议。UFShost和UFSdevice通过MIPI-M-PHY互联，在现有的技术与协议，UFSdevice的Unipro层与M-PHY层都是通过配置与管理实现的。Host的应用层构建的UFS协议帧格式，通过UIC层的Cport接口传输到Unipro层，然后经过Unipro层进行组合成Unipro协议帧格式，然后通过RMMI接口传输到M-PHY层，最后经过M-PHY层将信息传输到与UFSdevice连接的线上。UFSdevice的M-PHY层接收到Host传输过来的信息后会通过RMMI接口传输到Unipro层，Unipro层将数据帧的拆解成UFS的帧格式并通过Cport接口上传到UTP层，UTP层在接收到命令之后会构造一个响应给到Host，数据先是通过Cport接口传到Unipro层，然后通过RMMI接口传到M-PHY层，由M-PHY层将数据传到与Host连接的线上，从而完成UFShost与UFSdevice的一次完整通信。由上述可知，UFShost与UFSdevice通信的链路需要二者互相配合才能进行检测，即device设备要测试UIC层到M-PHY层的链路时，需要借助与UFShost的握手流程或者信息交互才能实现。当UFShost在发送信息到device端失败时，UFShost需要发送HardwareReset，并且需要重新与device建立链接，整个过程所花费的时间较多。发明内容为了克服现有技术的不足，本发明提供一种基于UFS的自检测与自复位方法及系统，用于解决现有技术在对UIC层到M-PHY层的链路进行检测时，必须UFShost与UFSdevice互相配合的技术问题，从而达到不需要UFShost的参与，即可完成UIC层到M-PHY层的链路自检测和自恢复的目的。为解决上述问题，本发明所采用的技术方案如下：一种基于UFS的自检测与自复位方法，包括以下步骤：UFSdevice控制器检测到UFSdevice处于空闲的状态后，控制UIC层中的pattern发起模块发出一自检pattern至互连层；所述互连层接收到所述自检pattern后，将所述自检patternloopback回所述UIC层中的pattern校验模块；所述pattern校验模块对loopback的自检pattern进行校验，并得到一校验结果；若所述校验结果为失败，则所述UFSdevice控制器对所述互连层的配置信息进行保存，并对链路进行复位；复位完成后，所述UFSdevice控制器根据所述配置信息对所述互连层的配置进行恢复，从而完成device端的自复位；若所述校验结果为成功，则所述UFSdevice控制器结束自检测过程。作为本发明优选的实施方式，上述的自检测与自复位方法还包括：UIC层中的pattern发起模块发出一自检pattern至MIPIUnipro层的Cport接口；第一loopback模块接收到所述自检pattern后，将所述自检patternloopback回所述UIC层中的pattern校验模块；所述pattern校验模块对所述第一loopback模块loopback的自检pattern进行校验；若校验成功，所述UFSdevice控制器继续自检测过程；若校验失败，所述UFSdevice控制器对所述UIC层进行复位，若复位成功，则继续自检测过程；其中，所述互连层包括所述MIPIUnipro层，所述Cport接口包括所述第一loopback模块。作为本发明优选的实施方式，在对所述UIC层进行复位时，还包括：若复位失败，则所述UFSdevice控制器对所述互连层的配置信息进行保存，并对链路进行复位。作为本发明优选的实施方式，在对所述UIC层进行复位以及对配置信息进行保存时，还包括：所述UFSdevice控制器利用所述UIC层中的单独复位源对所述UIC层进行单独复位；所述UFSdevice控制器利用RTL硬件电路将所述互连层的配置信息进行保存，所述RTL硬件电路不受复位操作的影响，并在不掉电的情况下可以一直保持。作为本发明优选的实施方式，在所述第一loopback模块对所述自检pattern进行loopback时，包括：所述第一loopback模块将所述Cport接口上的接收端信号按照正常通信的协议loopback到发送端。作为本发明优选的实施方式，所述继续自检测过程，包括：所述Cport接口将所述自检pattern发送至PA层的RMMI接口；第二loopback模块接收到所述自检pattern后，将所述自检patternloopback回所述UIC层中的pattern校验模块；若校验成功，所述UFSdevice控制器继续自检测过程；若校验失败，所述UFSdevice控制器对所述互连层的配置信息进行保存，并对链路进行复位；其中，所述MIPIUnipro层包括所述PA层，所述RMMI接口包括所述第二loopback模块。作为本发明优选的实施方式，所述继续自检测过程时，包括：所述RMMI接口将所述自检pattern发送至MIPIM-PHY层；第三loopback模块接收到所述自检pattern后，将所述自检patternloopback回所述UIC层中的pattern校验模块；若校验成功，所述UFSdevice控制器结束自检测过程；若校验失败，所述UFSdevice控制器对所述互连层的配置信息进行保存，并对链路进行复位；其中，所述互连层包括所述MIPIM-PHY层，所述MIPIM-PHY层包括所述第三loopback模块。作为本发明优选的实施方式，在所述pattern校验模块对loopback的自检pattern进行校验时，包括：所述pattern校验模块对所述自检pattern所携带的CRC校验码进行CRC校验，若校验失败，则在状态寄存器中标志位上进行标志，并且进入CPU中断。一种基于UFS的自检测与自复位系统，包括：UFSdevice控制器，用于发出自检测指令，以及在校验失败时对互连层的配置信息进行保存和对链路进行复位，并在所述链路复位后，根据所述配置信息对所述互连层的配置进行恢复；UIC层，包括pattern发起模块和pattern校验模块，所述pattern发起模块用于接收到所述自检测指令后，发出一自检pattern，所述pattern校验模块用于对loopback的自检pattern进行校验；互连层，用于接收到所述自检pattern后，将所述自检patternloopback回所述pattern校验模块。作为本发明优选的实施方式，所述互连层包括：MIPIUnipro层，包括Cport接口和RMMI接口，所述Cport接口包括第一loopback模块，所述RMMI接口包括第二loopback模块，所述第一loopback模块和所述第二loopback模块均用于接收到所述自检pattern后，将所述自检patt ernloopback回所述UIC层中的pattern校验模块；MIPIM-PHY层，包括第三loopback模块，用于接收到所述自检pattern后，将所述自检patternloopback回所述UIC层中的pattern校验模块。相比现有技术，本发明的有益效果在于：本发明通过UFSdevice控制器控制UIC层中的pattern发起模块发出一自检pattern，自检pattern经过互连层loopback到pattern校验模块，从而在不需要UFShost的参与下，对UIC层到M-PHY层的链路进行测试，有效地缩短链路的检测与恢复时间；本发明使得UFSdevice处于空闲状态时，就可对链路进行自检测，从而保证了正常使用时链路的稳定性，有效地提高工作效率。下面结合附图和具体实施方式对本发明作进一步详细说明。附图说明图1-是本发明实施例的基于UFS的自检测与自复位方法步骤图；图2-是本发明实施例的基于UFS的自检测与自复位系统结构框图；图3-是本发明实施例的基于UFS的自检测与自复位方法流程图。附图标号说明：1、UFSdevice控制器；2、UIC层；3、互连层；4、MIPIUnipro层；5、Cport接口；6、MIPIM-PHY层；7、RMMI接口；8、UAP层；9、UTP层。具体实施方式本发明所提供的基于UFS的自检测与自复位方法，如图1所示，包括以下步骤：步骤S1：UFSdevice控制器1检测到UFSdevice处于空闲的状态后，控制UIC层2中的pattern发起模块发出一自检pattern至互连层3；步骤S2：互连层3接收到自检pattern后，将自检patternloopback回UIC层2中的pattern校验模块；步骤S3：pattern校验模块对loopback的自检pattern进行校验，并得到一校验结果；步骤S4：若校验结果为失败，则UFSdevice控制器1对互连层3的配置信息进行保存，并对链路进行复位；步骤S5：复位完成后，UFSdevice控制器1根据配置信息对互连层3的配置进行恢复，从而完成device端的自复位；步骤S6：若校验结果为成功，则UFSdevice控制器1结束自检测过程。进一步地，空闲的状态包括：UFSdevice与UFSHost没有进行数据交互，或者处于background模式。进一步地，pattern发起模块和pattern校验模块均是通过RTL硬件电路实现。具体地，本发明是在device端的Cport接口5和RMMI接口7并且借助MIPI M-PHY层6支持的loopback功能实现硬件上的数据回流，并且在UIC层2增加pattern的发起模块和校验模块，使得数据的发送、数据的接收以及数据的校验都在UFSdevice端，从而脱离了UFShost的参与，也可对device端的数据链路运行情况进行检测。当校验模块报告校验失败时，本发明支持将MIPIUnipro层4和MIPIM-PHY层6的配置信息进行完整保存后，进行一次链路的复位操作，并在复位完成后，本发明可根据保存的配置信息恢复MIPIUnipro层4与MIPIM-PHY层6的配置，从而实现在UFShost无察觉的情况下，完成了device端的一次自检测和自复位操作。在自复位操作完成之后还可继续与UFShost进行正常的通信。如图2所示，上述的自检测与自复位方法，还包括：UIC层2中的pattern发起模块发出一自检pattern至MIPIUnipro层4的Cport接口5；第一loopback模块接收到自检pattern后，将自检patternloopback回UIC层2中的pattern校验模块；pattern校验模块对第一loopback模块loopback的自检pattern进行校验；若校验成功，UFSdevice控制器1继续自检测过程；若校验失败，UFSdevice控制器1对UIC层2进行复位，若复位成功，则继续自检测过程；其中，互连层3包括MIPIUnipro层4，Cport接口5包括第一loopback模块。进一步地，第一loopback模块通过在Cport接口5上嵌入一个RTL硬件电路模块而实现。进一步地，在对UIC层2进行复位时，还包括：若复位失败，则UFSdevice控制器1对互连层3的配置信息进行保存，并对链路进行复位。更进一步地，在对UIC层2进行复位以及对配置信息进行保存时，还包括：UFSdevice控制器1利用UIC层2中的单独复位源对UIC层2进行单独复位；UFSdevice控制器1利用RTL硬件电路将互连层的配置信息进行保存，RTL硬件电路不受复位操作的影响，并在不掉电的情况下可以一直保持。具体地，UIC层2拥有一个单独的复位源可实现整个系统中就单独复位UIC层2，本发明支持UFSdevice在自测试的环境下将MIPIUnipro层4和MIPI M-PHY层6当前的配置用RTL硬件电路保存下来，该RTL硬件电路不受reset的控制，在不掉电的情况下可一直保持，从而使得保存的配置信息电路并没有被reset，并在reset之后，可根据保存的配置信息恢复与host正常连接的状态。更进一步地，在第一loopback模块对自检pattern进行loopback时，包括：第一loopback模块将Cport接口5上的接收端信号按照正常通信的协议loopback到发送端。进一步地，如图2所示，继续自检测过程，包括：Cport接口5将自检pattern发送至PA层的RMMI接口7；第二loopback模块接收到自检pattern后，将自检patternloopback回UIC层2中的pattern校验模块；若校验成功，UFSdevice控制器1继续自检测过程；若校验失败，UFSdevice控制器1对互连层3的配置信息进行保存，并对链路进行复位；其中，MIPIUnipro层4包括PA层，RMMI接口7包括第二loopback模块。更进一步地，如图2所示，继续自检测过程时，包括：RMMI接口7将自检pattern发送至MIPIM-PHY层6；第三loopback模块接收到自检pattern后，将自检patternloopback回UIC层2中的pattern校验模块；若校验成功，UFSdevice控制器1结束自检测过程；若校验失败，UFSdevice控制器1对互连层3的配置信息进行保存，并对链路进行复位；其中，互连层3包括MIPIM-PHY层6，MIPIM-PHY层6包括第三loopback模块。进一步地，在pattern校验模块对loopback的自检pattern进行校验时，包括：pattern校验模块对自检pattern所携带的CRC校验码进行CRC校验，若校验失败，则在状态寄存器中标志位上进行标志，并且进入CPU中断。具体地，当UFSdevice处于空闲状态时，本发明通过UFSdevice控制器1控制特殊pattern的发送，特殊pattern携带有CRC校验码，UIC层2在接收到loopback回来的特殊pattern就会进行CRC校验，若检验失败则会在状态寄存器中标志位标志出来并且进入CPU中断告知当前出现链路通信失败。UIC层2的pattern发送模块在发送特殊pattern时会在数据帧后面增加CRC校验数据，UIC层2在接收到特殊pattern时会进行CRC校验，通过CRC校验是否成功来判定Cport链路的通信质量。如图3所示，本发明所提供的基于UFS的自检测与自复位系统，包括：UFSdevice控制器1，用于发出自检测指令，以及在校验失败时对互连层3的配置信息进行保存和对链路进行复位，并在链路复位后，根据配置信息对互连层3的配置进行恢复；UIC层2，包括pattern发起模块和pattern校验模块，pattern发起模块用于接收到自检测指令后，发出一自检pattern，pattern校验模块用于对loopback的自检pattern进行校验；互连层3，用于接收到自检pattern后，将自检patternloopback回pattern校验模块。UIC层2是UFS体系结构中的最低层，用于处理运输任务，UIC层2支持两个接口：UIC_SAP和UIO_SAP，UIC_SAP用于将UPIU从UFS主机传输到UFS设备，UIO_SAP用于传输设备管理的查询和控制。进一步地，如图3所示，互连层包括：MIPIUnipro层4，包括Cport接口5和RMMI接口7，Cport接口5包括第一loopback模块，RMMI接口7包括第二loopback模块，第一loopback模块和第二loopback模块均用于接收到自检pattern后，将自检patternloopback回UI C层2中的pattern校验模块；MIPIM-PHY层6，包括第三loopback模块，用于接收到自检pattern后，将自检patternloopback回UIC层2中的pattern校验模块。MIPIUnipro层4提供基本的传输功能到UTP层。UFS和UniPro之间数据层使用MIPIUniPro层4端口进行数据传输。控制层通过设备管理实体与MIPIUnipro层4通信。DME包括探寻、枚举和配置等任务。MIPIM-PHY层6是物理层。进一步地，如图3所示，本发明所提供的基于UFS的自检测与自复位系统，还包括UAP层8和UTP层9。UAP层8为应用层，用于发出简化的SCSI命令，如读写命令等。UTP层9为UFS传输协议层，UTP层9生成UFS协议信息单元，以从设备传输消息到管理器或应用程序层。UPIU从主机端UTP传输到设备端UTP。UTP层9支持三种SAP：UDM_SAP、UTP_CMD_SAP以及UTP_TM_SAP，UDM_SAP用于与设备管理器通信，UTP_CMD_SAP用于传输命令，UTP_TM_SAP用于传输任务管理功能。相比现有技术，本发明的有益效果在于：本发明通过UFSdevice控制器控制UIC层中的pattern发起模块发出一自检pattern，自检pattern经过互连层loopback到pattern校验模块，从而在不需要UFShost的参与下，对UIC层到M-PHY层的链路进行测试，有效地缩短链路的检测与恢复时间；本发明使得UFSdevice处于空闲状态时，就可对链路进行自检测，从而保证了正常使用时链路的稳定性，有效地提高工作效率。上述实施方式仅为本发明的优选实施方式，不能以此来限定本发明保护的范围，本领域的技术人员在本发明的基础上所做的任何非实质性的变化及替换均属于本发明所要求保护的范围。
