标题title
一种实时的内窥镜图像去烟雾方法
摘要abst
本发明涉及医疗图像处理技术领域，具体涉及一种实时的内窥镜图像去烟雾方法，包括：步骤S1：从目标对象的管腔内获取内窥镜原始图像；步骤S2：判断原始图像中是否有烟雾，若有烟雾，则进行下一步骤，若无烟雾，则输出图像；步骤S3：根据大气光照理论得到无雾图像与原始图像之间的关系式：，其中，为原始图像，为无雾图像，为透射率，A为大气光照值；步骤S4：根据关系式对原始图像进行去雾处理，并通过动态调整的值控制烟雾去除强度，持续至烟雾完全去除，得到无雾图像；步骤S5：通过计算公式对无雾图像进行动态提亮，并输出图像。本发明通过动态调整去烟雾过程中的烟雾去除强度，提高了整个微创治疗过程中的安全保障。
权利要求书clms
1.一种实时的内窥镜图像去烟雾方法，其特征在于，该方法包括以下步骤：步骤S1：从目标对象的管腔内获取内窥镜原始图像；步骤S2：判断所述原始图像中是否有烟雾，若有烟雾，则进行下一步骤，若无烟雾，则输出图像；步骤S3：根据大气光照理论得到无雾图像与所述原始图像之间的关系式：，其中，/＞为原始图像，/＞为无雾图像，/＞为透射率，A为大气光照值；步骤S4：根据所述关系式对所述原始图像进行去雾处理，并通过动态调整的值控制烟雾去除强度，持续至烟雾完全去除，得到所述无雾图像；步骤S5：通过计算公式对所述无雾图像进行动态提亮，并输出图像。2.根据权利要求1所述的实时的内窥镜图像去烟雾方法，其特征在于，步骤S2中，判断所述原始图像中是否有烟雾的具体方法为：步骤S2-1：计算暗通道图像，计算公式具体为：/＞，其中/＞为暗通道图像，/＞为R、G、B三个通道，R、G、B为图像的三种基本色，分别为红、绿、蓝，/＞，/＞为局部区域窗口内的任一子集，/＞，/＞为局部区域的窗口；步骤S2-2：统计暗通道图像的像素值在LumTh1和LumTh2之间的像素个数，记作，计算公式为：，其中，LumTh1和LumTh2分别代表第一个像素阈值和第二个像素阈值，/＞为求和函数；步骤S2-3：统计暗通道图像的像素值在LumTh3和LumTh4之间的像素个数，记作，计算公式为：/＞，其中LumTh3和LumTh4分别代表第三个像素阈值和第四个像素阈值；步骤S2-4：计算烟雾浓度的百分比：，计算公式为：；步骤S2-5：设定烟雾浓度阈值为，并将所述烟雾浓度百分比与所述烟雾浓度阈值进行比较，若/＞大于/＞，则判定为有烟雾，否则判定为无烟雾。3.根据权利要求1所述的实时的内窥镜图像去烟雾方法，其特征在于，步骤S4中，根据所述关系式对所述原始图像进行去雾处理的具体方法为：步骤S4-1：计算透射率，计算公式为：/＞，其中，/＞为调整烟雾去除强度的控制参数，/＞为无雾区域的偏移值；步骤S4-2：将A设置为定值，令；步骤S4-3：根据和/＞的值，并基于所述无雾图像与所述原始图像之间的关系式计算求得所述无雾图像。4.根据权利要求3所述的实时的内窥镜图像去烟雾方法，其特征在于，步骤S4-1中，通过与/＞以及/＞之间的关系式调控/＞的大小，以动态调整/＞的值；所述关系式为：/＞，其中，/＞为/＞的最小值，为/＞的最大值，/＞是整体的倍乘因子。5.根据权利要求3所述的实时的内窥镜图像去烟雾方法，其特征在于，步骤S4-3，计算求得所述无雾图像的计算公式为：。6.根据权利要求1所述的实时的内窥镜图像去烟雾方法，其特征在于，在步骤S5中，对所述无雾图像进行动态提亮的计算公式具体为：，其中，/＞为提亮后的图像，/＞为自适应伽玛调节量。7.根据权利要求6所述的实时的内窥镜图像去烟雾方法，其特征在于，所述自适应伽玛调节量的计算公式为：/＞，其中表示/＞的最小值，/＞表示/＞的最大值，/＞为倍乘因子。
说明书desc
技术领域本发明涉及医疗图像处理技术领域，具体涉及一种实时的内窥镜图像去烟雾方法。背景技术现如今，医疗水平越来越好，手术也逐渐微创化，微创手术一方面可以减轻患者的痛苦，一方面又能让患者恢复速度变快，同时提升了医院的换床率，使得医院可以诊治更多的病人。微创手术中重要的组成部分是内窥镜摄像系统，它相当于医生的眼睛，伸入观察对象的管腔后，可为医生提供管腔内的图像，以供医生进行观察，从而有助于疾病的诊断和手术的实施。因此保证画面的稳定性和流畅度就很重要。但在手术的过程中，通常需要利用激光烧灼或烧蚀组织，从而会产生大量的烟雾，这些烟雾会影响医生的视线，给手术带来一定的风险。目前常用的内窥镜去烟雾方法以物理去除方法为主，通过对不同的应用场景设计不同的去烟雾设备，将其与内窥镜配套使用，以便及时排出烟雾，从而实现去除烟雾的目的，但实施这种方式所花费的成本较高，且除雾效果较差。针对上述现有技术中存在的问题，本领域技术人员做出了诸多努力，如中国专利申请CN2022116997787提出了一种医用内窥镜图像快速去雾方法和系统，利用雾天图像退化物理模型对烟雾区域图像进行去雾处理，但对去烟雾的效果较弱，易对图像产生影响，使得整个微创治疗过程中的安全保障较低。发明内容为解决上述问题，本发明提供了一种实时的内窥镜图像去烟雾方法，通过动态调整透射率的值动态调整去烟雾过程中的烟雾去除强度，提高了内窥镜图像的去雾效果，提高了整个微创治疗过程中的安全保障。为实现上述目的，本发明采用的技术方案是一种实时的内窥镜图像去烟雾方法，包括：步骤S1：从目标对象的管腔内获取内窥镜原始图像；步骤S2：判断原始图像中是否有烟雾，若有烟雾，则进行下一步骤，若无烟雾，则输出图像；步骤S3：根据大气光照理论得到无雾图像与原始图像之间的关系式：，其中，为原始图像，为无雾图像，为透射率，A为大气光照值；步骤S4：根据关系式对原始图像进行去雾处理，并通过动态调整的值控制烟雾去除强度，持续至烟雾完全去除，得到无雾图像；步骤S5：通过计算公式对无雾图像进行动态提亮，并输出图像。进一步的，步骤S2中，判断原始图像中是否有烟雾的具体方法为：步骤S2-1：计算暗通道图像，计算公式具体为：，其中为暗通道图像，为R、G、B三个通道，R、G、B为图像的三种基本色，分别为红、绿、蓝，，为局部区域窗口内的任一子集，，为局部区域的窗口；步骤S2-2：统计暗通道图像的像素值在LumTh1和LumTh2之间的像素个数，记作，计算公式为：，其中，LumTh1和LumTh2分别代表第一个像素阈值和第二个像素阈值，为求和函数；步骤S2-3：统计暗通道图像的像素值在LumTh3和LumTh4之间的像素个数，记作，计算公式为：，其中LumTh3和LumTh4分别代表第三个像素阈值和第四个像素阈值；步骤S2-4：计算烟雾浓度的百分比：，计算公式为：；步骤S2-5：设定烟雾浓度阈值为，并将烟雾浓度百分比与烟雾浓度阈值进行比较，若大于，则判定为有烟雾，否则判定为无烟雾。进一步的，步骤S4中，根据关系式对原始图像进行去雾处理的具体方法为：步骤S4-1：计算透射率，计算公式为：，其中，为调整烟雾去除强度的控制参数，为无雾区域的偏移值；步骤S4-2：将A设置为定值，令；步骤S4-3：根据和的值，并基于无雾图像与原始图像之间的关系式计算求得无雾图像。进一步的，步骤S4-1中，通过与以及之间的关系式调控的大小，以动态调整的值；关系式为：，其中，为的最小值，为的最大值，是整体的倍乘因子。进一步的，步骤S4-3，计算求得无雾图像的计算公式为：。进一步的，在步骤S5中，对所述无雾图像进行动态提亮的计算公式具体为：，其中，为提亮后的图像，为自适应伽玛调节量。进一步的，自适应伽玛调节量的计算公式为：，其中表示的最小值，表示的最大值，为倍乘因子。本发明所述的技术方案取得有益效果为：1.本发明通过无雾图像与原始图像之间的关系式对原始图像进行去雾处理，基于透射率和大气光照值A求解无雾图像，通过动态调整的值，提高了去烟雾的效果，为微创手术过程提供了安全保障。同时，实现在去雾的过程中动态调整烟雾去除强度，避免在烟雾去除时对图像产生影响，进一步保证了微创手术过程中的安全性。2.本发明在对原始图像进行去雾处理之前，先对原始图像中是否有烟雾进行判定，能够保护无烟雾时的原始图像不受影响，从而能够进一步保证画面观感，并减小图像处理过程中的负担。3.本发明在对原始图像进行去烟雾处理之后，针对无雾图形进行动态提亮处理，避免了因图像局部区域过暗而对观感造成的影响，进一步保证了微创手术过程中的安全性，并减少了医生观看画面是的疲劳感。附图说明为了使本发明的内容更容易被清楚地理解，下面根据具体实施例，并结合附图，对本发明作进一步详细的说明。图1是实时的内窥镜图像去烟雾方法的流程图。图2是FPGA输入图像的仿真结果图。图3是FPGA处理结束后的仿真结果图。图4是图像去雾前与去雾后的对比图，其中左图为去雾前图像，右图为去雾后图像。图5是内窥镜获取的原始图像。图6是通过暗通道去雾方法得到的去雾后图像。图7是通过限制对比度的自适应直方图均衡化方法得到的去雾后图像图8是多尺度Retinex的去雾方法得到的去雾后图像。图9是快速去雾方法得到的去雾后图像。图10是基于双边滤波的实时去雾方法得到的去雾后图像。图11是本发明提出的去雾方法得到的去雾后图像。具体实施方式下面结合附图对本发明的技术方案作进一步的说明，但并不局限于此，凡是对本发明技术方案进行修改或者等同替换，而不脱离本发明技术方案的精神和范围，均应涵盖在本发明的保护范围中。如图1所示，本实施例提供了一种实时的内窥镜图像去烟雾方法，包括：步骤S1：从目标对象的官腔内获取内窥镜原始图像。步骤S2：判断原始中是否有烟雾，若有烟雾，则进行下一步骤，若无烟雾，则输出图像。具体操作包括：步骤S2-1：使用计算公式计算暗通道图像，计算公式具体为：，其中，其中为暗通道图像；为R、G、B三个通道，R、G、B为图像的三种基本色，分别为红、绿、蓝，；为局部区域窗口内的任一子集，，为局部区域的窗口。步骤S2-2：统计暗通道图像的像素处于LumTh1和LumTh2之间的像素个数，记作，计算公式为：，其中，LumTh1和LumTh2分别代表第一个像素阈值和第二个像素阈值，为求和函数。由于内窥镜图像中存在较多的黑边和过曝区域，且这些区域会对烟雾程度的统计产生偏差，需要将其排除在外，因此对LumTh1和LumTh2进行赋值，LumTh1为10，LumTh2为240.步骤S2-3：统计暗通道图像的像素值在LumTh3和LumTh4之间的像素个数，记作，计算公式为：，其中LumTh3和LumTh4分别代表第三个像素阈值和第四个像素阈值，LumTh3为80，LumTh4为150。步骤S2-4：计算烟雾浓度的百分比：，计算公式为：；步骤S2-5：设定烟雾浓度阈值为，并将烟雾浓度百分比与烟雾浓度阈值进行比较，若大于，则判定为有烟雾，否则判定为无烟雾。步骤S3：根据大气光照模型得到无雾图像与原始图像之间的关系式：，其中，为原始图像，为无雾图像，为透射率，A为大气光照值。步骤S4：根据步骤S3中无雾图像与原始图像之间的关系式，对原始图像进行去雾处理，并在去雾的过程中通过动态调整透射率的值控制烟雾去除强度，直至得到无雾图像。通过在去雾的过程中动态调整烟雾去除强度，能够避免去雾的过程中因去雾强度过大或过小对图像造成影响。具体操作方法为：步骤S4-1：计算透射率，计算公式为：，其中为无雾区域的偏移值，为调整烟雾去除强度的控制参数。的值跟随烟雾浓度百分比的浓度变化而变化，与烟雾浓度百分比之间的关系式为：。其中，为的最小值，为取值0.1，为的最大值，取值为0.2，是整体的倍乘因子，取值为1，用于将数值转变至0至1之间。在烟雾的去除过程中，烟雾浓度百分比是实时变化的，因此，基于烟雾浓度百分比的变化，的值随之被动态调整，从而动态调整透射率，实现对烟雾去除强度的动态调整，避免去雾的过程中因去雾强度过大或过小对图像造成影响。步骤S4-2：将A设置为定值，令，其中的值为255。步骤S4-3：根据和的值，代入无雾图像与原始图像之间的关系式中，并对其进行变换，得到计算无雾图像的计算公式：，求解公式后得到无雾图像。步骤S5：通过计算公式对求解所得到的无雾图像进行动态提亮，并在提亮完成后输出图像。其中为自适应伽玛调节量。的计算公式为：，其中表示的最小值，取值为1.1，表示的最大值，取值为2，为倍乘因子，取值为1。为评估本发明提出的方法的可行性和有效性，对本实施例进行实验验证：本发明以暗通道先验方法的原理为基础，基于该原理研发出全新的去烟雾算法。本发明中，算法研发过程分为初期仿真阶段和实现阶段，初期仿真阶段使用编程语言python进行算法的研发、修改以及快速验证，以实现算法功能和部分运算的优化。如图2和图3所示，FPGA输入图像的仿真结果图和FPGA处理结束后的仿真结果图中，当初期仿真阶段满足算法所要达到的要求后，进入FPGA实现阶段，可编程门阵列FPGA仿真是通过软件模拟和硬件描述来验证FPGA设计的正确性和性能的过程。利用FPGA的性能，能够满足视频流的低延迟目的，完成算法的实现验证。如图4所示，在图像去雾前与去雾后的对比图中，待FPGA实现仿真结束后，即可将算法程序编译，并通过实机烧录展示进行效果的验证和调试，并可以根据实际效果调整算法参数以满足最终所要达到的要求。具体的，在本验证例中，设定、，统计暗通道图像在该阈值区间内的像素个数，记作，并定义为合理的像素数量。设定、，统计暗通道图像在该阈值区间内的像素个数，记作，设定烟雾浓度百分比阈值为0.4。通过将实时获得的与之间的比值定义获取的内窥镜图像的实时烟雾浓度百分比，将该烟雾浓度百分比与烟雾浓度百分比阈值0.4进行比较，当烟雾浓度百分比大于烟雾浓度百分比阈值时，图像上存有烟雾，当烟雾浓度百分比小于或等于烟雾浓度百分比阈值时，图像无烟雾。在动态去烟雾过程中，将的最大最小值分别设定为：、，将倍乘因子设定为，将无雾区域的偏移值设定为：，并设定。结合透射率和的计算公式：，，可知，在去雾过程中，烟雾浓度百分比是实时变化的，这就导致的值也随着变化，从而导致的值的大小随之实时变化。的值越大，画面越不变动，去烟雾强度越弱，越小，画面变动就越大，去烟雾强度越强。在对图像进行动态提亮时，设定，，.通过伽玛提亮的方式引入自适应的伽玛调节量，结合公式：和可知，在去雾过程中，烟雾浓度百分比实时变化，导致的值也随之变化，使之能够根据去烟雾过程中烟雾浓度百分比变化自适应的调整图像提亮程度，使图像在整个微创过程中变化较小。结果对比：现有技术中，常用的去雾方法有：快速去雾方法、基于双边滤波的实时去雾方法、多尺度Retinex的去雾方法、限制对比度的自适应直方图均衡化方法和暗通道去雾方法。其中，快速去雾方法利用均值滤波对环境光和全局大气光进行估计。基于双边滤波的实时去雾方法根据暗原色先验统计原理估计大气光强度,使用快速双边滤波器估计大气光幕,通过求解带雾图像成像物理方程恢复理想光照条件下的大气辐射强度,实现图像去雾。多尺度Retinex的去雾方法通过对原始图像进行高斯滤波，得到不同尺度下的图像，再对每个尺度下的图像进行单尺度Retinex计算，得到该尺度下的反射分量，再对所有尺度下的反射分量进行加权平均，得到最终的反射分量。将最终的反射分量与原始图像进行融合，得到去雾后的图像。限制对比度的自适应直方图均衡化方法通过对图像分块，以块为单位，再计算每个块的累积，再进行块件双线性插值，并与原图做图像滤色混合操作。暗通道去雾方法则直觉先验，统计的多张清晰图像和有雾图像的特征，提出了暗通道先验理论，找到了清晰图像与有雾图像之间的关系，使用大气物理模型恢复无雾图像。对现有技术中的多种去雾方法进行仿真实验，并将多种去雾方法的运行时间与本发明对比：去雾方法运行时间暗通道去雾方法400.8直方图均衡化方法96.06多尺度Retinex方法1893.1409快速去雾方法199基于双边滤波的实时去雾方法660本发明88根据多种去雾方法的数据对比可知，本发明所提出的去雾方法运行时间短，在资源和效果上都取得了不错的表现。如图5-11所示，对经过对各种去雾方法所得到的去雾后图像进行对比可知：通过限制对比度的自适应直方图均衡化方法多尺度Retinex去雾方法所得到的图像中仅有小部分区域具有一定的去雾效果，总体去雾能力较弱；通过暗通道去雾方法和基于双边滤波的实时图像去雾方法所得到的图像中，虽然具备一定的去雾效果，但画面整体颜色受到较大的影响，画面变暗，尤其是基于双边滤波的实时图像去雾方法使得画面的饱和度提升较多，对画面造成的影响较大；通过快速去雾方法得到的图像去雾效果与本发明中的去雾后图像的去雾效果相近，但本发明通过实时动态调整去雾强度使得本发明中的去雾后图像不会发生较大变化，颜色相较于原图并没有发生较大的偏差，拥有较强的适应能力，在整体上具备更好的去雾效果。以上所述仅为本发明的实施例，并非因此限制本发明的专利范围，凡是利用本发明说明书及附图内容所作的等效结构或等效流程变换，或直接或间接运用在其他相关的技术领域，均同理包括在本发明的专利保护范围内。
