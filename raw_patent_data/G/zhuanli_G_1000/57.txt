标题title
基于动态分支预测的迭代求解的面向视觉定位方法
摘要abst
本发明公开了一种基于动态分支预测的迭代求解的面向视觉定位方法，属于视觉定位技术领域。本发明既能在收敛速度和求解效果上都有不错的表现，又能减少迭代算法的复杂度，实现快速计算。相较于视觉定位通常的迭代求解方式，本发明不管是对成功迭代还是对失败迭代，都减少了冗余的计算，显著减少了迭代过程的复杂度，同时显著减少了现有视觉定位的迭代处理的串行步骤，提升了运行速度；特别地对于失败迭代，不仅减少了构建标准方程带来的冗余计算，而且使用除法快速求解来代替复杂的乔莱斯基分解法，极大地提升了失败迭代情况下的速度。本发明适用于对实时性要求高的基于迭代求解的视觉定位应用，减少了视觉定位的算法复杂度，提高了运行速度。
权利要求书clms
1.基于动态分支预测的迭代求解的面向视觉定位方法，其特征在于，包括下列步骤：步骤一，输入待定位目标设备的初始位姿；步骤二，基于待定位目标设备的视觉传感器获取图像数据；步骤三，确定待定位目标设备的当前位姿；若当前为首次定位处理，则以输入的初始位姿作为当前位姿；否则，以最近一次更新后的位姿作为当前位姿；步骤四，对步骤二获取的图像数据进行图像预处理，以获取特征点坐标以及特征点匹配关系；步骤五，判断视觉定位的迭代求解是否结束，若是，则执行步骤十一；否则执行步骤六；步骤六，基于步骤四获取的特征点坐标以及特征点匹配关系计算当前位姿的残差；并基于历史预测结果预测下一次的迭代质量，得到预测结果，该预测结果为成功分支或失败分支；同时进行阻尼因子更新并确定迭代质量，其中迭代质量为迭代失败或迭代成功；若预测结果为成功分支则执行步骤七，若预测结果为失败分支，则执行步骤八；步骤七，计算当前位姿的残差的雅可比矩阵，然后构建标准方程并对其进行线性方程组求解以得到位姿增量；步骤八，使用除法求解当前构建好的标准方程，得到当前位姿变量的求解结果；步骤九，基于预测结果和迭代质量调整迭代计算流程：若预测结果与迭代质量相一致，则等待位姿增量或当前位姿变量的求解结果后，执行步骤十；若预测结果与迭代质量不一致，则基于不一致的具体情形执行不同调整策略：若预测结果为成功分支而迭代质量为迭代失败，则重新执行步骤八，并重新预测下一次的迭代低质量，得到新的预测结果后继续进行迭代计算流程调整；若预测结果为失败分支而迭代质量为迭代成功，则重新执行步骤七，并重新预测下一次的迭代低质量，得到新的预测结果后继续进行迭代计算流程调整；步骤十，基于位姿增量或当前位姿变量的求解结果确定当前时刻的更新后的位姿，再返回步骤三；步骤十一，检测是否收到定位结束指令，若否，则转到步骤二，继续获取图像数据；若是，则输出所有时刻的更新后的位姿，形成待定位目标设备的轨迹图。2.如权利要求1所述的基于动态分支预测的迭代求解的面向视觉定位方法，其特征在于，步骤二中，图像数据为二维灰度图像。3.如权利要求2所述的基于动态分支预测的迭代求解的面向视觉定位方法，其特征在于，步骤二中，二维灰度图像的每个位置的像素值的值域为0~255。4.如权利要求1所述的基于动态分支预测的迭代求解的面向视觉定位方法，其特征在于，步骤四中，图像预处理包括：特征点提取和特征点匹配。5.如权利要求1所述的基于动态分支预测的迭代求解的面向视觉定位方法，其特征在于，步骤五中，判断视觉定位的迭代是否结束的方式为：判断成功迭代总次数是否达到目标阈值来判断视觉定位的迭代是否结束。6.如权利要求1所述的基于动态分支预测的迭代求解的面向视觉定位方法，其特征在于，步骤六中，基于当前位姿的残差为特征点的重投影误差。7.如权利要求1至6任一项所述的基于动态分支预测的迭代求解的面向视觉定位方法，其特征在于，基于历史预测结果预测下一次的迭代质量，得到预测结果具体为：定义四种预测状态：强失败态，弱失败态，弱成功态，强成功态；其中，初始态为弱成功态；若当前为弱成功态且最近的历史预测结果为失败分支，则下一个预测状态为弱失败态；若当前为弱成功态且最近的历史预测结果为成功分支，则下一个预测状态为强成功态；若当前为强成功态且最近的历史预测结果为成功分支，则下一个状态继续为强成功态；若当前为强成功态且最近的历史预测结果为失败分支，则下一个状态为弱成功态；若当前为弱失败态且最近的历史预测结果为失败分支，则下一个状态为弱成功态；若当前为弱失败态且最近的历史预测结果为成功分支，则下一个状态为强失败态；若当前为强失败态且最近的历史预测结果为成功分支，则下一个状态继续为强失败态；若当前为强失败态且最近的历史预测结果为失败分支，则下一个状态为弱失败态；若下一个预测状态处于强失败态或弱失败态时，则预测结果为失败分支；若下一个预测状态处于弱成功态或强成功态时，则预测结果为成功分支。
说明书desc
技术领域本发明属于视觉定位技术领域，具体涉及一种基于动态分支预测的迭代求解的面向视觉定位方法。背景技术视觉定位是自动驾驶，移动机器人，增强现实等应用中的核心模块。相比于传统的激光雷达定位，视觉定位具有小型化，成本低，获取信息丰富的优点，成为当前研究的热点。视觉定位通常使用迭代求解的方法来优化设备的位置和姿态，现实中存在各种各样的噪声，这些都会对视觉定位算法造成很大的干扰。为了能够较为准确地得到设备的位姿，通常视觉定位算法中会构建最小二乘问题，通过迭代求解的方法，尽可能找到满足当前情况的最优解。有许多经典的迭代解法，比如最速下降法，高斯牛顿法，列文伯格-马夸尔特法。其中，最速下降法虽然每次都可以沿着最大的梯度方向下降，但是在最优值附近容易产出震荡，不容易收敛。高斯牛顿法利用泰勒的二阶展开，在最优值附近有更好地近似效果，但是二阶矩阵在实际计算中过于复杂。列文伯格-马夸尔特法通过雅可比矩阵来近似求出二阶导数，同时利用阻尼因子来平衡下降速率和近似效果，在收敛速度和求解效果上都有不错的表现，被广泛使用。在本发明的技术方案的实现过程中，发明人发现：现有的对视觉定位的这些迭代算法往往由于高复杂度成为计算占比最大的模块，影响了视觉定位技术在嵌入式这类资源受限的移动平台的部署。在迭代算法中会进行多轮计算，每一轮计算完成后会进行迭代质量的判断，如果判断结果是成功，则接受本轮迭代，开启下一轮计算，这种情况称为成功分支；否则，则回退到更新前的状态，继续计算，这种情况称为失败分支。图1给出了现有的迭代算法的迭代过程，其首先计算残差、雅可比，然后构建对应的标准方程，以计算对应的结果，待计算完结果后对数据进行更新；接着进行阻尼因子更新并判断迭代质量，若成功分支，则使用更新后数据继续迭代，包括残差计算、雅可比计算及构建标准方程；若失败分支，则退回更新前结果继续迭代，包括残差计算、雅可比计算及构建标准方程。在该过程中存在一个具有冗余计算的步骤，就是迭代质量的判断。迭代质量的判断的许多计算不仅与成功分支重复而且失败分支每次回退之后又要进行大量与之前重复的计算，这里存在大量的冗余计算以及串行模块多等问题，如图1所示，图1中的“*”表示失败迭代情况中重复的计算，“**”表示成功迭代情况中重复的计算。有鉴于此，有必要提出一种基于动态分支预测的迭代策略，以降低视觉定位的计算复杂度和减少计算资源的浪费，进而使得视觉定位技术可以更好地部署在嵌入式这类资源受限的移动平台。发明内容本发明提供了一种基于动态分支预测的迭代求解的面向视觉定位方法，可用于降低视觉定位的计算复杂度，以实现在计算资源受限的终端上部署基于迭代求解的视觉定位处理程序。本发明采用的技术问题为：基于动态分支预测的迭代求解的面向视觉定位方法，所述方法包括：步骤一，输入待定位目标设备的初始位姿；步骤二，基于待定位目标设备的视觉传感器获取图像数据；步骤三，确定待定位目标设备的当前位姿；若当前为首次定位处理，则以输入的初始位姿作为当前位姿；否则，以最近一次更新后的位姿作为当前位姿，即取出步骤十确定的更新后的位姿作为当前位姿；步骤四，对步骤二获取的图像数据进行图像预处理，以获取特征点坐标以及特征点匹配关系；步骤五，判断视觉定位的迭代求解是否结束，若是，则执行步骤十一；否则执行步骤六；步骤六，基于步骤四获取的特征点坐标以及特征点匹配关系计算当前位姿的残差；并基于历史预测结果预测下一次的迭代质量，得到预测结果，该预测结果为成功分支或失败分支；同时进行阻尼因子更新并确定迭代质量，其中迭代质量为迭代失败或迭代成功；若预测结果为成功分支则执行步骤七，若预测结果为失败分支，则执行步骤八；步骤七，计算当前位姿的残差的雅可比矩阵，然后构建标准方程并对其进行线性方程组求解以得到位姿增量；步骤八，使用除法求解当前构建好的标准方程，得到当前位姿变量的求解结果；步骤九，基于预测结果和迭代质量调整迭代计算流程：若预测结果与迭代质量相一致，则等待位姿增量或当前位姿变量的求解结果后，执行步骤十；若预测结果与迭代质量不一致，则基于不一致的具体情形执行不同调整策略：若预测结果为成功分支而迭代质量为迭代失败，则重新执行步骤八，并重新预测下一次的迭代低质量，得到新的预测结果后继续进行迭代计算流程调整；若预测结果为失败分支而迭代质量为迭代成功，则重新执行步骤七，并重新预测下一次的迭代低质量，得到新的预测结果后继续进行迭代计算流程调整；步骤十，基于位姿增量或当前位姿变量的求解结果确定当前时刻的更新后的位姿，再返回步骤三；步骤十一，检测是否收到定位结束指令，若否，则转到步骤二，继续获取图像数据；若是，则输出所有时刻的更新后的位姿，形成待定位目标设备的轨迹图。进一步的，步骤二中，图像数据为二维灰度图像。进一步的，步骤四中，图像预处理包括：特征点提取和特征点匹配。进一步的，步骤五中，判断视觉定位的迭代是否结束的方式为：判断成功迭代总次数是否达到目标阈值来判断视觉定位的迭代求解是否结束。进一步的，步骤六中，基于当前位姿的残差为特征点的重投影误差。进一步的，基于历史预测结果预测下一次的迭代质量，得到预测结果具体为：定义四种预测状态：强失败态，弱失败态，弱成功态，强成功态；其中，初始态为弱成功态；若当前为弱成功态且最近的历史预测结果为失败分支，则下一个预测状态为弱失败态；若当前为弱成功态且最近的历史预测结果为成功分支，则下一个预测状态为强成功态；若当前为强成功态且最近的历史预测结果为成功分支，则下一个状态继续为强成功态；若当前为强成功态且最近的历史预测结果为失败分支，则下一个状态为弱成功态；若当前为弱失败态且最近的历史预测结果为失败分支，则下一个状态为弱成功态；若当前为弱失败态且最近的历史预测结果为成功分支，则下一个状态为强失败态；若当前为强失败态且最近的历史预测结果为成功分支，则下一个状态继续为强失败态；若当前为强失败态且最近的历史预测结果为失败分支，则下一个状态为弱失败态；若下一个预测状态处于强失败态或弱失败态时，则预测结果为失败分支；若下一个预测状态处于弱成功态或强成功态时，则预测结果为成功分支。本发明提供的技术方案至少带来如下有益效果：本发明通过动态预测的方式实现以基于迭代求解的视觉定位处理，不管是成功迭代还是失败迭代，都减少了冗余的计算，而且减少了预测失败带来的额外计算和存储开销，大大减少了视觉定位的计算复杂度。本发明显著减少了现有基于迭代求解的视觉定位处理流程中的串行步骤，提升了定位处理的运行速度；特别地对于失败迭代，不仅减少了构建标准方程带来的冗余计算，而且使用除法快速求解来代替复杂的乔莱斯基分解方法求解，极大地提升了失败迭代情况下的处理速度；相比于传统列文伯格-马夸尔特方法，本发明对于成功迭代的情况完全等效，失败迭代的情况更偏向于最速下降法，整体定位处理精度基本保持一致。附图说明为了更清楚地说明本发明实施例中的技术方案，下面将对实施例描述中所需要使用的附图作简单地介绍，显而易见地，下面描述中的附图仅仅是本发明的一些实施例，对于本领域普通技术人员来讲，在不付出创造性劳动的前提下，还可以根据这些附图获得其它的附图。图1为现有的基于迭代求解的视觉定位的处理流程图。图2是本发明实施例提供的基于动态分支预测的迭代求解的面向视觉定位方法的流程图。图3是本发明实施例中的动态分支预测状态转移图。具体实施方式为使本发明的目的、技术方案和优点更加清楚，下面将结合附图对本发明实施方式作进一步地详细描述。在面向视觉定位的定位处理过程中，通常构建最小二乘模型进行求解，将设备的位姿作为自变量x，将位姿的残差f定义为特征点的重投影误差，表示残差f中的第i个特征点的位姿残差，总目标函数如下：最终的目标就是通过调整位姿变量x的值，使得总目标函数F最小，最终输出对应的位姿变量x，m表示特征点数量。作为一种可能的实现方式，如图2所示，本发明实施例提供的基于动态分支预测的迭代求解的面向视觉定位方法具体包括下列步骤：步骤1：初始化得到位姿，通过初始化方法得到设备的初始位姿；即首先通过初始化以获取初始化位姿，然后展开后续步骤；步骤2：获取摄像头数据，通过视觉传感器获取图像数据；优选的，步骤2中，通过视觉传感器获取的是二维灰度图像，每个位置的像素值是0~255范围的数；步骤3：获取当前位姿。如果是第一次，则取出步骤1初始化得到的设备的初始位姿；否则，取出步骤15更新后的位姿，然后带着图像数据，到步骤4进行预处理；步骤4：进行预处理，对图像数据进行预处理，得到特征点坐标以及匹配关系；其中，预处理是指通过特征点提取，特征点匹配可以得到特征点的二维坐标和匹配关系；步骤5：迭代结束判断，通过判断成功迭代总次数是否达到目标阈值来判断是否结束迭代求解过程，如果成功迭代总次数小于目标阈值，则执行步骤6，否则执行步骤16；步骤5中，通过判断成功迭代总次数是否达到目标阈值来判断是否结束迭代求解过程，迭代不能无限制的进行，通常在迭代开始前会设置一个最大成功迭代次数，在迭代过程中会统计成功迭代的次数，也就是被接受的迭代次数。通过比较统计的成功迭代次数跟设置的目标阈值来决定是否结束迭代。如果统计的成功迭代次数小于目标阈值，则继续迭代，执行步骤6；否则，结束迭代，执行步骤16；步骤6：计算残差，根据步骤3得到的位姿和步骤4预处理得到的特征点坐标以及匹配关系，可以计算出残差f；进一步的，步骤6中根据得到的位姿变量和特征点数据，计算目标优化问题的残差f。其中计算残差的方式为：根据构建的最小二乘问题来计算，残差是最小化重投影误差。残差等于当前时刻征点像素的灰度值减去估计出来的特征点像素的灰度值。步骤7：动态预测，根据历史预测结果，来预测下一次的更新结果情况：如果预测为成功分支，则执行步骤11；如果预测为失败分支，则执行步骤14；对于第一次迭代，预测为成功分支；步骤7的动态预测体现了本发明实施例的分支预测的第一个思想，动态预测，结合历史预测结果来进行预测。这里有四种状态，强失败态，弱失败态，弱成功态，强成功态。一开始是弱成功态，具体的状态转移关系如图3所示，若分支预测错误，则下一个状态为弱失败态，否则为强成功态；若当前为强成功态且分支预测正确，则下一个状态继续为强成功态；若当前为强成功态且分支预测错误，则下一个状态为弱成功态；若当前为弱失败态且分支预测错误，则下一个状态为弱成功态；若当前为弱失败态且分支预测正确，则下一个状态为强失败态；若当前为强失败态且分支预测正确，则下一个状态继续为强失败态；若当前为强失败态且分支预测错误，则下一个状态为弱失败态。当目前处于强失败态，弱失败态时，预测进入失败分支。当目前处于弱成功态，强成功态时，预测进入成功分支。本发明实施例通过动态预测可以实现：减少成功分支的冗余计算，加速计算。相比传统的计算完结果后判断迭代质量，然后根据判断结果再进行下一次迭代的方案。本发明实施例中，当预测进入成功分支时。可以减少关于残差的重复计算，并且可以提前开启计算，达到加速计算的效果。减少因为错误预测而导致的计算浪费，当实际为失败分支，但是预测为成功分支时往往会造成计算的浪费。这里的动态预测可以有效的减少这部分计算浪费，特别是当实际为连续迭代失败的情况。步骤8：更新阻尼因子，记阻尼因子为u，如果是第一次迭代，则阻尼因子为预设值。否则，先计算出比例因子，如果比例因子大于0，则减小阻尼因子，表示当前算法优化方向不错；否则，增大阻尼因子，表示当前算法优化方向偏差较大；步骤9：判断迭代质量，首先保存当前残差，用于跟下一次迭代残差比较。对于第一次迭代，则接受迭代，转到步骤5；对于其他次迭代，如果输入残差小于上一轮保存的残差，则认为迭代成功，反之则认为迭代失败，最后，转到步骤10；迭代质量的判断是指对于上一次迭代结果是否接受，接受的标准是让问题的残差变小。所以进行迭代质量判断的流程是：得到更新后的数据，计算出新的残差，将新残差与旧残差进行比较，如果新残差小则接受迭代，表示迭代成功，否则拒绝迭代，表示迭代失败；步骤10：预测更新，该步骤中根据预测结果和实际结果来更新预测状态，同时调整计算流程：如果预测结果跟实际结果一样，则不改变原来的计算，等待求解结果后，转到步骤15；反之，如果预测结果与实际结果不一样，当预测为成功分支，实际为迭代失败时，立刻转到步骤14；当预测为失败分支，实际为迭代成功时，立刻转到步骤11；即该步骤中，根据图2的状态转移关系，结合步骤9得到的实际迭代结果和步骤7中当前的预测状态，完成预测更新。比如当前是强失败态，如果预测失败，则变成弱失败态，如果再预测失败，则变成弱失败态。步骤11：计算雅可比矩阵J，对残差求一阶导，得到雅可比矩阵J；步骤12：构建标准方程：首先根据步骤6得到的残差f，步骤7得到的阻尼因子u，步骤11得到的雅可比矩阵J，计算出海森矩阵H和向量b：；；然后根据海森矩阵H和向量b构建标准方程H*deltax_x=b，其中，deltax_x表示位姿增量；步骤13：线性方程组求解，求解步骤12构建的标准方程，使用线性方程组求解的方法，利用cholesky方法求解位姿增量delta_x，转到步骤10；步骤14：使用除法求解步骤12构建的标准方程，其中，使用除法快速求解的方法，将海森矩阵H近似为矩阵uI，则标准方程变成uI*delta_x=b，求解得到变量x = b / u，转到步骤10；步骤13和步骤14中都是求解步骤12构建的标准方程，但是步骤13是成功迭代分支下使用方程组求解，使用cholesky方向进行方程组求解。步骤14是失败分支下使用除法求解，这里体现了分支预测的第二个思想，减少失败分支的冗余计算。在传统方案中，在一旦判断迭代失败，则会更新阻尼因子，然后把数据恢复到更新前的状态，再进行迭代，此时计算残差，计算雅可比都跟上一次迭代完全一样，甚至构建标准方程的时候，只是由于阻尼因子不同而导致海森矩阵的主对角元素不同，其他部分数据跟上一次迭代完全一样，这就导致了许多重复的计算。直接存储上一次迭代中计算的海森矩阵和向量确实可以节省许多重复的计算，但是往往实际问题中海森矩阵的维度都是几百上千维，会造成很大的存储压力。所以本发明实施例中，从列文伯格-马夸尔特的理论思想出发，即在迭代失败的时候更倾向于使用最速下降法。所以当迭代失败时，直接选择使用近似最速下降法，将海森矩阵H近似为uI，则标准方程变成uI*delta_x=b，通过除法快速求解。不仅减少了迭代失败后的大量重复计算，而且避免了大数据量的存储。步骤15：更新优化问题的位姿变量，根据步骤13或者步骤14求解的位姿增量得到更新后的位姿变量x_new = delta_x + x，转到步骤5；步骤15是用于实现数据更新，即对位姿变量进行更新，对于位置变量可以直接使用加法进行更新，对于旋转变量可以采用四元数更新，也可以采用旋转矩阵更新等；步骤16：算法是否结束，根据具体运行情况决定是否结束算法，如果是，则转到步骤17；否则，转到步骤2，继续获取新输入数据；步骤16中，在根据具体运行情况决定是否结束算法时，通常是根据现实应用中设备是否停止使用来判断，如果是，则转到步骤17；否则，转到步骤2，继续获取新输入数据；步骤17：输出所有更新后的位姿，所有位姿形成轨迹图。本发明实施例提出的基于动态分支预测的迭代求解的面向视觉定位方法在基于迭代求解的视觉定位领域中有着极其重要的作用，其既能在收敛速度和求解效果上都有不错的表现，又能减少迭代算法的复杂度，实现快速计算。相比于传统单纯使用列文伯格-马夸尔特方法，本发明实施例方法不管是对成功迭代还是对失败迭代，都减少了冗余的计算，大大减少了算法的复杂度；同时本发明实施例方法大大减少了现有视觉定位的迭代处理中的串行步骤，提升了运行速度；特别地对于失败迭代，本发明实施例方法不仅减少了构建标准方程带来的冗余计算，而且使用除法快速求解来代替复杂的乔莱斯基分解方法求解，极大地提升了失败迭代情况下的速度。本发明实施例方法对于以基于迭代求解的视觉定位为主的应用，可以在保持不错的收敛速度和求解效果的同时，减少基于迭代求解的视觉定位的迭代计算复杂度，提高运行速度，对于实时性要求高的场景，有更重要的应用意义。最后应说明的是：以上实施例仅用以说明本发明的技术方案，而非对其限制；尽管参照前述实施例对本发明进行了详细的说明，本领域的普通技术人员应当理解：其依然可以对前述各实施例所记载的技术方案进行修改，或者对其中部分技术特征进行等同替换；而这些修改或者替换，并不使相应技术方案的本质脱离本发明各实施例技术方案的精神和范围。以上所述的仅是本发明的一些实施方式。对于本领域的普通技术人员来说，在不脱离本发明创造构思的前提下，还可以做出若干变形和改进，这些都属于本发明的保护范围。
