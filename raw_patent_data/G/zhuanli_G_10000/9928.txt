标题title
车道线检测方法、电子设备及车辆
摘要abst
本发明提供一种车道线检测方法、电子设备及车辆，本发明基于深度学习，将栅格化的车辆前视图片输入预训练的模型，将车道线实例分割问题转化为栅格单元的类别感知预测和分割掩码预测两个子任务，如果车道线落在某些栅格单元内，那么这些栅格单元负责同时预测此车道线的分类信息和分割信息，由于图片中栅格单元与车道线实例存在对应关系，通过对模型输出的分类信息和分割信息进行简单处理就可以直接输出每条车道线的实例分割结果，因此本发明省去了复杂的后处理步骤，从而节省了大量的计算资源并可以大规模部署在低成本的车载嵌入式设备上。
权利要求书clms
1.一种车道线检测方法，其特征在于，包括：S101、对获取的车载前视图片进行栅格化；S102、将栅格化的车辆前视图片输入预训练的网络模型，得到图片中每个栅格单元的车道线类别的置信度以及车道线预测分割掩码；训练所述模型的样本图片集包含栅格化的车辆前视图片，所述车辆前视图片包含车道线，并标注有与车道线对应的标签；S103、基于每个栅格单元的置信度过滤掉不含车道线的栅格单元；S104、对过滤后的栅格单元对应的车道线预测分割掩码进行二值化；S105、对二值化后的车道线预测分割掩码进行非极大值抑制NMS，保留的车道线预测分割掩码即为最终的车道线的实例分割结果。2.根据权利要求1所述的一种车道线检测方法，其特征在于，所述栅格化的车辆前视图片上具有尺寸相同的S×S个栅格单元。3.根据权利要求2所述的一种车道线检测方法，其特征在于，所述模型被训练为：通过backbone网络从输入的图片中提取特征，输出特征层，将所述特征层同时输入分类分支head网络以及分割分支head网络，分别得到图片每个栅格单元的车道线类别的置信度以及车道线预测分割掩码。4.根据权利要求3所述的一种车道线检测方法，其特征在于，所述分类分支head网络进行如下处理，得到栅格单元的车道线类别的置信度：将输入的特征层的大小由双线性插值到，、、分别代表特征层的高、宽以及通道数；将大小为的特征层输入由四个3×3卷积核所组成的堆叠卷积层，预测每个栅格单元上是否有车道线，输出空间为，其中每个元素代表相应栅格单元包含车道线的概率。5.根据权利要求4所述的一种车道线检测方法，其特征在于，所述分割分支head网络进行如下处理，得到栅格单元的车道线预测分割掩码：生成与输入的特征层高宽相同且分别包含归一化的从-1到1的X方向像素坐标和Y方向像素坐标的两个向量，将所述两个向量附加到所述特征层上构成新特征层，其尺度为，其中最后两个通道为归一化的X方向像素坐标与Y方向像素坐标；将新特征层输入由四个3×3卷积核所组成的堆叠卷积层，预测每个栅格单元的车道线分割掩码，输出空间为，其中第三维度的每个通道代表了对应栅格单元的车道线预测分割掩码，第三维度第通道负责分割图片第i行第j列的栅格单元，。6.根据权利要求1或5所述的一种车道线检测方法，其特征在于，所述车道线对应的标签包括图片中每一条车道线的回归框以及每一条车道线的多边形的顶点集合。7.根据权利要求6所述的一种车道线检测方法，其特征在于，训练所述模型的损失函数为focal loss和dice loss，其中：所述focal loss用于优化分类分支head网络的损失函数；所述dice loss用于优化分割分支head网络的损失函数。8.根据权利要求7所述的一种车道线检测方法，其特征在于，所述步骤S103进一步包括：将每个栅格单元的置信度与预设的第一阈值进行比较，过滤掉不含车道线的栅格单元。9.根据权利要求8所述的一种车道线检测方法，其特征在于，所述步骤S104进一步包括：从过滤后的栅格单元中取置信度最大的预定数量的栅格单元，对所取栅格单元对应的车道线预测分割掩码二值化。10.根据权利要求9所述的一种车道线检测方法，其特征在于，所述步骤S104通过以下步骤对车道线预测分割掩码进行二值化：将车道线预测分割掩码上的每个像素值与预设的第二阈值进行比较，若像素值大于或等于所述第二阈值，则修改该像素值为1，否则，修改该像素值为0。11.根据权利要求10所述的一种车道线检测方法，其特征在于，所述步骤S105进一步包括：a、将二值化后的车道线预测分割掩码加入集合S；b、按照对应的栅格单元的置信度的大小对所述集合S中的车道线预测分割掩码进行降序排列；c、选取所述集合S中置信度最大的车道线预测分割掩码，过滤掉所述集合S中与所述车道线预测分割掩码的IOU大于等于第三阈值的车道线预测分割掩码，待所述集合S中剩余的车道线预测分割掩码与所述车道线预测分割掩码的IOU都小于所述第三阈值，将所述置信度最大的车道线预测分割掩码从集合S中取出并放入集合；d、循环步骤c，直到所述集合S中没有车道线预测分割掩码，此时所述集合包含最终的车道线的实例分割结果。12.一种电子设备，其特征在于，包括存储模块，所述存储模块包括由处理器加载并执行的指令,所述指令在被执行时使所述处理器执行根据权利要求1-11任一项所述的一种车道线检测方法。13.一种车辆，其特征在于，具有根据权利要求12所述的一种电子设备。
说明书desc
技术领域本发明属于车道线检测技术领域，尤其涉及一种车道线检测方法、电子设备及车辆。背景技术现阶段，随着人工智能技术的发展和成熟，自动驾驶技术以及先进辅助驾驶系统成为当下热门的研究领域。车道线检测是其中一项基础而重要的任务，它的目标是高效且准确地检测车道线在道路上的位置，从而保障车辆被定位在当前行驶的车道内，并辅助随后的车道偏离或轨迹规划模块做出合理的决策。大部分现有车辆都会配备前视摄像头，我们可以通过车载视觉系统实时地获取车辆前方的道路图像，从而在该图像上对车道线进行识别与定位来计算各个车道的位置，以便轨迹规划模块控制车辆保持在相应的车道行驶。因此，实时且精确地执行车道线检测是实现完全自动驾驶的关键推动因素。传统的车道线检测方法主要基于边缘检测、反投影变化、霍夫变换、聚类分析和相关后处理算法等一系列计算机视觉算法。该类方法的优势在于计算量低，在高速公路等路况良好的情况下性能稳定，但是难以处理复杂路况，不能在真实场景中稳定工作。另一类基于深度学习的车道线检测算法引起了更多的关注。该类方法从车道线语义分割的角度入手，将车道线与背景进行分离，但语义分割只能得到车道线的像素位置信息，无法得到每一条车道线的解析表达式，因此基于语义分割的车道线检测方法无法区分不同的车道线实例，需要进一步的后处理操作。为了克服上述问题，最具代表性的解决方法是基于深度学习的车道线实例分割方法，是将实例分割算法用在车道线检测上，在输出车道线语义分割结果的同时，还会输出一支车道线特征向量分支，通过运用聚类方法或特征嵌入方法进一步将车道线语义分割的结果转化成实例分割。上述方法在实际应用中仍然存在一些问题，车道线特征向量分支还需要复杂且耗时的后处理步骤，并依赖人工制定的车道线推断规则，难以在低成本的车载嵌入式设备上进行大规模部署。发明内容基于此，针对上述技术问题，提供一种处理简单、高效的车道线检测方法、电子设备及车辆。本发明采用的技术方案如下：一方面，提供一种车道线检测方法，其特征在于，包括：S101、对获取的车载前视图片进行栅格化；S102、将栅格化的车辆前视图片输入预训练的网络模型，得到图片中每个栅格单元的车道线类别的置信度以及车道线预测分割掩码；训练所述模型的样本图片集包含栅格化的车辆前视图片，所述车辆前视图片包含车道线，并标注有与车道线对应的标签；S103、基于每个栅格单元的置信度过滤掉不含车道线的栅格单元；S104、对过滤后的栅格单元对应的车道线预测分割掩码进行二值化；S105、对二值化后的车道线预测分割掩码进行非极大值抑制NMS，保留的车道线预测分割掩码即为最终的车道线的实例分割结果。另一方面，提供一种电子设备，包括存储模块，所述存储模块包括由处理器加载并执行的指令，所述指令在被执行时使所述处理器执行上述的一种车道线检测方法。再一方面，提供一种车辆，该车辆具有上述一种电子设备。本发明基于深度学习，将栅格化的车辆前视图片输入预训练的模型，将车道线实例分割问题转化为栅格单元的类别感知预测和分割掩码预测两个子任务，如果车道线落在某些栅格单元内，那么这些栅格单元负责同时预测此车道线的分类信息和分割信息，由于图片中栅格单元与车道线实例存在对应关系，通过对模型输出的分类信息和分割信息进行简单处理就可以直接输出每条车道线的实例分割结果，因此本发明省去了复杂的后处理步骤，从而节省了大量的计算资源并可以大规模部署在低成本的车载嵌入式设备上，同时，本发明适用于各种形状的车道线，包括直线，曲线和S形曲线等车道线，不需要人工制定车道线推断规则，对车道线的纹理缺失具有一定的容忍度。附图说明下面结合附图和具体实施方式对本发明进行详细说明：图1为本发明的流程图；图2为本发明的模型的示意图；图3为本发明的车辆前视图片的标注示意图；图4为本发明的车辆前视图片栅格化示意图；图5为本发明的车道线的真实分割掩码的示意图。具体实施方式如图1所示，本说明书实施例提供一种车道线检测方法，包括：S101、对获取的车载前视图片进行栅格化：在待检测的车辆前视图片上均匀地分割出个栅格单元，代表图片一个方向上的栅格单元的数量。其中，车辆前视图片为车载前视单目摄像头采集的图片，在本实施例中，S设置为12，参见图4。S102、将栅格化后的图片输入预训练的模型，得到图片中每个栅格单元的车道线类别的置信度以及车道线预测分割掩码。本发明将车道线实例分割问题转化为栅格单元的类别感知预测和分割掩码预测两个子任务。如果车道线落在某些栅格单元内，那么这些栅格单元负责同时预测此车道线的分类信息和分割信息，由于图片中栅格单元与车道线实例存在对应关系，故本发明可以直接输出每条车道线的实例分割结果，这样省去了复杂的后处理步骤，从而节省了大量的计算资源并可以在低成本的车载嵌入式设备上大规模部署。预训练即离线训练，用于在实际场合使用模型之前，通过让模型的输出和我们的预期更接近，从而对模型的参数进行固定。上述模型参见图2，其被训练为：通过backbone网络从输入的图片中提取特征，输出特征层，将特征层同时输入分类分支head网络以及分割分支head网络，分别得到图片每个栅格单元的车道线类别的置信度以及车道线预测分割掩码。backbone网络是在深度学习中用于提取特征的神经网络，它的输出是特征层F，可以采用resnet网络、vggnet网络、mobilenet网络或者shufflenet网络。head网络是一种将提取的特征转化成最终预测结果的神经网络。对于分类任务，head输出一个分类结果，在本发明中，分类分支head网络输出图像栅格单元属于车道线的类别概率，分割分支head网络输出图像栅格单元的车道线预测分割掩码。本发明的模型基于深度神经网络，具有强大的特征提取能力，网络模型可以根据输入图片自适应地提取强鲁棒性的特征，这些特征使得模型识别能力得到提升，因此，对车道线的纹理缺失具有一定的容忍度，并且适合处理复杂路况。具体地，分类分支head网络进行如下处理，得到栅格单元的车道线类别的置信度：1、将输入的特征层的大小由双线性插值到，、、分别代表特征层的高、宽以及通道数。2、将大小为的特征层输入由四个3×3卷积核所组成的堆叠卷积层，预测每个栅格单元上是否有车道线，输出空间为，其中每个元素代表相应栅格单元包含车道线的概率。分割分支head网络进行如下处理，得到栅格单元的车道线预测分割掩码：1、生成与输入的特征层高宽相同且分别包含归一化的从-1到1的X方向像素坐标和Y方向像素坐标的两个向量，将两个向量附加到特征层上构成新特征层，其尺度为，其中最后两个通道为归一化的X方向像素坐标与Y方向像素坐标。由于分割分支head网络是一种FCN全卷积网络结构，其对空间位置信息不够敏感，但分割分支是基于图像栅格单元的位置来生成分割掩码，并且分割掩码必须通过不同的特征通道进行编码，因此我们通过增加归一化的像素坐标给予分割分支head网络产生对位置信息的敏感度。2、将新特征层输入由四个3×3卷积核所组成的堆叠卷积层，预测每个栅格单元的车道线分割掩码，分割分支使用一个3D张量的第三维度来编码这些分割掩码，因此输出空间为，其中第三维度的每个通道代表了对应栅格单元的车道线预测分割掩码，第三维度第通道负责分割图片第i行第j列的栅格单元，。训练上述模型的样本图片集包含栅格化的车辆前视图片，该车辆前视图片包含车道线，并标注有与车道线对应的标签，具体地，标签包括图片中每一条车道线的回归框以及每一条车道线的多边形的顶点集合，其中，表示多边形的顶点,和表示多边形顶点的X坐标和Y坐标，分别为最小值函数和最大值函数，参见图3。其中，如图4所示，车辆前视图片同样为车载前视单目摄像头采集的图片，栅格化同步骤S101，S设置为12。由于摄像头采集图片帧率较高，为了避免使用大量相似的图片，可以设置一定的帧间间隔选取其中一部分图片作为训练数据，这种方式平衡了数据的总量和数据的多样性。如果车道线落在某些栅格单元内，那么这些单元负责预测该车道线的分类信息和分割信息，例如，如图4所示，图中车道线由六个栅格单元负责。此外，如果栅格单元所包含的车道线像素数量低于阈值，这个栅格单元无法提供足够的纹理信息来预测车道线，那么它将被视为背景，阈值可以设为栅格单元所包含像素总量的10%；如果栅格单元包含多条车道线的像素，那么这个栅格被标记为忽略区域不参与训练。对于一张前视图片里的每条车道线，我们标注一个多边形的顶点集合来表示这条车道线，如图3所示，我们用四个多边形顶点集合来分别表示图中的四条车道线。根据车道线对应的多边形顶点集合，我们可以生成对应的回归框，如图3所示，我们用来分别表示图中四条车道线的回归框。根据车道线对应的多边形顶点集合和回归框，我们可以生成每条车道线对应的真实分割掩码：创建一张与输入图片相同尺寸的单通道图片M，初始化所有像素值为0，在图片M上连接车道线多边形顶点集合中每一个顶点构成一个连通区域，连通区域内的像素值设为1，最后根据此车道线对应的回归框B截取目标区域得到对应的真实分割掩码，如图5中的、、、所示，分别对应图3中P1、P2、P3、P4四条车道线的真实分割掩码。各种形状的车道线通过多边形顶点集合可以生成对应的各种形状的分割掩码，而本发明中栅格单元直接学习预测分割掩码，因此具备预测各种形状的车道线的能力，如直线，曲线和S形曲线等形状的车道线。在本实施例中，上述模型通过如下损失函数，并采用梯度反向传导优化模型的参数：，是用于分类分支head网络的损失函数，是用于分割分支head网络的损失函数，为用于调节两种损失函数平衡的参数，在本实施例中，设为3。定义为FL函数：，，其中，代表栅格单元的类别标注值，通过车道线的顶点集合P内顶点所构成的连通区域，可以实时地判断每个栅格单元是车道线类别还是背景类别，在满足预设像素阈值的情况下，将车道线类别的栅格单元标注为1，否则，标注为0，代表栅格单元的车道线类别的置信度，为关于的分段函数，和为损失函数的调节参数，在本实施例中，设为0.25，设为2。Focal Loss是一种在交叉熵损失函数基础上进行修改的损失函数，主要是为了解决目标检测中正负样本比例严重失衡的问题。定义为：，其中，，k代表分割分支head网络输出空间的第三维度第k通道，代表图片一个方向上的栅格单元的数量，floor为向下取整函数，mod为求余函数，表示图片中包含车道线的栅格单元的数量，代表栅格单元的车道线类别的置信度，代表第k个栅格单元的车道线预测分割掩码，代表第k个栅格单元的车道线真实分割掩码，可以根据车道线对应的多边形顶点集合和回归框得到，代表第i行第j列的栅格单元的车道线类别的置信度，代表指示函数，如果则指示函数返回1，否则返回0。定义为Dice Loss函数：是Dice系数，被定义为：，和分别代表预测分割掩码和真实分割掩码上的像素坐标处的像素值。Dice系数是一种用于评估两个样本的相似性的度量函数，取值范围在0到1之间，取值越大表示越相似，具体形式见定义。S103、基于每个栅格单元的置信度过滤掉不含车道线的栅格单元：将每个栅格单元的置信度与预设的第一阈值进行比较，过滤掉不含车道线的栅格单元。如可以将第一阈值设为0.1，当分类置信度大于等于0.1时，对应的栅格单元为车道线类别，否则，对应的栅格单元为背景类别，将其过滤。S104、对过滤后的栅格单元对应的车道线预测分割掩码进行二值化：将车道线预测分割掩码上的每个像素值与预设的第二阈值进行比较，若像素值大于或等于第二阈值，则修改该像素值为1，否则，修改该像素值为0。为了减少一些计算量，步骤S104可以先从过滤后的栅格单元中取置信度最大的预定数量的栅格单元，对所取栅格单元对应的车道线预测分割掩码二值化，预定数量可以设置为64。S105、对二值化后的车道线预测分割掩码进行非极大值抑制NMS，保留的车道线预测分割掩码即为最终的车道线的实例分割结果：a、将二值化后的车道线预测分割掩码加入集合S；b、按照对应的栅格单元的置信度的大小对集合S中的车道线预测分割掩码进行降序排列；c、选取集合S中置信度最大的车道线预测分割掩码，过滤掉集合S中与车道线预测分割掩码的IOU大于等于第三阈值的车道线预测分割掩码，待集合S中剩余的车道线预测分割掩码与车道线预测分割掩码的IOU都小于第三阈值，将置信度最大的车道线预测分割掩码从集合S中取出并放入集合；d、循环步骤c，直到集合S中没有车道线预测分割掩码，此时集合包含最终的车道线的实例分割结果。其中，第三阈值设置为0.75。IOU=交集/并集，是指重叠率，用于在特定数据集中检测相应物体准确度的一个标准，在本发明中，IOU是指两个车道线预测分割掩码的像素重叠率。通过非极大值抑制NMS算法可以去除重复多余的车道线，如图4所示，假设车道线P1经过6个满足条件的栅格单元，则每一个栅格单元都对应整条车道线的真实分割掩码，可能会出现6个栅格单元预测出6条相同车道线的情况，这个时候通过NMS算法去除重复多余的车道线，保留置信度最大的一条车道线。集合中的每个分割掩码与其它分割掩码的IOU都小于阈值，因此，每个分割掩码即对应一条车道线的实例分割结果。本发明不需要人工制定车道线推断规则，可以直接输出每一条车道线的实例分割结果，无需从车道线的语义分割结果中分离出每一条车道线。基于同一发明构思，本说明书实施例还提供一种电子设备，包括存储模块，存储模块包括由处理器加载并执行的指令，指令在被执行时使处理器执行本说明书上述一种车道线检测方法部分中描述的根据本发明各种示例性实施方式的步骤。其中，存储模块可以包括易失性存储单元形式的可读介质，例如随机存取存储单元和/或高速缓存存储单元，还可以进一步包括只读存储单元。在本实施例中，电子设备可以为车载嵌入式设备，其还包含存储模块和处理器之外，用于实现车载嵌入式设备各种功能的模块。可以以一种或多种程序设计语言的任意组合来编写用于执行本发明操作的程序代码，程序设计语言包括面向对象的程序设计语言—诸如Java、C++等，还包括常规的过程式程序设计语言—诸如“C”语言或类似的程序设计语言。程序代码可以完全地在用户计算设备上执行、部分地在用户设备上执行、作为一个独立的软件包执行、部分在用户计算设备上部分在远程计算设备上执行、或者完全在远程计算设备或服务器上执行。在涉及远程计算设备的情形中，远程计算设备可以通过任意种类的网络，包括局域网或广域网，连接到用户计算设备，或者，可以连接到外部计算设备。基于同一发明构思，本说明书实施例还提供一种车辆，该车辆具有上述一种电子设备，使该车辆具有车道线检测功能，此处不再具体赘述。但是，本技术领域中的普通技术人员应当认识到，以上的实施例仅是用来说明本发明，而并非用作为对本发明的限定，只要在本发明的实质精神范围内，对以上所述实施例的变化、变型都将落在本发明的权利要求书范围内。
