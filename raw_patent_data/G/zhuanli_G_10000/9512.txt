标题title
一种基于视频图像的前景物体阴影实时生成方法
摘要abst
本发明公开了一种基于视频图像的前景物体阴影实时生成方法，包括步骤：S1，对从视频图像中提取的前景物体求取最大外接矩阵，然后根据光源位置、光照方向，将物体绕水平、垂直方向进行扭曲形变，生成阴影图；S2，计算前景物体上的点在平面上影子的对应点，形成一对特征点，同理计算得到多对特征点，然后利用多对特征点计算得到不同平面之间的变换矩阵，利用变换矩阵确定物体影子的位置和方向；在该步骤中至少选取前景物体上的两个点作为基准点；S3，利用步骤S2中的变换矩阵计算前景物体中所有像素点在影子区域对应的像素点的坐标等；本发明解决虚拟演播室、抠像前背景融合、视频图像后期编辑中物体的阴影缺失或不一致问题等。
权利要求书clms
1.一种基于视频图像的前景物体阴影实时生成方法，其特征在于，包括步骤：S1，对从视频图像中提取的前景物体求取最大外接矩阵，然后根据光源位置和光照方向，将前景物体进行扭曲形变生成阴影图；S2，根据步骤S1生成的阴影图，计算前景物体上的点在平面上影子的对应点，形成一对特征点；同理计算得到多对特征点；然后利用多对特征点计算得到不同平面之间的变换矩阵，利用所述变换矩阵确定前景物体影子的位置和方向；在该步骤中至少选取前景物体上的两个点作为基准点，根据基准点能够保证阴影实时跟随前景物体；S3，利用步骤S2中所述变换矩阵计算前景物体中所有像素点在影子区域对应像素点的坐标，生成前景物体阴影。2.根据权利要求1所述的一种基于视频图像的前景物体阴影实时生成方法，其特征在于，在步骤S1中，所述将前景物体进行扭曲形变生成阴影图包括如下步骤：固定所述最大外接矩阵的最下端线段，将其绕着水平和垂直方向进行扭曲变形，模拟真实世界中各角度光照阴影的变化生成阴影图。3.根据权利要求2所述的一种基于视频图像的前景物体阴影实时生成方法，其特征在于，在步骤S1中，所述将前景物体进行扭曲形变生成阴影图包括生成360°阴影图。4.根据权利要求1所述的一种基于视频图像的前景物体阴影实时生成方法，其特征在于，在步骤S2中，计算前景物体上的点在平面上影子的对应点，包括如下步骤：根据光源位置或光的方向，计算光的方向向量，阴影投射平面法向量记为，物体高度为，则利用方向光与平面法向的点乘求出光线与影子的交点：上式中，为S点的坐标，表示方向光的向量坐标，表示前景物体与平面的交点point_b的坐标。5.根据权利要求1所述的一种基于视频图像的前景物体阴影实时生成方法，其特征在于，在步骤S2中，利用多对特征点计算得到不同平面之间的变换矩阵包括如下步骤：以单应变换来确定前景物体影子的位置和方向，单应变换具有八个自由度，利用四对特征点即可求出单应变换矩阵H，从而确定物体影子的位置和方向。6.根据权利要求1所述的一种基于视频图像的前景物体阴影实时生成方法，其特征在于，在步骤S2中，利用多对特征点计算得到不同平面之间的变换矩阵包括如下步骤：以仿射变换来确定前景物体影子的位置和方向，仿射变换具有六个自由度，利用三对特征点即可求出仿射变换矩阵，从而确定物体影子的位置和方向。7.根据权利要求2所述的一种基于视频图像的前景物体阴影实时生成方法，其特征在于，在步骤S1中，绕着水平方向进行扭曲变形包括通过对前景物体水平方向缩放和旋转。8.根据权利要求1所述的一种基于视频图像的前景物体阴影实时生成方法，其特征在于，在步骤S3之后，包括阴影平滑处理步骤：S4，通过滤波操作使阴影边缘平滑过渡，将衰减因子作为滤波系数控制阴影边缘的宽度和平滑程度。
说明书desc
技术领域本发明涉及视频图像处理领域，更为具体的，涉及一种基于视频图像的前景物体阴影实时生成方法。背景技术物体阴影是一种常见的光学现象，在视频图像后期编辑、抠像前背景融合、增强现实等应用中添加前景物体阴影可增强视频图像的真实感，提高视觉感受。近年来，虚拟演播室、视频图像分割、抠像合成等相关技术迅猛发展，其在电视电影、综艺娱乐、直播和军事等领域有着广泛的应用。无论是二维视频图像的前背景融合还是三维虚拟物体与实景融合中，物体阴影是真实感提升的重要元素，若缺少阴影，则物体看上去就像漂浮在空中，不真实。如何从视频图像中重建场景的光照和物体的阴影，是近年来学术界研究的热门课题，也是比较具有挑战的技术难题。计算机图形渲染技术中，常见的阴影渲染技术有Shadow mapping 技术、阴影体基于RGB图像的阴影分解技术，以经典的Retinex模型为基础，假设材质改变引起像素值变化较大，而光照变化引起的像素值变化相对较小。利用用户交互及图像全局/局部信息作为约束条件，将问题转换为一个能量方程来求解图像阴影。2）基于深度RGB-D图像的阴影分解技术，则是利用场景中的深度图来进行光照约束，根据场景几何信息来计算物体表面的明暗关系，从而计算图像中的阴影。由于自然场景中光照和材质信息往往较为复杂，计算复杂度高，难以实时，准确度不高；且需要人工交互信息作为先验输入，无法在直播类、视频类场景中广泛推广。基于全景图的阴影绘制方法是将拍摄的全景图像作为场景环境光照，获取光照信息用于渲染三维虚拟物体阴影，从而获得逼真的光照效果。但该类技术要求输入为全景图，且对真实物体进行三维重建，亦或渲染虚拟三维模型。从视频图像中提取物体阴影的技术是最为直接的一种方式，即在提取前景物体的同时，将物体的阴影也从原图中提取出来，最后将提取的前景物体和阴影与目标场景融合。这类技术有一个较大的应用限制：目标场景的光照必须与源前景物体所在场景的光照相同，否则会出现视觉上的错误，得不偿失。在虚拟演播室中，常用三维人物面片来模拟真实场景中的人物，将抠像后的图像用作三维面片纹理贴图，面片在虚拟场景中产生的阴影作为人物的阴影。当光照从面片正前/后方照射时，可产生较为逼真的阴影；当光照从面片侧面照射时，由于面片没有厚度，阴影逐渐变为线状，甚至消失。因此，在演播室中采用人物面片方式产生阴影会从根据光照角度不同，产生不同程度的失真。在极端情况下，无法产生阴影。发明内容本发明的目的在于克服现有技术的不足，提供一种基于视频图像的前景物体阴影实时生成方法，解决虚拟演播室、抠像前背景融合、视频图像后期编辑中物体的阴影缺失或不一致问题等。本发明的目的是通过以下方案实现的：一种基于视频图像的前景物体阴影实时生成方法，包括步骤：S1，对从视频图像中提取的前景物体求取最大外接矩阵，然后根据光源位置和光照方向，将前景物体进行扭曲形变生成阴影图；S2，根据步骤S1生成的阴影图，计算前景物体上的点在平面上影子的对应点，形成一对特征点；同理计算得到多对特征点；然后利用多对特征点计算得到不同平面之间的变换矩阵，利用所述变换矩阵确定前景物体影子的位置和方向；在该步骤中至少选取前景物体上的两个点作为基准点，根据基准点能够保证阴影实时跟随前景物体；S3，利用步骤S2中所述变换矩阵计算前景物体中所有像素点在影子区域对应像素点的坐标，生成前景物体阴影。进一步地，在步骤S1中，所述将前景物体进行扭曲形变生成阴影图包括如下步骤：固定所述最大外接矩阵的最下端线段，将其绕着水平和垂直方向进行扭曲变形，模拟真实世界中各角度光照阴影的变化生成阴影图。进一步地，在步骤S1中，所述将前景物体进行扭曲形变生成阴影图包括生成360°阴影图。进一步地，在步骤S2中，计算前景物体上的点在平面上影子的对应点，包括如下步骤：根据光源位置或光的方向，计算光的方向向量，阴影投射平面法向量记为，物体高度为，则利用方向光与平面法向的点乘求出光线与影子的交点：上式中，为S点的坐标，表示方向光的向量坐标，表示前景物体与平面的交点point_b的坐标。进一步地，在步骤S2中，利用多对特征点计算得到不同平面之间的变换矩阵包括如下步骤：以单应变换来确定前景物体影子的位置和方向，单应变换具有八个自由度，利用四对特征点即可求出单应变换矩阵H，从而确定物体影子的位置和方向。进一步地，在步骤S2中，利用多对特征点计算得到不同平面之间的变换矩阵包括如下步骤：以仿射变换来确定前景物体影子的位置和方向，仿射变换具有六个自由度，利用三对特征点即可求出仿射变换矩阵，从而确定物体影子的位置和方向。进一步地，在步骤S1中，绕着水平方向进行扭曲变形包括通过对前景物体水平方向缩放和旋转。进一步地，在步骤S1中，将光源方向俯仰角度设置在85°以下。进一步地，在步骤S3之后，包括阴影平滑处理步骤：S4，通过滤波操作使阴影边缘平滑过渡，将衰减因子作为滤波系数控制阴影边缘的宽度和平滑程度。本发明的有益效果包括：本发明提出一种基于视频图像的前景物体阴影实时生成方法，解决虚拟演播室、抠像前背景融合、视频图像后期编辑中物体的阴影缺失或不一致问题。本发明基于视频图像中前景物体，在目标场景生成逼真的物体阴影。其至少解决了如下三个关键技术问题：1. 对于任意拍摄的视频图像序列，提取前景物体，并根据目标场景生成视觉效果一致的前景物体阴影。2. 阴影视觉一致性，即与目标场景光照信息一致：阴影明暗和方向一致。3. 阴影生成算法效率实时，实测证明对于4K视频算法效率高于50fps。本发明的方法应用领域包括但不限于虚实融合中实景物体阴影生成、抠像前背景融合中物体阴影生成，以及视频图像后期编辑中物体阴影生成。附图说明为了更清楚地说明本发明实施例或现有技术中的技术方案，下面将对实施例或现有技术描述中所需要使用的附图作简单地介绍，显而易见地，下面描述中的附图仅仅是本发明的一些实施例，对于本领域普通技术人员来讲，在不付出创造性劳动性的前提下，还可以根据这些附图获得其他的附图。图1为本发明中的360°阴影图生成示意图；图2为本发明中的影子关系示意图；其中，两个光源light_pos1、light_pos2，光方向分别为light_direction1、light_direction2，和光照与物体的夹角，s1和s2为光线与影子的交点，shadow1和shaow2为物体阴影；图3为本发明中的阴影生成示意图。具体实施方式本说明书中所有实施例公开的所有特征，或隐含公开的所有方法或过程中的步骤，除了互相排斥的特征和/或步骤以外，均可以以任何方式组合和/或扩展、替换。需要对本领域人员说明的是，本发明中拍摄的视频图像中前景物体是已知条件，即前景物体已从视频图像中提取，常用的物体提取方法有抠像、分割等，详细的物体提取方法不是本发明讨论的重点，在此不详细讨论。在本发明的实施方案中，做出如下说明：1）通过抠像提取视频图像中的前景物体，前景物体可为1个或多个。将原视频图像中的某一帧表示为I，提取出的前景物体可表示为；其中I为RGB图像，为带alpha通道的RGBA图像，对于图像中像素表示该像素属于物体。2）阴影投射平面为水平面。如图1~图3所示，一种基于视频图像的前景物体阴影实时生成方法，从视频图像中提取出前景物体，可采用常见的抠像、分割等。对每个前景物体求取最大外接矩阵，记为。根据光源位置、光照方向，将前景物体绕水平、垂直方向进行扭曲形变，即可生成前景物体的阴影图，详细过程如下：固定最大外接矩阵最下端线段，将其绕着水平和垂直方向进行特定扭曲变形，即可生成360°阴影图，能够模拟真实世界中各角度光照阴影的变化。如图1所示，影子在水平面旋转角度r2，决定阴影投射的方向和大小；影子在垂直平面转角度r1，决定阴影投射的长短。如图3所示，在本实施例中最大外接矩阵指p1 p2 p3 p4，最下端指矩形的下边线段p1p2。阴影的生成可通过将最大外接矩阵在光照方向上进行扭曲变换而得。阴影方向计算：已知光源位置或光的方向，计算光的方向向量，阴影投射平面法向量记为，物体高度为，则可利用方向光与平面法向的点乘求出光线与影子的交点。如图2所示，根据影子投射原理，可得光线与平面的交点坐标如下：依据以上原理，可计算出光线与前景物体的最大外接矩阵的两个上端点的影子在平面上的交点，即为前景物体在平面上影子的两个端点。如图3所示，计算出在平面上影子的对应点，空间中，两平面之间变换为单应变换或仿射变换而得。本发明中，很容易寻找出前景物体与阴影的4对特征点用于求解变换矩阵。仿射变换具有6个自由度，需要3对特征点即可求出变换矩阵；单应变换具有8个自由度，需要4对特征点可求出变换矩阵。以上两种变换均可用于本发明方案提出的阴影求解。相较于仿射变换，单应变换更具有灵活性，因此本实施方案后续以单应变换来展开阴影计算的描述和验证，仿射变换不再赘述。根据图示前景物体的最大外接矩阵的4个特征点及其影子对应点，可求出单应变换矩阵H，从而确定物体影子的位置和方向。上式中，等表示矩阵中元素。根据图3求出的单应变换矩阵H，即可计算出最大外接矩阵中所有像素点在影子区域对应的像素点的坐标。其中像素坐标。通过插值算法求出阴影区域每个像素的像素值。阴影实时跟随物体处理：前景物体的最大外接矩阵有4个关键特征点用于生成变换矩阵，其中前景物体底端两个特征点固定不动，作为阴影跟随物体的基准点。因此，生成的阴影底端与前景物体底端对齐即可保证阴影实时跟随。如图3所示，为阴影和物体对齐的两个基准点。阴影的颜色：阴影颜色由光照强度与接受阴影物体的材质共同决定，光照越强，阴影颜色越深；反之，越浅。假设阴影强度范围为取值范围为0~1.0，为接受阴影的物体颜色。；上式中，表示阴影颜色，表示阴影强度，表示接受阴影的物体颜色。阴影的平滑处理：阴影边缘常会有锯齿，通过滤波操着使阴影边缘能够平滑过渡，衰减因子作为滤波系数控制阴影边缘的宽度和平滑程度。对于水平方向的阴影生成，前景物体的最大外接矩阵个特征点对应的阴影投射点退化为一条线，无法通过单应变换生成阴影。对前景物体的最大外接矩阵水平方向缩放和旋转来生成阴影。对于光源方向俯仰角度接近90°时，生成的阴影会无限长，需要俯仰角度限制在85°以下避免出现以上问题。本发明未涉及部分均与现有技术相同或可采用现有技术加以实现。本发明功能如果以软件功能单元的形式实现并作为独立的产品销售或使用时，可以存储在一个计算机可读存储介质中。基于这样的理解，本发明的技术方案本质上或者说对现有技术做出贡献的部分或者该技术方案的部分可以以软件产品的形式体现出来，该计算机软件产品存储在一个存储介质中，在一台计算机设备以及相应的软件中执行本发明各个实施例所述方法的全部或部分步骤。而前述的存储介质包括：U盘、移动硬盘、或者光盘等各种可以存储程序代码的介质，进行测试或者实际的数据在程序实现中存在于只读存储器、随机存取存储器等。
