标题title
一种基于多模态检索与轮廓引导的图像生成方法
摘要abst
本发明提出了一种基于多模态检索与轮廓引导的图像生成方法，步骤如下所述：S1：图文多模态检索生成原始图像：输入正向提示文本Prompt，对其进行分词和向量化处理，输出符合相似度阈值的图库中图像作为原始图像；S2：文字检测；S3：图像修复，去除图像中生成效果不好的元素；S4：边缘检测；S5：生成引导文本，S6：图像条件生成：设置支持外部输入条件的隐式扩散模型；输入S4生成的轮廓图作为外部条件，利用S5生成的引导文本在扩散模型中有条件的生成最终图像并输出，本发明有较好的通用性，通过检测已有图像的布局结构来引导图像生成，有效提升了图像生成效果。
权利要求书clms
1.一种基于多模态检索与轮廓引导的图像生成方法，其特征在于，S1：图文多模态检索生成原始图像：输入正向提示文本Prompt，对其进行分词和向量化处理，计算与图库中图像的相似度，并输出符合相似度阈值的图库中图像作为原始图像；S2：文字检测：输入S1生成的原始图像，从所述原始图像的集合中选取图像，先通过文字检测，获取所述图像中文本的位置，生成掩码Mask图像；S3：图像修复：输入S2生成的掩码Mask图像，若检测出所述掩码Mask图像中有文字，使用图像修复功能抹除文字后输出作为修复图像；若没有文字则直接输出所述掩码Mask图像作为修复图像；S4：生成轮廓条件：输入S3生成的修复图像，对其进行边缘检测，获取布局轮廓并生成轮廓图，作为图像生成的引导及约束条件；S5：生成引导文本：输入S1所述的正向提示文本Prompt检测图像的不同生成场景，并针对不同场景设定固定的正向关键词Prompt和负向关键词Negative Prompt作为引导文本；S6：图像轮廓引导：设置支持外部输入条件的隐式扩散模型；输入S5生成的引导文本，以S4生成的轮廓图作为外部条件，在隐式扩散模型中进行有条件的轮廓引导，生成最终图像并输出。2.由权利要求1所述的一种基于多模态检索与轮廓引导的图像生成方法，其特征在于，S1中所述向量化处理的方法是：分别利用文本编码器和图像编码器对文本和图像进行编码，计算文本向量xi和图像向量yi之间的夹角余弦相似度cos：如果夹角余弦相似度超过设定阈值，则该图像满足相似度条件，将所有满足相似度条件的图像编为一个集合，从这个集合中随机选择一张图像作为原始图像。3. 由权利要求1所述的一种基于多模态检索与轮廓引导的图像生成方法，其特征在于，S3中图像修复的方法为：使用OCR检测图像中的文字并标注文字位置，生成带标注文字的Mask图像，再使用扩散模型中的Stable Diffusion进行图像修复抹除文字，使其与图片背景融为一体。4.由权利要求3所述的一种基于多模态检索与轮廓引导的图像生成方法，其特征在于，所述扩散模型进行图像修复抹除文字的方法为，在扩散模型中将正向提示文本Prompt置空，负向提示文本Negative Prompt改为“文字，海报文字，涂抹文字”，提高CFG来提升文本影响的强度，从而文本编码得到的特征会引导生成过程只留下图像背景而去除文字。5.由权利要求1所述的一种基于多模态检索与轮廓引导的图像生成方法，其特征在于，S4所述边缘检测的方法为：基于原始图像所处的不同场景设置边缘检测算法，获取图像主体轮廓，生成只有灰度信息的掩码Mask图像作为轮廓图。6.由权利要求1所述的一种基于多模态检索与轮廓引导的图像生成方法，其特征在于，S6中设置支持外部输入条件的隐式扩散模型的损失函数LLDM为：其中，表示高斯采样过程；/＞表示时序去噪自编码过程；/＞表示用于外部条件的编码器，/＞表示将外部条件y映射为中间层表示。7.由权利要求1所述的一种基于多模态检索与轮廓引导的图像生成方法，其特征在于，S6中在隐式扩散模型中进行有条件的轮廓引导的方法为：S61： 将输入的文本和图像通过编码器编码成特征，且所述编码器使文本特征和图像特征表征对齐；S62：将S61中被编码的特征进行Concat连接，合并为一个特征并对其添加随机噪声使每次生成的图像不同；如果只有文本特征则不需要Concat连接；S63：将S63中添加随机噪声后的特征送入特征预测器UNet进行降噪扩散并迭代，在隐式空间中生成更接近真实图像的特征；所述扩散模型降噪扩散过程为：其中，表示高斯采样过程；/＞表示其引入了隐式编码器/＞，/＞；t=1…T是时序去噪自编码过程，其根据输入/＞去预测对应去噪后的结果，其中/＞是输入x的加入噪音后的结果；S64：通过变分自编码器VAE将隐式空间中的特征转换为像素空间中的图像并输出。8.由权利要求7所述的一种基于多模态检索与轮廓引导的图像生成方法，其特征在于，在S61中，文本和图像通过编码器编码成特征的方法为：其中，示引入隐式编码器/＞，/＞表示将/＞转换为/＞，从而让文字或图像特征在隐式空间中表征；当图像作为所述扩散模型的输入时，扩散模型会首先将输入的图像通过图像编码器编码到隐式特征空间，同时将输入文本通过文本编码器编码到同一隐式特征空间。9.由权利要求7所述的一种基于多模态检索与轮廓引导的图像生成方法，其特征在于，在S63中，所述Unet是一种前后对称式结构，前半部分包含8个主编码块，后半部分包含8个主解码块；每个块中包含卷积神经网络ResNet和图像注意力网络ViT；所述卷积神经网络ResNet用于全局特征的编解码；所述图像注意力网络ViT包含交叉注意力和自注意力机制，用于局部特征的编解码。10.由权利要求7所述的一种基于多模态检索与轮廓引导的图像生成方法，其特征在于，在S63中，所述特征预测器UNet进行降噪扩散的方法为：使用一个由4个4核和2×2步长卷积层组成的微型网络作为编码器，其形状为16×32×64×128，将图像空间条件/＞编码为特征映射：为转换后的特征图；该网络会将512×512的图像条件转换为64×64的特征图。11.由权利要求7所述的一种基于多模态检索与轮廓引导的图像生成方法，其特征在于，在S63中，所述迭代过程中利用内嵌于Unet的数值变量CFG控制文本提示对扩散过程的调节程度来控制文本特征影响的程度。
说明书desc
技术领域本发明涉及图像识别技术领域，特别涉及一种基于多模态检索与轮廓引导的图像生成方法。背景技术现有技术中，Latent Diffusion Models通过在一个高维表示空间中迭代原始噪声数据来生成图像，然后将表示结果解码为复杂精细的图像，将扩散模型的计算复杂度显著降低，使得以文字生成图片能够在较低算力的设备上以较短时间生成高清图片，大大降低了模型落地的门槛，也带来了以文字生成图片领域的火热。而Stable Diffusion基于Latent Diffusion Models做了改进，增添了更多的训练数据并使用更先进的文本编码器和更大的生成尺寸，使其专门用于以文字生成图片任务。目前效果较好的潜在扩散模型虽然在FID和PrecisionandRecall指标上普遍超越了GANs和LSGM，但是目前的扩散模型若直接根据文本引导生成图像，还存在以下问题：作为引导图像生成的Prompt，其包含关键词的质量会改变文本编码的结果，从而显著影响图像生成的质量，此方法存在一定的随机性和不可控性；由于训练数据集包含的场景及语义有限，在一定的迭代次数下，生成图片结果在复杂场景上的效果显著低于简单场景；在一些特殊场景上，例如人体人脸及文字生成，生成图片往往效果欠佳，且具有一定的随机性和不可控性。发明内容为了解决现有技术中图像生成存在一定的随机性和不可控性的问题，提出了一种基于多模态检索与轮廓引导的图像生成方法，减少图像生成的随机性和不可控性，从而提升图像的生成效果。具体方案如下所述：一种基于多模态检索与轮廓引导的图像生成方法，S1：图文多模态检索生成原始图像：输入正向提示文本Prompt，对其进行分词和向量化处理，计算与图库中图像的相似度，并输出符合相似度阈值的图库中图像作为原始图像；S2：文字检测：输入S1生成的原始图像，从所述原始图像的集合中选取图像，先通过文字检测，获取所述图像中文本的位置，生成掩码Mask图像；S3：图像修复：输入S2生成的掩码Mask图像，若检测出所述掩码Mask图像中有文字，使用图像修复功能抹除文字后输出作为修复图像；若没有文字则直接输出所述掩码Mask图像作为修复图像；S4：生成轮廓条件：输入S3生成的修复图像，对其进行边缘检测，获取布局轮廓并生成轮廓图，作为图像生成的引导及约束条件；S5：生成引导文本：输入S1所述的正向提示文本Prompt检测图像的不同生成场景，并针对不同场景设定固定的正向关键词Prompt和负向关键词Negative Prompt作为引导文本；S6：图像轮廓引导：设置支持外部输入条件的隐式扩散模型；输入S5生成的引导文本，以S4生成的轮廓图作为外部条件，在隐式扩散模型中进行有条件的轮廓引导，生成最终图像并输出。优选地，S1中所述向量化处理的方法是：分别利用文本编码器和图像编码器对文本和图像进行编码，计算文本向量xi和图像向量yi之间的夹角余弦相似度cos：如果夹角余弦相似度超过设定阈值，则该图像满足相似度条件，将所有满足相似度条件的图像编为一个集合，从这个集合中随机选择一张图像作为原始图像。优选地，S3中图像修复的方法为：使用OCR检测图像中的文字并标注文字位置，生成带标注文字的Mask图像，再使用扩散模型中的Stable Diffusion进行图像修复抹除文字，使其与图片背景融为一体。优选地，所述扩散模型进行图像修复抹除文字的方法为，在扩散模型中将正向提示文本Prompt置空，负向提示文本Negative Prompt改为“文字，海报文字，涂抹文字”，提高CFG来提升文本影响的强度，从而文本编码得到的特征会引导生成过程只留下图像背景而去除文字。优选地，S4所述边缘检测的方法为：基于原始图像所处的不同场景设置边缘检测算法，获取图像主体轮廓，生成只有灰度信息的掩码Mask图像作为轮廓图。优选地，S6中设置支持外部输入条件的隐式扩散模型的损失函数LLDM为：其中，表示高斯采样过程；/＞表示时序去噪自编码过程；/＞表示用于外部条件的编码器，/＞表示将外部条件y映射为中间层表示。优选地，S6中在隐式扩散模型中进行有条件的轮廓引导的方法为：S61：将输入的文本和图像通过编码器编码成特征，且所述编码器使文本特征和图像特征表征对齐；S62：将S61中被编码的特征进行Concat连接，合并为一个特征并对其添加随机噪声使每次生成的图像不同；如果只有文本特征则不需要Concat连接；S63：将S63中添加随机噪声后的特征送入特征预测器UNet进行降噪扩散并迭代，在隐式空间中生成更接近真实图像的特征；所述扩散模型降噪扩散过程为：其中，表示高斯采样过程；/＞表示其引入了隐式编码器/＞，；t=1…T是时序去噪自编码过程，其根据输入/＞去预测对应去噪后的结果，其中是输入x的加入噪音后的结果；S64：通过变分自编码器VAE将隐式空间中的特征转换为像素空间中的图像并输出。优选地，在S61中，文本和图像通过编码器编码成特征的方法为：其中，表示引入隐式编码器/＞，/＞表示将/＞转换为/＞，从而让文字或图像特征在隐式空间中表征；当图像作为所述扩散模型的输入时，扩散模型会首先将输入的图像通过图像编码器编码到隐式特征空间，同时将输入文本通过文本编码器编码到同一隐式特征空间。优选地，在S63中，所述Unet是一种前后对称式结构，前半部分包含8个主编码块，后半部分包含8个主解码块；每个块中包含卷积神经网络ResNet和图像注意力网络ViT；所述卷积神经网络ResNet用于全局特征的编解码；所述图像注意力网络ViT包含交叉注意力和自注意力机制，用于局部特征的编解码。优选地，在S63中，所述特征预测器UNet进行降噪扩散的方法为：使用一个由4个4核和2×2步长卷积层组成的微型网络作为编码器，其形状为16×32×64×128，将图像空间条件/＞编码为特征映射：为转换后的特征图；该网络会将512×512的图像条件转换为64×64的特征图。优选地，在S63中，所述迭代过程中利用内嵌于Unet的数值变量CFG控制文本提示对扩散过程的调节程度来控制文本特征影响的程度。本发明提出了一种基于多模态检索与轮廓引导的图像生成方法，步骤如下所述：S1：图文多模态检索生成原始图像：输入正向提示文本Prompt，对其进行分词和向量化处理，计算与图库中图像的相似度，并输出符合相似度阈值的图库中图像作为原始图像；S2：文字检测；S3：图像修复，去除图像中生成效果不好的元素；S4：边缘检测；S5：生成引导文本，针对不同场景设定固定的正向关键词Prompt和负向关键词Negative Prompt作为引导文本，可以提升特定场景中的图像生成效果；S6：图像条件生成：设置支持外部输入条件的隐式扩散模型；输入S4生成的轮廓图作为外部条件，利用S5生成的引导文本在隐式扩散模型中有条件的生成最终图像并输出，该步骤将前文所述的轮廓图编码为一种特征参与到循环扩散过程当中，以影响生成过程，达到了保证生成图像的布局和质量的技术效果。本发明上述技术特征产生了如下的综合技术效果：首先，本发明有较好的通用性，通过检测已有图像的布局结构来引导图像生成，减少图像生成的随机性和不可控性，从而提升图像的生成效果。同时，相比较只依靠文字信息生成图像技术，本发明降低了生成高质量图像的技术难度，不需要设计过于复杂详细的Prompt，依靠已有图像的布局信息，使得生成的结果更加可靠。第三，本发明针对图像生成效果并不好的场景进行了优化，如通过轮廓检测引导人体和脸部的生成，通过图像修复抹除效果不好的文字，使得生成图片更加真实。附图说明图1是一种基于多模态检索与轮廓引导的图像生成方法流程图。图2通过传统图像生成方法生成家居图像效果图。图3基于本发明所述方法生成家居图像效果图。图4通过传统图像生成方法生成图书馆图像效果图。图5基于本发明所述方法生成图书馆图像效果图。具体实施方式下面结合附图和实施例对本发明做进一步说明。如图1所示，一种基于多模态检索与轮廓引导的图像生成方法，S1：图文多模态检索生成原始图像：输入正向提示文本Prompt，对其进行分词和向量化处理，计算与图库中图像的相似度，并输出符合相似度阈值的图库中图像作为原始图像；S2：文字检测：输入S1生成的原始图像，从所述原始图像的集合中选取图像，先通过文字检测，获取所述图像中文本的位置，生成掩码Mask图像；S3：图像修复：输入S2生成的掩码Mask图像，若检测出所述掩码Mask图像中有文字，使用图像修复功能抹除文字后输出作为修复图像；若没有文字则直接输出所述掩码Mask图像作为修复图像；S4：生成轮廓条件：输入S3生成的修复图像，对其进行边缘检测，获取布局轮廓并生成轮廓图，作为图像生成的引导及约束条件；S5：生成引导文本：输入S1所述的正向提示文本Prompt检测图像的不同生成场景，并针对不同场景设定固定的正向关键词Prompt和负向关键词Negative Prompt作为引导文本；S6：图像轮廓引导：设置支持外部输入条件的隐式扩散模型；输入S5生成的引导文本，以S4生成的轮廓图作为外部条件，在隐式扩散模型中进行有条件的轮廓引导，生成最终图像并输出。图2为不通过轮廓引导、通过传统图像生成方法生成家居图像，图3为经过轮廓引导生成的家居图像；图4通过传统图像生成方法生成图书馆图像效果图，图5基于本发明所述方法生成图书馆图像效果图。可以看出，若没有轮廓图作为引导，则生成结果容易缺失空间感，同时很多家具也像色块涂抹出来一般，缺少真实感；但有了轮廓图，则会产生更真实的结果。优选地，S1中所述向量化处理的方法是：分别利用文本编码器和图像编码器对文本和图像进行编码，计算文本向量xi和图像向量yi之间的夹角余弦相似度cos：如果夹角余弦相似度超过设定阈值，则该图像满足相似度条件，将所有满足相似度条件的图像编为一个集合，从这个集合中随机选择一张图像作为原始图像。优选地，S3中图像修复的方法为：使用OCR检测图像中的文字并标注文字位置，生成带标注文字的Mask图像，再使用扩散模型中的Stable Diffusion进行图像修复抹除文字，使其与图片背景融为一体。优选地，所述扩散模型进行图像修复抹除文字的方法为，在扩散模型中将正向提示文本Prompt置空，负向提示文本Negative Prompt改为“文字，海报文字，涂抹文字”，提高CFG来提升文本影响的强度，从而文本编码得到的特征会引导生成过程只留下图像背景而去除文字。优选地，S4所述边缘检测的方法为：基于原始图像所处的不同场景设置边缘检测算法，获取图像主体轮廓，生成只有灰度信息的掩码Mask图像作为轮廓图。所述边缘检测算法包括传统的图像边缘检测算法，一般为Canny边缘检测算法和基于深度学习的图像分割算法，Canny边缘检测算法主要有错误率低、单点检测效果好及重复检测率低等优点，主要步骤如下：对输入的图像进行高斯平滑处理，这一部主要的目的是降低错误率；估算每一像素点的边缘梯度与方向；根据梯度方向，对梯度值进行非极大值抑制；用双阈值检测并连接边缘。这里的双阈值一般指低阈值和高阈值，小于低阈值的像素点赋值0；大于高阈值的像素点标记为边缘点，赋值1或255。基于深度学习的图像分割算法一般指基于CNN的图像分割算法，一般采用Mask R-CNN，主要原理如下：使用卷积神经网络，获取图像的特征图；将特征图中的每一点设定N个ROI范围，获得多个候选ROI区域，其中N是预先设定的，代表分类数量；将候选的ROI送入RPN网络进行二值分类，过滤掉一部分候选的ROI；对剩下的ROI区域进行ROIAlign操作；对这些ROI进行分类和Mask生成。在实际应用中，对于某些背景复杂、图像过于清晰的图像来说，使用Canny边缘检测容易生成过于稠密和细碎的边缘，从而引导Stable Diffusion生成颜色过于分散而不真实的图片；抑或图像清晰度不够，导致Canny边缘检测获得的边缘不够，难以闭合，这样会引导Stable Diffusion生成图像时主体颜色和背景色发生混淆。以上两种情况不适合使用传统边缘检测来实现，更适合使用基于深度学习的图像分割来实现。利用S5中正向提示文本对图像进行优化，例如添加一些描述图像细节的修饰词作为正向提示文本，例如改“天空，多云”为“夕阳下火红的天空，多云”以及改“小狗坐在长椅上”为“棕色的卷毛小狗坐在公园的长椅上，草坪背景，多云天气”。及添加“复杂，精细，…，锐化”等关键词来提升图像生成质量；也可以通过负向提示文本Negative Prompt来优化特定场景下图像生成的结果，例如针对人脸及人体的图像生成，在负向提示文本NegativePrompt中可以添加“糟糕的手，缺手指，多手指，…，糟糕的脸”等关键词来避免生成不真实的人体结构。所述特定场景主要指人像生成场景以及包含复杂空间关系的场景。例如一个半身人像，扩散模型生成时容易出现脸部细节、手部细节及肢体动作的模式崩溃，出现明显不真实的图像细节；又例如一个卧室画面，包含了床、衣柜、窗户和顶灯等，它们在画面中彼此有明显的空间关系，但扩散模型生成的图像经常会产生割裂感。优选地，S6中在隐式扩散模型中进行有条件的轮廓引导的方法为：S61： 将输入的文本和图像通过编码器编码成特征，且所述编码器使文本特征和图像特征表征对齐；S62：将S61中被编码的特征进行Concat连接，合并为一个特征并对其添加随机噪声使每次生成的图像不同；如果只有文本特征则不需要Concat连接；S63：将S63中添加随机噪声后的特征送入特征预测器UNet进行降噪扩散并迭代，在隐式空间中生成更接近真实图像的特征；S64：通过变分自编码器VAE将隐式空间中的特征转换为像素空间中的图像并输出。优选地，在S61中，当图像作为所述扩散模型的输入时，扩散模型会首先将输入的图像通过图像编码器编码到隐式特征空间，同时将输入文本通过文本编码器编码到同一隐式特征空间。优选地，在S63中，所述Unet是一种前后对称式结构，前半部分包含8个主编码块，后半部分包含8个主解码块；每个块中包含卷积神经网络ResNet和图像注意力网络ViT；所述卷积神经网络ResNet用于全局特征的编解码；所述图像注意力网络ViT包含交叉注意力和自注意力机制，用于局部特征的编解码。优选地，在S63中，所述特征预测器UNet进行降噪扩散的方法为：使用一个由4个4核和22步长卷积层组成的微型网络作为编码器，其形状为16×32×64×128，将图像空间条件/＞编码为特征映射：为转换后的特征图；该网络会将512512的图像条件转换为64×64的特征图。优选地，在S63中，所述迭代过程中利用内嵌于Unet的数值变量CFG控制文本提示对扩散过程的调节程度来控制文本特征影响的程度。应当指出，以上所述具体实施方式可以使本领域的技术人员更全面地理解本发明创造，但不以任何方式限制本发明创造。因此，尽管本说明书参照附图和实施例对本发明创造已进行了详细的说明，但是，本领域技术人员应当理解，仍然可以对本发明创造进行修改或者等同替换，总之，一切不脱离本发明创造的精神和范围的技术方案及其改进，其均应涵盖在本发明创造专利的保护范围当中。
