标题title
一种数据库分片复制过程中聚合分裂的处理方法及系统
摘要abst
本发明公开了一种数据库分片复制过程中聚合分裂的处理方法及系统，属于数据复制处理技术领域，该方法的实现包括增加注册缓存preSpan，KV缓存rangeKVbuf，副本复制状态机splitMergeState，在复制断开和重新注册这段时间缓存主库发送的KV，在复制注册成功后，补足发送缓存的KV。本发明实现分布式数据库主备复制过程中分片的聚合、分裂情况下保持主备数据一致性，解决了主备数据丢失的问题。
权利要求书clms
1.一种数据库分片复制过程中聚合分裂的处理方法，其特征在于，该方法的实现包括增加注册缓存preSpan，KV缓存rangeKVbuf，副本复制状态机splitMergeState，在复制断开和重新注册这段时间缓存主库发送的KV，在复制注册成功后，补足发送缓存的KV；所述注册缓存preSpan，在分片聚合时，将Left和Right副本的注册Span合并后赋值给Left副本的注册缓存preSpan；在分片分裂时，将Left副本的注册Span按照Left和Right的范围分割，分别赋值给Left和Right副本的注册缓存preSpan；所述KV缓存rangeKVbuf，在主库数据KV发送过程中，如果复制状态处于复制断开和重新注册成功之间，则将KV缓存到rangeKVbuf中，当复制重新注册成功后，将KV缓存的数据rangeKVbuf补足发给备库。2.根据权利要求1所述的一种数据库分片复制过程中聚合分裂的处理方法，其特征在于，所述副本复制状态机splitMergeState，复制断开时，主库发送的KV被缓存；复制重新注册成功时，主库发送缓存的KV；复制正常时，主库发送的KV被实时发送给备库。3.根据权利要求2所述的一种数据库分片复制过程中聚合分裂的处理方法，其特征在于，所述副本复制状态机splitMergeState，复制断开时，复制状态机为1，即复制断开状态；复制重新注册成功时，复制状态机为2，即复制重新注册状态；复制正常时，即复制状态机为0，即复制正常状态。4.根据权利要求1或2或3所述的一种数据库分片复制过程中聚合分裂的处理方法，其特征在于，主数据库KV发送过程具体如下：主库数据KV发送过程中，判断复制状态机为正常复制状态，则正常将KV向备库发送；主库数据KV发送过程中，如果复制状态机为复制断开状态，或复制重新注册成功状态，则将KV缓存到rangeKvBuffer中；主库数据KV发送过程中，独立线程携带超时机制检测状态机为复制重新注册成功状态，则将缓存rangeKvBuffer的KV向备库发送，并将副本状态机设置为复制正常状态。5.根据权利要求1或2或3所述的一种数据库分片复制过程中聚合分裂的处理方法，其特征在于，分片聚合或分裂过程具体如下：分片聚合或分裂处理过程中，如果是分片聚合，对Left副本，获取Left副本和Right副本的注册Span，做区间合并，将总的注册Span赋值给Left的注册缓存preSpan；并设置Left副本状态机为复制断开状态；分片聚合或分离处理过程中，如果是分片聚合，对Right副本，设置副本状态机为复制断开状态；分片聚合或分裂处理过程中，如果是分片分裂，对Left副本，获取原注册Span，按照Left副本和Right副本的范围分割Span，将属于Left副本的Span的赋值给Left副本的注册缓存preSpan；并设置副本状态机为复制断开状态；分片聚合或分裂处理过程中，如果是分片分裂，对Right副本，将属于Right副本的Span赋值给Right副本的注册缓存preSpan；并设置Right副本状态机为复制断开状态。6.根据权利要求1或2或3所述的一种数据库分片复制过程中聚合分裂的处理方法，其特征在于，对于重新注册处理过程中，如果当前注册Span与副本的注册缓存preSpan相等，则设置副本状态机为重新注册完成状态，否则等待下次的复制的注册。7.一种数据库分片复制过程中聚合分裂的处理系统，其特征在于，包括注册缓存preSpan模块，KV缓存rangeKVbuf模块，副本复制状态机splitMergeState模块；通过在复制断开和重新注册这段时间缓存主库发送的KV，在复制注册成功后补足发送缓存的KV，实现在分片聚合和分裂情况下主备数据的一致性；所述注册缓存preSpan模块，在分片聚合时，将Left和Right副本的注册Span合并后赋值给Left副本的注册缓存preSpan；在分片分裂时，将Left副本的注册Span按照Left和Right的范围分割，分别赋值给Left和Right副本的注册缓存preSpan；所述KV缓存rangeKVbuf模块，在主库数据KV发送过程中，如果复制状态处于复制断开和重新注册成功之间，则将KV缓存到rangeKVbuf中，当复制重新注册成功后，将KV缓存的数据rangeKVbuf补足发给备库。8.根据权利要求7所述的一种数据库分片复制过程中聚合分裂的处理系统，其特征在于，所述副本复制状态机splitMergeState模块，复制断开时，主库发送的KV被缓存；复制重新注册成功时，主库发送缓存的KV；复制正常时，主库发送的KV被实时发送给备库。9.一种数据库分片复制过程中聚合分裂的处理装置，其特征在于，包括至少一个存储器和至少一个处理器；所述至少一个存储器，用于存储机器可读程序；所述至少一个处理器，用于调用所述机器可读程序，实现权利要求1至6任一所述的方法。10.一种计算机可读存储介质，其特征在于，所述存储介质上存储有计算机指令，所述计算机指令在被处理器执行时，使所述处理器执行权利要求1至6任一所述的方法。
说明书desc
技术领域本发明涉及数据复制处理技术领域，具体地说是一种数据库分片复制过程中聚合分裂的处理方法及系统。背景技术在数据库，数据分片复制，是分片数据库主备增量复制的一般方法。在数据库复制技术领域，在分片的聚合和分裂过程中,存在复制断开和重新注册的情况，而在复制断开和重新注册成功这段时间存在数据丢失的问题。发明内容本发明的技术任务是针对以上不足之处，提供一种数据库分片复制过程中聚合分裂的处理方法及系统，实现分布式数据库主备复制过程中分片的聚合、分裂情况下保持主备数据一致性，解决了主备数据丢失的问题。本发明解决其技术问题所采用的技术方案是：一种数据库分片复制过程中聚合分裂的处理方法，该方法的实现包括增加注册缓存preSpan，KV缓存rangeKVbuf，副本复制状态机splitMergeState，在复制断开和重新注册这段时间缓存主库发送的KV，在复制注册成功后，补足发送缓存的KV；所述注册缓存preSpan，在分片聚合时，将Left和Right副本的注册Span合并后赋值给Left副本的注册缓存preSpan；在分片分裂时，将Left副本的注册Span按照Left和Right的范围分割，分别赋值给Left和Right副本的注册缓存preSpan；所述KV缓存rangeKVbuf，在主库数据KV发送过程中，如果复制状态处于复制断开和重新注册成功之间，则将KV缓存到rangeKVbuf中，当复制重新注册成功后，将KV缓存的数据rangeKVbuf补足发给备库。进一步的，所述副本复制状态机splitMergeState，复制断开时，主库发送的KV被缓存；复制重新注册成功时，主库发送缓存的KV；复制正常时，主库发送的KV被实时发送给备库。优选的，所述副本复制状态机splitMergeState，复制断开时，复制状态机为1，即复制断开状态；复制重新注册成功时，复制状态机为2，即复制重新注册状态；复制正常时，即复制状态机为0，即复制正常状态。优选的，主数据库KV发送过程具体如下：主库数据KV发送过程中，判断复制状态机为正常复制状态，则正常将KV向备库发送；主库数据KV发送过程中，如果复制状态机为复制断开状态，或复制重新注册成功状态，则将KV缓存到rangeKvBuffer中；主库数据KV发送过程中，独立线程携带超时机制检测状态机为复制重新注册成功状态，则将缓存rangeKvBuffer的KV向备库发送，并将副本状态机设置为复制正常状态。优选的，分片聚合或分裂过程具体如下：分片聚合或分裂处理过程中，如果是分片聚合，对Left副本，获取Left副本和Right副本的注册Span，做区间合并，将总的注册Span赋值给Left的注册缓存preSpan；并设置Left副本状态机为复制断开状态；分片聚合或分离处理过程中，如果是分片聚合，对Right副本，设置副本状态机为复制断开状态；分片聚合或分裂处理过程中，如果是分片分裂，对Left副本，获取原注册Span，按照Left副本和Right副本的范围分割Span，将属于Left副本的Span的赋值给Left副本的注册缓存preSpan；并设置副本状态机为复制断开状态；分片聚合或分裂处理过程中，如果是分片分裂，对Right副本，将属于Right副本的Span赋值给Right副本的注册缓存preSpan；并设置Right副本状态机为复制断开状态。进一步的，对于重新注册处理过程中，如果当前注册Span与副本的注册缓存preSpan相等，则设置副本状态机为重新注册完成状态，否则等待下次的复制的注册。本发明还要求保护一种数据库分片复制过程中聚合分裂的处理系统，包括注册缓存preSpan模块，KV缓存rangeKVbuf模块，副本复制状态机splitMergeState模块；通过在复制断开和重新注册这段时间缓存主库发送的KV，在复制注册成功后补足发送缓存的KV，实现在分片聚合和分裂情况下主备数据的一致性；所述注册缓存preSpan模块，在分片聚合时，将Left和Right副本的注册Span合并后赋值给Left副本的注册缓存preSpan；在分片分裂时，将Left副本的注册Span按照Left和Right的范围分割，分别赋值给Left和Right副本的注册缓存preSpan；所述KV缓存rangeKVbuf模块，在主库数据KV发送过程中，如果复制状态处于复制断开和重新注册成功之间，则将KV缓存到rangeKVbuf中，当复制重新注册成功后，将KV缓存的数据rangeKVbuf补足发给备库。进一步的，所述副本复制状态机splitMergeState模块，复制断开时，主库发送的KV被缓存；复制重新注册成功时，主库发送缓存的KV；复制正常时，主库发送的KV被实时发送给备库。本发明还要求保护一种数据库分片复制过程中聚合分裂的处理装置，包括至少一个存储器和至少一个处理器；所述至少一个存储器，用于存储机器可读程序；所述至少一个处理器，用于调用所述机器可读程序，实现上述的方法。本发明还要求保护一种计算机可读存储介质，所述存储介质上存储有计算机指令，所述计算机指令在被处理器执行时，使所述处理器执行上述的方法。本发明的一种数据库分片复制过程中聚合分裂的处理方法及系统与现有技术相比，具有以下有益效果：本方法及系统解决了分片复制过程中，分片聚合和分裂情况下的KV丢失问题，保证主备数据一致，且不阻塞聚合和分裂过程，保证高性能复制。附图说明图1是本发明一个实施例提供的主数据库KV发送过程示图；图2是本发明一个实施例提供的分片聚合或分离处理过程示图；图3是本发明一个实施例提供的重新注册处理过程示图。具体实施方式下面结合具体实施例对本发明作进一步说明。本发明实施例提供了一种数据库分片复制过程中聚合分裂的处理方法，该方法的实现包括增加注册缓存preSpan，KV缓存rangeKVbuf，副本复制状态机splitMergeState，在复制断开和重新注册这段时间缓存主库发送的KV，在复制注册成功后，补足发送缓存的KV；所述注册缓存preSpan，在分片聚合时，将Left和Right副本的注册Span合并后赋值给Left副本的注册缓存preSpan；在分片分裂时，将Left副本的注册Span按照Left和Right的范围分割，分别赋值给Left和Right副本的注册缓存preSpan；所述KV缓存rangeKVbuf，在主库数据KV发送过程中，如果复制状态处于复制断开和重新注册成功之间，则将KV缓存到rangeKVbuf中，当复制重新注册成功后，将KV缓存的数据rangeKVbuf补足发给备库。所述副本复制状态机splitMergeState，复制断开时，复制状态机为1，即复制断开状态，此时主库发送的KV被缓存；复制重新注册成功时，复制状态机为2，即复制重新注册状态，此时主库发送缓存的KV；复制正常时，即复制状态机为0，即复制正常状态，此时主库发送的KV被实时发送给备库。如图1所示，主数据库KV发送过程具体如下：主库数据KV发送过程中，判断复制状态机为正常复制状态，则正常将KV向备库发送；主库数据KV发送过程中，如果复制状态机为复制断开状态，或复制重新注册成功状态，则将KV缓存到rangeKvBuffer中；主库数据KV发送过程中，独立线程携带超时机制检测状态机为复制重新注册成功状态，则将缓存rangeKvBuffer的KV向备库发送，并将副本状态机设置为复制正常状态。如图2所示，分片聚合或分裂过程具体如下：分片聚合或分裂处理过程中，如果是分片聚合，对Left副本，获取Left副本和Right副本的注册Span，做区间合并，将总的注册Span赋值给Left的注册缓存preSpan；并设置Left副本状态机为复制断开状态；分片聚合或分离处理过程中，如果是分片聚合，对Right副本，设置副本状态机为复制断开状态；分片聚合或分裂处理过程中，如果是分片分裂，对Left副本，获取原注册Span，按照Left副本和Right副本的范围分割Span，将属于Left副本的Span的赋值给Left副本的注册缓存preSpan；并设置副本状态机为复制断开状态；分片聚合或分裂处理过程中，如果是分片分裂，对Right副本，将属于Right副本的Span赋值给Right副本的注册缓存preSpan；并设置Right副本状态机为复制断开状态。如图3所示，对于重新注册处理过程中，如果当前注册Span与副本的注册缓存preSpan相等，则设置副本状态机为重新注册完成状态，否则等待下次的复制的注册。本发明实施例还提供一种数据库分片复制过程中聚合分裂的处理系统，包括注册缓存preSpan模块，KV缓存rangeKVbuf模块，副本复制状态机splitMergeState模块；通过在复制断开和重新注册这段时间缓存主库发送的KV，在复制注册成功后补足发送缓存的KV，实现在分片聚合和分裂情况下主备数据的一致性；所述注册缓存preSpan模块，在分片聚合时，将Left和Right副本的注册Span合并后赋值给Left副本的注册缓存preSpan；在分片分裂时，将Left副本的注册Span按照Left和Right的范围分割，分别赋值给Left和Right副本的注册缓存preSpan；所述KV缓存rangeKVbuf模块，在主库数据KV发送过程中，如果复制状态处于复制断开和重新注册成功之间，则将KV缓存到rangeKVbuf中，当复制重新注册成功后，将KV缓存的数据rangeKVbuf补足发给备库。所述副本复制状态机splitMergeState模块，复制断开时，复制状态机为1，即复制断开状态，此时主库发送的KV被缓存；复制重新注册成功时，复制状态机为2，即复制重新注册状态，此时主库发送缓存的KV；复制正常时，即复制状态机为0，即复制正常状态，此时主库发送的KV被实时发送给备库。主数据库KV发送过程具体如下：主库数据KV发送过程中，判断复制状态机为正常复制状态，则正常将KV向备库发送；主库数据KV发送过程中，如果复制状态机为复制断开状态，或复制重新注册成功状态，则将KV缓存到rangeKvBuffer中；主库数据KV发送过程中，独立线程携带超时机制检测状态机为复制重新注册成功状态，则将缓存rangeKvBuffer的KV向备库发送，并将副本状态机设置为复制正常状态。分片聚合或分裂过程具体如下：分片聚合或分裂处理过程中，如果是分片聚合，对Left副本，获取Left副本和Right副本的注册Span，做区间合并，将总的注册Span赋值给Left的注册缓存preSpan；并设置Left副本状态机为复制断开状态；分片聚合或分离处理过程中，如果是分片聚合，对Right副本，设置副本状态机为复制断开状态；分片聚合或分裂处理过程中，如果是分片分裂，对Left副本，获取原注册Span，按照Left副本和Right副本的范围分割Span，将属于Left副本的Span的赋值给Left副本的注册缓存preSpan；并设置副本状态机为复制断开状态；分片聚合或分裂处理过程中，如果是分片分裂，对Right副本，将属于Right副本的Span赋值给Right副本的注册缓存preSpan；并设置Right副本状态机为复制断开状态。对于重新注册处理过程中，如果当前注册Span与副本的注册缓存preSpan相等，则设置副本状态机为重新注册完成状态，否则等待下次的复制的注册。本发明实施例还提供一种数据库分片复制过程中聚合分裂的处理装置，包括至少一个存储器和至少一个处理器；所述至少一个存储器，用于存储机器可读程序；所述至少一个处理器，用于调用所述机器可读程序，实现上述实施例中所述的数据库分片复制过程中聚合分裂的处理方法。本发明实施例还提供一种计算机可读介质，所述计算机可读介质上存储有计算机指令，所述计算机指令在被处理器执行时，使所述处理器执行上述实施例中所述的数据库分片复制过程中聚合分裂的处理方法。具体地，可以提供配有存储介质的系统或者装置，在该存储介质上存储着实现上述实施例中任一实施例的功能的软件程序代码，且使该系统或者装置的计算机读出并执行存储在存储介质中的程序代码。在这种情况下，从存储介质读取的程序代码本身可实现上述实施例中任何一项实施例的功能，因此程序代码和存储程序代码的存储介质构成了本发明的一部分。用于提供程序代码的存储介质实施例包括软盘、硬盘、磁光盘、光盘、磁带、非易失性存储卡和ROM。可选择地，可以由通信网络从服务器计算机上下载程序代码。此外，应该清楚的是，不仅可以通过执行计算机所读出的程序代码，而且可以通过基于程序代码的指令使计算机上操作的操作系统等来完成部分或者全部的实际操作，从而实现上述实施例中任意一项实施例的功能。此外，可以理解的是，将由存储介质读出的程序代码写到插入计算机内的扩展板中所设置的存储器中或者写到与计算机相连接的扩展单元中设置的存储器中，随后基于程序代码的指令使安装在扩展板或者扩展单元上的CPU等来执行部分和全部实际操作，从而实现上述实施例中任一实施例的功能。上文通过附图和优选实施例对本发明进行了详细展示和说明，然而本发明不限于这些已揭示的实施例，基与上述多个实施例本领域技术人员可以知晓，可以组合上述不同实施例中的代码审核手段得到本发明更多的实施例，这些实施例也在本发明的保护范围之内。
