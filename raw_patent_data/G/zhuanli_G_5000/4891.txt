标题title
一种基于同态映射的安全文件系统实现方法
摘要abst
本发明公开一种基于同态映射的安全文件系统实现方法，属于信息安全技术领域。本方法将文件映射表La和文件内容隔离存储，文件映射表La、同态映射模块、文件解析引擎存储于隔离沙箱内，隔离沙箱是由硬件实现的易失存储环境，文件内容以多个文件簇PD的形式存储于非易失空间，同态映射模块使用一对函数管理文件映射表La和文件内容的关联，文件映射表La和文件内容之间增加一个中间参数Pa，Pa表示文件簇PD在非易失空间的存储地址。通过本发明设计的隔离存储，使得获取文件映射表无法获取该文件所有的连接关系，需要同态映射模块、文件解析引擎协同工作才能实现文件解析。本方法大幅度增加了文件系统的安全性。
权利要求书clms
1.一种基于同态映射的安全文件系统实现方法，其特征在于：本方法将文件映射表La和文件内容隔离存储，文件映射表La、同态映射模块、文件解析引擎存储于隔离沙箱内，隔离沙箱是由硬件实现的易失存储环境，文件内容以多个文件簇PD的形式存储于非易失空间，同态映射模块使用一对函数func_a和func_b管理文件映射表La和文件内容的关联，func_a= Pa，func_b=La，通过函数func_a寻址La对应的Pa，通过函数func_b寻找下一个Pa即Next_Pa对应的La，其中Pa表示文件簇PD在非易失空间的存储地址；文件解析引擎根据文件ID检索其对应的首La，并根据同态映射模块的解析结果更新文件更新表，文件更新表用于缓存当前的Pa。2.根据权利要求1所述的基于同态映射的安全文件系统实现方法，其特征在于：PD包括PD头部和PD内容，PD头部标识PD内容的描述信息，PD头部包括权限标识、映射关系、文件长度、时间戳、有效标识和PD校验和，PD内容以数据流的形式存储文件的实际内存，整个PD由PD校验和进行保护；映射关系中的Next_Pa是一个伪映射，仅用于指向La的位置。3.根据权利要求1所述的基于同态映射的安全文件系统实现方法，其特征在于：La以记录的形式组织，包括La地址、La时间戳、有效映射、La校验和，存储介质中顺序存储La的有效映射，每次删除、修改、追加文件内容，需要修改La的有效映射，将整个La记录写入新地址，通过时间戳标识记录的时间点，通过La校验和保证每条La记录的完整性。4.根据权利要求2所述的基于同态映射的安全文件系统实现方法，其特征在于：文件结束标识在Next_Pa中特定指示， Next_Pa为结束标识时，则映射关系结束，整个文件读取完毕。5.根据权利要求1所述的基于同态映射的安全文件系统实现方法，其特征在于：函数func_a和func_b是可逆的双射映射函数、自定义映射函数或者通过机器学习训练出来的映射函数。6.根据权利要求1所述的基于同态映射的安全文件系统实现方法，其特征在于：增加部分没有对应关系的La和Pa。7.根据权利要求1所述的基于同态映射的安全文件系统实现方法，其特征在于：PD的最大长度不超过非易失存储芯片的擦除最小单位。8.根据权利要求1所述的基于同态映射的安全文件系统实现方法，其特征在于：文件系统包括目录和文件内容，目录包括根文件目录、应用目录和带节点目录，应用目录和带节点目录位于根文件目录下，文件内容位于应用目录和带节点目录下。9.根据权利要求1所述的基于同态映射的安全文件系统实现方法，其特征在于：文件内容经过硬件密码模块进行数据加解密，加解密采用密钥扩展模块扩展后的密钥，具体文件存储的PD位置使用不同的密钥扩展器进行加解密。
说明书desc
技术领域本发明涉及信息安全领域，具体的说，是一种基于同态映射的安全文件系统实现方法。背景技术对用户数据的管理和保护，是密码卡/密码机的重中之重，用户数据如密钥、权限、身份信息泄露将产生不可估量的影响。用户信息往往以厂商自定义的文件系统来进行管理，通过SDF_CreateFile、SDF_ReadFile、SDF_WriteFile、SDF_DeleteFile等GM/T 0016 -2012《智能密码钥匙密码应用接口规范》定义的标准接口进行调用，因此高安全、高可靠性、可移植性的文件系统，将是固件实现的技术难点，也是整个密码卡/密码机产品的核心竞争力。对目前使用较广的FAT32、EXFAT、NTFS、EXT4等通用文件系统进行研究和分析，发现大多文件系统采用文件映射表加文件数据块的模式组织。以FAT32文件系统为例，首先通过MBR解析分区信息，然后通过对应分区的DBR记录文件系统的数据，在通过DBR解析FAT文件系统的目录项，从而找到文件，文件以链表的结构将数据内容以簇的形式进行内容关联。这就导致一个问题，仅通过密钥的形式对数据进行加密。在目前高性能计算机暴力破解的情况下，很容易根据MBR和DBR和固定特征数据反向破解密钥，从而解析出整个文件系统，因此基于通用文件系统设计的面向密码卡/密码机的自定义文件系统，在安全性上存在漏洞，尤其符合CSP/SKF/SDF接口标准的安全设备上，存在一定的隐患。发明内容针对现有技术的缺陷，本发明提供一种基于同态映射的安全文件系统实现方法，将文件映射表和文件内容相隔离，仅获取文件映射表无法获取该文件所有的连接关系，从而大幅度提高文件系统的安全性。为了解决所述技术问题，本发明采用的技术方案是：一种基于同态映射的安全文件系统实现方法，本方法将文件映射表La和文件内容隔离存储，文件映射表La、同态映射模块、文件解析引擎存储于隔离沙箱内，隔离沙箱是由硬件实现的易失存储环境，文件内容以多个文件簇PD的形式存储于非易失空间，同态映射模块使用一对函数func_a和func_b管理文件映射表和文件内容的关联，func_a= Pa，func_b=La，通过函数func_a寻址La对应的Pa，通过函数func_b寻找下一个Pa即Next_Pa对应的La，其中Pa表示文件簇PD在非易失空间的逻辑存储地址；文件解析引擎根据文件ID检索其对应的首La，并根据同态映射模块的解析结果更新文件更新表，文件更新表用于缓存当前的Pa。进一步的，PD包括PD头部和PD内容，PD头部标识PD内容的描述信息，PD头部包括权限标识、映射关系、文件长度、时间戳、有效标识和PD校验和，PD内容以数据流的形式存储文件的实际内存，整个PD由PD校验和进行保护；映射关系中的Next_Pa是一个伪映射，仅用于指向La的位置。进一步的，La以记录的形式组织，包括La地址、La时间戳、有效映射、La校验和，存储介质中顺序存储La的有效映射，每次删除、修改、追加文件内容，需要修改La的有效映射，将整个La记录写入新地址，通过时间戳标识记录的时间点，通过La校验和保证每条La记录的完整性。进一步的，文件结束标识在Next_Pa中特定指示， Next_Pa为结束标识时，则映射关系结束，整条记录全部加载。进一步的，函数func_a和func_b是可逆的双射映射函数、自定义映射函数或者通过机器学习训练出来的映射函数。进一步的，增加部分没有对应关系的La和Pa。进一步的，PD的最大长度不超过非易失存储芯片的擦除最小单位。进一步的，文件系统包括目录和文件内容，目录包括根文件目录、应用目录和带节点目录，应用目录和带节点目录位于根文件目录下，文件内容位于应用目录和带节点目录下。进一步的，文件内容经过硬件密码模块进行数据加解密，加解密采用密钥扩展模块扩展后的密钥，具体文件存储的PD位置使用不同的密钥扩展器进行加解密。本发明的有益效果：本发明将文件映射表和文件内容隔离，并通过同态映射模块实现文件映射表和文件内容的关联，同态映射模块里设有两个函数，一个实现La到Pa的映射，即映射关系到数据实际存储位置的映射，另一个实现Next_Pa到La的映射，即下一跳有效数据实际存储位置到映射关系的映射，其中Next_Pa是一个伪映射，并不指向真实的下一跳有效数据实际存储位置，仅用于指向La的位置，如此设计，是为了防止获取La与PD的映射关系后，依据La读取PD后，根据PD中Next_Pa的指示依次读取所有数据。通过该隔离设计能大幅度提高文件系统的安全性。本方法还设有多组密钥获取模块，可以设置多组密钥对不同的数据区域进行数据加密，在冷热数据交换和垃圾回收过程中，随机选取空闲Pa，该Pa可能会使用不同的密钥扩展模块进行加解密，实现“相同的数据，在不同的时间点，以不同形式的密文存储在数据存储区”。附图说明图1是安全文件系统的总体架构图；图2是安全文件系统硬件组成示意图；图3是La、Pa、PD的映射关系示意图；图4是文件内容数据保护模型示意图；图5是安全文件系统数据结构示意图；图6是文件检索流程图；图7是文件更新流程图；图8是垃圾回收流程图。具体实施方式下面结合附图和具体实施例对本发明作进一步的说明。实施例1本实施例公开一种基于同态映射的安全文件系统实现方法，所述的安全文件系统包括GM/T 0016 - 2012《智能密码钥匙密码应用接口规范》、GM/T 0017 - 2012《智能密码钥匙密码应用接口数据格式规范》，如图1所示，包括目录和文件内容，目录包括根文件目录MDF、应用目录ADF和带节点目录DDF，应用目录ADF和带节点目录DDF位于根文件目录MDF下，文件内容EF位于应用目录和带节点目录下。目录不具有实际意义，只是构成文件系统的逻辑关系；文件EF是文件实体，是以各种应用为基础组织的二进制内容，如二进制记录、对称密钥、PIN、非对称密钥、电子钱包等具有实际价值的数据内容，用于保存用户的数据信息。如图2所示，本方法将文件映射表La和文件内容隔离存储，文件映射表La、同态映射模块、文件解析引擎存储于隔离沙箱内，隔离沙箱是由硬件实现的易失存储环境，用于保护文件映射表La。文件内容以多个文件簇PD的形式存储于非易失空间。同态映射模块使用一对函数func_a和func_b管理文件映射表和文件内容的关联，func_a= Pa，func_b=La，通过函数func_a寻址La对应的Pa，通过函数func_b寻找下一个Pa即Next_Pa对应的La，其中Pa表示文件簇PD在非易失空间的逻辑存储地址；文件解析引擎根据文件ID检索其对应的首La，并根据同态映射模块的解析结果更新文件更新表，文件更新表用于缓存当前的Pa。本实施例中，隔离沙箱负责保护文件映射表La；同态映射模块用于匹配La、Pa、PD的对应关系；文件解析引擎用于根据文件标识ID解析出所有文件的内容，将Pa和PD存放到SRAM中，CPU通过总线进行读写操作。本方法将文件映射表La与文件内容PD隔离，并且文件映射表La与文件内容PD设有中间参量Pa，因此仅获取全部La无法获取该文件所有的连接关系，需要结合PD中的下一条映射及同态映射模块，通过映射函数func_a和func_b进行解析，将映射关系解析即func=Pa到文件更新表，然后根据La解析出的Pa地址，通过密码模块根据Pa地址解密PD，PD存储在非易失的空间中，可以是片内Flash存储介质，也可以是片外Flash存储介质，通过密码模块将解密后的数据放入SRAM中，CPU通过AHB/AXI总线进行读写操作。本实施例及附图中，AHB到代数的映射，本实施例采用的默认同态映射关系是一阶的，满足双射关系，用户自定义的高阶非线性函数只需要满足单射即可，象集相同则原象一定相同，若象不同则原象一定不同，象集和原象集可能有剩余元素，但不存在相同的Pa映射出不同的La关系，增加部分没有对应关系的La和Pa可以进一步，增加干扰性。本实施例中，自定义的同态映射函数为：y = a7 * func77 + a6 * func66 +a5 * func55 + a4 * func44 + a3 * func33 + a2 * func22 + a1 * func11+ a0，其中a7、a6、a5、a4、a3、a2、a1、a0是可用户自定义，func1~n为线性或非线性函数，例如func = x - offset、sigmoid、tanh、Relu等，也可以通过机器学习进行训练得出的两组y到x的映射关系作为func_a和func_b，用于La到Pa和Next_Pa到La的映射计算。在func_a映射关系中，y指代Pa，x指代La；在func_b映射关系中，y指代La，x指代Next_Pa。本实施例中，高阶函数的计算结果通过固件计算进行二次处理，进行无效映射过滤。如图4所示，硬件加密模块设计多组密钥扩展模块，设置多组密钥对不同的数据区域进行数据加密，在冷热数据交换和垃圾回收过程中，随机选取空闲Pa，该Pa可能会使用不同的密钥扩展模块进行加解密，实现“相同的数据，在不同的时间点，以不同形式的密文存储在数据存储区”。硬件密码模块可以主动访问数据存储区，整个数据块搬运和交换过程，只需要固件提供数据的源地址和目的地址，硬件密码模块自动读取源地址的密钥扩展模块并解密数据，使用目的PD地址的密钥扩展模块进行加密写入，整个数据计算过程完全由硬件完成，可以最大限度保证安全性和效率。本实施例中，PD的地址用Pa来进行描述，Pa描述某个PD块存储在非易失区间的逻辑地址，PD作为独立的一个文件簇，可以是256字节、512字节、1024字节等来存放数据内容，但PD的最大长度不应超过非易失存储芯片的擦除最小单位，如果PD太小会导致La的颗粒度过于复杂，如果PD太大会导致资源浪费，频繁进行擦除操作，本文采用512字节为擦除单位。采用512字节为擦除单位的依据是SATA、USB、PCIE的存储类通讯协议如SCSI、ATA是以LBA为最小单位，而LBA的大小为512字节，这样做可以方便主机端管理工具无需数据拆分和拼接，有利于减少接口通讯次数，提高效率。PD存在非易失存储空间中，CPU通过总线经过硬件密码模块进行数据加解密，加解密采用密钥扩展模块扩展后的密钥，密码模块将非易失存储空间划分成多个数据簇，按照位置使用不同的密钥扩展模块进行加解密，特别强调从容量来看Cluster ＞ 最小擦除单位 ＞ PD。如图6所示，依据本方法的文件解析流程为：S11）、文件解析引擎根据文件标识检索到起始La后，通过同态映射模块的func_a函数查找到对应的Pa地址，Pa是PD的唯一标识；S12）、读取Enc数据并进行解密，Enc表示加密后的PD数据，将PD内容加载到SRAM中；S13）、根据PD中Next_Pa的标识，使用func_b函数，查找到对应的La地址，根据La解析下一个内容相关的PD位置，重复步骤S12）；S14）、将PA写入文件更新表；S15）、判断是否结束，当func_b计算结果为结束标识，文件内容全部加载到SRAM中，并且对应的Pa地址也加载到文件更新表中。在La、Pa、PD的映射关系加载识别的过程中，Pa、PD通过以密文形式根据不同的文件簇位置选取对应的密钥扩展模块进行解密读取到SRAM中；La常驻于隔离沙箱中，读取和更新操作只能通过文件解析引擎通过同态映射模块进行读取和修改。如图7所示，文件更新流程为：S21）、申请新的La空间，通过同态映射模块的func_a函数查找到La对应的Pa地址，外部非易失存储设备根据Pa申请新的PD空间；S22）、对数据加密写入PD，不写入PD头部；S23）、标识申请的La已占用；S24）、判断PD写入是否结束，如果是，更新整个La表，更新PD头部信息，计算校验和CRC并写入。为进一步增加数据的安全性，用户根据非易失存储设备的容量，划分为多个文件簇，如图4所示。当某项文件进行修改，首先向文件解析引擎申请新的空闲La，根据同态映射模块的func_a函数得到Pa，Pa = func_b，Pa代表了空闲的PD地址，(Pa、PD）作为新内容写入的空间，用于更新内容。首先更新空闲PD地址的数据内容，只更新PD内容，然后更新La的映射关系，即将La标识为已用；然后更新PD文件头，最主要的是记录Next_Pa用于保证后续文件连接未丢失。更新整个La记录，记录La的时间戳标识，整个文件记录修改完成。由于非易失存储设备擦除和PD的大小是不一致的，在频繁的数据读写过程中，会产生数据碎片，即一个擦除单位里面可能会有大量的无效PD，而非易失电存储设备需要进行数据刷新保证数据保持时间，这种行为称为冷热数据交换，即垃圾回收。如图8所示，垃圾回收的流程为：La中的有效映射标识PD中已经有数据的映射块数量，当该值接近阈值，需要进行垃圾回收，进行数据擦除释放空间。本实施例通过cnt表示已经有数据的映射块，cnt为累积已使用的映射块。文件解析引擎分析映射块中占用率最低的块，也就是某个映射块中有效标识即Trim位 = 1最少的，该块的有效数据使用率最低，用于进行垃圾回收。将每条有效的PD进行搬移，即重复步骤S21）至步骤S23），进行数据搬移，数据搬移的目标地址由文件解析引擎分配，根据目标地址使用密码算法模块调用对应的密钥扩展模块进行加密，当所有有效数据搬移完成，执行步骤S24），更新La记录。完成La更新后，进行映射块清除，释放空间，这样整个映射块中的所有PD空间均可再次利用。映射块也可用英文Sector表示。以上，描述的仅是本发明的基本原理和优选实施例，本领域技术人员根据本发明做出的改进和替换，属于本发明的保护范围。
