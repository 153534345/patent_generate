标题title
一种注量谱分布计算建模、注量谱分布计算方法及装置
摘要abst
本发明公开了一种注量谱分布计算建模、注量谱分布计算方法及装置，包括：搜集图像数据，根据图像数据完成蒙特卡罗模拟计算，获得训练数据，所述训练数据包括粒子的入射注量谱分布和出射注量谱分布；根据所述入射注量谱分布，对所述图像数据进行预处理，生成训练输入数据；基于图形处理器构建初始神经网络模型，并根据训练输入数据和训练数据对所述初始神经网络模型进行重复训练和评估，并更新模型参数；直至达到预设条件后，停止训练迭代，保存模型参数，以完成神经网络模型的构建。本发明通过以蒙特卡罗模拟计算作为神经网络模型训练目标，保证了注量谱分布计算的精度和效率。
权利要求书clms
1.一种注量谱分布计算建模方法，其特征在于，包括：搜集图像数据，根据图像数据完成蒙特卡罗模拟计算，获得训练数据，所述训练数据包括粒子的入射注量谱分布和出射注量谱分布；根据所述入射注量谱分布，对所述图像数据进行预处理，生成训练输入数据；基于图形处理器构建初始神经网络模型，并根据训练输入数据和训练数据对所述初始神经网络模型进行重复训练和评估，并更新模型参数；直至达到预设条件后，停止训练迭代，保存模型参数，以完成神经网络模型的构建。2.如权利要求1所述的注量谱分布计算建模方法，其特征在于，所述搜集图像数据，根据图像数据完成蒙特卡罗模拟计算，获得训练数据，所述训练数据包括粒子的入射注量谱分布和出射注量谱分布，具体为：搜集图像数据，根据图像数据获取粒子信息，所述粒子信息包括介质条件、源的条件和粒子与介质相互作用的截面数据；随机设置射野条件，根据粒子信息对粒子进行模拟抽样，完成蒙特卡罗模拟计算，以获得粒子的入射注量谱分布和出射注量谱分布；并将所述入射注量谱分布和出射注量谱分布作为训练数据。3.如权利要求2所述的注量谱分布计算建模方法，其特征在于，所述根据所述入射注量谱分布，对所述图像数据进行预处理，生成训练输入数据，具体为：将所述图像数据转换为电子密度分布图，并根据粒子的入射注量谱分布，构建入射注量谱分布矩阵；基于电子密度分布图，构建空间物理距离矩阵；将所述电子密度分布图、空间物理距离矩阵和入射注量谱分布矩阵进行连接整合，得到训练输入数据。4.如权利要求3所述的注量谱分布计算建模方法，其特征在于，所述基于电子密度分布图，构建空间物理距离矩阵，具体为：根据电子密度分布图获取电子密度网格每个网格点对应的物理坐标，计算每个网格点与放射源的距离和放射源归一化距离，并构建源距离平方反比因子矩阵；根据电子密度分布图获取电子密度网格每个网格点对应的物理坐标，计算每个网格点到放射源所在中心轴的垂直距离，构建离轴距离矩阵；将所述源距离平方反比因子矩阵和所述离轴距离矩阵进行链接合并，获得空间物理距离矩阵。5.如权利要求1所述的注量谱分布计算建模方法，其特征在于，在所述基于图形处理器构建初始神经网络模型，并根据训练输入数据和训练数据对所述初始神经网络模型进行重复训练和评估，并更新模型参数之前，还包括：根据所述训练数据获得初始训练集和评估集；对所述初始训练集进行扩充，随机抽取初始训练集中的多组入射注量谱分布和对应的出射注量谱分布作为扩充数据集；对扩充数据集中的入射注量谱分布和出射注量谱分布分别进行线性叠加，得到扩充入射注量谱分布和对应的扩充出射注量谱分布，并将所述扩充入射注量谱分布和所述扩充出射注量谱分布加入目标训练集，完成一次数据扩充；多次重复数据扩充，直至初始训练集中所有入射注量谱分布和对应的出射注量谱均被抽取过，且所述目标训练集中的样本数量达到预设条件，停止数据扩充，得到目标训练集；所述目标训练集中还包括初始训练集。6.如权利要求5所述的注量谱分布计算建模方法，其特征在于，所述基于图形处理器构建初始神经网络模型，并根据训练输入数据和训练数据对所述初始神经网络模型进行重复训练和评估，并更新模型参数，具体为：基于图形处理器，构建初始神经网络模型，随即设置模型权值，采用自适应梯度方法对初始神经网络模型进行训练迭代；在训练输入数据集中随机抽取多个数据样本，将所述多个数据样本输入初始神经网络模型，获取模型输出的第一出射注量谱分布；在目标训练集中获取与所述多个数据样本的入射注量谱分布对应的第二出射注量谱分布；根据第一出射注量谱分布和第二出射注量谱分布，计算损失值，基于损失值更新模型权值；直至训练输入数据中所有数据样本均被抽取过，保存模型权值，基于评估集更新模型权值。7.如权利要求6所述的注量谱分布计算建模方法，其特征在于，所述基于评估集更新模型权值，具体为：计算评估集数据样本的当前训练周期的损失值；比较当前训练周期的损失值和上一周期的损失值，若当前训练周期的损失值小于上一周期的损失值，更新保存的模型权值，否则不对模型权值进行更新。8.一种注量谱分布计算方法，其特征在于，包括：获取应用如权利要求1至7任一项所述的注量谱分布计算建模方法所构建的神经网络模型；获取待检测的第一图像数据，所述第一图像数据包括影像信息或几何信息；并对所述第一图像数据做预处理，得到第一输入数据；将所述第一输入数据输入至所述神经网络模型中，计算出射注量谱分布矩阵；对所述出射注量谱分布矩阵还原为绝对值，完成出射注量谱分布计算。9.一种注量谱分布计算建模装置，其特征在于，包括：模拟计算模块、数据预处理模块和迭代训练模块；所述模拟计算模块，用于搜集图像数据，根据图像数据完成蒙特卡罗模拟计算，获得训练数据，所述训练数据包括粒子的入射注量谱分布和出射注量谱分布；所述数据预处理模块，用于根据所述入射注量谱分布，对所述图像数据进行预处理，生成训练输入数据；所述迭代训练模块，用于基于图形处理器构建初始神经网络模型，并根据训练输入数据和训练数据对所述初始神经网络模型进行重复训练和评估，并更新模型参数；直至达到预设条件后，停止训练迭代，保存模型参数，以完成神经网络模型的构建。10.一种注量谱分布计算装置，其特征在于，包括：模型构建模块、数据处理模块、数据计算模块和归一化处理模块；所述模型构建模块，用于获取应用如权利要求9所述的注量谱分布计算建模装置所构建的神经网络模型；所述数据处理模块，用于获取图像数据，所述图像数据包括影像信息或几何信息；并对所述图像数据做预处理，得到模型输入数据；所述数据计算模块，用于将所述模型输入数据输入至所述神经网络模型中，计算出射注量谱分布矩阵；所述归一化处理模块，用于对所述出射注量谱分布矩阵还原为绝对值，完成出射注量谱分布计算。
说明书desc
技术领域本发明涉及粒子输运计算领域，尤其涉及一种注量谱分布计算建模、注量谱分布计算方法及装置。背景技术粒子注量定义为单位面积垂直通过记录平面的粒子数，注量谱分布是指对记录平面划分多个记录网格，记录每个网格中不同能量区间的注量。无论是放射治疗领域还是辐射防护领域，都需要计算射线在穿透一定结构介质后，所出射的注量谱分布，以方便进行下一步计算。例如对于辐射防护，需要评估射线穿透防护墙后的射线，以评估防护效果；对于放射治疗，需要获得穿透人体后注量谱分布，以进行在体剂量检测等。目前，对于注量谱计算主流的技术有：以蒙特卡罗算法为代表的基于粒子相互作用基本原理进行模拟抽样获得出射注量分布的算法；通过卷积算法，利用卷积原理进行计算，例如笔形束卷积算法，筒串卷积算法，计算出射注量谱分布。现有的蒙特卡罗算法为代表的基于粒子相互作用基本原理进行模拟抽样获得出射注量分布的算法，虽然精度高但由于剂量计算中粒子量大，计算效率较低。此外，现有一种注量谱分布计算方法，通过基于深度学习模型构建剂量计算模型，以医疗机器参数为输入，通过水中的剂量信息训练剂量计算模型，实现了自动建模，但剂量计算中神经元数量巨大，因此计算效率不高。发明内容本发明提供了一种注量谱分布计算建模、注量谱分布计算方法及装置，以解决注量谱计算中，计算效率和计算精度难以同时保证的技术问题。为了解决上述技术问题，第一方面，本发明实施例提供了一种注量谱分布计算建模方法，包括：搜集图像数据，根据图像数据完成蒙特卡罗模拟计算，获得训练数据，所述训练数据包括粒子的入射注量谱分布和出射注量谱分布；根据所述入射注量谱分布，对所述图像数据进行预处理，生成训练输入数据；基于图形处理器构建初始神经网络模型，并根据训练输入数据和训练数据对所述初始神经网络模型进行重复训练和评估，并更新模型参数；直至达到预设条件后，停止训练迭代，保存模型参数，以完成神经网络模型的构建。本发明通过蒙特卡罗模拟计算，获取粒子的入射注量谱分布和出射注量谱分布，并将蒙特卡罗模拟计算结果作为神经网络模型训练的目标，优化神经网络模型，提高模型计算精度，同时采用经过预处理的图像数据，通过图形处理器构建神经网络模型处理数据，能够并行处理注量谱分布计算中神经网络模型训练或应用产生的大量的神经元计算任务，提高注量谱分布计算效率。进一步地，所述搜集图像数据，根据图像数据完成蒙特卡罗模拟计算，获得训练数据，所述训练数据包括粒子的入射注量谱分布和出射注量谱分布，具体为：搜集图像数据，根据图像数据获取粒子信息，所述粒子信息包括介质条件、源的条件和粒子与介质相互作用的截面数据；随机设置射野条件，并根据粒子信息对粒子进行模拟抽样，完成蒙特卡罗模拟计算，获得粒子的入射注量谱分布和出射注量谱分布；将所述入射注量谱分布和出射注量谱分布作为训练数据。本发明通过图像数据获取粒子信息，并根据粒子信息和随机设置的射野条件完成蒙特卡罗模拟计算，记录蒙特卡罗模拟中的入射注量谱分布和出射注量谱分布，将其作为神经网络模型的训练样本和训练目标，不断优化神经网络模型，提高了神经网络模型计算注量谱分布的精度。进一步地，所述根据所述入射注量谱分布，对所述图像数据进行预处理，生成训练输入数据，具体为：将所述图像数据转换为电子密度分布图，并根据粒子的入射注量谱分布，构建入射注量谱分布矩阵；基于电子密度分布图，构建空间物理距离矩阵；将所述电子密度分布图、空间物理距离矩阵和入射注量谱分布矩阵进行连接整合，得到训练输入数据。本发明通过对图像数据进行预处理，整合图像数据，使得不同量纲的数据在相近的范围内，以使后续神经网络模型的训练过程有更快的收敛速度，提高模型训练效率，提高模型计算注量谱分布的效率。进一步地，所述基于电子密度分布图，构建空间物理距离矩阵，具体为：根据电子密度分布图获取电子密度网格每个网格点对应的物理坐标，计算每个网格点与放射源的距离和放射源归一化距离，并构建源距离平方反比因子矩阵；根据电子密度分布图获取电子密度网格每个网格点对应的物理坐标，计算每个网格点到放射源所在中心轴的垂直距离，构建离轴距离矩阵；将所述源距离平方反比因子矩阵和所述离轴距离矩阵进行链接合并，获得空间物理距离矩阵。进一步地，在所述基于图形处理器构建初始神经网络模型，并根据训练输入数据和训练数据对所述初始神经网络模型进行重复训练和评估，并更新模型参数之前，还包括：根据所述训练数据获得初始训练集和评估集；对所述初始训练集进行扩充，随机抽取初始训练集中的多组入射注量谱分布和对应的出射注量谱分布作为扩充数据集；对扩充数据集中的入射注量谱分布和出射注量谱分布分别进行线性叠加，得到扩充入射注量谱分布和对应的扩充出射注量谱分布，并将所述扩充入射注量谱分布和所述扩充出射注量谱分布加入目标训练集，完成一次数据扩充；多次重复数据扩充，直至初始训练集中所有入射注量谱分布和对应的出射注量谱均被抽取过，且所述目标训练集中的样本数量达到预设条件，停止数据扩充，得到目标训练集；所述目标训练集中还包括初始训练集。本发明通过对训练数据进行划分获取初始训练集和评估集，并对初始训练集进行扩充，避免模型的过拟合，尽可能地提升模型的泛化能力。此外，对训练集中的样本进行扩充增加样本数量，提升了样本的多样性，避免了蒙特卡罗模拟计算效率低导致的样本获取效率不高的问题。进一步地，所述基于图形处理器构建初始神经网络模型，并根据训练输入数据和训练数据对所述初始神经网络模型进行重复训练和评估，并更新模型参数，具体为：基于图形处理器，构建初始神经网络模型，随即设置模型权值，采用自适应梯度方法对初始神经网络模型进行训练迭代；在训练输入数据集中随机抽取多个数据样本，将所述多个数据样本输入初始神经网络模型，获取模型输出的第一出射注量谱分布；在目标训练集中获取与所述多个数据样本的入射注量谱分布对应的第二出射注量谱分布；根据第一出射注量谱分布和第二出射注量谱分布，计算损失值，基于损失值更新模型权值；直至训练输入数据中所有数据样本均被抽取过，保存模型权值，基于评估集更新模型权值。本发明通过图形处理器构建神经网络模型处理数据，能够并行处理大量的神经元计算任务，提高注量谱分布计算效率。同时通过自适应梯度算法进行模型参数的迭代优化，计算出射注量谱分布的损失值，并更新模型的权值，提高模型的精度。进一步地，所述基于评估集更新模型权值，具体为：计算评估集数据样本的当前训练周期的损失值；比较当前训练周期的损失值和上一周期的损失值，若当前训练周期的损失值小于上一周期的损失值，更新保存的模型权值，否则不对模型权值进行更新。本发明通过将经蒙特卡罗模拟计算获得的训练数据作为评估集，评估模型的损失值，对模型的权值进行优化更新，提高模型的精度，提高注量谱分布计算的精度。第二方面，本发明实施例提供了一种注量谱分布计算方法，包括：获取应用所述的注量谱分布计算建模方法所构建的神经网络模型；获取待检测的第一图像数据，所述第一图像数据包括影像信息或几何信息；并对所述第一图像数据做预处理，得到第一输入数据；将所述第一输入数据输入至所述神经网络模型中，计算出射注量谱分布矩阵；对所述出射注量谱分布矩阵还原为绝对值，完成出射注量谱分布计算。本发明通过根据图像数据进行预处理，获取模型输入数据，并根据神经网络模型计算注量谱分布，提高了注量谱分布计算的效率，并且所述神经网络模型将蒙特卡罗模拟计算的样本作为训练数据，保证了所述神经网络模型计算注量谱分布的精度。第三方面，本发明实施例提供了一种注量谱分布计算建模装置，包括：模拟计算模块、数据预处理模块和迭代训练模块；所述模拟计算模块，用于搜集图像数据，根据图像数据完成蒙特卡罗模拟计算，获得训练数据，所述训练数据包括粒子的入射注量谱分布和出射注量谱分布；所述数据预处理模块，用于根据所述入射注量谱分布，对所述图像数据进行预处理，生成训练输入数据；所述迭代训练模块，用于基于图形处理器构建初始神经网络模型，并根据训练输入数据和训练数据对所述初始神经网络模型进行重复训练和评估，并更新模型参数；直至达到预设条件后，停止训练迭代，保存模型参数，以完成神经网络模型的构建。第四方面，本发明实施例提供了一种注量谱分布计算装置，包括：模型构建模块、数据处理模块、数据计算模块和归一化处理模块；所述模型构建模块，用于获取应用所述的注量谱分布计算建模装置所构建的神经网络模型；所述数据处理模块，用于获取图像数据，所述图像数据包括影像信息或几何信息；并对所述图像数据做预处理，得到模型输入数据；所述数据计算模块，用于将所述模型输入数据输入至所述神经网络模型中，计算出射注量谱分布矩阵；所述归一化处理模块，用于对所述出射注量谱分布矩阵还原为绝对值，完成出射注量谱分布计算。附图说明图1为本发明实施例提供的注量谱分布计算建模方法的一种流程示意图；图2为本发明实施例提供的步骤102提供的一种流程示意图；图3为本发明实施例提供的注量谱分布计算方法的一种流程示意图；图4为本发明实施例提供的注量谱分布计算建模装置的一种结构示意图；图5为本发明实施例提供的注量谱分布计算装置的一种结构示意图。具体实施方式下面将结合本发明实施例中的附图，对本发明实施例中的技术方案进行清楚、完整地描述，显然，所描述的实施例仅仅是本发明一部分实施例，而不是全部的实施例。基于本发明中的实施例，本领域普通技术人员在没有作出创造性劳动前提下所获得的所有其他实施例，都属于本发明保护的范围。实施例一请参照图1，图1为本发明实施例提供的注量谱分布计算建模方法的一种流程示意图，其主要包括步骤101至步骤103，具体如下：步骤101：搜集图像数据，根据图像数据完成蒙特卡罗模拟计算，获得训练数据，所述训练数据包括粒子的入射注量谱分布和出射注量谱分布。在本实施例中，蒙特卡罗模拟计算需要的条件包含三部分：一部分是介质条件，第二部分是源的条件，第三部分是粒子与介质相互作用的截面数据，该部分可通过查阅公开的数据库获得，例如美国国家标准与技术研究院。在本实施例中，对于第一部分，如果所搜集的人体各个部位，根据影像数据密度分布，直接赋予介质密度，然后根据密度范围赋予介质材料如果是设计图纸，则根据图纸还原介质几何分布，介质成分和密度根据图纸材料成分说明直接赋予。对于第二部分，根据源照射范围，源能量以及种类进行模拟抽样。在本实施例中，搜集图像数据，所述图像数据包含人体各个部位，例如头颈、胸部、腹部、盆腔等不同人体部位的CT/MR影像数据，或者相关设计图纸。作为本发明实施例的一种具体举例，在根据图像数据完成蒙特卡罗模拟计算之前，还包括对所述图像数据进行扩充，具体包括：对收集总数为N的原始图像数据按顺序进行编号；把按顺序排列的编号进行打乱；从打乱的编号中顺序抽取B个编号，并根据抽取的编号获取对应的原始图像数据；通过对所述抽取的B个图像数据进行线性叠加，获取新的图像数据；当所有原始图像数据均被遍历完成一次影像数据扩充；多次重复影像数据扩充，生成新的图像数据，直到生成满足需求的新图像数据数量。在本实施例中，对原始图像数据进行线性叠加，获取新的图像数据，具体为：其中，Ik为所抽取的原始样本图像，xk的叠加权重，为0～1的随机浮点数，同时xk满足以下条件：在本实施例中，根据扩充后的图像数据，采用蒙特卡罗算法，模拟计算训练数据。根据图像数据获取粒子信息，所述粒子信息包括介质条件、源的条件和粒子与介质相互作用的截面数据。在本实施例中，进行蒙特卡罗模拟计算时，随机设置射野条件，所述射野条件包括射野形状，强度分布，入射角度以及入射能量；根据源的能谱及照射范围对模拟粒子的能量及方向进行抽样，并模拟粒子穿透介质的过程，经过足够数量粒子模拟后，分别记录进入介质前入射注量谱分布以及离开介质的出射注量谱分布作为训练数据。在本实施例中，通过图像数据获取粒子信息，并根据粒子信息和随机设置的射野条件完成蒙特卡罗模拟计算，记录蒙特卡罗模拟中的入射注量谱分布和出射注量谱分布，将其作为神经网络模型的训练样本和训练目标，不断优化神经网络模型，提高了神经网络模型计算注量谱分布的精度。步骤102：根据所述入射注量谱分布，对所述图像数据进行预处理，生成训练输入数据。请参照图2，图2为本发明实施例提供的步骤102提供的一种流程示意图，其主要包括步骤201至步骤203，具体如下：步骤201：将所述图像数据转换为电子密度分布图，并根据粒子的入射注量谱分布，构建入射注量谱分布矩阵。在本实施例中，根据影像或几何信息，转换为电子密度分布图，所述影像图像为CT图像，根据采集CT图像的机器的HU-电子密度转换曲线把CT图像的HU值转换成电子密度分布。影像信息，根据不同介质赋予电子密度，例如：空气：0.001，肺组织：0.4，脂肪组织：0.9，水：1.0，肌肉组织：1.05，骨组织：1.69。或者可以根据已知的结构几何，例如根据机房防护墙图纸赋予厚度以及对应水泥墙电子密度，或者医用直线加速器机头结构，例如多页光栅的结构位置等)把电子密度分布插值成100×100×100，每个网格物理尺寸为0.5cm×0.5cm×0.5cm。在本实施例中，构建粒子进入模体前的入射注量谱分布矩阵F具体为：粒子注量定义为单位面积垂直通过记录平面的粒子数，注量谱分布是指对记录平面划分多个记录网格，记录每个网格中不同能量区间的注量。构建一个网格数量为100×100×100的矩阵，其中空间物理维度尺寸为50cm×50cm，网格数量为100×100，在空间维度每个网格大小为0.5cm×0.5cm，在能量维度范围为0～20MeV，划分100个区间，每个能量区间间隔为0.2MeV。分别记录各个记录网格各个能量区间内粒子的注量获得入射注量谱分布矩阵Fin。入射注量谱可以有以下办法获得，第一种，当已知源种类，源的粒子种类以及能谱，可以直接根据确定几何关系，根据注量定义，计算源所发出的粒子到进入体模前记录平面入射注量谱分布。第二种根据保存有记录平面的相空间文件统计该平面的注量谱分布。步骤202：基于电子密度分布图，构建空间物理距离矩阵。在本实施例中，为了描述电子密度分布所对应的空间位置，根据电子密度网格每个网格点所对应的物理坐标，构建空间物理距离矩阵，矩阵大小为100×100×100，具体方法如下：空间物理矩阵包含两部分，一部分是源距离平方反比因子，计算公式如下：其中，rijk为网格点与放射源距离，r0为放射源归一化距离。另一部分是离轴距离矩阵,计算公式如下：其中，d为网格到源所在中心轴的垂直距离，d0为矩阵总长度的一半，本实施例为25cm。最后，将两部分矩阵链接合并成大小为100×100×100×2的空间物理距离矩阵。步骤203：将所述电子密度分布图、空间物理距离矩阵和入射注量谱分布矩阵进行连接整合，得到训练输入数据。在本实施例中，获取电子密度分布图，空间物理距离矩阵以及入射注量谱分布后，分别将其作为数据通道进行整合，最终输入矩阵为100×100×100×4，为了使训练过程有更快的收敛速度，让不同量纲的数据在相近范围内，例如在0～1之间，对数据按照各自对应最大值进行归一化，电子密度分布最大值为2，入射注量谱分布按照最大值Fmax,in进行归一。步骤103：基于图形处理器构建初始神经网络模型，并根据训练输入数据和训练数据对所述初始神经网络模型进行重复训练和评估，并更新模型参数；直到达到预设条件停止训练迭代，保存模型参数，以完成神经网络模型的构建。在本实施例中，在所述基于图形处理器构建初始神经网络模型，并根据训练输入数据和训练数据对所述初始神经网络模型进行重复训练和评估，并更新模型参数之前，还包括：将训练数据中的样本量按9：1的比例分为初始训练集和评估集。对所述初始训练集进行扩充，随机抽取初始训练集中的多组入射注量谱分布和对应的出射注量谱分布作为扩充数据集；对扩充数据集中的入射注量谱分布和出射注量谱分布分别进行线性叠加，得到扩充入射注量谱分布和对应的扩充出射注量谱分布，并将所述扩充入射注量谱分布和所述扩充出射注量谱分布加入目标训练集，完成一次数据扩充；多次重复数据扩充，直至初始训练集中所有入射注量谱分布和对应的出射注量谱均被抽取过，且所述目标训练集中的样本数量达到预设条件，停止数据扩充，得到目标训练集；所述目标训练集中还包括初始训练集。作为本实施例的一种具体举例，所述数据扩充具体为：对所述初始训练集中总数量为M的入射注量谱分布与所对应的出射注量谱分布按顺序进行编号；把按顺序排列的编号进行打乱，从打乱的编号中顺序抽取B个编号，并根据编号获取相应的原始样本，所述原始样本为入射注量谱分布与所对应的出射注量谱分布；通过对所抽取B个样本继续线性叠加，获取新输入样本Sin及输出样本Sout；当所有原始样本均被遍历，完成一次数据扩充。在本实施例中，多次进行数据扩充，进行新样本生成，直到生成满足需要的新注量样本数量。作为本实施例的一种具体举例，对所述原始样本进行线性叠加，具体如下：其中Fin,k为所抽取的原始样本入射注量谱分布，Fout,k为所抽取的原始样本出射注量谱分布，yk的叠加权重，为0～1的随机浮点数，同时yk满足以下条件：在本实施例中，所述基于图形处理器构建初始神经网络模型，并根据训练输入数据和训练数据对所述初始神经网络模型进行重复训练和评估，并更新模型参数，具体为：基于图形处理器，构建初始神经网络模型，随即设置模型权值，采用自适应梯度方法对初始神经网络模型进行训练迭代；在训练输入数据集中随机抽取多个数据样本，将所述多个数据样本输入初始神经网络模型，获取模型输出的第一出射注量谱分布；在目标训练集中获取与所述多个数据样本的入射注量谱分布对应的第二出射注量谱分布；根据第一出射注量谱分布和第二出射注量谱分布，计算损失值，基于损失值更新模型权值；直至训练输入数据中所有数据样本均被抽取过，保存模型权值；计算评估集数据样本的当前训练周期的损失值；比较当前训练周期的损失值和上一周期的损失值，若当前训练周期的损失值小于上一周期的损失值，更新保存的模型权值，否则不对模型权值进行更新。作为本实施例的一种具体举例，神经网络的构建采用的编码器-解码器的结构，编码器逐渐减少数据维度，识别图像特征，解码器逐步修复物体的细节和数据维度，逐像素进行预测。考虑到剂量计算是三维计算过程，采用三维VisionTransformer模块作为编码器。所述编码器深度为4层，除了第一层编码器的输入为模型输入，每一层编码器为上一层编码器的输出，经过第一层编码器，输出为50×50×50×32，经过第二层编码器，输出为25×25×25×64，经过第三层编码器，输出为12×12×12×128，第四层编码器，输出为6×6×6×256.采用三维三线性上采样结合残差卷积作为解码器。同一层编码器-解码器之间采用特征通道层进行连接，因此解码器输入通道数为解码器的2倍。第四层解码器输入为6×6×6×512，输出为12×12×12×128，第三层解码器输入为12×12×12×256，输出为25×25×25×64，第二层解码器输入为25×25×25×128，输出为50×50×50×32，第一层解码器输入50×50×50×64，输出为100×100×100×16。最后一层输出层通过卷积核大小为1的卷积层把特征层减少到1，为了保证最后输出范围＞0,最后输出层采用relu激活函数。在本实施例中，无论是神经网络模型的训练以及应用，都需要对每个神经元进行计算，该计算的特点是单个神经元计算简单但数量巨大，对于本发明所构建的神经网络，具体参数量为：30698775。图形处理器的最大优势是具有大量的处理单元，在不需要提高单个处理单元处理速度，可以有效并行计算完成多个神经元的计算任务。从而提高整体计算效率。在本实施例中，模型的训练过程采用自适应梯度方法进行模型参数迭代优化，设定初始学习速率为5e-4。采用均方差作为损失函数，计算模型输出结果与训练样本的MSE损失值。训练过程每次迭代从训练集中随机抽取2个样本输入模型对MSE求导，计算梯度方向更新模型参数。在本实施例中，具体计算损失值具体如下：其中，yi为真实值即训练样本，yi′为模型输出值。在本实施例中，当对所有训练集样本都遍历一次后，固定模型参数，计算评估集样本的MSE损失值，并把模型参数进行保存，此时完成模型训练第一个周期。重新根据步骤对训练集继续新一轮扩充，进入训练第二个周期。从第二个周期开始，仅当评估集的MSE损失值比上一周期的MSE损失值更小，才更新保存的模型参数，以保证所保存的模型性能最优。在本实施例中，当训练周期达到上限或评估集损失值连续10个周期没有下降则停止训练。请参照图3，图3为本发明实施例提供的注量谱分布计算方法的一种流程示意图，其主要包括步骤301至步骤304：步骤301：获取应用本发明实施例提供的注量谱分布计算建模方法所构建的神经网络模型；步骤302：获取待检测的第一图像数据，所述第一图像数据包括影像信息或几何信息；并对所述第一图像数据做预处理，得到第一输入数据；步骤303：将所述第一输入数据输入至所述神经网络模型中，计算出射注量谱分布矩阵；步骤304：对所述出射注量谱分布矩阵还原为绝对值，完成出射注量谱分布计算。在本实施例中，所述神经网络模型输出数据为穿过电子密度分布所描述的体模后，射线离开体模的出射注量谱分布矩阵，输出网格数量为100×100×100的矩阵，其中空间物理维度尺寸为50cm×50cm，网格数量为100×100，在空间维度每个网格大小为0.5cm×0.5cm，在能量维度范围为0～20MeV，划分100个区间，每个能量区间间隔为0.2MeV。分别记录各个记录网格中各个能量区间内粒子的注量，获得所述的出射注量谱分布矩阵Fout。对于训练数据为了保持输入数据中的入射注量谱分布与输出的出射注量谱分布在数值上的关联，根据产生所述的出射注量谱分布所对应的入射注量谱分布的归一值Fmax,in作为分母，进行归一计算。在本实施例中，经过模型计算输出为归一化的出射注量谱分布矩阵Fout’，根据输入的入射注量谱分布的最大值进行还原为绝对值。作为本实施例的一种具体举例，出射注量谱分布矩阵具体还原步骤为：Fout＝Fout’*Fmax,in 其中，Fin为所述输入的入射注量谱分布，Fmax,in为所述输入的入射注量谱分布的最大值，Fout’为经过模型计算，输出的归一化出射注量谱分布。在本实施例中，通过根据图像数据进行预处理，获取模型输入数据，并根据神经网络模型计算注量谱分布，提高了注量谱分布计算的效率，并且所述神经网络模型将蒙特卡罗模拟计算的样本作为训练数据，保证了所述神经网络模型计算注量谱分布的精度。请参照图4，图4为本发明实施例提供的注量谱分布计算建模装置的一种结构示意图，其主要包括模拟计算模块401、数据预处理模块402和迭代训练模块403；所述模拟计算模块401，用于搜集图像数据，根据图像数据完成蒙特卡罗模拟计算，获得训练数据，所述训练数据包括粒子的入射注量谱分布和出射注量谱分布；所述数据预处理模块402，用于根据所述入射注量谱分布，对所述图像数据进行预处理，生成训练输入数据；所述迭代训练模块403，用于基于图形处理器构建初始神经网络模型，并根据训练输入数据和训练数据对所述初始神经网络模型进行重复训练和评估，并更新模型参数；直至达到预设条件后，停止训练迭代，保存模型参数，以完成神经网络模型的构建。请参照图5，图5为本发明实施例提供的注量谱分布计算装置的一种结构示意图，其主要包括模型构建模块501、数据处理模块502、数据计算模块503和归一化处理模块504；所述模型构建模块501，用于获取应用所述的注量谱分布计算建模装置所构建的神经网络模型；所述数据处理模块502，用于获取图像数据，所述图像数据包括影像信息或几何信息；并对所述图像数据做预处理，得到模型输入数据；所述数据计算模块503，用于将所述模型输入数据输入至所述神经网络模型中，计算出射注量谱分布矩阵；所述归一化处理模块504，用于对所述出射注量谱分布矩阵还原为绝对值，完成出射注量谱分布计算。在本实施例中，通过根据图像数据进行预处理，获取模型输入数据，并根据神经网络模型计算注量谱分布，提高了注量谱分布计算的效率，并且所述神经网络模型将蒙特卡罗模拟计算的样本作为训练数据，保证了所述神经网络模型计算注量谱分布的精度。以上所述的具体实施例，对本发明的目的、技术方案和有益效果进行了进一步的详细说明，应当理解，以上所述仅为本发明的具体实施例而已，并不用于限定本发明的保护范围。特别指出，对于本领域技术人员来说，凡在本发明的精神和原则之内，所做的任何修改、等同替换、改进等，均应包含在本发明的保护范围之内。
