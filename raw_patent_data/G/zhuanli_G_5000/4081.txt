标题title
数据处理方法、装置、电子设备及存储介质
摘要abst
本发明提供了一种数据处理方法、装置、电子设备及存储介质，涉及数据云存储技术领域。本发明实施例中，假设存储网关在向云端服务器上传数据组的过程中中断，导致本次数据组未完整上传，由于本次数据组的版本号大于上一次上传至云端服务器的数据组的版本号，则部分已经上传至云端服务器的数据对应的对象的版本号大于上一次成功上传云端服务器的屏障版本号，从而，在进行数据恢复时，以云端服务器中对象的最大版本号的方式来读取有效对象，不会从云端服务器读到大于屏障版本号的这部分未完整上传的数据。
权利要求书clms
1.一种数据处理方法，其特征在于，应用于存储网关，所述方法包括：在本地存储元件发生故障的情况下，从云端服务器中获取屏障版本号，所述屏障版本号是最近一次连续成功上传至所述云端服务器的数据组的版本号，一个数据组包括预设数据量阈值的待上传数据，一个数据组对应云端服务器中的一个或多个对象，所述云端服务器按照一个或多个对象的形式，对存储网关上传的数据组中的数据进行存储；根据所述屏障版本号，从所述云端存储服务器中下载有效对象，以完成数据恢复，其中，所述有效对象是版本号为最大有效版本号的对象，所述最大有效版本号小于或等于所述屏障版本号。2.根据权利要求1所述的数据处理方法，其特征在于，所述方法还包括：从所述云端服务器中获取历史对象，所述历史对象用于记录首次存储以及每次数据恢复对应的实例ID和版本号区间，所述版本号区间对应所述屏障版本号；根据所述历史对象，判断从所述云端服务器中读取到的对象的版本号是否在所述历史对象所记载的版本号区间内；在读取到的对象的版本号在所述历史对象所记载的版本号区间内的情况下，确定读取到的对象是所述有效对象。3.根据权利要求2所述的数据处理方法，其特征在于，所述方法还包括：在读取到的对象的版本号不在所述历史对象所记载的版本号区间内的情况下，确定读取到的对象的版本号为无效版本号；继续从所述云端服务器中读取所述无效版本号的低一版本号的对象，直至读取到的对象为有效对象为止。4.根据权利要求2所述的数据处理方法，其特征在于，所述方法还包括：在首次将数据存储到所述本地存储元件之后，以及每次进行数据恢复之后，对本地存储的历史对象进行更新；将更新后的历史对象上传至所述云端服务器。5.根据权利要求1所述的数据处理方法，其特征在于，所述方法还包括：在客户端写入的数据量达到所述预设数据量阈值的情况下，生成数据组，为所生成的数据组添加版本号；为不同数据组添加的版本号随着数据组的生成时间递增；将所生成的数据组划分成一个或多个对象；将划分出的各个对象上传至所述云端服务器，并将所述数据组的版本号确定为所述各个对象的版本号；在所述数据组成功上传的情况下，将所述数据组的版本号作为所述屏障版本号上传至云端服务器。6.根据权利要求5所述的数据处理方法，其特征在于，所述方法还包括：在所生成的数据组包含已成功上传的对象的部分更新数据的情况下，从所述云端服务器下载该对象；根据所生成的数据组包含的所述部分更新数据，对所下载的对象中的数据进行部分替换，得到版本更新后的对象；将所述版本更新后的对象上传至云端服务器。7.根据权利要求5所述的数据处理方法，其特征在于，所述方法还包括：在所生成的数据组包含已成功上传的对象的全部更新数据的情况下，将所生成的数据组包含的所述全部更新数据，作为版本更新后的对象上传至云端服务器。8.根据权利要求5所述的数据处理方法，其特征在于，在所述数据组成功上传的情况下，所述方法还包括以下至少一者：删除所述本地存储元件中版本号小于或等于所述屏障版本号的数据组；向所述云端服务器发送删除指示，所述删除指示用于指示所述云端服务器删除版本号小于所述屏障版本号的对象。9.一种数据处理装置，其特征在于，应用于存储网关，所述装置包括：第一获取模块，用于在本地存储元件发生故障的情况下，从云端服务器中获取屏障版本号，所述屏障版本号是最近一次连续成功上传至所述云端服务器的数据组的版本号，一个数据组包括预设数据量阈值的待上传数据，一个数据组对应云端服务器中的一个或多个对象，所述云端服务器按照一个或多个对象的形式，对存储网关上传的数据组中的数据进行存储；下载模块，用于根据所述屏障版本号，从所述云端存储服务器中下载有效对象，以完成数据恢复，其中，所述有效对象是版本号为最大有效版本号的对象，所述最大有效版本号小于或等于所述屏障版本号。10.根据权利要求9所述的数据处理装置，其特征在于，所述装置还包括：第二获取模块，用于从所述云端服务器中获取历史对象，所述历史对象用于记录首次存储以及每次数据恢复对应的实例ID和版本号区间，所述版本号区间对应所述屏障版本号；判断模块，用于根据所述历史对象，判断从所述云端服务器中读取到的对象的版本号是否在所述历史对象所记载的版本号区间内；第一确定模块，用于在读取到的对象的版本号在所述历史对象所记载的版本号区间内的情况下，确定读取到的对象是所述有效对象。11.根据权利要求10所述的数据处理装置，其特征在于，所述装置还包括：第二确定模块，用于在读取到的对象的版本号不在所述历史对象所记载的版本号区间内的情况下，确定读取到的对象的版本号为无效版本号；读取模块，用于继续从所述云端服务器中读取所述无效版本号的低一版本号的对象，直至读取到的对象为有效对象为止。12.根据权利要求10所述的数据处理装置，其特征在于，所述装置还包括：历史对象更新模块，用于在首次将数据存储到所述本地存储元件之后，以及每次进行数据恢复之后，对本地存储的历史对象进行更新；历史对象上传模块，用于将更新后的历史对象上传至所述云端服务器。13.根据权利要求9所述的数据处理装置，其特征在于，所述装置还包括：数据组生成模块，用于在客户端写入的数据量达到所述预设数据量阈值的情况下，生成数据组，为所生成的数据组添加版本号；为不同数据组添加的版本号随着数据组的生成时间递增；对象划分模块，用于将所生成的数据组划分成一个或多个对象；对象上传模块，用于将划分出的各个对象上传至所述云端服务器，并将所述数据组的版本号确定为所述各个对象的版本号；屏障版本号上传模块，用于在所述数据组成功上传的情况下，将所述数据组的版本号作为所述屏障版本号上传至云端服务器。14.一种电子设备，包括存储器、处理器及存储在存储器上并可在处理器上运行的计算机程序，其特征在于，所述处理器执行所述计算机程序时实现权利要求1-8任一项所述的数据处理方法的步骤。15.一种计算机可读存储介质，其上存储有计算机程序，其特征在于，该计算机程序被处理器执行时实现权利要求1-8任一项所述的数据处理方法的步骤。
说明书desc
技术领域本发明实施例涉及数据云存储技术领域，尤其涉及一种数据处理方法、装置、电子设备及存储介质。背景技术存储网关是位于用户侧的硬件或软件，作为本地应用和云存储间的桥梁来提供服务。如果云存储使用基于HTTP的协议，而本地应用只能访问传统的SAN、NAS，存储网关就可以在本地应用和云存储所使用的不同协议之间做转换，达到不修改已有应用也可以使数据上云的目的。此外，存储网关还可以缓存热数据，提升用户侧的读写性能。当存储网关所在节点发生硬件故障，导致本地缓存的数据丢失时，通常可以利用云端的数据进行恢复。相关技术中，基于性能的考虑，存储网关通常以并发的方式向云端上传数据。由于并发的存在，数据在云端上传成功的顺序可能是乱序的，因此在进行数据恢复时不能简单地将所有上传成功的数据都作为当前的有效数据。恢复出对用户有意义的有效数据是当前存储网关系统的设计难点之一。因此，目前亟需一种新的数据处理方法。发明内容本发明实施例提供一种数据处理方法、装置、电子设备及存储介质，以至少部分解决相关技术中存在的问题。本发明实施例第一方面提供了一种数据处理方法，应用于存储网关，所述方法包括：在本地存储元件发生故障的情况下，从云端服务器中获取屏障版本号，所述屏障版本号是最近一次连续成功上传至所述云端服务器的数据组的版本号，一个数据组包括预设数据量阈值的待上传数据，一个数据组对应云端服务器中的一个或多个对象，所述云端服务器按照一个或多个对象的形式，对存储网关上传的数据组中的数据进行存储；根据所述屏障版本号，从所述云端存储服务器中下载有效对象，以完成数据恢复，其中，所述有效对象是版本号为最大有效版本号的对象，所述最大有效版本号小于或等于所述屏障版本号。可选地，所述方法还包括：从所述云端服务器中获取历史对象，所述历史对象用于记录首次存储以及每次数据恢复对应的实例ID和版本号区间，所述版本号区间对应所述屏障版本号；根据所述历史对象，判断从所述云端服务器中读取到的对象的版本号是否在所述历史对象所记载的版本号区间内；在读取到的对象的版本号在所述历史对象所记载的版本号区间内的情况下，确定读取到的对象是所述有效对象。可选地，所述方法还包括：在读取到的对象的版本号不在所述历史对象所记载的版本号区间内的情况下，确定读取到的对象的版本号为无效版本号；继续从所述云端服务器中读取所述无效版本号的低一版本号的对象，直至读取到的对象为有效对象为止。可选地，所述方法还包括：在首次将数据存储到所述本地存储元件之后，以及每次进行数据恢复之后，对本地存储的历史对象进行更新；将更新后的历史对象上传至所述云端服务器。可选地，所述方法还包括：在客户端写入的数据量达到所述预设数据量阈值的情况下，生成数据组，为所生成的数据组添加版本号；为不同数据组添加的版本号随着数据组的生成时间递增；将所生成的数据组划分成一个或多个对象；将划分出的各个对象上传至所述云端服务器，并将所述数据组的版本号确定为所述各个对象的版本号；在所述数据组成功上传的情况下，将所述数据组的版本号作为所述屏障版本号上传至云端服务器。可选地，所述方法还包括：在所生成的数据组包含已成功上传的对象的部分更新数据的情况下，从所述云端服务器下载该对象；根据所生成的数据组包含的所述部分更新数据，对所下载的对象中的数据进行部分替换，得到版本更新后的对象；将所述版本更新后的对象上传至云端服务器。可选地，所述方法还包括：在所生成的数据组包含已成功上传的对象的全部更新数据的情况下，将所生成的数据组包含的所述全部更新数据，作为版本更新后的对象上传至云端服务器。可选地，在所述数据组成功上传的情况下，所述方法还包括以下至少一者：删除所述本地存储元件中版本号小于或等于所述屏障版本号的数据组；向所述云端服务器发送删除指示，所述删除指示用于指示所述云端服务器删除版本号小于所述屏障版本号的对象。本发明实施例第二方面提供了一种数据处理装置，应用于存储网关，所述装置包括：第一获取模块，用于在本地存储元件发生故障的情况下，从云端服务器中获取屏障版本号，所述屏障版本号是最近一次连续成功上传至所述云端服务器的数据组的版本号，一个数据组包括预设数据量阈值的待上传数据，一个数据组对应云端服务器中的一个或多个对象，所述云端服务器按照一个或多个对象的形式，对存储网关上传的数据组中的数据进行存储；下载模块，用于根据所述屏障版本号，从所述云端存储服务器中下载有效对象，以完成数据恢复，其中，所述有效对象是版本号为最大有效版本号的对象，所述最大有效版本号小于或等于所述屏障版本号。可选地，所述装置还包括：第二获取模块，用于从所述云端服务器中获取历史对象，所述历史对象用于记录首次存储以及每次数据恢复对应的实例ID和版本号区间，所述版本号区间对应所述屏障版本号；判断模块，用于根据所述历史对象，判断从所述云端服务器中读取到的对象的版本号是否在所述历史对象所记载的版本号区间内；第一确定模块，用于在读取到的对象的版本号在所述历史对象所记载的版本号区间内的情况下，确定读取到的对象是所述有效对象。可选地，所述装置还包括：第二确定模块，用于在读取到的对象的版本号不在所述历史对象所记载的版本号区间内的情况下，确定读取到的对象的版本号为无效版本号；读取模块，用于继续从所述云端服务器中读取所述无效版本号的低一版本号的对象，直至读取到的对象为有效对象为止。可选地，所述装置还包括：历史对象更新模块，用于在首次将数据存储到所述本地存储元件之后，以及每次进行数据恢复之后，对本地存储的历史对象进行更新；历史对象上传模块，用于将更新后的历史对象上传至所述云端服务器。可选地，所述装置还包括：数据组生成模块，用于在客户端写入的数据量达到所述预设数据量阈值的情况下，生成数据组，为所生成的数据组添加版本号；为不同数据组添加的版本号随着数据组的生成时间递增；对象划分模块，用于将所生成的数据组划分成一个或多个对象；对象上传模块，用于将划分出的各个对象上传至所述云端服务器，并将所述数据组的版本号确定为所述各个对象的版本号；屏障版本号上传模块，用于在所述数据组成功上传的情况下，将所述数据组的版本号作为所述屏障版本号上传至云端服务器。可选地，所述装置还包括：对象下载模块，用于在所生成的数据组包含已成功上传的对象的部分更新数据的情况下，从所述云端服务器下载该对象；替换模块，用于根据所生成的数据组包含的所述部分更新数据，对所下载的对象中的数据进行部分替换，得到版本更新后的对象；第一对象更新模块，用于将所述版本更新后的对象上传至云端服务器。可选地，所述装置还包括：第二对象更新模块，用于在所生成的数据组包含已成功上传的对象的全部更新数据的情况下，将所生成的数据组包含的所述全部更新数据，作为版本更新后的对象上传至云端服务器。可选地，在所述数据组成功上传的情况下，所述装置还包括以下至少一者：本地删除模块，用于删除所述本地存储元件中版本号小于或等于所述屏障版本号的数据组；云端删除模块，用于向所述云端服务器发送删除指示，所述删除指示用于指示所述云端服务器删除版本号小于所述屏障版本号的对象。本发明实施例第三方面提供一种计算机可读存储介质，其上存储有计算机程序，该程序被处理器执行时实现如本发明第一方面所述的方法中的步骤。本发明实施例第四方面提供一种电子设备，包括存储器、处理器及存储在存储器上并可在处理器上运行的计算机程序，所述处理器执行时实现如本发明第一方面所述的方法中的步骤。本发明实施例中，存储网关在进行数据恢复时，以云端服务器中对象的最大版本号的方式来读取。这样，从云端服务器下载的数据是小于等于屏障版本号的有效数据，假设，存储网关在向云端服务器上传数据组的过程中中断，导致本次数据组未完整上传，由于本次数据组的版本号大于上一次上传至云端服务器的数据组的版本号，则部分已经上传至云端服务器的数据对应的对象的版本号大于上一次成功上传云端服务器的屏障版本号，从而，在进行数据恢复时，以云端服务器中对象的最大版本号的方式来读取有效对象，不会从云端服务器读到大于屏障版本号的这部分未完整上传的数据。由此，本发明实施例中，在存储网关的本地存储元件损坏的情况下，网关只需下载屏障版本号，就可以成功从云端服务器恢复下载有效数据，以处理后续来自用户的读请求，达到了快速恢复业务的目的。附图说明为了更清楚地说明本发明实施例的技术方案，下面将对本发明实施例的描述中所需要使用的附图作简单地介绍，显而易见地，下面描述中的附图仅仅是本发明的一些实施例，对于本领域普通技术人员来讲，在不付出创造性劳动性的前提下，还可以根据这些附图获得其他的附图。图1是本发明实施例的一种数据处理方法的流程图；图2是本发明实施例的另一种数据处理方法的流程图；图3是本发明实施例的另一种数据处理方法的流程图；图4是本发明实施例的一种数据处理装置的结构框图。具体实施方式为使本发明的上述目的、特征和优点能够更加明显易懂，下面结合附图和具体实施方式对本发明作进一步详细的说明。参照图1，示出了本发明实施例的一种数据处理方法的流程图，本发明实施例所提供的数据处理方法应用于存储网关，本发明实施例提供的数据处理方法可以包括以下步骤：S101，在本地存储元件发生故障的情况下，从云端服务器中获取屏障版本号。本发明实施例中，存储网关位于用户侧，为用户提供了块存储的接口，可以把客户端写入的数据转换成对象后上传到云端，同时也起到缓存热数据、降低读写延时的作用。本发明实施例中，云端服务器提供了基于对象的读写接口，具有较大的存储容量，用于保存全量的数据。本发明实施例中，位于云端服务除器除了一般的写入、读取、删除对象的功能外，还具备多版存储本的功能，即对同一个对象名可以保存多个版本的数据，而且版本之间是可以比较版本号大小。本发明实施例中，用户可以在存储网关上创建多个卷，并通过存储网关所支持的协议来读写数据。存储网关可以利用本地的内存和本地存储元件来缓存用户新写入的数据。对于新收到的写请求，存储网关首先会将数据写入内存，然后异步地将数据写入本地存储元件，只要数据在存储网关的内存中写入成功，存储网关就会向用户返回写成功，但是这部分数据可能在网关断电后丢失。如果要保证数据在断电后不丢失，用户需要发送特定请求，以使已返回写成功的数据都成功地持久化到存储网关的本地存储元件中。本发明实施例中，存储网关可以将本地存储元件的存储空间按照一个固定的长度划分为多份，每一份对应于云端服务器的一个对象。一个存储空间的全部对象会统一存储在一个指定的路径前缀之下，这个路径可以全部或者部分由用户指定。每个对象可以按照某种以卷中偏移量为序的方式来命名，以指示其在卷中所代表的数据范围。例如，一个卷的总大小为100MiB，云端服务器以1MiB一个对象进行存储，存储路径的前缀为/a/b/c，那么云端服务器会存储100个对象：/a/b/c/0,/a/b/c/1. …,/a/b/c/99。其中对象/a/b/c/0对应的是本发明实施例中，所述屏障版本号是最近一次连续成功上传至所述云端服务器的数据组的版本号，一个数据组包括预设数据量阈值的待上传数据，一个数据组对应云端服务器中的一个或多个对象，所述云端服务器按照一个或多个对象的形式，对存储网关上传的数据组中的数据进行存储。本发明实施例中，当客户端向存储网关写入的数据量，达到预设数据量阈值时，存储网关将写入的数据量作为一个数据组，并为该数据组生成对应的版本号。本发明实施例中，一个数据组可能涉及云端服务器中一个或多个对象的上传或更新。本发明实施例中，在存储网关将当前数据组中涉及的相关对象的数据对应上传后，可以对相关对象的版本号进行更新，并且，在当前数据组成功上传之后，将屏障版本号上传至云端服务器，该屏障版本号即为当前数据组的版本号。从而，在下一次上传之前云端服务器中存储的所有对象的数据的版本号均小于等于该屏障版本号。本发明实施例中，本发明实施例中，存储网关还可以按照数据组的版本号大小顺序，同时并发上传多个数据组，在存储网关并发上传数据组的情况下，屏障版本号为并发上传的多个数据组中的最大数据组版本号，即屏障版本号等于最大连续成功上传的数据组的版本号。例如，在并发上传的情况下，版本号为100、200的数据组上传成功了，屏障版本号为200，在此基础上并发地上传版本号为300、400的数据组，其中400成功了，300尚未成功，此时屏障版本号仍是200。在这种情况下，将成功上传了的屏障版本号为400的数据组对应的对象也视作无效对象，从而可以在多线程处理的情况下，避免对屏障版本号的频繁更新，同时避免存储网关恢复到无效数据。S102，根据所述屏障版本号，从所述云端存储服务器中下载有效对象，以完成数据恢复。本发明实施例中，所述有效对象是版本号为最大有效版本号的对象，所述最大有效版本号小于或等于所述屏障版本号。本发明实施例中，将成功上传至云端服务器的数据组对应的数据作为有效数据，相应的，将最近一次成功上传至云端服务器之后，云端服务器上存在的所有对象作为有效对象。本发明实施例中，通过屏障版本号，可以从云端服务器中下载到最近一次成功上传云端服务器之后，云端服务器存在的有效对象。具体的，本发明实施例中，存储网关在进行数据恢复时，以云端服务器中对象的最大版本号的方式来读取。这样，从云端服务器下载的数据是小于等于屏障版本号的有效数据，假设，存储网关在向云端服务器上传数据组的过程中中断，导致本次数据组未完整上传，由于本次数据组的版本号大于上一次上传至云端服务器的数据组的版本号，则部分已经上传至云端服务器的数据对应的对象的版本号大于上一次成功上传云端服务器的屏障版本号，从而，在进行数据恢复时，这些无效数据不会包括在有效对象里面，存储网关不会从云端服务器读到大于屏障版本号的这部分未完整上传的数据。因此，本发明实施例中，在存储网关的本地存储元件损坏的情况下，网关只需下载屏障版本号，就可以成功从云端服务器恢复下载有效数据，以处理后续来自用户的读请求，达到了快速恢复业务的目的。参照图2，示出了本发明实施例的一种数据处理方法的流程图，本发明实施例所提供的数据处理方法，具体可以包括以下步骤：S201，在本地存储元件发生故障的情况下，从云端服务器中获取屏障版本号。S202，根据所述屏障版本号，从所述云端存储服务器中下载有效对象，以完成数据恢复。本发明实施例中，S201~202与上述步骤S101~S102类似，在此不再赘述。S203，从所述云端服务器中获取历史对象，所述历史对象用于记录首次存储以及每次数据恢复对应的实例ID和版本号区间，所述版本号区间对应所述屏障版本号。本发明实施例中，存储网关可以在首次存储以及每次数据恢复时生成对应的实例ID并将该实例ID上传至云端服务器，并将实例ID和数据恢复时的屏障版本号进行关联，进而得到首次存储以及每次数据恢复对应的实例ID和版本号区间。示例地，例如，首次存储时实例ID为x，屏障版本号为0；第一次数据恢复时实例ID为y，屏障版本号为100；第三次恢复时实例ID为z，屏障版本号为200。那么，可以确定版本号属于x的有效数据，版本号上实施的计算机程序产品的形式。本发明实施例是参照根据本发明实施例的方法、终端设备、和计算机程序产品的流程图和/或方框图来描述的。应理解可由计算机程序指令实现流程图和/或方框图中的每一流程和/或方框、以及流程图和/或方框图中的流程和/或方框的结合。可提供这些计算机程序指令到通用计算机、专用计算机、嵌入式处理机或其他可编程数据处理终端设备的处理器以产生一个机器，使得通过计算机或其他可编程数据处理终端设备的处理器执行的指令产生用于实现在流程图一个流程或多个流程和/或方框图一个方框或多个方框中指定的功能的装置。这些计算机程序指令也可存储在能引导计算机或其他可编程数据处理终端设备以特定方式工作的计算机可读存储器中，使得存储在该计算机可读存储器中的指令产生包括指令装置的制造品，该指令装置实现在流程图一个流程或多个流程和/或方框图一个方框或多个方框中指定的功能。这些计算机程序指令也可装载到计算机或其他可编程数据处理终端设备上，使得在计算机或其他可编程终端设备上执行一系列操作步骤以产生计算机实现的处理，从而在计算机或其他可编程终端设备上执行的指令提供用于实现在流程图一个流程或多个流程和/或方框图一个方框或多个方框中指定的功能的步骤。尽管已描述了本发明实施例的优选实施例，但本领域内的技术人员一旦得知了基本创造性概念，则可对这些实施例做出另外的变更和修改。所以，所附权利要求意欲解释为包括优选实施例以及落入本发明实施例范围的所有变更和修改。最后，还需要说明的是，在本文中，诸如第一和第二等之类的关系术语仅仅用来将一个实体或者操作与另一个实体或操作区分开来，而不一定要求或者暗示这些实体或操作之间存在任何这种实际的关系或者顺序。而且，术语“包括”、“包含”或者其任何其他变体意在涵盖非排他性的包含，从而使得包括一系列要素的过程、方法、物品或者终端设备不仅包括那些要素，而且还包括没有明确列出的其他要素，或者是还包括为这种过程、方法、物品或者终端设备所固有的要素。在没有更多限制的情况下，由语句“包括一个……”限定的要素，并不排除在包括所述要素的过程、方法、物品或者终端设备中还存在另外的相同要素。以上对本发明所提供的一种数据处理方法、装置、电子设备及存储介质，进行了详细介绍，本文中应用了具体个例对本发明的原理及实施方式进行了阐述，以上实施例的说明只是用于帮助理解本发明的方法及其核心思想；同时，对于本领域的一般技术人员，依据本发明的思想，在具体实施方式及应用范围上均会有改变之处，综上所述，本说明书内容不应理解为对本发明的限制。
