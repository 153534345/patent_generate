标题title
一种基于合成数据的神经网络去炫光方法
摘要abst
本发明公开了一种基于合成数据的神经网络去炫光方法。定义了一种合成炫光图像的方法——首先通过对炫光图像和场景图像进行逆伽马变换得到炫光图像和场景图像的逆伽马空间的图像，然后通过计算炫光图像和场景图像的亮度矩阵，通过亮度矩阵计算场景图像和炫光图像的权重矩阵来对场景图像和炫光图像进行合成，得到含有炫光的场景图。通过对炫光图片和场景图片的合成，我们构造出成对的数据集训练神经网络，使神经网络能自动去除炫光；本发明从色调映射的角度重新定义的含炫光场景图的合成方法，能够使神经网络在日常场景中对于炫光图像去除能力的泛化性能更强。
权利要求书clms
1.一种基于合成数据的神经网络去炫光方法，其特征在于，包括以下步骤：步骤S1、从场景数据集中随机选取一张图片，为场景图片S，从炫光数据集中随机选取一张图片，为炫光图片F；步骤S2、对所述场景图片S和所述炫光图片F进行逆伽马变换；步骤S3、计算所述炫光图片F的亮度矩阵IF；步骤S4、根据所述炫光图片F的亮度矩阵IF为炫光图片F和场景图片S分配权重矩阵，并合成带炫光的场景图片I；步骤S5、通过步骤S1到S4获取多张带炫光的场景图片I构成带炫光的场景图片数据集，利用步骤S1的场景数据集和获取的所述带炫光的场景图片数据集来训练神经网络模型，得到训练好的神经网络模型；步骤S6、向训练好的神经网络模型中输入炫光图片，对训练好的神经网络模型输出的图片恢复光源得到最终的去炫光图片Ifinal。2.根据权利要求1所述的一种基于合成数据的神经网络去炫光方法，其特征在于，步骤S3中，将所述炫光图片F的R，G，B颜色通道相加并乘以三分之一得到亮度矩阵IF：，其中，/＞分别代表所述炫光图片F的R，G，B颜色通道，其中相加并乘以三分之一是为了将所述亮度矩阵IF归一化至区间。3.根据权利要求2所述的一种基于合成数据的神经网络去炫光方法，其特征在于，步骤S4的实现过程为：步骤S4.1、根据所述炫光图片F的亮度矩阵IF为所述炫光图片F分配权重矩阵：；为所述场景图片S分配权重矩阵：/＞；其中，为sigmoid型函数，且有：/＞；其中，e为指数，a和x为参数；步骤S4.2、利用所述场景图片S和所述炫光图片F合成带炫光的场景图片I：；其中，为点乘操作。4.根据权利要求3所述的一种基于合成数据的神经网络去炫光方法，其特征在于，步骤S6的实现过程为：步骤S6.1、向训练好的神经网络模型中输入炫光图片，输出图片/＞；步骤S6.2、计算炫光图片的亮度矩阵/＞：；其中，分别代表炫光图片/＞的 R，G，B 颜色通道；步骤S6.3、计算所述炫光图片的权重矩阵W：；其中，为亮度矩阵/＞的最小元素和最大元素；/＞为参数，取值为15；步骤S6.4、对图片恢复光源得到最终的去炫光图片Ifinal：。
说明书desc
技术领域本发明涉及图像处理技术领域，主要涉及一种基于合成数据的神经网络去炫光方法。背景技术当设备面对强光源成像时，由于光线在镜头组间的多次反射与散射，常常会导致图片中出现大量的炫光。这些炫光不仅仅影响图像质量，而且容易对底层视觉任务造成极大的影响。因此人们致力于寻找从图像中去除炫光的有效方法。炫光去除的方法主要分为传统方法与深度学习方法两类。传统方法Auto removalof bright spot from images captured against flashing light source. In 2019IEEE International Conference on Distributed Computing, VLSI, ElectricalCircuits and Robotics , pages 1–6. IEEE, 2019. 2对于图像中的炫光的炫光的亮度，形状等做出强烈假设，并根据假设来检测出炫光。对于检测出的炫光，将其去除并同时修复图像。但这一部分传统方法仅能去除少量的炫光。How to train neural networks for flare removal. In Proceedings of theIEEE/CVF International Conference on Computer Vision, pages 2239–2247, 2021.首次引入深度学习的方法去除炫光。其依据物理原理，用计算机模拟出散射炫光的图像数据，并且在实验室中摄影收集了反射炫光图像数据，并利用这两份数据构成了炫光数据集。将炫光数据和场景图像做伽马逆变换后直接相加，合成出了含有炫光的场景图像。利用含有炫光的场景图像和不含炫光的场景图像训练神经网络，使神经网络能自动将炫光从图像中去除。最后，设置亮度阈值0.99，找出图像中光源，对其模糊处理，并还原回图像中。上述方法在合成带炫光的场景图像时，选择直接逆伽马变换后直接相加，然后在范围内截断，得到所需带炫光的场景图像。但是，首先，上述方法未考虑到在ISP图像信号处理过程中，色调映射曲线在图像层和炫光层融合过程中造成的影响，从而导致图像像素值的溢出；其次，在图像中找到光源时，需要设置亮度阈值，但是亮度阈值的超参数难以选定；最后，在夜晚时，光源的亮度常常低于0.99，导致光源难以恢复。发明内容发明目的：针对上述背景技术中存在的问题，本发明提供了一种基于合成数据的神经网络去炫光方法：技术方案：为实现上述目的，本发明采用的技术方案为：一种基于合成数据的神经网络去炫光方法，包括以下步骤：步骤S1、从场景数据集中随机选取一张图片，为场景图片S，从炫光数据集中随机选取一张图片，为炫光图片F；步骤S2、对所述场景图片S和所述炫光图片F进行逆伽马变换；步骤S3、计算所述炫光图片F的亮度矩阵IF；步骤S4、根据所述炫光图片F的亮度矩阵IF为炫光图片F和场景图片S分配权重矩阵，并合成带炫光的场景图片I；步骤S5、通过步骤S1到S4获取多张带炫光的场景图片I构成带炫光的场景图片数据集，利用步骤S1的场景数据集和获取的所述带炫光的场景图片数据集来训练神经网络模型，得到训练好的神经网络模型；步骤S6、向训练好的神经网络模型中输入炫光图片，对训练好的神经网络模型输出的图片恢复光源得到最终的去炫光图片Ifinal。优选的，步骤S3中，将所述炫光图片F的R，G，B颜色通道相加并乘以三分之一得到亮度矩阵IF：其中，/＞分别代表所述炫光图片F的R，G，B颜色通道，其中相加并乘以三分之一是为了将所述亮度矩阵IF归一化至区间。优选的，步骤S4的实现过程为：步骤S4.1、根据所述炫光图片F的亮度矩阵IF为所述炫光图片F分配权重矩阵：；为所述场景图片S分配权重矩阵：/＞；其中，为sigmoid型函数，且有：/＞；其中，e为指数，a和x为参数；步骤S4.2、利用所述场景图片S和所述炫光图片F合成带炫光的场景图片I：；其中，为点乘操作。优选的，步骤S6的实现过程为：步骤S6.1、向训练好的神经网络模型中输入炫光图片，输出图片/＞；步骤S6.2、计算炫光图片的亮度矩阵/＞：；其中，分别代表炫光图片/＞的 R，G，B 颜色通道；步骤S6.3、计算所述炫光图片的权重矩阵W：；其中，为亮度矩阵/＞的最小元素和最大元素；/＞为参数，取值为15；步骤S6.4、对图片恢复光源得到最终的去炫光图片Ifinal：。本发明的有益效果是：本发明考虑到色调映射曲线在图像层和炫光层融合过程中造成的影响，从而利用亮度矩阵算出权重后，对炫光图像进行合成，不会造成图像像素值溢出。本发明在恢复光源时，直接不需要设置亮度阈值，这样在黑夜与白天的情形下都能有效复原光源；并且即使存在多光源，同样能将光源进行恢复。附图说明图1是本发明提供的基于合成数据的神经网络去炫光方法流程图；图2是本发明提供的基于合成数据的神经网络去炫光方法中获取带炫光的场景图片并进行训练神经网络模型流程图；图3是本发明提供的基于合成数据的神经网络去炫光方法中对输出图片进行恢复光源流程图。实施方式下面结合附图对本发明作更进一步的说明。显然，所描述的实施例是本发明一部分实施例，而不是全部的实施例。基于本发明中的实施例，本领域普通技术人员在没有做出创造性劳动前提下所获得的所有其他实施例，都属于本发明保护的范围。本发明中：考虑到在ISP图像信号处理流程中色调映射曲线在色调映射曲线在图像层和炫光层融合过程中造成的影响，进而通过计算亮度矩阵来自适应产生权重对场景图片产生抑制效果；在恢复光源时，先计算其亮度矩阵，用最大最小值归一化至，这样图中最亮的区域的权重便被置为1，再用将图中非光源部分的权重抑制，α的值越大，图中非光源部分的权重抑制效果越好，这里我们取值15即能够满足需求。本发明提供了一种基于合成数据的神经网络去炫光方法，具体原理如图1所示，包括以下步骤：步骤S1、从场景数据集和炫光数据集中分别随机选取两张图片；步骤S2、对场景图片和炫光图片进行逆伽马变换；步骤S3、计算炫光图像的亮度矩阵：其中S为炫光图片，下标分别代表其RGB通道，I为炫光图像的亮度矩阵。我们相加除以三是将亮度矩阵归一化至。步骤S4、用亮度矩阵计算炫光图像和场景图像的权重矩阵并合成带炫光的场景图像；步骤S4.1、利用炫光图像的亮度矩阵，可以计算出炫光图像和场景矩阵各自的权重矩阵和/＞。其中f为sigmoid型函数步骤S4.2、用上述步骤计算得到的矩阵合成带炫光的场景图像。步骤S5、利用场景图像和带炫光的场景图像训练神经网络；步骤S6、测试时，对网络输出的图片恢复光源。步骤S6.1、计算输入图像的亮度矩阵：其中，I表示输入的含炫光的场景图像。步骤S6.2、计算输入图像的权重矩阵：步骤S6.2、利用输入图像还原输出图像中的光源：表1是不同的α下，图像质量和图像失真程度对比，这里我们取值15即能够满足需求。表1：不同的α下，图像质量和图像失真程度对比：以上所述仅是本发明的优选实施方式，应当指出：对于本技术领域的普通技术人员来说，在不脱离本发明原理的前提下，还可以做出若干改进和润饰，这些改进和润饰也应视为本发明的保护范围。
