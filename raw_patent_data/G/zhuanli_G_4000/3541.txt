标题title
一种基于NAND闪存控制器的纠错方法及系统
摘要abst
本发明属于存储主控芯片技术领域，具体提供了一种基于NAND闪存控制器的纠错方法及系统，其中方法包括：输入端获取写指令，将写入数据写入到写入数据缓存模块，并生成随机数；将写入数据与随机数发送至优化数据模块进行优化，最后将优化后的数据存储到NAND存储颗粒；输入端读取读指令，将数据从NAND存储颗粒里读取出来，进行纠错处理，通过与写数据时相同的随机数进行去优化处理；将处理好的数据传输到读取数据缓存模块，再通过读指令读出数据到Host系统。本发明通过设计使用可提高纠错效率的设计结构和方法，可以广泛地使用多种不同类型的闪存颗粒，解决了现有存储主控芯片中的纠错技术里难以解决的大量连续相同数据写入，尤其是当存储数据出现长“1”或长“0”时，造成纠错效率低下或无法纠错的问题，有效地提高了存储主控芯片的纠错性能。
权利要求书clms
1.一种基于NAND闪存控制器的纠错方法，其特征在于，包括以下步骤：S1，输入端获取写指令，将写入数据写入到写入数据缓存模块，并生成随机数；S2，将写入数据与随机数发送至优化数据模块进行优化；S3，将优化后的数据进行纠错编码处理后写入存储颗粒；S4，获取读指令，将数据从存储颗粒读出，并对数据进行译码纠错；S5，将完成纠错的读出数据与写入优化时相同的随机数进行去优化处理；S6，将处理好的数据传输到读取数据缓存模块，再通过读指令读出数据到Host系统。2.根据权利要求1所述的基于NAND闪存控制器的纠错方法，其特征在于，所述S1具体包括：当Host主机端发送写指令时，存储主控芯片将数据写入到数据缓存模块，与此同时，当存储主控芯片判断指示启动Randomizer发生器后，随机数据产生模块根据寄存器和Trim表的配置，产生随机数Random Key。3.根据权利要求1所述的基于NAND闪存控制器的纠错方法，其特征在于，所述S1中随机数据产生模块具体包括：通过配置控制信号和初始化Key信号控制Trim配置模块中的各相应寄存器；Host系统的写/读控制信号通过写/读指令解析模块进行解析判断，再根据Trim配置模块的指示信号在状态控制模块内进行状态机控制；最终由随机数据发生模块产生所需的多个随机数据。4.根据权利要求3所述的基于NAND闪存控制器的纠错方法，其特征在于，所述S1具体包括：首先存储主控芯片判断是否为写指令还是读指令，如果是写指令，则判断是第几个扇区的写操作，是否需要启动随机数生成，如果是，则根据写指令及NAND类型进行状态机判别，最终产生随机数据。5.根据权利要求1所述的基于NAND闪存控制器的纠错方法，其特征在于，所述S2-S3具体包括：写指令下的优化数据模块中，将32个Byte或32xN个Byte的写入数据与随机数进行异或非处理，产生优化的数据。6.根据权利要求1所述的基于NAND闪存控制器的纠错方法，其特征在于，所述S3具体包括：优化后的数据通过ECC纠错模块进行编码处理，然后将处理后通过读写指令数据处理模块写入到存储颗粒。7.根据权利要求1所述的基于NAND闪存控制器的纠错方法，其特征在于，所述S4～S6具体包括：当Host主机端发送读指令时，读指令首先从NAND存储里读取数据，经过ECC译码纠错后，在去优化数据模块，将完成纠错的读出数据与写入优化时产生的相同的随机数进行去优化处理，然后将处理好的数据传输到读取数据缓存模块，最后通过读指令处理将数据从读取数据缓存模块传输到HOST主机端。8.根据权利要求7所述的基于NAND闪存控制器的纠错方法，其特征在于，所述S4具体包括：通过读写指令数据处理模块将数据从存储颗粒里读出，传输到ECC纠错模块进行数据译码纠错。9.根据权利要求7所述的基于NAND闪存控制器的纠错方法，其特征在于，所述S5具体包括：如果是读指令，则判断是在第几个扇区的读操作，然后判别是否要进行去随机化操作，如是，再根据读指令及NAND类型进行状态机判别，启动去随机化操作；在读指令下的去优化数据模块中，将32个Byte或32xN个Byte的已完成ECC纠错的数据与写入时相同的随机化数据进行异或非处理。10.一种基于NAND闪存控制器的纠错系统，其特征在于，所述系统用于实现如权利要求1-9任一项所述的基于NAND闪存控制器的纠错方法，包括：写入数据缓存模块，用于在输入端获取写指令，将写入数据写入到数据缓存模块；随机数据产生模块，用于生成随机数；优化数据模块，用于将写入数据与随机数进行优化处理，并将优化后的数据传输到ECC纠错模块进行处理；ECC纠错模块，用于数据编码及译码纠错，当收到写指令时，输入的数据进行编码；读指令时，对数据进行译码纠错；读写指令数据处理模块，用于对写指令下或读指令下的数据进行处理，使之能传输到NAND存储颗粒芯片中；去优化处理模块，用于将完成纠错的读出数据与写入优化时相同的随机数进行去优化处理；读取数据缓存模块，用于将处理好的数据传输到读取数据缓存模块，再通过读指令读出数据到Host系统。
说明书desc
技术领域本发明涉及存储主控芯片技术领域，更具体地，涉及一种基于NAND闪存控制器的纠错方法及系统。背景技术随着闪存存储的快速发展，出现了多种NAND颗粒产品，包括了SLC、MLC、TLC和QLC等产品。每个闪存颗粒产品的数据存储页容量大小也不完全相同，有1024byte、也有2048bytes，4096bytes和8192bytes以及为了寻求更大效率使用的16KBytes等。NAND颗粒在新数据没有写入时维持在初始化状态数据“1”，而且NAND闪存颗粒的读取是按页读取，然后在存储主控中做ECC纠错处理。以三层单元NAND单元存储特性为例，如图2～所示，图2为TLC NAND存储单元中当外部数据进行写入存储时，是以存储单元内的存储电荷的电压在不同的区间来表征不同的数据存储；图2是当外部写入数据是大量的相同或相近数据时，多个NAND存储单元内的电荷电压分布会几乎一致；图2是指当数据存储单元的电荷出现损失或因温度变化等情况时，会导致存储单元内的电荷电压发生偏移，进而会导致部分数据出现错误，需要用ECC纠错。在实际的嵌入式存储芯片应用时，往往是一颗存储主控芯片加上1颗或多颗NAND颗粒设计而成的芯片，如U盘、SD卡、eMMC芯片或UFS芯片。存储主控芯片设计中，写入数据时会将每个页空间分成若干个扇区结构进行数据处理存储，但是实际所存储的数据大小往往不会按一个完整的页容量写入到NAND存储颗粒中，这样就可能有很多数据维持在初始状态的“1”或“0”，导致写入到NAND颗粒的数据出现长“1”或者长“0”。一旦写入的数据出现多次大量相同数据，如长“1”或“0”，在纠错时，必然会导致纠错效率减低，纠错迭代次数增加，甚至纠错失败。以低密度奇偶校验码LDPC纠错为例，在码长较长时需要的奇偶校验矩阵要满足“稀疏性”，即校验矩阵中“1”的密度比较低，并且码长越长，密度越低。现在主流NAND颗粒的页容量大小达到8Kbytes或16Kbytes，分成4或8个Sector后，每个Sector大小有1K或2Kbytes，需要的校验矩阵会很大。如图3所示，在LDPC译码纠错时，会通过对码字中的各个比特值进行关于接收码字和信道参数的后验概率或似然比进行估算，针对概率大的数据再进行译码尝试，经过多次迭代之后，实现纠错功能。如果写入的数据为长“0”或长“1”，就无法通过后验概率或者对数似然比来度量判决，无法有效地将迭代结束得到的码字的可靠度计算结果作为下一次迭代的输入，就容易导致NAND存储主控芯片的纠错性能降低，甚至出错。所以现有的存储主控设计中，缺少了一种可适用于当HOST端主芯片发送大量连续相同的数据时，尤其是在不满一个页容量数据时不得不写入大量长“1”或者长“0”数据到NAND颗粒时能高效译码纠错的设计结构和方法。发明内容本发明针对现有技术中存在的当HOST端主芯片发送大量连续相同的数据时，纠错性能降低，甚至出错的技术问题。本发明提供了一种基于NAND闪存控制器的纠错方法，包括以下步骤：S1，输入端获取写指令，将写入数据写入到写入数据缓存模块，并生成随机数；S2，将写入数据与随机数发送至优化数据模块进行优化；S3，将优化后的数据进行纠错编码处理后写入存储颗粒；S4，获取读指令，将数据从存储颗粒读出，并对数据进行译码纠错；S5，将完成纠错的读出数据与写入优化时相同的随机数进行去优化处理；S6，将处理好的数据传输到读取数据缓存模块，再通过读指令读出数据到Host系统。优选地，所述S1具体包括：当Host主机端发送写指令时，存储主控芯片将数据传输到写入数据缓存模块，与此同时，当存储主控芯片判断存储主控芯片指示启动Randomizer发生器后，随机数据产生模块根据寄存器和Trim表的配置，产生随机数Random Key。优选地，所述S1中随机数据产生模块具体包括：通过配置控制信号和初始化Key信号控制Trim配置模块中的各相应寄存器；Host系统的写/读控制信号通过写/读指令解析模块进行解析判断，再根据Trim配置模块的指示信号在状态控制模块内进行状态机控制；最终由随机数据发生模块产生所需的多个随机数据。优选地，所述S1具体包括：首先存储主控芯片判断是否为写指令还是读指令，如果是写指令，则判断是第几个扇区的写操作，是否需要启动随机数生成，如果是，则根据写指令及NAND类型进行状态机判别，最终产生随机数据。优选地，所述S2具体包括：写指令下的优化数据模块中，将32个Byte或32xN个Byte的NAND写入数据与随机数进行异或非处理。优选地，所述S3具体包括：优化后的数据通过ECC纠错模块进行解码处理，处理后通过读写指令数据处理模块将数据写入存储颗粒。优选地，所述S4～S6具体包括：当Host主机端发送读指令时，读指令首先从NAND存储里读取数据，经过ECC译码纠错后，再通过去优化数据模块，将完成纠错的读出数据与写入优化时相同的随机数进行去优化处理，然后将处理好的数据传输到读取数据缓存模块，最后通过读指令处理将数据从读取数据缓存模块传输到HOST主机端。优选地，所述S4具体包括：通过读写指令数据处理模块将数据从存储颗粒里读出，传输到ECC纠错模块进行数据译码纠错。优选地，所述S5具体包括：如果是读指令，则判断是在第几个扇区的读操作，然后判别是否要进行去随机化操作，如是，再根据读指令及NAND类型进行状态机判别，启动去随机化操作；在读指令下的去优化数据模块中，将32个Byte或32xN个Byte的NAND读取的数据与随机化数据进行异或非处理。本发明还提供了一种基于NAND闪存控制器的纠错系统，所述系统用于实现基于NAND闪存控制器的纠错方法，包括：写入数据缓存模块，用于在输入端获取写指令，将写入数据写入到数据缓存模块；随时数据产生模块，用于生成随机数；优化数据模块，用于将写入数据与随机数进行优化处理，并将优化后的数据进行纠错编码处理后写入存储颗粒；ECC纠错模块，用于获取读指令，将数据从存储颗粒读出，并对数据进行译码纠错；读写指令数据处理模块，用于对写指令下或读指令下的数据进行处理，使之能传输到NAND存储颗粒芯片中；去优化处理模块，用于将完成纠错的读出数据按与写入优化时相同的随机数进行去优化处理；读取数据缓存模块，用于将处理好的数据传输到读取数据缓存模块，再通过读指令读出数据到Host系统。有益效果：本发明提供的一种基于NAND闪存控制器的纠错方法及系统，其中方法包括：获取写指令，将写入数据写入到写入数据缓存模块，并生成随机数；将写入数据与随机数发送至优化数据模块进行优化；将与写数据时相同的随机数进行纠错处理；将处理好的数据传输到读取数据缓存模块，再通过读指令读出数据到Host系统。本发明通过设计使用可提高纠错效率的设计结构和方法，可以广泛地使用多种不同类型的闪存颗粒，解决了现有存储主控芯片中的纠错技术里难以解决的大量连续相同数据写入，尤其是当存储数据出现长“1”或长“0”时，造成纠错效率低下或无法纠错的问题，有效的提高了存储主控芯片的纠错性能。附图说明图1为本发明提供的一种基于NAND闪存控制器的纠错方法原理图；图2为背景技术提供的TLC NAND电压与数据存储分布情况图；图2为背景技术提供的写入大量相同数据时存储单元电压相同；图2为背景技术提供的电荷损失-＞导致电压偏移-＞数据出错图；图3为背景技术提供的LDPC码BP译码算法图；图4为本发明提供的随机数据产生模块原理图；图5为本发明提供的状态控制模块原理图；图6为本发明提供的优化数据模块原理图；图7为本发明提供的一种可能的电子设备的硬件结构示意图；图8为本发明提供的一种可能的计算机可读存储介质的硬件结构示意图。具体实施方式下面结合附图和实施例，对本发明的具体实施方式作进一步详细描述。以下实施例用于说明本发明，但不用来限制本发明的范围。图1为本发明提供的一种基于NAND闪存控制器的纠错方法，包括以下步骤：S1，输入端获取写指令，将写入数据写入到写入数据缓存模块，并生成随机数；S2，将写入数据与随机数发送至优化数据模块进行优化；S3，将优化后的数据进行纠错编码处理后写入存储颗粒；S4，获取读指令，将数据从存储颗粒读出，并对数据进行译码纠错；S5，将完成纠错的读出数据与写入优化时相同的随机数进行去优化处理；S6，将处理好的数据传输到读取数据缓存模块，再通过读指令读出数据到Host系统。在一个具体的实施场景中，如图1所示，当Host主机端发送写指令时，存储主控芯片将写入数据写入到写入数据缓存模块，与此同时，当存储主控芯片判断存储主控芯片指示启动Randomizer发生器后，随机数据产生模块根据寄存器和Trim表的配置，产生随机数Random Key。然后系统输入的写入数据和随机数Random Key通过优化数据模块进行数据转换，用户数据在通过ECC纠错模块实现编码，然后通过读写指令数据处理模块处理好各数据，将数据通过NAND接口写入到NAND颗粒中。当Host主机端发送读指令时，读指令首先从NAND存储里读取数据，经过ECC译码纠错后，再通过去优化数据模块，将与写数据时相同的随机数Random Key进行纠错处理。最后将处理好的数据传输到读取数据缓存模块，再通过读指令读出数据到Host系统。在随机数据产生模块中，如图4所示，随机数据产生模块包含了Trim配置模块、写/读指令解析模块、状态控制模块，以及Random数据发生模块。通过配置控制信号和初始化Key控制信号配置Trim模块中的各相应寄存器；Host系统的写/读控制信号通过写/读指令解析模块进行解析判断，再根据Trim模块的指示信号在状态控制模块内进行状态机控制，最终由Random数据发生模块产生所需的32或32xN个Byte字节的多个随机数据。在状态控制模块中，如图5所示，首先存储主控芯片判断是否为写指令还是读指令，如果是写指令，则判断是第几个扇区写操作，是否需要启动随机数生产，如果是，则根据系统写指令及NAND类型等进行状态机判别；最终产生随机数据。如果是读指令，则判断是在第几个扇区的写操作，然后判别是否要进行去随机化操作，如是，再根据读指令及NAND类型等进行状态机判别，启动去随机化操作。优选的方案，对于优化数据模块和去优化数据模块，两者都可以公用一套操作算法和模块处理，基本原则如图6所示，在写指令下优化数据模块中将32个Byte或32xN个Byte的用户数据与随机化数据进行异或非处理，如下列数据为例：用户数据：0 0 0 0 0 0 0 0 0 0F F 0 0 0 0 0 0F F F F 0 0 0 0 00 0 0 0 0随机数据：1 3a b e 4 7 6 2 4 8 9a b d 2 6d 3 5a 9 4 2 8 3 6 59 0a c写入NAND数据：1 3a b e 4 7 6 2 4 7 6a b d 2 6d c a 5 6 4 2 8 3 65 9 0ac对于读指令下的去优化数据模块中，将32个Byte或32xN个Byte的NAND读取的数据与随机化数据进行异或非处理，如下列数据为例：NAND读出数据：1 3a b e 4 7 6 2 4 7 6a b d 2 6d c a 5 6 4 2 8 3 6 5 90a c随机数据：1 3a b e 4 7 6 2 4 8 9a b d 2 6d 3 5a 9 4 2 8 3 6 5 9 0a c用户数据：0 0 0 0 0 0 0 0 0 0F F 0 0 0 0 0 0F F F F 0 0 0 0 00 0 0 0 0从上例可以看出，开始时系统写入的大量相同或相似的数据，通过写入和读出的2次异或非处理，仍然可以完整无误的读出到系统。数据经过了随机数据产生模块和优化数据模块的设计结构和方法后，长“1”或长“0“数据已经被处理优化过了，有效的提高了下一步的ECC纠错模块的数据处理效率和减少了不能有效纠错的风险。本发明实施例还提供了一种基于NAND闪存控制器的纠错系统，所述系统用于实现如前所述的基于NAND闪存控制器的纠错方法，包括：写入数据缓存模块，用于在输入端获取写指令，将写入数据写入到数据缓存模块；随机数据产生模块，用于生成随机数；优化数据模块，用于将写入数据与随机数进行优化处理，并将优化后的数据进行纠错编码处理后写入存储颗粒；ECC纠错模块，用于获取读指令，将数据从存储颗粒读出，并对数据进行译码纠错；读写指令数据处理模块，用于对写指令下或读指令下的数据进行处理，使之能传输到NAND存储颗粒芯片中；去优化处理模块，用于将完成纠错的读出数据按与写入优化时相同的随机数进行去优化处理；读取数据缓存模块，用于将处理好的数据传输到读取数据缓存模块，再通过读指令读出数据到Host系统。请参阅图7为本发明实施例提供的电子设备的实施例示意图。如图7所示，本发明实施例提了一种电子设备，包括存储器1310、处理器1320及存储在存储器1310上并可在处理器1320上运行的计算机程序1311，处理器1320执行计算机程序1311时实现以下步骤：S1，输入端获取写指令，将写入数据写入到写入数据缓存模块，并生成随机数；S2，将写入数据与随机数发送至优化数据模块进行优化；S3，将优化后的数据进行纠错编码处理后写入存储颗粒；S4，获取读指令，将数据从存储颗粒读出，并对数据进行译码纠错；S5，将完成纠错的读出数据与写入优化时相同的随机数进行去优化处理；S6，将处理好的数据传输到读取数据缓存模块，再通过读指令读出数据到Host系统。请参阅图8为本发明提供的一种计算机可读存储介质的实施例示意图。如图8所示，本实施例提供了一种计算机可读存储介质1400，其上存储有计算机程序1411，该计算机程序1411被处理器执行时实现如下步骤：S1，输入端获取写指令，将写入数据写入到写入数据缓存模块，并生成随机数；S2，将写入数据与随机数发送至优化数据模块进行优化；S3，将优化后的数据进行纠错编码处理后写入存储颗粒；S4，获取读指令，将数据从存储颗粒读出，并对数据进行译码纠错；S5，将完成纠错的读出数据与写入优化时相同的随机数进行去优化处理；S6，将处理好的数据传输到读取数据缓存模块，再通过读指令读出数据到Host系统。需要说明的是，在上述实施例中，对各个实施例的描述都各有侧重，某个实施例中没有详细描述的部分，可以参见其它实施例的相关描述。本领域内的技术人员应明白，本发明的实施例可提供为方法、系统、或计算机程序产品。因此，本发明可采用完全硬件实施例、完全软件实施例、或结合软件和硬件方面的实施例的形式。而且，本发明可采用在一个或多个其中包含有计算机可用程序代码的计算机可用存储介质上实施的计算机程序产品的形式。本发明是参照根据本发明实施例的方法、设备、和计算机程序产品的流程图和/或方框图来描述。应理解可由计算机程序指令实现流程图和/或方框图中的每一流程和/或方框、以及流程图和/或方框图中的流程和/或方框的结合。可提供这些计算机程序指令到通用计算机、专用计算机、嵌入式计算机或者其他可编程数据处理设备的处理器以产生一个机器，使得通过计算机或其他可编程数据处理设备的处理器执行的指令产生用于实现在流程图一个流程或多个流程和/或方框图一个方框或多个方框中指定的功能的装置。这些计算机程序指令也可存储在能引导计算机或其他可编程数据处理设备以特定方式工作的计算机可读存储器中，使得存储在该计算机可读存储器中的指令产生包括指令装置的制造品，该指令装置实现在流程图一个流程或多个流程和/或方框图一个方框或多个方框中指定的功能。这些计算机程序指令也可装载到计算机或其他可编程数据处理设备上，使得在计算机或其他可编程设备上执行一系列操作步骤以产生计算机实现的处理，从而在计算机或其他可编程设备上执行的指令提供用于实现在流程图一个流程或多个流程和/或方框图一个方框或多个方框中指定的功能的步骤。尽管已描述了本发明的优选实施例，但本领域内的技术人员一旦得知了基本创造概念，则可对这些实施例作出另外的变更和修改。所以，所附权利要求意欲解释为包括优选实施例以及落入本发明范围的所有变更和修改。显然，本领域的技术人员可以对本发明进行各种改动和变型而不脱离本发明的精神和范围。这样，倘若本发明的这些修改和变型属于本发明权利要求及其等同技术的范围之内，则本发明也意图包括这些改动和变型在内。
