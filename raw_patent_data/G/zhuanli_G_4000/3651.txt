标题title
基于Yolov5和Drools的管道病害识别方法
摘要abst
本发明为一种基于Yolov5和Drools的管道病害识别方法，包括：利用Flask框架部署深度学习模型，上传管道图像或视频，对管道视频进行关键帧提取；基于Yolov5模型对管道图像或视频的关键帧进行检测，输出检测结果图像以及病害信息，提取病害属性；通过JPype库引入Drools规则引擎模块，将管道病害属性传入并封装成实体对象，进而执行规则推理，与基于行业标准制定的DRL规则进行匹配，推理得到管道修复建议表；局部刷新管道病害修复建议表，整合管道病害属性和修复建议。本发明通过结合深度学习和规则引擎，实现管道病害识别、等级判断和修复建议生成一体化，节省人力成本并提高管道病害检测效率。
权利要求书clms
1.一种基于Yolov5和Drools的管道病害识别方法，其特征在于，包括如下步骤：步骤一、利用Flask框架部署深度学习模型，上传管道图像或管道视频文件，对管道视频进行关键帧提取；步骤二、基于Yolov5深度学习模型对管道图像或管道视频的关键帧进行检测，输出检测结果图像以及病害信息，从所述管道病害信息中提取管道病害属性；步骤三、通过JPype库引入Drools规则引擎模块，将所述管道病害属性传入所述Drools规则引擎模块并封装成实体对象，对实体对象执行规则推理，与基于行业标准制定的DRL规则进行匹配，推理得到管道病害修复建议表；步骤四、局部更新管道病害修复建议表，整合管道病害属性和修复建议作为管道标签节点存入Neo4j数据库从而进行可视化。2.根据权利要求1所述的一种基于Yolov5和Drools的管道病害识别方法，其特征在于，所述步骤一中上传管道图像或管道视频文件具体为：获取所述管道图像或管道视频文件的后缀，根据文件后缀对文件类型进行分类，如果文件后缀为avi、wmv、mpeg、mp4、m4v、mov、asf、flv、f4v、rmvb、rm、3gp、vob，则作为视频文件保存；如果文件后缀为bmp、jpg、jpeg、png、tif、pcx、tga、exif、fpx、svg、psd、cdr、pcd、dxf、ufo、eps、ai、raw、WMF、webp、avif、apng，则作为图像文件保存。3.根据权利要求1或2所述的一种基于Yolov5和Drools的管道病害识别方法，其特征在于，所述对管道视频进行关键帧提取具体包括：提取视频的所有帧，进行灰度化和高斯模糊处理，将依次经过灰度化和高斯模糊处理的当前帧和上一帧进行图像差分运算得到帧差，遍历视频所有帧后得到帧差数组，利用多项式函数拟合帧差数组，通过设置归一化阈值和最小间距找出所述多项式函数极值点，即视频的关键帧以及位置。4.根据权利要求1所述的一种基于Yolov5和Drools的管道病害识别方法，其特征在于，所述步骤二中包括：将所述Yolov5深度学习模型中的detect.py文件封装成函数，调用该函数对原始管道图像或管道视频的关键帧进行检测，输出检测结果图像和管道病害信息，在检测结果图像中，通过边界框标识病害所在位置并给出病害类型和置信度；其中，所述管道病害信息包含管道病害类别的标号、边界框中心点坐标与宽高、原始图像大小和检测结果置信度。5.根据权利要求1所述的一种基于Yolov5和Drools的管道病害识别方法，其特征在于，所述步骤三中包括：建立一个设定名称的实体类，设置所述实体类的参数，所述参数包括deformArea变形面积、diameter直径、disjointDistance脱节距离、ruptureArea破裂面积、gradeXX病害等级、E管道重要性参数、K地区重要性参数、T土质影响参数、Arclength弧长、lateralDeviofNozzle 管口横向偏差距离、scoreXX病害分值、thicknessOfTubewall管壁厚度、s管段结构性病害参数、f管段损坏状况参数、ri修复指数、damage_status_description损坏状态描述和repair_advice修复建议属性；将Drools规则引擎模块及其依赖打包成jar文件，通过所述JPype库提供的函数引入规则推理功能，将所述管道病害属性传入规则引擎模块中并封装成一个Pipe类型的实体对象，并结合基于行业标准制定的DRL规则，执行Drools规则引擎，推理得到管道病害的修复建议，建立管道病害修复建议表。6.根据权利要求5所述的一种基于Yolov5和Drools的管道病害识别方法，其特征在于，所述行业标准制定的DRL规则具体包括：根据行业标准文件，按照病害名称、代码、等级划分及分值表、管段结构性病害参数计算公式、管段损坏状况参数计算公式、地区重要性参数K表、管道重要性参数E表、土质影响参数T表、管段修复指数计算公式、管段修复等级划分表制定DRL规则。7.根据权利要求5所述的一种基于Yolov5和Drools的管道病害识别方法，其特征在于，所述步骤四中包括：使用Ajax交互方式实现管道修复建议表的局部刷新，所述修复建议表中包含：病害等级和分值、管道重要性参数E、地区重要性参数K、土质影响参数T、管段损坏状况参数、管段结构性病害参数、管段修复指数、损坏状况描述和修复建议；将管道领域本体模型OWL文件转化为turtle文件，导入至Neo4j图形数据库，建立web页面与Neo4j图形数据库的连接，将管道病害属性和修复建议整合成一个节点，所述节点以所述设定名称为标签，并存入Neo4j数据库，Echarts模块实现可视化。
说明书desc
技术领域本发明公开了一种结合Yolov5和Drools的管道病害识别方法，涉及深度学习和规则推理领域。背景技术随着中国经济发展，城镇化普及，城镇排水管道网作为重要的基础设施得到了较大的发展。城镇排水管道长度里程不断增长，维护成本也大大提高，如果忽视城镇排水管道的维护，会直接影响人们的日常生活，影响建筑结构的稳定性和安全性、导致房屋潮湿、城市内涝、资源浪费和经济损失。传统的城镇排水管道检测与评估方法存在一定的局限性，例如专业技术人员进入管道进行人工检测并记录城镇排水管道病害类型和程度以及给出管道修复建议，或使用机器进入管道拍摄图像或视频然后通过专业技术人员进行分析和评估，以上方法都需要大量的专业技术人员的参与和时间成本的投入，并存在一定的安全隐患以及不便性。随着机器学习算法的日趋成熟，使用大量的城镇排水管道图像数据集训练而成的深度学习模型可以判断出管道病害类别，但是无法判断病害严重程度并直接给出修复建议。发明内容针对上述技术问题，发明旨在提供一种基于Yolov5和Drools的管道病害识别方法，有效地结合深度学习模型和规则引擎，从而实现管道病害识别和规则推理功能的一体化，提高管道检测与评估流程的便利性。本发明采取的技术方案如下。一种基于Yolov5和Drools的管道病害识别方法，包括如下步骤：步骤一、利用Flask框架部署深度学习模型，上传管道图像或管道视频文件，对管道视频进行关键帧提取；步骤二、基于Yolov5深度学习模型对管道图像或管道视频的关键帧进行检测，输出检测结果图像以及病害信息，从所述管道病害信息中提取管道病害属性；步骤三、通过JPype库引入Drools规则引擎模块，将所述管道病害属性传入所述Drools规则引擎模块并封装成实体对象，对实体对象执行规则推理，与基于行业标准制定的DRL规则进行匹配，推理得到管道病害修复建议表；步骤四、局部更新管道病害修复建议表，整合管道病害属性和修复建议作为管道标签节点存入Neo4j数据库从而进行可视化。进一步的，所述步骤一中上传管道图像或管道视频文件具体为：获取所述管道图像或管道视频文件的后缀，根据文件后缀对文件类型进行分类，如果文件后缀为avi、wmv、mpeg、mp4、m4v、mov、asf、flv、f4v、rmvb、rm、3gp、vob，则作为视频文件保存；如果文件后缀为bmp、jpg、jpeg、png、tif、pcx、tga、exif、fpx、svg、psd、cdr、pcd、dxf、ufo、eps、ai、raw、WMF、webp、avif、apng，则作为图像文件保存。进一步的，所述对管道视频进行关键帧提取具体包括：提取视频的所有帧，进行灰度化和高斯模糊处理，将依次经过灰度化和高斯模糊处理的当前帧和上一帧进行图像差分运算得到帧差，遍历视频所有帧后得到帧差数组，利用多项式函数拟合帧差数组，通过设置归一化阈值和最小间距找出所述多项式函数极值点，即视频的关键帧以及位置。进一步的，所述步骤二中包括：将所述Yolov5深度学习模型中的detect.py文件封装成函数，调用该函数对原始管道图像或管道视频的关键帧进行检测，输出检测结果图像和管道病害信息，在检测结果图像中，通过边界框标识病害所在位置并给出病害类型和置信度；其中，所述管道病害信息包含管道病害类别的标号、边界框中心点坐标与宽高、原始图像大小和检测结果置信度。进一步的，所述步骤三中包括：建立一个设定名称的实体类，设置所述实体类的参数，所述参数包括deformArea变形面积、diameter直径、disjointDistance脱节距离、ruptureArea破裂面积、gradeXX病害等级、E管道重要性参数、K地区重要性参数、T土质影响参数、Arclength弧长、lateralDeviofNozzle 管口横向偏差距离、scoreXX病害分值、thicknessOfTubewall管壁厚度、s管段结构性病害参数、f管段损坏状况参数、ri修复指数、damage_status_description损坏状态描述和repair_advice修复建议属性；将Drools规则引擎模块及其依赖打包成jar文件，通过所述JPype库提供的函数引入规则推理功能，将所述管道病害属性传入规则引擎模块中并封装成一个Pipe类型的实体对象，并结合基于行业标准制定的DRL规则，执行Drools规则引擎，推理得到管道病害的修复建议，建立管道病害修复建议表。进一步的，所述行业标准制定的DRL规则具体包括：根据行业标准文件，按照病害名称、代码、等级划分及分值表、管段结构性病害参数计算公式、管段损坏状况参数计算公式、地区重要性参数K表、管道重要性参数E表、土质影响参数T表、管段修复指数计算公式、管段修复等级划分表制定DRL规则。进一步的，所述步骤四中包括：使用Ajax交互方式实现管道修复建议表的局部刷新，所述修复建议表中包含：病害等级和分值、管道重要性参数E、地区重要性参数K、土质影响参数T、管段损坏状况参数、管段结构性病害参数、管段修复指数、损坏状况描述和修复建议；将管道领域本体模型OWL文件转化为turtle文件，导入至Neo4j图形数据库，建立web页面与Neo4j图形数据库的连接，将管道病害属性和修复建议整合成一个节点，所述节点以所述设定名称为标签，并存入Neo4j数据库，Echarts模块实现可视化。有益效果：本发明实施例提供了一种结合Yolov5和Drools的管道病害识别方法，可以有效地结合深度学习模型和规则引擎，将管道病害识别、严重程度评估和修复建议生成融为一体，使城镇排水管道检测与评估的便利性得到改善。附图说明图1是本发明实施例的结合Yolov5和Drools的管道病害识别方法的流程图；图2是本发明实施例的视频关键帧提取流程图；图3是本发明实施例的规则引擎模块引入Flask项目的流程图；图4是本发明实施例的系统架构图。实施方式为使本发明实施例的目的、技术方案和优点更加清楚，下面将结合本发明实施例中的附图，对本发明实施例中的技术方案进行清楚、完整地描述，显然，所描述的实施例是本发明一部分实施例，而不是全部的实施例。基于本发明中的实施例，本领域技术人员在没有做出创造性劳动前提下所获得的所有其他实施例，都属于本发明保护的范围。如图1所示，一种基于Yolov5和Drools的管道病害识别方法的具体步骤如下：步骤1、利用Flask框架部署深度学习模型，上传管道图像或视频，对管道视频进行关键帧提取；步骤1.1、创建Flask项目；步骤1.2、部署Yolov5深度学习模型；步骤1.3、上传文件类型判断及视频关键帧提取；步骤2、基于Yolov5深度学习模型对管道图像或视频的关键帧进行检测，输出检测结果图像以及病害信息，通过公式从病害信息中提取病害属性；步骤3、通过JPype库引入Drools规则引擎模块，将所述管道病害属性传入并封装成实体对象，对实体对象执行规则推理，与基于行业标准制定的DRL规则进行匹配，推理得到管道修复建议信息；步骤3.1、制定基于行业标准的DRL规则，实现Drools规则引擎模块；步骤3.2、通过JPype库引入Drools规则引擎模块，其次将管道病害属性传入并封装成一个实体对象，进而执行规则推理，推理得到管道修复建议表；步骤4、局部刷新管道病害修复建议表，整合管道病害属性和修复建议作为管道标签节点存入Neo4j数据库从而进行可视化。在一个实施例中，步骤1.1中Flask项目创建过程如下，利用Pycharm开发软件创建一个Flask项目，项目解释器为python3.7，在templates文件夹下新建一个名为index.html的模板文件，在app.py文件中创建与模板文件相互映射的view函数。本项目采用的Web前端UI框架是Element-ui+Echarts,需要在html模板文件中引入vue.js、require.js、echarts.min.js、index.css、index.js、jquery-3.5.1.min.js。利用Element-ui组件库设计Web前端，并实现相应的组件，包括导航菜单、加载、表格、表单、上传、按钮、图标、标签、分割线，回到顶部。在一个实施例中，步骤1.2中Yolov5深度学习模型的部署过程如下，通过Yolo官方提供的渠道下载Yolov5源码，并将其导入Flask项目中，通过pip安装requirements.txt文件中所需要的对应版本的package。将detect.py检测文件封装成一个函数以方便调用，其中深度学习权重文件切换成针对管道病害训练的模型并修改yaml配置文件。在一个实施例中，步骤1.3中的文件类型判断如下，如果文件后缀为avi、wmv、mpeg、mp4、m4v、mov、asf、flv、f4v、rmvb、rm、3gp、vob，当作视频文件保存并进行关键帧提取；如果文件后缀为bmp、jpg、jpeg、png、tif、pcx、tga、exif、fpx、svg、psd、cdr、pcd、dxf、ufo、eps、ai、raw、WMF、webp、avif、apng，当作图像文件保存。在一个实施例中，步骤1.3中的视频关键帧提取过程如图2所示，具体步骤如下：读取上传的管道视频文件；计算上传的管道视频的总共帧数，记为count；设置循环变量i=1以及循环判断条件i＜=count,以下为循环体；读取视频第i帧；对当前帧进行灰度化处理；使用大小的高斯核对当前帧的灰度图进行高斯模糊处理；将依次经过灰度化和高斯模糊处理的当前帧和上一帧进行图像差分运算得到帧差；设置循环变量i=i+1，判断循环条件是否满足，如果满足条件，继续进入循环体，否则循环结束；循环结束后，得到帧差数组；获取拟合帧差数组的多项式函数，多项式函数的次数可以通过deg参数控制，而本实施例中deg=2，表示最高次数项的次数为2；设置归一化阈值和最小间距参数找出多项式函数的极值点，即视频的关键帧。在一个实施例中，步骤2中的Yolov5深度学习模型检测结果有管道病害检测结果图像和管道病害信息。其中管道病害检测结果图像，通过边界框标识出了管道病害类别以及框出病害所在位置并给出置信度，例如边界框在图像中框出了管道病害所处位置，并在左上方显示“BX 0.77”，其中“BX”表示管道病害类型为变形，“0.77”表示管道病害检测的置信度为0.77；其中检测结果文本文件包含管道病害类别的标号、边界框中心点坐标与宽高和检测结果置信度，例如“1 275 117.5 316 75 480 360 0.765214”，其中“1”表示管道病害类型为变形，“275 117.5”表示边界框中心点坐标，“316 75”表示边界框宽高，“480 360”表示管道图像大小，“0.765214”表示管道病害检测的置信度。在一个实施例中，步骤2中的管道病害属性如下，6种管道病害类型分别为变形、破裂、沉积、障碍物、脱节和错口，它们分别具有不同的病害属性：变形区域、裂口大小和数量、沉积物厚度、过水断面损失、脱节距离和管口偏差。在一个实施例中，步骤3.1中的制定基于行业标准的DRL规则过程如下：首先建立一个名为Pipe的实体类，设置deformArea变形面积、diameter直径、disjointDistance脱节距离、ruptureArea破裂面积、gradeXX病害等级、E管道重要性参数、K地区重要性参数、T土质影响参数、Arclength弧长、lateralDeviofNozzle管口横向偏差距离、scoreXX病害分值、thicknessOfTubewall管壁厚度、s管段结构性病害参数、f管段损坏状况参数、ri修复指数、damage_status_description损坏状态描述和repair_advice修复建议属性；其次根据《城镇排水管道检测与评估技术规程》中的管道评估部分制定对应的DRL规则，例如rule "qingduBX"lock-on-active truewhen$pipe:Pipe)then$pipe.setGradeBX；$pipe.setScoreBX；end。其中“qingduBX”表示规则名称为轻度变形，“lock-on-active true”用来限制当前规则只会被匹配一次，当管道的deformArea变形区域小于diameter直径的5%时，推理得到管道的GradeBX变形等级为1，ScoreBX变形分值为1.0。在一个实施例中，步骤3.1中的基于行业标准的管道修复建议计算过程如下：；式中，RI表示管段修复指数；F 表示管段结构性病害参数，由管道病害数量、病害类型、病害等级所决定；K 表示地区重要性参数；E 表示管道重要性参数；T 表示土质影响参数。地区重要性参数K与管道所处地区类别有关，其计算方法如下：；管道重要性参数E与管径D有关，其计算方法如下：；土质影响参数T与管道所处土质类型和等级有关，其计算方法如下：；管段修复等级划分即管段修复建议计算方法如下：。/＞在一个实施例中，步骤3.2中的Drools规则引擎模块引入至Flask项目的过程如图3所示，具体步骤如下：在idea开发软件，依次点击File-＞Artifacts-＞+-＞jar-＞From modules withdependencies-＞copy to the output directory and link via manifest-＞OK，此后会在out文件夹下生成规则引擎模块项目jar文件以及依赖jar文件；加载规则引擎模块jar文件以及依赖jar文件；启动JVM虚拟机，其中jdk版本为1.8.0_351；加载Java类并实例化对象 ；调用对象的方法，将管道病害属性文件所在路径作为参数传入方法中，执行规则推理。在一个实施例中，步骤3.2中的执行Drools规则推理功能的过程如下，将经过公式提取的管道病害属性传入规则引擎模块中并封装成一个Pipe类型的实体对象，从而执行Drools规则引擎，推理得到管道病害的修复建议。在一个实施例中，步骤4中的管道病害修复建议表的显示过程如下，使用Ajax技术实现修复建议表的局部刷新，修复建议表中包含：病害等级和分值、管道重要性参数E、地区重要性参数K、土质影响参数T、管段损坏状况参数、管段结构性病害参数、管段修复指数、损坏状况描述和修复建议。在一个实施例中，步骤4中的Neo4j图形数据库导入OWL本体模型过程如下，安装3.5.34版本的Neo4j数据库，并通过Github下载neosemantics-3.5.0.4_2.jar,将其保存至Neo4j数据库安装路径中的plugins目录下，修改Neo4j数据库的配置文件neo4j.conf，在其末尾添加dbms.unmanaged_extension_classes=semantics.Extension =/rdf，通过rdf2rdf-1.0.1-2.3.1.jar将owl格式文件转变成turtle格式文件。在Neo4j图像数据库命令行依次输入CREATE INDEX ON:Resource，CALL semantics. importRDF这两个命令并执行，至此完成OWL本体模型导入至Neo4j图形数据库。在一个实施例中，步骤4中的管道领域本体模型可视化过程如下，通过py2neo提供的函数建立Web项目与Neo4j数据库的连接，查询Neo4j中存储的所有节点和所有关系，用字典格式存储单个节点信息和关系信息，将所有的节点信息和关系信息存放在一个字典中，并转化为json格式保存。Json文件中节点信息保存格式如下：{"name": "pty_deformArea","symbolSize": 50,"category": "u5bf9u8c61"}。其中“name”表示节点名称、”symbolSize”表示节点标记大小、“category”表示节点类型的unicode编码。Json文件中关系信息保存格式如下：{"source": "pty_scoreBX","target": "pty_score","name": "subPropertyOf"}。其中“source”表示源对象，“target”表示目标对象，“name”表示关系名称，整体表示pty_scoreBX是pty_score的子属性。在HTML文件中定义一个大小合适的DIV容器用来显示关系图，初始化Echarts实例对象，指定配置项和数据，其中数据即是json格式的节点信息和关系信息，将配置项设置给Echarts实例对象即完成OWL本体模型的可视化。在一个实施例中，系统架构图如图4所示，具体包括：PC访问Web系统；Element-UI和Echarts处于展示层负责前端UI；Jinja2负责HTML模板渲染以及数据传递，Ajax通过GET和POST方法实现局部刷新；Werkzeug是Flask提供的WSGI规范的使用函数库，提供路由、调试和Web服务器网关接口子系统；业务逻辑层中主要包括深度学习模块检测管道病害类别、规则引擎模块执行规则推理和OWL管道领域本体模型的可视化；Py2neo作为数据访问层用于建立与Neo4j图形数据库的连接；数据库采用Neo4j图像数据库，用于存储OWL本体模型。尽管已描述了本发明的优选实施例，但本领域内的技术人员一旦得知了基本创造性概念，则可对这些实施例作出另外的变更和修改。所附权利要求意欲解释为包括优选实施例以及落入本发明范围的所有变更和修改。本说明书中的各个实施例均采用递进的方式描述，各个实施例之间相同相似的部分互相参见即可，每个实施例重点说明的都是与其他实施例的不同之处。尤其，对于设备实施例而言，由于其基本相似于方法实施例，所以描述得比较简单，相关之处参见方法实施例的部分说明即可。以上所述，仅为本发明的具体实施方式，但本发明的保护范围并不局限于此，任何熟悉本技术领域的技术人员在本发明揭露的技术范围内，可轻易想到的变化或替换，都应涵盖在本发明的保护范围之内。因此，本发明的保护范围应该以权利要求的保护范围为准。另外需要说明的是，在上述具体实施方式中所描述的各个具体技术特征，在不矛盾的情况下，可以通过任何合适的方式进行组合。为了避免不必要的重复，本发明对各种可能的组合方式不再另行说明。
