标题title
内窥镜系统及其工作方法
摘要abst
本发明提供一种内窥镜系统，其选择性地切换并驱动多个磁场产生元件而产生磁场，并根据基于磁场检测元件的磁场的测定结果，检测包含内窥镜的插入部分的位置及形状中的至少一者在内的插入状态，所述内窥镜系统进行使预先设定的测定单位时间内的磁场产生元件的驱动顺序在多个测定单位时间之间不同的控制。
权利要求书clms
1.一种内窥镜系统，其选择性地切换并驱动多个磁场产生元件而产生磁场，并根据基于磁场检测元件的所述磁场的测定结果，检测包含内窥镜的插入部分的位置及形状中的至少一者在内的插入状态，所述内窥镜系统包括：磁场产生控制部，其进行使预先设定的测定单位时间内的所述磁场产生元件的驱动顺序在多个所述测定单位时间之间不同的控制。2.根据权利要求1所述的内窥镜系统，其中，在选择性地切换并获取通过多个所述磁场检测元件检测出的磁场的测定结果的情况下，所述内窥镜系统还具备：磁场测定控制部，其在所述测定单位时间内进行如下控制，即，使从多个所述磁场检测元件获取在1个所述磁场产生元件被驱动的单位驱动时间内产生的所述磁场的测定结果的顺序在多个所述单位驱动时间之间不同。3.根据权利要求1或2所述的内窥镜系统，其中，所述内窥镜系统还包括：插入状态检测部，其根据将针对最近的规定数量的所述测定单位时间的每一个所述测定单位时间由多个所述磁场产生元件各自产生的磁场的测定结果进行平均化而得的测定结果，检测所述插入状态。4.根据权利要求1至3中任一项所述的内窥镜系统，其中，多个所述磁场产生元件所产生的各个磁场的频率相同。5.一种内窥镜系统的工作方法，其选择性地切换并驱动多个磁场产生元件而产生磁场，并根据基于磁场检测元件的所述磁场的测定结果，检测包含内窥镜的插入部分的位置及形状中的至少一者在内的插入状态，所述内窥镜系统的工作方法具备：磁场产生控制步骤，进行使预先设定的测定单位时间内的所述磁场产生元件的驱动顺序在多个所述测定单位时间之间不同的控制。
说明书desc
技术领域本发明涉及一种内窥镜系统及其工作方法。背景技术公开有一种通过磁场检测元件测定由多个磁场产生元件产生的磁场，并根据测定结果检测内窥镜的插入部分的形状的检测装置。在该检测装置中，预先设定的测定单位时间内的磁场产生元件的驱动顺序始终为相同顺序。发明内容发明要解决的技术课题当测定单位时间内的磁场产生元件的驱动顺序始终为相同顺序的情况下，各磁场产生元件的驱动周期成为恒定。因此，有时周期性噪声仅对由特定的相同磁场产生元件产生的磁场产生较大影响。这种情况下，由该磁场产生元件产生的磁场中包含噪声影响较多，其结果导致无法精度良好的检测出包含内窥镜的插入部分的位置及形状中的至少一者在内的插入状态。本发明是鉴于上述情况而完成的，其提供一种能够精度良好的检测包含内窥镜的插入部分的位置及形状中的至少一者在内的插入状态的内窥镜系统及其工作方法。用于解决技术课题的手段关于本发明的内窥镜系统，其选择性地切换并驱动多个磁场产生元件而产生磁场，并根据基于磁场检测元件的磁场的测定结果，检测包含内窥镜的插入部分的位置及形状中的至少一者在内的插入状态，所述内窥镜系统包括磁场产生控制部，其进行使预先设定的测定单位时间内的磁场产生元件的驱动顺序在多个测定单位时间之间不同的控制。另外，关于本发明的内窥镜系统，在选择性地切换并获取通过多个磁场检测元件检测出的磁场的测定结果的情况下，还可以具备：磁场测定控制部，其在测定单位时间内进行如下控制，即，使从多个磁场检测元件获取在1个磁场产生元件被驱动的单位驱动时间内产生的磁场的测定结果的顺序在多个单位驱动时间之间不同。并且，关于本发明的内窥镜系统，其还可以包括：插入状态检测部，其根据将针对最近的规定数量的测定单位时间的每一个测定单位时间由多个磁场产生元件各自产生的磁场的测定结果进行平均化而得的测定结果，检测插入状态。并且，关于本发明的内窥镜系统，多个磁场产生元件所产生的各个磁场的频率可以相同。并且，关于本发明的内窥镜系统的工作方法，其选择性地切换并驱动多个磁场产生元件而产生磁场，并根据基于磁场检测元件的磁场的测定结果，检测包含内窥镜的插入部分的位置及形状中的至少一者在内的插入状态，所述内窥镜系统的工作方法包括：磁场产生控制步骤，进行使预先设定的测定单位时间内的磁场产生元件的驱动顺序在多个测定单位时间之间不同的控制。发明效果根据本发明，能够精度良好的检测包含内窥镜的插入部分的位置及形状中的至少一者在内的插入状态。附图说明图1是表示使用了内窥镜系统的内窥镜检查的状态的说明图。图2是表示内窥镜系统的整体结构的示意图。图3是表示内窥镜系统的电结构的框图。图4是表示磁场检测电路的电结构的框图。图5是表示多个检测线圈检测多个产生线圈所产生的磁场的状态的说明图。图6是表示磁场测定数据的一例的说明图。图7是对基于判别部的判别处理和基于位置检测部的各检测线圈的位置检测处理进行说明的图。图8是表示插入部分的形状检测处理的一例的说明图。图9是对以相同顺序驱动产生线圈的情况进行说明的图。图10是对以相同顺序驱动产生线圈的情况进行说明的图。图11是对周期性噪声的影响进行说明的的图。图12是对实施方式所涉及的产生线圈的驱动顺序进行说明的的图。图13是表示实施方式所涉及的每一个磁场测定期间的对应关系的一例的图。图14是表示观察图像及插入部分形状图像的显示处理的一例的流程图。图15是对减少周期性噪声的影响进行说明的的图。图16是对磁场检测元件的选择顺序进行说明的的图。具体实施方式以下，参考附图对用于实施本发明的技术的方式例进行详细说明。＜内窥镜系统的整体结构＞图1是表示本发明的技术所涉及的内窥镜系统9的整体结构的示意图。如图1所示，内窥镜系统9具备内窥镜10、光源装置11、导航装置12、磁场产生器13、处理器装置14及显示器15。内窥镜系统9用于患者等受检者H的体内内窥镜检查。受检者H为受检体的一例。该内窥镜10例如是插入到大肠等消化道内的内窥镜，且是具有挠性的软性内窥镜。内窥镜10具有：被插入到消化道内的插入部分17、与插入部分17的基端侧连接设置且供执刀医生OP把持而进行各种操作的操作部18及与操作部18连接设置的通用塞绳19。内窥镜检查例如在使受检者H躺在床16上的状态下进行。当大肠检查的情况下，由作为医生的执刀医生OP将内窥镜10的插入部分17从肛门插入到下消化道内。光源装置11向内窥镜10提供照亮作为观察部位的大肠内的照明光。处理器装置14通过处理由内窥镜10拍摄到的图像来生成观察图像41。观察图像41显示于显示器15上。执刀医生OP一边确认观察图像41，一边进行内窥镜检查。显示于显示器15的观察图像41基本上是动态图像，但作为观察图像41，根据需要也能够显示静止图像。并且，内窥镜系统9具备对由执刀医生OP进行的内窥镜10的插入操作等的手指的操作进行导航的导航功能。在此，导航是指通过向执刀医生OP提示受检者H的体内的包含内窥镜10的插入部分17的位置及形状中的至少一者在内的插入状态，从而辅助执刀医生OP的内窥镜10的手指的操作。导航功能是利用磁场MF来检测插入部分17的插入状态，从而提示所检测到的插入状态的功能。在本实施方式中，插入状态除了插入体内的插入部分17的一部分的位置以外，还包括体内的插入部分17整体的形状。导航功能通过导航装置12、磁场产生器13及后述的内窥镜10内的磁场测定装置来实现。磁场产生器13产生磁场MF。磁场产生器13例如安装于支架，并配置于受检者H躺卧的床16的旁边。并且，磁场产生器13配置于所产生的磁场MF到达受检者H的体内的范围内。内窥镜10内的磁场测定装置检测由磁场产生器13产生的磁场MF，并测定所检测到的磁场MF的强度。导航装置12根据基于磁场测定装置测定出的磁场测定结果导出磁场产生器13与插入部分17的相对位置，由此检测插入部分17的插入状态。处理器装置14生成表示导航装置12所检测到的插入状态的插入部分形状图像42。显示器15显示观察图像41和插入部分形状图像42。另外，显示观察图像41和插入部分形状图像42的显示器15可以分别单独设置。如图2所示，插入部分17为细径且长条的管状部分，由软性部21、弯曲部22及前端部23从基端侧朝向前端侧依次连接而构成。软性部21具有挠性。弯曲部22为能够通过操作部18的操作而弯曲的部位。前端部23配置有摄像装置48等。并且，虽未图示，但在前端部23的前端面上设置有：照明窗46，向观察部位照亮照明光；观察窗47，入射照明光被被摄体反射的被摄体光；处置器具出口，用于使处置器具突出；及清洗喷嘴，用于通过对观察窗47喷射气体及水来清洗观察窗47。在插入部分17内设置有光导件33、信号电缆32、操作线、处置器具插入贯穿用的管路。光导件33从通用塞绳19延伸设置，将从光源装置11供给的照明光引导到前端部23的照明窗46。信号电缆32除了用于来自摄像装置48的图像信号及控制摄像装置48的控制信号的通信以外，还用于对摄像装置48的电力供给。信号电缆32与光导件33同样地，也从通用塞绳19延伸设置，并配设至前端部23。操作线是用于操作弯曲部22的线，配设于操作部18至弯曲部22之间。处置器具插入贯穿用的管路是用于插入贯穿钳子等处置器具的管路，从操作部18配设至前端部23。除此以外，在插入部分17内设置有送气送水用流体软管。流体软管向前端部23供给观察窗47的清洗用气体及水。并且，在插入部分17内，从该软性部21到前端部23为止以预先设定的间隔设置有多个检测线圈25。各检测线圈25相当于检测磁场MF的磁场检测元件。各检测线圈25分别因受到从磁场产生器13产生的磁场MF的影响而在电磁感应的作用下产生感应电动势，并通过感应电动势产生感应电流。从各检测线圈25产生的感应电流的值表示由各检测线圈25分别检测到的磁场MF的强度，这成为磁场测定结果。即，磁场测定结果是指与表示磁场MF的强度的感应电流的大小相对应的值。在操作部18上设置有由执刀医生OP操作的各种操作部件。具体而言，在操作部18上设置有两种弯曲操作旋钮27、送气送水按钮28及抽吸按钮29。两种弯曲操作旋钮27分别连结于操作线，用于弯曲部22的左右弯曲操作及上下弯曲操作。并且，在操作部18上设置有作为处置器具插入贯穿用管路的入口的处置器具导入口31。通用塞绳19是用于将内窥镜10连接于光源装置11的连接塞绳。通用塞绳19内包括信号电缆32、光导件33及流体软管。并且，在通用塞绳19的端部设置有连接于光源装置11的连接器34。通过将连接器34连接于光源装置11，从光源装置11向内窥镜10供给内窥镜10的运用中所需要的电力、控制信号、照明光、气体及水。并且，通过前端部23的摄像装置48获取到的观察部位的图像信号和基于各检测线圈25的检测信号的磁场测定结果从内窥镜10发送到光源装置11。在连接器34与光源装置11之间未进行使用了金属制信号线等的有线电连接，取而代之，连接器34与光源装置11通过光通信可通信地连接。连接器34通过光通信来进行在内窥镜10与光源装置11之间交换的控制信号的收发和从内窥镜10向光源装置11的图像信号及磁场测定结果的发送。在连接器34上设置有连接于信号电缆32的激光二极管36。LD36用于从内窥镜10向光源装置11发送大容量数据，具体而言，用于发送图像信号及磁场测定结果。LD36将原本为电信号形式的图像信号及磁场测定结果以光信号的形式发送到设置于光源装置11的光电二极管37。另外，虽然省略图示，但与LD36及PD37单独地，在连接器34及光源装置11这两者中均设置有光收发部，其将在内窥镜10与光源装置11之间交换的小容量的控制信号进行光信号化而进行收发。另外，在连接器34上设置有从光源装置11的供电部通过无线供电接受供电的受电部。连接器34内的光导件33被插入到光源装置11内。并且，连接器34内的流体软管经由光源装置11连接于送气送水装置。由此，从光源装置11及送气送水装置向内窥镜10分别供给照明光和气体及水。光源装置11经由连接器34向内窥镜10的光导件33供给照明光，并且向内窥镜10的流体软管供给从送气送水装置供给的气体及水。并且，光源装置11用PD37接收从LD36发送的光信号，将所接收到的光信号转换为作为电信号的原来的图像信号及磁场测定结果之后，输出到导航装置12。导航装置12将从光源装置11输入的用于生成观察图像41的图像信号输出到处理器装置14。并且，导航装置12控制后述的磁场产生器13的驱动，并且检测受检者H的体内的插入部分17的插入状态，并将该检测结果作为用于生成插入部分形状图像42的信息输出到处理器装置14。如此，本实施方式所涉及的内窥镜10为具有与光源装置11连接的一个连接器34的单连接器类型。内窥镜10经由连接有连接器34的光源装置11分别与处理器装置14及导航装置12可通信地连接。磁场产生器13具有相当于多个磁场产生元件的多个产生线圈39。各产生线圈39例如包括通过施加驱动电流，从而在与直交坐标系XYZ的XYZ坐标轴分别对应的方向产生交流磁场的X轴线圈、Y轴线圈及Z轴线圈。各产生线圈39产生相同频率的磁场MF。各产生线圈39在导航装置12的控制下，以彼此不同的时刻产生磁场MF，详细内容将后述。＜内窥镜＞图3是表示内窥镜系统9的电结构的框图。如图3所示，内窥镜10具有光导件33、照射透镜45、照明窗46、观察窗47、摄像装置48、磁场检测电路49、总括控制电路50、信号电缆32、LD36、未图示的流体软管及清洗喷嘴。光导件33为大口径光纤或束状光纤等。光导件33的入射端经由连接器34插入于光源装置11内。光导件33插入贯穿于连接器34内、通用塞绳19内、操作部18内及插入部分17内，且出射端向设置于插入部分17的前端部23内的照射透镜45凸出。由此，从光源装置11向光导件33的入射端供给的照明光从照射透镜45通过设置于前端部23的前端面的照明窗46照摄于观察部位。然后，在观察部位所反射的照明光作为观察部位的像光，通过设置于前端部23的前端面的观察窗47而入射于摄像装置48的摄像面。另外，前述的流体软管的一端侧通过连接器34及光源装置11与送气送水装置连接，并且流体软管的另一端侧通过插入部分17内等而与设置于前端部23的前端面的送气送水喷嘴连接。由此，从送气送水装置供给的气体或水从送气送水喷嘴向观察窗47喷射，从而清洗观察窗47。摄像装置48具有聚光透镜52和成像元件53。聚光透镜52将从观察窗47入射的观察部位的像光进行聚光，且将所聚光的观察部位的像光成像于成像元件53的成像面。成像元件53为CMOS型或CCD型的成像元件。成像元件53例如为向各像素分配了R、G、B中任一种微型滤波器的彩色成像元件。成像元件53拍摄作为观察对象的观察部位。更具体而言，成像元件53拍摄成像于成像面的观察部位的像光，并将观察部位的图像信号输出到总括控制电路50。并且，在成像元件53中例如设置有输出水晶振子等基准信号的振荡部53a，以从该振荡部53a振荡的基准信号为基准，成像元件53输出构成动态图像的图像信号。基准信号的间隔规定帧速率。帧速率例如为30fps。磁场检测电路49与插入部分17内的各检测线圈25电连接。磁场检测电路49将磁场测定数据55输出到总括控制电路50，所述磁场测定数据55包括与由磁场产生器13的产生线圈39产生的磁场MF对应的各检测线圈25的各个磁场测定结果。具体而言，如图4所示，磁场检测电路49具有：仪表放大器49A、滤波器49B、选择器49C、放大器49D、及A/D转换电路49E。仪表放大器49A设置于每个检测线圈25，输入端子与各检测线圈25连接。仪表放大器49A扩增各检测线圈25所输出的微弱的检测信号，并作为与检测信号的值相应的电压而输出。各仪表放大器49A的输出端子与滤波器49B连接。滤波器49B为LPF或BPF等滤波器，设置于每个仪表放大器49A，输入端子与各仪表放大器49A连接。滤波器49B使从仪表放大器49A输入的信号中的预先设定的频率带的信号通过。各滤波器49B的输出端子与选择器49C连接。选择器49C从各滤波器49B中选择读取对象的滤波器49B。多个滤波器49B中、来自通过选择器49C选择的滤波器49B的电压经由选择器49C输入到放大器49D。选择器49C根据从磁场测定控制部58输入的定时信号，依次选择各滤波器49B。由此，依次读取与多个检测线圈25的检测信号相应的电压。放大器49D扩增从选择器49C输出的电压。更具体而言，放大器49D例如为运算放大器，扩增并输出从选择器49C输入的输入电压与作为参考试料输入的基准电压之差的电压值。A/D转换电路49E将放大器49D的输出电压转换为数字信号。A/D转换电路49E输出该数字信号的值作为各检测线圈25的磁场测定结果。通过选择器49C依次选择各检测线圈25，由此A/D转换电路49E将包含基于所有的检测线圈25的检测信号的各个磁场测定结果的磁场测定数据55向总括控制电路50输出。总括控制电路50包含包括CPU的各种运算电路和各种存储器而构成，总括控制内窥镜10的各部的动作。该总括控制电路50通过执行存储于未图示的存储器的控制用程序而发挥信号处理部57、磁场测定控制部58、图像信号输出部59的功能。磁场检测电路49及磁场测定控制部58相当于磁场测定部。磁场测定部根据检测线圈25输出的检测信号，测定以相当于多个磁场产生元件的各产生线圈39作为产生源的多个磁场MF，由此输出每个磁场MF的磁场测定结果。组合磁场测定部和检测线圈25而构成磁场测定装置。信号处理部57对依次从成像元件53输出的图像信号实施各种信号处理。作为信号处理，例如，包含相关双采样处理及信号扩增处理等模拟信号处理、在模拟信号处理后将模拟信号转换为数字信号的A/D转换处理等。将实施了信号处理之后的图像信号称为帧图像信号61。信号处理部57按照帧速率将帧图像信号61输出到图像信号输出部59。帧图像信号61用作观察部位的动态图像数据。如此，多个帧图像信号61为通过成像元件53执行动态图像摄影来获取且以与帧速率相应的时间间隔输出的图像信号。磁场测定控制部58经由磁场检测电路49获取包含各检测线圈25的多个磁场测定结果的磁场测定数据55，并将所获取到的磁场测定数据55输出到图像信号输出部59。如图5所示，关于各检测线圈25的磁场测定结果，即使各产生线圈39所产生的磁场的强度相同，例如，也根据产生磁场MF的各产生线圈39与各检测线圈25的每一个之间的距离及朝向而变化。例如，图5所示的第1产生线圈39中，如以实线表示那样，与第1～第3的各检测线圈25的距离及朝向不同。因此，关于1个第1产生线圈39所产生的磁场MF，第1～第3的各检测线圈25的每一个磁场测定结果不同。第2产生线圈39及第3产生线圈39的每一个与第1～第3的各检测线圈25的关系也是一样的。并且，相反地，即使第1～第3的各产生线圈39所产生的磁场MF的强度相同，针对各产生线圈39的每一个磁场MF的1个第1检测线圈25的磁场测定结果不同。在此，例如，考虑第1～第3的各产生线圈39分别为X轴线圈、Y轴线圈及Z轴线圈的情况。在这种情况下，根据针对X轴、Y轴及Z轴的各线圈的每一个磁场MF的1个第1检测线圈25的磁场测定结果，能够检测与XYZ坐标轴对应的第1检测线圈25的三维坐标位置。关于第2检测线圈25及第3检测线圈25也是同样的。只要能够检测以预先设定于插入部分17的间隔设置的各检测线圈25的三维坐标位置，则能够检测插入部分17的形状。并且，若能够检测配置于前端部23附近的检测线圈25的三维坐标位置，则能够检测前端部23的位置。图6是用于说明磁场测定控制部58所获取的磁场测定数据55的一例的说明图。磁场测定控制部58获取磁场测定数据55，其包含由多个各检测线圈25分别检测多个产生线圈39所产生的多个磁场MF的每一个，并从各检测线圈25分别输出的多个磁场测定结果。在图6中，～分别为表示针对1个产生线圈39所产生的磁场MF的多个检测线圈25的各磁场测定结果的数据列。例如“D11”为通过“第1检测线圈”检测第一个驱动的产生线圈39中所产生的磁场MF而得到的磁场测定结果。“D12”为通过“第2检测线圈”检测第一个驱动的产生线圈39中所产生的磁场MF而得到的磁场测定结果。同样地，“D42”为通过“第2检测线圈”检测第四个驱动的产生线圈39中所产生的磁场MF而得到的磁场测定结果。“D43”为通过“第3检测线圈”检测第四个驱动的产生线圈39中所产生的磁场MF而得到的磁场测定结果。磁场测定控制部58一边与磁场产生器13中的各产生线圈39的各自的磁场产生时刻同步，一边依次获取各检测线圈25的磁场测定结果。磁场测定控制部58例如在以后述同步信号规定的1次磁场测定期间中，对所有的产生线圈39的各自的磁场MF获取所有的检测线圈25的各自的磁场测定结果。由此，磁场测定控制部58在1次磁场测定期间中，获取包含各产生线圈39与各检测线圈25的所有组合所涉及的多个磁场测定结果的磁场测定数据55。该磁场测定期间相当于预先设定的磁场的测定单位时间。在本实施方式中，磁场测定期间成为规定成像元件53的帧速率的基准信号的间隔。例如，当在磁场产生器13内设置有9个产生线圈39，且在插入部分17内设置有17个检测线圈25的情况下，针对各产生线圈39获取17个磁场测定结果。因此，磁场测定控制部58在1次磁场测定期间内获取合计包含9×17＝153个磁场测定结果的磁场测定数据55。将包含所有这些组合所涉及的多个磁场测定结果的磁场测定数据55称为总磁场测定数据。在本实施方式中，只要没有特别说明，则在磁场测定数据55中包含总磁场测定数据。如图7所示，图像信号输出部59对从信号处理部57依次输入的多个帧图像信号61的每一个附加帧开始信号VD，从而输出到帧图像信号61。在图7中，为了便于理解，“帧1”、“帧2”、“帧3”……，为表示多个帧图像信号61的输出顺序的帧编号。帧开始信号VD例如为垂直同步信号。此外，图像信号输出部59对帧图像信号61附加磁场测定数据55，从而输出帧图像信号61。即，图像信号输出部59输出的所有的帧图像信号61中包含帧开始信号VD及磁场测定数据55。如图7所示，磁场测定数据55附加于与成像元件53的消隐时段BT对应的各帧图像信号61之间的信号无效区域ND。消隐时段BT例如为垂直消隐期间。帧开始信号VD也为多个帧图像信号61的垂直消隐期间中所包含的信号。图像信号输出部59经由信号电缆32将帧图像信号61输出到LD36。LD36将对帧图像信号61进行光信号化的光信号发送到光源装置11的PD37。如此，图像信号输出部59将从成像元件53经由信号处理部57获取到的帧图像信号61输出到内窥镜10的外部。并且，通过将帧图像信号61中所包含的帧开始信号VD作为同步信号进行利用，图像信号输出部59发挥同步信号生成部的功能。＜光源装置＞光源装置11具有照明光源63、PD37、光源控制部64、通信接口65。照明光源63例如为LD或发光二极管等半导体光源，并且是将波长从红色区域遍及青色区域的白色光作为照明光射出的白色光源。另外，作为照明光源63，除了白色光源之外，还可以使用射出紫色光及红外光等特殊光的特殊光光源。从照明光源63射出的照明光入射于光导件33的入射端。PD37接收从LD36发送的光信号。PD37将以光信号的形式接收到的帧图像信号61转换为原来的电信号的形式。将基于PD37的转换后的帧图像信号61输入到光源控制部64。光源控制部64包含包括CPU的各种运算电路和各种存储器而构成，且控制照明光源63等光源装置11的各部的动作。并且，光源控制部64将从PD37输入的转换后的帧图像信号61经由通信接口65输出到导航装置12。＜导航装置＞导航装置12具有：图像信号获取部68、插入状态检测部69、定时信号发生器70、磁场产生控制部71、显示输出部74。导航装置12的各部由包含1个或多个CPU的各种运算电路构成，并通过执行存储于未图示的存储器的控制用程序来进行动作。图像信号获取部68经由通信接口65从光源控制部64获取帧图像信号61。然后，图像信号获取部68将所获取到的帧图像信号61输出到显示输出部74。并且，图像信号获取部68提取帧图像信号61中所包含的帧开始信号VD及磁场测定数据55，并将所提取到的帧开始信号VD及磁场测定数据55输出到插入状态检测部69。并且，图像信号获取部68将从帧图像信号61所提取到的帧开始信号VD输出到TG70。TG70根据从图像信号获取部68输入的帧开始信号VD，将选择性地切换各产生线圈39的控制用时钟信号输出到磁场产生控制部71。磁场产生控制部71根据从TG70输入的时钟信号，控制各产生线圈39的磁场产生的开始时刻。此外，磁场产生控制部71还控制各磁场测定期间中的各产生线圈39的磁场产生的顺序。对基于磁场产生控制部71的控制的详细内容进行后述。插入状态检测部69根据从图像信号获取部68获取到的帧开始信号VD及磁场测定数据55，检测插入受检者H的体内的内窥镜10的插入部分17的插入状态。插入状态检测部69具有位置检测部72、插入部分形状检测部73。位置检测部72根据帧开始信号VD及磁场测定数据55，检测各检测线圈25的位置。位置检测部72具有判别部72A。如图7所示，判别部72A参考对应关系75来判别磁场测定数据55中所包含的多个磁场测定结果。对应关系75是表示磁场测定数据55中所包含的与各产生线圈39和各检测线圈25的多个组合对应的多个磁场测定结果的存储顺序的信息。判别部72A根据对应关系75，判别磁场测定数据55中所包含的各磁场测定结果是与各产生线圈39和各检测线圈25的哪个组合对应的数据。具体而言，如后面叙述，在磁场测定中，以帧开始信号VD为基准，按每个磁场测定期间确定有各产生线圈39产生磁场MF的产生顺序以及针对1个产生线圈39的磁场MF的各检测线圈25的磁场测定结果的获取顺序。与各产生线圈39和各检测线圈25的组合相应的多个磁场测定结果根据产生顺序和获取顺序存储于磁场测定数据55内。因此，判别部72A通过以帧开始信号VD为基准，并参考规定存储顺序的对应关系75，能够判别磁场测定数据55中所包含的多个磁场测定结果与哪个组合对应。位置检测部72根据判别部72A判别出的多个磁场测定结果，将各检测线圈25的位置、具体而言将三维坐标位置检测为线圈位置数据76。线圈位置数据76是以磁场产生器13为基准的相对位置。在图7中，例如，P1表示第1检测线圈25的三维坐标位置。对于P2、P3、P4等也是同样的。在本实施方式中，位置检测部72根据将最近的规定数量的磁场测定期间的磁场测定数据55进行平均化而得的磁场测定数据55，检测各检测线圈25的位置。由此，能够减少噪声的影响。另外，为了该平均化，位置检测部72将至少最近的5个磁场测定数据55存储于导航装置12所具备的非易失性存储器等的存储部中。这种情况下，每当输入新的磁场测定数据55时，位置检测部72将其替换为最久的磁场测定数据55。位置检测部72将线圈位置数据76输出到插入部分形状检测部73。插入部分形状检测部73根据从位置检测部72输入的线圈位置数据76，检测受检者H的体内的插入部分17的形状。图8是用于说明基于插入部分形状检测部73的插入部分17的形状检测处理的一例的说明图。如图8所示，插入部分形状检测部73根据线圈位置数据76所表示的各检测线圈25的位置，进行将各位置以曲线进行内插的内插处理，生成表示插入部分17的形状的插入部分形状数据78。插入部分形状数据78中包含插入部分17的前端部23的前端位置PT。插入部分形状检测部73将插入部分形状数据78输出到显示输出部74。每当图像信号获取部68获取新的帧图像信号61时，插入状态检测部69反复进行基于判别部72A的判别处理、检测各检测线圈25的线圈位置数据76的位置检测处理、插入部分17的形状检测处理及插入部分形状数据78的输出处理。显示输出部74将从图像信号获取部68输入的帧图像信号61和从插入状态检测部69输入的插入部分形状数据78经由通信接口80A、80B输出到处理器装置14。此时，显示输出部74将帧图像信号61和与该帧图像信号61时间上对应的插入部分形状数据78建立对应关系，并输出到处理器装置14。＜处理器装置＞处理器装置14具有显示输入部82和显示控制部83。显示输入部82将从显示输出部74经由通信接口80A、80B依次输入的帧图像信号61及插入部分形状数据78依次输出到显示控制部83。显示控制部83从显示输入部82接收帧图像信号61及插入部分形状数据78的输入，并将基于帧图像信号61的观察图像41和基于插入部分形状数据78的插入部分形状图像42显示于显示器15。如此，帧图像信号61从内窥镜10经由光源装置11及导航装置12发送到处理器装置14。然后，处理器装置14对从内窥镜10获取到的帧图像信号61实施图像处理，并生成作为显示图像的一例的观察图像41。＜产生线圈的驱动顺序的控制＞首先，参考图9～图11，对如以往那样将各磁场测定期间内的产生线圈39的驱动顺序设为相同顺序时的问题点进行说明。如图9所示，各磁场测定期间中，与帧开始信号VD相对应而从TG70向磁场产生控制部71输入的时钟信号成为基准。并且，在各磁场测定期间内，按照预先设定的频率，时钟信号从TG70向磁场产生控制部71输入。该频率在各磁场测定期间即连续的2个帧开始信号VD之间，设定为产生磁场的产生线圈39能够循环一周的频率。并且，该频率也预先设定于磁场测定控制部58，基于各产生线圈39的磁场的产生和基于磁场测定控制部58的磁场的测定同步进行。在图9及图10的例中，在各磁场测定期间内，根据从TG70向磁场产生控制部71输入的时钟信号，以相同顺序驱动产生线圈39。图10的“FG”是指产生线圈，“FG”之后的数字表示区分产生线圈39的编号。例如，图10的“FG1”对应于图9的“第1产生线圈”。在图10中，示出各磁场测定期间内的12个产生线圈39的驱动顺序为相同顺序的例。在该例中，各个产生线圈39的驱动周期为恒定。例如，考虑因电源引起的噪声等周期性的噪声对由产生线圈39产生的磁场产生影响的情况。这种情况下，当产生线圈39的驱动周期和噪声的周期几乎形同的情况下，如图11所示，有可能在从特定的产生线圈39产生的磁场上叠加较高的信号电平的噪声。图11的纵轴表示噪声的信号电平，横轴表示时间。并且，图11的圆圈表示特定的产生线圈39进行驱动的时刻。在图11中，示出在从特定的产生线圈39产生的磁场上叠加最大的信号电平的噪声的例。这种情况下，有可能导致在从特定的产生线圈39产生的磁场的测定结果上叠加较大的噪声。因此，若位置检测部72使用包含该磁场的测定结果的磁场测定数据55来检测产生线圈39的位置，则无法精度良好的检测上述特定的产生线圈39的位置。其结果，也无法精度良好的检测内窥镜10的插入部分17的形状。因此，关于本实施方式所涉及的磁场产生控制部71，作为一例，如图12所示，进行使磁场测定期间内的产生线圈39的驱动顺序在多个磁场测定期间之间不同的控制。在本实施方式中，磁场产生控制部71随机确定在各磁场测定期间最初驱动的产生线圈39，并且从该产生线圈39开始按照用于区分产生线圈39的编号顺序驱动产生线圈39。另外，只要磁场测定期间内的产生线圈39的驱动顺序在多个磁场测定期间之间不同，则关于如何不同并没有特别限定。例如，可以随机地使其不同。并且，如上所述，位置检测部72根据将最近的规定数量的磁场测定期间的磁场测定数据55进行平均化而得的磁场测定数据55，检测各检测线圈25的位置。因此，例如，磁场产生控制部71优选在基于位置检测部72的平均化对象的数量的磁场测定期间中，以各产生线圈39的磁场测定期间之间的驱动间隔不成为恒定的驱动顺序驱动各产生线圈39。即，优选在5个磁场测定期间，各产生线圈39的驱动顺序全部不同。在本实施方式中，例如，在导航装置12所具备的非易失性存储器等存储部中，存储有表示按照什么样的规则使产生线圈39的驱动顺序不同的规则信息。然后，磁场产生控制部71根据规则信息，进行使磁场测定期间内的产生线圈39的驱动顺序在多个磁场测定期间之间不同的控制。判别部72A能够根据表示从磁场测定开始起为第几个磁场测定期间的信息和上述规则信息确定前述的对应关系75。在图13中，示出以图12中所示的驱动顺序驱动产生线圈39时的第1帧的对应关系75和第2帧的对应关系75。图13中的“第1产生线圈”～“第12产生线圈”与图12中的“FG1”～“FG12”一对一对应。在图12及图13的例中，判别部72A能够确定如下内容：在第1帧中，磁场测定数据55的最初的磁场测定结果基于由“FG01”产生的磁场，在第2帧中，磁场测定数据55的最初的磁场测定结果基于由“FG12”产生的磁场。＜内窥镜系统的作用＞接着，参考图14，对本实施方式所涉及的内窥镜系统9的作用进行说明。另外，图14是表示观察图像41及插入部分形状图像42的显示处理的一例的流程图。该显示处理例如在将内窥镜系统9的电源开关设为打开的状态，且在内窥镜系统9的各部启动后执行。在图14的步骤S1A中，摄像装置48的成像元件53拍摄通过观察窗47及聚光透镜52而入射的像光。由此，成像元件53将从振荡部53a振荡的基准信号作为基准，将图像信号向总括控制电路50输出。从成像元件53向总括控制电路50输入的图像信号在由总括控制电路50的信号处理部57实施各种信号处理之后，作为帧图像信号61向图像信号输出部59输出。从信号处理部57向图像信号输出部59输出的帧图像信号61在通过图像信号输出部59附加帧开始信号VD之后，向LD36输出。在步骤S2A中，LD36将对从图像信号输出部59输入的帧图像信号61进行光信号化的光信号发送到光源装置11的PD37。在步骤S1B中，光源装置11的PD37接收从LD36发送的光信号。并且，PD37将以光信号的形式接收到的帧图像信号61转换为原来的电信号的形式。基于PD37的转换后的帧图像信号61经由光源控制部64及通信接65向导航装置12输出。在步骤S2B中，图像信号获取部68经由通信接65从光源控制部64获取帧图像信号61，并从所获取到的帧图像信号61提取帧开始信号VD。然后，图像信号获取部68将所提取的帧开始信号VD输出到TG70。在步骤S3B中，TG70根据来自图像信号获取部68的帧开始信号VD，将各产生线圈39的切换控制用时钟信号输出到磁场产生控制部71。在步骤S4B中，磁场产生控制部71根据从TG70输入的时钟信号，使各产生线圈39在不同的时刻驱动。由此，在不同的时刻从各产生线圈39产生磁场。此时，磁场产生控制部71根据前述的规则信息，以作为第1帧规定的顺序使各产生线圈39驱动。通过以上所说明的至步骤S4B为止的处理，内窥镜系统9的启动完成。接着，在步骤S3A中，内窥镜10的插入部分17由执刀医生OP插入受检者H内，开始受检者H内的观察部位的拍摄。从光源装置11的照明光源63供给的照明光通过光导件33及照射透镜45从照明窗46向观察部位射出。在步骤S4A中，成像元件53拍摄通过观察窗47及聚光透镜52而入射的观察部位的像光。由此，成像元件53将从振荡部53a振荡的基准信号作为基准，将图像信号向总括控制电路50输出。从成像元件53向总括控制电路50输入的图像信号在由总括控制电路50的信号处理部57实施各种信号处理之后，作为帧图像信号61向图像信号输出部59输出。在步骤S5A中，磁场测定控制部58根据从振荡部53a振荡的基准信号，以与TG70的时钟信号对应的频率控制磁场检测电路49，并反复获取各检测线圈25所检测到的磁场测定结果。即，磁场测定控制部58与产生线圈39的切换同步地，针对各产生线圈39获取各检测线圈25所检测到的磁场测定结果。然后，磁场测定控制部58将包含所获取到的所有的磁场测定结果的磁场测定数据55与从信号处理部57向图像信号输出部59的帧图像信号61的输出同步地，向图像信号输出部59输出。在步骤S6A中，图像信号输出部59对从信号处理部57输入的帧图像信号61附加帧开始信号VD，且将从磁场测定控制部58输入的磁场测定数据55附加于信号无效区域ND。在步骤S7A中，图像信号输出部59将附加了帧开始信号VD及磁场测定数据55的帧图像信号61向LD36输出。LD36将对从图像信号输出部59输入的帧图像信号61进行光信号化的光信号发送到光源装置11的PD37。步骤S5B～步骤S8B执行与步骤S1B～步骤S4B相同的处理。此时，在步骤S8B中，每当执行步骤S8B时，根据表示为第几帧的信息和前述的规则信息确定产生线圈39的驱动顺序。由此，以每帧不同的驱动顺序驱动产生线圈39。在步骤S9B中，图像信号获取部68提取在步骤S6B中所获取的帧图像信号61中所包含的帧开始信号VD及磁场测定数据55，并将所提取到的帧开始信号VD及磁场测定数据55输出到插入状态检测部69。在步骤S10B中，如上所述，位置检测部72根据从图像信号获取部68输入的帧开始信号VD及磁场测定数据55检测各检测线圈25的位置。此时，如上所述，在每次执行步骤S10B时，根据表示为第几帧的信息和前述的规则信息来确定判别部72A所使用的对应关系75。然后，位置检测部72将表示所检测到的各检测线圈25的位置的线圈位置数据76向插入部分形状检测部73输出。在步骤S11B中，如上所述，插入部分形状检测部73根据从位置检测部72输入的线圈位置数据76，检测在受检者H的体内的插入部分17的形状，并生成插入部分17的形状的插入部分形状数据78。在步骤S12B中，显示输出部74将在步骤S6B中图像信号获取部68获取到的帧图像信号61、及在步骤S11B中插入部分形状检测部73所生成的插入部分形状数据78经由通信接口80A、80B向处理器装置14输出。从显示输出部74向处理器装置14的显示输入部82输入的帧图像信号61及插入部分形状数据78通过显示控制部83向显示器15输出。由此，将基于帧图像信号61的观察图像41和基于插入部分形状数据78的插入部分形状图像42显示于显示器15。以上的步骤S4A～步骤S7A的处理及步骤S5B～步骤S12B的处理直到内窥镜的检查结束为止反复进行。由此，根据预先设定的帧速率，将观察图像41和插入部分形状图像42在显示器15上更新显示。如以上所说明的那样，根据本实施方式，使磁场测定期间内的产生线圈39的驱动顺序在多个磁场测定期间之间不同。因此，作为一例，如图15所示，各产生线圈39的驱动周期并不恒定。图15的纵轴表示噪声的信号电平，横轴表示时间。并且，图15的圆圈表示某1个产生线圈39进行驱动的时刻。由此，由于叠加在从产生线圈39产生的磁场上的噪声的信号电平也不恒定，因此能够抑制较高信号电平的噪声叠加在从特定的产生线圈39产生的磁场。其结果，能够精度良好的检测内窥镜的插入部分的插入状态。另外，在上述实施方式中，对如下情况进行了说明，但并不限定于此：在磁场测定期间内，将从多个检测线圈25获取在各产生线圈39被驱动的单位驱动时间内产生的磁场的测定结果的顺序在各单位驱动时间设为相同。例如，图16所示，磁场测定控制部58也可以为进行如下控制的方式：在磁场测定期间内，使从多个检测线圈25获取在单位驱动时间内产生的磁场的测定结果的顺序在多个单位驱动时间之间不同。该顺序能够根据基于磁场检测电路49的选择器49C的滤波器49B的选择顺序进行控制。由此，对于基于检测线圈25的磁场的测定结果也能够减少周期性噪声的影响，其结果，能够更精度良好的检测内窥镜的插入部分的插入状态。另外，在图16中，示出检测线圈25的数量为6个的情况。这种情况下，例如，例示出在总括控制电路50所具备的非易失性存储器中，存储表示按照什么样的规则使磁场的测定结果的获取顺序不同的信息的方式。并且，这种情况下，通过进一步使用该信息，判别部72A能够确定对应关系75。并且，在上述实施方式中，以在内窥镜10中配置包含磁场测定控制部58的磁场测定部，且在导航装置12中配置磁场产生控制部71的例子进行了说明，但相反地，也可以在内窥镜10中配置磁场产生控制部71，而在导航装置12中配置磁场测定部。并且，在上述实施方式中，对将帧图像信号61中所包含的帧开始信号VD作为同步信号而利用的情况进行了说明，但也可以将除了垂直消隐期间中所包含的信号以外的信号，例如，水平同步信号等用作同步信号。并且，也可以在帧图像信号61的标题信息中埋入同步信号而使用。此外，也可以将与帧图像信号61中所包含的信号不同的信号用作同步信号。这种情况下，成为设置与帧图像信号61不同的发送路径的方式。并且，在上述实施方式中，对在连续的2个帧开始信号VD之间获取包含各产生线圈39和各检测线圈25所有的组合所涉及的磁场测定结果的总磁场测定数据的情况进行了说明，但并不限定于此。例如，也可以在输出3个以上的帧开始信号VD的周期获取总磁场测定数据。总磁场测定数据的获取周期越长，插入部分形状图像42的更新频度越低，但插入部分形状图像42与观察图像41相比不要求高清图像，因此即使与观察图像41相比更新频度低，在插入部分形状图像42的情况下也可以容许。并且，在上述实施方式中，对从内窥镜10相对于光源装置11将帧图像信号61转换为光信号而发送的情况进行了说明，但并不限定于此。例如，也可以是将内窥镜10和光源装置11经由金属制的信号线电连接，并将帧图像信号61直接以电信号的形式从内窥镜10发送到光源装置11的方式。并且，在上述实施方式中，作为内窥镜10，举例说明了在大肠等下部消化管的检查中所使用的内窥镜，但内窥镜10的种类及用途并没有特别限定。也可以为上部消化管用的内窥镜10。并且，尤其以插入部分17的前端位置PT的检测为目的的情况下，不仅柔性内窥镜、在硬性内窥镜中也能够适用本发明的技术。并且，在上述实施方式中，以各产生线圈39产生相同频率的磁场MF的例子进行了说明，但各产生线圈39所产生的磁场MF的频率也可以不同。然而，如上述实施方式的内窥镜系统9那样，当各产生线圈39所产生的磁场MF的频率相同的情况下，多个磁场MF本身无法区分。因此，为了区分多个磁场MF的各个产生源的产生线圈39，只能改变产生时刻。因此，当各产生线圈39所产生的磁场MF的频率相同的情况下，本发明的技术是有效的。并且，在上述实施方式中，具有多个产生线圈39和多个检测线圈25，但检测线圈25至少具有1个即可。例如，可以对使用在插入部分17的前端部23仅设置1个检测线圈25的内窥镜10的内窥镜系统9适用本发明的技术。这种情况下，也能够提示前端部23的当前位置。并且，在上述实施方式中，例如，作为执行磁场测定控制部58及磁场产生控制部71等各种处理的处理部的硬件结构，能够使用以下所示的各种处理器。各种处理器中除了包括通过执行软件来作为各种处理部发挥作用的通用的处理器即CPU以外，还包括FPGA)等在制造后能够变更电路结构的处理器即可编程逻辑器件、或ASIC等具有为了执行特定的处理而以专用设计的电路结构的处理器即专用电路等。一个处理部可以由这些各种处理器中的一个构成，也可以由相同种类或不同种类的两个以上的处理器的组合构成。如此，各种处理部作为硬件结构使用上述各种处理器中的一个以上而构成。换言之，这些处理器与内置于处理器的存储器或所连接的存储器协作而作为各处理部发挥作用。而且，更具体而言，作为这些各种处理器的硬件结构，能够使用组合半导体元件等电路元件而成的电路。根据以上的记载，能够掌握以下附记项所涉及的技术。一种内窥镜系统，其选择性地切换并驱动多个磁场产生元件而产生磁场，并根据基于磁场检测元件的所述磁场的测定结果，检测包含内窥镜的插入部分的位置及形状中的至少一者在内的插入状态，所述内窥镜系统包括：控制处理器，其进行使预先设定的测定单位时间内的所述磁场产生元件的驱动顺序在多个所述测定单位时间之间不同的控制。2019年8月20日申请的日本专利申请2019-150387号的发明的全部内容通过参考援用于本说明书中。并且，本说明书中所记载的所有文献、专利申请及技术标准与具体地且分别地记载通过参考而被并入的各个文献、专利申请及技术标准的情况相同程度地，通过参考被并入本说明书中。
