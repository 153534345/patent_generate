标题title
一种面向时序数据库的查询时间预测方法
摘要abst
一种面向时序数据库的查询时间预测方法，涉及计算机技术领域，针对现有技术中查询时间预测速度慢的问题，包括：步骤一：读取时序数据；步骤二：将时序数据写入CnosDB，CnosDB使用CnoSQL查询语句对时序数据进行查询检索，并记录查询时间；步骤三：将查询语句编码为向量化数据；步骤四：对向量化数据提取数据分布特征；步骤五：使用PCA对数据分布特征进行降维；步骤六：利用向量化数据和降维后的数据分布特征作为输入，查询时间作为输出，训练梯度提升回归树模型；步骤七：利用训练好的梯度提升回归树模型进行查询时间预测。本申请在预测时间上，在上述实验中本模型都能在几十毫秒内给出预测结果，具有非常可观的响应速度。
权利要求书clms
1.一种面向时序数据库的查询时间预测方法，其特征在于包括以下步骤：步骤一：读取时序数据；步骤二：将时序数据写入CnosDB，CnosDB使用CnoSQL查询语句对时序数据进行查询检索，并记录查询时间；步骤三：将查询语句编码为向量化数据；步骤四：对向量化数据提取数据分布特征；步骤五：使用PCA对数据分布特征进行降维；步骤六：利用向量化数据和降维后的数据分布特征作为输入，查询时间作为输出，训练梯度提升回归树模型；步骤七：利用训练好的梯度提升回归树模型进行查询时间预测。2.根据权利要求1所述的一种面向时序数据库的查询时间预测方法，其特征在于所述步骤三之前还包括以下步骤：将CnoSQL重写为标准的SQL。3.根据权利要求2所述的一种面向时序数据库的查询时间预测方法，其特征在于所述步骤三中编码包括join图编码和列信息编码，join图编码和列信息编码的结果连接作为整个查询的编码。4.根据权利要求3所述的一种面向时序数据库的查询时间预测方法，其特征在于所述join图编码的具体步骤为：分析CnoSQL或SQL查询语句中涉及到的参加join的表，分析每两个参加join的表的连接关系，并判断每两个参加join的表之间是否连接，若连接，则将join对应的编码设置为1，若未连接，则将join对应的编码设置为0，最后保留二维矩阵的上三角矩阵部分，并按行展开为一维矩阵。5.根据权利要求4所述的一种面向时序数据库的查询时间预测方法，其特征在于所述列信息编码的具体步骤为：针对每个参加join的表，将每个参加join的表中参与查询谓词的编码列设置为1，将每个参加join的表中未参与查询谓词的编码列设置为0，将设置为1的列和设置为0的列连接，得到查询编码。6.根据权利要求5所述的一种面向时序数据库的查询时间预测方法，其特征在于所述列信息编码通过one-hot编码方式进行。
说明书desc
技术领域本发明涉及计算机技术领域，具体为一种面向时序数据库的查询时间预测方法。背景技术查询时间预测是数据库领域中准入控制、查询优化、查询调度等多个热点问题的技术基础。比如，在数据库优化中，优化的主要目标是查询响应时间和空间利用率两点，因此，查询的执行时间将作为重要的反馈指标，指示优化结果的优劣。但是实际使用中，如果对查询负载在物理上执行查询，得到真实的执行时间，会给优化过程带来不可接受的代价，因为负载往往要反复的执行成百上千轮。目前，查询时间预测方向的相关研究已经比较成熟。总的来说，目前数据库上的查询时间预测技术有两种方案：一种是在查询计划层面对查询进行编码，另一种是在物理操作符层面对查询进行编码。查询计划层面的编码粒度较低，预测效果较依赖于训练集和测试集的特征相似性，对未知查询的预测效果较差，而物理操作符层面的编码，通常利用查询树的深度优先遍历，得到操作符的序列，从而可以提取出查询树中的结构特征，编码的粒度更高，在应对未知的查询上，预测效果相对查询计划层面较好，但是在与训练集相似特征的测试查询的预测速度慢。发明内容本发明的目的是：针对现有技术中查询时间预测速度慢的问题，提出一种面向时序数据库的查询时间预测方法。本发明为了解决上述技术问题采取的技术方案是：一种面向时序数据库的查询时间预测方法，包括以下步骤：步骤一：读取时序数据；步骤二：将时序数据写入CnosDB，CnosDB使用CnoSQL查询语句对时序数据进行查询检索，并记录查询时间；步骤三：将查询语句编码为向量化数据；步骤四：对向量化数据提取数据分布特征；步骤五：使用PCA对数据分布特征进行降维；步骤六：利用向量化数据和降维后的数据分布特征作为输入，查询时间作为输出，训练梯度提升回归树模型；步骤七：利用训练好的梯度提升回归树模型进行查询时间预测。进一步的，所述步骤三之前还包括以下步骤：将CnoSQL重写为标准的SQL。进一步的，所述步骤三中编码包括join图编码和列信息编码，join图编码和列信息编码的结果连接作为整个查询的编码。进一步的，所述join图编码的具体步骤为：分析CnoSQL或SQL查询语句中涉及到的参加join的表，分析每两个参加join的表的连接关系，并判断每两个参加join的表之间是否连接，若连接，则将join对应的编码设置为1，若未连接，则将join对应的编码设置为0，最后保留二维矩阵的上三角矩阵部分，并按行展开为一维矩阵。进一步的，所述列信息编码的具体步骤为：针对每个参加join的表，将每个参加join的表中参与查询谓词的编码列设置为1，将每个参加join的表中未参与查询谓词的编码列设置为0，将设置为1的列和设置为0的列连接，得到查询编码。进一步的，所述列信息编码通过one-hot编码方式进行。本发明的有益效果是：本申请使用NYSE网站上2016年10月24日纽约交易所的股票交易数据生成了Quotes_Big表，对其上常用的11种查询进行了测试，应用本申请的方法，在数据库的数据规模不发生弹性变化的情况下，查询预测回归模型的可决系数可以达到0.996以上，平均绝对百分比误差可以达到17％以内，在数据库的数据规模在20％的范围内发生弹性变化时，查询预测回归模型的可决系数可以达到0.971以上，平均绝对百分比误差可以达到19％以内。此外，在预测时间上，在上述实验中本模型都能在几十毫秒内给出预测结果，具有非常可观的响应速度。附图说明图1为CnoSQL重写为标准的SQL示意图；图2为上半区压缩成一维编码的序列示意图；图3为本申请的整体流程示意图。具体实施方式需要特别说明的是，在不冲突的情况下，本申请公开的各个实施方式之间可以相互组合。具体实施方式一：参照图3具体说明本实施方式，本实施方式所述的一种面向时序数据库的查询时间预测方法，包括以下步骤：步骤一：读取时序数据；步骤二：将时序数据写入CnosDB，CnosDB使用CnoSQL查询语句对时序数据进行查询检索，并记录查询时间；步骤三：将查询语句编码为向量化数据；步骤四：对向量化数据提取数据分布特征；步骤五：使用PCA对数据分布特征进行降维；步骤六：利用向量化数据和降维后的数据分布特征作为输入，查询时间作为输出，训练梯度提升回归树模型；步骤七：利用训练好的梯度提升回归树模型进行查询时间预测。具体实施方式二：本实施方式是对具体实施方式一的进一步说明，本实施方式与具体实施方式一的区别是所述步骤三之前还包括以下步骤：将CnoSQL重写为标准的SQL。具体实施方式三：本实施方式是对具体实施方式二的进一步说明，本实施方式与具体实施方式二的区别是所述步骤三中编码包括join图编码和列信息编码，join图编码和列信息编码的结果连接作为整个查询的编码。具体实施方式四：本实施方式是对具体实施方式三的进一步说明，本实施方式与具体实施方式三的区别是所述join图编码的具体步骤为：分析CnoSQL或SQL查询语句中涉及到的参加join的表，分析每两个参加join的表的连接关系，并判断每两个参加join的表之间是否连接，若连接，则将join对应的编码设置为1，若未连接，则将join对应的编码设置为0，最后保留二维矩阵的上三角矩阵部分，并按行展开为一维矩阵。具体实施方式五：本实施方式是对具体实施方式四的进一步说明，本实施方式与具体实施方式四的区别是所述列信息编码的具体步骤为：针对每个参加join的表，将每个参加join的表中参与查询谓词的编码列设置为1，将每个参加join的表中未参与查询谓词的编码列设置为0，将设置为1的列和设置为0的列连接，得到查询编码。具体实施方式六：本实施方式是对具体实施方式五的进一步说明，本实施方式与具体实施方式五的区别是所述列信息编码通过one-hot编码方式进行。时间序列数据，简称为时序数据，是指在一段时间内由固定的采集设备按照固定的时间间隔采集到的数据点的序列，每个数据点都关联着一个时间戳，表明采集的时间。通过分析一段时间的时序数据，可以获得事务在一段时间内的发展趋势，从而实现对未来的预测。时序数据本身特点明显，数据结构固定，写入间隔固定，写入量大，原始数据空间占用大，每次查询获取的时间范围广，对更新操作需求少，对单点查询需要少。这些特点导致，传统的关系型数据库对时序数据的支持并不佳。为了时序数据做特别优化的数据库被称为时序数据库。本申请提出的特征化编码方案，在查询工作负载密集的业务需求下，达到快速且准确的查询时间预测目标。对应于关系数据库的SQL查询，CnosDB使用CnoSQL查询语言对时序数据进行查询检索。在实际进行预测时，首先将CnoSQL重写为标准的SQL，如图1所示。为了使用算法对查询时间进行预测，首先需要对查询语句进行编码。本发明对CnosDB时序数据库的查询语句进行特征化编码，主要从查询级别进行解析和编码，分为两个主要部分：join图编码和列信息编码，两项编码的结果连接作为整个查询的编码。Join图编码是指，分析整个SQL查询中涉及到的参加join的表，分析其连接关系，依次判断两两之间是否需要连接，在二维矩阵中将需要连接的设置为1。考虑到需要连接为双向关系，二维矩阵只需要保留一半，并压缩为一维矩阵用于后续编码。如图所示，A和B，B和D，A和C之间存在连接，即在二维数组中置1，将上半区压缩成一维编码得到如图2所示的序列.列信息编码则是指，对于每一个表，将其参与查询谓词的列设置为1，此处采用了one-hot编码方式进行编码，即对于有n个列的表，用n位数表示其每个列参与查询谓词的情况，为1表示其参与到查询谓词中，为0则表示不参与。二者连接即可得到最终的查询编码为了使特征化编码能够适应实际业务中的数据库数据规模的弹性变化，还需要提取数据分布特征。为此，假设数据规模在一定的业务范围内存在一个上限值，该上限制根据实际业务需求凭经验人为设置。我们记数据分布的特征编码长度等于表数目，特征向量的索引和表序号对应，编码位的取值为当前表数据条目与表数据条目上限的比值。并把该数据分布特征向量拼接到查询特征向量之前。在对查询和数据分布做特征化编码后，还需要对数据矩阵进行PCA降维。由于实际业务中的查询负载通常不能覆盖所有时序数据中的Tag，也就会有些关系表并没有使用到，因此数据矩阵中会存储在大量零值，较为稀疏。PCA降维处理可以有效去除数据矩阵的冗余分量，加速模型回归速度，提高准确率。最后，用这些训练数据训练梯度提升回归树模型，从而可以利用该模型，对查询进行准确快速的时间预测。需要注意的是，具体实施方式仅仅是对本发明技术方案的解释和说明，不能以此限定权利保护范围。凡根据本发明权利要求书和说明书所做的仅仅是局部改变的，仍应落入本发明的保护范围内。
