标题title
一种基于通讯协议的充电桩漏洞检测方法及检测装置
摘要abst
本发明提供了一种基于通讯协议的充电桩漏洞检测方法，包括：将检测装置与充电桩相连接、确定相应的波特率、选择检测装置的运行模式：所述运行模式包括普通转发模式和中间人攻击模式；填入能源汽车的VIN码、运行检测系统；即插即用电动汽车充电自动支付功能的安全性而发明。通过报文劫持伪造方式，利用GB/T27930‑2015协议明文传输及绑定VIN码，将绑定即插即充功能VIN码账号转发至直流充电桩支付平台验证，通过模拟盗刷检测充电桩上是否存在GB/T27930‑2015协议漏洞，从而便于对漏洞进行修复。
权利要求书clms
1.一种基于通讯协议的充电桩漏洞检测方法，其特征在于，包括：S1、将充电桩充电接口接入检测装置，检测装置再与新能源汽车充电接口连接；S2、确定相应的波特率：如果数据不压缩，所述波特率等于每秒钟传输的数据位数；如果数据进行压缩，那么每秒钟传输的数据位数大于调制速率，使得交换使用的波特和比特/秒偶尔会产生错误；CAN总线协议包的抓包、解析、伪造、重发，都在同一个所述波特率下通讯；S3、选择检测装置的运行模式：所述运行模式包括普通转发模式和中间人攻击模式；S4、填入能源汽车的VIN码：如果所述VIN码输入不符合规则，通过警报中止检测；如果所述VIN码输入符合规则，则进行下一个步骤；S5、运行检测系统：检测所述检测系统中线缆的CAN0的CAN_H和CAN_L，CAN1的CAN_H和CAN_L与2-CH CANHAT扩展版的CAN0的CAN_H和CAN_L，CAN1的CAN_H和CAN_L对应连接；打开软件，选择所述波特率、所述运行模式；若是所述普通转发模式就直接点击开始；若是所述中间人攻击模式，填入17位VIN码，点击开始；将开通了即插即用的新能源汽车的VIN码，输入到装置对应界面中，依靠程序生产篡改报文数据的VIN-CHEAT码；当未开通即插即用的新能源汽车，利用装置充电时，篡改报文数据的VIN-CHEAT码，按照报文格式发送给充电桩，绕过认证，实现免费的即插即用充电；S6、根据检测装置是否显示充电成功，确定是否存在漏洞问题。2.根据权利要求1所述的一种基于通讯协议的充电桩漏洞检测方法，其特征在于，所述步骤S6中，确定是否存在漏洞，包括以下步骤：S61、打开树莓派终端，输入指令进入配置界面；S62、开启SPI接口；S63、重启树莓派：在/boot/config.txt中间检查，以确保SPI没有被其它的设备占用；S64、修改脚本config.txt：将2-CH CAN HAT模块插在树莓派上，然后修改开机脚本config.txt；S65、重启树莓派以应用所有设置；S66、待树莓派重启后，查看SPI信息；S67、开启CAN，查看ifconfig；S68、IM7600模组通过USB口连接到树莓派上，然后执行指令，如果能正常识别到ttyUSB2，通过minicom打开该端口；通过minicom发送指令，然后等待模组重启；S69、ifconfig查看是否有识别出一个usb0的网卡，获取ip地址，测试下通过usb0无线网卡ping百度能否正常联网；S610、将UPSPackV3模块与树莓派4B的IO口连接，通电后，在树莓派4B进行UART配置，配置完毕后交换串口0和串口1的指向，下载基于Python3的功能脚本，设置为开机启动；S611、在终端使用ls-l/dev查看串口设备的指向关系；S612、利用sudo raspi-config进行uart的配置。3.根据权利要求2所述的一种基于通讯协议的充电桩漏洞检测方法，其特征在于，所述S612中，进行uart的配置，包括以下步骤：选Interfacing Options-＞Serial-＞No-＞Yes-＞显示小节然后回到主界面-＞利用TAB键-＞选到Finish-＞重启选Ye；重启之后，利用ls-l/dev再次查看串口设备的指向关系；利用dtoverlay，把串口0和串口1的指向进行交换首先查看下/boot/overlays，确认有一个叫pi3-miniuart-bt.dtbo的文件；命令行打入sudo nano/boot/config.txt，在文件的最后加入：pi3-miniuart-bt；再次用ls-l/dev，查看串口0和串口1的指向关系，以查看serial0-＞ttyAMA0这个指向为UPS python程序。4.根据权利要求1所述的一种基于通讯协议的充电桩漏洞检测方法，其特征在于：所述步骤S5中，当检测开始后，检测装置会将充电桩发送给BMS的协议包，全部不改动的实时转发给BMS；同时，检测装置会逐帧的检测BMS发往充电桩的协议包，当出现帧ID为0x180256F4,将VIN-CHEAT码直接填入其数据部分的BYTE24-BYTE40,其他部分保持不变，发送给充电桩。5.一种基于通讯协议的充电桩漏洞检测装置能够实现如权利要求1至3中任一项所述的方法，其特征在于：包括2-CH CAN HAT扩展版，所述2-CH CAN HAT扩展版按照2x20针的GPIO接入树莓派4B，所述树莓派4B通过USB连接4GDONGLE通讯模块。6.根据权利要求5所述的一种基于通讯协议的充电桩漏洞检测装置，其特征在于：所述树莓派4B通过UART与电源模块相连接；所述树莓派4B通过I2C与双通道串口相通讯；所述树莓派4B通过HDMI与7寸IPS屏相连。7.根据权利要求6所述的一种基于通讯协议的充电桩漏洞检测装置，其特征在于：所述树莓派4B安装Raspberry PiOS with desktop系统和BCM2835、wiringPi及Python3函数库；所述双通道串口输出TTL电平信号，并将所述TTL电平信号转换成RS232。8.根据权利要求7所述的一种基于通讯协议的充电桩漏洞检测装置，其特征在于：所述2-CH CAN HAT扩展版的CAN模块能够处理所有CAN总线上的报文接收和发送；报文发送时，将报文装载到正确的报文缓冲器和控制寄存器中，通过SPI接口设置所述控制寄存器中的相应位或使用发送使能引脚均能启动发送操作；通过读取相应的所述控制寄存器能够检查通讯状态和错误；对在CAN总线上检测到的任何报文进行错误检查，与用户定义的滤波器进行匹配，以确定是否将报文移到两个接收缓冲器中的一个。
说明书desc
技术领域本发明涉及工控安全领域，尤其涉及一种基于通讯协议的充电桩漏洞检测方法及检测装置。背景技术随着新能源汽车普及，电动汽车充电桩也随之得以发展。电动汽车充电桩属于物联网设备，通常具有内置的系统和操作接口，其攻击面涉及硬件、系统、云服务和通信。通信协议是充电桩与电动车“即插即用”的依据。通讯协议一部分自建充电桩的厂商，如特斯拉，使用其自己的私有通信协议和认证协议；一部分公共站点运营商则会根据GB/T-27930标准使用汽车的VIN来完成汽车的认证。“即插即用”是电动汽车充电自动支付的一种新方式。用户无需刷卡或扫描代码，只需将充电桩连接到车辆充电端口，即可自动完成身份认证和支付。充电通信主要涉及电池管理系统和充电器，双方就车辆的功率要求以及充电过程中使用的安培数和电压达成一致，并监测充电过程。目前已知，“即插即用”是电动汽车充电自动支付的一种新方式。用户无需刷卡或扫描代码，只需将充电桩连接到车辆充电端口，即可自动完成身份认证和支付。该功能中涉及的GB/T-27930-2015协议传输存在明文、无认证的问题，其中的关键信息即VIN码也能容易获得。了解到目前我国直流充电桩体与电动汽车使用GB/T27930-2015协议通讯超过了90％以上，“即插即充”功能也在快速覆盖，代表说全国大部分充电桩都存在此漏洞并可以被利用。发明内容本发明的目的在于针对上述现有技术的不足，提供了一种基于通讯协议的充电桩漏洞检测方法及检测装置，检测充电桩上是否存在协议漏洞，以便于对漏洞进行修复。为实现上述目的，本发明采用了如下技术方案：本发明提供了一种基于通讯协议的充电桩漏洞检测方法，包括：S1、将充电桩充电接口接入检测装置，检测装置再与新能源汽车充电接口连接；S2、确定相应的波特率：如果数据不压缩，所述波特率等于每秒钟传输的数据位数；如果数据进行压缩，那么每秒钟传输的数据位数大于调制速率，使得交换使用的波特和比特/秒偶尔会产生错误；CAN总线协议包的抓包、解析、伪造、重发，都在同一个所述波特率下通讯；S3、选择检测装置的运行模式：所述运行模式包括普通转发模式和中间人攻击模式；S4、填入能源汽车的VIN码：如果所述VIN码输入不符合规则，通过警报中止检测；如果所述VIN码输入符合规则，则进行下一个步骤；S5、运行检测系统：检测所述检测系统中线缆的CAN0的CAN_H和CAN_L，CAN1的CAN_H和CAN_L与2-CHCAN HAT扩展版的CAN0的CAN_H和CAN_L，CAN1的CAN_H和CAN_L对应连接；打开软件，选择所述波特率、所述运行模式；若是所述普通转发模式就直接点击开始；若是所述中间人攻击模式，填入17位VIN码，点击开始；将开通了即插即用的新能源汽车的VIN码，输入到装置对应界面中，依靠程序生产篡改报文数据的VIN-CHEAT码；当未开通即插即用的新能源汽车，利用装置充电时，篡改报文数据的VIN-CHEAT码，按照报文格式发送给充电桩，绕过认证，实现免费的即插即用充电；S6、根据检测装置是否显示充电成功，确定是否存在漏洞问题。进一步，所述步骤S6中，确定是否存在漏洞，包括以下步骤：S61、打开树莓派终端，输入指令进入配置界面；S62、开启SPI接口；S63、重启树莓派：在/boot/config.txt中间检查，以确保SPI没有被其它的设备占用；S64、修改脚本config.txt：将2-CH CAN HAT模块插在树莓派上，然后修改开机脚本config.txt；S65、重启树莓派以应用所有设置；S66、待树莓派重启后，查看SPI信息；S67、开启CAN，查看ifconfig；S68、IM7600模组通过USB口连接到树莓派上，然后执行指令，如果能正常识别到ttyUSB2，通过minicom打开该端口；通过minicom发送指令，然后等待模组重启；S69、ifconfig查看是否有识别出一个usb0的网卡，获取ip地址，测试下通过usb0无线网卡ping百度能否正常联网；S610、将UPSPackV3模块与树莓派4B的IO口连接，通电后，在树莓派4B进行UART配置，配置完毕后交换串口0和串口1的指向，下载基于Python3的功能脚本，设置为开机启动；S611、在终端使用ls-l/dev查看串口设备的指向关系；S612、利用sudo raspi-config进行uart的配置。进一步，所述S612中，进行uart的配置，包括以下步骤：选Interfacing Options-＞Serial-＞No-＞Yes-＞显示小节然后回到主界面-＞利用TAB键-＞选到Finish-＞重启选Ye；重启之后，利用ls-l/dev再次查看串口设备的指向关系；利用dtoverlay，把串口0和串口1的指向进行交换首先查看下/boot/overlays，确认有一个叫pi3-miniuart-bt.dtbo的文件；命令行打入sudo nano/boot/config.txt，在文件的最后加入：pi3-miniuart-bt；再次用ls-l/dev，查看串口0和串口1的指向关系，以查看serial0-＞ttyAMA0这个指向为UPS python程序。进一步，所述步骤S5中，当检测开始后，检测装置会将充电桩发送给BMS的协议包，全部不改动的实时转发给BMS；同时，检测装置会逐帧的检测BMS发往充电桩的协议包，当出现帧ID为0x180256F4,将VIN-CHEAT码直接填入其数据部分的BYTE24-BYTE40,其他部分保持不变，发送给充电桩。本发明提供一种基于通讯协议的充电桩漏洞检测装置，包括2-CH CAN HAT扩展版，所述2-CH CAN HAT扩展版按照2x20针的GPIO接入树莓派4B，所述树莓派4B2通过USB连接4GDONGLE通讯模块。所述树莓派4B2通过UART与电源模块4相连接；所述树莓派4B2通过I2C与双通道串口5相通讯；所述树莓派4B2通过HDMI与7寸IPS屏6相连。所述树莓派4B2安装Raspberry Pi OS with desktop系统和BCM2835、wiringPi及Python3函数库；所述双通道串口5输出TTL电平信号，并将所述TTL电平信号转换成RS232。所述2-CH CAN HAT扩展版1的CAN模块能够处理所有CAN总线上的报文接收和发送；报文发送时，将报文装载到正确的报文缓冲器和控制寄存器中，通过SPI接口设置所述控制寄存器中的相应位或使用发送使能引脚均能启动发送操作；通过读取相应的所述控制寄存器能够检查通讯状态和错误；对在CAN总线上检测到的任何报文进行错误检查，与用户定义的滤波器进行匹配，以确定是否将报文移到两个接收缓冲器中的一个。本发明的有益效果为：“即插即用”电动汽车充电自动支付功能的安全性而发明。通过报文劫持伪造方式，利用GB/T27930-2015协议明文传输及绑定VIN码，将绑定“即插即充”功能VIN码账号转发至直流充电桩支付平台验证，通过模拟盗刷检测充电桩上是否存在GB/T27930-2015协议漏洞，从而便于对漏洞进行修复。附图说明图1为本发明一种基于通讯协议的充电桩漏洞检测方法的程序流程图；图2为本发明一种基于通讯协议的充电桩漏洞检测装置的系统架构图。具体实施方式为了使本发明的目的、技术方案及优点更加清楚明白，下面结合附图，对本发明进行进一步详细说明。应当理解，此处所描述的具体实施例仅用以解释本发明，并不用于限定本发明。请参阅图1，一种基于通讯协议的充电桩漏洞检测方法，包括：S1、将充电桩充电接口接入检测装置，检测装置再与新能源汽车充电接口连接；其中，检测装置包括操作界面和显示界面和检测系统。S2、确定相应的波特率：如果数据不压缩，所述波特率等于每秒钟传输的数据位数；如果数据进行压缩，那么每秒钟传输的数据位数大于调制速率，使得交换使用的波特和比特/秒偶尔会产生错误；CAN总线协议包的抓包、解析、伪造、重发，都在同一个所述波特率下通讯；其中，波特率是传输通道频宽的指标。目前，在现场测试中发现，由于生产厂家不同，CAN总线的波特率设置的并不相同。本检测方法进行CAN总线协议包的抓包、解析、伪造、重发，需要在同一个波特率下才能做到通讯。S3、选择检测装置的运行模式：所述运行模式包括普通转发模式和中间人攻击模式；其中，普通转发模式不仅会对由充电桩到电动汽车BMS、电动汽车BMS到充电桩的CAN总线协议包进行抓取转发，还会将CAN总线协议包进行记录，便于后期对于协议的解析；中间人攻击模式，不仅会对由充电桩到电动汽车BMS、电动汽车BMS到充电桩的CAN总线协议包进行抓取转发，还会将CAN总线协议包中由电动汽车BMS发送给充电桩的含有VIN码的报文进行拦截，进行篡改后，重放给充电桩，以达到“欺骗”充电桩，绕过认证，实现“即插即用”的充电；本发明正是采用了中间人攻击模式作为基础方案，围绕其进行了软硬件的组建及设计。目标为充电桩与新能源汽车“即插即用”功能安全性测试，其使用通讯方式为CAN总线通讯，GB/T-27930-2015协议传输。S4、填入能源汽车的VIN码：如果所述VIN码输入不符合规则，通过警报中止检测；如果所述VIN码输入符合规则，则进行下一个步骤；S5、运行检测系统：检测所述检测系统中线缆的CAN0的CAN_H和CAN_L，CAN1的CAN_H和CAN_L与2-CHCAN HAT扩展版的CAN0的CAN_H和CAN_L，CAN1的CAN_H和CAN_L对应连接；打开软件，选择所述波特率、所述运行模式；若是所述普通转发模式就直接点击开始；若是所述中间人攻击模式，填入17位VIN码，点击开始；将开通了即插即用的新能源汽车的VIN码，输入到装置对应界面中，依靠程序生产篡改报文数据的VIN-CHEAT码；当未开通即插即用的新能源汽车，利用装置充电时，篡改报文数据的VIN-CHEAT码，按照报文格式发送给充电桩，绕过认证，实现免费的即插即用充电；所述步骤S5中，当检测开始后，检测装置会将充电桩发送给BMS的协议包，全部不改动的实时转发给BMS；同时，检测装置会逐帧的检测BMS发往充电桩的协议包，当出现帧ID为0x180256F4,将VIN-CHEAT码直接填入其数据部分的BYTE24-BYTE40,其他部分保持不变，发送给充电桩。S6、根据检测装置是否显示充电成功，确定是否存在漏洞问题。所述步骤S6中，确定是否存在漏洞，包括以下步骤：S61、打开树莓派终端，输入指令进入配置界面；S62、开启SPI接口；S63、重启树莓派：在/boot/config.txt中间检查，以确保SPI没有被其它的设备占用；S64、修改脚本config.txt：将2-CH CAN HAT模块插在树莓派上，然后修改开机脚本config.txt；S65、重启树莓派以应用所有设置；S66、待树莓派重启后，查看SPI信息；S67、开启CAN，查看ifconfig；S68、IM7600模组通过USB口连接到树莓派上，然后执行指令，如果能正常识别到ttyUSB2，通过minicom打开该端口；通过minicom发送指令，然后等待模组重启；S69、ifconfig查看是否有识别出一个usb0的网卡，获取ip地址，测试下通过usb0无线网卡ping百度能否正常联网；S610、将UPSPackV3模块与树莓派4B的IO口连接，通电后，在树莓派4B进行UART配置，配置完毕后交换串口0和串口1的指向，下载基于Python3的功能脚本，设置为开机启动；S611、在终端使用ls-l/dev查看串口设备的指向关系；S612、利用sudo raspi-config进行uart的配置。所述步骤S612中，进行uart的配置，包括以下步骤：选Interfacing Options-＞Serial-＞No-＞Yes-＞显示小节然后回到主界面-＞利用TAB键-＞选到Finish-＞重启选Ye；重启之后，利用ls-l/dev再次查看串口设备的指向关系；利用dtoverlay，把串口0和串口1的指向进行交换首先查看下/boot/overlays，确认有一个叫pi3-miniuart-bt.dtbo的文件；命令行打入sudo nano/boot/config.txt，在文件的最后加入：pi3-miniuart-bt；再次用ls-l/dev，查看串口0和串口1的指向关系，以查看serial0-＞ttyAMA0这个指向为UPS python程序。请参阅图2，一种基于通讯协议的充电桩漏洞检测装置：包括2-CH CAN HAT扩展版1，所述2-CH CAN HAT扩展版1按照2x20针的GPIO接入树莓派4B2，所述树莓派4B2通过USB连接4GDONGLE通讯模块3。其中，树莓派4B2为8G、SD卡、32G，不具备CAN总线通讯功能。2-CH CAN HAT扩展版1双通道隔离CAN线开发版，这是一款专为树莓派设计的2通道CAN总线扩展HAT，支撑CAN2.0，具有多种板载保电路，抗干扰能力强，运行稳定。4G通讯模块3为SIM7600CE-CNSE 4G DONGLE，一款工业级4G上网模块，全网通，支持高达150Mbps下行速率和50Mbps上行速率，支持Windows/Linux/Android等操作系统，可适用于PC、树莓派、无人机、工控机或其他需要4G联网的工业或物联网设备中，可以通过4GDONGLE连接笔记本、树莓派或其他工控主机，随时随地通过4G进行上网。所述树莓派4B2通过UART与电源模块4相连接；所述树莓派4B2通过I2C与双通道串口5相通讯；其中，电源模块4为UPSPack板载电池接口为PH2.0封装；产品提供了3种不同容量的电池可供客户选择。客户亦可自行接入不同容量：标准电压为3.7V的锂聚合物软包电池，或者是3.7V 18650电池组。所述树莓派4B2通过HDMI与7寸IPS屏6相连。所述树莓派4B2安装Raspberry Pi OS with desktop系统和BCM2835、wiringPi及Python3函数库；所述双通道串口5输出TTL电平信号，并将所述TTL电平信号转换成RS232。所述2-CH CAN HAT扩展版1的CAN模块能够处理所有CAN总线上的报文接收和发送；报文发送时，将报文装载到正确的报文缓冲器和控制寄存器中，通过SPI接口设置所述控制寄存器中的相应位或使用发送使能引脚均能启动发送操作；通过读取相应的所述控制寄存器能够检查通讯状态和错误；对在CAN总线上检测到的任何报文进行错误检查，与用户定义的滤波器进行匹配，以确定是否将报文移到两个接收缓冲器中的一个。以上所述实施例仅表达了本发明的实施方式，其描述较为具体和详细，但并不能因此而理解为对本发明专利范围的限制。应当指出的是，对于本领域的普通技术人员来说，在不脱离本发明构思的前提下，还可以做出若干变形和改进，这些都属于本发明的保护范围。因此，本发明专利的保护范围应以所附权利要求为准。
