标题title
一种基于嵌入式的FATFS文件系统
摘要abst
本发明公开一种基于嵌入式的FATFS文件系统，包括设置在内部FLASH的配置区和设置在外部FLASH的数据区，配置区包括引导区、FAT区和目录区，内部FLASH和外部FLASH统一使用逻辑地址进行管理。采用本申请技术方案，对于基于FATFS文件系统结构的区域的读写访问更加节省时间，从而加快整个业务层面的处理时间。
权利要求书clms
1.一种基于嵌入式的FATFS文件系统，其特征在于，包括设置在内部FLASH的配置区和设置在外部FLASH的数据区，配置区包括引导区、FAT区和目录区，内部FLASH和外部FLASH统一使用逻辑地址进行管理。2.如权利要求1所述的基于嵌入式的FATFS文件系统，其特征在于，FAT区只包括FAT1区，内部FLASH和外部FLASH进行统一掉电管理，使用内部FLASH的备份区进行数据备份。3.如权利要求2所述的基于嵌入式的FATFS文件系统，其特征在于，响应于正常写操作命令，从写操作命令中获取写地址；判断写地址所对应的写操作区域：如果是对内部FLASH的配置区的写操作，则查找地址映射表，通过地址对应映射方式，将写地址所对应的配置区地址映射到内部FLASH对应大小的地址处，将配置区数据写入到内部FLASH备份区进行备份，然后将写操作中的待写入数据写入到内部FLASH的真实地址，写入成功则丢弃内部FLASH备份区的对应内容；如果是对外部FLASH的数据区的写操作，则将外部FLASH地址数据写入内部FLASH备份区，将数据写入到外部FLASH的真实地址，写入成功则丢弃内部FLASH备份区的对应内容。4.如权利要求3所述的基于嵌入式的FATFS文件系统，其特征在于，统一掉电管理，具体为：上电检测内部FLASH备份区中是否有配置区或数据区的数据，如果有，则将内部FLASH备份区中配置区的数据恢复到内部FLASH的配置区对应位置，或将内部FLASH备份区中数据区的数据恢复到外部FLASH的数据区对应位置。5.如权利要求2所述的基于嵌入式的FATFS文件系统，其特征在于，响应于正常读操作命令，从读操作命令中获取读地址；判断读地址所对应的读操作区域：如果是对内部FLASH的配置区的读操作，则查找地址映射表，通过地址对应映射方式，将读地址所对应的配置区地址映射到内部FLASH对应大小的地址处，读出对应的数据；如果是对外部FLASH的数据区的读操作，则直接调用外部FLASH的读操作，从外部FLASH的数据区读出对应的数据。6.如权利要求1所述的基于嵌入式的FATFS文件系统，其特征在于，FAT区包括FAT1区和FAT2区，FAT1区和FAT2区互为备份。7.如权利要求6所述的基于嵌入式的FATFS文件系统，其特征在于，响应于正常写操作命令，从写操作命令中获取写地址；判断写地址所对应的写操作区域：如果是对内部FLASH的配置区的写操作，则查找地址映射表，通过地址对应映射方式，将写地址所对应的配置区地址映射到内部FLASH对应大小的地址处，将配置区数据写入到FAT2区进行备份，然后将写操作中的待写入数据写入到内部FLASH的真实地址，写入成功则丢弃FAT2区的对应内容；如果是对外部FLASH的数据区的写操作，则将写命令中的数据写入外部FLASH数据区中，然后更新FAT1区数据，再对应更新FAT2区数据。8.如权利要求7所述的基于嵌入式的FATFS文件系统，其特征在于，内部FLASH的掉电保护具体为：上电，检测FAT1区和FAT2区中的数据是否一致，如果一致则数据写成功，如果不一致，检测FAT1区和FAT2区数据的合法性，若FAT1区数据合法，则根据FAT1区数据更新FAT2区，若FAT2区数据合法，则根据FAT2区数据更新FAT1区。9.如权利要求6所述的基于嵌入式的FATFS文件系统，其特征在于，响应于正常读操作命令，从读操作命令中获取读地址；判断读地址所对应的读操作区域：如果是对内部FLASH的配置区的读操作，则查找地址映射表，通过地址对应映射方式，将读地址所对应的配置区地址映射到内部FLASH对应大小的地址处，读出对应的数据；如果是对外部FLASH的数据区的读操作，则直接调用外部FLASH的读操作，从外部FLASH的数据区读出对应的数据。10.一种计算机可读存储介质，其特征在于，包括外部FLASH和内部FLASH，用于存储如权利要求1-9任一项所述的基于嵌入式的FATFS文件系统，具体包括在外部FLASH中存储FATFS文件系统中的数据区，在内部FLASH中存储FATFS文件系统中的配置区。
说明书desc
技术领域本发明涉及数据存储领域，尤其涉及一种基于嵌入式的FATFS文件系统。背景技术现有的嵌入式系统中，对于文件系统方面的处理，为了节省空间，很多使用FATFS文件系统结构。此文件系统结构在原有的FAT32文件系统结构的基础上，针对嵌入式的使用场景和需求，进行精简后的一种文件系统结构。现有技术中，FATFS文件系统一般使用在外部FLASH上，进行管理外部FLASH区域。对于外部FLASH而言，访问速度一般通过SPI或者I2C接口协议驱动，访问速度与内部CPU与内部FLASH的访问速度相比比较慢。而有一些使用场景中，需要对于交易处理过程的时间，有具体的时间要求，全部在外部进行FLASH的访问处理，速度无法满足要求。发明内容本发明提供了一种基于嵌入式的FATFS文件系统，包括设置在内部FLASH的配置区和设置在外部FLASH的数据区，配置区包括引导区、FAT区和目录区，内部FLASH和外部FLASH统一使用逻辑地址进行管理。如上所述的基于嵌入式的FATFS文件系统，其中，FAT区只包括FAT1区，内部FLASH和外部FLASH进行统一掉电管理，使用内部FLASH的备份区进行数据备份。如上所述的基于嵌入式的FATFS文件系统，其中，响应于正常写操作命令，从写操作命令中获取写地址；判断写地址所对应的写操作区域：如果是对内部FLASH的配置区的写操作，则查找地址映射表，通过地址对应映射方式，将写地址所对应的配置区地址映射到内部FLASH对应大小的地址处，将配置区数据写入到内部FLASH备份区进行备份，然后将写操作中的待写入数据写入到内部FLASH的真实地址，写入成功则丢弃内部FLASH备份区的对应内容；如果是对外部FLASH的数据区的写操作，则将外部FLASH地址数据写入内部FLASH备份区，将数据写入到外部FLASH的真实地址，写入成功则丢弃内部FLASH备份区的对应内容。如上所述的基于嵌入式的FATFS文件系统，其中，统一掉电管理，具体为：上电检测内部FLASH备份区中是否有配置区或数据区的数据，如果有，则将内部FLASH备份区中配置区的数据恢复到内部FLASH的配置区对应位置，或将内部FLASH备份区中数据区的数据恢复到外部FLASH的数据区对应位置。如上所述的基于嵌入式的FATFS文件系统，其中，响应于正常读操作命令，从读操作命令中获取读地址；判断读地址所对应的读操作区域：如果是对内部FLASH的配置区的读操作，则查找地址映射表，通过地址对应映射方式，将读地址所对应的配置区地址映射到内部FLASH对应大小的地址处，读出对应的数据；如果是对外部FLASH的数据区的读操作，则直接调用外部FLASH的读操作，从外部FLASH的数据区读出对应的数据。如上所述的基于嵌入式的FATFS文件系统，其中，FAT区包括FAT1区和FAT2区，FAT1区和FAT2区互为备份。如上所述的基于嵌入式的FATFS文件系统，其中，响应于正常写操作命令，从写操作命令中获取写地址；判断写地址所对应的写操作区域：如果是对内部FLASH的配置区的写操作，则查找地址映射表，通过地址对应映射方式，将写地址所对应的配置区地址映射到内部FLASH对应大小的地址处，将配置区数据写入到FAT2区进行备份，然后将写操作中的待写入数据写入到内部FLASH的真实地址，写入成功则丢弃FAT2区的对应内容；如果是对外部FLASH的数据区的写操作，则将写命令中的数据写入外部FLASH数据区中，然后更新FAT1区数据，再对应更新FAT2区数据。如上所述的基于嵌入式的FATFS文件系统，其中，内部FLASH的掉电保护具体为：上电，检测FAT1区和FAT2区中的数据是否一致，如果一致则数据写成功，如果不一致，检测FAT1区和FAT2区数据的合法性，若FAT1区数据合法，则根据FAT1区数据更新FAT2区，若FAT2区数据合法，则根据FAT2区数据更新FAT1区。如上所述的基于嵌入式的FATFS文件系统，其中，响应于正常读操作命令，从读操作命令中获取读地址；判断读地址所对应的读操作区域：如果是对内部FLASH的配置区的读操作，则查找地址映射表，通过地址对应映射方式，将读地址所对应的配置区地址映射到内部FLASH对应大小的地址处，读出对应的数据；如果是对外部FLASH的数据区的读操作，则直接调用外部FLASH的读操作，从外部FLASH的数据区读出对应的数据。本申请还提供一种计算机可读存储介质，包括外部FLASH和内部FLASH，用于存储上述任一项所述的基于嵌入式的FATFS文件系统，具体包括在外部FLASH中存储FATFS文件系统中的数据区，在内部FLASH中存储FATFS文件系统中的配置区。本发明实现的有益效果如下：采用本申请技术方案，对于基于FATFS文件系统结构的区域的读写访问更加节省时间，从而加快整个业务层面的处理时间。附图说明为了更清楚地说明本发明实施例或现有技术中的技术方案，下面将对实施例或现有技术描述中所需要使用的附图作简单地介绍，显而易见地，下面描述中的附图仅仅是本发明中记载的一些实施例，对于本领域普通技术人员来讲，还可以根据这些附图获得其他的附图。图1是现有FATFS文件系统的结构图；图2是本申请提供的一种基于嵌入式的FATFS文件系统示意图；图3是一种基于嵌入式的FATFS文件系统的写方法流程图；图4是一种基于嵌入式的FATFS文件系统的读方法流程图；图5是另一种基于嵌入式的FATFS文件系统的写方法流程图。具体实施方式下面结合本发明实施例中的附图，对本发明实施例中的技术方案进行清楚、完整地描述，显然，所描述的实施例是本发明一部分实施例，而不是全部的实施例。基于本发明中的实施例，本领域技术人员在没有做出创造性劳动前提下所获得的所有其他实施例，都属于本发明保护的范围。在介绍本申请的基于嵌入式的FATFS文件系统之前，先对现有FATFS文件系统的结构进行描述。如图1所示，现有FATFS文件系统包括配置区和数据区，配置区和数据区均设置在外部FLASH中，管理外部FLASH区域，配置区包括引导区、FAT1区、FAT2区和目录区。在外部对现有FATFS文件系统进行文件内容写入时，将一个簇作为基本单位，首先从FAT1区中找到文件中对应地址的相应的簇数，根据FAT1区的链接方式，计算出需要写入的数据区的簇位置，然后写入数据，数据写入成功后，需要把相关的簇位置，映射到FAT1区域内，并进行写入对应的标记，同时在FAT2中同步FAT1区的内容，作为备份FAT区使用。对于文件目录的添加和删除操作处理，除了在FAT区中对于对应簇进行管理，同时还需要在目录区进行对于改动的目录所在簇位置，进行添加和删除。从对现有FATFS文件系统的数据写入操作可以看出，引导区、FAT1区、FAT2区和目录区在数据写入时会被频繁访问，而由于外部FLASH的访问速度一般通过SPI或者I2C接口协议驱动，因此对于某些对访问处理时间要求较高的操作，现有FATFS文件系统在速度上不能满足需求。基于对现有FATFS文件系统所存在问题的发现，本申请实施例一构建了一种基于嵌入式的FATFS文件系统，用以解决现有FATFS文件系统访问速度慢的问题。实施例一如图2所示，本申请实施例一提供一种基于嵌入式的FATFS文件系统，包括设置在内部FLASH的配置区和设置在外部FLASH的数据区，配置区包括引导区、FAT区和目录区，内部FLASH和外部FLASH统一使用逻辑地址进行管理。其中，FAT区可以只包括FAT1区，内部FLASH和外部FLASH进行统一掉电管理，使用内部FLASH的备份区进行数据备份，省去FAT2区，进一步减少对内部FLASH区域的空间占用，并且也减少一次内部FLASH的写操作，从而使得外部文件的读写操作的性能更加快捷。相应的，如图3所示，所述基于嵌入式的FATFS文件系统的写方法，包括：步骤310、响应于正常写操作命令，从写操作命令中获取写地址；步骤320、判断写地址所对应的写操作区域：如果是对内部FLASH的配置区的写操作，则查找地址映射表，通过地址对应映射方式，将写地址所对应的配置区地址映射到内部FLASH对应大小的地址处，将配置区数据写入到内部FLASH备份区进行备份，然后将写操作中的待写入数据写入到内部FLASH的真实地址，写入成功则丢弃内部FLASH备份区的对应内容；需要说明的是，一般设定配置区中引导区为固定设置，不需要进行写处理，FAT区用来管理包括目录区和外部FLASH数据区的索引参数区，因此，在写操作时备份到内部FLASH备份区的配置区数据一般指的是FAT区数据。由于内部FLASH和外部FLASH统一使用逻辑地址进行管理，内部FLASH的配置区和外部FLASH的数据区均用唯一的逻辑地址表示，即配置区地址与数据区地址不重复，通过设置地址映射表，可以将内部FLASH的配置区和外部FLASH的数据区进行统一地址映射，写操作命令中的写地址在地址映射表中对应内部FLASH的配置区或外部FLASH的数据区的唯一地址，由此可以确定写地址所对应的写区域是外部FLASH的数据区还是内部FLASH的配置区。如果是对外部FLASH的数据区的写操作，则将外部FLASH地址数据写入内部FLASH备份区，将数据写入到外部FLASH的真实地址，写入成功则丢弃内部FLASH备份区的对应内容。本申请实施例中，统一掉电管理，具体为：上电检测内部FLASH备份区中是否有配置区或数据区的数据，如果有，则将内部FLASH备份区中配置区的数据恢复到内部FLASH的配置区对应位置，或将内部FLASH备份区中数据区的数据恢复到外部FLASH的数据区对应位置。如图4所示，所述基于嵌入式的FATFS文件系统的读方法，包括：步骤410、响应于正常读操作命令，从读操作命令中获取读地址；步骤420、判断读地址所对应的读操作区域，如果是对内部FLASH的配置区的读操作，则查找地址映射表，通过地址对应映射方式，将读地址所对应的配置区地址映射到内部FLASH对应大小的地址处，读出对应的数据；如果是对外部FLASH的数据区的读操作，则调用外部FLASH的读操作，从外部FLASH的数据区读出对应的数据。另外，FAT区也可以包括FAT1区和FAT2区，FAT1区和FAT2区互为备份，这种情况下内部FLASH和外部FLASH统一使用逻辑地址进行管理，但可以不进行统一掉电管理；相应的，如图5所示，所述基于嵌入式的FATFS文件系统的写方法，包括：步骤510、响应于正常写操作命令，从写操作命令中获取写地址；步骤520、判断写地址所对应的写操作区域：如果是对内部FLASH的配置区的写操作，则查找地址映射表，通过地址对应映射方式，将写地址所对应的配置区地址映射到内部FLASH对应大小的地址处，将配置区数据写入到FAT2区进行备份，然后将写操作中的待写入数据写入到内部FLASH的真实地址，写入成功则丢弃FAT2区的对应内容；如果是对外部FLASH的数据区的写操作，则写命令中的数据写入外部FLASH数据区中，然后更新FAT1区数据，再对应更新FAT2区数据。对于设置FAT1区和FAT2区所对应的掉电保护机制具体为：上电，检测FAT1区和FAT2区中的数据是否一致，如果一致则数据写成功，如果不一致，检测FAT1区和FAT2区数据的合法性，若FAT1区数据合法，则根据FAT1区数据更新FAT2区，若FAT2区数据合法，则根据FAT2区数据更新FAT1区。对于设置FAT1区和FAT2区所对应的基于嵌入式的FATFS文件系统的读方法，与只设置FAT1区所对应的基于嵌入式的FATFS文件系统的读方法相同，在此不作赘述。与上述实施例对应的，本发明实施例提供一种计算机可读存储介质，计算机可读存储介质中包含外部FLASH和内部FLASH，用于在外部FLASH中存储FATFS文件系统中的数据区，在内部FLASH中存储FATFS文件系统中的配置区。本发明所公开的实施例提供一种计算机可读存储介质，所述计算机可读存储介质中存储有计算机程序指令，当所述计算机程序指令在计算机上运行时，使得计算机执行上述的方法。在本发明实施例中，处理器可以是一种集成电路芯片，具有信号的处理能力。处理器可以是通用处理器、数字信号处理器、专用集成电路、现场可编程门阵列或者其他可编程逻辑器件、分立门或者晶体管逻辑器件、分立硬件组件。可以实现或者执行本发明实施例中的公开的各方法、步骤及逻辑框图。通用处理器可以是微处理器或者该处理器也可以是任何常规的处理器等。结合本发明实施例所公开的方法的步骤可以直接体现为硬件译码处理器执行完成，或者用译码处理器中的硬件及软件模块组合执行完成。软件模块可以位于随机存储器，闪存、只读存储器，可编程只读存储器或者电可擦写可编程存储器、寄存器等本领域成熟的存储介质中。处理器读取存储介质中的信息，结合其硬件完成上述方法的步骤。存储介质可以是存储器，例如可以是易失性存储器或非易失性存储器，或可包括易失性和非易失性存储器两者。其中，非易失性存储器可以是只读存储器、可编程只读存储器、可擦除可编程只读存储器、电可擦除可编程只读存储器或闪存。易失性存储器可以是随机存取存储器，其用作外部高速缓存。通过示例性但不是限制性说明，许多形式的RAM可用，例如静态随机存取存储器、动态随机存取存储器、同步动态随机存取存储器、双倍数据速率同步动态随机存取存储器、增强型同步动态随机存取存储器、同步连接动态随机存取存储器和直接内存总线随机存取存储器。本发明实施例描述的存储介质旨在包括但不限于这些和任意其它适合类型的存储器。本领域技术人员应该可以意识到，在上述一个或多个示例中，本发明所描述的功能可以用硬件与软件组合来实现。当应用软件时，可以将相应功能存储在计算机可读介质中或者作为计算机可读介质上的一个或多个指令或代码进行传输。计算机可读介质包括计算机存储介质和通信介质，其中通信介质包括便于从一个地方向另一个地方传送计算机程序的任何介质。存储介质可以是通用或专用计算机能够存取的任何可用介质。以上所述的具体实施方式，对本发明的目的、技术方案和有益效果进行了进一步详细说明，所应理解的是，以上所述仅为本发明的具体实施方式而已，并不用于限定本发明的保护范围，凡在本发明的技术方案的基础之上，所做的任何修改、等同替换、改进等，均应包括在本发明的保护范围之内。
