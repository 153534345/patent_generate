标题title
一种基于改进的PBFT物联网区块链共识算法
摘要abst
一种基于改进的PBFT物联网区块链共识算法，属于区块链共识算法技术领域，本发明区块链平台采用了目前发展良好的Fabric平台，为Fabric平台设计了改进的PBFT共识算法，在PBFT共识算法的基础上加入了可验证随机函数与代理节点设计，既能解决Fabric共识网络中不支持拜占庭容错的缺陷，同时解决了在PBFT共识网络拓展时通信量剧增的问题，本发明算法在提高共识安全性的同时提高了共识速度。
权利要求书clms
1.一种基于改进的PBFT物联网区块链共识算法，其特征是：包括以下步骤，且以下步骤顺次进行，步骤一、PBFT共识网络初始化，设定PBFT共识超时时间，设置每个共识节点的信誉值为1；步骤二、PBFT共识网络接收应用程序SDK的请求，每个节点调用可验证随机函数生成范围在0-65535之间的随机数，节点的排序分数为信誉值与该随机数的乘积，根据每个节点的排序分数进行排序，选择排序分数最大的4个节点参与PBFT共识，节点的排序分数相等时，选择其中一个的节点参与PBFT共识；步骤三、所述步骤二中获得排序分数最高的节点为PBFT共识的主节点，排序分数最高的节点为一个以上时，选取其中的一个节点作为主节点，其他节点为副本节点；步骤四、主节点向PBFT共识网络发起共识请求，经过三阶段共识，在所述步骤一设定的PBFT共识超时时间内，主节点收到2f+1个确认消息后共识完成，式中，f为拜占庭节点；步骤五、共识算法统计PBFT共识网络中的节点是否返回确认消息，节点成功返回确认消息，节点的信誉值不变；节点未返回确认消息，将该节点的信誉值更新为原值的二分之一；步骤六、达成共识后，主节点向Fabric网络发送区块，Fabric网络中的peer节点将区块写入到本地账本，完成一次交易流程。2.根据权利要求1所述的一种基于改进的PBFT物联网区块链共识算法，其特征是：所述步骤四中未在设定的PBFT共识超时时间内，主节点收到2f+1个确认消息，须重新选择节点参与PBFT共识进行对交易的排序。3.根据权利要求1所述的一种基于改进的PBFT物联网区块链共识算法，其特征是：所述步骤六主节点向Fabric网络发送区块后，anchor锚节点广播给同一通道所有组织的leader领导节点，leader领导节点在接收到由orderer排序节点发送的区块后进行读写集版本、交易格式、是否重复、是否有足够背书验证，该区块通过验证后，peer对等节点将该区块写入到本地账本中。4.根据权利要求3所述的一种基于改进的PBFT物联网区块链共识算法，其特征是：所述Leader领导节点用于在组织内广播通过验证的区块；所述anchor锚节点用于跨组织广播区块；所述peer对等节点用于将收到的区块写入到帐本中，通知客户端应用程序的交易提案已经写入区块链，以及该交易提案是否有效。
说明书desc
技术领域本发明属于区块链共识算法技术领域，特别是涉及到一种在物联网区块链中改进的PBFT的共识算法。背景技术区块链源自于2008年由化名为中本聪的作者提出的比特币的底层技术，区块链是一个多方共同维护的分布式账本，账本可以理解为传统的数据库。与传统数据库不同的是，区块链的各个节点都持有一份完整的账本，账本是由持续增长的区块组成的，每个区块都保存了上个区块的hash值，若攻击者想要篡改账本内容，则需要拥有整个区块链网络中51%以上的算力，所以，攻击者想要攻击区块链的账本是极其困难的，区块链提供了不可篡改与可溯源的能力。物联网是指通过互联网连接，将各种信息传感设备与网络结合起来的形成的、实现人与物互联互通的一个巨大的网络。近几年物联网技术迅速发展，信息化正在改变人们的衣食住行，但是由于物联网设备的客观受限能力，复杂的接入网络方式，数据的不同结构，使得物联网系统与系统之前协作成本较高。将物联网与区块链结合，可以使物联网数据更安全，从而可以利用此特性发展更多应用，如溯源、存证等，这将使社会生产生活中各方实体之间建立信任，提供社会协作效率。区块链架构是一种分布式的架构。在区块链的系统中，共识算法需要解决的问题是使各个节点通过一个规则将数据保持一致，区块链实质是一个分布式的数据库，因此共识算法是区块链的核心。在公有链系统中常见的共识算法有POW、POS、DPOS；在联盟链系统中常见的共识算法有PBFT、Raft。不同的共识算法会有不同的耗能、安全性、效率等。目前较多的物联网区块链业务使用Hyperledger Fabric作为其区块链技术平台，Fabric v1.4中内置共识算法有Solo、Kafka、Raft，这些算法并不支持拜占庭容错，即当区块链的共识网络中如果有恶意节点，则使用内置共识算法不能达成共识。可验证随机函数是一种加密函数，基于数据输入产生伪随机数，以及一个proof，验证者可以轻易验证上述随机数的合法性。其中输入的数据有自己的私钥与公开的一个信息，验证者可以通过证明者的公钥、公开信息和proof即可验证该随机数的合法性。现如今物联网区块链在使用Fabric平台中默认共识算法时存在以下不足：Fabric内置的Solo、Kafka、Raft共识算法并不支持拜占庭容错算法，若共识网络中有拜占庭节点则不能达成共识，这将使相关业务被迫停止，无法继续服务。直接将PBFT共识算法应用于Fabric平台有以下不足：由于PBFT算法的通信复杂度依赖于参与协议的节点数量，每个节点都要与其他节点进行通信，当区块链共识网络的节点增加时，会使共识达成的速度降低，影响区块链网络的吞吐量。因此，现有技术亟需一种新的技术方案来解决上述问题。发明内容本发明所要解决的技术问题是：提供一种基于改进的PBFT物联网区块链共识算法，结合DPOS选择代理节点的思想在PBFT共识网络中选择代理节点参与PBFT共识，使得在共识节点较多时区块链网络保持较好的性能，从而应对日益增长的业务量需求。一种基于改进的PBFT物联网区块链共识算法，其特征是：包括以下步骤，且以下步骤顺次进行，步骤一、PBFT共识网络初始化，设定PBFT共识超时时间，设置每个共识节点的信誉值为1；步骤二、PBFT共识网络接收应用程序SDK软件开发工具包的请求，每个节点调用可验证随机函数生成范围在0-65535之间的随机数，节点的排序分数为信誉值与该随机数的乘积，根据每个节点的排序分数进行排序，选择排序分数最大的4个节点参与PBFT共识，节点的排序分数相等时，选择其中一个的节点参与PBFT共识；步骤三、所述步骤二中获得排序分数最高的节点为PBFT共识的主节点，排序分数最高的节点为一个以上时，选取其中的一个节点作为主节点，其他节点为副本节点；步骤四、主节点向PBFT共识网络发起共识请求，经过三阶段共识，在所述步骤一设定的PBFT共识超时时间内，主节点收到2f+1个确认消息后共识完成，式中，f为拜占庭节点；步骤五、共识算法统计PBFT共识网络中的节点是否返回确认消息，节点成功返回确认消息，节点的信誉值不变；节点未返回确认消息，将该节点的信誉值更新为原值的二分之一；步骤六、达成共识后，主节点向Fabric网络发送区块，Fabric网络中的peer对等节点将区块写入到本地账本，完成一次交易流程。所述步骤四中未在设定的PBFT共识超时时间内，主节点收到2f+1个确认消息，须重新选择节点参与PBFT共识进行对交易的排序。所述步骤六主节点向Fabric网络发送区块后，anchor锚节点广播给同一通道所有组织的leader领导节点，leader节点在接收到由orderer排序节点发送的区块后进行读写集版本、交易格式、是否重复、是否有足够背书验证，该区块通过验证后，peer对等节点将该区块写入到本地账本中。所述Leader领导节点用于在组织内广播通过验证的区块；所述anchor锚节点用于跨组织广播区块；所述peer对等节点用于将收到的区块写入到帐本中，通知客户端应用程序的交易提案已经写入区块链，以及该交易提案是否有效。通过上述设计方案，本发明可以带来如下有益效果：一种基于改进的PBFT物联网区块链共识算法，区块链平台采用了目前发展良好的Fabric平台，为Fabric平台设计了改进的PBFT共识算法，在PBFT共识算法的基础上加入了可验证随机函数与代理节点设计，既能解决Fabric共识网络中不支持拜占庭容错的缺陷，同时解决了在PBFT共识网络拓展时通信量剧增的问题，本发明算法在提高共识安全性的同时提高了共识速度。本发明进一步有益效果在于，设置每个共识节点的信誉值为1，节点是否可以参与本轮共识取决于节点的排序分数，排序分数由信誉值与节点通过可验证随机函数产生的随机数相乘得到，而可验证随机函数的随机数范围为0-65535，这样设置可以在一定程度上避免共识节点排序分数相同的情况，便于在步骤二中选择节点。所述信誉度更新规则是指在PBFT共识网络中，节点若成功完成了本轮共识，则将该节点的信誉度不变；当节点未能完成本轮共识则将该节点的信誉度更新为原来的二分之一；若节点产生过一次拜占庭错误则相较于其他节点更容易再次发生拜占庭错误，因此设置了当节点未完成消息确认则降低该节点的信誉度，节点的信誉度降低将影响节点下次参于PBFT共识。附图说明以下结合附图和具体实施方式对本发明作进一步的说明：图1为本发明一种基于改进的PBFT物联网区块链共识算法流程示意图。图2为本发明一种基于改进的PBFT物联网区块链共识算法信誉值更新规则流程示意图。具体实施方式一种基于改进的PBFT物联网区块链共识算法，如图1所示，包括以下步骤步骤一：在Fabric网络启动后，PBFT共识网络进行初始化操作，设置PBFT共识超时的时间，给所有的共识节点设置初始信誉值为1。步骤二：在PBFT共识网络初始化成功后，等待应用程序SDK向PBFT共识网络发送交易请求request，PBFT共识网络在收到请求消息后，各节点通过可验证随机函数生成一个随机数，其中公开消息为PBFT共识网络当前视图编号，然后计算排序分数，排序分数计算规则为上述随机数与节点信誉值的乘积。将根据排序分数大小对PBFT共识节点排序，取排序分数最大的四个节点作为代理节点参与本轮PBFT共识。如果在选择上述四个节点时若干个节点信誉值相等，则随机选择其中的节点参与本轮PBFT共识。步骤三：在步骤二中已成功选择好了参与本轮PBFT共识的节点，排序分数最高的节点作为本轮PBFT共识的主节点，接下来就是常规的PBFT共识流程。步骤四：在本轮PBFT共识中，主节点发送共识请求，直至收到2f+1个确认消息后，共识完成，其中，f为拜占庭节点。在PBFT共识算法的流程中，C为客户端，0，1，2，3为四个PBFT共识节点，一个完整的共识需要经过request、Pre-prepare、Prepare、Commit、reply流程。在本发明算法中，排序分数最高的节点作为本轮PBFT共识的主节点。在预准备阶段中：主节点对请求消息进行验证，如果验证通过的话就广播给其他的节点；在准备阶段：其他节点验证Pre-prepare消息是否有效，如果通过则将Prepare消息广播给其他的节点。节点在收到2f+1个Prepare消息后则广播Commit消息；在提交阶段：主节点在收到2f+1个有效的Commit确认消息后，本轮次的共识完成。步骤五：如图2所示，在完成本轮PBFT共识后，系统根据收到的确认消息对参加本轮PBFT共识节点的信誉值进行更新。在Fabric网络启动时，设置了节点的初始信誉值。在完成一次共识流程后对节点更新信誉值有两种情况，一种情况是未收到PBFT共识节点的确认消息，则将该节点的信誉值更新为原来的二分之一。在该类情况中有可能是主节点故障，需要将所有参与本轮PBFT共识的节点的信誉值更新为原来的二分之一。这样做的原因是本轮参与PBFT共识的节点可能存在拜占庭节点大于或等于一个，且节点之间网络通信可能有问题，这些节点在参与之后的PBFT共识时也有几率不能完成共识，因此将本轮参与PBFT共识的节点的信誉值均更新为原来的二分之一。另一种情况是收到了所有节点的确认消息，这表示本轮次PBFT共识中所有节点都顺利完成了三阶段共识，即Pre-prepare、Prepare、Commit三个阶段，可以看作良好的节点，因此本轮次节点的信誉值不做更新。这样操作的优势是尽量让良好的节点参与PBFT共识。在信誉值更新完成后，节点可以等待参与下次共识。步骤六：本轮PBFT共识中的主节点向Fabric网络发送区块，peer节点将区块写入到本地账本，完成一次交易流程。PBFT共识网络完成共识后，创建交易区块，广播给同一通道所有组织的leader节点，leader节点在接收到由orderer节点发送的区块后进行验证：读写集版本、交易格式、是否重复、是否有足够背书，如果该区块通过验证，则将该区块写入到本地账本中。Leader节点在组织内广播通过验证的区块，anchor节点负责跨组织广播区块。peer节点将收到的区块写入到帐本中，通知客户端应用程序的交易提案已经写入区块链，以及该交易提案是否有效。本发明中使用的区块链平台是Linux基金会下的Hyperledger Fabric，Fabric是开源的、面向企业的区块链平台，不仅有一般区块链平台的去中心化、不可篡改和可追溯的特征，还有企业级别的准入机制，可以阻挡攻击者的非授权访问，更有优势的相较于比特币、以太坊是有更高的交易速度。本发明设计的一种基于改进的PBFT的物联网区块链共识算法，基于物联网区块链业务常用的Hyperledger Fabric平台进行改进，与现有的技术相比较，本发明结合了可验证随机函数DPOS与PBFT的优点，不仅为Fabric添加了PBFT共识算法，使其支持了拜占庭容错，而且将DPOS思想与PBFT共识算法相结合，对PBFT共识算法进行改进，根据排序分数选择代理节点参与PBFT共识流程，减少了普通PBFT共识网络的通信次数，提高了PBFT共识算法的效率。以上所述为本发明的具体实施方式，但本发明保护范围不局限于以上，熟悉本技术领域的技术人员可轻易想到变化或替换。因此，本发明的保护范围以权利要求的保护范围为准。
