标题title
一种成人呼吸监测设备及系统
摘要abst
本发明提供了一种成人呼吸监测设备及系统，在上电启动并加载呼吸监测程序后，获取微处理器的核心数以及用户级线程，并确定关键用户级线程；根据用户级线程数量、关键用户级线程数量和所述核心数确定LWP池中初始轻量级进程的数量；将关键用户级线程和LWP池中的轻量级进程一对一的绑定，其他用户级线程和LWP池中其他轻量级进程构成多对多或多对一关系；用于在设备运行中，记录其他用户级线程被内核调度的运行时间和次数，根据所述运行时间和次数调整LWP池中轻量级进程数量，并调整其他用户级线程和LWP池中其他轻量级进程的对应关系。本发明通过对LWP的调整，避免了资源的浪费，提高了成人呼吸监测设备的稳定性。
权利要求书clms
1.一种成人呼吸监测设备，所述设备包括微处理器、操作系统以及呼吸监测程序，其特征在于，所述设备包括以下模块：LWP池确定模块，用于在上电启动并加载呼吸监测程序后，获取微处理器的核心数以及用户级线程，并确定关键用户级线程；根据用户级线程数量、关键用户级线程数量和所述核心数确定LWP池中初始轻量级进程的数量；LWP绑定模块，用于将关键用户级线程和LWP池中的轻量级进程一对一的绑定，其他用户级线程和LWP池中其他轻量级进程构成多对多或多对一关系；LWP池调整模块，用于在设备运行中，记录其他用户级线程被内核调度的运行时间和次数，根据所述运行时间和次数调整LWP池中轻量级进程数量，并调整其他用户级线程和LWP池中其他轻量级进程的对应关系。2.如权利要求1所述的设备，其特征在于，所述呼吸监测程序包括数据预处理单元和报警单元；所述数据预处理单元，用于对监测的呼吸数据进行预处理，并判断呼吸数据是否满足预设条件，如果满足预设条件，则发送报警信息到报警单元；所述报警单元，用于向外发出报警信息。3.如权利要求1或2所述的设备，其特征在于，所述关键用户级线程为加载所述呼吸监测程序后出现的一个或多个进程中的线程。4.如权利要求1所述的设备，其特征在于，所述根据用户级线程数量、关键用户级线程数量和所述核心数确定LWP池中初始轻量级进程的数量，具体为：计算用户级线程数量与所述核心数的比值，得到第一比值；计算所述关键用户级线程数量与所述核心数的比值，得到第二比值；计算第一比值和第二比值的平均值；根据内存中系统区占用情况与权值的对照关系确定权值，根据所述平均值、所述权值和所述核心数确定LWP池中初始轻量级进程的数量。5.如权利要求1所述的设备，其特征在于，所述根据用户级线程数量、关键用户级线程数量和所述核心数确定LWP池中初始轻量级进程的数量，具体为：计算所述关键用户级线程数量与所述核心书的比值，得到第二比值及余数；若所述余数为0，则LWP池中初始轻量级进程的数量为所述关键用户线程数量和所述核心数的和；若所述余数不为0，计算所述核心数与所述余数的差值，则LWP池中初始轻量级进程的数量为所述关键用户线程数量和所述差值的和。6.如权利要求1-5任一一项所述的设备，其特征在于，所述根据所述运行时间和次数调整LWP池中轻量级进程数量，具体为：根据记录的其他用户级线程中每一个被内核调度的运行时间计算总运行时间，利用所述总运行时间和所述次数计算平均每次运行时间，若所述平均每次运行时间大于时间阈值，则不调整LWP池中轻量级进程数量；否则，计算时间阈值与所述平均每次运行时间的比值，得到第三比值，并计算调整前LWP池中轻量级进程数量与所述关键用户线程数量的差，计算所述第三比值与所述差的乘积，则调整后的LWP池中轻量级进程数量为所述关键用户线程数量和所述乘积的和。7.如权利要求6所述的设备，其特征在于，所述调整其他用户级线程和LWP池中其他轻量级进程的对应关系，具体为：根据所述其他用户级线程被内核调度的所述次数，将所述其他用户级线程均衡负载到LWP池中其他轻量级进程。8.一种成人呼吸监测系统，所述系统包括服务器、移动终端以及如权利要求1-7任一一项所述的设备，其特征在于，所述设备通过近距离无线通信与移动终端建立连接，所述移动终端通过无线通信与所述服务器建立连接。9.如权利要求8所述的系统，其特征在于，所述移动终端安装有呼吸监测APP，所述呼吸监测程序还通过所述呼吸监测APP发出报警信息。10.一种计算机可读存储介质，其特征在于，所述可读存储介质上存储有可执行程序，所述可执行程序在被微处理器执行时，执行以下步骤：步骤1，在上电启动并加载呼吸监测程序后，获取微处理器的核心数以及用户级线程，并确定关键用户级线程；根据用户级线程数量、关键用户级线程数量和所述核心数确定LWP池中初始轻量级进程的数量；步骤2，将关键用户级线程和LWP池中的轻量级进程一对一的绑定，其他用户级线程和LWP池中其他轻量级进程构成多对多或多对一关系；步骤3，在设备运行中，记录其他用户级线程被内核调度的运行时间和次数，根据所述运行时间和次数调整LWP池中轻量级进程数量，并调整其他用户级线程和LWP池中其他轻量级进程的对应关系。
说明书desc
技术领域本发明涉及医疗设备领域，尤其涉及一种成人呼吸监测设备及系统。背景技术呼吸是人体的重要生理特征，也是进行新陈代谢的重要方式，呼吸系统的疾病困扰着很多人，例如哮喘、睡眠呼吸暂停、打鼾等都会影响人们的健康。呼吸监测有助于对呼吸系统疾病尤其是对于睡眠呼吸暂停综合征的判断，在很多医院的呼吸科都配备有呼吸监测设备。在市场上也推出了各种类型的便携式的呼吸监测设备，按照呼吸监测设备测量方式，呼吸监测大体分为两类，一种是直接测量法，另外一种是间接测量法，其中，呼吸流量测定方法是常见的直接测量法，例如佩戴在口鼻位置的热敏元件、流量仪等，间接测量法主要是通过佩戴在手指、腕部或者腹部的压力变化实现对呼吸的监测。在以往的呼吸监测设备中，尤其是医院配置的呼吸监测设备采集到用户的呼吸信号后，需要医生对采集的呼吸信号波形进行判断，用户无法自行对呼吸情况进行判断。一些家用便携式呼吸监测设备会搭配手机APP，用户通过APP可以查看呼吸监测情况，但是呼吸监测多数情况下是在用户睡眠的情况进行监测，稳定性以及低功耗都是呼吸监测设备的重要指标，如何减少监测过程中资源的消耗、提高呼吸监测设备的稳定性是本领域亟待解决的问题。发明内容呼吸监测一般是在用户睡眠的情况下进行，由于呼吸监测设备使用的芯片的资源有限，用户在睡眠时无法及时发现呼吸监测设备的异常，这就需要对呼吸监测设备进行改进，尽可能保证呼吸监测设备的资源得到充分使用，而且要保证关键的呼吸监测线程的执行能够得到执行。针对上述问题，首先，本发明提供了一种成人呼吸监测设备，所述设备包括微处理器、操作系统以及呼吸监测程序，所述设备包括以下模块：LWP池确定模块，用于在上电启动并加载呼吸监测程序后，获取微处理器的核心数以及用户级线程，并确定关键用户级线程；根据用户级线程数量、关键用户级线程数量和所述核心数确定LWP池中初始轻量级进程的数量；LWP绑定模块，用于将关键用户级线程和LWP池中的轻量级进程一对一的绑定，其他用户级线程和LWP池中其他轻量级进程构成多对多或多对一关系；LWP池调整模块，用于在设备运行中，记录其他用户级线程被内核调度的运行时间和次数，根据所述运行时间和次数调整LWP池中轻量级进程数量，并调整其他用户级线程和LWP池中其他轻量级进程的对应关系。优选地，所述呼吸监测程序包括数据预处理单元和报警单元；所述数据预处理单元，用于对监测的呼吸数据进行预处理，并判断呼吸数据是否满足预设条件，如果满足预设条件，则发送报警信息到报警单元；所述报警单元，用于向外发出报警信息。优选地，所述关键用户级线程为加载所述呼吸监测程序后出现的一个或多个进程中的线程。优选地，所述根据用户级线程数量、关键用户级线程数量和所述核心数确定LWP池中初始轻量级进程的数量，具体为：计算用户级线程数量与所述核心数的比值，得到第一比值；计算所述关键用户级线程数量与所述核心数的比值，得到第二比值；计算第一比值和第二比值的平均值；根据内存中系统区占用情况与权值的对照关系确定权值，根据所述平均值、所述权值和所述核心数确定LWP池中初始轻量级进程的数量。优选地，所述根据用户级线程数量、关键用户级线程数量和所述核心数确定LWP池中初始轻量级进程的数量，具体为：计算所述关键用户级线程数量与所述核心书的比值，得到第二比值及余数；若所述余数为0，则LWP池中初始轻量级进程的数量为所述关键用户线程数量和所述核心数的和；若所述余数不为0，计算所述核心数与所述余数的差值，则LWP池中初始轻量级进程的数量为所述关键用户线程数量和所述差值的和。优选地，所述根据所述运行时间和次数调整LWP池中轻量级进程数量，具体为：根据记录的其他用户级线程中每一个被内核调度的运行时间计算总运行时间，利用所述总运行时间和所述次数计算平均每次运行时间，若所述平均每次运行时间大于时间阈值，则不调整LWP池中轻量级进程数量；否则，计算时间阈值与所述平均每次运行时间的比值，得到第三比值，并计算调整前LWP池中轻量级进程数量与所述关键用户线程数量的差，计算所述第三比值与所述差的乘积，则调整后的LWP池中轻量级进程数量为所述关键用户线程数量和所述乘积的和。优选地，所述调整其他用户级线程和LWP池中其他轻量级进程的对应关系，具体为：根据所述其他用户级线程被内核调度的所述次数，将所述其他用户级线程均衡负载到LWP池中其他轻量级进程。另外，本发明还提供了一种成人呼吸监测系统，所述系统包括服务器、移动终端以及如上所述的设备，所述设备通过近距离无线通信与移动终端建立连接，所述移动终端通过无线通信与所述服务器建立连接。优选地，所述移动终端安装有呼吸监测APP，所述呼吸监测程序还通过所述呼吸监测APP发出报警信息。最后，本发明还提供了一种计算机可读存储介质，所述可读存储介质上存储有可执行程序，所述可执行程序在被微处理器执行时，执行以下步骤：步骤1，在上电启动并加载呼吸监测程序后，获取微处理器的核心数以及用户级线程，并确定关键用户级线程；根据用户级线程数量、关键用户级线程数量和所述核心数确定LWP池中初始轻量级进程的数量；步骤2，将关键用户级线程和LWP池中的轻量级进程一对一的绑定，其他用户级线程和LWP池中其他轻量级进程构成多对多或多对一关系；步骤3，在设备运行中，记录其他用户级线程被内核调度的运行时间和次数，根据所述运行时间和次数调整LWP池中轻量级进程数量，并调整其他用户级线程和LWP池中其他轻量级进程的对应关系。本发明针对成人呼吸监测设备资源有限、稳定性差的问题，针对成人呼吸监测设备使用的系统进行改进，主要是采用动态调整LWP池中轻量级进程的数量，防止过多的产生轻量级进程对资源的消耗，同时对于关键性的用户级线程，分配一个与之绑定的轻量级进程，防止由于用户级线程争抢LWP导致关键用户级线程执行时间得不到保证的问题；此外，还针对成人呼吸监测系统的移动终端的报警方式进行改进，实现了双重报警机制。附图说明为了更清楚地说明本发明具体实施方式或现有技术中的技术方案，下面将对具体实施方式或现有技术描述中所需要使用的附图作简单地介绍，显而易见地，下面描述中的附图是本发明的一些实施方式，对于本领域普通技术人员来讲，在不付出创造性劳动的前提下，还可以根据这些附图获得其他的附图。图1为LWP与用户级线程、内核线程的对应的关系；图2为成人呼吸监测系统结构图；图3为实施例三流程图。具体实施方式在本文中，诸如第一和第二等之类的关系术语仅仅用来将一个实体或者操作与另一个实体或操作区分开来，而不一定要求或者暗示这些实体或操作之间存在任何这种实际的关系或者顺序。而且，术语“包括”、“包含”或者其任何其他变体意在涵盖非排他性的包含，从而使得包括一系列要素的过程、方法、物品或者设备不仅包括那些要素，而且还包括没有明确列出的其他要素，或者是还包括为这种过程、方法、物品或者设备所固有的要素。在没有更多限制的情况下，由语句“包括一个……”限定的要素，并不排除在包括所述要素的过程、方法、物品或者设备中还存在另外的相同要素。下面将结合本发明实施例中的附图，对本发明实施例中的技术方案进行清楚、完整地描述，显然，所描述的实施例仅仅是本发明一部分实施例，而不是全部的实施例。基于本发明中的实施例，本领域普通技术人员在没有做出创造性劳动前提下所获得的所有其他实施例，都属于本发明保护的范围。实施例一首先，本发明提供了一种成人呼吸监测设备，所述设备包括微处理器、操作系统以及呼吸监测程序，所述设备包括以下模块：LWP池确定模块，用于在上电启动并加载呼吸监测程序后，获取微处理器的核心数以及用户级线程，并确定关键用户级线程；根据用户级线程数量、关键用户级线程数量和所述核心数确定LWP池中初始轻量级进程的数量；直接监测方式测量呼吸的准确性更高，本发明采用直接监测法对成人的呼吸进行监测，微处理器采用ARM处理器，操作系统采用嵌入式操作系统，包括但不限于嵌入式Linux，呼吸监测程序是运行在嵌入式操作系统之上的应用程序，但是需要注意的是，此处所述的呼吸监测程序和呼吸监测APP是两个不同的程序，具体地，呼吸监测程序是运行在成人呼吸监测设备上，呼吸监测APP是运行在移动终端例如手机上的程序，成人呼吸监测设备是佩戴在用户身上的设备，例如穿戴在口鼻位置的面罩。相较于儿童呼吸监测设备，成人呼吸监测更为方便，成人的配合度较高，如果对儿童呼吸进行监测还需要对佩戴情况进行监测，这不在本发明的讨论范围，当然，应当理解的是，本发明的成人呼吸监测可以作为儿童呼吸监测设备的一部分，在此基础上，通过改进实现针对儿童的呼吸监测。操作系统中线程分为用户级线程和内核级线程，用户级线程无法被系统调用，采用的方式通过轻量级用户进程实现用户级线程调度到硬件CPU上，每个LWP需要一个与之对应的内核级线程，用户级线程和LWP的对应关系包括一对一、多对一、多对多，如图1所示。但是LWP创建的过多或者过少都对成人呼吸监测设备有影响，具体地，如果创建过多，则LWP本身占用很多资源，如果创建过少，则会有多个用户级线程等待分配LWP，这都不利于成人呼吸监测设备的流畅运行。在对呼吸进行监测时，呼吸监测设备上会运行多种用户级线程，例如和监测呼吸相关的用户线程，以及系统中其他的用户级线程，其中和呼吸监测的用户线程是呼吸监测设备的关键线程，其正常运行实现了呼吸监测。本发明对由呼吸监测程序产生的线程设置为关键用户级线程，具体地，通过线程的继承关系或者线程名字确定关键用户级线程，而用户级线程是指设备中所有的用户级线程，用户级线程包括了关键用户级线程，用户级线程中非关键用户级线程记为其他用户级线程，也即用户级线程由关键用户级线程和其他用户级线程。LWP绑定模块，用于将关键用户级线程和LWP池中的轻量级进程一对一的绑定，其他用户级线程和LWP池中其他轻量级进程构成多对多或多对一关系；关键用户级线程对实现呼吸监测很重要，本发明对每个关键用户级线程分配一个LWP，其他用户级线程和LWP是多对多或多对一关系，具体地，如果在给关键用户级线程分配LWP后，仅剩下一个LWP，则其他用户级线程共用剩下的一个LWP，如果剩下多个LWP，则其他用户级线程共用剩下的多个LWP。LWP池调整模块，用于在设备运行中，记录其他用户级线程被内核调度的运行时间和次数，根据所述运行时间和次数调整LWP池中轻量级进程数量，并调整其他用户级线程和LWP池中其他轻量级进程的对应关系。在设备运行中，设备的剩余资源是不断变化的，及时调整LWP能够保证设备的正常运行。在一个实施例中，保持关键用户级线程和LWP的对应关系不变，对LWP池中LWP的数量进行调整，并及时调整其他用户级线程和LWP的对应关系，能有效节省微处理器和内存资源。呼吸监测设备采集的数据有助于医生对睡眠情况的判断，但是及时的发出报警提示对于用户来说也是十分重要的，例如在呼吸暂停时，能够及时向用户或者用户的家人发出报警能有效让用户及家属采取措施。在一个具体实施例中，所述呼吸监测程序包括数据预处理单元和报警单元；所述数据预处理单元，用于对监测的呼吸数据进行预处理，并判断呼吸数据是否满足预设条件，如果满足预设条件，则发送报警信息到报警单元；所述预设条件为报警触发条件，例如呼吸强度持续低于一定值，则会触发报警。所述报警单元，用于向外发出报警信息。报警单元对外发出报警信息，既可以通过蜂鸣器的方式发出报警，也可以向用户或者用户家属的手机发出报警信息，这样及时用户家属不在用户身边也能即使了解用户的呼吸监测情况。对于睡眠障碍的用户，报警单元的功能是一个可选功能，用户通过手机APP也即呼吸监测APP打开或者关闭该功能。在一个具体实施例中，所述关键用户级线程为加载所述呼吸监测程序后出现的一个或多个进程中的线程。在初始时刻，设置LWP池中LWP数量具体为：计算用户级线程数量与所述核心数的比值，得到第一比值；计算所述关键用户级线程数量与所述核心数的比值，得到第二比值；计算第一比值和第二比值的平均值；根据内存中系统区占用情况与权值的对照关系确定权值，根据所述平均值、所述权值和所述核心数确定LWP池中初始轻量级进程的数量。下面结合一个示例进行说明，例如用户级线程数量为20个，核心数为2，关键用户级线程为4，则第一比值为10，第二比值为2，二者的平均值为6。内存被操作系统划分为系统内存区和用户内存区，当系统内存区被系统过多占用，则无法创建过多LWP，在一个实施例中，预先建立内存中的系统区占用情况和权值的对照关系表，通过查表即可确定权值，假设查表得到的权值为0.5，则可以根据所述平均值、所述权值和所述核心数确定LWP中初始时刻轻量级进程的数量，在一个更为具体的实施例中，采用三者的乘积的方式得到初始时刻轻量级进程的数量，最后得到的结果为6，也即初始时刻LWP池中有6个LWP。在初始化LWP池后，由于关键用户级线程为4，将有4个LWP与4个关键用户级线程一一对应绑定，剩下的2个LWP被16个其他用户级线程共用。为了确保每个关键用户级线程有一个与之对应的LWP，在计算得到初始化LWP池中LWP数量后，还需要对其进行校验，具体地，若所述初始轻量级进程的数量小于所述关键用户级线程数量+1，则将初始轻量级进程的数量设置为关键用户级线程+1。在一个实施例中，所述初始时刻是指监测设备启动并加载所述呼吸监测程序后。在另外一个具体实施例中，为了减少LWP以及与LWP对应的内核线程对系统的占用，在初始时刻，所述根据用户级线程数量、关键用户级线程数量和所述核心数确定LWP池中初始轻量级进程的数量，具体为：计算所述关键用户级线程数量与所述核心书的比值，得到第二比值及余数；若所述余数为0，则LWP池中初始轻量级进程的数量为所述关键用户线程数量和所述核心数的和；若所述余数不为0，计算所述核心数与所述余数的差值，则LWP池中初始轻量级进程的数量为所述关键用户线程数量和所述差值的和。仍以上面的示例性数据为例，第二比值为2，余数为0，则LWP池中初始轻量级进程的数量为关键用户线程数量4+核心数2，最后的结果为6。若关键用户线程数量为5，则第二比值为2，余数为1，则LWP池中初始轻量级进程的数量为关键用户线程数量5+差值1，最后的结果为6。在该实施例中，能够保证LWP的数量是核心数的整数倍，有利于将与LWP对应的内核线程均衡分配到核心中。在一个具体实施例中，所述根据所述运行时间和次数调整LWP池中轻量级进程数量，具体为：根据记录的其他用户级线程中每一个被内核调度的运行时间计算总运行时间，利用所述总运行时间和所述次数计算平均每次运行时间，若所述平均每次运行时间大于时间阈值，则不调整LWP池中轻量级进程数量；否则，计算时间阈值与所述平均每次运行时间的比值，得到第三比值，并计算调整前LWP池中轻量级进程数量与所述关键用户线程数量的差，计算所述第三比值与所述差的乘积，则调整后的LWP池中轻量级进程数量为所述关键用户线程数量和所述乘积的和。如果每个其他用户级线程的平均运行时间比较长，则调度其他用户级线程的平均次数较少，其他用户线线程争抢LWP的时机也就比较少，为了节省资源，无需过多的创建LWP；反之，如果每个其他用户级线程的平均运行时间比较短，则说明经常性的轮调其他用户级线程，这就需要多创建LWP，减少竞争。在一个具体实施例中，所述调整其他用户级线程和LWP池中其他轻量级进程的对应关系，具体为：根据所述其他用户级线程被内核调度的所述次数，将所述其他用户级线程均衡负载到LWP池中其他轻量级进程。多个用户级线程对应一个LWP时，当需要调度用户级线程时，首先需要该用户级线程得到LWP，均衡负载到LWP有利于每个用户级线程的执行。实施例二本发明还提供了一种成人呼吸监测系统，如图2所示，所述系统包括服务器、移动终端以及如实施例一所述的设备，所述设备通过近距离无线通信与移动终端建立连接，所述移动终端通过无线通信与所述服务器建立连接。在一个具体实施例中，所述移动终端安装有呼吸监测APP，所述呼吸监测程序还通过所述呼吸监测APP发出报警信息。用户通过呼吸监测APP不仅能够查看历史的监测数据，而且可以对成人呼吸监测设备进行控制，例如设置是否报警、关联手机等。实施例三本发明还提供了一种计算机可读存储介质，所述可读存储介质上存储有可执行程序，所述可执行程序在被微处理器执行时，如图3所示，执行以下步骤：步骤1，在上电启动并加载呼吸监测程序后，获取微处理器的核心数以及用户级线程，并确定关键用户级线程；根据用户级线程数量、关键用户级线程数量和所述核心数确定LWP池中初始轻量级进程的数量；步骤2，将关键用户级线程和LWP池中的轻量级进程一对一的绑定，其他用户级线程和LWP池中其他轻量级进程构成多对多或多对一关系；步骤3，在设备运行中，记录其他用户级线程被内核调度的运行时间和次数，根据所述运行时间和次数调整LWP池中轻量级进程数量，并调整其他用户级线程和LWP池中其他轻量级进程的对应关系。通过以上的实施方式的描述，本领域的技术人员可以清楚地了解到各实施方式可借助加必需的通用硬件平台的方式来实现，当然也可以通过硬件和软件结合的方式来实现。基于这样的理解，上述技术方案本质上或者说对现有技术做出贡献的部分可以以计算机产品的形式体现出来，本发明可采用在一个或多个其中包含有计算机可用程序代码的计算机可用存储介质上实施的计算机程序产品的形式。最后应说明的是：以上实施例仅用以说明本发明的技术方案，而非对其限制；尽管参照前述实施例对本发明进行了详细的说明，本领域的普通技术人员应当理解：其依然可以对前述各实施例所记载的技术方案进行修改，或者对其中部分技术特征进行等同替换；而这些修改或者替换，并不使相应技术方案的本质脱离本发明各实施例技术方案的精神和范围。
