标题title
一种基于多曝光生成融合的弱光车辆检测方法
摘要abst
本发明公开了一种基于多曝光生成融合的弱光车辆检测方法，属于计算机视觉技术领域。本发明设计了多曝光生成融合网络，实现了端到端的图像增强与车辆检测的功能，并可以使任意检测框架与本发明兼容；在多曝光生成网络中选取了双输入单输出的卷积循环模块来避免过度平滑与过度曝光问题，并设计单门控记忆单元来进行实现；在伪监督预训练时，设计了SMAE与SSIM相结合的损失函数，综合了整体视觉质量与像素值误差这两点进行计算；在端到端训练的损失函数中，加入双平衡因子损失函数，使损失函数重点关注暗光下难以检测的车辆样本；在多曝光生成网络与多曝光融合网络之间加入压缩激励网络，并使用卷积核通道维膨胀的方法来完成两个网络的融合对接。
权利要求书clms
1.一种基于多曝光生成融合的弱光车辆检测方法，其特征在于，包括：S1.构建弱光车辆检测网络；所述弱光车辆检测模型包括多曝光生成网络和多曝光融合网络；所述多曝光生成网络包括编码器和解码器，用于生成不同曝光度的图像；其中，编码器具有多个阶段；每一阶段包括多层串联的卷积循环模块；每个卷积循环模块为双输入单输出结构；其中一个输入为上一阶段同一层卷积循环模块的参数输出；另一输入为同一阶段上一层的编码输出；多曝光融合网络采用目标检测框架实现，用于对不同曝光度图像之间的差异信息进行互补学习，得到车辆检测结果；所述目标检测框架中第一层卷积核的参数权重复制与归一化T次后与多曝光生成网络的输出连接；T表示编码阶段数；S2.从低曝光图像中生成多张不同曝光度的伪曝光图；S3.使用步骤S2中低曝光图像与多张伪曝光图对多曝光生成网络进行伪监督预训练，得到多曝光生成模块的预训练参数；之后，采用低曝光图像对多曝光生成模块和多曝光融合网络进行端到端联合训练，使多曝光融合模块提供车辆检测信息来指导生成模块进行参数微调，多曝光生成模块为融合模块提供预训练后的增强图像来进行自适应的融合检测，最终得到弱光车辆检测模型；S4.将待检测弱光图像输入弱光车辆检测模型，得到车辆检测结果。2.根据权利要求1所述的一种基于多曝光生成融合的弱光车辆检测方法，其特征在于，采用 从低曝光图像中生成多张不同曝光度的伪曝光图；Px、P0分别为所需图像像素值与数据库中原有图像的像素值，kx为曝光率，a、b与相机有关的内部参数。3.根据权利要求1所述的一种基于多曝光生成融合的弱光车辆检测方法，其特征在于，编码器具有四个阶段；每一阶段包括四层串联的卷积循环模块。4.根据权利要求3所述的一种基于多曝光生成融合的弱光车辆检测方法，其特征在于，所述弱光车辆检测网络还包括压缩激励网络；所述压缩激励网络连接在多曝光生成网络与多曝光融合网络之间。5.根据权利要求3或4所述的一种基于多曝光生成融合的弱光车辆检测方法，其特征在于，所述目标检测框架采用one-stage下的特征金字塔网络；特征金字塔的主干网络Resnet中批量归一化BN与非线性激活RELU操作位于卷积层之前。6.根据权利要求1-4任一项所述的一种基于多曝光生成融合的弱光车辆检测方法，其特征在于，所述卷积循环模块包括单门控记忆单元、通道注意力机制和空间注意力机制。7.根据权利要求1-4任一项所述的一种基于多曝光生成融合的弱光车辆检测方法，其特征在于，所述多曝光生成网络伪监督预训练采用的损失函数为：It为网络训练生成的图像，为伪曝光图，N表示图像中的像素数量，SSIM表示结构相似性指标，H代表SMAE损失。8.根据权利要求1-4任一项所述的一种基于多曝光生成融合的弱光车辆检测方法，其特征在于，弱光车辆检测网络训练过程中采用的置信损失为：，为双平衡因子，/＞为1代表车辆，/＞为0代表背景，/＞为0-1之间的置信得分。9.一种计算机可读存储介质，其上存储有计算机程序，其特征在于，所述程序被处理器执行时实现如权利要求1-8中任一项所述的基于多曝光生成融合的弱光车辆检测方法。
说明书desc
技术领域本发明属于计算机视觉技术领域，更具体地，涉及一种基于多曝光生成融合的弱光车辆检测方法。背景技术现如今智慧交通系统是智慧城市的重要组成部分，是未来交通系统发展的主要方向。它是一个实时、准确、便捷的综合交通管理系统，与工作和出行生活交织在一起，发挥着极为关键的作用。而在ITS的研究中，车辆的目标检测是所有研究的重中之重，但从实际运用角度考虑，约有一半时间会受到夜晚暗光的影响，出现车辆检测率偏低的情况。对于ITS而言，仅依靠人工的方式对暗光车辆进行实时监测是不现实的。因此为了提高暗光下车辆检测的准确率，搭建一个高效准确的弱光下车辆检测系统进行实时监测是非常有必要的。弱光下的图像往往会因低亮度与低对比度而影响特征的提取，降低车辆检测的性能，同时低光照时还会产生额外的噪点，进一步影响并损害车辆图像的信息结构。一些常规的图像增强方法可以一定程度上解决这一问题，但是这些非深度学习的增强方法旨在提升整张图像的视觉质量，与车辆检测的目标并非完全一致。例如，常用的平滑操作可能会损害车辆检测时不可或缺的特征，对于亮度过低处的增强也不可避免产生一定的噪声。而基于深度学习的端到端“亮度增强-车辆检测”方案可以有效解决这一问题。在计算机视觉的任务中，通常生成目标图像的方法是以前一阶段图像作为输入去生成下一阶段的图像，通过卷积神经网络CNN形成一个单输入单输出的框架。但是由于实际道路交通中有车灯与路灯等因素的影响，有较为严重的光照与黑暗不均匀问题，单纯使用上述策略极可能会导致图片局部出现过度平滑或者过度曝光的现象，从而损害车辆检测任务中的细节信息，这都为暗光下的目标检测带来了困难。发明内容针对现有技术的以上缺陷或改进需求，本发明提供了一种基于多曝光生成融合的弱光车辆检测方法，其目的在于提高暗光下车辆检测的召回率。为实现上述目的，本发明提供了一种基于多曝光生成融合的弱光车辆检测方法，包括：S1.构建弱光车辆检测网络；所述弱光车辆检测模型包括多曝光生成网络和多曝光融合网络；所述多曝光生成网络包括编码器和解码器，用于生成不同曝光度的图像；其中，编码器具有多个阶段；每一阶段包括多层串联的卷积循环模块；每个卷积循环模块为双输入单输出结构；其中一个输入为上一阶段同一层卷积循环模块的参数输出；另一输入为同一阶段上一层的编码输出；多曝光融合网络采用目标检测框架实现，用于对不同曝光度图像之间的差异信息进行互补学习，得到车辆检测结果；所述目标检测框架中第一层卷积核的参数权重复制与归一化T次后与多曝光生成网络的输出连接；T表示编码阶段数；S2.从低曝光图像中生成多张不同曝光度的伪曝光图；S3.使用步骤S2中低曝光图像与多张伪曝光图对多曝光生成网络进行伪监督预训练，得到多曝光生成模块的预训练参数；之后，采用低曝光图像对多曝光生成模块和多曝光融合网络进行端到端联合训练，使多曝光融合模块提供车辆检测信息来指导生成模块进行参数微调，多曝光生成模块为融合模块提供预训练后的增强图像来进行自适应的融合检测，最终得到弱光车辆检测模型；S4.将待检测弱光图像输入弱光车辆检测模型，得到车辆检测结果。进一步地，采用从低曝光图像中生成多张不同曝光度的伪曝光图；Px、P0分别为所需图像像素值与数据库中原有图像的像素值，kx为曝光率，a、b与相机有关的内部参数。进一步地，编码器具有四个阶段；每一阶段包括四层串联的卷积循环模块。进一步地，所述弱光车辆检测网络还包括压缩激励网络；所述压缩激励网络连接在多曝光生成网络与多曝光融合网络之间。进一步地，所述目标检测框架采用one-stage下的特征金字塔网络；特征金字塔的主干网络Resnet中批量归一化BN与非线性激活RELU操作位于卷积层之前。进一步地，所述卷积循环模块包括单门控记忆单元、通道注意力机制和空间注意力机制。进一步地，所述多曝光生成网络伪监督预训练采用的损失函数为：It为网络训练生成的图像，为伪曝光图，N表示图像中的像素数量，SSIM表示结构相似性指标，H代表SMAE损失。进一步地，弱光车辆检测网络训练过程中采用的置信损失为：、/＞为双平衡因子，/＞为1代表车辆，/＞为0代表背景，/＞为0-1之间的置信得分。总体而言，通过本发明所构思的以上技术方案与现有技术相比，能够取得下列有益效果。本发明采取了双输入单输出的RNN模块应用于多曝光生成网络中，一方面利用历史信息来维持关键区域细节，一方面去生成曝光度逐渐变高的图像。这样设计可以避免常规卷积神经网络单输入单输出导致的过度平滑或过度曝光问题，可以有效解决黑夜中车灯与路灯影响下的车辆检测明暗不均问题；同时，本发明采用多曝光增强的检测方案，实现了不同曝光条件下的细节交互与特征融合，能有效提高低光照下车辆检测的精度；本发明是一个端到端的图像增强与车辆检测网络，不仅可以进行不同照明下的细节信息交互与特征融合，还可以通过端到端学习来使生成网络针对车辆检测这一问题进行有效优化，同时由于轻量化的设计，本发明仅会增加极少的参数。本发明选取CNN下的车辆检测算法作为多曝光融合框架，可以将多曝光生成模块设置于多曝光融合模块前，只需处理两模块连接处的通道维数，就可以与任意目标检测框架兼容，适用范围广。在信息输入多曝光融合网络之前，将生成的多张曝光图片输入到压缩-激励网络中，让学习过程可以使用全局信息以强化有用的通道特征，淡化无用的通道特征，以获得3T个通道融合时的通道维权重。目标检测框架采用one-stage下的特征金字塔网络进行训练，可以在保有one-stage速度的前提下，拥有不输于two-stage的结果精度；本发明采用残差网络的变体作为特征金字塔的主干网络。相较于最常用的Resnet，该变体将批量归一化与非线性激活操作移到了卷积层之前，使之具有预激活的功能，更易于整个网络的训练。本发明在二分类交叉熵上加入两个动态缩放因子，动态地大幅降低学习过程中易区分样本所带来的损失，从而将损失的重心放在那部分难以区分的正负样本上，将更有利于弱光照下对于困难目标的检测。附图说明图1是多曝光生成、融合网络结构图。图2是卷积循环模块示意图。图3中是特征金字塔网络，是Resnet变体骨干网络示意图。图4是多曝光生成网络不同阶段数与不同编码层数的准确率结果图。图5是数据集所需曝光率统计直方图。具体实施方式为了使本发明的目的、技术方案及优点更加清楚明白，以下结合附图及实施例，对本发明进行进一步详细说明。应当理解，此处所描述的具体实施例仅仅用以解释本发明，并不用于限定本发明。此外，下面所描述的本发明各个实施方式中所涉及到的技术特征只要彼此之间未构成冲突就可以相互组合。S1.构建弱光车辆检测网络；参考图1，弱光车辆检测模型包括多曝光生成网络和多曝光融合网络，多曝光生成网络包括编码器和解码器，用于生成不同曝光度的图像；其中，编码器具有多个阶段；每一阶段包括多层串联的卷积循环模块；本发明将每个卷积循环模块设置为双输入单输出结构，具体而言如图1所示，在单张低光照图像中，通过一系列双分支卷积训练进行实现：一个方向的输入如下式所示，引导网络框架进行编码和解码从而产生不同曝光度的图像。另一个方向输入如下式所示，将同一层的编码网络串联起来，将本阶段的输出作为下一阶段的输入之一。其中I代表各个阶段的图片，H代表中间隐藏层模块，与Eω表示模块中的解码器与编码器，其具有相应的参数/＞与ω。其中多个基于RNN的模块级联起来组成编码器，将输入图像编码为多层特征图。Htl表示隐藏层中第t个阶段的第l层，每一个编码器的输入都由前一层与前一阶段两部分组成。一方面，输入依赖于前一阶段的信息来实现神经网络的记忆功能，通过利用历史信息来维持关键区域细节，避免丧失学习间隔较远阶段信息的能力，从而减少图像中关键位置出现极端值的概率；另一方面，输入同一阶段的上一层用于完成编码过程，通过增加通道维数量来提取该阶段输入图像的特征，之后通过解码还原输入图像的大小，用以生成曝光度逐渐变高的图像。这样设计可以避免常规卷积神经网络单输入单输出导致的过度平滑或过度曝光问题，可以有效解决黑夜中车灯与路灯影响下的车辆检测明暗不均问题。基于多曝光生成网络的车辆检测是ITS算法架构中的第一部分，它的运算速度会对后续车牌检测、驾驶员行为识别等ITS算法的运行造成影响。将RNN卷积化处理后形成的卷积循环模块本身就具有一定量参数，同时多曝光生成网络也需要一定量的编码模块，因此在不损失精度的前提下设计参数更少的轻量化ConvRNN结构至关重要。在一般的ConvRNN中，每一阶段保存的信息通常都是短期信息，之前阶段的数据会呈现指数级别的缺失。这就导致在反向传播时，由于复合函数的链式求导法则，较为靠前阶段的卷积循环单元的参数变化极小，达不到所需的通过深度学习来避免过度平滑与过度曝光的目的。因此本发明根据实验所需的阶段数量，设计了一种特殊的RNN记忆单元，仅增加少量的参数，来保证学习到长期的关键信息。本发明结构图如图2所示。从序列长度这一角度出发，由于多曝光生成网络的阶段数量远小于自然语言处理的序列长度，因此本记忆单元的参数总和可以小于常用的ConvLTSM与ConvGRU。首先，将两个输入分别经过空洞卷积W与普通卷积U后进行sigmoid门控运算，得到模块中唯一一个门控模块。之后将门控模块与前一阶段的输入相乘后进行卷积，来得到卷积循环模块的隐藏层/＞，这里的门控模块来控制隐藏层中包含多少上一阶段的有效信息，从而避免梯度消失与梯度爆炸。接下来，使用门控参数来动态调整所需记忆的上一阶段有效信息，得到记忆单元的输出/＞。本卷积循环模块的参数总量只有ConvLSTM的一半，将有更快的速度进行训练与使用。记忆单元的运算公式如下所示，/＞此外在循环卷积模块内，还设计了轻量级的通道注意力机制Ac模块与空间注意力机制As模块放在记忆单元的后面，来关注重要特征，抑制不必要特征。在通道维度中，并联使用全局最大池化与全局平均池化来对图像的长与宽进行压缩，之后通过共享多层感知机来获取对通道维的权重标定；而在空间维度中，需要在通道维分别取平均值与最大值来进行信息提取，之后通过一个自定义大小的卷积核来继续对获得的两个结果进行通道数量的压缩。最后，使用非线性函数对原始的特征图进行权重系数的加权，从而完成整个注意力模块。在本发明中，选取CNN下的目标检测框架作为多曝光融合模块，这样就可以将多曝光生成模块放在融合模块前，只需处理两模块连接处的通道维数，就可以达到算法与任意车辆检测框架兼容的目的。在深度学习中，目标检测框架分为单阶段与双阶段两种。其中单阶段网络相比较于双阶段网络而言少了区域候选网络，不仅速度更快，而且更符合摄像头中芯片的要求。因此，本发明中目标检测框架采用单阶段网络下的特征金字塔网络进行训练，特征金字塔的网络结构如下图3中所示。它可以在保有单阶段网络速度的前提下，拥有不输于双阶段的结果精度。同时，采用残差网络的变体作为特征金字塔的主干网络，相较于最常用的Resnet，该变体将批量归一化与非线性激活操作移到了卷积层之前，参考图3中，使之具有预激活的功能，更易于整个网络的训练。由于选取的检测器都是基于卷积神经网络的，因此本发明选择裁取检测器框架的第一层，在通道维使用卷积核膨胀的方法，使得检测器可以同时处理多个图像并进行自适应的融合。具体而言，对于预训练后的车辆检测器，通过复制与归一化T次第一层卷积核的参数权重，来保证多曝光融合模块与生成模块拥有相同的通道维数，同时有助于在不同的伪曝光中保持更好的区分性和互补性区域信息。综上所述，本发明将图3中的中的第一个卷积层进行卷积核通道维膨胀后，就可以将其接入到图1所示的整个网络框架中，来整体实现多曝光融合功能。此外，由于多曝光生成网络最后的输出为T张RGB图片，因此融合网络的输入通道数为3T。因此可以在信息输入车辆检测器之前，将生成的图片输入到压缩-激励网络中，让学习过程可以使用全局信息强化有用的通道特征，淡化无用的通道特征，以获得3T个通道融合时的通道维权重。对于多曝光生成网络而言，本发明选取4个阶段作为多曝光的曝光数量，每一阶段选取4个卷积循环模块作为编码器。一般来说，增加阶段数不但会增加模型的参数数量与运算成本，还会需要更大的空间来提前生成更多伪曝光图用以支持学习训练；而增加每一阶段的编码数则可能会因层数过深而出现过拟合的现象。对于数量的选取，本发明还进行了对比实验，结果如图4所示。在准确率和效率之间进行权衡，最终选择了4乘4的编码结构。此外，当生成网络阶段数为1时，本发明就变成了单曝光的增强检测网络，图4中的结果也验证了所使用的多曝光方法相较于单曝光算法有更高的准确性。S2.从低曝光图像中生成多张不同曝光度的伪曝光图；摄像头获取的车型检测数据集难以收集同一场景不同级别曝光度的曝光图。因此，需要在多曝光融合模块前使用多曝光生成模块，通过深度学习使数据集中的图像生成不同级别的伪曝光图，为了能够完成上述多曝光生成网络的监督训练任务，首先需要从原始的低曝光输入图像中生成多个不同曝光度的伪曝光图，这样研究就不需要数据库依赖低光照与正常光照的图像对，具有良好的可扩展性。由于相机传感器辐照度与图像像素值之间的非线性函数关系，因此可以大致将二者关系表述为：其中Px与P0为所需图像与数据库中原有图像的像素值，曝光率kx为它们辐照度的比值，函数g为曝光度变换函数。参数a与b为所使用相机的内部参数，仅与相机有关。通过拟合所使用数据库中所有卡口与电警相机的响应曲线从而获取其值。而参数k则与数据集照片所需的曝光率有关，需要求解出大致所需曝光率的数值并进行统计。绘制出统计直方图如下图5所示。然后选择分布中的第一四分位数、第二四分位数、第三四分位数以及最大值作为所需的四个不同级别的曝光率，因此四个阶段的曝光率设置依次为：k1=3.8328，k2=4.0223，k3=4.3367，k4=6.9852。最后，将几个k值带入上面的公式中进行伪曝光图的生成。S3.使用步骤S2中低曝光图像与多张伪曝光图对多曝光生成网络进行伪监督预训练，得到多曝光生成模块的预训练参数；之后，采用低曝光图像对多曝光生成模块和多曝光融合网络进行联合训练，得到弱光车辆检测模型；具体地，这部分的预训练不仅可以减少后续端到端联合训练的用时，还可以提高最后暗光下车辆检测的性能。为了衡量网络训练生成的图像It与从步骤S2生成的伪曝光图的差异，本发明需要构造相对应的损失函数。由于结果中存在因车灯或路灯造成的明暗不均问题，若仅仅采用常见的MSE损失，则可能会导致这些过度曝光的离群值对结果造成很大的影响，使损失函数偏大。因此，本发明综合使用MSE与MAE来构成SMAE，对于误差小的位置，使用MSE来让损失易于收敛并更加稳定；而对于误差大的离群值则使用MAE来降低影响。除了像素点的误差所产生的回归损失外，还需要考虑生成图像的整体质量，并将该评价指标加入损失函数中。结构相似性指标SSIM可以很好的反应视觉领域的质量感受，因此本发明设计SSIM与SMAE相结合的损失函数，公式如下所示，/＞其中，H代表SMAE，均值μ与方差δ通过在图像像素pt处应用高斯滤波器计算得到，N表示图像中的像素数量。同时，因为生成的图片会无法避免的产生噪声与伪影，所以本发明在预训练中采用深度学习常用的早停法来避免这些不利因素的过拟合，为后续端到端的生成融合训练做准备。在车辆检测阶段，损失函数通常包括置信损失与回归损失两部分：其中，Na代表全部的样本数，Np代表正样本数量，参数λ用于平衡置信损失Lconf与回归损失Lreg。车辆目标检测应用于区分车辆与背景，因此置信损失Lconf是一个二分类的损失函数，其数值为。对于普通的二分类交叉熵，正样本输出概率越大越趋近于1，则损失越小；同样的，负样本输出概率越小越趋近于0，损失越小。在摄像头获取的道路数据集中，车辆目标的所占比远远小于背景的占比，因此anchor的目标会以负样本为主。又因为one-stage中没有区域候选网络，所以通常一张图片上会产生大约数十万个anchor，这就导致在最后的训练过程中，大多数都是容易区分的负样本。虽然它们产生的损失很低，但是大量的简单样本仍旧会产生较大的损失。此外，大量简单样本的迭代过程用时较长而且不利于目标的收敛。因此，本发明在二分类交叉熵上加入两个动态缩放因子，动态地大幅降低学习过程中易区分样本所带来的损失，从而将损失的重心放在那部分难以区分的正负样本上，这对于弱光照下的困难目标检测极为关键。综上所述，置信损失由下式给出，其中参数与为设计的双平衡因子，平滑的调整简单样本，使其权重损失大幅下降，让损失函数重点关注暗光下难以检测的车辆样本，最终构成双平衡因子损失函数。/＞为1代表车辆，/＞为0代表背景，/＞为0-1之间的置信得分。回归损失则是损失函数的另一部分，它仅由正样本计算生成。本发明使用SMAE损失来计算预测框与真实框/＞之间的距离，公式如下：/＞将多曝光生成模块与多曝光融合模块串联起来进行训练，使两部分形成一个端到端的学习系统。从两部分功能切入分析：多曝光融合模块提供车辆检测信息来指导生成模块进行参数微调，从而可以专门增强车辆区域进行检测；多曝光生成模块为融合模块提供经过监督预训练后的增强图像，经过通道维注意机制后进行自适应的融合检测。本发明将两部分耦合之后进行训练，不仅可以实现不同照明条件下的细节交互与特征融合，而且可以实现异常光照下车辆检测的端到端学习。S4.将待检测弱光图像输入弱光车辆检测模型，得到车辆检测结果。下面借助实验对本发明效果进行验证。首先，对本发明提出的多曝光生成融合方法进行定量分析。表1展示了本发明网络与单一的目标检测网络在参数量、速度与整体准确率等方面的比较结果。可以看出，在前置多曝光生成融合模块后，特殊车型数据集中黑夜照片在检测时的AP值提高较为明显，增加了7.3%。AIoU也有一定的增长，提升了4.7%。在参数量方面，由于轻量化注意力机制与单门控记忆单元的设计，使得现有算法仅增加了0.49M的计算参数，特殊车辆检测用时方面的增量也在实际使用的可接受范围内。对于暗光条件下的目标检测，衡量是否漏检的性能指标查全率至关重要，因此，可以修改关键参数IoU来多次进行实验，进而测试在不同条件下Recall的性能。实验的定量结果如表2所示。不难看出随着IoU的增加，Recall的值都在逐渐减小。同时在任何一个IoU中，本发明的查全率都要远高于Baseline算法。最后在IoU为0.5的情况下，将常用的暗光下图像增强算法与本发明的算法进行比较，比较结果如表3所示。可以看到，本发明提出的暗光下特殊车辆检测算法性能优于其余主流方案，进一步验证了它具有更好的性能。本领域的技术人员容易理解，以上所述仅为本发明的较佳实施例而已，并不用以限制本发明，凡在本发明的精神和原则之内所作的任何修改、等同替换和改进等，均应包含在本发明的保护范围之内。
