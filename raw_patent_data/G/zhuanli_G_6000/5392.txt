标题title
一种非同步高速串口实时连续数据采集系统
摘要abst
本发明公开了一种非同步高速串口实时连续数据采集系统，包括：硬件采集模块，用于将采集到的模拟信号转换为数字信号；软件控制模块，用于对所述数字信号进行滤波，并通过脉冲计数器累计，并将滤波完成后的数字信号发送至接收方串口缓冲区，形成实时连续数据流；实时数据拼接模块，用于通过采集线程对串口数据进行解析，判断所述串口数据的完整性和连续性，以实现无同步信号条件下对所述实时连续数据流的拼接处理。通过采用多串口卡与脉冲采样控制器模块，并设计串口高速收发及数据拼包模块，保证测试过程中不丢包不错数；在采集系统中采用多级硬件滤波，软件滤波，能够实现在高速串口实时数据采集下保证数据完整接收且保证极低的误码率。
权利要求书clms
1.一种非同步高速串口连续实时数据采集系统，其特征在于，包括：硬件采集模块，用于将采集到的模拟信号转换为数字信号；软件控制模块，用于对所述数字信号进行滤波，并通过脉冲计数器累计，并将滤波完成后的数字信号发送至接收方串口缓冲区，形成实时连续数据流；实时数据拼接模块，用于通过采集线程对串口数据进行解析，判断所述串口数据的完整性和连续性，以实现无同步信号条件下对所述实时连续数据流的拼接处理。2.根据权利要求1所述的系统，其特征在于，所述硬件采集模块包括：采样控制器、工控机、RS-422收发器、RS-422多串口卡以及数据传输电缆，其中，所述采样控制器用于将输入的所述模拟信号转化为数字信号，并通过RS-422收发器将所述数字信号发送至所述RS-422多串口卡，具体的，通过采样控制器完成加速度计及陀螺仪脉冲模拟信号实时采集系统和串口数据实时发送，工控机搭载非实时操作系统用于接收，其中满足发送周期为Tw，定时接收周期为TR，非实时漂移为ΔTR，且满足Tw＜TR±ΔTR＜10Tw时钟收发条件；所述RS-422多串口卡用于将所述数字信号发送至计算机。3.根据权利要求2所述的系统，其特征在于，所述采样控制器基于FPGA芯片搭配RS-422器架构组成。4.根据权利要求2所述的系统，其特征在于，所述RS-422多串口卡以总线插槽形式设置于所述计算机的主板。5.根据权利要求1所述的系统，其特征在于，所述软件控制模块包括：嵌入式FPGA软件模块和上位机数据接收软件模块。6.根据权利要求1所述的系统，其特征在于，所述软件控制模块用于实现模拟信号采集、调理滤波、模数逻辑转换、串口初始化操作、高速数据采集、多串口多线程工作以及数据实时显示与存储的功能。7.根据权利要求1所述的系统，其特征在于，所述实时数据拼接模块的拼接流程包括：S1、串口设备及数据初始化，用于数据采集线程开启，配置串口参数，包括波特率，数据发送形式，数据采集间隔时间，清空串口缓冲区，拼接数据预留存储区和完整帧数据存储区，数据拼接标志位设为0，上位机数据接收停止标志位设为0；S2、初始包头判断单元，读取串口缓冲区，判断当前串口数据的第一个字节是否为预设包头字节，若是，则进入完整校验单元S3，若否，则进入数据包后拼接单元S5；S3、完整校验单元，从第一个包头开始，按照预设串口字节长度N依次读取数据，再进行预设好的连续通道码、检验位及包尾的校验，若校验不通过，则报数据收发错误警示，舍弃这一帧数据，回到S1；若校验通过，则将这字节长度为N的数据流按一帧完整数据存入完整帧数据存储区中，再此从下一包头开始重新进行完整校验单元S3循环操作，直到缓冲区内数据不够字节长度N，再转到数据包前预留单元S4；S4、数据包前预留单元，从缓冲区内最后一个包尾处下一个字节开始保留剩余数据到拼接数据预留存储区，记为，字节长度为，将数据包拼接标志位设为1，进入初始包头判断单元S2；S5、数据包后拼接单元，用于上一包中不完整数据包中后半部分拼包处理，判断当前缓冲区内的数据第一个字节是否为包头，若不为包头，则依次向后读取字节，索引到读取字节等于第一个包头时，保留该字节之前的缓冲区内所有数据，设为，字节长度为，若满足Nback+Npre＝N，且校验通过，与上一包的完成拼包，存入完整帧数据存储区，数据拼接标志位设为0，同时清空拼接数据预留存储区，若不满足，则上报数据收发错误警示，返回S1；S6、数据接收停止单元，用于在S2-S5运行过程中定时接收上位机数据接收停止标志，若为0，则继续原始步骤，若为1，则关闭串口数据采集线程。
说明书desc
技术领域本发明涉及通信领域。更具体地，涉及一种非同步高速串口实时连续数据采集系统。背景技术在数据采集及通讯应用的场景中，常常采用串行通讯接口替代了其他大通讯接口，作为数据收发及交互通讯的接口。而在数据传输过程中，一般采用同步信号来同步接收和发送端的实时性，但是当没有时钟源最为同步信号时，往往会在串口包数据比较大时，出现在定时多次接收时无法完成整包数据任务而造成丢包或者误码，特别是在高速传输时，比如10ms以下的串口收发周期或波特率大于460800的传输速率下，这种问题会更加明显。中国发明专利名称“一种串口协议数据采集解析方法、系统及装置”公开了一种串口协议数据采集解析方法、系统及装置，根据所述约定帧长度进行串口数据的数据高低位，是否差分和是否求均值等内容进行所帧校验和帧解析，主要是应用于串口协议变更时的一种通用数据解析方法。该方法仅仅对某一帧串口数据的完整性进行了约定和解析，但对收发装置实时性匹配，多帧串口数据之间的连续性没有作进一步的考虑，出现误码之后可能出现数据丢失和错乱的问题。中国发明专利名称“一种多串口通信控制方法、装置及上位机”公开了一种多串口通讯控制方法，主要是针对监测上位机人机交互界面的多个串口控制区域，便于操作人员操作多个串口的开关及收发数据。该方法主要是基于人机交互界面完成可多串口相关参数及功能设置，并没有对多串口的独立操作性极数据交互完整性进行论述。因此，如何在高速串口实时数据采集下保证数据完整接收且保证极低的误码率是本领域技术人员需要亟待解决的技术问题。发明内容为了解决上述问题中的至少一个，本申请提出一种高速串行通讯实时数据采集系统，该系统包括：硬件采集模块，用于将采集到的模拟信号转换为数字信号；软件控制模块，用于对所述数字信号进行滤波，并通过脉冲计数器累计，并将滤波完成后的数字信号发送至接收方串口缓冲区，形成实时连续数据流；实时数据拼接模块，用于通过采集线程对串口数据进行解析，判断所述串口数据的完整性和连续性，以实现无同步信号条件下对所述实时连续数据流的拼接处理。在一个具体实施例中，所述硬件采集模块包括：采样控制器、工控机、RS-422收发器、RS-422多串口卡以及数据传输电缆，其中，所述采样控制器用于将输入的所述模拟信号转化为数字信号，并通过RS-422收发器将所述数字信号发送至所述RS-422多串口卡，具体的，通过采样控制器完成加速度计及陀螺仪脉冲模拟信号实时采集系统和串口数据实时发送，工控机搭载非实时操作系统用于接收，其中满足发送周期为Tw，定时接收周期为TR，非实时漂移为ΔTR，且满足Tw＜TR±ΔTR＜10Tw时钟收发条件；所述RS-422多串口卡用于将所述数字信号发送至计算机。在一个具体实施例中，所述采样控制器基于FPGA芯片搭配RS-422器架构组成。在一个具体实施例中，所述RS-422多串口卡以总线插槽形式设置于所述计算机的主板。在一个具体实施例中，所述软件控制模块包括：嵌入式FPGA软件模块和上位机数据接收软件模块。在一个具体实施例中，所述软件控制模块用于实现模拟信号采集、调理滤波、模数逻辑转换、串口初始化操作、高速数据采集、多串口多线程工作以及数据实时显示与存储的功能。在一个具体实施例中，所述实时数据拼接模块的拼接流程包括：S1、串口设备及数据初始化，用于数据采集线程开启，配置串口参数，包括波特率，数据发送形式，数据采集间隔时间，清空串口缓冲区，拼接数据预留存储区和完整帧数据存储区，数据拼接标志位设为0，上位机数据接收停止标志位设为0；S2、初始包头判断单元，读取串口缓冲区，判断当前串口数据的第一个字节是否为预设包头字节，若是，则进入完整校验单元S3，若否，则进入数据包后拼接单元S5；S3、完整校验单元，从第一个包头开始，按照预设串口字节长度N依次读取数据，再进行预设好的连续通道码、检验位及包尾的校验，若校验不通过，则报数据收发错误警示，舍弃这一帧数据，回到S1；若校验通过，则将这字节长度为N的数据流按一帧完整数据存入完整帧数据存储区中，再此从下一包头开始重新进行完整校验单元S3循环操作，直到缓冲区内数据不够字节长度N，再转到数据包前预留单元S4；S4、数据包前预留单元，从缓冲区内最后一个包尾处下一个字节开始保留剩余数据到拼接数据预留存储区，记为，字节长度为，将数据包拼接标志位设为1，进入初始包头判断单元S2；S5、数据包后拼接单元，用于上一包中不完整数据包中后半部分拼包处理，判断当前缓冲区内的数据第一个字节是否为包头，若不为包头，则依次向后读取字节，索引到读取字节等于第一个包头时，保留该字节之前的缓冲区内所有数据，设为，字节长度为，若满足Nback+Npre＝N，且校验通过，与上一包的完成拼包，存入完整帧数据存储区，数据拼接标志位设为0，同时清空拼接数据预留存储区，若不满足，则上报数据收发错误警示，返回S1；S6、数据接收停止单元，用于在S2-S5运行过程中定时接收上位机数据接收停止标志，若为0，则继续原始步骤，若为1，则关闭串口数据采集线程。本发明的有益效果如下：本申请针对现有问题制定一种非同步高速串口实时连续数据采集系统，通过采用多串口卡与脉冲采样控制器模块，并设计串口高速收发及数据拼包模块，保证测试过程中不丢包不错数；进一步，在采集系统中采用多级硬件滤波，软件滤波，在采样控制器中结合计数器和锁存器针对高速串口数据采集进行设计，能够实现在高速串口实时数据采集下保证数据完整接收且保证极低的误码率，具有通用性强、结构简单的特点，适用于高速串行通讯接口实时数据采集方法，极大的缩减开发时间，降低开发成本，具有广泛的应用前景。附图说明为了更清楚地说明本发明实施例中的技术方案，下面将对实施例描述中所需要使用的附图作简单地介绍，显而易见地，下面描述中的附图仅仅是本发明的一些实施例，对于本领域普通技术人员来讲，在不付出创造性劳动的前提下，还可以根据这些附图获得其他的附图。图1示出根据本申请的一个实施例所述的一种非同步高速串口实时连续数据采集系统的结构示意图。图2示出根据本申请的一个实施例所述的硬件采集模块的结构示意图。图3示出根据本申请的一个实施例所述的FPGA芯片的示意图。图4示出根据本申请的一个实施例所述的RS-422收发器的示意图。图5示出根据本申请的一个实施例所述的FPGA嵌入式软件流程图的示意图。图6示出根据本申请的一个实施例所述的上位机控制软件流程图的示意图。图7示出根据本申请的一个实施例所述的实时数据拼接模块的拼接流程示意图。具体实施方式为使本发明的、技术方案和优点更加清楚，下面将结合附图对本发明实施方式作进一步地详细描述。如图1所示，本申请提出一种高速串行通讯实时数据采集系统，该系统包括：硬件采集模块10，用于将采集到的模拟信号转换为数字信号；软件控制模块20，用于对所述数字信号进行滤波，并通过脉冲计数器累计，并将滤波完成后的数字信号发送至接收方串口缓冲区，形成实时连续数据流；实时数据拼接模块30，用于通过采集线程对串口数据进行解析，判断所述串口数据的完整性和连续性，以实现无同步信号条件下对所述实时连续数据流的拼接处理。在一个具体实施例中，所述硬件采集模块包括：采样控制器、工控机、RS-422收发器、RS-422多串口卡以及数据传输电缆，其中，所述采样控制器用于将输入的所述模拟信号转化为数字信号，并通过RS-422收发器将所述数字信号发送至所述RS-422多串口卡，具体的，通过采样控制器完成加速度计及陀螺仪脉冲模拟信号实时采集系统和串口数据实时发送，工控机搭载非实时操作系统用于接收，其中满足发送周期为Tw，定时接收周期为TR，非实时漂移为ΔTR，且满足Tw＜TR±ΔTR＜10Tw时钟收发条件；所述RS-422多串口卡用于将所述数字信号发送至计算机。在一个具体示例中，如图2所示，整个系统硬件采集模块包括采样控制器，工控机，RS-422多串口卡及传输电缆等，当测试开始时，多路模拟信号进入采样控制器中，后转化为数字信号，通过RS-422串口将数据流发送给计算机，其中RS-422串口卡一般以总线插槽形式安装在计算机主板上，如PCI，PCIe等形式，串口数据进入计算机后续进行数据处理。在一个具体实施例中，所述采样控制器基于FPGA芯片搭配RS-422器架构组成。例如，如图3所示，采样控制器中选用EP3C25Q系列的FPGA芯片，其中，选用SCI接口，配置对应的SCIRX和SCITX管脚，对应串口信号的读写通道。外部模拟信号进入采样控制器后，针对不同频段不同干扰形式的信号设计不同的滤波电路，如RC滤波低通电路，滤波后在FPGA中完成模拟-数字信号转换，具体来讲是逻辑器件将模拟信号记录并转换成一定时间间隔的计数值得到数值传输到RS-422收发器中。需要说明的是，如图4所示，本实施例中的RS-422收发器选用MAX3491ESD芯片，输出为差分信号的串口读写信号对RX和TX。具体的，上位机软件首先通过RS422高速串口发送初始化命令给采样控制器，当测试开始时，经过FPGA的数字信号，然后通过采样控制器上的RS-422收发器将数据流发送给计算机多串口卡接收。本示例中，硬件采集模块主要实现多路模拟信号经过滤波器电路、FPGA芯片处理、RS-422收发器，完成数字信号的转换。在一个具体实施例中，软件控制模块主要实现串口初始化操作及定时收发数据等功能，并以多线程模式调用多个串口以线程同步的形式进行工作。其中，所述软件控制模块包括：如图5所示的嵌入式FPGA软件模块和如图6所示的上位机数据接收软件模块。其中，FPGA嵌入式软件模块的开发环境为Quartus II 8.1，编程语言为Verilog。上位机软件开发的操作系统选用Win 7 64bit，对应安装包为qt-windows-x86-5.2.exe，集成开发环境选用Qt creator 4.6.3，C++编译器选用Qt creator自带的MinGw，编程语言为C++，软件驱动方式为多串口卡驱动Moxa PComm 2K。本示例中，所述软件控制模块用于实现模拟信号采集、调理滤波、模数逻辑转换、串口初始化操作、高速数据采集、多串口多线程工作以及数据实时显示与存储的功能。此外，本实施例中的软件控制模块对应用程序进行了主次线程和同等模式线程的设计，主测试线程MainWindow中根据开启串口个数创建同等的子线程ComThread。多个子线程之间通过线程同步类QMutex和线程等待类QWaitCondition进行测试过程中的时序规划和线程同步，使得应用程序更加易于扩展和维护。在一个具体实施例中，实时数据拼接模块主要针对多个串口高速收发过程出现数据包被截断情况下完成上下两包数据的拼接功能。如图7所示，所述实时数据拼接模块的拼接流程包括：S1、串口设备及数据初始化，用于数据采集线程开启，配置串口参数，包括波特率，数据发送形式，数据采集间隔时间，清空串口缓冲区，拼接数据预留存储区和完整帧数据存储区，数据拼接标志位设为0，上位机数据接收停止标志位设为0；S2、初始包头判断单元，读取串口缓冲区，判断当前串口数据的第一个字节是否为预设包头字节，若是，则进入完整校验单元S3，若否，则进入数据包后拼接单元S5；S3、完整校验单元，从第一个包头开始，按照预设串口字节长度N依次读取数据，再进行预设好的连续通道码、检验位及包尾的校验，若校验不通过，则报数据收发错误警示，舍弃这一帧数据，回到S1；若校验通过，则将这字节长度为N的数据流按一帧完整数据存入完整帧数据存储区中，再此从下一包头开始重新进行完整校验单元S3循环操作，直到缓冲区内数据不够字节长度N，再转到数据包前预留单元S4；S4、数据包前预留单元，从缓冲区内最后一个包尾处下一个字节开始保留剩余数据到拼接数据预留存储区，记为，字节长度为，将数据包拼接标志位设为1，进入初始包头判断单元S2；S5、数据包后拼接单元，用于上一包中不完整数据包中后半部分拼包处理，判断当前缓冲区内的数据第一个字节是否为包头，若不为包头，则依次向后读取字节，索引到读取字节等于第一个包头时，保留该字节之前的缓冲区内所有数据，设为，字节长度为，若满足Nback+Npre＝N，且校验通过，与上一包的完成拼包，存入完整帧数据存储区，数据拼接标志位设为0，同时清空拼接数据预留存储区，若不满足，则上报数据收发错误警示，返回S1；S6、数据接收停止单元，用于在S2-S5运行过程中定时接收上位机数据接收停止标志，若为0，则继续原始步骤，若为1，则关闭串口数据采集线程。本申请所述技术方案适用于高速串口实时采集数据的场景，为针对高速串口传输时因单帧数据被截断而造成误码的时数据采集系统，利用硬件采集模块、软件控制模块以及实时数据拼接模块之间的相互配合，最终实现了高速串口实时数据采集下保证数据完整接收且保证极低的误码率，具有通用性强、结构简单的特点，适用于高速串行通讯接口实时数据采集方法，极大的缩减开发时间，降低开发成本。本实施例采用硬件设计的多串口卡的设计模式，从硬件原理上保证了多路串口可以同时进行测试采集；采用多线程的程序调度及设计模式，在软件上保证了多路串口可以同时进行测试采集，以使得本实施的高速串行通讯接口实时数据采集系统具有通用性强的特点。此外，本实施例采用多串口卡与脉冲采样控制器模块，设计串口高速收发及数据拼包模块，保证测试过程中不丢包不错数；采集系统中采用多级硬件滤波，软件滤波，在采样控制器中结合计数器和锁存器针对高速串口数据采集进行了设计，以使得本实施例的高速串行通讯接口实时数据采集系统能够提高脉冲采集的准确度。显然，本发明的上述实施例仅仅是为清楚地说明本发明所作的举例，而并非是对本发明的实施方式的限定，对于所属领域的普通技术人员来说，在上述说明的基础上还可以做出其它不同形式的变化或变动，这里无法对所有的实施方式予以穷举，凡是属于本发明的技术方案所引伸出的显而易见的变化或变动仍处于本发明的保护范围之列。
