标题title
一种基于自监督拼图模块的工业品异常检测方法
摘要abst
本发明属于工业视觉检测领域，具体涉及一种基于自监督拼图模块的工业品异常检测方法。本发明一方面针对物体的形状特征引入了拼图问题的损失函数，对预训练模型进行微调来识别物体的形状信息。另一方面引入了全新的多尺度频率通道自注意力模块—MFCSAM，模块由多尺度特征提取模块、频率通道注意力模块与自注意力模块组合而成，通过此模块提高了模型获取全局信息的能力。随后搭建基于多维高斯分布的图像异常检测模型，利用MVTec训练数据集对图像异常检测模型进行训练，建立每个类别中无缺陷图像各个位置的多维高斯分布矩阵。在MVTec AD测试数据集上的实验表明，我们提出的方法可以获取更全面更丰富的特征信息，具备更好的异常检测效果。
权利要求书clms
1.一种基于自监督拼图模块的工业品异常检测方法，其特征在于，包括如下步骤： 利用公开纹理数据集和可控泊松噪声对MVTec工业品异常检测中用于训练的无缺陷数据集进行缺陷生成操作，得到合成缺陷图像训练数据集； 搭建一个由拼图分类网络组成的自监督异常拼图模型； 使用基于ImageNet的预训练网络和合成缺陷图像训练数据集对自监督异常拼图模型进行训练，学习工业品的形状信息，输出微调后的预训练网络； 搭建一个基于多维高斯分布的图像异常检测模型，所述图像异常检测模型包括微调后的预训练网络和多维高斯分布模块，首先对微调后的预训练网络输出的特征进行融合，随后输入到多维高斯分布模块中；其中，多维高斯分布模块用于建立每个类别中无缺陷图像各个位置的多维高斯分布矩阵； 利用MVTec训练数据集对图像异常检测模型进行训练； 工业品表面图像的异常定位与检测： 将MVTec测试集中t类别的图像输入训练好的图像异常检测模型中，其通过微调后的预训练网络输出测试特征，通过逐像素计算测试特征与步骤5中得到的无缺陷图像多维高斯分布矩阵之间的马氏距离，得到用于异常定位的像素级异常得分图M，取M中的最大值作为异常检测的图像级异常得分S'； 计算MVTec训练集中t类别的所有无缺陷图像的图像级异常得分S'，取其中最大的值作为阈值，比较测试图像的图像级异常得分S'与阈值τ，如果S＞τ则该测试图为异常缺陷图像，否则为无缺陷图像。2.如权利要求1所述的一种基于自监督拼图模块的工业品异常检测方法，其特征在于：步骤的具体实现方式如下； 通过向二维泊松噪声P中加入圆形渐变过滤器，获得噪声大小和位置随机的缺陷噪声掩码MP，随后对输入训练图像进行二值化获取物体前景掩码Mf，对Mf和MP取并集将噪声掩码MP固定于物体前景； 随机挑选公开纹理数据集DTD中的纹理图R与MP点乘获得包含纹理信息的缺陷DR； 将缺陷DR与工业品图像I点乘获取最终的合成缺陷图像，并将合成缺陷图像与原无缺陷图联合组成为合成图像训练数据集。3.如权利要求2所述的一种基于自监督拼图模块的工业品异常检测方法，其特征在于：步骤中加入圆形渐变过滤器如下：所述圆形渐变过滤器长宽与输入图像长宽一致，每个像素位置的值计算公式为，其中xp和yp为控制缺陷大小和位置的参数，w和h分别为图像的宽和高，随后对该过滤器的数值进行归一化即可得到最终的圆形渐变过滤器。4.如权利要求1所述的一种基于自监督拼图模块的工业品异常检测方法，其特征在于：步骤的具体实现方式如下； 使用n×n网格对合成图像训练数据集中的图片进行切分并将这些小网格打乱次序重新放入n2网格，在n2!种组合里，随机选择P种组合，并将这些组合索引作为每个网格的次序； 假设数据集中t类别包含Nt张图片，针对Nt张有标签的拼图实例定义拼图分类任务，其中/＞是重新排序后的训练样本，/＞是相关的次序索引，该自监督异常拼图分类模型任务的目标是最小化拼图损失/＞，其中/＞为标准的交叉熵损失，h为预测拼图位置索引的基于ImageNet的预训练模型，该模型中θf和θp分别代表卷积网络和最终全连接层的参数，计算得到一轮损失后利用Adam反向传播优化算法训练θf和θp，完成其一次训练； 执行直到交叉熵损失函数收敛，停止迭代，得到学习到图像形状信息的微调预训练网络。5.如权利要求4所述的一种基于自监督拼图模块的工业品异常检测方法，其特征在于：步骤的拼图分类网络结构与损失函数如下：该拼图分类网络使用wide_resnet50_2预训练网络h进行特征抽取，其中残差模块仅取第三层的结果作为最终预测的线性回归层的输入，输出特征为拼图分类的预测位置索引；计算拼图分类网络的预测值与输入的真实图像位置索引/＞之间的交叉熵损失/＞，公式如下：。6.如权利要求1所述的一种基于自监督拼图模块的工业品异常检测方法，其特征在于：步骤的具体实现方式如下； 图像I经过微调后预训练网络得到三个不同等级的特征X1,X2,X3，进行分布式融合处理用于计算无缺陷图像的高斯分布，在进入高斯分布模块之前，为了对多级别的特征进行充分融合，提出一个多尺度频率通道自注意力模块用于从多个尺度上学习小面积缺陷以及形状特征信息这些高级特征信息，该模块将三个特征拼接后输出融合特征Y；模型训练的目的是学习到Nt张图片中的每个像素的多维高斯分布，首先将Nt张图片的/＞处的融合特征/＞联合在一起组成该像素点特征为，计算/＞的均值得到多维高斯分布中的/＞，随后计算/＞的协方差得到多维高斯分布中的/＞； 执行直至计算完毕所有像素点的多维高斯分布，停止训练，得到该类别中所有无缺陷图像的多维高斯分布，建立多维高斯分布矩阵。7.如权利要求6所述的一种基于自监督拼图模块的工业品异常检测方法，其特征在于：在步骤中对特征X1,X2,X3进行分布式融合处理的过程如下：对X1使用一个1×1的卷积核获取其深层信息C，同时利用多尺度频率自注意力模块MFCSAM从多个通道、多个维度上获取其全局信息M1= MFCSAM，随后将C与M1结合获得更全面的低级特征；Y1= C + M1考虑到计算量与模型性能的平衡性，对X2保持不变，用来保留中级特征的信息；Y2= X2对X3利用 MFCSAM获取最高级最丰富的特征信息；Y3= MFCSAM最后，将处理后的特征Y1,Y2,Y3拼接后输出融合特征Y；对于多尺度频率自注意力模块，输入特征经过分别使用大小不同的卷积核获得4个具备不同感受野的特征xi1，其中第i1个卷积核大小为ki= 2 ×  + 1，之后对这四个不同大小感受野的特征进行处理：首先将xi1送入FCA注意力模块中从空间域转换到频域获取更全面的通道特征/＞，让zi1经过3个卷积层分别获取3个新特征图P,K和V，其中/＞，随后转置变形为/＞，此时/＞，其中，C1是通道数，W1和H1分别是此时特征图的宽度和高度；令P与K矩阵相乘再进行softmax处理得到位置注意力图/＞，随后将S转置与V矩阵相乘获得具备全局信息的注意力特征，最后将具备不同感受野的特征Ej1级联获得最终具备多尺度全局丰富信息的特征E；；其中，j1取值为1至s，s表示分量的个数，取4。8.如权利要求6所述的一种基于自监督拼图模块的工业品异常检测方法，其特征在于：步骤中均值的计算公式为，；样本协方差矩阵的计算公式为，；其中正则化项使样本协方差矩阵/＞满秩且可逆。9.如权利要求6所述的一种基于自监督拼图模块的工业品异常检测方法，其特征在于：步骤中测试特征与无缺陷图像多维高斯分布矩阵的马氏距离计算公式如下：；其中，z表示测试集中t类别的图像，为多维高斯分布的均值即为该类别所有无缺陷图像的融合特征/＞的均值，/＞为多维高斯分布的协方差即为该类别所有无缺陷图像的融合特征/＞的协方差，/＞表示在像素级异常得分图中第i行第j列处的异常得分。/＞
说明书desc
技术领域本发明属于工业视觉检测领域，具体涉及无监督异常检测下对带有形状特征的工业品缺陷进行准确识别与精准定位分割的图像方法。背景技术在抽象层面上，异常被定义为不符合预期正常行为的模式，因此异常检测指的是在数据中发现不符合预期行为的模式的问题。因为异常检测的训练数据是正常样本，仅需少量异常样本用于测试，所以异常检测广泛应用于各种各样的应用，如信用卡欺诈检测、保险或医疗保健、网络安全入侵检测、安全关键系统的故障检测，以及对敌方活动的军事监视。工业品表面缺陷的自动化检测是智能制造的重要一环，然而，由于工业品缺陷数量少并且难以获取，普通的基于大量数据的机器学习方法无法解决该问题，同时由于工业品缺陷可量化的特点，无监督异常检测方法受到广泛关注。虽然异常检测方法不同，大多数方法中都有一项至关重要的步骤是：如何从正常数据中提取丰富的特征信息。近年来，基于ImageNet数据集的预训练模型已经广泛用于计算机视觉任务，同时也在异常检测任务中占据重要地位。特别的，大部分常用的预训练模型都是基于卷积神经网络架构设计而成，卷积神经网络通过卷积层与池化层学习权重参数，逐层激活局部特征，然后按层将这些特征拼接到一起，最后形成一个金字塔式的复杂特征，这些特征包含从低级特征到高级特征的信息。在异常检测领域中，当前的许多方法都使用预训练模型对图像提取特征。针对预训练特征，异常检测模型经过各自独特的方法学习无缺陷数据中具有区别性的特征，然后在推理阶段对测试数据与该特征的分布情况做对比得到异常评分。根据建立分布方法的不同，可以细分为基于概率密度的方法和基于距离的方法。基于概率密度的算法通过为特征图的每个点计算概率密度分布，计算测试特征与每个最近点的分布差为异常分数。PaDiM通过计算特征图的所有块算得概率密度分布，并使用距离公式计算异常得分。FYD通过对PaDiM 的特征做预对齐操作，利用粗糙对齐和细致对齐两个操作使每个位置的分布更接近平均情况，减少了由于方向不同造成的分布差异。CSFlow使用归一化流代替高斯分布计算每个位置更为丰富的概率分布情况，这使得异常数据与正常数据的分布差距更加明显。基于距离的方法为每个特征点找最具代表的特征信息，随后用特征图计算最近的特征点距离。Panda对特征使用knn聚类方法收集核心特征建立存储库，然后计算测试图特征与存储库特征的距离。PatchCore在Panda基础的上引入最近邻搜索方法优化建立存储库的步骤。Uninformed Students利用预训练无缺陷特征的最后一层训练教师网络，然后用软信息训练出模型轻量级的学生网络。如果测试图片为异常图片，那么由于学生网络的判别能力不如教师网络，所以两者的差异会大于正常样本。因为层数越多，图像语义信息越全面，所以MKD将中间层输出同样做了蒸馏，获得了更加丰富的信息。虽然上述基于预训练网络的方法在一定程度上解决了异常检测的基本问题。但是由于预训练模型造成的形状偏见问题也随之而来。随着对预训练模型的研究，卷积神经网络模型可能并不是从低等级的边角特征学起进而慢慢学习到整体形状的过程，而是会倾向于对局部的纹理信息产生偏好，仅通过局部纹理信息就做出判断，提取到的特征同样仅仅包含这些局部纹理信息，无法提取更加高级全面的包含形状的信息。但是，当处理特定任务时，高精度任务往往要求模型抽取到的特征更加全面且符合该任务的特点，在无监督异常检测任务中则需要尽量获取高级抽象特征，这种信息抽取能力对于现有的基于ImageNet卷积神经网络框架是极大的挑战。具体来说，当模型处理一些基于形状类别和形状信息明显的纹理类别时，都会显示出这样的问题，进而限制模型的整体检测效果。PatchCore在异常检测领域讨论了该问题的存在，由于信息抽取能力的局部纹理特征导致检测效果受到削弱，PatchCore 在实验中选择了丢弃某些低级特征，这种做法毫无疑问会导致高级特征的基础信息和一些小面积缺陷的特征信息丢失，无法解决这种由于预训练模型带来的伴随性问题。发明内容为了克服上述现有技术的不足，本发明介绍了一个基于拼图难题的自回归模块，该模块引入拼图难题使预训练模型对物体形状进行预适应，去抽取到更有利于形状识别的有效特征，随后对这些特征分层次有深度的挖掘丰富信息，通过对预训练模块和特征的专门处理，我们的模块能够帮助异常检测方法对形状特征强的数据具有更强的鲁棒性。为实现上述目的，本发明的技术方案包括如下：一种基于自监督拼图模块的工业品异常检测方法，包括如下步骤： 利用公开纹理数据集和可控泊松噪声对MVTec工业品异常检测中用于训练的无缺陷数据集进行缺陷生成操作，得到合成缺陷图像训练数据集； 搭建一个由拼图分类网络组成的自监督异常拼图模型； 使用基于ImageNet的预训练网络和合成缺陷图像训练数据集对自监督异常拼图模型进行训练，学习工业品的形状信息，输出微调后的预训练网络； 搭建一个基于多维高斯分布的图像异常检测模型，所述图像异常检测模型包括微调后的预训练网络和多维高斯分布模块，首先对微调后的预训练网络输出的特征进行融合，随后输入到多维高斯分布模块中；其中，多维高斯分布模块用于建立每个类别中无缺陷图像各个位置的多维高斯分布矩阵； 利用MVTec训练数据集对图像异常检测模型进行训练； 工业品表面图像的异常定位与检测： 将MVTec测试集中t类别的图像输入训练好的图像异常检测模型中，其通过微调后的预训练网络输出测试特征，通过逐像素计算测试特征与步骤5中得到的无缺陷图像多维高斯分布矩阵之间的马氏距离，得到用于异常定位的像素级异常得分图M，取M中的最大值作为异常检测的图像级异常得分S'； 计算MVTec训练集中t类别的所有无缺陷图像的图像级异常得分S'，取其中最大的值作为阈值，比较测试图像的图像级异常得分S'与阈值τ，如果S＞τ则该测试图为异常缺陷图像，否则为无缺陷图像。进一步的，步骤的具体实现方式如下； 通过向二维泊松噪声P中加入圆形渐变过滤器，获得噪声大小和位置随机的缺陷噪声掩码MP，随后对输入训练图像进行二值化获取物体前景掩码Mf，对Mf和MP取并集将噪声掩码MP固定于物体前景； 随机挑选公开纹理数据集DTD中的纹理图R与MP点乘获得包含纹理信息的缺陷DR；1c) 将缺陷DR与工业品图像I点乘获取最终的合成缺陷图像，并将合成缺陷图像与原无缺陷图联合组成为合成图像训练数据集。进一步的，步骤中加入圆形渐变过滤器如下：所述圆形渐变过滤器长宽与输入图像长宽一致，每个像素位置的值计算公式为，其中xp和yp为控制缺陷大小和位置的参数，w和h分别为图像的宽和高，随后对该过滤器的数值进行归一化即可得到最终的圆形渐变过滤器。进一步的，步骤的具体实现方式如下； 使用n×n网格对合成图像训练数据集中的图片进行切分并将这些小网格打乱次序重新放入n2网格，在n2!种组合里，随机选择P种组合，并将这些组合索引作为每个网格的次序； 假设数据集中t类别包含Nt张图片，针对Nt张有标签的拼图实例定义拼图分类任务，其中/＞是重新排序后的训练样本，/＞是相关的次序索引，该自监督异常拼图分类模型任务的目标是最小化拼图损失/＞，其中/＞为标准的交叉熵损失，h为预测拼图位置索引的基于ImageNet的预训练模型，该模型中θf和θp分别代表卷积网络和最终全连接层的参数，计算得到一轮损失后利用Adam反向传播优化算法训练θf和θp，完成其一次训练； 执行直到交叉熵损失函数收敛，停止迭代，得到学习到图像形状信息的微调预训练网络。进一步的，步骤的拼图分类网络结构与损失函数如下：该拼图分类网络使用wide_resnet50_2预训练网络h进行特征抽取，其中残差模块仅取第三层的结果作为最终预测的线性回归层的输入，输出特征为拼图分类的预测位置索引；计算拼图分类网络的预测值与输入的真实图像位置索引/＞之间的交叉熵损失/＞，公式如下：。进一步的，步骤的具体实现方式如下； 图像I经过微调后预训练网络得到三个不同等级的特征X1,X2,X3，进行分布式融合处理用于计算无缺陷图像的高斯分布，在进入高斯分布模块之前，为了对多级别的特征进行充分融合，提出一个多尺度频率通道自注意力模块用于从多个尺度上学习小面积缺陷以及形状特征信息这些高级特征信息，该模块将三个特征拼接后输出融合特征Y；模型训练的目的是学习到Nt张图片中的每个像素的多维高斯分布，首先将Nt张图片的/＞处的融合特征/＞联合在一起组成该像素点特征为/＞，计算/＞的均值得到多维高斯分布中的/＞，随后计算/＞的协方差得到多维高斯分布中的/＞； 执行直至计算完毕所有像素点的多维高斯分布，停止训练，得到该类别中所有无缺陷图像的多维高斯分布，建立多维高斯分布矩阵。进一步的，在步骤中对特征X1,X2,X3进行分布式融合处理的过程如下：对X1使用一个1×1的卷积核获取其深层信息C，同时利用多尺度频率自注意力模块MFCSAM从多个通道、多个维度上获取其全局信息M1= MFCSAM，随后将C与M1结合获得更全面的低级特征；Y1= C + M1考虑到计算量与模型性能的平衡性，对X2保持不变，用来保留中级特征的信息；Y2= X2对X3利用 MFCSAM获取最高级最丰富的特征信息；Y3= MFCSAM最后，将处理后的特征Y1,Y2,Y3拼接后输出融合特征Y；对于多尺度频率自注意力模块，输入特征经过分别使用大小不同的卷积核获得4个具备不同感受野的特征xi1，其中第i1个卷积核大小为ki= 2 ×  + 1，之后对这四个不同大小感受野的特征进行处理：首先将xi1送入FCA注意力模块中从空间域转换到频域获取更全面的通道特征/＞，让zi1经过3个卷积层分别获取3个新特征图P, K和V，其中/＞，随后转置变形为/＞，此时/＞，其中，C1是通道数，W1和H1分别是此时特征图的宽度和高度；令P与K矩阵相乘再进行softmax处理得到位置注意力图/＞，随后将S转置与V矩阵相乘获得具备全局信息的注意力特征，最后将具备不同感受野的特征Ej1级联获得最终具备多尺度全局丰富信息的特征E；其中，j1取值为1至s，s表示分量的个数，取4。进一步的，步骤中均值的计算公式为，样本协方差矩阵的计算公式为，其中正则化项使样本协方差矩阵/＞满秩且可逆。进一步的，步骤中测试特征与无缺陷图像多维高斯分布矩阵的马氏距离计算公式如下：其中，z表示测试集中t类别的图像，为多维高斯分布的均值即为该类别所有无缺陷图像的融合特征/＞的均值，/＞为多维高斯分布的协方差即为该类别所有无缺陷图像的融合特征/＞的协方差，/＞表示在像素级异常得分图中第i行第j列处的异常得分。与现有技术相比，本发明的有益效果是：基于拼图难题的自监督注意力模块同时考虑形状和纹理信息，专门设计了自监督异常拼图模块对基于ImageNet的预训练模型进行形状信息的学习识别，并且针对纹理特征设计了预训练特征注意力融合模块提高模型获取多尺度全局通道信息的能力，因此使模型在训练阶段能够学习到更具有代表性的信息，进而提高模型的异常检测与定位效果。附图说明图1为本发明的整体技术流程图。图2为本发明的图像异常检测模型图。图3为本发明的预训练特征整体框架图。具体实施方式下面结合附图对本发明进一步说明。如图1所示，本发明的总体实现流程如下：步骤1，利用可控泊松噪声和纹理数据集对MVTec AD工业品异常检测中用于训练的每一张无缺陷数据集进行缺陷生成操作，得到合成缺陷图像训练数据集。1.1）随机生成二维泊松噪声P，向其中加入圆形渐变过滤器，获得噪声大小和位置随机的缺陷噪声掩码MP。所述圆形渐变过滤器长宽与输入图像长宽一致，每个像素位置的值计算公式为，其中xp和yp为控制缺陷大小和位置的参数，w和h分别为图像的宽和高，随后对该过滤器的数值进行归一化即可得到最终的圆形渐变过滤器。获取公开的工业品图像数据集MVTec AD。由于该数据集中的图像物体本身所占的空间较小，所以我们并非直接对整张图像添加缺陷噪声。我们先对输入图像进行二值化获取物体前景掩码Mf，随后对Mf和MP取并集将噪声掩码MP固定于物体前景。1.2）获取公开纹理数据集DTD中的各类纹理数据，随机挑选其中的纹理图R与MP点乘获得包含纹理信息的缺陷DR。1.3）将缺陷DR与工业品图像点乘获取最终的合成缺陷图像，并将合成缺陷图像与原无缺陷图联合组成为合成图像训练数据集。步骤2，搭建一个由拼图分类网络组成的自监督异常拼图模型。所述拼图分类网络使用公开的预训练wide_resnet50_2网络h进行特征抽取，其中残差模块仅取第三层的结果作为最终预测的线性回归层的输入，输出特征为拼图分类的预测位置索引；计算拼图分类网络的预测值与输入的真实图像位置索引/＞之间的交叉熵损失/＞，公式如下：/＞步骤3，利用基于ImageNet的预训练网络和合成图像训练数据集对拼图模型进行训练以学习工业品中基于形状的信息，模型输出微调后的预训练网络；3.1）对于基于形状的数据类别，我们使用n×n网格对合成图像训练数据集中的该类别图片进行切分并将这些小网格打乱次序重新放入n2网格，在n2!种组合中随机选择P种组合，并将这些组合索引作为每个网格的次序。.2）数据集中某基于形状的t类别包含Nt张图片，针对于Nt有标签的拼图实例定义拼图分类任务，其中/＞是重新排序后的训练样本，/＞是相关的次序索引。该自监督异常拼图分类模型任务的目标是最小化拼图损失/＞，其中/＞为标准的交叉熵损失，h为预测拼图位置索引的基于ImageNet的预训练模型，该模型中θf和θp分别代表卷积网络和最终全连接层的参数。计算得到一轮损失后利用Adam反向传播优化算法训练θf和θp，完成其一次训练；3.3）执行拼图分类模型训练直到交叉熵损失函数收敛，停止迭代，得到相应类别学习到图像形状信息的微调预训练网络；步骤4，搭建一个基于多维高斯分布的图像异常检测模型。参照图2，所述图像异常检测模型包括预训练网络和多维高斯分布模块，其中预训练网络采用步骤3中得到的微调后预训练网络，首先对微调后的预训练网络输出的特征进行融合然后输入到多维高斯分布模块中，通过对训练图像集进行参数估计，建立多维高斯分布矩阵。步骤5，使用预训练网络和MVTec训练数据集对图像异常检测模型进行训练，对于基于形状的类别使用对应类别微调后的预训练网络：5.1）图像经过预训练网络后得到三个不同等级的特征X1,X2,X3，对预训练特征X1,X2,X3进行分布式融合处理用于计算无缺陷图像的高斯分布。如图3所示，为了对多级别的特征充分学习，对预训练特征X1,X2,X3进行分布式融合处理：首先对X1使用一个1×1的卷积核获取其深层信息C，同时利用多尺度频率自注意力模块从多个通道、多个维度上获取其全局信息M1= MFCSAM。随后我们将C与M1结合获得更全面的低级特征。Y1= C + M1考虑到计算量与模型性能的平衡性，对X2保持不变，用来保留中级特征的信息；Y2= X2对X3利用 MFCSAM获取最高级最丰富的特征信息。Y3= MFCSAM所述多尺度频率自注意力模块中输入特征经过大小不同的卷积核获得4个具备不同感受野的特征/＞，其中第i个卷积核大小为ki= 2 ×  + 1，之后对这四个不同大小感受野的特征进行处理：首先将/＞送入FCA注意力模块中从空间域转换到频域获取更全面的通道特征/＞，让/＞经过3个卷积层分别获取3个新特征图P, K和V，其中/＞，随后转置变形为/＞，此时/＞，其中，C1是通道数，这里的C/4是因为有4个分量，所以先除4，后面拼接在一起后就是正常的C通道，W1和H1分别是此时特征图的宽度和高度；令P与K矩阵相乘再进行softmax处理得到位置注意力图/＞，随后将S转置与V矩阵相乘获得具备全局信息的注意力特征/＞。最后将具备不同感受野的特征/＞级联获得最终具备多尺度全局丰富信息的特征E。该多尺度频率通道自注意力模块可以从多个尺度上学习小面积缺陷以及形状特征信息等高级特征信息。最终我们将处理后的预训练特征Y1,Y2,Y3拼接后输出融合特征Y。5.2）图像异常检测模型训练的目的是学习到该类别Nt张无缺陷图片中的每个像素的多维高斯分布。首先将Nt张图片的融合特征/＞联合在一起组成该点特征为/＞，计算/＞的均值得到多维高斯分布中的均值/＞：随后计算的协方差得到多维高斯分布中的样本协方差矩阵/＞：其中正则化项使样本协方差矩阵/＞满秩且可逆。5.3）执行异常检测模型训练直至计算完毕所有像素点的多维高斯分布，停止训练，得到该类别中所有无缺陷图像的多维高斯分布，建立该类别中无缺陷图像各个位置的多维高斯分布矩阵。步骤6，对工业品表面图像进行测试数据集的异常定位与检测：6.1）将MVTec测试集中t类别的图像z输入训练好的图像异常检测模型中，其通过t类别对应的预训练网络和多尺度频率通道自注意力模块输出测试特征Yz，通过逐像素计算测试特征与步骤5中得到的该类别无缺陷图像多维高斯分布矩阵之间的马氏距离得到用于异常定位的像素级异常得分图/＞：其中，W和H分别为像素级异常得分图的宽和高，表示在像素级异常得分图中第i行第j列处的异常得分。此时异常检测的图像级异常得分S就是M中的最大值。6.2）计算MVTec训练集中t类别的Nt张无缺陷图像的图像级异常得分S。取其中最大的值作为阈值。在进行测试时，比较测试图像的图像级异常得分S与阈值τ，如果S＞τ则该测试图为异常缺陷图像，否则为无缺陷图像。接下来我们通过具体的仿真实验对发明效果进行阐述：本次仿真实验具体硬件设备为：显卡Nvidia RTX 3080TiCPU，平台12th GenIntel Core i7-12700 t；本次仿真实验具体软件环境为：Ubuntu16.04操作系统，Pytorch1.10.0，Python3.7；实验使用的MVTec AD数据集是一个用于评估工业品表面缺陷异常检测与定位效果的基准数据集，包含 15 个子数据集，共有 5354 张图像，其中测试集有1725张图片。每个子数据集都分为正常的训练数据和测试集，其中测试集包含针对具有各种缺陷类型的产品类别的正常和异常样本以及各自的异常缺陷掩码。该数据集使用AUROC作为评判标准，具体来说使用异常检测与定位两个性能指标对本专利提出的方法进行实验比较，其值介于0％-100％，值越大则效果越好。通过PatchCore和CFA中的预训练模型对比结果，我们在实验过程中所有模型的预训练网络都选择基于ImageNet的wide_resnet50_2。为了更好的保留预训练特征，实验统一取前三层的卷积层结果作为特征图。由于本次实验的输入图片像素普遍大于900x900，为了降低计算量，我们将图片像素裁剪到224x224。仿真实验1，将本发明方法与当前流行的4种异常检测方法在MVTec AD数据集上进行对比。表 1.五种异常检测方法实验结果表如表1所示，除了在基于纹理类别的定位任务平均值上略低于PaDiM方法外，基于自监督拼图模块的图像异常检测方法在检测和定位任务上的AUROC值都高于其他方法。与PaDiM相比，本专利方法在整体结果的检测任务上提高了0.93%。仿真实验2，为了说明各个模块的有效性，实验选择PatchCore和CFA模型作为基准模型用于测试本专利方法中各模块在异常检测上的嵌入效果。表2.两种异常检测模型原始结果与加入本专利方法后的实验结果表如表2中给出实验结果所示，在基于纹理的类别结果中可以看到，两个异常检测模型在加入拼图模块后都有一定程度的提升，其中PatchCore模型中针对MVTec AD的检测效果上获得了0.64%的提高。在CFA模型中，由于模型利用了所有层的特征，并且具备特定任务的自适应性，所以更加适合我们针对纹理与形状的任务，表现效果也是最好的。证明本发明中的拼图模块与异常检测模块可以很好的对现有方法进行即插即用，并且效果上都有一定提高。综合以上实验结果，证明了本发明提出的方法可以帮助模型获取更全面更丰富的特征信息，具备更好的异常检测效果。
