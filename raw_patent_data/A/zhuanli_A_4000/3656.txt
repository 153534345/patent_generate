标题title
一种基于长视野特征融合的棘波检测方法及系统
摘要abst
本发明公开了一种基于长视野特征融合的棘波检测方法及系统，包括如下步骤：S1：对采集的癫痫病人发作间期的脑磁图数据进行预处理；S2：对预处理后的脑磁图数据提取单通道波形特征，并在长视野范围内对所述单通道波形特征进行归一化操作得到长视野归一化特征；S3：将所述长视野归一化特征对应到脑磁图数据的每个点上进行拼接，得到融合的多通道特征数据矩阵；S4：将重组后的四维切片多通道多特征数据矩阵输送到已训练完成的注意力模型中以输出每个切片中每个点是否为棘波的预测矩阵，将预测矩阵组合为预测序列；S5：对预测序列采用非极大值抑制操作，最终得到预测棘波时刻点序列；该棘波检测方法及系统提升了棘波检测的准确率。
权利要求书clms
1.一种基于长视野特征融合的棘波检测方法，其特征在于，包括如下步骤：S1：对采集的癫痫病人发作间期的脑磁图数据进行预处理；S2：对预处理后的脑磁图数据提取单通道波形特征，并在长视野范围内对所述单通道波形特征进行归一化操作得到长视野归一化特征；S21：对每个预处理后的脑磁图数据进行滑窗平滑操作，取平滑数据的局部极大值作为波峰，取平滑数据的局部极小值作为波谷，两个波谷之间的部分定义为一个正向波，两个波峰之间的区域定义为一个负向波；S22：遍历滑窗平滑操作，得到波形的几何特征数据并确定单通道波形特征，所述单通道波形特征包括波形振幅、波形上升斜率、波形下降斜率和波形锐度；S23：在长视野下对所述单通道波形特征进行归一化操作，得到长视野归一化特征；S3：将所述长视野归一化特征对应到脑磁图数据的每个点上进行拼接，得到融合的多通道特征数据矩阵；S31：将所述长视野归一化特征分别复制扩展到正向波和负向波的覆盖范围，得到时间维度长度和所述脑磁图数据一致的归一化特征数据；S32：将所述脑磁图数据、所述几何特征数据、所述归一化特征数据在特征维度拼接，得到单通道数据矩阵；S33：将所述单通道数据矩阵在通道维度进行拼接，得到三维多通道数据矩阵；S34：将所述三维多通道数据矩阵在时间维度进行切片，切片长度M，相邻的两个切片重叠K，将所有切片并行拼接得到四维切片多通道数据矩阵；S35：将得到的四维切片多通道数据矩阵进行矩阵重组，得到重组后的四维切片多通道数据矩阵；S4：将重组后的四维切片多通道多特征数据矩阵输送到已训练完成的注意力模型中以输出每个切片中每个点是否为棘波的预测矩阵，将预测矩阵组合为与所述脑磁图数据时间长度一致的预测序列；S5：对预测序列采用非极大值抑制操作，最终得到与所述脑磁图数据对应的预测棘波时刻点序列。2.根据权利要求1所述的基于长视野特征融合的棘波检测方法，其特征在于，在步骤S1中，所述预处理包括带通滤波、去心电伪迹，重采样，归一化，具体包括：对采集的癫痫病人发作间期的脑磁图数据通过3Hz-40Hz的带通滤波参数进行带通滤波处理；对带通滤波处理处理后的数据通过ICA分解去除伪迹分量算法进行去心跳伪迹处理；对去心跳伪迹处理的数据通过250Hz的重采样参数进行重采样操作；对重采样操作后的数据通过梯度计和磁力计进行归一化操作，得到预处理后的脑磁图数据。3.根据权利要求1所述的基于长视野特征融合的棘波检测方法，其特征在于，在步骤S22中，所述几何特征的时间维度长度和脑磁图数据一致，设定相邻波峰和波谷的磁场强度差50%位置为腰点，其中波峰取值为1，波谷取值为-1，腰点取值为0，波峰和腰点中间区域取值为0.5，波谷和腰点中间区域取值为-0.5。4.根据权利要求1所述的基于长视野特征融合的棘波检测方法，其特征在于，在步骤S22中，所述单通道波形特征具体包括：正向波的波形振幅为波峰到左右波谷连线的垂直距离，负向波的波形振幅为波谷到左右波峰连线的垂直距离；正向波的波形上升斜率为波峰和左波谷的磁场强度差除以波峰和左波谷的间隔时间；负向波的波形上升斜率为波谷和右波峰的磁场强度差除以波谷和右波峰的间隔时间；正向波的波形下降斜率为波峰和右波谷的磁场强度差除以波峰和右波谷的间隔时间；负向波的波形下降斜率为波谷和左波峰的磁场强度差除以波谷和左波峰的间隔时间；正向波的波形锐度为波峰处的二阶导数；负向波的波形锐度为波谷处的二阶导数。5.根据权利要求1所述的基于长视野特征融合的棘波检测方法，其特征在于，在步骤S23中，具体包括：设定长视野的时间尺度Q；对于时刻处的单通道波形特征/＞，取，或简称MEG，是通过对脑内神经电流发出的极其微弱的生物磁场信号的直接测量，无创伤性地探测大脑电磁生理信号的脑功能检测技术。相比头皮脑电图，脑磁图所采集的磁性号受组织传导干扰小，传感器更多，对癫痫灶定位更加精确；相比颅内脑电图、立体脑电图，脑磁图成像全面且对病人完全无害，减少病人的痛苦和额外风险。由于种种优势，目前脑磁图检查在癫痫灶手术定位上被广泛使用。发作间期癫痫样放电，以棘波为代表，是一种癫痫生理标志，通常认为能够显示致痫灶。目前临床上主要是通过医生手工标注棘波时刻点，但脑磁图数据量很大，手工标注效率低，多有遗漏，且主观性很强，依赖于医生的诊疗水平，为此产生了多种棘波检测辅助算法，如阈值法、模板匹配法、特征工程+传统机器学习、深度学习等。阈值法通过棘波的高振幅特征从原始信号中筛选棘波，模板匹配法通过先验的棘波形态从原始信号中筛选棘波，这两种方法可解释性强、支持人工交互、自适应调节。但因为模型简单，难以概况复杂的波形数据，对伪迹、非典型棘波等情况检测精度较差。特征工程+传统机器学习的算法中，时域、频域、小波域特征及其融合的方式种类繁多，现有的论文多在自己准备的小规模数据上进行精细调参，但通常特征工程的迁移性不佳，泛化能力不强，也无法满足临床实际需要。深度学习是近年来兴起的技术，具有代表性的两种技术框架RNN和CNN在棘波检测中也有部分运用，这两种模型都是时间序列建模，对多通道融合效果不佳，并且模型运算量较大，通常只聚焦局部视野。发明内容基于背景技术存在的技术问题，本发明提出了一种基于长视野特征融合的棘波检测方法及系统，长视野特征融合能大幅改善数据切片信息不足的问题，提升了棘波检测的准确率，减少了预测的假阳率。本发明提出的一种基于长视野特征融合的棘波检测方法，包括如下步骤：S1：对采集的癫痫病人发作间期的脑磁图数据进行预处理；S2：对预处理后的脑磁图数据提取单通道波形特征，并在长视野范围内对所述单通道波形特征进行归一化操作得到长视野归一化特征；S21：对每个预处理后的脑磁图数据进行滑窗平滑操作，取平滑数据的局部极大值作为波峰，取平滑数据的局部极小值作为波谷，两个波谷之间的部分定义为一个正向波，两个波峰之间的区域定义为一个负向波；S22：遍历滑窗平滑操作，得到波形的几何特征数据并确定单通道波形特征，所述单通道波形特征包括波形振幅、波形上升斜率、波形下降斜率和波形锐度；S23：在长视野下对所述单通道波形特征进行归一化操作，得到长视野归一化特征；S3：将所述长视野归一化特征对应到脑磁图数据的每个点上进行拼接，得到融合的多通道特征数据矩阵；S31：将所述长视野归一化特征分别复制扩展到正向波和负向波的覆盖范围，得到时间维度长度和所述脑磁图数据一致的归一化特征数据；S32：将所述脑磁图数据、所述几何特征数据、所述归一化特征数据在特征维度拼接，得到单通道数据矩阵；S33：将所述单通道数据矩阵在通道维度进行拼接，得到三维多通道数据矩阵；S34：将所述三维多通道数据矩阵在时间维度进行切片，切片长度M，相邻的两个切片重叠K，将所有切片并行拼接得到四维切片多通道数据矩阵；S35：将得到的四维切片多通道数据矩阵进行矩阵重组，得到重组后的四维切片多通道数据矩阵；具体矩阵重组过程为：将四维切片多通道数据矩阵的磁力计通道和空间位置对应的两个梯度计通道进行重组，从通道维度并列改到特征维度并列；S4：将重组后的四维切片多通道数据矩阵输送到已训练完成的注意力模型中以输出每个切片中每个点是否为棘波的预测矩阵，将预测矩阵组合为与所述脑磁图数据时间长度一致的预测序列；S5：对预测序列采用非极大值抑制操作，最终得到与所述脑磁图数据对应的预测棘波时刻点序列。进一步地，在步骤S1中，所述预处理包括带通滤波、去心电伪迹，重采样，归一化，具体包括：对采集的癫痫病人发作间期的脑磁图数据通过3Hz-40Hz的带通滤波参数进行带通滤波处理；对带通滤波处理处理后的数据通过ICA分解去除伪迹分量算法进行去心跳伪迹处理；对去心跳伪迹处理的数据通过250Hz的重采样参数进行重采样操作；对重采样操作后的数据通过梯度计和磁力计进行归一化操作，得到预处理后的脑磁图数据。进一步地，在步骤S22中，所述几何特征的时间维度长度和脑磁图数据一致，设定相邻波峰和波谷的磁场强度差50%位置为腰点，其中波峰取值为1，波谷取值为-1，腰点取值为0，波峰和腰点中间区域取值为0.5，波谷和腰点中间区域取值为-0.5。进一步地，在步骤S22中，所述单通道波形特征具体包括：正向波的波形振幅为波峰到左右波谷连线的垂直距离，所述负向波的波形振幅为波谷到左右波峰连线的垂直距离；正向波的波形上升斜率为波峰和左波谷的磁场强度差除以波峰和左波谷的间隔时间；负向波的波形上升斜率为波谷和右波峰的磁场强度差除以波谷和右波峰的间隔时间；正向波的波形下降斜率为波峰和右波谷的磁场强度差除以波峰和右波谷的间隔时间；负向波的波形下降斜率为波谷和左波峰的磁场强度差除以波谷和左波峰的间隔时间；正向波的波形锐度为波峰处的二阶导数；负向波的波形锐度为波谷处的二阶导数。进一步地，在步骤S23中，具体包括：设定长视野的时间尺度Q；对于时刻处的特征/＞，取s至s内所有单通道波形特征计算均值mean和标准差std，长视野范围选择的时间越长，特征更能代表整体时间尺度上的显著性，选择的时间越短，特征更能体现局部显著性。S3：将所述长视野归一化特征对应到脑磁图数据的每个点上进行拼接，得到融合的多通道特征数据矩阵，具体包括步骤S31至S34。S31：将所述长视野归一化特征分别复制扩展到正向波和负向波的覆盖范围，得到时间维度长度和所述脑磁图数据一致的归一化特征数据；以正向波为例，波峰左右腰点的中间区域定义为该正向波的覆盖范围，将步骤23中得到的所有波形的长视野归一化特征复制扩展到该波的覆盖范围内，得到时间维度长度和原始脑磁图数据一致的归一化特征数据，数据可视化如附图4所示。S32：将所述脑磁图数据、所述几何特征数据、所述归一化特征数据在特征维度拼接，得到时间长度T，特征个数5的单通道数据矩阵；例如，对于一个400s时间的原始脑磁图数据，通过重采样250Hz后单通道采样点个数为100000个点，所以数据矩阵大小为。S33：将所述单通道数据矩阵在通道维度进行拼接，得到通道个数306，时间长度T，特征个数5的三维多通道数据矩阵；对于正常的306通道医科达设备脑磁图400s数据，三维数据矩阵大小为。S34：将所述三维多通道数据矩阵在时间维度进行切片，切片长度M，相邻的两个切片重叠K，将所有切片并行拼接得到四维切片多通道数据矩阵；其中M可以取1s，K可以取0.5s，即表示切片长度为1s，相邻的两个切片重叠0.5s，然后将所有切片并行拼接得到切片数量N，通道个数306，切片长度1s，特征个数5的四维切片多通道数据矩阵。例如：对于正常的306通道医科达设备脑磁图400s数据，重采样为250Hz时，四维切片多通道数据矩阵长度为。S35：将得到的四维切片多通道数据矩阵进行矩阵重组，得到重组后的四维切片多通道数据矩阵；将四维切片多通道数据矩阵的磁力计通道和其空间位置对应的两个梯度计通道进行重组，从通道维度并列改到特征维度并列。例如：对于S34中得到长的四维切片多通道数据矩阵，重组后的四维切片多通道数据矩阵变成。S4：将重组后的四维切片多通道多特征数据矩阵输送到已训练完成的注意力模型中以输出每个切片中每个点是否为棘波的预测矩阵，将预测矩阵组合为与所述脑磁图数据时间长度一致的预测序列；注意力模型是近年来在各个领域取得比RNN、CNN效果更好的深度学习模型，对于多通道之间的特征融合以及时间维度上的棘波特征增强具有很好的效果。注意力模型整体网络结构示意图如附图5所示，该网络结构分为多层，每层都包括依次连接的注意力模块组合和矩阵变换组合，第一层的注意力模块组合用于重组后的四维切片多通道多特征数据矩阵的输入，当前层的矩阵变换组合的输出与下一层的注意力模块组合的输入连接，最后一层的矩阵变换组合输出每个切片中每个点是否为棘波的预测矩阵。其中，注意力模块组合包括依次连接的时间注意力模块和通道注意力模块，多个时间注意力模块和多个通道注意力模块依次按序重复设置，矩阵变换组合包括依次连接的通道维度全连接模块、矩阵重组和特征维度全连接模块，第一层的注意力模块组合中第一个时间注意力模块的输入用于输入四维切片多通道多特征数据矩阵，通道维度全连接模块的输入连接到注意力模块组合中最后一个通道注意力模块的输出，上一层的特征维度全连接模块输出连接到下一层的第一个时间注意力模块的输入，最后一层的特征维度全连接模块输出每个切片中每个点是否为棘波的预测矩阵。在本实施例中，层数L取4。注意力模块组合由时间维度注意力模块和通道维度注意力模块多次串联组成。通道维度注意力模块如附图6所示，时间维度注意力模块如附图7所示，相比语音领域的注意力模块，脑磁图的注意力模块组合对其改进以处理多维输入数据，具体的，对于输入四维切片多通道多特征数据矩阵：，通道维度注意力模块只在通道维度和特征维度进行处理，在其他维度做并行计算，时间维度注意力模块只在时间维度和特征维度进行处理，在其他维度做并行计算。在本实例中，注意力模块组合均不改变输出矩阵长度；使用的激活函数为GRelu；第一层注意力模块组合的串联次数S为2，第二层注意力模块组合的串联次数S为4，第三层注意力模块组合的串联次数S为8，第四层注意力模块组合的串联次数S为6。矩阵变换组合的目的是改变输入四维切片多通道多特征数据矩阵的各维长度，首先通过通道维度全连接模块将通道维度进行升维，再通过矩阵重组操作，将通道维度重组到特征维度，最后再使用特征维度全连接模块对特征维度进行降维。在本实例中，使用的激活函数为GRelu；每次通过矩阵变换组合的四维矩阵长度为：第一层输入，输出；第二层输入，输出；第三层输入，输出，第四层输入，输出。第四层矩阵变换组合会将通道维度和特征维度均压缩至1，得到大小为的预测矩阵，简记为，采用sigmoid激活函数，值域为。所述注意力模型的训练过程如下步骤至。获取脑磁图癫痫数据集，并对脑磁图癫痫数据集中的脑磁图癫痫数据标注棘波时刻点序列，得到标注后的脑磁图癫痫数据集；可以通过经验丰富的临床医生标注脑磁图癫痫数据。将标注后的脑磁图癫痫数据集经过步骤S1至S3处理得到切片四维矩阵；步骤S1至S3对脑磁图癫痫数据的处理过程上所述，在此不赘述了。将标注的棘波时刻点序列处理成和所述脑磁图癫痫数据集中脑磁图癫痫数据时间长度一样的一维label矩阵，对得到的一维label矩阵进行切片操作得到二维label矩阵；具体方案为标记棘波时刻点所在的波形范围为正例区域，标记计为1；左右各扩展30ms为忽略区域，标记计为-1；其他区域为负例部分，标记计为0。对得到的一维label矩阵进行步骤S34同样的切片操作得到切片数量N，切片长度1s的二维label矩阵。根据交叉熵损失设计注意力模型的目标函数；其中，为二维label矩阵，/＞为二维预测矩阵，二维预测矩阵是脑磁图癫痫数据集处理后输入到注意力模型后输出的矩阵，/＞表示训练数据的切片维度下标，表示训练数据的时间维度下标。将所述切片四维矩阵输送到构建完成的注意力模型中，以二维label矩阵作为注意力模型预测输出棘波时刻的标签，采用随机梯度下降优化算法对所述注意力模型进行参数优化，以训练所述注意力模型；标注的棘波时刻点序列用于验证注意力模型输出的预测棘波时刻的准确率，以实现注意力模型的有效训练。最后使用验证集对训练后的注意力模型进行验证，如果输出满足预先设置的准确度阈值，则注意力模型训练完成，如果输出不满足预先设置的准确度阈值，则通过训练集对注意力模型继续训练，直至输出满足预先设置的准确度阈值，其中，训练集和验证集均为标注后的脑磁图癫痫数据。S5：对预测序列采用非极大值抑制操作，最终得到与所述脑磁图数据对应的预测棘波时刻点序列；具体为：棘波检测阈值可以从0-1中按实际情况挑选，默认0.5，对预测序列使用非极大值抑制算法，非极大值抑制算法的区间长度也可以按实际情况挑选，默认为100ms，使用非极大值抑制算法可以从全脑磁图预测序列中得到准确的预测棘波时刻点序列，该预测棘波时刻点序列可以直接提供给医生，极大的加速临床医生的脑磁图判读工作。根据步骤S1至S5，提供了一种基于长视野特征融合的棘波检测方法，长视野特征融合能大幅改善数据切片信息不足的问题，使得输入注意力模型的信息量不仅是切片范围内的短视野，而在于将长视野的特征显著性输入注意力模型中，更符合医生手工标注时的思维模式，提升了棘波检测的准确率，特别是对于短视野中和棘波类似，但长视野情况下不是棘波的波形有很好的识别作用。本发实施例提供一种注意力模型可以自适应选择需要关注多通道波形特征，对于通道维度的显著性特征识别具有良好的建模效果，并使用分割loss和非极大值抑制算法直接得到脑磁图棘波时刻点序列，这一技术有效提升了棘波检测的准确率，特别是减少了预测的假阳率。以上所述，仅为本发明较佳的具体实施方式，但本发明的保护范围并不局限于此，任何熟悉本技术领域的技术人员在本发明揭露的技术范围内，根据本发明的技术方案及其发明构思加以等同替换或改变，都应涵盖在本发明的保护范围之内。
