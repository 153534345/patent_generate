标题title
一种口腔种植手术配准方法、系统和存储介质
摘要abst
本发明提供了一种口腔种植手术配准方法、系统和存储介质，通过构建CT三维模型，获取对应的CT二维截面图像，识别配准小球所对应的配准圆斑，获取配准球体的CT三维坐标值，基于至少4个拟合所得的配准球体的CT三维坐标值将配准器模型匹配至CT三维模型上，根据凹坑的相机三维坐标值和CT三维坐标值，在CT三维坐标系和相机坐标系之间建立转换关系等进行配准。在扫描切割识别配准圆斑、基于配准圆斑获取配准球体的CT三维坐标值、基于凹坑的相机三维坐标值和CT三维坐标值进行配准等方面都更为清晰，现比现有技术中自动识别配准圆斑和自动生成配准球体，本方案在保证方案实现逻辑简单的基础上，提升配准的效率和准确率，从而有效保障种植精度和治疗效果。
权利要求书clms
1.一种口腔种植手术配准方法，其特征在于，包括以下步骤：S1.采集患者带有配准器的口腔CBCT数据，基于口腔CBCT数据构建CT三维模型，所述配准器上设置有多个配准小球和多个凹坑；S2.获取CT三维模型所对应的CT二维截面图像，所述CT二维截面图像包括XY二维截面图像、YZ二维截面图像和XZ轴二维截面图像；S3.沿截面法向扫描切割CT三维模型，直至在CT二维截面图像中识别得到配准小球所对应的配准圆斑；S4.选取二维截面图像识别所得配准圆斑，拟合配准圆斑以获取其圆心的平面二维坐标，基于屏幕坐标系和CT三维坐标系之间的转换关系将配准圆斑圆心的平面二维坐标转换成对应的CT三维坐标，并以配准圆斑圆心的CT三维坐标为中心点在CT三维模型选取对应的球形ROI区域，在该球形ROI区域中拟合出配准球体，并获取配准球体的CT三维坐标值；S5.基于至少4个拟合所得的配准球体的CT三维坐标值，将配准器模型匹配至CT三维模型上；S6.当种植手机通过球形钻头抵于所述配准器的凹坑内时，获取种植手机的相机三维坐标值，通过种植手机的相机三维坐标值确定凹坑的相机三维坐标值；S7.通过配准器模型，结合配准球体的CT三维坐标值确定凹坑的CT三维坐标值；S8.根据凹坑的相机三维坐标值和CT三维坐标值，在CT三维坐标系和相机坐标系之间建立转换关系，完成配准。2.根据权利要求1所述的一种口腔种植手术配准方法，其特征在于，所述步骤S4中，选取二维截面图像识别所得配准圆斑，拟合配准圆斑以获取其圆心的平面二维坐标具体包括以下步骤：以特定的圆心和半径选取配准圆斑搜索区域，对搜索区域进行二值化处理和去噪滤波处理，收集配准圆斑数据点，记录所有数据点所对应的二维坐标；获取估算配准圆斑圆心坐标为和估算圆心半径r，将所有数据点所对应的二维坐标表示为²+²=r²；通过误差方程分析误差平方和E=Σ²；计算误差平方和E偏导数，基于E偏导数得到关于配准圆斑圆心坐标的方程组：∂E/∂x0=-4Σ=0∂E/∂y0=-4Σ=0求解上述方程组得到配准圆斑圆心精确值和半径精确值，拟合完成；所述步骤S4中，基于屏幕坐标系和CT三维坐标系之间的转换关系将配准圆斑圆心的平面二维坐标转换成对应的CT三维坐标具体包括以下步骤：根据CT三维模型的像素大小和切片间距，将配准圆斑圆心的平面二维坐标转换为CT截面坐标；根据CT三维模型中CT二维截面图像的切片间距和像素大小，将配准圆斑圆心的CT截面坐标转换为CT体积坐标；将CT体积坐标转换为CT三维模型中的CT三维坐标。3.根据权利要求1所述的一种口腔种植手术配准方法，其特征在于，所述步骤S4中，以配准圆斑圆心的CT三维坐标为中心点在CT三维模型选取对应的球形ROI区域并在该球形ROI区域中拟合出配准球体具体包括以下步骤：选取拟合区域，获取拟合半径并在CT三维模型上选取以配准圆斑圆心的CT三维坐标为中心点为球心、以拟合半径为半径的球形ROI区域；对选取的球形ROI区域进行CT值二值化处理，得到二值化图像数据；对二值化图像数据进行去噪处理；根据去噪处理后的二值化图像数据，基于拟合算法拟合得到配准球体；计算拟合得到的配准球体的圆度；当圆度超过预设阈值时配准球体拟合完成，否则重新选取拟合区域并进行再次拟合。4.根据权利要求1所述的一种口腔种植手术配准方法，其特征在于，所述步骤S5中，基于至少4个拟合所得的配准球体的CT三维坐标值将配准器模型匹配至CT三维模型上具体包括以下步骤：根据至少4个CT三维坐标值分析得到各个配准球体的点云数据；提取CT三维模型的点云数据；数据预处理，对配准球体的点云数据和CT三维模型的点云数据进行去噪、滤波、采样；根据初始变换矩阵将各个配准球体的点云数据对齐到取CT三维模型的初始位置；使用迭代方式，通过最小化点云之间的距离或最大化对齐的度量函数，来优化初始对齐的结果，完成匹配。5.根据权利要求1所述的一种口腔种植手术配准方法，其特征在于，所述步骤S8中，在CT三维坐标系和相机坐标系之间建立转换关系具体包括：获取凹坑的相机三维坐标值和凹坑的CT三维坐标值；通过对凹坑的相机三维坐标值和CT三维坐标值进行均值运算得到平移向量；通过对凹坑的相机三维坐标值和CT三维坐标值进行最小二乘法运算得到旋转矩阵；计算凹坑的相机三维坐标值在相机坐标系中的欧氏距离A，计算凹坑的CT三维坐标值在CT三维坐标系中的欧氏距离B，根据缩放因子 = ∑连续不断获取多个XY二维截面图像，直至XY二维截面图像出现配准圆斑。S4.选取二维截面图像识别所得配准圆斑，拟合配准圆斑以获取其圆心的平面二维坐标，基于屏幕坐标系和CT三维坐标系之间的转换关系将配准圆斑圆心的平面二维坐标转换成对应的CT三维坐标，并以配准圆斑圆心的CT三维坐标为中心点在CT三维模型选取对应的球形ROI区域，在该球形ROI区域中拟合出配准球体，并获取配准球体的CT三维坐标值。S5.基于至少4个拟合所得的配准球体的CT三维坐标值，将配准器模型匹配至CT三维模型上。步骤S4至少重复4次，以得到4个配准球体并获取与之对应的CT三维坐标值，基于4个配准球体的CT三维坐标值，即可在三维空间进行定位，以便将配准器模型匹配至CT三维模型上。至此，基于配准器完成了配准的第一阶段工作。S6.当种植手机通过球形钻头抵于所述配准器的凹坑内时，获取种植手机的相机三维坐标值，通过种植手机的相机三维坐标值确定凹坑的相机三维坐标值。在步骤S6中所使用的种植手机已经经过标定，经过标定的种植手机可直接通过光学定位仪获取种植手机的相机三维坐标值，而由于种植手机与球形钻头之间的三维坐标转换关系在设计阶段便已知，同时球形钻头又抵于在配准器的凹坑内，因此可通过种植手机的相机三维坐标值确定凹坑的相机三维坐标值。S7.通过配准器模型，结合配准球体的CT三维坐标值确定凹坑的CT三维坐标值。在步骤S7中，在设计阶段便可知道配准器上配准球体和凹坑之间的三维坐标转换关系，而在步骤S4中已经获取配准球体的CT三维坐标值，因此可通过配准球体的CT三维坐标值获取凹坑的CT三维坐标值。S8.根据凹坑的相机三维坐标值和CT三维坐标值，在CT三维坐标系和相机坐标系之间建立转换关系。至此，基于配准器和种植手机完成配准，配准完成后，即可在CT坐标系和相机坐标系之间建立转换关系。本技术方案的核心创新点在于获取CT三维模型所对应的XY二维截面图像、YZ二维截面图像和XZ轴二维截面图像，再基于任一CT二维截面图像沿截面法向扫描切割CT三维模型，通过识别至少4个配准圆斑并获取对应配准球体的CT三维坐标值后进行配准。本技术方案在扫描切割识别配准圆斑、基于配准圆斑获取配准球体的CT三维坐标值、基于凹坑的相机三维坐标值和CT三维坐标值进行配准等方面都更为清晰，现比于现有技术中自动识别配准圆斑和自动生成配准球体，本技术方案中的“半自动”配准方式在保证方案实现逻辑简单的基础上，还能够提升配准的效率和准确率，从而有效保障种植精度和治疗效果。优选地，所述步骤S4中，选取二维截面图像识别所得配准圆斑，拟合配准圆斑以获取其圆心的平面二维坐标具体包括以下步骤：在二维截面图像中，以特定的圆心和半径选取配准圆斑搜索区域，对搜索区域进行二值化处理和去噪滤波处理，收集配准圆斑数据点，记录所有数据点所对应的二维坐标。在此步骤中，通过鼠标点击即可确定圆心，而搜索区域的半径则可通过预先设置参数的方式确定，因此，只需要通过在屏幕上点击配准圆斑，即可确定对应的搜索区域。进一步，对该区域进行二值化处理和去噪滤波处理后进行数据点收集，二值化处理和去噪滤波处理能够提高数据点的可靠性，使得数据点的二维坐标更加精确。获取估算配准圆斑圆心坐标为和估算圆心半径r，将所有的数据点所对应的二维坐标表示为²+²=r²。“估算配准圆斑圆心坐标”，即根据在搜索区域内收集到的所有数据点的二维坐标进行估算，得到大致的圆心和半径；进一步将所有数据点的二维坐标用上式表示出来。通过误差方程分析误差平方和E=Σ²。此步骤的目的在于建立误差方式，构建最小二乘问题。计算误差平方和E偏导数，基于E偏导数得到关于配准圆斑圆心坐标的方程组：∂E/∂x0=-4Σ=0∂E/∂y0=-4Σ=0求解上述方程组得到配准圆斑圆心精确值和半径精确值，拟合完成。至此，通过解决最小二乘问题，获取圆心精确值和半径精确值，即可得到最佳拟合的圆。基于上述技术方案，能够有效在二维截面图像中识别确定配准圆斑所对应的搜索区域，并通过二值化处理和去噪滤波处理提高该区域内数据点的清晰度和可读性，再通过构建和求解最小二乘问题获取圆心精确值和半径精确值，以准确获取配准圆斑圆心的平面二维坐标。优选地，所述步骤S4中，基于屏幕坐标系和CT三维坐标系之间的转换关系将配准圆斑圆心的平面二维坐标转换成对应的CT三维坐标具体包括以下步骤：根据CT三维模型的像素大小和切片间距，将配准圆斑圆心的平面二维坐标转换为CT截面坐标。在此步骤中，平面二维坐标为，CT截面坐标对应为，其中，px2=x2 * 像素大小，py2=y2 * 像素大小。根据CT三维模型中CT二维截面图像的切片间距和像素大小，将配准圆斑圆心的CT截面坐标转换为CT体积坐标。根据pz2=slice_index * 切片间距获取CT体积坐标，其中，slice_index为CT截面的索引，表示CT体积中的第几个切面。获取CT三维模型的原点坐标和方向向量信息，将CT体积坐标转换为CT三维模型中的CT三维坐标。其中，原点坐标表示CT三维模型中的原点位置，方向向量表示x轴、y轴和z轴的方向。基于上述步骤，即可将在屏幕操作时直接点击的点，直接体现在CT三维模型中，具有直观、快捷和方便等优点。优选地，所述步骤S4中，以配准圆斑圆心的CT三维坐标为中心点在CT三维模型选取对应的球形ROI区域并在该球形ROI区域中拟合出配准球体具体包括以下步骤：选取拟合区域，获取拟合半径并在CT三维模型上选取以配准圆斑圆心的CT三维坐标为中心点为球心、以拟合半径为半径的球形ROI区域；对选取的球形ROI区域进行CT值二值化处理，得到二值化图像数据。在此步骤中，对CT值进行二值化处理，使用阈值分割方法，选择一个合适的阈值将物体与背景分离，使得二值化图像数据能够从背影中突显出来。对二值化图像数据进行去噪处理。对二值化后的图像进行去噪处理，去除离散的噪点，可以提升数据处理效率。在具体实施时，可以使用形态学操作，如腐蚀和膨胀，来去除小的噪点。根据去噪处理后的二值化图像数据，基于拟合算法拟合得到配准球体。在此步骤中，可以使用最小二乘法或其他拟合算法，将二值化后的图像中的点拟合成一个球体，即为配准球体。计算拟合得到的配准球体的圆度；当圆度超过预设阈值时配准球体拟合完成，否则重新选取拟合区域并进行再次拟合。圆度是指实际物体与拟合球体之间的相似程度。可以使用圆度公式来计算圆度，圆度越接近1表示拟合效果越好。本技术方案在具体实施时，圆度高于0.8为判断标准。优选地，所述步骤S5中，基于至少4个拟合所得的配准球体的CT三维坐标值将配准器模型匹配至CT三维模型上具体包括以下步骤：根据至少4个CT三维坐标值分析得到各个配准球体的点云数据。在三维空间中，3个点形成一个面，因而至少基于4个点才能确定一个物体的基本姿态。本步骤中，使用4个配准球体的点云数据进行匹配前数据处理。提取CT三维模型的点云数据。数据预处理，对配准球体的点云数据和CT三维模型的点云数据进行去噪、滤波、采样。此步骤的目的在于提高数据处理的精度和效率。根据初始变换矩阵将各个配准球体的点云数据对齐到取CT三维模型的初始位置。通过选择一个初始变换矩阵，将4个配准球体的点云数据大致对齐到CT三维模型的的初始位置。具体实施时，可以使用人工选择或自动选择算法来估计初始变换矩阵。使用迭代方式，通过最小化点云之间的距离或最大化对齐的度量函数，来优化初始对齐的结果，完成匹配。在此步骤中，可使用ICP算法和非刚性配准算法进行迭代。基于上述技术方案，能够以简单的方式将配准器模型匹配至CT三维模型上。优选地，所述步骤S8中，在CT三维坐标系和相机坐标系之间建立转换关系具体包括：获取凹坑的相机三维坐标值和凹坑的CT三维坐标值。通过对凹坑的相机三维坐标值和CT三维坐标值进行均值运算得到平移向量。通过对凹坑的相机三维坐标值和CT三维坐标值进行最小二乘法运算得到旋转矩阵。计算凹坑的相机三维坐标值在相机坐标系中的欧氏距离A，计算凹坑的CT三维坐标值在CT三维坐标系中的欧氏距离B，根据缩放因子 = ∑（欧氏距离A / 欧氏距离B)分析得到缩放因子；其中，∑表示对多个凹坑对应的欧氏距离A / 欧氏距离B进行求和。根据平移向量、旋转矩阵和缩放因子，建立CT三维坐标系和相机坐标系之间的转换关系。在实施种植牙手术前进行配准的目的在于，在CT坐标系和相机坐标系之间建立转换关系，从而为实时导航奠定数据基础。通过上述步骤，即可在CT三维坐标系和相机坐标系之间建立转换关系，完成配准。如图2所示，对应地，一种口腔种植手术配准系统，包括：模型构建模块1，用于采集患者带有配准器的口腔CBCT数据，基于口腔CBCT数据构建CT三维模型，所述配准器上设置有多个配准小球和多个凹坑；截面数据获取模块2，用于获取CT三维模型所对应的CT二维截面图像，所述CT二维截面图像包括XY二维截面图像、YZ二维截面图像和XZ轴二维截面图像；圆斑识别模块3，用于沿截面法向扫描切割CT三维模型，直至在CT二维截面图像中识别得到配准小球所对应的配准圆斑；球体拟合模块4，用于选取二维截面图像识别所得配准圆斑，拟合配准圆斑以获取其圆心的平面二维坐标，基于屏幕坐标系和CT三维坐标系之间的转换关系将配准圆斑圆心的平面二维坐标转换成对应的CT三维坐标，并以配准圆斑圆心的CT三维坐标为中心点在CT三维模型选取对应的球形ROI区域，在该球形ROI区域中拟合出配准球体，并获取配准球体的CT三维坐标值；模型匹配模块5，用于基于至少4个拟合所得的配准球体的CT三维坐标值，将配准器模型匹配至CT三维模型上；第一坐标获取模块6，用于在当种植手机通过球形钻头抵于所述配准器的凹坑内时，获取种植手机的相机三维坐标值，通过种植手机的相机三维坐标值确定凹坑的相机三维坐标值；第二坐标获取模块7，用于通过配准器模型，结合配准球体的CT三维坐标值确定凹坑的CT三维坐标值；配准模块8，用于根据凹坑的相机三维坐标值和CT三维坐标值，在CT三维坐标系和相机坐标系之间建立转换关系，完成配准。优选地，为以配准圆斑圆心的CT三维坐标为中心点在CT三维模型选取对应的球形ROI区域并在该球形ROI区域中拟合出配准球体，所述球体拟合模块包括：圆形区域选取单元，用于在二维截面图像中以特定的圆心和半径选取配准圆斑搜索区域，对搜索区域进行二值化处理和去噪滤波处理，收集配准圆斑数据点，记录所有数据点所对应的二维坐标；估算单元，用于获取估算配准圆斑圆心坐标为和估算圆心半径r，将所有的数据点所对应的二维坐标表示为²+²=r²；最小二乘问题构建单元，用于通过误差方程分析误差平方和E=Σ²；最小二乘问题解决单元，用于计算误差平方和E偏导数，基于E偏导数得到关于配准圆斑圆心坐标的方程组：∂E/∂x0=-4Σ=0∂E/∂y0=-4Σ=0求解上述方程组得到配准圆斑圆心精确值和半径精确值，拟合完成。优选地，为基于屏幕坐标系和CT三维坐标系之间的转换关系将配准圆斑圆心的平面二维坐标转换成对应的CT三维坐标，所述球体拟合模块包括：第一坐标转换单元，用于根据CT三维模型的像素大小和切片间距，将配准圆斑圆心的平面二维坐标转换为CT截面坐标；第二坐标转换单元，用于根据CT三维模型中CT二维截面图像的切片间距和像素大小，将配准圆斑圆心的CT截面坐标转换为CT体积坐标；第三坐标转换单元，用于将CT体积坐标转换为CT三维模型中的CT三维坐标；为以配准圆斑圆心的CT三维坐标为中心点在CT三维模型选取对应的球形ROI区域并在该球形ROI区域中拟合出配准球体，所述球体拟合模块包括：球形区域选取单元，用于获取拟合半径并在CT三维模型上选取以配准圆斑圆心的CT三维坐标为中心点为球心、以拟合半径为半径的球形ROI区域；二值化单元，用于对选取的球形ROI区域进行CT值二值化处理，得到二值化图像数据；去噪单元，用于对二值化图像数据进行去噪处理；球体拟合单元，用于根据去噪处理后的二值化图像数据，基于拟合算法拟合得到配准球体；圆度计算单元，用于计算拟合得到的配准球体的圆度；当圆度超过预设阈值时配准球体拟合完成，否则重新选取拟合区域并进行再次拟合。优选地，所述模型匹配模块包括：数据分析单元，用于根据至少4个CT三维坐标值分析得到各个配准球体的点云数据；数据提取单元，用于提取CT三维模型的点云数据；数据预处理单元，用于对配准球体的点云数据和CT三维模型的点云数据进行去噪、滤波、采样；对齐单元，用于根据初始变换矩阵将各个配准球体的点云数据对齐到取CT三维模型的初始位置；迭代匹配单元，用于通过最小化点云之间的距离或最大化对齐的度量函数，来优化初始对齐的结果，完成匹配。优选地，所述配准模块包括：坐标获取单元，用于获取凹坑的相机三维坐标值和凹坑的CT三维坐标值；第一运算单元，用于通过对凹坑的相机三维坐标值和CT三维坐标值进行均值运算得到平移向量；第二运算单元，用于通过对凹坑的相机三维坐标值和CT三维坐标值进行最小二乘法运算得到旋转矩阵；第三运算单元，用于计算凹坑的相机三维坐标值在相机坐标系中的欧氏距离A，计算凹坑的CT三维坐标值在CT三维坐标系中的欧氏距离B，根据缩放因子=∑（欧氏距离A /欧氏距离B)分析得到缩放因子；其中，∑表示对多个凹坑对应的欧氏距离A/欧氏距离B进行求和；综合分析单元，用于根据平移向量、旋转矩阵和缩放因子，建立CT三维坐标系和相机坐标系之间的转换关系。对应地，一种存储介质，所述存储介质存储有计算机程序，所述的计算机程序包括程序指令，当所述程序指令被处理器执行时，处理器执行如上所述的口腔种植手术配准方法。应当理解的是，本发明的应用不限于上述的举例，对本领域普通技术人员来说，可以根据上述说明加以改进或变换，所有这些改进和变换都应属于本发明所附权利要求的保护范围。
