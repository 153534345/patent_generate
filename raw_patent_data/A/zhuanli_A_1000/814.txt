标题title
一种笔形束扫描束流位置快速校正装置及方法
摘要abst
本发明公开了一种笔形束扫描束流位置快速校正装置和方法，该装置的特点是：在扫描磁铁SMX前，还依次安装有快速校正磁铁；所述扫描控制器设有基于神经网络的束流位置预测模块，该束流位置预测模块保存有训练好的神经网络参数，该训练好的神经网络参数用于束流位置预测模块综合所有位置反馈结构反馈的信息；该方法特点是：判定预测位置及反馈位置均大于最小调节值且大于误差阈值，如果是，则控制快速校正磁铁电流，校正束流位置；如果不是，则判断位置误差大于误差阈值、并判定目标剂量达到且照射过程结束。本发明既考虑了局部位置误差又结合神经网络结合多种参数判定的整体位置误差，从而在避免了局部误差波动导致的不必要调节。
权利要求书clms
1.一种笔形束扫描束流位置快速校正装置，沿着束流进入的方向，依次包括：用于实现束流X方向偏转的X方向扫描磁铁SMX及其电源、用于实现束流Y方向偏转Y方向扫描磁铁SMY及其电源、用于对X方向扫描磁铁和和Y方向扫描磁偏转后的束流位置和剂量进行读取的条带电离室IC1和条带电离室IC2、用于对扫描磁铁电流进行设定并对扫描磁铁的电流值、电压值、磁场值、束流位置和束流剂量进行实时监控的扫描控制器；其特征在于：在扫描磁铁SMX前，还依次安装有快速校正磁铁、以及条带电离室IC3；所述快速校正磁铁用于在调节扫描磁铁之前进行提前校正，降低了对扫描磁铁调节范围和对系统的影响，避免了因闭环调节的引入造成原系统的不稳定性；所述条带电离室IC3用于对快速校正磁铁校正后的束流位置和剂量进行读取；所述扫描控制器设有基于神经网络的束流位置预判模块，该束流位置预测模块保存有训练好的神经网络参数，该训练好的神经网络参数用于束流位置预测模块综合所有位置反馈结构反馈的信息，既考虑了局部位置误差，又通过神经网络结合多种参数进行整体位置误差判定，从而避免了局部误差波动导致的不必要调节，保证了系统自身的位置稳定性。2.根据权利要求1所述一种笔形束扫描束流位置快速校正装置，其特征在于：所述的扫描控制器包括扫描磁铁电流设定模块、局部位置实时监控模块，基于神经网络的束流位置预判模块；所述扫描磁铁电流设定模块接收上位机发送的扫描数据文件并按照扫描数据对扫描磁铁电流进行设定以实现固定位置固定剂量的束流照射在目标靶体上，所述的扫描数据文件包括等中心平面处束流位置坐标设定值；所述局部位置实时监控模块对扫描磁铁的电流/电压值、磁铁内霍尔探头测量的磁场值、以及电离室的束流位置/剂量等数据进行实时监测；所述的基于神经网络的束流位置预判模块接收扫描磁铁电流设定模块、以及局部位置实时监控模块的信息，进行束流位置的预判。3.根据权利要求2所述一种笔形束扫描束流位置快速校正装置，其特征在于：所述基于神经网络预测模型的束流位置预测模块，包括局部位置误差判定模块、整体位置误差判定模块、调节决策模块；所述调节决策模块引入部位置误差判定结果、以及整体位置误差判定结果，当局部位置误差判定、整体位置误差判定，二者全部满足大于最小调节量且小于最大位置误差时，将这个误差作为等中心点处的位置误差，最终引入调节过程。4.根据权利要求3所述一种笔形束扫描束流位置快速校正装置，其特征在于：所述整体位置误差判定模块包括读取神经网络输入参数子模块、训练好的神经网络及参数子模块、整体位置误差判定子模块、接收扫描磁铁电流设定值子模块；所述读取神经网络输入参数子模块用于读取以下七个参数：束流能量E、安装在扫描铁上的霍尔探头测量到的两扫描铁的磁场值Bp_x和Bp_y、第一个电离室IC1监测到的束流位置坐标点IC1_x和IC1_y、第二个电离室IC2监测到的束流位置坐标IC2_x和IC2_y，这7个参数作为训练好的神经网络的输入层；所述训练好的神经网络及参数子模块读取神经网络输入参数子模块的7个参数，并接收学习阶段神经网络训练好的网络权值和阈值；所述整体位置误差判定子模块一方面根据训练好的神经网络输出的等中心平面处束流位置坐标预测值，也即为神经网络的输出层、一方面根据接收扫描磁铁电流设定值子模块设定的等中心平面处束流位置设定值，从而最终计算出整体位置误差。5.根据权利要求1所述一种笔形束扫描束流位置快速校正装置，其特征在于：所述扫描控制器的调节决策模块针对束流位置预测模块计算出的对应在等中心点处的位置误差，然后根据误差值控制快速校正磁铁的电源电流，进而对束流位置进行校正；每次输出电流调节范围做限制不超过最大值△Imax-E，具体输出电流如下：△Iadj-i＝△Imax-E*erri*f，其中，△Iadj-i为调节输出电流变化量，erri为位置误差与最大调节误差比值，f为修正系数。6.根据权利要求4所述一种笔形束扫描束流位置快速校正装置，其特征在于：所述用于神经网络学习阶段的输入输出参数设置子模块的输入层、输出层、隐含层的设置如下：1)输入层为与束流位置相关的7维变量数组：其中E为束流能量，Bp_x和Bp_y为安装在扫描铁上的霍尔探头测量到的两扫描铁的磁场值，IC1_x和IC1_y为第一个电离室IC1监测到的束流位置坐标点，IC2_x和IC2_y为第二个电离室IC2监测到的束流位置坐标；2)输出层为等中心平面处束流的位置坐标；3)隐含层节点数目的确定参考如下公式：式中，h为隐含层节点数目，m为输入层节点数目，n为输出层节点数目，a为1到10之间的调节常数，因此选择隐含层节点个数为10，建立起网络的模型，并最终确定模型参数，输入层7个节点，隐含层10个节点，输出层2个节点。7.根据权利要求1所述一种笔形束扫描束流位置快速校正装置，其特征在于：所述快速校正磁铁通过其电源输出电流值的变化产生相应的磁场，从而实现对束流位置的偏转和校正；所述快速校正磁铁的最终位置校正最大范围为±0.8mm，用以保证在实时调节过程中对束流位置的调节量在安全范围内；所述快速校正磁铁对230MeV质子束流的偏转角度为2.25mrad及以上，用以实现对质子束流的偏转能力。8.根据权利要求1所述一种笔形束扫描束流位置快速校正装置，其特征在于：所述X方向扫描磁铁SMX及Y方向扫描磁铁SMY内部装有霍尔探头、用以实现对磁场的回读，由于磁场和束流位置一一对应的关系，从而能够通过磁场回读值间接对束流位置进行检测；所述X方向扫描磁铁SMX及Y方向扫描磁铁最大工作电流达到150A及以上、最大工作电压360V及以上，响应时间于900μs。9.根据权利要求1所述一种笔形束扫描束流位置快速校正装置，其特征在于：所述条带电离室IC1和条带电离室IC2分别包含128个X方向条带及128个Y方向条带，用以实现束流位置的实时监测；所述电离室IC1/IC2有效测量位置区域不小于25cm x 25cm、位置分精度X方向和Y方向均不低于250μm、电离室电子学数据采样率不小于5kHz，采样ADC大于16位，从而保证束流位置和剂量读取的精度；同时保证质子束流在50～250MeV下电离室的水等效厚度小于200μm，从而保证足够少的能量损失。10.一种基于权利要求1-9任意一项一种笔形束扫描束流位置快速校正装置的笔形束扫描束流位置快速校正方法，其特征在于，包括以下步骤：步骤一、笔形束扫描过程开始；步骤二、扫描控制器根据扫描文件对扫描磁铁电流进行设定；步骤三、电流回读和霍尔探头回读正确？如果正确，则继续步骤四，否则，返回步骤二；步骤四、其他连锁条件是否满足？如果不满足，循环返回步骤四，如果满足，继续步骤五；步骤五、开启照射过程；步骤六、预测位置及反馈位置均大于最小调节值且大于误差阈值？如果是，则控制快速校正磁铁电流，校正束流位置；如果不是，则继续步骤七；步骤七、位置误差大于误差阈值？如果是，Error状态触发安全联锁，停止束流照射过程；如果不是，则继续步骤八；步骤八、继续照射过程；步骤九、目标剂量达到且照射过程结束？如果没有达到，则返回步骤五，达到则结束。
说明书desc
技术领域本发明属于回旋加速器质子治疗领域，具体涉及一种笔形束扫描束流位置快速校正装置及方法。背景技术质子束扫描是质子治疗的最终也是非常重要的环节，是直接将质子束流传送到人体肿瘤细胞的最终过程。束流扫描的原理是质子受洛伦兹力的作用，即质子在磁场作用下发生偏转，这样笔形束在平面中的位置可由扫描磁铁进行调节。目前现有技术的普遍做法，是在笔形束扫描照射过程中，如果照射位置出现偏差且超出误差阈值时，通过实时扫描控制器快速切断束流以停止照射过程，从而防止将不必要的剂量照射到非指定位置，也保护健康细胞和组织避免接收不必要的剂量。现有技术笔形束扫描照射存在的问题之一：对扫描磁铁的调节范围比较大，当调节范围比较大时，如果再加上闭环调节的引入，可能会使得原系统不稳定从而引起更大的风险。现有技术笔形束扫描照射存在的问题之二：束流经过的所有位置反馈机构都会存在系统误差或不确定误差，当位置反馈机构的累计误差或者不确定误差引起的不必要位置误差过大时，导致照射过程中断，从而增加了照射过程中的错误率。发明内容本发明针对现有技术提出的问题，提出一种笔形束扫描束流位置快速校正装置及方法，目的在于解决现有技术对扫描磁铁的调节范围比较大，致使闭环调节的引入使得原系统不稳定、以及当累计误差或者不确定误差过大时，导致照射过程中的错误率较大的问题。本发明为解决其技术问题，采用以下技术方案：一种笔形束扫描束流位置快速校正装置，沿着束流进入的方向，依次包括：用于实现束流X方向偏转的X方向扫描磁铁SMX及其电源、用于实现束流Y方向偏转Y方向扫描磁铁SMY及其电源、用于对X方向扫描磁铁和和Y方向扫描磁偏转后的束流位置和剂量进行读取的条带电离室IC1和条带电离室IC2、用于对扫描磁铁电流进行设定并对扫描磁铁的电流值、电压值、磁场值、束流位置和束流剂量进行实时监控的扫描控制器；其特征在于：在扫描磁铁SMX前，还依次安装有快速校正磁铁、以及条带电离室IC3；所述快速校正磁铁用于在调节扫描磁铁之前进行提前校正，降低了对扫描磁铁调节范围和对系统的影响，避免了因闭环调节的引入造成原系统的不稳定性；所述条带电离室IC3用于对快速校正磁铁校正后的束流位置和剂量进行读取；所述扫描控制器设有基于神经网络的束流位置预判模块，该束流位置预测模块保存有训练好的神经网络参数，该训练好的神经网络参数用于束流位置预测模块综合所有位置反馈结构反馈的信息，既考虑了局部位置误差，又通过神经网络结合多种参数进行整体位置误差判定，从而避免了局部误差波动导致的不必要调节，保证了系统自身的位置稳定性。所述的扫描控制器包括扫描磁铁电流设定模块、局部位置实时监控模块，基于神经网络的束流位置预判模块；所述扫描磁铁电流设定模块接收上位机发送的扫描数据文件并按照扫描数据对扫描磁铁电流进行设定以实现固定位置固定剂量的束流照射在目标靶体上，所述的扫描数据文件包括等中心平面处束流位置坐标设定值；所述局部位置实时监控模块对扫描磁铁的电流/电压值、磁铁内霍尔探头测量的磁场值、以及电离室的束流位置/剂量等数据进行实时监测；所述的基于神经网络的束流位置预判模块接收扫描磁铁电流设定模块、以及局部位置实时监控模块的信息，进行束流位置的预判。所述基于神经网络预测模型的束流位置预测模块，包括局部位置误差判定模块、整体位置误差判定模块、调节决策模块；所述调节决策模块引入部位置误差判定结果、以及整体位置误差判定结果，当局部位置误差判定、整体位置误差判定，二者全部满足大于最小调节量且小于最大位置误差时，将这个误差作为等中心点处的位置误差，最终引入调节过程。所述整体位置误差判定模块包括读取神经网络输入参数子模块、训练好的神经网络及参数子模块、整体位置误差判定子模块、接收扫描磁铁电流设定值子模块；所述读取神经网络输入参数子模块用于读取以下七个参数：束流能量E、安装在扫描铁上的霍尔探头测量到的两扫描铁的磁场值Bp_x和Bp_y、第一个电离室IC1监测到的束流位置坐标点IC1_x和IC1_y、第二个电离室IC2监测到的束流位置坐标IC2_x和IC2_y，这7个参数作为训练好的神经网络的输入层；所述训练好的神经网络及参数子模块读取神经网络输入参数子模块的7个参数，并接收学习阶段神经网络训练好的网络权值和阈值；所述整体位置误差判定子模块一方面根据训练好的神经网络输出的等中心平面处束流位置坐标预测值，也即为神经网络的输出层、一方面根据接收扫描磁铁电流设定值子模块设定的等中心平面处束流位置设定值，从而最终计算出整体位置误差。所述扫描控制器的调节决策模块针对束流位置预测模块计算出的对应在等中心点处的位置误差，然后根据误差值控制快速校正磁铁的电源电流，进而对束流位置进行校正；每次输出电流调节范围做限制不超过最大值△Imax-E，具体输出电流如下：△Iadj-i＝△Imax-E*erri*f，其中，△Iadj-i为调节输出电流变化量，erri为位置误差与最大调节误差比值，f为修正系数。所述用于神经网络学习阶段的输入输出参数设置子模块的输入层、输出层、隐含层的设置如下：1)输入层为与束流位置相关的7维变量数组：其中E为束流能量，Bp_x和Bp_y为安装在扫描铁上的霍尔探头测量到的两扫描铁的磁场值，IC1_x和IC1_y为第一个电离室IC1监测到的束流位置坐标点，IC2_x和IC2_y为第二个电离室IC2监测到的束流位置坐标；2)输出层为等中心平面处束流的位置坐标；3)隐含层节点数目的确定参考如下公式：式中，h为隐含层节点数目，m为输入层节点数目，n为输出层节点数目，a为1到10之间的调节常数。因此选择隐含层节点个数为10，建立起网络的模型，并最终确定模型参数，输入层7个节点，隐含层10个节点，输出层2个节点。所述快速校正磁铁通过其电源输出电流值的变化产生相应的磁场，从而实现对束流位置的偏转和校正；所述快速校正磁铁的最终位置校正最大范围为±0.8mm，用以保证在实时调节过程中对束流位置的调节量在安全范围内；所述快速校正磁铁对230MeV质子束流的偏转角度为2.25mrad及以上，用以实现对质子束流的偏转能力。所述X方向扫描磁铁SMX及Y方向扫描磁铁SMY内部装有霍尔探头、用以实现对磁场的回读，由于磁场和束流位置一一对应的关系，从而能够通过磁场回读值间接对束流位置进行检测；所述X方向扫描磁铁SMX及Y方向扫描磁铁最大工作电流达到150A及以上、最大工作电压360V及以上，响应时间于900μs。所述条带电离室IC1和条带电离室IC2分别包含128个X方向条带及128个Y方向条带，用以实现束流位置的实时监测；所述电离室IC1/IC2有效测量位置区域不小于25cm x25cm、位置分精度X方向和Y方向均不低于250μm、电离室电子学数据采样率不小于5kHz，采样ADC大于16位，从而保证束流位置和剂量读取的精度；同时保证质子束流在50～250MeV下电离室的水等效厚度小于200μm，从而保证足够少的能量损失。一种笔形束扫描束流位置快速校正方法，其特征在于，包括以下步骤：步骤一、笔形束扫描过程开始；步骤二、扫描控制器根据扫描文件对扫描磁铁电流进行设定；步骤三、电流回读和霍尔探头回读正确？如果正确，则继续步骤四，否则，返回步骤二；步骤四、其他连锁条件是否满足？如果不满足，循环返回步骤四，如果满足，继续步骤五；步骤五、开启照射过程；步骤六、预测位置及反馈位置均大于最小调节值且大于误差阈值？如果是，则控制快速校正磁铁电流，校正束流位置；如果不是，则继续步骤七；步骤七、位置误差大于误差阈值？如果是，Error状态触发安全联锁，停止束流照射过程；如果不是，则继续步骤八；步骤八、继续照射过程；步骤九、目标剂量达到且照射过程结束？如果没有达到，则返回步骤五，达到则结束。本发明优点效果1、本发明通过快速扫描磁铁实现束流位置的快速调节，能够提高照射过程中束流位置精度。2、本发明通过束流位置的实时快速校正，避免累计误差或者不确定误差引起的不必要位置误差过大导致的照射过程中断，降低了照射过程中的错误率，提高了笔形束扫描的效率和可靠性。3、本发明通过在扫描磁铁前安装快速校正装置，而非直接调节扫描磁铁，降低了调节范围和对系统的影响，避免因闭环调节的引入造成原系统的不稳定性。4、本发明既考虑了局部位置误差又结合神经网络结合多种参数判定的整体位置误差，从而在避免了局部误差波动导致的不必要调节，因此保证了系统自身的位置稳定性；除此之外，能够根据神经网络预判结合局部误差对束流位置进行快速修正，同时修正系数可调节。附图说明图1为本发明笔形束扫描治疗头结构示意图；图2为本发明校正装置及校正曲线示意图；图3-1为本发明扫描控制器功能框图；图3-2为本发明束流位置预判模块功能框图；图3-3为本发明整体位置误差判定功能框图；图4为BP神经网络模型；图5为常规笔形束扫描工作流程；图6为本发明带有校正装置的笔形束扫描工作流程。具体实施方式本发明设计原理1、本发明创新点：创新点在于一个硬件上的创新和一个软件上的创新。硬件上没有采用传统的方法，通过本身的偏转体进行改进，给原有的偏转体制造更多的调整上的麻烦和复杂性，而是在原有基础上引入了新的独立控件，增加了闭环上的环节，并且限制了调节范围，由此，不会给原有系统造成不必要的混乱和扰动、把本来正常的变成错误的。软件上不光判断局部某个点的位置，还从整体上综合了所有位置反馈机构的反馈的结果，进行预判输出，这个预判输出是预判最终实际的位置，如果最终实际位置也存在误差才进行调节，防止因为中间某一个反馈点出现位置误差但最终位置没有误差的情况下也进行调整的情况出现。也就是将局部误差和整体误差这二个综合进行判断，只有这二个误差满足一定条件才进行调整。2、扫描磁铁部分包括X方向扫描磁铁和Y方向扫描磁铁，另外装两个有霍尔探头根据测得磁场数据作为扫描磁铁磁铁磁场/电流的状态反馈回读。两个扫描磁铁实现对束流沿XY方向的偏转从而使束流照射到治疗计划指定的照射位置。扫描控制器主要通过对扫描磁铁电源的控制实现对束流的扫描位置控制，具体通过控制扫描磁铁的电流值来实现。此部分控制接口包括两个扫描磁铁电源的开关控制/状态检测及电流/电压设置及回读，另外包括两个霍尔探头磁场数据的读取。3、电离室部分实现对束流位置和剂量的实时监测，当束流位置或剂量超出预定的数值，并立即采取措施对扫描过程进行干预。像素电离室安装在真空窗后扫描磁铁前，用于对束流等中心点位置进行校验以确保束流进入治疗头后处于等中心点位置。两个条带电离室安装在扫描磁铁下游靠近治疗头出口方向，实时监测束流位置和剂量信息，用于对即将照射目标靶体的束流进行位置和剂量的最后校验，当束流实际监测位置偏离治疗计划给定的目标值且超出设定允许范围后立即采取措施，防止束流照射在扫描文件规定的目标以外，另外，条带电离室能够对束流剂量进行监测，当扫描位置剂量达到治疗计划规定的目标剂量后进行换点或换层操作，当扫描位置的剂量超过治疗计划规定的允许范围后立即停止束流以保证照过程的安全。4、扫描控制器实时读取电离室IC1/IC2反馈的束流位置信息，并和设定值进行比较，反过来控制快速校正磁铁的电流值，实现束流位置的校正。为保证笔形束扫描过程中束流位置快速校正闭环控制的安全性，要求快速校正磁铁在实时调节过程中对束流位置的调节量必须保证在安全范围内，由于笔形束扫描对束流位置的精度要求位±1mm，因此，校正装置的最终位置校正最大范围为±0.8mm。5、为了避免束流位置变化波动而引起的不必要调节过程，同时降低扫描控制器的工作压力，因此当束流位置误差超出最小调节值时才进行位置校正过程，要求束流位置误差校正最小调节值为±0.2mm。因此能够避免频繁的调节和误动作带来的不确定性。6、对于笔形束扫描系统，实际照射过程中关注的是束流最终照射在等中心平面的位置，而与束流位置有关的参数包括扫描铁X/Y的磁场值；束流能量，不同能量的束流在相同磁场下的偏转角度也不相同；电离室监测的位置坐标，电离室作为监测束流位置的最终环节，其测量的束流位置与等中心平面处的束流位置直接关联。人工神经网络如图4所示，作为人工智能算法的热点，在推断隐蔽、复杂的数据间对应关系以及对多种因素影响下的结果预测方面有着独特的优势，因而设计了基于扫描铁磁场值以及电离室位置信息对束流位置进行追踪和预测的神经网络模型。BP神经网络作为最典型的有监督学习算法，主要是计算出正确输出与神经网络的当前输出的误差，然后沿着误差的梯度下降的方向进行权值的修改。学习过程由信号的正向传播与误差的反向传播两个过程组成。正向传播时，输入样本从输入层传入，经各隐含层逐层处理后，传向输出层。若输出层的实际输出与期望的输出不符，则转入误差的反向传播阶段。反向传播时，将输出以某种形式通过隐含层向输入层逐层反传，并将误差分摊给各层的所有单元，从而获得各层单元的误差信号，此误差信号即作为修正各单元权值的依据。如图4所示，网络一般采用三层结构，即输入层、隐含层以及输出层。输入层将输入信号传达给隐含层的各个单元；隐含层从网络内部接收输入信息，并进行计算处理；输出层将隐含层的输出数据作为它的输入数据，并计算整个网络的输出。BP神经网络法具体学习算法步骤如下：初始化网络：将网络的各个权值Wij和阈值θj初始化为中的随机数。设置最大迭代次数和目标误差值，并设置网络误差平方和SSE的初值为0。给定输入输出训练集x及T。输入信号的正向传播过程，计算隐含层和输出层各神经元相对于前一层的i净输入Ij向量Ij＝∑WijOj+θjOj＝f式中Oj为网络相对于上一层输入的输出，f为采用的传递函数，根据实际情况可选取激活函数为Sigmoid函，tanh函数、softmax函数、purelin函数、Relu函数等。计算并检验网络误差平方和SSE：SSE＝∑2式中Oj为样本的期望输出。误差反向传播：根据样本x所对应的期望输出向量Oj，求出输出层的各神经元的误差向量ERRj：ERRj＝Oj对从最后一个到第一个隐含层的神经元j，根据后一较高层中连接到j的所有神经元的误差加权和来计算误差向量ERRj：ERRj＝Oj∑k调整权值及阈值：把网络中的权重向量Wij以及阈值向量θj做如下调整，Wij＝wij+aERRjOjθj＝θj+aERRj式中a为学习率。判断误差是否已经满足要求，如果不满足的话，返回步，直到误差满足或达到训练次数为止。对于笔形束扫描系统，实际照射过程中关注的是束流最终照射在等中心平面的位置，而与束流位置有关的参数包括扫描铁X/Y的磁场值；束流能量，不同能量的束流在相同磁场下的偏转角度也不相同；电离室监测的位置坐标，电离室作为监测束流位置的最终环节，其测量的束流位置与等中心平面处的束流位置直接关联。因此基于以上分析，设计了基于图6的三层模型的神经网络，输入层为上述与束流位置相关的7维变量数组：其中E为束流能量，Bp_x和Bp_y为安装在扫描铁上的霍尔探头测量到的两扫描铁的磁场值，IC1_x和IC1_y为第一个电离室IC1监测到的束流位置坐标点，IC2_x和IC2_y为第二个电离室IC2监测到的束流位置坐标。输出层为等中心平面处束流的位置坐标。隐含层节点数目的确定参考如下公式：式中，h为隐含层节点数目，m为输入层节点数目，n为输出层节点数目，a为1到10之间的调节常数。因此选择隐含层节点个数为10，建立起网络的模型，并最终确定模型参数，输入层7个节点，隐含层10个节点，输出层2个节点。综上所述，为了避免某一个探测器出现问题而引起的局部误差而引入的不必要调节，考虑引入基于神经网络预测模型的束流位置判断程序，当二者全部满足大于最小调节量且小于最大位置误差时才最终引入调节过程。这样既考虑了局部位置误差又结合神经网络结合多种参数判定的整体位置误差，从而在避免了局部误差波动导致的不必要调节，因此保证了系统自身的位置稳定性；除此之外，能够根据神经网络预判结合局部误差对束流位置进行快速修正，同时修正系数可调节。基于以上原理，本发明涉及了一种笔形束扫描束流位置快速校正装置。一种笔形束扫描束流位置快速校正装置如图1、图2所示，沿着束流进入的方向，依次包括：用于实现束流X方向偏转的X方向扫描磁铁SMX及其电源、用于实现束流Y方向偏转Y方向扫描磁铁SMY及其电源、用于对X方向扫描磁铁和和Y方向扫描磁偏转后的束流位置和剂量进行读取的条带电离室IC1和条带电离室IC2、用于对扫描磁铁电流进行设定并对扫描磁铁的电流值、电压值、磁场值、束流位置和束流剂量进行实时监控的扫描控制器；其特点是：在扫描磁铁SMX前，还依次安装有快速校正磁铁、以及条带电离室IC3；所述快速校正磁铁用于在调节扫描磁铁之前进行提前校正，降低了对扫描磁铁调节范围和对系统的影响，避免了因闭环调节的引入造成原系统的不稳定性；所述条带电离室IC3用于对快速校正磁铁校正后的束流位置和剂量进行读取；所述扫描控制器设有基于神经网络的束流位置预判模块，该束流位置预测模块保存有训练好的神经网络参数，该训练好的神经网络参数用于束流位置预测模块综合所有位置反馈结构反馈的信息，既考虑了局部位置误差，又通过神经网络结合多种参数进行整体位置误差判定，从而避免了局部误差波动导致的不必要调节，保证了系统自身的位置稳定性。所述的扫描控制器3-1包括扫描磁铁电流设定模块、局部位置实时监控模块，基于神经网络的束流位置预判模块；所述扫描磁铁电流设定模块接收上位机发送的扫描数据文件并按照扫描数据对扫描磁铁电流进行设定以实现固定位置固定剂量的束流照射在目标靶体上，所述的扫描数据文件包括等中心平面处束流位置坐标设定值；所述局部位置实时监控模块对扫描磁铁的电流/电压值、磁铁内霍尔探头测量的磁场值、以及电离室的束流位置/剂量等数据进行实时监测；所述的基于神经网络的束流位置预判模块接收扫描磁铁电流设定模块、以及局部位置实时监控模块的信息，进行束流位置的预判。所述基于神经网络预测模型的束流位置预测模块如图3-2所示，包括局部位置误差判定模块、整体位置误差判定模块、调节决策模块；所述调节决策模块引入局部位置误差判定结果、以及整体位置误差判定结果，当局部位置误差判定、整体位置误差判定，二者全部满足大于最小调节量且小于最大位置误差时，将这个误差作为等中心点处的位置误差，最终引入调节过程。所述整体位置误差判定模块如图3-3所示，包括读取神经网络输入参数子模块、训练好的神经网络及参数子模块、整体位置误差判定子模块、接收扫描磁铁电流设定值子模块；所述读取神经网络输入参数子模块用于读取以下七个参数：束流能量E、安装在扫描铁上的霍尔探头测量到的两扫描铁的磁场值Bp_x和Bp_y、第一个电离室IC1监测到的束流位置坐标点IC1_x和IC1_y、第二个电离室IC2监测到的束流位置坐标IC2_x和IC2_y，这7个参数作为训练好的神经网络的输入层；所述训练好的神经网络及参数子模块读取神经网络输入参数子模块的7个参数，并接收学习阶段神经网络训练好的网络权值和阈值；所述整体位置误差判定子模块一方面根据训练好的神经网络输出的等中心平面处束流位置坐标预测值，也即为神经网络的输出层、一方面根据接收扫描磁铁电流设定值子模块设定的等中心平面处束流位置设定值，从而最终计算出整体位置误差。所述扫描控制器的调节决策模块针对束流位置预测模块计算出的对应在等中心点处的位置误差，然后根据误差值控制快速校正磁铁的电源电流，进而对束流位置进行校正；每次输出电流调节范围做限制不超过最大值△Imax-E，具体输出电流如下：△Iadj-i＝△Imax-E*erri*f，其中，△Iadj-i为调节输出电流变化量，erri为位置误差与最大调节误差比值，f为修正系数。所述用于神经网络学习阶段的输入输出参数设置子模块的输入层、输出层、隐含层的设置如下：1)输入层为与束流位置相关的7维变量数组：其中E为束流能量，Bp_x和Bp_y为安装在扫描铁上的霍尔探头测量到的两扫描铁的磁场值，IC1_x和IC1_y为第一个电离室IC1监测到的束流位置坐标点，IC2_x和IC2_y为第二个电离室IC2监测到的束流位置坐标；2)输出层为等中心平面处束流的位置坐标；3)隐含层节点数目的确定参考如下公式：式中，h为隐含层节点数目，m为输入层节点数目，n为输出层节点数目，a为1到10之间的调节常数。因此选择隐含层节点个数为10，建立起网络的模型，并最终确定模型参数，输入层7个节点，隐含层10个节点，输出层2个节点。所述快速校正磁铁如图2所示，通过其电源输出电流值的变化产生相应的磁场，从而实现对束流位置的偏转和校正；所述快速校正磁铁的最终位置校正最大范围为±0.8mm，用以保证在实时调节过程中对束流位置的调节量在安全范围内；所述快速校正磁铁对230MeV质子束流的偏转角度为2.25mrad及以上，用以实现对质子束流的偏转能力。如图2所示，所述X方向扫描磁铁SMX及Y方向扫描磁铁SMY内部装有霍尔探头、用以实现对磁场的回读，由于磁场和束流位置一一对应的关系，从而能够通过磁场回读值间接对束流位置进行检测；所述X方向扫描磁铁SMX及Y方向扫描磁铁最大工作电流达到150A及以上、最大工作电压360V及以上，响应时间于900μs。如图2所示，所述条带电离室IC1和条带电离室IC2分别包含128个X方向条带及128个Y方向条带，用以实现束流位置的实时监测；所述电离室IC1/IC2有效测量位置区域不小于25cm x 25cm、位置分精度X方向和Y方向均不低于250μm、电离室电子学数据采样率不小于5kHz，采样ADC大于16位，从而保证束流位置和剂量读取的精度；同时保证质子束流在50～250MeV下电离室的水等效厚度小于200μm，从而保证足够少的能量损失。一种笔形束扫描束流位置快速校正方法如图6所示，其特征在于，包括以下步骤：步骤一、笔形束扫描过程开始；步骤二、扫描控制器根据扫描文件对扫描磁铁电流进行设定；步骤三、电流回读和霍尔探头回读正确？如果正确，则继续步骤四，否则，返回步骤二；步骤四、其他连锁条件是否满足？如果不满足，循环返回步骤四，如果满足，继续步骤五；步骤五、开启照射过程；步骤六、预测位置及反馈位置均大于最小调节值且大于误差阈值？如果是，则控制快速校正磁铁电流，校正束流位置；如果不是，则继续步骤七；步骤七、位置误差大于误差阈值？如果是，Error状态触发安全联锁，停止束流照射过程；如果不是，则继续步骤八；步骤八、继续照射过程；步骤九、目标剂量达到且照射过程结束？如果没有达到，则返回步骤五，达到则结束。需要强调的是，上述具体实施例仅仅是对本发明的解释，其并不是对本发明的限制，本领域技术人员在阅读完本说明书后可以根据需要对上述实施例做出没有创造性贡献的修改，但只要在本发明的权利要求范围内都受到专利法的保护。
