标题title
一种医用CT机X射线准直器动态调整方法和装置
摘要abst
本发明涉及CT图像校准技术领域，公开了一种医用CT机X射线准直器动态调整方法和装置，方法包括步骤：持续监测X射线球管的曝光开始信号；曝光开始前，获取一探测器模块的探测器单元对应的本底数据；曝光开始后，执行一次以上的准直器控制策略，根据每次执行准直器控制策略得到的所有差异值，计算准直器中心的偏移量，对准直器的位置进行调整，相邻两次调整间隔预设时间，直至曝光停止，结束调整。本发明能够实时调整准直器的位置，使调整后的准直器作用于当前扫描，获得更加准确的扫描数据，扫描过程更连贯，能够适应不同扫描条件。
权利要求书clms
1.一种医用CT机X射线准直器动态调整方法，其特征在于，包括步骤：持续监测X射线球管的曝光开始信号；曝光开始前，获取一探测器模块的探测器单元对应的本底数据，并计算探测器单元对应的本底数据平均值；曝光开始后，执行一次以上的准直器控制策略，对准直器的位置进行调整，相邻两次调整间隔预设时间，直至曝光停止，结束调整；其中，每次执行准直器控制策略的步骤包括：获取所选探测器模块的第k排探测器单元和倒数第k排探测器单元的曝光数据，并分别计算对应的曝光数据平均值，k为所选探测器单元的排序号；根据第k排探测器单元、倒数第k排探测器单元的曝光数据平均值与对应的本底数据平均值，计算出一个差异值并缓存；根据每次执行准直器控制策略得到的所有差异值，计算准直器中心的偏移量；将准直器中心的偏移量发送给准直器控制单元，由准直器控制单元根据所述偏移量调整准直器的位置。2.根据权利要求1所述的医用CT机X射线准直器动态调整方法，其特征在于，所述准直器中心的偏移量的计算步骤如下：计算当前缓存的所有差异值的平均值；根据本次调整时获得的差异值与前一次调整时的差异值的差值，确定差异值变化率；根据本次调整时获得的差异值、平均值和差异值变化率，计算准直器中心的偏移量。3.根据权利要求1或2任一所述的医用CT机X射线准直器动态调整方法，其特征在于，以如下公式计算出所述准直器中心的偏移量：S＝ωp·P+ωI·I+ωD·D其中，S表示准直器中心的偏移量，P取本次调整时计算出的差异值，I为平均值，D为差异值变化率，ωp、ωI、ωD分别为P、I、D的权重系数。4.根据权利要求3所述的医用CT机X射线准直器动态调整方法，其特征在于：所述ωp根据本次调整计算的差异值的绝对值动态调整。5.根据权利要求1所述的医用CT机X射线准直器动态调整方法，其特征在于，所述差异值的计算步骤如下：计算第k排探测器单元、倒数第k排探测器单元的曝光数据平均值与对应的本底数据平均值的差值，分别得到第一差值和第二差值；根据第一差值和第二差值计算出差异值并缓存。6.根据权利要求1或5任一所述的医用CT机X射线准直器动态调整方法，其特征在于，以如下公式计算出差异值：其中，δ表示差异值，Ak、AN-k+1分别表示所选探测器模块的第k排和倒数第k排的探测器单元的曝光数据平均值，Bk、BN-k+1分别表示所选探测器模块的第k排和倒数第k排的探测器单元的本底数据平均值；N指探测器模块的物理排数，k是所选探测器单元的排序号。7.根据权利要求1所述的医用CT机X射线准直器动态调整方法，其特征在于：相邻两次调整的间隔预设时间ΔT，根据本次调整时的差异值的绝对值实时调整。8.根据权利要求1所述的一种医用CT机X射线准直器动态调整方法，其特征在于，在曝光开始后，停止取本底数据，在执行准直器控制策略前设置一个预设长度的缓存区并清零，缓存区用于在本次曝光停止前，存储执行准直器控制策略获得的差异值。9.一种医用CT机X射线准直器动态调整装置，其特征在于，包括：曝光信号监测模块，用于持续监测X射线球管的曝光开始信号；本底数据获取模块，用于获取一探测器模块的探测器单元对应的本底数据，并计算探测器单元对应的本底数据平均值；控制模块，用于曝光开始后，执行一次以上的准直器控制策略，对准直器的位置进行调整，设置相邻两次调整的间隔时间，在曝光停止，发出结束调整的指令；曝光数据获取模块，获取所选探测器模块的第k排探测器单元和倒数第k排探测器单元接收到的曝光数据，并分别计算对应的曝光数据平均值，k为所选探测器单元的排序号；第一计算模块，根据第k排探测器单元、倒数第k排探测器单元的曝光数据平均值与对应的本底数据平均值，计算出一个差异值并缓存；缓存模块，用于缓存每次对准直器进行调整时，计算出的差异值；第二计算模块，根据一个曝光周期内对准直器调整时得到的所有差异值，计算准直器中心的偏移量；执行模块，将准直器中心的偏移量发送给准直器控制单元，由准直器控制单元根据所述偏移量调整准直器的位置。10.一种计算机存储介质，其特征在于，所述计算机存储介质存储有至少一个可被处理器执行的指令，所述至少一个指令被处理器执行时，实现如权利要求1至8中任意一项所述方法。
说明书desc
技术领域本发明涉及医用CT图像校准技术领域，尤其涉及一种医用CT机X射线准直器动态跟踪调整方法。背景技术在CT的使用过程中，由于扫描条件等因素影响，X射线球管的焦点在z方向上的位置并不固定，存在偏移，且由于X射线准直器离球管的位置很近，该偏移将会导致准直器在探测器上的阴影发生大的变化。阴影的变化会进一步造成校准数据的不准确，从而导致图像上出现伪影。目前针对此问题的常规解决办法是采用准直器定位技术，是先扫描再调整准直器进行补偿，即对前一次扫描数据进行复杂校准计算得出球管焦点的偏移量，再调整准直器中心位置来补偿X射线球管的焦点在z方向上的偏移。该准直器定位技术有明显的不足，首先此种方式的补偿是滞后的，非实时性的，只能作用于下一次扫描，对前一次扫描是不起作用；其次实际扫描控制时序需要等待补偿完成才能执行当前扫描，此种方式的补偿是需要额外时间，因此会影响扫描控制时序的连贯性，特别是在前后两次扫描条件不变仅球管焦点出现偏移需要补偿时影响最明显；最后，也是最大问题，实际球管焦点的偏移量并不固定，球管焦点的偏移量取决于机架转速、球管阳极转速、球管热容量、kV、mA等因素，如果球管焦点的偏移量在补偿的前后发生了变化，通过此种方式就无法进行有效补偿。发明内容技术目的：针对上述技术问题，本发明公开了一种医用CT机X射线准直器动态调整方法和装置，能够实时跟踪球管焦点位置，通过检测探测器上未受遮挡的探测器模块的对称排上的信号差异，计算准直器中心的偏移量，实时调整准直器中心位置进行补偿。技术方案：为实现上述技术目的，本发明采用了如下技术方案：一种医用CT机X射线准直器动态调整方法，其特征在于，包括步骤：持续监测X射线球管的曝光开始信号；曝光开始前，获取一探测器模块的探测器单元对应的本底数据，并计算探测器单元对应的本底数据平均值；曝光开始后，执行一次以上的准直器控制策略，对准直器的位置进行调整，相邻两次调整间隔预设时间，直至曝光停止，结束调整；其中，每次执行准直器控制策略的步骤包括：获取所选探测器模块的第k排探测器单元和倒数第k排探测器单元的曝光数据，并分别计算对应的曝光数据平均值，k为所选探测器单元的排序号；根据第k排探测器单元、倒数第k排探测器单元的曝光数据平均值与对应的本底数据平均值，计算出一个差异值并缓存；根据每次执行准直器控制策略得到的所有差异值，计算准直器中心的偏移量；将准直器中心的偏移量发送给准直器控制单元，由准直器控制单元根据所述偏移量调整准直器的位置。优选地，所述准直器中心的偏移量的计算步骤如下：计算当前缓存的所有差异值的平均值；根据本次调整时获得的差异值与前一次调整时的差异值的差值，确定差异值变化率；根据本次调整时获得的差异值、平均值和差异值变化率，计算准直器中心的偏移量。优选地，以如下公式计算出所述准直器中心的偏移量：S＝ωp·P+ωI·I+ωD·D其中，S表示准直器中心的偏移量，P取本次调整时计算出的差异值，I为平均值，D为差异值变化率，ωp、ωI、ωD分别为P、I、D的权重系数。优选地，所述ωp根据本次调整计算的差异值的绝对值动态调整。优选地，所述差异值的计算步骤如下：计算第k排探测器单元、倒数第k排探测器单元的曝光数据平均值与对应的本底数据平均值的差值，分别得到第一差值和第二差值；根据第一差值和第二差值计算出差异值并缓存。优选地，以如下公式计算出差异值：其中，δ表示差异值，Ak、AN-k+1分别表示所选探测器模块的第k排和倒数第k排的探测器单元的曝光数据平均值，Bk、BN-k+1分别表示所选探测器模块的第k排和倒数第k排的探测器单元的本底数据平均值；N指探测器模块的物理排数，k是所选探测器单元的排序号。优选地，相邻两次调整的间隔预设时间ΔT，根据本次调整时的差异值的绝对值实时调整。优选地，在曝光开始后，停止取本底数据，在执行准直器控制策略前设置一个预设长度的缓存区并清零，缓存区用于在本次曝光停止前，存储执行准直器控制策略获得的差异值。一种医用CT机X射线准直器动态调整装置，其特征在于，包括：曝光信号监测模块，用于持续监测X射线球管的曝光开始信号；本底数据获取模块，用于获取一探测器模块的探测器单元对应的本底数据，并计算探测器单元对应的本底数据平均值；控制模块，用于曝光开始后，执行一次以上的准直器控制策略，对准直器的位置进行调整，设置相邻两次调整的间隔时间，在曝光停止，发出结束调整的指令；曝光数据获取模块，获取所选探测器模块的第k排探测器单元和倒数第k排探测器单元接收到的曝光数据，并分别计算对应的曝光数据平均值，k为所选探测器单元的排序号；第一计算模块，根据第k排探测器单元、倒数第k排探测器单元的曝光数据平均值与对应的本底数据平均值，计算出一个差异值并缓存；缓存模块，用于缓存每次对准直器进行调整时，计算出的差异值；第二计算模块，根据一个曝光周期内对准直器调整时得到的所有差异值，计算准直器中心的偏移量；执行模块，将准直器中心的偏移量发送给准直器控制单元，由准直器控制单元根据所述偏移量调整准直器的位置。一种计算机存储介质，其特征在于，所述计算机存储介质存储有至少一个可被处理器执行的指令，所述至少一个指令被处理器执行时，实现所述方法。有益效果：与现有技术相比，本发明具有如下技术效果：本发明的医用CT机X射线准直器动态调整方法，通过检测探测器上未受遮挡的探测器模块的对称排上的信号差异，计算准直器中心的偏移量，在一次CT扫描需要的X射线管的一个曝光周期内，对准直器进行多次调节，其准直器的偏移的补偿是实时的、非滞后的，使调整后的准直器能够作用于当前扫描，获得更加准确的CT原始扫描数据。本发明在实际的一次CT扫描中，无需控制时序和等待补偿完成，因此不耗费额外时间，扫描过程更连贯，能够自适应不同扫描条件。附图说明图1为本发明的动态准直器跟踪技术示意图；图2为准直器动态跟踪流程图；图3为探测器中第一探测器模块在z方向上的信号；图4为PID算法来获得准直器中心的偏移量S；图5为准直器调节量变化示意图；图6为模块信号差异变化示意图。具体实施方式下面结合附图对本发明做详细的说明。如图1所示，在没有动态准直器跟踪的情况下，当球管焦点发生偏移后，X射线的照射范围不再和探测器的覆盖范围吻合，从而造成辐射剂量的浪费和图像伪影的产生。本发明提供的动态准直器跟踪技术，能够实时根据探测器的数据观察球管焦点的位置，并根据该位置实时调节X射线准直器的位置，从而使X射线在Z方向始终与探测器的覆盖范围保持一致，从而达到保证图像质量的目的。实际应用中，若球管焦点存在偏移，希望准直器在扫描开始后可以既快又准确地调整到位。由于受准直器电机启停响应速度、电机自身机械与运动特性影响，准直器响应实时性欠佳，收到准直器中心的偏移量指令后，需要毫秒量级时间才能完成。在控制准直器运动过程中，容易出现准直器中心的偏移量大，电机容易过冲；准直器中心的偏移量小，耗时长等问题。这就需要通过一套控制策略来实现“既快又准确地”调整到位目标，大致思路是先监测探测器信号变化来预判准直器离目标位置距离，再调整控制策略来控制准直器运动，继续监测探测器信号变化预判准直器离目标位置距离，调整控制策略来控制准直器运动，如此反复最后到达目标位置，使X射线照射覆盖在探测器模块的排方向上对称，如图2所示。实施例一本实施例提供了一种医用CT机X射线准直器动态调整方法，CT机的探测器包括多个排列在x方向上的探测器模块，各个探测器模块在z方向上包括多排探测器单元。1、准直器动态调整方法具体包括步骤：持续监测X射线球管的曝光开始信号；曝光开始前，获取一探测器模块的探测器单元对应的本底数据，并计算探测器单元对应的本底数据平均值；本底数据是指没有X射线照射时即非曝光时探测器采集的数据；曝光开始后，执行一次以上的准直器控制策略，对准直器的位置进行调整，相邻两次调整间隔预设时间，直至曝光停止，结束调整；其中，每次执行准直器控制策略的步骤包括：获取所选探测器模块的第k排探测器单元和倒数第k排探测器单元的曝光数据，并分别计算对应的曝光数据平均值，k为所选探测器单元的排序号；根据第k排探测器单元、倒数第k排探测器单元的曝光数据平均值与对应的本底数据平均值，计算出一个差异值并缓存；根据每次执行准直器控制策略得到的所有差异值，计算准直器中心的偏移量；将准直器中心的偏移量发送给准直器控制单元，由准直器控制单元根据所述偏移量调整准直器的位置。2、准直器中心的偏移量的计算步骤如下：计算当前缓存的所有差异值的平均值；根据本次调整时获得的差异值与前一次调整时的差异值的差值，确定差异值变化率；根据本次调整时获得的差异值、平均值和差异值变化率，计算准直器中心的偏移量。具体地，以如下公式计算出所述准直器中心的偏移量：S＝ωp·P+ωI·I+ωD·D其中，S表示准直器中心的偏移量，P取本次调整时计算出的差异值，I为平均值，D为差异值变化率，ωp、ωI、ωD分别为P、I、D的权重系数。3、差异值的确定步骤如下：计算第k排探测器单元、倒数第k排探测器单元的曝光数据平均值与对应的本底数据平均值的差值，分别得到第一差值和第二差值；根据第一差值和第二差值计算出差异值并缓存。以如下公式计算出差异值：其中，δ表示差异值，Ak、AN-k+1分别表示所选探测器模块的第k排和倒数第k排的探测器单元的曝光数据平均值，Bk、BN-k+1分别表示所选探测器模块的第k排和倒数第k排的探测器单元的本底数据平均值；N指探测器模块的物理排数，k是所选探测器单元的排序号。优选其上的各排探测器单元均能够采集到曝光数据的探测器模块，通常监测探测器的最边上的第一个模块信号数据，取第一个模块是因为该位置一般会直接看到X射线源，不会被物体遮挡。当然，算法中也需要考虑被遮挡的情况，如果发现遮挡的话应该停止跟踪。探测器的第一模块要求没有坏点。假设探测器的第一模块有32排，由于半影区的存在，探测器在z方向上的两侧信号会比中间要小，当球管的X射线焦点发生偏移时，一侧的信号会上升，而另一侧的信号会下降，从而使两侧信号发生变化，如图3示出了探测器模块检测到的信号情况。通常CT扫描过程由多个扫描序列构成，每个扫描序列都有特定的扫描条件。扫描条件决定了曝光开始、曝光结束、曝光参数等扫描相关参数，曝光开始前会有曝光参数配置等准备动作。算法中相邻两次调整的间隔预设时间只与算法运算和指令发送周期相关，而曝光时长是由扫描条件决定的，所以算法中需要监测曝光信号。准直器动态跟踪的目标是让X射线在这个模块上的分布在z方向，就是在排方向上对称。准直器动态跟踪就是不断调整准直器位置，使信号差逐渐趋于0的过程，理想情况下能够调整到使X光在探测器排方向上对称分布。实施例二1、本实施例中准直器控制策略是在上述PID算法基础上实现的。如图4所示，包括如下步骤：曝光开始前，循环取当前第k和倒数第k排的本底数据分别求其平均值Bk、BN-k+1，并监测曝光开始信号；曝光开始后，停止取本底数据，设置一个长度为L的FIFO缓存，清零；取当前第k和倒数第k排的曝光数据并分别求其平均值Ak、AN-k+1；计算差异值将当前δ放入FIFO缓存，并计算缓存内的所有值的平均值：I；计算当前δ的变化率：D＝δ1-δ2；令P＝δ，计算准直器中心的偏移量为：S＝ωp·P+ωI·I+ωD·D；将S发送给准直器控制单元；如果曝光停止结束，如果不是的话等待ΔT时间回到3。其中，N是指探测器模块的物理排数，通常为2的n次方，现在较多为16、32、64、128、256等排，N是固定的；k可以是指在当前扫描排数下，X射线居中照射覆盖的探测器模块的首个探测器单元的排序号，k并不固定，由扫描排数决定，k小于N/2，第k排探测器单元和倒数第k排探测器单元为所在探测器模块上的对称排，且均位于当前X射线照射覆盖范围内。本实施例步骤中，循环取本底数据，其实质是在持续监测X射线球管的曝光开始信号时，不间断地获取对称排探测器单元的本底数据，直到曝光开始，才停止获取本底数据。此外，根据CT扫描开始前设置的扫描条件，确定了扫描范围和扫描排数，选取相应的对称排，如本实施例中的第k排和倒数第k排，然后计算对应的本底数据平均值，均可用于随后的曝光开始至曝光结束期间内的每次差异值计算中。算法中需要根据实际调试确认的参数有：ΔT，L，ωp，ωI，ωD，其中ωp，ωI，ωD分别为P、I、D的权重系数。在早期研发阶段，发现对结果影响最大的ΔT，ωp参数与kV、mA、准直器缝宽等扫描条件相关联，相同参数更换不同扫描条件就可能会出现补偿效果不佳情况，无法找出适用于不同扫描条件的固定参数。后期对算法进行优化了，根据扫描时当前模块信号差进行自适应动态调参，经验证明可满足各种扫描条件。动态调参过程大致如下：ΔT参数根据当前δ绝对值实时动态调整，|δ|大时，说明离目标远，ΔT调大，进入粗调阶段，用于调整准直器中心的偏移量的指令发送频率慢；|δ|小时，说明离目标近，ΔT调小，进入细调阶段，指令发送频率快；ωP参数可根据当前δ绝对值动态调参，|δ|大时，说明离目标远，ωp调大，加大粗调；|δ|小时，说明离目标近，ωp调小，减少细调。ωI，ωD可根据计算与实验分析得出，设计动态调参，也可直接忽略其影响配为0。2、下面以探测器模块有32排，当前扫描排数也是32排为例。包括如下步骤：曝光开始前，循环取当前第1和倒数第1排的本底数据分别求其平均值B1、B32，并监测曝光开始信号；曝光开始后，停止取本底数据，设置一个长度为64的FIFO缓存，清零；取当前第1和倒数第1排的曝光数据平均值A1、A32；计算差异值δ＝-)/+)；将当前δ放入FIFO缓存，并计算缓存内的所有值的平均值：I；计算当前δ的变化率：D＝δ1-δ2；令P＝δ，计算准直器中心的偏移量为：S＝ωP·P+ωI·I+ωD·D；将S发送给准直器控制单元；如果曝光停止，本次调整结束，如果不是的话等待ΔT时间回到3。为了简化，只对ΔT参数进行实时动态调整，且调整档位为三档，默认ΔT＝20mS，|δ|＞0.5，ΔT＝40mS；|δ|＜0.2，ΔT＝10mS，效果如图5和图6所示，图5和图6中横坐标表示数据帧数，可间接表示时间，图6中的纵坐标表示对称两排的数据比值。3、下面以探测器模块有128排，当前扫描排数是32排为例。物理排数N＝128，扫描排数M＝32，依k＝/2)+1可得k＝49，所以可取第49和倒数第49排数据，余下步骤同上面2。实施例三一种医用CT机X射线准直器动态调整装置，其特征在于，包括：曝光信号监测模块，用于持续监测X射线球管的曝光开始信号；本底数据获取模块，用于获取一探测器模块的探测器单元对应的本底数据，并计算探测器单元对应的本底数据平均值；控制模块，用于曝光开始后，执行一次以上的准直器控制策略，对准直器的位置进行调整，设置相邻两次调整的间隔时间，在曝光停止，发出结束调整的指令；曝光数据获取模块，获取所选探测器模块的第k排探测器单元和倒数第k排探测器单元接收到的曝光数据，并分别计算对应的曝光数据平均值，k为所选探测器单元的排序号；第一计算模块，根据第k排探测器单元、倒数第k排探测器单元的曝光数据与对应的本底数据平均值，计算出一个差异值并缓存；缓存模块，用于缓存每次对准直器进行调整时，计算出的差异值；第二计算模块，根据一个曝光周期内对准直器调整时得到的所有差异值，计算准直器中心的偏移量；执行模块，将准直器中心的偏移量发送给准直器控制单元，由准直器控制单元根据所述偏移量调整准直器的位置。在本发明的又一实施例中，提供了一种计算机存储介质，计算机存储介质存储有至少一个可被处理器执行的指令，所述至少一个指令被处理器执行时，实现实施例1所述方法。以上所述仅是本发明的优选实施方式，应当指出：对于本技术领域的普通技术人员来说，在不脱离本发明原理的前提下，还可以做出若干改进和润饰，这些改进和润饰也应视为本发明的保护范围。
